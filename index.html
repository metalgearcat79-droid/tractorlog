<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex">
  <link rel="manifest" href="/tractorlog/manifest.json">
  <title>å’Œè¾²æ—¥å‘ Tractor Log</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/bold/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* --- åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« --- */
    body { background-color: #f7f4ef; color: #3a3a3a; font-family: "Hiragino Sans", "Noto Sans JP", sans-serif; margin: 0; transition: background-color 0.3s; }
    body.dark-mode { background: #1a1c1e; color: #e0e0e0; }
    
    .view { display: none; }
    .view.active { display: block; }

    /* ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    #sideMenu { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: white; z-index: 9999; transition: left 0.3s ease; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
    body.dark-mode #sideMenu { background-color: #1a1a1a; color: #e0e0e0; }
    #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 9998; display: none; }

    .menu-item { width: 100%; text-align: left; padding: 1rem; border-radius: 0.5rem; font-weight: bold; color: #6b8f71; display: flex; align-items: center; transition: background-color 0.2s; }
    .menu-item:hover { background-color: #f0f4f0; } 
    body.dark-mode .menu-item:hover { background-color: #2d352d; }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚µã‚¤ã‚ºèª¿æ•´ */
    .header-icon { font-size: 64px; color: #6b8f71; margin-bottom: 8px; transition: font-size 0.3s; }
    @media (max-width: 640px) { .header-icon { font-size: 40px; } }

    /* åŒºåˆ‡ã‚Šç·š */
    .section-title { font-size: 1.25rem; font-weight: bold; color: #6b8f71; display: flex; align-items: center; gap: 10px; padding-bottom: 8px; border-bottom: 2px solid #6b8f71; margin-bottom: 16px; }

    /* ã‚«ãƒ¼ãƒ‰ãƒ»å…¥åŠ›é …ç›® */
    .card { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); margin-bottom: 16px; position: relative; }
    body.dark-mode .card { background: #2d2d2d; color: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }

    input, select, textarea { background-color: white; color: #3a3a3a; border: 1px solid #ddd; transition: background-color 0.2s, color 0.2s; }
    body.dark-mode input, body.dark-mode select, body.dark-mode textarea { background-color: #3d3d3d; color: #ffffff; border-color: #555; }

    /* ãƒœã‚¿ãƒ³ */
    .btn-main { background-color: #6b8f71; color: white; padding: 14px; border-radius: 12px; text-align: center; font-weight: bold; width: 100%; display: block; }
    .btn-sub { background-color: #6b8f71; color: white; padding: 12px; border-radius: 10px; text-align: center; font-weight: bold; width: 100%; margin-top: 20px; display: block; }
    
    /* å‰Šé™¤ãƒœã‚¿ãƒ³ */
    .delete-btn { color: #e57373; cursor: pointer; padding: 4px 8px; border-radius: 6px; transition: background 0.2s; }
    .delete-btn:hover { background: rgba(229, 115, 115, 0.1); }

    /* DASHBOARD */
    #dashboard.active { display: flex !important; flex-direction: column; min-height: 100vh; background-color: #e2e8e3; overflow: hidden; }
    body.dark-mode #dashboard { background-color: #121412; }
    .bi-header { height: 60px; display: flex; align-items: center; padding: 0 20px; background: #2d4031; color: white; flex-shrink: 0; }
    .bi-container { display: flex; padding: 15px; gap: 15px; overflow: hidden; }
    .bi-left-col { width: 300px; display: flex; flex-direction: column; gap: 10px; flex-shrink: 0; }
    .bi-main-col { flex: 1.2; display: flex; flex-direction: column; gap: 10px; min-width: 0; }
    .bi-right-col { width: 280px; display: flex; flex-direction: column; gap: 10px; flex-shrink: 0; }
    .kpi-card { background: #6b8f71; color: white; padding: 8px 4px; border-radius: 12px; text-align: center; }
    .tab-btn { padding: 6px 16px; border-radius: 20px; font-size: 12px; font-weight: bold; white-space: nowrap; cursor: pointer; }
    .tab-btn.active { background: #2d4031; color: white; }
    .tab-btn.inactive { background: white; color: #6b8f71; }

    @media (max-width: 1024px) {
      #dashboard.active { overflow-y: auto; height: auto; }
      .bi-container { flex-direction: column; overflow: visible; }
      .bi-left-col, .bi-main-col, .bi-right-col { width: 100%; }
    }
  </style>
</head>
<body>

<div id="overlay"></div>

<div id="sideMenu">
  <div class="flex justify-between items-center mb-8">
    <h2 class="font-bold text-xl text-[#6b8f71]">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
    <button id="closeMenuBtn" class="text-3xl text-gray-400">&times;</button>
  </div>
  <nav class="space-y-1">
    <button onclick="switchView('inputView')" class="menu-item"><i class="fa-solid fa-pen-to-square w-8"></i>ãƒ­ã‚°å…¥åŠ›</button>
    <button onclick="switchView('todayView')" class="menu-item"><i class="fa-solid fa-calendar-day w-8"></i>æœ¬æ—¥ã®ç¨¼åƒçŠ¶æ³</button>
    <button onclick="switchView('historyView')" class="menu-item"><i class="fa-solid fa-magnifying-glass w-8"></i>ç¨¼åƒå±¥æ­´ãƒ»æ¤œç´¢</button>
    <button onclick="switchView('dashboard')" class="menu-item"><i class="fa-solid fa-chart-line w-8"></i>DASHBOARD</button>
    <button onclick="toggleDarkMode()" class="menu-item"><i class="fa-solid fa-moon w-8"></i>ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</button>
  </nav>
</div>

<div id="mainContainer">
  <header id="pageHeader" class="flex flex-col items-center justify-center py-8 relative">
    <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl text-[#6b8f71] p-2"><i class="fa-solid fa-bars"></i></button>
    <i class="fa-solid fa-tractor header-icon"></i>
    <h1 class="text-xl font-bold text-[#6b8f71]">å’Œè¾²æ—¥å‘ Tractor log</h1>
  </header>

  <div id="inputView" class="view active px-4 max-w-xl mx-auto pb-10">
    <div class="card"><label class="block text-xs font-bold text-gray-400 mb-1">æ©Ÿæ¢°ã‚’é¸æŠ</label><select id="machineSelect" class="w-full p-3 border rounded-lg outline-none"></select></div>
    <div class="card"><label class="block text-xs font-bold text-gray-400 mb-1">ä½œæ¥­æ—¥</label><input type="date" id="workDate" class="w-full p-3 border rounded-lg outline-none" /></div>
    <div class="card"><label class="block text-xs font-bold text-gray-400 mb-1">ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼</label>
      <select id="operatorSelect" class="w-full p-3 border rounded-lg outline-none">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option><option>é˜¿æ›½ åƒä¸€</option><option>é˜¿æ›½ å³è²¢</option><option>è…åŸ äºœç¾</option><option>åœŸäº• é”ä¹Ÿ</option><option>é˜¿æ›½ æ–‡å¹³</option><option>ç”°ä¸­ æ­¦å¿—</option><option>èµ¤å¡š ã‹ãŠã‚Š</option><option>åœŸé–€ å…ƒç¾©</option><option>ãã®ä»–</option>
      </select>
    </div>
    <div class="card"><label class="block text-xs font-bold text-gray-400 mb-1">ç¨®åˆ¥</label><select id="categorySelect" class="w-full p-3 border rounded-lg outline-none"><option value="">é¸æŠã—ã¦ãã ã•ã„</option><option value="æ°´ç¨²">æ°´ç¨²</option><option value="ãã°">ãã°</option><option value="ä¿å…¨ä¼š">ä¿å…¨ä¼š</option><option value="å°è¦æ¨¡å·¥äº‹">å°è¦æ¨¡å·¥äº‹</option></select></div>
    <div class="card"><label class="block text-xs font-bold text-gray-400 mb-1">ä½œæ¥­å†…å®¹</label><select id="taskSelect" class="w-full p-3 border rounded-lg outline-none"></select></div>
    <div class="card">
      <div class="flex space-x-4">
        <div class="flex-1"><label class="block text-xs font-bold text-gray-400 mb-1">ç¨¼åƒå‰</label><input type="number" id="hourBefore" class="w-full p-3 border rounded-lg" step="0.1" /></div>
        <div class="flex-1"><label class="block text-xs font-bold text-gray-400 mb-1">ç¨¼åƒå¾Œ</label><input type="number" id="hourAfter" class="w-full p-3 border rounded-lg" step="0.1" /></div>
      </div>
    </div>
    <div id="hourDiffDisplay" class="text-right font-black text-[#6b8f71] mb-6 text-xl">ç¨¼åƒæ™‚é–“: 0.0 h</div>
    <div class="card"><label class="block text-xs font-bold text-gray-400 mb-1">çµ¦æ²¹é‡ (L)</label><input type="number" id="fuelAmount" class="w-full p-3 border rounded-lg" placeholder="çµ¦æ²¹é‡å…¥åŠ›" /></div>
    <div class="card"><label class="block text-xs font-bold text-gray-400 mb-1">ãƒ¡ãƒ¢</label><textarea id="memoInput" class="w-full p-3 border rounded-lg" rows="2"></textarea></div>
    <button id="saveBtn" class="btn-main">ãƒ­ã‚°ã‚’ä¿å­˜ã™ã‚‹</button>
  </div>

  <div id="todayView" class="view px-4 max-w-xl mx-auto pb-10">
    <div class="section-title"><i class="fa-solid fa-calendar-day"></i> æœ¬æ—¥ã®ç¨¼åƒçŠ¶æ³</div>
    <div id="todayLogList" class="space-y-4"></div>
    <button onclick="switchView('inputView')" class="btn-sub"><i class="fa-solid fa-arrow-left mr-2"></i>TOPã«æˆ»ã‚‹</button>
  </div>

  <div id="historyView" class="view px-4 max-w-xl mx-auto pb-10">
    <div class="flex justify-between items-center">
      <div class="section-title border-none mb-0"><i class="fa-solid fa-magnifying-glass"></i> ç¨¼åƒå±¥æ­´ãƒ»æ¤œç´¢</div>
      <div id="historyTotalHours" class="text-sm font-black opacity-60">åˆè¨ˆ: 0.0 h</div>
    </div>
    <div class="w-full h-[2px] bg-[#6b8f71] mb-4"></div>
    <div class="card space-y-2 text-sm">
      <div class="grid grid-cols-2 gap-2">
        <input type="month" id="filterMonth" class="p-2 border rounded-lg w-full">
        <select id="filterMachine" class="p-2 border rounded-lg w-full"><option value="">ã™ã¹ã¦ã®æ©Ÿæ¢°</option></select>
      </div>
      <div class="grid grid-cols-2 gap-2">
        <select id="filterOperator" class="p-2 border rounded-lg w-full"><option value="">ã™ã¹ã¦ã®æ‹…å½“</option><option>é˜¿æ›½ åƒä¸€</option><option>é˜¿æ›½ å³è²¢</option><option>è…åŸ äºœç¾</option><option>åœŸäº• é”ä¹Ÿ</option><option>é˜¿æ›½ æ–‡å¹³</option><option>ç”°ä¸­ æ­¦å¿—</option><option>èµ¤å¡š ã‹ãŠã‚Š</option><option>åœŸé–€ å…ƒç¾©</option></select>
        <select id="filterTask" class="p-2 border rounded-lg w-full"><option value="">ã™ã¹ã¦ã®ä½œæ¥­å†…å®¹</option></select>
      </div>
      <button onclick="loadLogs('historyLogList', false)" class="btn-main py-2">æ¤œç´¢ã‚’å®Ÿè¡Œ</button>
    </div>
    <div id="historyLogList" class="space-y-4"></div>
    <button onclick="switchView('inputView')" class="btn-sub"><i class="fa-solid fa-arrow-left mr-2"></i>TOPã«æˆ»ã‚‹</button>
  </div>

  <div id="dashboard" class="view">
    <div class="bi-header">
      <button onclick="openMenu()" class="text-2xl mr-4"><i class="fa-solid fa-bars"></i></button>
      <h1 class="text-lg font-black tracking-widest uppercase">Operation Dashboard</h1>
      <span id="currentViewLabel" class="ml-auto text-[10px] font-bold bg-white/20 px-3 py-1 rounded-full uppercase">All Machines</span>
    </div>
    <div class="bi-container">
      <div class="bi-left-col">
        <div class="card flex-1 flex flex-col m-0"><p class="text-[10px] font-bold text-[#6b8f71] mb-1">CROP SHARE</p><div class="chart-wrapper"><canvas id="categoryShareChart"></canvas></div></div>
        <div class="card flex-1 flex flex-col m-0"><p class="text-[10px] font-bold text-[#6b8f71] mb-1">TASK ANALYSIS</p><div class="chart-wrapper"><canvas id="taskShareChart"></canvas></div></div>
        <div class="card flex-1 flex flex-col m-0"><p class="text-[10px] font-bold text-[#6b8f71] mb-1">OPERATOR SHARE</p><div class="chart-wrapper"><canvas id="operatorShareChart"></canvas></div></div>
      </div>
      <div class="bi-main-col">
        <div id="machineTabs" class="machine-tabs flex gap-2 overflow-x-auto pb-2"></div>
        <div class="grid grid-cols-5 gap-2 mb-2 text-center">
          <div class="kpi-card"><p class="text-[9px]">Hours</p><p class="text-sm font-black" id="kpi-hours">0.0</p></div>
          <div class="kpi-card"><p class="text-[9px]">Fuel</p><p class="text-sm font-black" id="kpi-fuel">0</p></div>
          <div class="kpi-card"><p class="text-[9px]">L/h</p><p class="text-sm font-black" id="kpi-avg">0.0</p></div>
          <div class="kpi-card"><p class="text-[9px]">Days</p><p class="text-sm font-black" id="kpi-days">0</p></div>
          <div class="kpi-card bg-[#4a6b50]"><p class="text-[9px]">Maint</p><p class="text-sm font-black">OK</p></div>
        </div>
        <div class="card h-48 m-0"><canvas id="detailChart"></canvas></div>
        <div class="card flex-1 m-0"><canvas id="gradientBarChart"></canvas></div>
      </div>
      <div class="bi-right-col">
        <div class="card flex-1 text-center m-0">
          <p class="text-xs font-bold text-[#6b8f71]">YoY æ¯”</p>
          <div class="relative h-20"><canvas id="yearComparisonGauge"></canvas></div>
          <p id="detailCompareValue" class="text-xl font-black text-[#6b8f71]">--%</p>
        </div>
        <div class="card flex-[2] m-0 overflow-y-auto">
          <p class="text-xs font-bold mb-2 border-b pb-1">æœ€è¿‘ã®å±¥æ­´</p>
          <div id="recentLogList" class="text-[10px] space-y-2 opacity-80"></div>
        </div>
        <button onclick="switchView('inputView')" class="btn-sub py-2 mt-0"><i class="fa-solid fa-house mr-2"></i>TOP</button>
      </div>
    </div>
  </div>
</div>

<div id="savePopup" class="hidden fixed inset-0 flex items-center justify-center z-[10001]"><div class="px-6 py-3 rounded-lg text-white bg-[#2f5d3a] shadow-xl font-bold">ä¿å­˜ã—ã¾ã—ãŸ</div></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const SUPABASE_URL = "https://txsqxnwgolybcdclazdx.supabase.co";
  const SUPABASE_KEY = "sb_publishable_8JEM6Yyg5_oQpF-grdaxIw_rrxZBQYj";
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let allMachines = [];
  let currentMachineId = 'all';
  window.charts = {};

  function openMenu() { document.getElementById("sideMenu").style.left = "0px"; document.getElementById("overlay").style.display = "block"; }
  function closeMenu() { document.getElementById("sideMenu").style.left = "-280px"; document.getElementById("overlay").style.display = "none"; }
  document.getElementById("closeMenuBtn").onclick = closeMenu;
  document.getElementById("overlay").onclick = closeMenu;

  function switchView(id) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.getElementById("pageHeader").style.display = (id === 'dashboard') ? 'none' : 'flex';
    closeMenu();
    if (id === 'dashboard') renderDashboard('all');
    if (id === 'todayView') loadLogs("todayLogList", true);
    if (id === 'historyView') loadLogs("historyLogList", false);
  }

  document.addEventListener("DOMContentLoaded", async () => {
    if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
    const { data: machines } = await client.from("machines").select("*").order("name");
    allMachines = machines || [];
    document.getElementById("machineSelect").innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' + allMachines.map(m => `<option value="${m.id}">${m.name}</option>`).join("");
    document.getElementById("filterMachine").innerHTML = '<option value="">ã™ã¹ã¦ã®æ©Ÿæ¢°</option>' + allMachines.map(m => `<option value="${m.id}">${m.name}</option>`).join("");
    document.getElementById("machineTabs").innerHTML = `<button onclick="renderDashboard('all')" id="tab-all" class="tab-btn active">å…¨ä½“åˆ†æ</button>` + 
                     allMachines.map(m => `<button onclick="renderDashboard(${m.id})" id="tab-${m.id}" class="tab-btn inactive">${m.name}</button>`).join("");
    const allTaskOptions = ["ã‚ãœå¡—ã‚Š", "èµ·è€•", "ç²—ä»£", "æœ¬ä»£", "ãƒ­ãƒ¼ãƒ«é‹æ¬", "ä»£ã‹ã", "ç”°æ¤ãˆ", "æºåˆ‡ã‚Š", "è‰åˆˆã‚Š", "é˜²é™¤", "è¿½è‚¥", "ç¨²åˆˆã‚Š", "ç§‹è€•", "æ’­ç¨®", "åˆˆå–ã‚Š", "ãƒãƒ³ãƒãƒ¼ãƒ¢ã‚¢", "ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ¢ã‚¢", "æ•´åœ°", "æ˜å‰Š", "é‹æ¬"];
    document.getElementById("filterTask").innerHTML = '<option value="">ã™ã¹ã¦ã®ä½œæ¥­å†…å®¹</option>' + allTaskOptions.sort().map(t => `<option value="${t}">${t}</option>`).join("");
    const now = new Date();
    document.getElementById("workDate").value = new Date(now.getTime() + 9*60*60*1000).toISOString().split('T')[0];
    document.getElementById("filterMonth").value = document.getElementById("workDate").value.substring(0, 7);
  });

  document.getElementById("machineSelect").onchange = async function() {
    if (!this.value) return;
    const { data } = await client.from("hour_logs").select("end_hour").eq("machine_id", this.value).order("date", {ascending:false}).order("end_hour", {ascending:false}).limit(1);
    document.getElementById("hourBefore").value = (data && data.length > 0) ? data[0].end_hour : 0;
    calcDiff();
  };

  const tasks = { "æ°´ç¨²": ["ã‚ãœå¡—ã‚Š", "èµ·è€•", "ç²—ä»£", "æœ¬ä»£", "ãƒ­ãƒ¼ãƒ«é‹æ¬", "ä»£ã‹ã", "ç”°æ¤ãˆ", "æºåˆ‡ã‚Š", "è‰åˆˆã‚Š", "é˜²é™¤", "è¿½è‚¥", "ç¨²åˆˆã‚Š", "ç§‹è€•"], "ãã°": ["èµ·è€•", "æ’­ç¨®", "é˜²é™¤", "åˆˆå–ã‚Š"], "ä¿å…¨ä¼š": ["ãƒãƒ³ãƒãƒ¼ãƒ¢ã‚¢", "ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ¢ã‚¢", "è‰åˆˆã‚Š"], "å°è¦æ¨¡å·¥äº‹": ["æ•´åœ°", "æ˜å‰Š", "é‹æ¬"] };
  document.getElementById("categorySelect").onchange = function() {
    document.getElementById("taskSelect").innerHTML = (tasks[this.value] || ["ãã®ä»–"]).map(t => `<option value="${t}">${t}</option>`).join("");
  };

  function calcDiff() {
    const diff = (parseFloat(document.getElementById("hourAfter").value) || 0) - (parseFloat(document.getElementById("hourBefore").value) || 0);
    document.getElementById("hourDiffDisplay").textContent = `ç¨¼åƒæ™‚é–“: ${diff > 0 ? diff.toFixed(1) : "0.0"} h`;
  }
  document.getElementById("hourAfter").oninput = calcDiff;
  document.getElementById("hourBefore").oninput = calcDiff;

  document.getElementById("saveBtn").onclick = async () => {
    const mId = document.getElementById("machineSelect").value;
    const op = document.getElementById("operatorSelect").value;
    const hA = parseFloat(document.getElementById("hourAfter").value);
    if (!mId || !op || isNaN(hA)) return alert("æ©Ÿæ¢°ã€ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã€ç¨¼åƒå¾Œã‚¢ãƒ¯ãƒ¼ã¯å¿…é ˆã§ã™");
    const { error } = await client.from("hour_logs").insert([{
      machine_id: mId, date: document.getElementById("workDate").value, operator: op,
      category: document.getElementById("categorySelect").value, task: document.getElementById("taskSelect").value,
      start_hour: parseFloat(document.getElementById("hourBefore").value) || 0, end_hour: hA,
      fuel_amount: parseFloat(document.getElementById("fuelAmount").value) || 0, memo: document.getElementById("memoInput").value
    }]);
    if (!error) { document.getElementById("savePopup").classList.remove("hidden"); setTimeout(() => location.reload(), 1200); }
  };

  async function deleteLog(id) {
    if (!confirm("ã“ã®ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
    const { error } = await client.from("hour_logs").delete().eq("id", id);
    if (!error) {
      alert("å‰Šé™¤ã—ã¾ã—ãŸ");
      loadLogs("todayLogList", true);
      loadLogs("historyLogList", false);
    }
  }

  async function loadLogs(elId, todayOnly) {
    const list = document.getElementById(elId);
    list.innerHTML = "<p class='text-center py-10 opacity-50'>èª­ã¿è¾¼ã¿ä¸­...</p>";
    let query = client.from("hour_logs").select("*, machines(name)").order("date", { ascending: false });
    if (todayOnly) { query = query.eq("date", new Date().toISOString().split('T')[0]); } else {
      const month = document.getElementById("filterMonth").value;
      const mId = document.getElementById("filterMachine").value;
      const op = document.getElementById("filterOperator").value;
      const tsk = document.getElementById("filterTask").value;
      if (month) query = query.gte("date", `${month}-01`).lte("date", `${month}-31`);
      if (mId) query = query.eq("machine_id", mId);
      if (op) query = query.eq("operator", op);
      if (tsk) query = query.eq("task", tsk);
    }
    const { data } = await query;
    if(!data || data.length === 0) {
      list.innerHTML = "<p class='text-center py-10 opacity-50 text-sm'>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>";
      if(!todayOnly) document.getElementById("historyTotalHours").innerText = "åˆè¨ˆ: 0.0 h";
      return;
    }
    list.innerHTML = data.map(l => `
      <div class="card border-l-4 border-[#6b8f71] mb-4">
        <div class="flex justify-between items-start">
          <b class="text-sm">${l.date} - ${l.machines?.name}</b>
          <div class="flex items-center gap-3">
            <span class="bg-[#6b8f71]/10 text-[#6b8f71] text-[10px] px-2 py-1 rounded font-bold">${(l.end_hour-l.start_hour).toFixed(1)}h</span>
            <i class="fa-solid fa-trash-can delete-btn text-xs text-red-400" onclick="deleteLog(${l.id})"></i>
          </div>
        </div>
        <p class="text-xs opacity-70 mt-1">${l.operator} | ${l.task}</p>
        ${l.memo ? `<p class="text-[10px] mt-2 italic opacity-60">ğŸ“ ${l.memo}</p>` : ''}
      </div>
    `).join("");
    if(!todayOnly) {
      const total = data.reduce((s,l) => s + (l.end_hour - l.start_hour), 0);
      document.getElementById("historyTotalHours").innerText = `åˆè¨ˆ: ${total.toFixed(1)} h`;
    }
  }

  async function renderDashboard(mId) {
    currentMachineId = mId;
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.replace('active', 'inactive');
      if (btn.id === `tab-${mId}`) btn.classList.replace('inactive', 'active');
    });
    let query = client.from("hour_logs").select("*, machines(name)");
    if (mId !== 'all') query = query.eq("machine_id", mId);
    const { data: logs } = await query;
    if(!logs) return;
    const logs26 = logs.filter(l => l.date.startsWith("2026"));
    const logs25 = logs.filter(l => l.date.startsWith("2025"));
    const recentList = document.getElementById("recentLogList");
    recentList.innerHTML = logs26.slice(0, 8).map(l => `<div class="flex justify-between border-b border-gray-100 dark:border-gray-800 pb-1"><span>${l.date.substring(5)} ${l.machines?.name}</span><span class="font-bold">${(l.end_hour-l.start_hour).toFixed(1)}h</span></div>`).join("");
    const totalH = logs26.reduce((s,l) => s + (l.end_hour - l.start_hour), 0);
    const totalF = logs26.reduce((s,l) => s + (l.fuel_amount || 0), 0);
    document.getElementById("kpi-hours").innerText = totalH.toFixed(1);
    document.getElementById("kpi-fuel").innerText = Math.floor(totalF);
    document.getElementById("kpi-avg").innerText = totalH > 0 ? (totalF/totalH).toFixed(1) : "0.0";
    document.getElementById("kpi-days").innerText = new Set(logs26.map(l => l.date)).size;
    const cat = {}; const tsk = {}; const opr = {}; const monthly = Array(12).fill(0);
    logs26.forEach(l => {
      const h = l.end_hour - l.start_hour;
      cat[l.category || "ä»–"] = (cat[l.category || "ä»–"] || 0) + h;
      tsk[l.task || "ä»–"] = (tsk[l.task || "ä»–"] || 0) + h;
      opr[l.operator || "ä»–"] = (opr[l.operator || "ä»–"] || 0) + h;
      if(l.date.split("-")[1]) monthly[parseInt(l.date.split("-")[1])-1] += h;
    });
    drawCharts(cat, tsk, opr, monthly, totalH, logs25);
  }

  function drawCharts(cat, task, op, monthly, totalH, logs25) {
    Object.values(window.charts).forEach(c => { if(c) c.destroy(); });
    const isDark = document.body.classList.contains('dark-mode');
    const color = '#6b8f71';
    const textColor = isDark ? '#e0e0e0' : '#3a3a3a';
    const donut = (ctx, data) => new Chart(ctx, { type:'doughnut', data:{labels:Object.keys(data), datasets:[{data:Object.values(data), backgroundColor:['#2d4031','#6b8f71','#a3b18a','#dad7cd','#588157'], borderWidth:0}]}, options:{cutout:'75%', maintainAspectRatio:false, plugins:{legend:{display:false}}}});
    window.charts.c1 = donut(document.getElementById('categoryShareChart'), cat);
    window.charts.c2 = donut(document.getElementById('taskShareChart'), task);
    window.charts.c3 = donut(document.getElementById('operatorShareChart'), op);
    window.charts.line = new Chart(document.getElementById('detailChart'), { type:'line', data:{labels:['1','2','3','4','5','6','7','8','9','10','11','12'], datasets:[{data:monthly, borderColor:color, backgroundColor:'rgba(107,143,113,0.1)', fill:true, tension:0.4}]}, options:{maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false},ticks:{color:textColor}},y:{grid:{color:isDark?'#444':'#eee'},ticks:{color:textColor}}}}});
    window.charts.bar = new Chart(document.getElementById('gradientBarChart'), { type:'bar', data:{labels:Object.keys(task), datasets:[{data:Object.values(task), backgroundColor:color, borderRadius:5}]}, options:{indexAxis:'y', maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{grid:{color:isDark?'#444':'#eee'},ticks:{color:textColor}},y:{grid:{display:false},ticks:{color:textColor}}}}});
    const lastH = logs25.reduce((s,l) => s + (l.end_hour - l.start_hour), 0) || 1;
    const ratio = Math.min(100, (totalH / lastH) * 100);
    window.charts.gauge = new Chart(document.getElementById('yearComparisonGauge'), { type:'doughnut', data:{datasets:[{data:[ratio, 100-ratio], backgroundColor:[color, isDark?'#333':'#eee'], borderWidth:0}]}, options:{rotation:-90, circumference:180, cutout:'80%', maintainAspectRatio:false, plugins:{legend:{display:false}}}});
    document.getElementById("detailCompareValue").innerText = ratio.toFixed(1) + "%";
  }

  function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    if (document.getElementById("dashboard").classList.contains("active")) renderDashboard(currentMachineId);
  }
</script>
</body>
</html>