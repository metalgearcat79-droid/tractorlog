<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex">
  <link rel="manifest" href="/tractorlog/manifest.json">
  <title>和農日向 Tractor Log - BI DASHBOARD</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
  /* --- 基本設定（既存維持） --- */
  body { background-color: #f7f4ef; color: #3a3a3a; font-family: "Hiragino Sans", "Noto Sans JP", sans-serif; margin: 0; padding: 0; transition: background 0.3s, color 0.3s; }
  body.dark-mode { background: #1a1c1e; color: #e0e0e0; }
  .view { display: none; }
  .view.active { display: block; }

  /* --- BIダッシュボード専用デザイン（画像再現） --- */
  #dashboard { background-color: #e2e8e3; min-height: 100vh; display: flex; }
  body.dark-mode #dashboard { background-color: #121412; }

  /* サイドナビゲーション（左ペイン） */
  .bi-sidebar { width: 240px; background: #2d4031; color: white; height: 100vh; position: sticky; top: 0; padding: 20px 0; flex-shrink: 0; }
  .bi-nav-item { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; transition: 0.2s; border-left: 4px solid transparent; font-weight: bold; opacity: 0.7; }
  .bi-nav-item:hover, .bi-nav-item.active { background: rgba(255,255,255,0.1); opacity: 1; border-left-color: #a3b18a; }

  /* メインコンテンツエリア（中・右ペイン） */
  .bi-content-wrapper { flex: 1; display: flex; padding: 24px; gap: 20px; overflow-y: auto; }
  .bi-main-col { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 20px; }
  .bi-right-col { width: 320px; flex-shrink: 0; display: flex; flex-direction: column; gap: 20px; }

  /* KPIカード（サークル） */
  .kpi-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; }
  .kpi-card { background: #6b8f71; color: white; padding: 15px; border-radius: 40px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
  .kpi-card .label { font-size: 10px; opacity: 0.8; font-weight: bold; text-transform: uppercase; }
  .kpi-card .value { font-size: 20px; font-weight: 900; line-height: 1.2; }

  /* BIカード（グラフ等の容器） */
  .bi-card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: relative; }
  body.dark-mode .bi-card { background: rgba(45, 45, 45, 0.6); backdrop-filter: blur(10px); color: #e0e0e0; border: 1px solid rgba(255, 255, 255, 0.1); }
  .bi-card-title { font-size: 12px; font-weight: 800; color: #6b8f71; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 0.1em; display: flex; align-items: center; }

  /* ドーナツ中央アイコン */
  .chart-wrapper { position: relative; height: 110px; }
  .chart-icon-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 20px; color: #6b8f71; pointer-events: none; }

  /* メンテナンス履歴リスト */
  .maint-list { display: flex; flex-direction: column; gap: 12px; }
  .maint-item { border-left: 3px solid #6b8f71; padding-left: 12px; }
  .maint-date { font-size: 10px; color: #888; font-weight: bold; }
  .maint-content { font-size: 12px; font-weight: bold; }

  /* タブ調整 */
  .tab-btn { white-space: nowrap; padding: 8px 16px; border-radius: 99px; font-size: 12px; font-weight: bold; transition: 0.2s; }
  .tab-btn.active { background: #2d4031; color: white; }
  .tab-btn.inactive { background: #fff; color: #6b8f71; }

  /* モバイル・タブレット対応 */
  @media (max-width: 1100px) {
    .bi-sidebar { display: none; }
    #dashboard { flex-direction: column; }
    .bi-content-wrapper { flex-direction: column; padding: 15px; }
    .bi-right-col { width: 100%; }
    .bi-main-col { min-width: 100%; }
    .kpi-row { grid-template-columns: repeat(3, 1fr); }
  }

  /* 共通UI要素維持 */
  .btn-main { background-color: #6b8f71; color: white; padding: 12px; border-radius: 8px; text-align: center; font-weight: bold; width: 100%; }
  .btn-back-light { background-color: #e5e7eb; color: #374151; }
  #sideMenu { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: white; z-index: 9999; transition: left 0.3s; padding: 20px; }
  #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 9998; display: none; }
  </style>
</head>
<body>
<div id="overlay"></div>

<div id="sideMenu">
  <div class="flex justify-between items-center mb-8">
    <h2 class="font-bold text-xl text-[#6b8f71]">メニュー</h2>
    <button onclick="closeSideMenu()" style="font-size: 36px; color: #aaa;">&times;</button>
  </div>
  <nav class="space-y-4">
    <button onclick="switchView('inputView')" class="w-full text-left p-4 hover:bg-gray-100 rounded-lg font-bold text-[#6b8f71]"><i class="fa-solid fa-pen-to-square mr-3"></i>ログ入力</button>
    <button onclick="switchView('todayView')" class="w-full text-left p-4 hover:bg-gray-100 rounded-lg font-bold text-[#6b8f71]"><i class="fa-solid fa-calendar-day mr-3"></i>本日の稼働状況</button>
    <button onclick="switchView('historyView')" class="w-full text-left p-4 hover:bg-gray-100 rounded-lg font-bold text-[#6b8f71]"><i class="fa-solid fa-magnifying-glass mr-3"></i>稼働履歴・検索</button>
    <button onclick="switchView('dashboard')" class="w-full text-left p-4 hover:bg-gray-100 rounded-lg font-bold text-[#6b8f71]"><i class="fa-solid fa-chart-line mr-3"></i>DASHBOARD</button>
    <button onclick="toggleDarkMode()" class="w-full text-left p-4 hover:bg-gray-100 rounded-lg font-bold text-[#6b8f71]"><i class="fa-solid fa-moon mr-3"></i>MODE切替</button>
  </nav>
</div>

<div id="mainContainer">
  <header id="pageHeader" class="flex flex-col items-center justify-center py-10 relative">
    <button id="menuBtn" class="absolute left-4 top-4 z-50 text-3xl text-[#6b8f71] p-2"><i class="fa-solid fa-bars"></i></button>
    <i class="fa-solid fa-tractor text-7xl text-[#6b8f71] mb-2"></i>
    <h1 class="text-2xl font-bold text-[#6b8f71] tracking-wider">和農日向 Tractor log</h1>
  </header>

  <div id="inputView" class="view active px-4 max-w-2xl mx-auto">
    <div class="card mb-4"><label class="block text-sm font-medium text-gray-500 mb-1">機械を選択</label><select id="machineSelect" class="w-full p-3 border rounded-lg bg-white outline-none"></select></div>
    <div class="card mb-4"><label class="block text-sm font-medium text-gray-500 mb-1">作業日</label><input type="date" id="workDate" class="w-full p-3 border rounded-lg" /></div>
    <div class="card mb-4"><label class="block text-sm font-medium text-gray-500 mb-1">オペレーター</label><select id="operatorSelect" class="w-full p-3 border rounded-lg outline-none"><option value="選択してください">選択してください</option><option value="阿曽 千一">阿曽 千一</option><option value="阿曽 右貢">阿曽 右貢</option><option value="菅原 亜美">菅原 亜美</option><option value="土井 達也">土井 達也</option><option value="阿曽 文平">阿曽 文平</option><option value="田中 武志">田中 武志</option><option value="赤塚 かおり">赤塚 かおり</option><option value="土門 元義">土門 元義</option><option value="その他">その他</option></select></div>
    <div class="card mb-4"><label class="block text-sm font-medium text-gray-500 mb-1">種別</label><select id="categorySelect" class="w-full p-3 border rounded-lg outline-none"><option value="">選択してください</option><option value="水稲">水稲</option><option value="そば">そば</option><option value="保全会">保全会</option><option value="小規模工事">小規模工事</option><option value="その他">その他</option></select></div>
    <div class="card mb-4"><label class="block text-sm font-medium text-gray-500 mb-1">作業内容</label><select id="taskSelect" class="w-full p-3 border rounded-lg"></select></div>
    <div class="card mb-4"><div class="flex space-x-4"><div class="flex-1"><label class="block text-sm font-medium text-gray-500 mb-1">稼働前</label><input type="number" id="hourBefore" class="w-full p-3 border rounded-lg" step="0.1" /></div><div class="flex-1"><label class="block text-sm font-medium text-gray-500 mb-1">稼働後</label><input type="number" id="hourAfter" class="w-full p-3 border rounded-lg" step="0.1" /></div></div></div>
    <div id="hourDiffDisplay" class="text-right font-bold text-[#6b8f71] mb-6 text-lg">稼働時間: 0.0 h</div>
    <div class="card mb-4"><label class="block text-sm font-medium text-gray-500 mb-1">給油量 (L)</label><input type="number" id="fuelAmount" class="w-full p-3 border rounded-lg" step="0.1" /></div>
    <div class="card mb-6"><label class="block text-sm font-medium text-gray-500 mb-1">メモ</label><textarea id="memoInput" class="w-full p-3 border rounded-lg" rows="2"></textarea></div>
    <button id="saveBtn" class="btn-main py-4">保存する</button>
  </div>

  <div id="todayView" class="view px-4 max-w-2xl mx-auto">
    <h2 class="text-xl font-bold text-[#6b8f71] mb-4 border-b pb-2">本日の稼働状況</h2>
    <div id="todayLogList" class="space-y-4 mb-10"></div>
    <button onclick="switchView('inputView')" class="w-full py-4 btn-back-light rounded-xl font-bold">TOPに戻る</button>
  </div>

  <div id="historyView" class="view px-4 max-w-2xl mx-auto">
    <h2 class="text-xl font-bold text-[#6b8f71] mb-4 border-b pb-2">稼働履歴・検索</h2>
    <div id="historyLogList" class="space-y-4 mb-10"></div>
    <button onclick="switchView('inputView')" class="w-full py-4 btn-back-light rounded-xl font-bold">TOPに戻る</button>
  </div>

  <div id="dashboard" class="view">
    <div class="bi-sidebar">
      <div class="px-8 mb-10"><i class="fa-solid fa-tractor text-4xl text-[#a3b18a]"></i><p class="text-[10px] font-black tracking-widest mt-2 opacity-50 uppercase">Tractor Log BI</p></div>
      <div class="bi-nav-item active" onclick="switchView('dashboard')"><i class="fa-solid fa-chart-pie mr-4"></i>DASHBOARD</div>
      <div class="bi-nav-item" onclick="switchView('inputView')"><i class="fa-solid fa-pen-to-square mr-4"></i>LOG INPUT</div>
      <div class="bi-nav-item" onclick="switchView('todayView')"><i class="fa-solid fa-calendar-day mr-4"></i>TODAY LOG</div>
      <div class="bi-nav-item" onclick="switchView('historyView')"><i class="fa-solid fa-magnifying-glass mr-4"></i>HISTORY</div>
      <div class="bi-nav-item" onclick="toggleDarkMode()"><i class="fa-solid fa-circle-half-stroke mr-4"></i>APPEARANCE</div>
    </div>

    <div class="bi-content-wrapper">
      <div class="bi-main-col">
        <div id="machineTabs" class="flex gap-2 overflow-x-auto no-scrollbar pb-2"></div>

        <div class="kpi-row">
          <div class="kpi-card"><div class="label">Total Hours</div><div class="value" id="kpi-hours">0.0</div></div>
          <div class="kpi-card"><div class="label">Total Fuel</div><div class="value" id="kpi-fuel">0</div></div>
          <div class="kpi-card"><div class="label">Avg Fuel</div><div class="value" id="kpi-avg">0.0</div></div>
          <div class="kpi-card"><div class="label">Work Days</div><div class="value" id="kpi-days">0</div></div>
          <div class="kpi-card bg-[#4a6b50]"><div class="label">Next Maint</div><div class="value">---</div></div>
        </div>

        <div class="flex gap-5 flex-1">
          <div class="flex flex-col gap-4 w-[160px]">
            <div class="bi-card p-3">
              <div class="bi-card-title">作物</div>
              <div class="chart-wrapper"><canvas id="categoryShareChart"></canvas><i class="fa-solid fa-wheat-awn chart-icon-center"></i></div>
            </div>
            <div class="bi-card p-3">
              <div class="bi-card-title">工程</div>
              <div class="chart-wrapper"><canvas id="taskShareChart"></canvas><i class="fa-solid fa-gears chart-icon-center"></i></div>
            </div>
            <div class="bi-card p-3">
              <div class="bi-card-title">担当</div>
              <div class="chart-wrapper"><canvas id="operatorShareChart"></canvas><i class="fa-solid fa-user-check chart-icon-center"></i></div>
            </div>
          </div>

          <div class="flex-1 flex flex-col gap-5">
            <div class="bi-card flex-1">
              <div class="bi-card-title">月別稼働推移 (Monthly Trends)</div>
              <div class="h-full max-h-[220px]"><canvas id="detailChart"></canvas></div>
            </div>
            <div class="bi-card flex-1">
              <div class="bi-card-title">作業内容分析 (Task Analysis)</div>
              <div class="h-full max-h-[220px]"><canvas id="gradientBarChart"></canvas></div>
            </div>
          </div>
        </div>
      </div>

      <div class="bi-right-col">
        <div class="bi-card">
          <div class="bi-card-title">稼働前年比 (YoY)</div>
          <div class="relative h-[120px]"><canvas id="yearComparisonGauge"></canvas></div>
          <div class="text-center mt-[-20px] font-black text-2xl text-[#6b8f71]" id="detailCompareValue">--%</div>
        </div>
        
        <div class="bi-card flex-1 overflow-hidden flex flex-col">
          <div class="bi-card-title">メンテナンス履歴</div>
          <div id="maintenanceHistory" class="maint-list mt-2 overflow-y-auto">
            <div class="maint-item"><div class="maint-date">2026-01-10</div><div class="maint-content">エンジンオイル交換 (阿曽)</div></div>
            <div class="maint-item"><div class="maint-date">2025-12-25</div><div class="maint-content">ロータリー爪交換 (土井)</div></div>
            <div class="maint-item"><div class="maint-date">2025-11-02</div><div class="maint-content">グリスアップ (田中)</div></div>
          </div>
        </div>

        <button onclick="switchView('inputView')" class="btn-main shadow-lg">新規ログを入力する</button>
      </div>
    </div>
  </div>
</div>

<div id="savePopup" class="hidden fixed inset-0 flex items-center justify-center z-[10001]"><div class="px-6 py-3 rounded-lg text-white bg-[#2f5d3a] shadow-xl font-bold">保存しました</div></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const SUPABASE_URL = "https://txsqxnwgolybcdclazdx.supabase.co";
  const SUPABASE_KEY = "sb_publishable_8JEM6Yyg5_oQpF-grdaxIw_rrxZBQYj";
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const menu = document.getElementById("sideMenu");
  const overlay = document.getElementById("overlay");
  let deleteTargetId = null;

  // チャート管理用
  window.charts = { history: null, category: null, task: null, operator: null, gradient: null, gauge: null };

  document.addEventListener("DOMContentLoaded", () => {
    if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
    const now = new Date();
    const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    document.getElementById("workDate").value = jstNow.toISOString().split("T")[0];
    loadMachines();
  });

  // --- 基本ユーティリティ ---
  function toggleDarkMode() {
    const isDark = document.body.classList.toggle('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    if (document.getElementById('dashboard').classList.contains('active')) {
      loadDashboardData(); // ダッシュボード表示中なら再描画
    }
    closeSideMenu();
  }

  function closeSideMenu() { 
    if(menu) menu.style.left = "-280px"; 
    if(overlay) overlay.style.display = "none"; 
  }

  function switchView(id) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    closeSideMenu();
    
    // ヘッダーの制御
    const header = document.getElementById("pageHeader");
    if (header) header.style.display = (id === 'dashboard') ? 'none' : 'flex';

    if (id === 'dashboard') loadDashboardData();
    if (id === 'todayView') loadTodayLogs();
    if (id === 'historyView') loadHistoryLogs();
    window.scrollTo(0, 0);
  }

  // --- 入力画面用ロジック ---
  async function loadMachines() {
    const { data } = await client.from("machines").select("*").order("name");
    const machineSelect = document.getElementById("machineSelect");
    if(machineSelect) {
      machineSelect.innerHTML = '<option value="">選択してください</option>' +
        (data || []).map(m => `<option value="${m.id}">${m.name}</option>`).join("");
    }
    // ダッシュボード用のタブも初期化
    const tabContainer = document.getElementById("machineTabs");
    if(tabContainer && data) {
      tabContainer.innerHTML = data.map(m => 
        `<button id="tab-${m.id}" onclick="renderMachineDetail(${m.id}, '${m.name}')" class="tab-btn inactive">${m.name}</button>`
      ).join("");
    }
  }

  const taskOptions = {
    "水稲": ["あぜ塗り", "クロぶつし", "起耕", "起耕+基肥散布", "粗代", "本代", "ロール運搬", "その他"],
    "そば": ["起耕", "起耕+基肥散布", "その他"],
    "保全会": ["ハンマーモア(春作業)", "ハンマーモア(秋作業)", "スライドモア(春作業)", "スライドモア(秋作業)", "その他"],
    "小規模工事": ["整地", "掘削", "埋戻し", "土砂運搬", "その他"],
    "その他": ["その他"]
  };

  document.getElementById("categorySelect").addEventListener("change", function () {
    const taskSelect = document.getElementById("taskSelect");
    taskSelect.innerHTML = (taskOptions[this.value] || []).map(t => `<option value="${t}">${t}</option>`).join("");
  });

  function calculate() {
    const diff = (parseFloat(document.getElementById("hourAfter").value) || 0) - (parseFloat(document.getElementById("hourBefore").value) || 0);
    const el = document.getElementById("hourDiffDisplay");
    el.textContent = `稼働時間: ${diff.toFixed(1)} h`;
    el.classList.toggle("text-red-500", diff < 0);
  }
  document.getElementById("hourAfter").addEventListener("input", calculate);

  // --- データ保存 ---
  document.getElementById("saveBtn").onclick = async function () {
    const mId = document.getElementById("machineSelect").value;
    const hA = parseFloat(document.getElementById("hourAfter").value);
    const op = document.getElementById("operatorSelect").value;
    if (!mId || isNaN(hA) || op === "選択してください") { alert("必須項目を入力してください"); return; }
    
    const { error } = await client.from("hour_logs").insert([{
      machine_id: mId, 
      date: document.getElementById("workDate").value, 
      operator: op,
      category: document.getElementById("categorySelect").value, 
      task: document.getElementById("taskSelect").value,
      start_hour: parseFloat(document.getElementById("hourBefore").value) || 0, 
      end_hour: hA, 
      fuel_amount: parseFloat(document.getElementById("fuelAmount").value) || 0, 
      memo: document.getElementById("memoInput").value
    }]);

    if (error) alert("保存失敗: " + error.message);
    else { 
      const p = document.getElementById("savePopup");
      p.classList.remove("hidden");
      setTimeout(() => location.reload(), 1200);
    }
  };

  // --- BIダッシュボード描画エンジン ---
  async function loadDashboardData() {
    const { data: machines } = await client.from("machines").select("*").order("name");
    if (!window.selectedMachineId && machines.length > 0) {
      renderMachineDetail(machines[0].id, machines[0].name);
    } else if(window.selectedMachineId) {
      const m = machines.find(x => x.id == window.selectedMachineId);
      renderMachineDetail(m.id, m.name);
    }
  }

  async function renderMachineDetail(mId, mName) {
    window.selectedMachineId = mId;
    
    // タブ表示の切り替え
    document.querySelectorAll('.tab-btn').forEach(b => {
      b.className = "tab-btn inactive bg-white text-[#6b8f71]";
    });
    const activeTab = document.getElementById(`tab-${mId}`);
    if(activeTab) activeTab.className = "tab-btn active bg-[#2d4031] text-white";

    const { data: logs } = await client.from("hour_logs").select("*").eq("machine_id", mId).order("date", { ascending: true });
    if (!logs) return;

    const logs26 = logs.filter(l => l.date.startsWith('2026'));
    const logs25 = logs.filter(l => l.date.startsWith('2025'));

    // 1. KPI集計
    const totalH = logs26.reduce((s, l) => s + (l.end_hour - l.start_hour), 0);
    const totalF = logs26.reduce((s, l) => s + (l.fuel_amount || 0), 0);
    const uniqueDays = new Set(logs26.map(l => l.date)).size;

    document.getElementById("kpi-hours").innerText = totalH.toFixed(1);
    document.getElementById("kpi-fuel").innerText = Math.floor(totalF);
    document.getElementById("kpi-avg").innerText = totalH > 0 ? (totalF/totalH).toFixed(2) : "0.0";
    document.getElementById("kpi-days").innerText = uniqueDays;

    // 2. グラフ用データ作成
    const catData = {}; const taskData = {}; const opData = {};
    logs26.forEach(l => {
      const h = l.end_hour - l.start_hour;
      catData[l.category || "その他"] = (catData[l.category || "その他"] || 0) + h;
      taskData[l.task || "未分類"] = (taskData[l.task || "未分類"] || 0) + h;
      opData[l.operator || "不明"] = (opData[l.operator || "不明"] || 0) + h;
    });

    // 3. 各チャート描画
    drawBiCharts(logs26, logs25, catData, taskData, opData);
  }

  function drawBiCharts(logs26, logs25, catData, taskData, opData) {
    const isDark = document.body.classList.contains('dark-mode');
    const colors = ['#2d4031', '#6b8f71', '#a3b18a', '#dad7cd', '#588157'];

    // 共通破棄
    Object.values(window.charts).forEach(c => { if(c) c.destroy(); });

    // 月別推移（折れ線）
    const monthlyH = Array(12).fill(0);
    logs26.forEach(l => {
      const m = parseInt(l.date.split('-')[1]) - 1;
      monthlyH[m] += (l.end_hour - l.start_hour);
    });
    window.charts.history = new Chart(document.getElementById('detailChart'), {
      type: 'line',
      data: {
        labels: ['1','2','3','4','5','6','7','8','9','10','11','12'],
        datasets: [{ label: '2026', data: monthlyH, borderColor: '#6b8f71', backgroundColor: 'rgba(107,143,113,0.1)', fill: true, tension: 0.4 }]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });

    // 3連ドーナツ
    const donutOpt = { cutout: '75%', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } };
    window.charts.category = new Chart(document.getElementById('categoryShareChart'), { type: 'doughnut', data: { datasets: [{ data: Object.values(catData), backgroundColor: colors }] }, options: donutOpt });
    window.charts.task = new Chart(document.getElementById('taskShareChart'), { type: 'doughnut', data: { datasets: [{ data: Object.values(taskData), backgroundColor: colors }] }, options: donutOpt });
    window.charts.operator = new Chart(document.getElementById('operatorShareChart'), { type: 'doughnut', data: { datasets: [{ data: Object.values(opData), backgroundColor: colors }] }, options: donutOpt });

    // 作業内容グラデーション棒グラフ
    const ctxGrad = document.getElementById('gradientBarChart').getContext('2d');
    const gradient = ctxGrad.createLinearGradient(0, 0, 400, 0);
    gradient.addColorStop(0, '#2d4031');
    gradient.addColorStop(1, '#a3b18a');

    window.charts.gradient = new Chart(ctxGrad, {
      type: 'bar',
      data: {
        labels: Object.keys(taskData),
        datasets: [{ data: Object.values(taskData), backgroundColor: gradient, borderRadius: 10 }]
      },
      options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });

    // 前年比ゲージ
    const h26 = Object.values(monthlyH).reduce((a,b)=>a+b, 0);
    const h25 = logs25.reduce((s,l)=>s+(l.end_hour-l.start_hour), 0.1);
    const ratio = Math.min(100, (h26 / h25) * 100);
    document.getElementById("detailCompareValue").innerText = ratio.toFixed(1) + "%";

    window.charts.gauge = new Chart(document.getElementById('yearComparisonGauge'), {
      type: 'doughnut',
      data: { datasets: [{ data: [ratio, 100 - ratio], backgroundColor: ['#6b8f71', isDark ? '#333' : '#eee'], borderWidth: 0 }] },
      options: { rotation: -90, circumference: 180, cutout: '80%', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });
  }

  // --- 履歴表示（既存ロジックを微調整） ---
  async function loadTodayLogs() { 
    const today = new Date().toISOString().split("T")[0];
    const { data } = await client.from("hour_logs").select("*, machines(name)").eq("date", today).order("created_at", { ascending: false }); 
    renderLogList(data, "todayLogList"); 
  }

  async function loadHistoryLogs() { 
    const { data } = await client.from("hour_logs").select("*, machines(name)").order("date", { ascending: false }).limit(50); 
    renderLogList(data, "historyLogList"); 
  }

  function renderLogList(data, elementId) {
    const list = document.getElementById(elementId);
    if(!list) return;
    list.innerHTML = data?.length ? "" : "<p class='text-center opacity-40 py-10'>データがありません</p>";
    data?.forEach(log => {
      const diff = (log.end_hour - log.start_hour).toFixed(1);
      list.innerHTML += `
        <div class="card border-l-4 border-[#6b8f71] p-4 mb-4 relative">
          <div class="text-xs font-bold opacity-50 mb-1">${log.date} | ${diff} h</div>
          <div class="font-bold">${log.machines?.name} / ${log.operator}</div>
          <div class="text-sm opacity-70">${log.category} : ${log.task}</div>
        </div>`;
    });
  }

  if ("serviceWorker" in navigator) navigator.serviceWorker.register('/tractorlog/sw.js');
</script>