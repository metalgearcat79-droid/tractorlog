<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å’Œè¾²æ—¥å‘ Tractor Log</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    body {
      background-color: #f7f4ef;
      color: #3a3a3a;
      font-family: "Hiragino Sans", "Noto Sans JP", sans-serif;
      margin: 0;
      padding: 0;
    }

.hidden { display: none; }
.fade-in { animation: fadeIn 0.3s forwards; }
.fade-out { animation: fadeOut 0.3s forwards; }

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to   { opacity: 1; transform: translateY(0); }
}

@keyframes fadeOut {
  from { opacity: 1; transform: translateY(0); }
  to   { opacity: 0; transform: translateY(10px); }
}
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      position: relative;
    }
    .btn-main {
      background-color: #6b8f71;
      color: white;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      width: 100%;
      transition: all 0.2s;
    }
    .btn-main:active {
      background-color: #587a5f;
      transform: scale(0.98);
    }
#overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 9998;
  display: none;
}
#sideMenu {
  position: fixed;
  top: 0;
  left: -280px;
  width: 280px;
  height: 100%;
  background: white;
  z-index: 9999;
  transition: left 0.3s ease;
  padding: 20px;
  padding-top: 60px;
}

@media (max-width: 480px) {
  #sideMenu {
    width: 240px;
  }
}

#overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.4);
  z-index: 9998;
  display: none;
}

    .view { display: none; padding: 20px; }
    .view.active { display: block; }
  </style>
</head>

<body class="pb-10 bg-[#f7f4ef] text-gray-800">

<div id="overlay"></div>

<div id="sideMenu">
  <div class="menuContent">
    <div class="flex justify-between items-center mb-8">
      <h2 class="font-bold text-xl text-[#6b8f71]">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
      <button id="closeMenuBtn" style="font-size: 36px; color: #aaa; line-height: 1;">&times;</button>
    </div>

<nav class="space-y-4">
<p>FlorÃ©na Tractor Log ã®åˆ push è¨˜å¿µğŸŒ¸</p>

  <!-- ãƒ­ã‚°å…¥åŠ› -->
  <button onclick="switchView('inputView')" 
    class="w-full text-left p-4 bg-[#f7f4ef] rounded-lg font-bold text-[#6b8f71] flex items-center">
    <i class="fa-solid fa-pen-to-square mr-3 text-lg"></i>ãƒ­ã‚°å…¥åŠ›
  </button>

  <!-- æœ¬æ—¥ã®ç¨¼åƒçŠ¶æ³ -->
  <button onclick="switchView('todayView')" 
    class="w-full text-left p-4 hover:bg-[#f7f4ef] rounded-lg font-bold flex items-center text-[#6b8f71]">
    <i class="fa-solid fa-calendar-day mr-3 text-lg"></i>æœ¬æ—¥ã®ç¨¼åƒçŠ¶æ³
  </button>

  <!-- ç¨¼åƒå±¥æ­´ãƒ»æ¤œç´¢ -->
  <button onclick="switchView('historyView')" 
    class="w-full text-left p-4 hover:bg-[#f7f4ef] rounded-lg font-bold flex items-center text-[#6b8f71]">
    <i class="fa-solid fa-magnifying-glass mr-3 text-lg"></i>ç¨¼åƒå±¥æ­´ãƒ»æ¤œç´¢
  </button>

  <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆæº–å‚™ä¸­ï¼‰ -->
  <button disabled 
    class="w-full text-left p-4 hover:bg-[#f7f4ef] rounded-lg font-bold flex items-center text-[#6b8f71] opacity-60 cursor-not-allowed">
    <i class="fa-solid fa-chart-line mr-3 text-lg"></i>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆæº–å‚™ä¸­ï¼‰
  </button>

  <!-- ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æƒ…å ±ï¼ˆæº–å‚™ä¸­ï¼‰ -->
  <button disabled 
    class="w-full text-left p-4 hover:bg-[#f7f4ef] rounded-lg font-bold flex items-center text-[#6b8f71] opacity-60 cursor-not-allowed">
    <i class="fa-solid fa-wrench mr-3 text-lg"></i>ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æƒ…å ±ï¼ˆæº–å‚™ä¸­ï¼‰
  </button>

  <!-- ä¿®ç†å±¥æ­´ï¼ˆæº–å‚™ä¸­ï¼‰ -->
  <button disabled 
    class="w-full text-left p-4 hover:bg-[#f7f4ef] rounded-lg font-bold flex items-center text-[#6b8f71] opacity-60 cursor-not-allowed">
    <i class="fa-solid fa-screwdriver-wrench mr-3 text-lg"></i>ä¿®ç†å±¥æ­´ï¼ˆæº–å‚™ä¸­ï¼‰
  </button>

</nav>
      </button>
    </nav>
  </div>
</div>

  <div class="max-w-2xl mx-auto">
    <header class="flex flex-col items-center justify-center py-10 relative">
      <button id="menuBtn" class="absolute left-4 top-4 sm:top-8 z-50 text-3xl text-[#6b8f71] p-2 bg-transparent border-none">
        <i class="fa-solid fa-bars"></i>
      </button>

      

      <i class="fa-solid fa-tractor text-7xl text-[#6b8f71] mb-2"></i>
      <h1 class="text-xl sm:text-2xl font-bold text-[#6b8f71] tracking-wider text-center">å’Œè¾²æ—¥å‘ Tractor log</h1>
    </header>

    <div id="inputView" class="view active">
      <div class="card mb-4">
        <label class="block text-base md:text-sm font-medium text-gray-500 mb-1">æ©Ÿæ¢°ã‚’é¸æŠ</label>
        <select id="machineSelect"
  class="w-full p-3 text-base border rounded-lg bg-white outline-none focus:border-[#6b8f71]">
        <option value="">æ©Ÿæ¢°ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
     </select>
      </div>

      <div class="card mb-4">
        <label class="block text-base md:text-sm font-medium text-gray-500 mb-1">ä½œæ¥­æ—¥</label>
        <input type="date" id="workDate" class="w-full p-3 border rounded-lg outline-none" />
      </div>

      <div class="card mb-4">
        <label class="block text-base md:text-sm font-medium text-gray-500 mb-1">ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼</label>
        <select id="operatorSelect" class="w-full p-3 border rounded-lg outline-none">
          <option value="é¸æŠã—ã¦ãã ã•ã„">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="é˜¿æ›½ åƒä¸€">é˜¿æ›½ åƒä¸€</option>
          <option value="é˜¿æ›½ å³è²¢">é˜¿æ›½ å³è²¢</option>
          <option value="è…åŸ äºœç¾">è…åŸ äºœç¾</option>
          <option value="åœŸäº• é”ä¹Ÿ">åœŸäº• é”ä¹Ÿ</option>
          <option value="é˜¿æ›½ æ–‡å¹³">é˜¿æ›½ æ–‡å¹³</option>
          <option value="ç”°ä¸­ æ­¦å¿—">ç”°ä¸­ æ­¦å¿—</option>
          <option value="èµ¤å¡š ã‹ãŠã‚Š">èµ¤å¡š ã‹ãŠã‚Š</option>
          <option value="åœŸé–€ å…ƒç¾©">åœŸé–€ å…ƒç¾©</option>
          <option value="ãã®ä»–">ãã®ä»–</option>
        </select>
      </div>

      <div class="card mb-4">
        <label class="block text-base md:text-sm font-medium text-gray-500 mb-1">ç¨®åˆ¥</label>
        <select id="categorySelect" class="w-full p-3 border rounded-lg outline-none">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="æ°´ç¨²">æ°´ç¨²</option>
          <option value="ãã°">ãã°</option>
          <option value="ä¿å…¨ä¼š">ä¿å…¨ä¼š</option>
          <option value="å°è¦æ¨¡å·¥äº‹">å°è¦æ¨¡å·¥äº‹</option>
          <option value="ãã®ä»–">ãã®ä»–</option>
        </select>
      </div>

      <div class="card mb-4">
        <label class="block text-base md:text-sm font-medium text-gray-500 mb-1">ä½œæ¥­å†…å®¹</label>
        <select id="taskSelect" class="w-full p-3 border rounded-lg outline-none"></select>
      </div>

      <div class="card mb-4">
        <div class="flex space-x-4">
          <div class="flex-1">
            <label class="block text-base md:text-sm font-medium text-gray-500 mb-1">ç¨¼åƒå‰ãƒ¡ãƒ¼ã‚¿ãƒ¼</label>
            <input type="number" id="hourBefore" class="w-full p-3 border rounded-lg mt-1" step="0.1" />
          </div>
          <div class="flex-1">
            <label class="block text-base md:text-sm font-medium text-gray-500 mb-1">ç¨¼åƒå¾Œãƒ¡ãƒ¼ã‚¿ãƒ¼</label>
            <input type="number" id="hourAfter" class="w-full p-3 border rounded-lg mt-1" step="0.1" />
          </div>
        </div>
      </div>

      <div id="hourDiffDisplay" class="text-right font-bold text-[#6b8f71] mb-6 text-lg">
        ç¨¼åƒæ™‚é–“: 0.0 h
      </div>

      <div class="card mb-6">
        <label class="block text-base md:text-sm font-medium text-gray-500 mb-1">ãƒ¡ãƒ¢</label>
        <textarea id="memoInput" class="w-full p-3 border rounded-lg outline-none" rows="3" placeholder="å‚™è€ƒãªã©"></textarea>
      </div>

      <button id="saveBtn" class="btn-main text-base py-3">ä¿å­˜ã™ã‚‹</button>
    </div>

<div id="savePopup" class="hidden fixed inset-0 flex items-center justify-center z-50">
  <div class="px-6 py-3 rounded-lg text-white text-lg shadow-lg"
       style="background-color: #2f5d3a;">
    ä¿å­˜ã—ã¾ã—ãŸ
  </div>
</div>


    <div id="todayView" class="view">
      <div class="flex justify-between items-center border-b-2 border-[#6b8f71] pb-3 mb-6">
        <h2 class="text-xl font-bold text-[#6b8f71] flex items-center">
          <i class="fa-solid fa-calendar-day mr-2"></i>æœ¬æ—¥ã®ç¨¼åƒçŠ¶æ³
        </h2>
        <button onclick="loadTodayLogs()" class="text-sm bg-white px-3 py-1 rounded-lg shadow text-gray-600 active:scale-95">
          <i class="fa-solid fa-rotate"></i> æ›´æ–°
        </button>
      </div>

      <div id="todayLogList" class="space-y-4 mb-10"></div>

      <button onclick="switchView('inputView')" class="w-full py-4 bg-gray-200 text-gray-700 rounded-xl font-bold flex items-center justify-center shadow-sm active:bg-gray-300">
        <i class="fa-solid fa-circle-arrow-left mr-2 text-xl"></i>ãƒ­ã‚°å…¥åŠ›ã«æˆ»ã‚‹
      </button>
    </div>

    <div id="historyView" class="view">
      <div class="flex justify-between items-center border-b-2 border-[#6b8f71] pb-3 mb-6">
        <h2 class="text-xl font-bold text-[#6b8f71] flex items-center">
          <i class="fa-solid fa-magnifying-glass mr-2"></i>éå»ã®å±¥æ­´ãƒ»æ¤œç´¢
        </h2>
        <div id="historyTotalHours" class="text-sm font-bold bg-[#6b8f71] text-white px-3 py-1 rounded-full">
          åˆè¨ˆ: 0.0 h
        </div>
      </div>

      <div class="card mb-6 bg-white border border-gray-200">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">

          <div>
            <label class="text-xs font-bold text-gray-500 mb-1 block">è¡¨ç¤ºæœˆ</label>
            <input type="month" id="filterMonth" onchange="loadHistoryLogs()" class="w-full p-2 border rounded-lg bg-white" />
          </div>

          <div>
            <label class="text-xs font-bold text-gray-500 mb-1 block">æ—¥ä»˜</label>
            <input type="date" id="filterDay" onchange="loadHistoryLogs()" class="w-full p-2 border rounded-lg bg-white text-sm">
          </div>

          <div>
            <label class="text-xs font-bold text-gray-500 mb-1 block">ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼</label>
            <select id="filterOperator" onchange="loadHistoryLogs()" class="w-full p-2 border rounded-lg bg-white text-sm">
              <option value="ã™ã¹ã¦">ã™ã¹ã¦</option>
              <option value="é˜¿æ›½ åƒä¸€">é˜¿æ›½ åƒä¸€</option>
              <option value="é˜¿æ›½ å³è²¢">é˜¿æ›½ å³è²¢</option>
              <option value="è…åŸ äºœç¾">è…åŸ äºœç¾</option>
              <option value="åœŸäº• é”ä¹Ÿ">åœŸäº• é”ä¹Ÿ</option>
              <option value="é˜¿æ›½ æ–‡å¹³">é˜¿æ›½ æ–‡å¹³</option>
              <option value="ç”°ä¸­ æ­¦å¿—">ç”°ä¸­ æ­¦å¿—</option>
              <option value="èµ¤å¡š ã‹ãŠã‚Š">èµ¤å¡š ã‹ãŠã‚Š</option>
              <option value="åœŸé–€ å…ƒç¾©">åœŸé–€ å…ƒç¾©</option>
              <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
          </div>

          <div>
            <label class="text-xs font-bold text-gray-500 mb-1 block">æ©Ÿæ¢°</label>
            <select id="filterMachine" onchange="loadHistoryLogs()" class="w-full p-2 border rounded-lg bg-white text-sm"></select>
          </div>

          <div>
            <label class="text-xs font-bold text-gray-500 mb-1 block">ä½œæ¥­å†…å®¹</label>
            <select id="filterTask" onchange="loadHistoryLogs()" class="w-full p-2 border rounded-lg bg-white text-sm">
            <option value="ã™ã¹ã¦">ã™ã¹ã¦</option>
         </select>
         </div>

        </div>
      </div>

      <div id="historyLogList" class="space-y-4 mb-10"></div>

      <button onclick="switchView('inputView')" class="w-full py-4 bg-gray-200 text-gray-700 rounded-xl font-bold flex items-center justify-center shadow-sm active:bg-gray-300">
        <i class="fa-solid fa-circle-arrow-left mr-2 text-xl"></i>ãƒ­ã‚°å…¥åŠ›ã«æˆ»ã‚‹
      </button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  const SUPABASE_URL = "https://txsqxnwgolybcdclazdx.supabase.co";
  const SUPABASE_KEY = "sb_publishable_8JEM6Yyg5_oQpF-grdaxIw_rrxZBQYj";
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const menu = document.getElementById("sideMenu");
  const overlay = document.getElementById("overlay");

  // -----------------------------
  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†ï¼ˆãƒ­ã‚°å…¥åŠ›ãƒšãƒ¼ã‚¸ç”¨ï¼‰
  // -----------------------------
  document.addEventListener("DOMContentLoaded", () => {
    const now = new Date();
    now.setHours(now.getHours() + 9);
    const today = now.toISOString().split("T")[0];
    document.getElementById("workDate").value = today;

    loadMachines();
  });

  // -----------------------------
  // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹é–‰ãƒ­ã‚¸ãƒƒã‚¯
  // -----------------------------
  document.getElementById("menuBtn").onclick = () => {
    menu.style.left = "0px";
    overlay.style.display = "block";
  };

  document.getElementById("closeMenuBtn").onclick = () => {
    menu.style.left = "-280px";
    overlay.style.display = "none";
  };

  overlay.onclick = () => {
    menu.style.left = "-280px";
    overlay.style.display = "none";
  };

  // -----------------------------
  // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
  // -----------------------------
  function switchView(id) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    menu.style.left = "-280px";
    overlay.style.display = "none";

    if (id === 'todayView') loadTodayLogs();

    if (id === 'historyView') {
      loadTaskFilterOptions();
      loadHistoryLogs();
    }

    window.scrollTo(0, 0);
  }

  // -----------------------------
  // æ©Ÿæ¢°ãƒã‚¹ã‚¿ã®èª­ã¿è¾¼ã¿
  // -----------------------------
  async function loadMachines() {
    const { data } = await client.from("machines").select("*").order("name");
    const entrySelect = document.getElementById("machineSelect");
    const filterSelect = document.getElementById("filterMachine");

    const optionsHtml =
      '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
      (data || [])
        .map(m => `<option value="${m.id}">${m.manufacturer} ${m.name}</option>`)
        .join("");

    entrySelect.innerHTML = optionsHtml;
    filterSelect.innerHTML = optionsHtml;
  }

  // -----------------------------
  // ç¨®åˆ¥ â†’ ä½œæ¥­å†…å®¹ã®å¯¾å¿œè¡¨
  // -----------------------------
  const taskOptions = {
    "æ°´ç¨²": ["ã‚ãœå¡—ã‚Š", "ã‚¯ãƒ­ã¶ã¤ã—", "èµ·è€•", "èµ·è€•+åŸºè‚¥æ•£å¸ƒ", "ç²—ä»£", "æœ¬ä»£", "ãƒ­ãƒ¼ãƒ«é‹æ¬", "ãã®ä»–"],
    "ãã°": ["èµ·è€•", "èµ·è€•+åŸºè‚¥æ•£å¸ƒ", "ãã®ä»–"],
    "ä¿å…¨ä¼š": ["ãƒãƒ³ãƒãƒ¼ãƒ¢ã‚¢(æ˜¥ä½œæ¥­)", "ãƒãƒ³ãƒãƒ¼ãƒ¢ã‚¢(ç§‹ä½œæ¥­)", "ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ¢ã‚¢(æ˜¥ä½œæ¥­)", "ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ¢ã‚¢(ç§‹ä½œæ¥­)", "ãã®ä»–"],
    "å°è¦æ¨¡å·¥äº‹": ["æ•´åœ°", "æ˜å‰Š", "åŸ‹æˆ»ã—", "åœŸç ‚é‹æ¬", "ãã®ä»–"],
    "ãã®ä»–": ["è‡ªç”±å…¥åŠ›"]
  };

  // -----------------------------
  // ç¨®åˆ¥ã‚’é¸ã‚“ã ã‚‰ä½œæ¥­å†…å®¹ã‚’æ›´æ–°
  // -----------------------------
  document.getElementById("categorySelect").addEventListener("change", function () {
    const category = this.value;
    const taskSelect = document.getElementById("taskSelect");

    taskSelect.innerHTML = "";
    const tasks = taskOptions[category] || [];

    tasks.forEach(task => {
      const option = document.createElement("option");
      option.value = task;
      option.textContent = task;
      taskSelect.appendChild(option);
    });
  });

  // -----------------------------
  // æ©Ÿæ¢°é¸æŠ â†’ å‰å›ãƒ¡ãƒ¼ã‚¿ãƒ¼èª­ã¿è¾¼ã¿
  // -----------------------------
  async function loadLastEndHour() {
    const machineId = document.getElementById("machineSelect").value;
    if (!machineId) return;

    const { data, error } = await client
      .from("hour_logs")
      .select("end_hour")
      .eq("machine_id", machineId)
      .order("date", { ascending: false })
      .order("created_at", { ascending: false })
      .limit(1);

    if (error) {
      console.error("ãƒ¡ãƒ¼ã‚¿ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
      return;
    }

    const hourBeforeInput = document.getElementById("hourBefore");
    hourBeforeInput.value = data?.[0]?.end_hour || "";
  }

  document.getElementById("machineSelect").addEventListener("change", loadLastEndHour);

  document.getElementById("machineSelect").addEventListener("change", async function () {
    if (!this.value) return;

    const { data } = await client
      .from("hour_logs")
      .select("end_hour")
      .eq("machine_id", this.value)
      .order("date", { ascending: false })
      .order("created_at", { ascending: false })
      .limit(1);

    if (data && data[0]) {
      document.getElementById("hourBefore").value = data[0].end_hour;
      if (typeof calculate === "function") calculate();
    }
  });

  // -----------------------------
  // ç¨¼åƒæ™‚é–“è¨ˆç®—
  // -----------------------------
  function calculate() {
    const before = parseFloat(document.getElementById("hourBefore").value) || 0;
    const after = parseFloat(document.getElementById("hourAfter").value) || 0;

    const diff = after - before;

    const diffElement = document.getElementById("hourDiffDisplay");
    if (diffElement) {
      diffElement.textContent = "ç¨¼åƒæ™‚é–“: " + diff.toFixed(1) + " h";

          if (diff < 0) {
      diffElement.classList.add("text-red-500");
    } else {
      diffElement.classList.remove("text-red-500");
    }
  }

  return diff;
}


  document.getElementById("hourAfter").addEventListener("input", calculate);

    function showSavePopup() {
    const popup = document.getElementById("savePopup");
    popup.classList.remove("hidden");
    popup.classList.add("fade-in");

    setTimeout(() => {
      popup.classList.remove("fade-in");
      popup.classList.add("fade-out");

      setTimeout(() => {
        popup.classList.add("hidden");
        popup.classList.remove("fade-out");
      }, 300);
    }, 1500);
  }

  // -----------------------------
  // ä¿å­˜å‡¦ç†
  // -----------------------------
  document.getElementById("saveBtn").onclick = async function () {
    const machineId = document.getElementById("machineSelect").value;
    const workDate = document.getElementById("workDate").value;
    const operator = document.getElementById("operatorSelect").value;
    const category = document.getElementById("categorySelect").value;
    const task = document.getElementById("taskSelect").value;
    const hBefore = parseFloat(document.getElementById("hourBefore").value);
    const hAfter = parseFloat(document.getElementById("hourAfter").value);
    const memo = document.getElementById("memoInput").value;

    if (!machineId || !workDate || operator === "é¸æŠã—ã¦ãã ã•ã„" || isNaN(hAfter)) {
      alert("å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }

    const { error } = await client.from("hour_logs").insert([
      {
        machine_id: machineId,
        date: workDate,
        operator: operator,
        category: category,
        task: task,
        start_hour: hBefore,
        end_hour: hAfter,
        memo: memo
      }
    ]);

    if (error) {
      alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
    } else {
      showSavePopup();
      setTimeout(() => {
     location.reload();
     }, 1800);

    }
  };

  // -----------------------------
  // ä½œæ¥­å†…å®¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼èª­ã¿è¾¼ã¿ï¼ˆâ˜…æ–°è¦è¿½åŠ ï¼‰
  // -----------------------------
  async function loadTaskFilterOptions() {
    const { data, error } = await client
      .from("hour_logs")
      .select("task")
      .order("task", { ascending: true });

    if (error) {
      console.error("ä½œæ¥­å†…å®¹å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
      return;
    }

    const uniqueTasks = [...new Set(data.map(item => item.task))];

    const select = document.getElementById("filterTask");
    if (!select) return;

    select.innerHTML = '<option value="ã™ã¹ã¦">ã™ã¹ã¦</option>';

    uniqueTasks.forEach(task => {
      if (task) {
        const option = document.createElement("option");
        option.value = task;
        option.textContent = task;
        select.appendChild(option);
      }
    });
  }

  // -----------------------------
  // ãƒ­ã‚°è¡¨ç¤ºç”¨
  // -----------------------------
  function renderLogs(data, elementId) {
    const list = document.getElementById(elementId);
    list.innerHTML = "";
    if (!data || data.length === 0) {
      list.innerHTML = "<p class='text-center text-gray-400'>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>";
      return;
    }

    data.forEach(log => {
      const diff = (log.end_hour - log.start_hour).toFixed(1);
      list.innerHTML += `
        <div class="mx-2 card border-l-4 border-[#6b8f71] relative">
          <div class="flex justify-between items-start mb-2">
            <span class="text-xs font-bold text-gray-400">${log.date}</span>
            <span class="bg-[#f7f4ef] text-[#6b8f71] px-2 py-1 rounded text-xs font-bold">${diff} h</span>
          </div>
          <div class="font-bold text-gray-700">${log.machines?.name || 'ä¸æ˜'} / ${log.operator}</div>
          <div class="text-sm text-gray-500">${log.category} - ${log.task}</div>
          ${log.memo ? `<div class="text-xs mt-2 text-gray-400 bg-gray-50 p-2 rounded">${log.memo}</div>` : ""}
        </div>
      `;
    });
  }

// -----------------------------
// æœ¬æ—¥ã®ãƒ­ã‚°èª­ã¿è¾¼ã¿
// -----------------------------
async function loadTodayLogs() {
  const today = new Date().toISOString().split("T")[0];
  const { data } = await client
    .from("hour_logs")
    .select("*, machines(name)")
    .eq("date", today)
    .order("created_at", { ascending: false });

  const list = document.getElementById("todayLogList");
  list.innerHTML = "";

  data.forEach(log => {
    const diff = (log.end_hour - log.start_hour).toFixed(1);

    list.innerHTML += `
      <div class="card border-l-4 border-[#6b8f71] relative">

        <!-- ã‚´ãƒŸç®±ï¼ˆå³ä¸Šï¼‰ -->
        <button 
          onclick="deleteLog(${log.id})"
          class="absolute top-3 right-4 text-gray-400 hover:text-red-500"
        >
          <i class="fa-solid fa-trash"></i>
        </button>

        <!-- ç¨¼åƒæ™‚é–“ãƒãƒƒã‚¸ -->
        <div class="flex justify-end items-start mb-2">
          <span class="bg-[#f7f4ef] text-[#6b8f71] px-2 py-1 rounded text-xs font-bold mr-6">
            ${diff} h
          </span>
        </div>

        <div class="text-xs font-bold text-gray-400">${log.date}</div>
        <div class="font-bold text-gray-700">${log.machines?.name || 'ä¸æ˜'} / ${log.operator}</div>
        <div class="text-sm text-gray-500">${log.category} - ${log.task}</div>
        ${log.memo ? `<div class="text-xs mt-2 text-gray-400 bg-gray-50 p-2 rounded">${log.memo}</div>` : ""}
      </div>
    `;
  });
}

  // -----------------------------
  // å±¥æ­´èª­ã¿è¾¼ã¿ï¼ˆâ˜…task æ¡ä»¶è¿½åŠ æ¸ˆã¿ï¼‰
  // -----------------------------
  async function loadHistoryLogs() {
    let query = client.from("hour_logs").select("*, machines(name)");

    const month = document.getElementById("filterMonth").value;
    const day = document.getElementById("filterDay").value;
    const op = document.getElementById("filterOperator").value;


    const mach = document.getElementById("filterMachine").value;
    const task = document.getElementById("filterTask")?.value || "ã™ã¹ã¦";

    if (day) query = query.eq("date", day);
    else if (month) query = query.gte("date", `${month}-01`).lte("date", `${month}-31`);

    if (op !== "ã™ã¹ã¦") query = query.eq("operator", op);
    if (mach) query = query.eq("machine_id", mach);

    // â˜… ä½œæ¥­å†…å®¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    if (task !== "ã™ã¹ã¦") query = query.eq("task", task);

    const { data } = await query.order("date", { ascending: false });
    renderLogs(data, "historyLogList");

    const total = (data || []).reduce((sum, log) => sum + (log.end_hour - log.start_hour), 0);
    document.getElementById("historyTotalHours").textContent = `åˆè¨ˆ: ${total.toFixed(1)} h`;
  }
</script>
</body>
</html>