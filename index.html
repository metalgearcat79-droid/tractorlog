<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex">
  <link rel="manifest" href="/tractorlog/manifest.json">
  <title>和農日向 Tractor Log</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* --- 基本スタイル --- */
    body {
      background-color: #e2e8e3;
      color: #3a3a3a;
      font-family: "Hiragino Sans", "Noto Sans JP", sans-serif;
      margin: 0;
    }

    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    #sideMenu {
      position: fixed;
      top: 0;
      left: -280px;
      width: 280px;
      height: 100%;
      background: white;
      z-index: 9999;
      transition: left 0.3s ease;
      padding: 20px;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
    }

    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: 9998;
      display: none;
    }

    .menu-item {
      width: 100%;
      text-align: left;
      padding: 0.8rem;
      border-radius: 0.5rem;
      font-weight: bold;
      color: #6b8f71;
      display: flex;
      align-items: center;
      font-size: 0.9rem;
    }

    select,
    input,
    textarea {
      color: #3a3a3a !important;
      background-color: #ffffff !important;
      border: 1px solid #ddd;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }

    .btn-main {
      background-color: #6b8f71;
      color: white;
      padding: 14px;
      border-radius: 12px;
      text-align: center;
      font-weight: bold;
      width: 100%;
      display: block;
    }

    .btn-sub {
      background-color: #6b8f71;
      color: white;
      padding: 12px;
      border-radius: 10px;
      text-align: center;
      font-weight: bold;
      width: 160px;
      max-width: 40%;
      margin: 20px auto 0;
      display: block;
      border: none;
      cursor: pointer;
    }

    .log-badge {
      background-color: #f3f4f6;
      color: #374151;
    }

    #dashboard.active {
      display: flex !important;
      flex-direction: column;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .bi-header {
      height: 65px;
      display: flex;
      align-items: center;
      background: #2d4031;
      color: white;
      flex-shrink: 0;
      width: 100%;
      padding: 0 20px;
    }

    .dashboard-top-bar {
      flex-shrink: 0;
      padding: 10px 15px;
    }

    .main-top-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: stretch;
    }

    .kpi-section {
      flex: 1;
      min-width: 320px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .ranking-section {
      flex: 0.4;
      min-width: 250px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 12px;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
    }

    .kpi-card {
      background: #6b8f71;
      color: white;
      padding: 8px 2px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .kpi-label {
      font-size: 9px;
      font-weight: bold;
      opacity: 0.9;
    }

    .kpi-value-container {
      display: flex;
      align-items: baseline;
      gap: 1px;
    }

    .kpi-value {
      font-size: 14px;
      font-weight: 900;
    }

    .kpi-unit {
      font-size: 8px;
      opacity: 0.8;
      font-weight: bold;
    }

    .bi-container {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      padding: 12px;
      gap: 12px;
      align-items: stretch;
    }

    .bi-left-col {
      flex: 1.1;
      min-width: 280px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .bi-main-col {
      flex: 1.8;
      min-width: 320px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* 右カラム自体の定義 */
    .bi-right-col {
      flex: 0.8;
      min-width: 280px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-self: stretch;
      /* これで親の高さ一杯に伸びます */
    }

    /* YoYカード (全体の1/4の高さ) */
    .bi-right-col>.yoy-card {
      flex: 1;
      display: flex;
      flex-direction: column;
      margin-bottom: 0 !important;
    }

    /* メンテナンスカード (全体の3/4の高さ) */
    .bi-right-col>.maint-card {
      flex: 3;
      display: flex;
      flex-direction: column;
      margin-bottom: 0 !important;
      overflow: hidden;
      /* はみ出し防止 */
    }

    /* ログ表示エリア */
    #maintenanceLog {
      flex: 1;
      overflow-y: auto;
    }

    @media (max-width: 1024px) {
      .bi-right-col {
        width: 100%;
        flex: 1;
      }
    }

    .bi-container>div>.card {
      margin-bottom: 0 !important;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .chart-title {
      font-size: 12px;
      font-weight: bold;
      color: #6b8f71;
      margin-bottom: 8px;
    }

    .chart-wrapper {
      flex: 1;
      position: relative;
      width: 100%;
      min-height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .donut-icon {
      position: absolute;
      font-size: 24px;
      color: #6b8f71;
      opacity: 0.3;
      pointer-events: none;
    }

    #customModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
      padding: 20px;
    }

    #customModal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      width: 100%;
      max-width: 320px;
      border-radius: 20px;
      overflow: hidden;
    }

    .tab-btn {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: bold;
      cursor: pointer;
      white-space: nowrap;
      border: none;
    }

    .tab-btn.active {
      background: #2d4031;
      color: white;
    }

    .tab-btn.inactive {
      background: rgba(255, 255, 255, 0.5);
      color: #6b8f71;
    }

    .dashboard-sidebar {
      width: 200px;
      min-width: 200px;
      background: #2d4031;
      color: white;
      height: 100vh;
      position: sticky;
      top: 0;
      display: flex;
      flex-direction: column;
      padding: 20px 0;
    }

    .nav-item {
      width: 100%;
      padding: 15px 20px;
      text-align: left;
      color: rgba(255, 255, 255, 0.7);
      font-size: 13px;
      border: none;
      background: none;
      cursor: pointer;
      transition: 0.3s;
    }

    .nav-item i {
      margin-right: 10px;
    }

    .nav-item.active {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border-left: 4px solid #6b8f71;
    }

    .dashboard-main-content {
      overflow-y: auto;
      height: 100vh;
    }
  </style>
</head>

<body>

  <div id="overlay" onclick="closeMenu()"></div>
  <div id="sideMenu">
    <div class="flex justify-between items-center mb-6">
      <h2 class="font-bold text-lg text-[#6b8f71]">メニュー</h2>
      <button onclick="closeMenu()" class="text-2xl text-gray-400">&times;</button>
    </div>
    <nav class="space-y-1">
      <button onclick="switchView('inputView')" class="menu-item"><i
          class="fa-solid fa-pen-to-square w-8 text-lg"></i>ログ入力</button>
      <button onclick="switchView('todayView')" class="menu-item"><i
          class="fa-solid fa-calendar-day w-8 text-lg"></i>本日の稼働状況</button>
      <button onclick="switchView('historyView')" class="menu-item"><i
          class="fa-solid fa-magnifying-glass w-8 text-lg"></i>稼働履歴・検索</button>
      <button onclick="switchView('dashboard')" class="menu-item"><i
          class="fa-solid fa-chart-line w-8 text-lg"></i>DASHBOARD</button>
      <button onclick="switchView('repairView')" class="menu-item"><i
          class="fa-solid fa-tools w-8 text-lg"></i>修理履歴</button>
      <button onclick="switchView('maintenanceMachineListView'); loadMachineList();" class="menu-item"><i
          class="fa-solid fa-toolbox w-8 text-lg"></i>メンテナンス記録</button>
      <button onclick="switchView('versionView')" class="menu-item"><i
          class="fa-solid fa-info-circle w-8 text-lg"></i>バージョン情報</button>
    </nav>
  </div>

  <div id="customModal">
    <div class="modal-content">
      <div class="modal-header bg-[#2d4031] p-4 text-white text-center">
        <h3 id="modalTitle" class="font-bold">CONFIRM</h3>
      </div>
      <div class="modal-body p-6 text-center font-bold" id="modalMessage">メッセージ</div>
      <div class="modal-footer p-4 bg-gray-50 flex gap-2">
        <button class="flex-1 p-2 bg-gray-200 rounded-lg" onclick="closeModal()">戻る</button>
        <button id="modalOkBtn" class="flex-1 p-2 bg-[#6b8f71] text-white rounded-lg">実行する</button>
      </div>
    </div>
  </div>

  <div id="mainContainer">
    <header id="pageHeader" class="flex flex-col items-center justify-center py-8 relative">
      <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl text-[#6b8f71] p-2"><i
          class="fa-solid fa-bars"></i></button>
      <i class="fa-solid fa-tractor text-5xl text-[#6b8f71]"></i>
      <h1 class="text-xl font-bold text-[#6b8f71]">和農日向 Tractor log</h1>
    </header>

    <div id="inputView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">
      <div class="flex items-center gap-2 mb-1 mt-4">
        <i class="fa-solid fa-pen-to-square text-[#6b8f71] text-lg"></i>
        <span class="text-lg font-bold text-[#6b8f71]">ログ入力</span>
      </div>
      <div class="border-t-2 border-[#6b8f71] mb-6 opacity-50"></div>
      <div class="card"><label class="block text-xs font-bold text-gray-400 mb-1">機械を選択</label><select
          id="machineSelect" class="w-full p-3 rounded-lg" onchange="autoFillHour()"></select></div>
      <div class="card"><label class="block text-xs font-bold text-gray-400 mb-1">作業日</label><input type="date"
          id="workDate" class="w-full p-3 rounded-lg" /></div>
      <div class="card"><label class="block text-xs font-bold text-gray-400 mb-1">オペレーター</label>
        <select id="operatorSelect" class="w-full p-3 rounded-lg">
          <option value="">選択</option>
          <option>阿曽 千一</option>
          <option>阿曽 右貢</option>
          <option>菅原 亜美</option>
          <option>土井 達也</option>
          <option>阿曽 文平</option>
          <option>田中 武志</option>
          <option>赤塚 かおり</option>
          <option>土門 元義</option>
        </select>
      </div>
      <div class="card"><label class="block text-xs font-bold text-gray-400 mb-1">種別</label><select id="categorySelect"
          class="w-full p-3 rounded-lg">
          <option value="">選択</option>
          <option value="水稲">水稲</option>
          <option value="そば">そば</option>
          <option value="保全会">保全会</option>
          <option value="小規模工事">小規模工事</option>
        </select></div>
      <div class="card"><label class="block text-xs font-bold text-gray-400 mb-1">作業内容</label><select id="taskSelect"
          class="w-full p-3 rounded-lg"></select></div>
      <div class="card">
        <div class="flex space-x-4">
          <div class="flex-1"><label class="block text-xs font-bold text-gray-400 mb-1">稼働前</label><input type="number"
              id="hourBefore" class="w-full p-3 rounded-lg font-bold" step="0.1" oninput="calcDiff()" /></div>
          <div class="flex-1"><label class="block text-xs font-bold text-gray-400 mb-1">稼働後</label><input type="number"
              id="hourAfter" class="w-full p-3 rounded-lg font-bold" step="0.1" oninput="calcDiff()" /></div>
        </div>
      </div>
      <div id="hourDiffDisplay" class="text-right font-black text-[#6b8f71] mb-6 text-xl">稼働時間: 0.0 h</div>
      <div class="card"><label class="block text-xs font-bold text-gray-400 mb-1">給油量 (L)</label><input type="number"
          id="fuelAmount" class="w-full p-3 rounded-lg" /></div>
      <div class="card"><label class="block text-xs font-bold text-gray-400 mb-1">メモ</label><textarea id="memoInput"
          class="w-full p-3 rounded-lg" rows="2"></textarea></div>
      <button id="saveBtn" class="btn-main">ログを保存する</button>
    </div>

    <div id="dashboard" class="view">
      <div class="bi-header">
        <button onclick="openMenu()" class="text-2xl mr-6 hover:opacity-70 transition-opacity"><i
            class="fa-solid fa-bars"></i></button>
        <h1 class="text-lg md:text-2xl font-black tracking-widest flex items-center">
          <i class="fa-solid fa-chart-column mr-3"></i> 2026 OPERATION DASHBOARD
        </h1>
      </div>

      <div class="dashboard-top-bar">
        <div class="main-top-row">
          <div class="kpi-section">
            <div id="machineTabs" class="flex gap-2 overflow-x-auto pb-1"></div>
            <div class="kpi-grid">
              <div class="kpi-card"><span class="kpi-label">総稼働</span>
                <div class="kpi-value-container"><span class="kpi-value" id="kpi-hours">0.0</span><span
                    class="kpi-unit">h</span></div>
              </div>
              <div class="kpi-card"><span class="kpi-label">給油</span>
                <div class="kpi-value-container"><span class="kpi-value" id="kpi-fuel">0.0</span><span
                    class="kpi-unit">L</span></div>
              </div>
              <div class="kpi-card"><span class="kpi-label">燃費</span>
                <div class="kpi-value-container"><span class="kpi-value" id="kpi-avg">0.0</span><span
                    class="kpi-unit">L/h</span></div>
              </div>
              <div class="kpi-card"><span class="kpi-label">日数</span>
                <div class="kpi-value-container"><span class="kpi-value" id="kpi-days">0</span><span
                    class="kpi-unit">日</span></div>
              </div>
              <div class="kpi-card bg-[#4a6b50]"><span class="kpi-label">状態</span><span
                  class="kpi-value text-[10px]">良好</span></div>
            </div>
          </div>
          <div class="ranking-section">
            <p class="text-[11px] font-bold text-[#6b8f71] mb-2 text-center"><i
                class="fa-solid fa-trophy mr-1"></i>稼働ランキング</p>
            <div id="rankList" class="flex justify-around items-center"></div>
          </div>
        </div>
      </div>

      <div class="bi-container">
        <div class="bi-left-col">
          <div class="card">
            <p class="chart-title">作物別比率</p>
            <div class="chart-wrapper relative">
              <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <i class="fa-solid fa-seedling text-2xl text-[#6b8f71] opacity-20"></i>
              </div>
              <canvas id="categoryShareChart"></canvas>
            </div>
          </div>

          <div class="card">
            <p class="chart-title">作業内容分析</p>
            <div class="chart-wrapper relative">
              <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <i class="fa-solid fa-gears text-2xl text-[#6b8f71] opacity-20"></i>
              </div>
              <canvas id="taskShareChart"></canvas>
            </div>
          </div>

          <div class="card">
            <p class="chart-title">担当者別比率</p>
            <div class="chart-wrapper relative">
              <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <i class="fa-solid fa-user-check text-2xl text-[#6b8f71] opacity-20"></i>
              </div>
              <canvas id="operatorShareChart"></canvas>
            </div>
          </div>
        </div>
        <div class="bi-main-col">
          <div class="card">
            <p class="chart-title">月別稼働推移</p>
            <div class="chart-wrapper"><canvas id="detailChart"></canvas></div>
          </div>
          <div class="card">
            <p class="chart-title">工程分布分析</p>
            <div class="chart-wrapper"><canvas id="gradientBarChart"></canvas></div>
          </div>
        </div>
        <div class="bi-right-col">
          <div class="card yoy-card text-center relative">
            <p class="chart-title">前年実績比 (YoY)</p>
            <div class="chart-wrapper relative">
              <canvas id="yearComparisonGauge"></canvas>
              <div class="absolute inset-0 flex items-center justify-center pt-14">
                <p id="detailCompareValue" class="text-2xl font-black text-[#6b8f71]">--%</p>
              </div>
            </div>
          </div>

          <div class="card maint-card overflow-hidden">
            <p class="chart-title border-b pb-1">メンテナンス情報</p>
            <div id="maintenanceLog" class="text-[10px] space-y-2 opacity-80 pt-2 flex-1 overflow-y-auto">
              <p class="italic text-gray-400 text-center py-4">履歴はありません</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="todayView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">
      <div class="flex items-center gap-2 mb-4 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-2 text-lg"><i
          class="fa-solid fa-calendar-day"></i> 本日の稼働状況</div>
      <div id="todayLogList" class="space-y-4"></div>
      <button onclick="switchView('inputView')" class="btn-sub">TOPに戻る</button>
    </div>

    <div id="historyView" class="view px-4 py-6 max-w-3xl mx-auto pb-10">

      <div
        class="flex items-center gap-2 mb-6 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-3 text-lg w-full">
        <i class="fa-solid fa-magnifying-glass"></i>
        <span>稼働履歴検索</span>
      </div>

      <div class="card space-y-3 text-sm mb-6">
        <div class="grid grid-cols-2 gap-3">
          <div class="flex flex-col gap-1">
            <label class="text-[10px] text-gray-400 font-bold ml-1">対象月</label>
            <input type="month" id="filterMonth" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm">
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-[10px] text-gray-400 font-bold ml-1">機械</label>
            <select id="filterMachine" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm">
              <option value="">すべての機械</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mt-1">
          <div class="flex flex-col gap-1">
            <label class="text-[10px] text-gray-400 font-bold ml-1">オペレーター</label>
            <select id="filterOperator"
              class="p-3 rounded-lg w-full border border-gray-100 shadow-sm text-sm text-gray-600">
              <option value="">全オペレーター</option>
            </select>
          </div>

          <div class="flex flex-col gap-1">
            <label class="text-[10px] text-gray-400 font-bold ml-1">作業内容</label>
            <select id="filterCategory"
              class="p-3 rounded-lg w-full border border-gray-100 shadow-sm text-sm text-gray-600">
              <option value="">全作業内容</option>
            </select>
          </div>
        </div>

        <button onclick="loadLogs('historyLogList', false)" class="btn-main mt-2 shadow-md">
          検索を実行
        </button>
      </div>

      <div class="flex justify-end items-center mb-4 px-1">
        <div id="historyTotalHours"
          class="text-sm font-black text-[#6b8f71] opacity-80 bg-white px-4 py-2 rounded-full shadow-sm">
          合計: 0.0 h
        </div>
      </div>

      <div id="historyLogList" class="space-y-4"></div>

      <button onclick="switchView('inputView')" class="btn-sub mt-8">
        <i class="fa-solid fa-house mr-2"></i>TOPに戻る
      </button>
    </div>

    <div id="maintenanceMachineListView" class="view px-4 max-w-3xl mx-auto pb-10">
      <div class="flex items-center gap-2 mb-4 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-2 text-lg">
        <i class="fa-solid fa-wrench"></i> トラクター メンテナンス記録
      </div>

      <div id="maintenanceMachineGrid" class="space-y-6">
      </div>

      <button onclick="switchView('inputView')" class="btn-sub mt-10 w-full">
        <i class="fa-solid fa-house mr-2"></i>TOPに戻る
      </button>
    </div>

    <div id="repairView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10 hidden">

      <button onclick="switchView('invoiceOCRView')" class="btn-main w-full mb-6">
        修理の登録</button>

      <!-- 累計修理費 -->
      <div class="text-center my-6">
        <div class="text-sm text-gray-500">累計修理費</div>
        <div id="totalRepairCost" class="text-3xl font-bold text-[#6b8f71]">¥ 0</div>
      </div>

      <!-- 年ごとの修理費 -->
      <h2 class="font-bold text-lg mt-6 mb-2">年ごとの修理費</h2>
      <div id="yearlyRepairContainer" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>

      <!-- 機械ごとの修理費 -->
      <h2 class="font-bold text-lg mt-6 mb-2">機械ごとの修理費</h2>
      <div id="machineRepairContainer" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>

      <!-- 最近の修理履歴 -->
      <h2 class="font-bold text-lg mt-6 mb-2">最近の修理</h2>
      <div id="recentRepairContainer" class="space-y-3"></div>

    </div>

    <div id="invoiceOCRView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10 hidden">

      <div class="flex items-center gap-2 mb-4 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-2 text-lg">
        <i class="fa-solid fa-screwdriver-wrench"></i> 修理履歴の登録
      </div>

      <!-- 請求書の読み取り -->
      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">請求書・領収書の撮影</label>

        <input type="file" id="invoiceImage" accept="image/*" capture="environment" class="hidden"
          onchange="previewInvoice(this)">

        <button onclick="document.getElementById('invoiceImage').click()"
          class="w-full py-4 border-2 border-dashed border-[#6b8f71] rounded-lg text-[#6b8f71] flex flex-col items-center gap-2 hover:bg-[#f0f7f1] transition-colors">
          <i class="fa-solid fa-camera text-2xl"></i>
          <span class="text-sm font-bold">カメラを起動 / 画像を選択</span>
        </button>

        <div id="invoicePreviewArea" class="mt-4 hidden text-center">
          <img id="invoicePreviewImg" src="" class="w-full rounded-lg shadow-md mb-2">
          <p class="text-[10px] text-gray-500">この画像を修理履歴として保存します</p>
        </div>
      </div>

      <!-- 自動入力される項目 -->
      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">修理日</label>
        <input type="date" id="repairDate" class="w-full p-3 rounded-lg">
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">店舗名</label>
        <input type="text" id="repairShop" class="w-full p-3 rounded-lg">
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">金額</label>
        <input type="number" id="repairCost" class="w-full p-3 rounded-lg">
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">メモ（OCR全文）</label>
        <textarea id="repairMemo" class="w-full p-3 rounded-lg" rows="3"></textarea>
      </div>

      <button id="saveRepairBtn" class="btn-main">修理履歴を保存</button>
      <button onclick="switchView('repairView')" class="btn-sub mt-4">修理履歴へ戻る</button>

    </div>

    <div id="maintenanceDetailView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">

      <!-- タイトル（機械名は JS で差し替える） -->
      <div class="flex items-center gap-2 mb-4 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-2 text-lg">
        <i class="fa-solid fa-tractor"></i>
        <span id="maintenanceMachineName">機械名</span>
      </div>

      <div class="card mb-4">
        <p class="font-bold text-sm text-gray-500 mb-2">メンテナンス進捗</p>
        <div id="maintenanceSummary" class="text-xs mt-1">
          未着手
        </div>
      </div>

      <div class="card mb-4">
        <p class="font-bold text-sm text-gray-500 mb-2">点検項目</p>
        <div id="maintenanceChecklist" class="space-y-2">
        </div>
      </div>

      <!-- 作業履歴タイムライン -->
      <div class="card mb-4">
        <p class="font-bold text-sm text-gray-500 mb-2">作業履歴</p>
        <div id="maintenanceHistoryLog" class="space-y-3 text-sm">
          <p class="italic text-gray-400 text-center py-4">履歴はありません</p>
        </div>
      </div>

      <div class="card mb-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
        <p class="font-bold text-sm text-[#6b8f71] mb-4 flex items-center">
          <i class="fas fa-tools mr-2"></i>部品交換を記録
        </p>

        <label class="block text-xs font-bold text-gray-400 mb-1">交換部品・項目名</label>
        <input id="newMaintenanceItem" type="text"
          class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#6b8f71] outline-none"
          placeholder="例：オイルエレメント">

        <label class="block text-xs font-bold text-gray-400 mb-1">担当者</label>
        <select id="newMaintenanceOperator"
          class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#6b8f71] outline-none">
          <option value="">担当者を選択</option>
        </select>

        <label class="block text-xs font-bold text-gray-400 mb-1">状態</label>
        <select id="newMaintenanceStatus"
          class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#6b8f71] outline-none">
          <option value="done">完了</option>
          <option value="progress">作業中</option>
        </select>

        <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
        <textarea id="newMaintenanceMemo" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-4" rows="2"
          placeholder="備考"></textarea>

        <button onclick="saveMaintenanceRecord()"
          class="btn-main w-full py-3 bg-[#6b8f71] text-white rounded-lg font-bold hover:bg-[#5a7a5f] transition-all shadow-md">
          部品交換を保存する
        </button>
      </div>

      <div class="flex justify-center w-full mt-6 mb-8">
        <button onclick="switchView('maintenanceMachineListView')"
          class="bg-gray-500 text-white px-6 py-2.5 rounded-lg hover:bg-gray-600 transition-colors whitespace-nowrap text-[13px] sm:text-sm shadow-md flex items-center justify-center">
          <i class="fas fa-arrow-left mr-2"></i>
          <span>機械一覧ページに戻る</span>
        </button>
      </div>

      <div id="versionView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">
        <div class="flex items-center gap-2 mb-4 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-2 text-lg">
          <i class="fa-solid fa-code-branch"></i> バージョン情報
        </div>

        <div class="card text-sm leading-relaxed space-y-3">
          <p><span class="font-bold">バージョン:</span> 1.0.0</p>
          <p><span class="font-bold">最終更新日:</span> 2026-01-19</p>

          <div>
            <p class="font-bold text-[#6b8f71] mb-1">更新内容</p>
            <ul class="list-disc pl-5 space-y-1">
              <li>初期リリース</li>
            </ul>
          </div>

          <div>
            <p class="font-bold text-[#6b8f71] mb-1">使用技術</p>
            <ul class="list-disc pl-5 space-y-1">
              <li>HTML / CSS / JavaScript</li>
              <li>Tailwind CSS</li>
              <li>Supabase</li>
              <li>Chart.js</li>
              <li>GitHub Pages</li>
            </ul>
          </div>

          <button onclick="switchView('inputView')" class="btn-sub mt-6">TOPに戻る</button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      const SUPABASE_URL = "https://txsqxnwgolybcdclazdx.supabase.co";
      const SUPABASE_KEY = "sb_publishable_8JEM6Yyg5_oQpF-grdaxIw_rrxZBQYj";
      const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      let allMachines = []; let currentMachineId = 'all'; window.charts = {};

      function openMenu() { document.getElementById("sideMenu").style.left = "0px"; document.getElementById("overlay").style.display = "block"; }
      function closeMenu() { document.getElementById("sideMenu").style.left = "-280px"; document.getElementById("overlay").style.display = "none"; }

      function showModal(title, message, onOk) {
        const modal = document.getElementById("customModal");
        document.getElementById("modalTitle").innerText = title;
        document.getElementById("modalMessage").innerText = message;
        const okBtn = document.getElementById("modalOkBtn");
        okBtn.onclick = () => { closeModal(); if (onOk) onOk(); };
        modal.classList.add("active");
      }
      function closeModal() { document.getElementById("customModal").classList.remove("active"); }

      function switchView(id) {
        console.log("Switching to:", id); // どこに切り替えようとしているか確認

        // 全てのビューからactiveを取り除く
        document.querySelectorAll('.view').forEach(v => {
          v.classList.remove('active');
          v.style.display = 'none';
        });

        // 対象のビューを取得
        const targetView = document.getElementById(id);
        if (targetView) {
          targetView.classList.add('active');
          targetView.style.display = 'block'; // 強制的に表示
        } else {
          console.error("エラー: ID '" + id + "' のビューが見つかりません。");
        }

        // ヘッダーの制御
        const header = document.getElementById("pageHeader");
        if (header) {
          header.style.display = (id === 'dashboard') ? 'none' : 'flex';
        }

        closeMenu();

        // 各ページごとの読み込み処理
        if (id === 'dashboard') {
          setTimeout(() => renderDashboard('all'), 100);
        }
        if (id === 'todayView') {
          console.log("本日ログ読込実行");
          loadLogs("todayLogList", true);
        }
        if (id === 'historyView') {
          console.log("履歴ログ読込実行");
          loadLogs("historyLogList", false);
        }
        if (id === 'repairView') {
          loadRepairDashboard();
        }
        if (id === 'maintenanceMachineListView') {
          loadMachineList();
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        // 1. 機械（トラクターのみ）の取得
        const { data: machines } = await client
          .from("machines")
          .select("*")
          .eq("machine_type", "tractor")
          .order("name");

        allMachines = machines || [];

        // 2. オペレーターの取得 (operators テーブルから)
        const { data: operators } = await client
          .from("operators")
          .select("*")
          .order("name");

        // 3. 作業内容の取得 (work_types テーブルから)
        const { data: workTypes } = await client
          .from("work_types")
          .select("*")
          .order("name");

        // --- 各画面要素への反映 ---

        // 入力フォームの機械選択
        document.getElementById("machineSelect").innerHTML = '<option value="">選択</option>' +
          allMachines.map(m => `<option value="${m.id}">${m.name}</option>`).join("");

        // 検索条件の機械選択
        document.getElementById("filterMachine").innerHTML = '<option value="">すべての機械</option>' +
          allMachines.map(m => `<option value="${m.id}">${m.name}</option>`).join("");

        // ダッシュボードの機械別タブ
        document.getElementById("machineTabs").innerHTML = `<button onclick="renderDashboard('all')" id="tab-all" class="tab-btn active">全体</button>` +
          allMachines.map(m => `<button onclick="renderDashboard(${m.id})" id="tab-${m.id}" class="tab-btn inactive">${m.name}</button>`).join("");

        // 検索条件のオペレーター選択（追加分）
        if (operators) {
          document.getElementById("filterOperator").innerHTML = '<option value="">全オペレーター</option>' +
            operators.map(o => `<option value="${o.name}">${o.name}</option>`).join("");
        }

        // 検索条件の作業内容選択（追加分）
        if (workTypes) {
          document.getElementById("filterCategory").innerHTML = '<option value="">全作業内容</option>' +
            workTypes.map(w => `<option value="${w.name}">${w.name}</option>`).join("");
        }

        // 日付の初期セット
        const today = new Date().toISOString().split('T')[0];
        if (document.getElementById("workDate")) document.getElementById("workDate").value = today;
        if (document.getElementById("filterMonth")) document.getElementById("filterMonth").value = today.substring(0, 7);
      });

      // 修理履歴ダッシュボードを読み込む
      async function loadRepairDashboard() {
        try {
          // repair_logs をすべて取得
          const { data: logs, error } = await client
            .from('repair_logs')
            .select('*')
            .order('date', { ascending: false });

          if (error) {
            console.error('Error loading repair logs:', error);
            return;
          }

          // -----------------------------
          // ① 累計修理費
          // -----------------------------
          const totalCost = logs.reduce((sum, log) => sum + (log.cost || 0), 0);
          document.getElementById('totalRepairCost').textContent =
            '¥ ' + totalCost.toLocaleString();

          // -----------------------------
          // ② 年ごとの修理費
          // -----------------------------
          const yearly = {};
          logs.forEach(log => {
            const year = new Date(log.date).getFullYear();
            if (!yearly[year]) yearly[year] = 0;
            yearly[year] += log.cost || 0;
          });

          const yearlyContainer = document.getElementById('yearlyRepairContainer');
          yearlyContainer.innerHTML = '';

          Object.keys(yearly)
            .sort((a, b) => b - a)
            .forEach(year => {
              const card = document.createElement('div');
              card.className =
                'p-3 bg-white rounded shadow text-center border border-gray-100';
              card.innerHTML = `
          <div class="text-sm text-gray-500">${year}年</div>
          <div class="text-lg font-bold text-[#6b8f71]">¥ ${yearly[year].toLocaleString()}</div>
        `;
              yearlyContainer.appendChild(card);
            });

          // -----------------------------
          // ③ 機械ごとの修理費
          // -----------------------------
          const machineTotals = {};

          logs.forEach(log => {
            if (!machineTotals[log.machine_id]) machineTotals[log.machine_id] = 0;
            machineTotals[log.machine_id] += log.cost || 0;
          });

          // machines テーブルから名前を取得
          const { data: machines } = await client.from('machines').select('*');

          const machineContainer = document.getElementById('machineRepairContainer');
          machineContainer.innerHTML = '';

          Object.keys(machineTotals).forEach(machineId => {
            const machine = machines.find(m => m.id === Number(machineId));
            const name = machine ? machine.name : '不明な機械';

            const card = document.createElement('div');
            card.className =
              'p-3 bg-white rounded shadow text-center border border-gray-100';
            card.innerHTML = `
        <div class="text-sm text-gray-500">${name}</div>
        <div class="text-lg font-bold text-[#6b8f71]">¥ ${machineTotals[machineId].toLocaleString()}</div>
      `;
            machineContainer.appendChild(card);
          });

          // -----------------------------
          // ④ 最近の修理履歴（最新5件）
          // -----------------------------
          const recentContainer = document.getElementById('recentRepairContainer');
          recentContainer.innerHTML = '';

          logs.slice(0, 5).forEach(log => {
            const item = document.createElement('div');
            item.className =
              'p-3 bg-white rounded shadow border border-gray-100';

            item.innerHTML = `
        <div class="text-sm text-gray-500">${log.date}</div>
        <div class="font-bold">${log.memo || '(内容なし)'}</div>
        <div class="text-[#6b8f71] font-bold mt-1">¥ ${log.cost.toLocaleString()}</div>
        <div class="text-xs text-gray-400 mt-1">${log.shop || ''}</div>
      `;

            recentContainer.appendChild(item);
          });

        } catch (err) {
          console.error('Unexpected error:', err);
        }
      }

      const tasksMap = { "水稲": ["あぜ塗り", "起耕", "粗代", "本代", "秋耕", "その他"], "そば": ["起耕", "播種", "刈取り", "その他"], "保全会": ["ハンマーモア", "草刈り", "その他"], "小規模工事": ["整地", "掘削", "運搬", "その他"], "その他": ["その他"] };
      document.getElementById("categorySelect").onchange = function () { document.getElementById("taskSelect").innerHTML = (tasksMap[this.value] || ["その他"]).map(t => `<option value="${t}">${t}</option>`).join(""); };

      async function autoFillHour() {
        const mId = document.getElementById("machineSelect").value;
        if (!mId) return;
        const { data } = await client.from("hour_logs").select("end_hour").eq("machine_id", mId).order("date", { ascending: false }).order("created_at", { ascending: false }).limit(1);
        if (data && data.length > 0) { document.getElementById("hourBefore").value = data[0].end_hour; calcDiff(); }
      }

      function calcDiff() {
        const b = parseFloat(document.getElementById("hourBefore").value) || 0;
        const a = parseFloat(document.getElementById("hourAfter").value) || 0;
        const d = a - b;
        const disp = document.getElementById("hourDiffDisplay");

        // ① 稼働後のほうが小さい場合に文字を赤くするロジック
        if (a > 0 && a < b) {
          disp.classList.remove("text-[#6b8f71]");
          disp.classList.add("text-red-500");
          disp.textContent = `稼働時間: 0.0 h (入力エラー)`;
        } else {
          disp.classList.remove("text-red-500");
          disp.classList.add("text-[#6b8f71]");
          disp.textContent = `稼働時間: ${d > 0 ? d.toFixed(1) : "0.0"} h`;
        }
      }

      function previewInvoice(input) {
        const previewArea = document.getElementById('invoicePreviewArea');
        const previewImg = document.getElementById('invoicePreviewImg');

        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            previewImg.src = e.target.result;
            previewArea.classList.remove('hidden');
          }
          reader.readAsDataURL(input.files[0]);
        }
      }

      document.getElementById("saveBtn").onclick = async () => {
        const mId = document.getElementById("machineSelect").value;
        const hBefore = parseFloat(document.getElementById("hourBefore").value) || 0;
        const hAfter = parseFloat(document.getElementById("hourAfter").value) || 0;

        if (!mId) return alert("機械を選択してください");
        if (hAfter < hBefore) return alert("エラー：稼働後の数値が稼働前より小さくなっています。");

        showModal("登録確認", "ログを登録しますか？", async () => {
          const logData = {
            machine_id: mId, date: document.getElementById("workDate").value,
            operator: document.getElementById("operatorSelect").value,
            category: document.getElementById("categorySelect").value,
            task: document.getElementById("taskSelect").value,
            start_hour: hBefore, end_hour: hAfter,
            fuel_amount: parseFloat(document.getElementById("fuelAmount").value) || 0,
            memo: document.getElementById("memoInput").value
          };
          const { error } = await client.from("hour_logs").insert([logData]);
          if (!error) location.reload();
        });
      };

      async function loadLogs(elId, todayOnly) {
        const list = document.getElementById(elId);
        list.innerHTML = "<p class='text-center py-10 opacity-50 text-xs'>読込中...</p>";

        // 基本のクエリ作成
        let query = client.from("hour_logs").select("*, machines(name)").order("date", { ascending: false });

        if (todayOnly) {
          // 【本日の稼働状況】日本時間（JST）の今日の日付で絞り込み
          const jstToday = new Date().toLocaleDateString('sv-SE');
          query = query.eq("date", jstToday);
        } else {

          // 【稼働履歴】画面の入力値を取得してフィルターをかける
          const month = document.getElementById("filterMonth").value; // YYYY-MM
          const machine = document.getElementById("filterMachine").value;
          const operator = document.getElementById("filterOperator").value;
          const category = document.getElementById("filterCategory").value;

          // 月で絞り込み (前方一致)
          if (month) query = query.gte("date", `${month}-01`).lte("date", `${month}-31`);
          // 機械で絞り込み
          if (machine) query = query.eq("machine_id", machine);
          // オペレーターで絞り込み
          if (operator) query = query.eq("operator", operator);
          // 種別（水稲・そば等）で絞り込み
          if (category) query = query.eq("category", category);
        }

        const { data, error } = await query;
        if (error) {
          console.error("データ取得エラー:", error);
          return;
        }

        let total = 0;
        const displayData = todayOnly ? [...(data || [])].reverse() : (data || []);

        list.innerHTML = displayData.map(l => {
          const diff = (l.end_hour - l.start_hour);
          total += diff;
          return `<div class="card border-l-4 border-[#6b8f71] !mb-3 !py-3 flex justify-between items-center">
              <div>
                <b class="text-sm">${l.date} - ${l.machines?.name}</b>
                <p class="text-xs opacity-70 mt-1">${l.operator} | ${l.task}</p>
                <div class="flex gap-4 mt-2">
                  <span class="text-[11px] font-bold log-badge px-2 py-1 rounded"><i class="fa-solid fa-clock mr-1 text-[#6b8f71]"></i>${diff.toFixed(1)} h</span>
                  <span class="text-[11px] font-bold log-badge px-2 py-1 rounded"><i class="fa-solid fa-gas-pump mr-1 text-[#6b8f71]"></i>${l.fuel_amount || 0} L</span>
                </div>
              </div>
              <button onclick="deleteLog(${l.id})" class="text-gray-400 p-2 hover:text-red-500 transition-colors">
                <i class="fa-regular fa-trash-can text-lg"></i>
              </button>
            </div>`;
        }).join("");

        if (!todayOnly) {
          const totalEl = document.getElementById("historyTotalHours");
          if (totalEl) totalEl.innerText = `合計: ${total.toFixed(1)} h`;
        }
      }

      async function deleteLog(id) {
        showModal("削除確認", "このログを削除しますか？", async () => {
          const { error } = await client.from("hour_logs").delete().eq("id", id);
          if (!error) {
            if (document.getElementById("todayView").classList.contains("active")) loadLogs("todayLogList", true);
            else loadLogs("historyLogList", false);
          }
        });
      }

      // 1. メンテナンス一覧（トラクター一覧）を表示する
      async function loadMachineList() {
        try {
          const { data: machines, error } = await client
            .from("machines")
            .select("*")
            .eq("machine_type", "tractor")
            .order("id");

          if (error) throw error;

          const container = document.getElementById("maintenanceMachineGrid");
          if (!container) return;
          container.innerHTML = "";

          const grouped = {};
          machines.forEach(m => {
            const manufacturer = m.manufacturer || "その他";
            if (!grouped[manufacturer]) grouped[manufacturer] = [];
            grouped[manufacturer].push(m);
          });

          Object.keys(grouped).forEach(brand => {
            const brandHeader = document.createElement("h3");
            brandHeader.className = "text-[#6b8f71] font-bold text-sm mb-2 mt-4 flex items-center gap-2";
            brandHeader.innerHTML = `<i class="fa-solid fa-tag opacity-50"></i> ${brand}`;
            container.appendChild(brandHeader);

            const grid = document.createElement("div");
            grid.className = "grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-4";

            grouped[brand].forEach(m => {
              const card = document.createElement("div");
              card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-all active:scale-95";
              card.onclick = () => openMaintenanceDetail(m.id);

              const statusText = m.status || "未着手";
              const iconColor = "#6b8f71";

              card.innerHTML = `
                    <div class="flex flex-col gap-2">
                        <div class="flex items-center gap-3">
                            <div style="color: ${iconColor};" class="text-xl flex-shrink-0">
                                <i class="fa-solid fa-tractor"></i>
                            </div>
                            <div class="font-bold text-gray-900 text-lg truncate">${m.name}</div>
                        </div>
                        <div class="border-t border-gray-50 pt-2">
                            <div class="text-[11px] text-red-600 font-black flex items-center gap-1">
                                <i class="fa-solid fa-circle-exclamation text-[9px]"></i>
                                ${statusText}
                            </div>
                        </div>
                    </div>
                `;
              grid.appendChild(card);
            });
            container.appendChild(grid);
          });

        } catch (e) {
          console.error("メンテナンス一覧の読み込み失敗:", e);
        }
      }

      async function openMaintenanceDetail(machineId) {
        window.currentMachineId = machineId;
        switchView('maintenanceDetailView');

        try {
          // 1. 機械名を取得
          const { data: machine } = await client.from("machines").select("*").eq("id", machineId).single();
          document.getElementById("maintenanceMachineName").textContent = machine.name;

          // ★追加：担当者（オペレーター）リストを取得してセレクトボックスに反映
          const { data: operators } = await client.from('operators').select('name').order('id');
          const opSelect = document.getElementById('newMaintenanceOperator');
          if (opSelect && operators) {
            opSelect.innerHTML = '<option value="">担当者を選択</option>'; // 初期化
            operators.forEach(op => {
              const opt = document.createElement('option');
              opt.value = op.name;
              opt.textContent = op.name;
              opSelect.appendChild(opt);
            });
          }

          // ★追記：作業履歴（部品交換履歴）を取得して表示
          loadMaintenanceHistory(machineId);



          // 2. 全メンテナンス項目を取得
          const { data: items } = await client.from("maintenance_items_tractor").select("*").order("id");

          // 3. すでに保存されているチェック状態を取得
          const { data: savedChecks } = await client
            .from("maintenance_checks")
            .select("item_id, is_checked")
            .eq("machine_id", machineId);

          const checklistContainer = document.getElementById("maintenanceChecklist");
          if (!checklistContainer) return;
          checklistContainer.innerHTML = "";

          items.forEach(item => {
            const isChecked = savedChecks?.find(c => c.item_id === item.id)?.is_checked || false;

            const div = document.createElement("div");
            div.className = "flex items-center justify-between p-3 border-b border-gray-50 last:border-0 hover:bg-gray-50 transition-colors";
            div.innerHTML = `
                <div class="flex flex-col flex-1 text-left">
                    <span class="text-sm font-bold text-gray-700">${item.item_name}</span>
                    <span class="text-[10px] text-gray-400">${item.description || ''}</span>
                </div>
                <input type="checkbox" 
                       class="maintenance-check w-6 h-6 rounded border-gray-300 text-[#6b8f71] focus:ring-[#6b8f71] cursor-pointer"
                       ${isChecked ? 'checked' : ''} 
                       onchange="saveSingleCheck('${machineId}', '${item.id}', this.checked)">
            `;
            checklistContainer.appendChild(div);
          });

          calculateProgress();

        } catch (e) {
          console.error("読み込み失敗:", e);
        }
      }

      async function updateGlobalProgress(machineId) {
        const checkboxes = document.querySelectorAll('.maintenance-check');
        const total = checkboxes.length;
        const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
        const percent = total > 0 ? Math.round((checked / total) * 100) : 0;

        calculateProgress();

        let statusText = percent === 100 ? "メンテナンス完了" : (percent === 0 ? "未着手" : `${percent}%完了`);

        await client.from('machines').update({ status: statusText }).eq('id', machineId);
        loadMachineList();
      }

      function calculateProgress() {
        const checkboxes = document.querySelectorAll('.maintenance-check');
        const total = checkboxes.length;
        const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
        const percent = total > 0 ? Math.round((checked / total) * 100) : 0;

        const summaryEl = document.getElementById("maintenanceSummary");
        if (summaryEl) {
          summaryEl.innerHTML = `
            <div class="flex justify-between items-center mb-1">
                <span class="font-bold text-[#6b8f71]">完了: ${checked} / ${total} 項目</span>
                <span class="font-black text-[#6b8f71]">${percent}%</span>
            </div>
            <div class="w-full bg-gray-100 rounded-full h-2">
                <div class="bg-[#6b8f71] h-2 rounded-full transition-all duration-300" style="width: ${percent}%"></div>
            </div>
        `;
        }
      }

      async function renderDashboard(mId) {
        currentMachineId = mId;
        document.querySelectorAll('.tab-btn').forEach(btn => { btn.classList.replace('active', 'inactive'); if (btn.id === `tab-${mId}`) btn.classList.replace('inactive', 'active'); });
        let { data: logs } = await client.from("hour_logs").select("*, machines(name)");
        if (mId !== 'all') logs = logs.filter(l => l.machine_id == mId);
        if (!logs) return;

        const l26 = logs.filter(l => l.date.startsWith("2026"));
        const l25 = logs.filter(l => l.date.startsWith("2025"));
        const totalH = l26.reduce((s, l) => s + (l.end_hour - l.start_hour), 0);
        const totalF = l26.reduce((s, l) => s + (l.fuel_amount || 0), 0);
        document.getElementById("kpi-hours").innerText = totalH.toFixed(1);
        document.getElementById("kpi-fuel").innerText = totalF.toFixed(1);
        document.getElementById("kpi-avg").innerText = totalH > 0 ? (totalF / totalH).toFixed(1) : "0.0";
        document.getElementById("kpi-days").innerText = new Set(l26.map(l => l.date)).size;

        const mRank = {}; l26.forEach(l => { const n = l.machines?.name || "他"; mRank[n] = (mRank[n] || 0) + (l.end_hour - l.start_hour); });
        const sorted = Object.entries(mRank).sort((a, b) => b[1] - a[1]);
        document.getElementById("rankList").innerHTML = [0, 1, 2].map(i => sorted[i] ? `<div class="text-center"><i class="fa-solid fa-crown ${['text-yellow-500', 'text-gray-400', 'text-amber-600'][i]} text-xl"></i><p class="text-[10px] font-bold mt-1">${sorted[i][0]}</p></div>` : '').join("");

        const cat = {}, tsk = {}, opr = {}, mon = Array(12).fill(0);
        l26.forEach(l => {
          const h = l.end_hour - l.start_hour;
          cat[l.category || "他"] = (cat[l.category || "他"] || 0) + h;
          tsk[l.task || "他"] = (tsk[l.task || "他"] || 0) + h;
          opr[l.operator || "他"] = (opr[l.operator || "他"] || 0) + h;
          if (l.date.split("-")[1]) mon[parseInt(l.date.split("-")[1]) - 1] += h;
        });
        drawCharts(cat, tsk, opr, mon, totalH, l25);
      }

      function drawCharts(cat, task, op, monthly, totalH, l25) {
        Object.values(window.charts).forEach(c => c && c.destroy());
        const txt = '#3a3a3a';
        const colorSet = ['#1b4332', '#2d6a4f', '#40916c', '#52b788', '#74c69d'];

        const donut = (id, data) => new Chart(document.getElementById(id), {
          type: 'doughnut',
          data: { labels: Object.keys(data), datasets: [{ data: Object.values(data), backgroundColor: colorSet, borderWidth: 0 }] },
          options: {
            cutout: '75%', maintainAspectRatio: false,
            plugins: { legend: { display: true, position: 'right', labels: { boxWidth: 12, padding: 15, font: { size: 11, weight: 'bold' }, color: txt } } }
          }
        });

        window.charts.c1 = donut('categoryShareChart', cat);
        window.charts.c2 = donut('taskShareChart', task);
        window.charts.c3 = donut('operatorShareChart', op);

        window.charts.line = new Chart(document.getElementById('detailChart'), {
          type: 'line',
          data: { labels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'], datasets: [{ data: monthly, borderColor: '#6b8f71', backgroundColor: 'rgba(107,143,113,0.1)', fill: true, tension: 0.4 }] },
          options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: txt, font: { size: 9 } } }, y: { ticks: { color: txt, font: { size: 9 } } } } }
        });

        const barCtx = document.getElementById('gradientBarChart').getContext('2d');
        const tLabels = Object.keys(task);
        const tData = Object.values(task);
        window.charts.bar = new Chart(barCtx, {
          type: 'bar',
          data: { labels: tLabels, datasets: [{ data: tData, backgroundColor: tData.map((_, i) => `rgba(45, 64, 49, ${Math.max(0.2, 1 - (i / tLabels.length))})`), borderRadius: 4 }] },
          options: { indexAxis: 'y', maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: txt, font: { size: 9 } } }, y: { ticks: { color: txt, font: { size: 9 } } } } }
        });

        const lastH = l25.reduce((s, l) => s + (l.end_hour - l.start_hour), 0) || 1;
        const ratio = Math.min(100, (totalH / lastH) * 100);
        window.charts.gauge = new Chart(document.getElementById('yearComparisonGauge'), {
          type: 'doughnut',
          data: { datasets: [{ data: [ratio, 100 - ratio], backgroundColor: ['#6b8f71', '#eee'], borderWidth: 0 }] },
          options: { rotation: -90, circumference: 180, cutout: '75%', maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
        document.getElementById("detailCompareValue").innerText = ratio.toFixed(1) + "%";
      }

      async function loadCategories() {
        try {
          const { data, error } = await client
            .from('work_types')
            .select('*')
            .order('id');

          if (error) throw error;

          const filterSelect = document.getElementById('filterCategory');
          const inputSelect = document.getElementById('workCategory');

          if (filterSelect) {
            filterSelect.innerHTML = '<option value="">全作業内容</option>';
            data.forEach(cat => {
              const opt = document.createElement('option');
              opt.value = cat.work_name;
              opt.textContent = cat.work_name;
              filterSelect.appendChild(opt);
            });
          }

          if (inputSelect) {
            inputSelect.innerHTML = '<option value="">作業内容を選択</option>';
            data.forEach(cat => {
              const opt = document.createElement('option');
              opt.value = cat.work_name;
              opt.textContent = cat.work_name;
              inputSelect.appendChild(opt);
            });
          }
          console.log("作業内容の読み込みに成功しました");
        } catch (e) {
          console.error("カテゴリー読み込み失敗:", e);
        }
      }

      // オペレーターを読み込んでセレクトボックスにセットする
      async function loadOperators() {
        try {
          const { data, error } = await client.from('operators').select('*').order('id');
          if (error) throw error;

          const filterSelect = document.getElementById('filterOperator');
          const inputSelect = document.getElementById('operator');

          if (filterSelect) {
            filterSelect.innerHTML = '<option value="">全オペレーター</option>';
            data.forEach(op => {
              const opt = document.createElement('option');
              opt.value = op.operator_name;
              opt.textContent = op.operator_name;
              filterSelect.appendChild(opt);
            });
          }
          if (inputSelect) {
            inputSelect.innerHTML = '<option value="">選択してください</option>';
            data.forEach(op => {
              const opt = document.createElement('option');
              opt.value = op.operator_name;
              opt.textContent = op.operator_name;
              inputSelect.appendChild(opt);
            });
          }
        } catch (e) {
          console.error("オペレーター読み込み失敗:", e);
        }
      }

      // ページ読み込み時の初期化処理
      document.addEventListener('DOMContentLoaded', () => {
        if (typeof loadLogs === 'function') loadLogs('historyLogList', false);
        loadCategories();
        loadOperators();
        if (typeof loadMachineList === 'function') loadMachineList();
      });

      // 1. 部品交換を保存する
      async function saveMaintenanceRecord() {
        const mId = window.currentMachineId; // 今開いている機械のID
        const item = document.getElementById('newMaintenanceItem').value;
        const operator = document.getElementById('newMaintenanceOperator').value;
        const status = document.getElementById('newMaintenanceStatus').value;
        const memo = document.getElementById('newMaintenanceMemo').value;

        if (!item || !operator) {
          alert("項目名と担当者を入力してください");
          return;
        }

        try {
          const { error } = await client.from('maintenance_records').insert([{
            machine_id: mId,
            item_name: item,
            operator: operator,
            status: status,
            memo: memo,
            date: new Date().toLocaleDateString('sv-SE')
          }]);

          if (error) throw error;
          alert("記録しました！");

          // 入力欄を空にする
          document.getElementById('newMaintenanceItem').value = "";
          document.getElementById('newMaintenanceMemo').value = "";

          // 2. 保存後、すぐに履歴を再読み込みして表示を更新する
          loadMaintenanceHistory(mId);

        } catch (e) {
          console.error(e);
          alert("保存に失敗しました。テーブルがあるか確認してください。");
        }
      }

      // 2. 履歴を表示する
      async function loadMaintenanceHistory(machineId) {
        try {
          const { data } = await client
            .from('maintenance_records')
            .select('*')
            .eq('machine_id', machineId)
            .order('created_at', { ascending: false });

          const historyContainer = document.getElementById('maintenanceHistoryLog');
          if (!historyContainer) return;

          if (!data || data.length === 0) {
            historyContainer.innerHTML = '<p class="italic text-gray-400 text-center py-4">履歴はありません</p>';
            return;
          }

          historyContainer.innerHTML = data.map(rec => `
      <div class="border-b border-gray-100 pb-2 mb-2 last:border-0 text-left">
        <div class="flex justify-between font-bold text-gray-700">
          <span>${rec.item_name}</span>
          <span class="text-gray-400 text-[9px]">${rec.date}</span>
        </div>
        <div class="text-gray-500">担当: ${rec.operator}</div>
        ${rec.memo ? `<div class="text-gray-400 italic">"${rec.memo}"</div>` : ''}
      </div>
    `).join('');
        } catch (e) { console.error(e); }
      }

    </script>
</body>

</html>