<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex">
  <link rel="manifest" href="/tractorlog/manifest.json">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;900&family=Space+Grotesk:wght@400;600;700&family=Zen+Kaku+Gothic+New:wght@400;500;700;900&display=swap" rel="stylesheet">
  <title>和農日向 Tractor Log</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <style>
    /* --- CSS変数でカラーテーマを管理 --- */
    :root {
      /* トラクターセクションのテーマカラー */
      --tractor-color: #6b8f71;
      --tractor-hover: #5a7760;
      --tractor-light: #f0f7f1;
      
      /* 田植え機セクションのテーマカラー */
      --planting-color: #c9a961;
      --planting-hover: #b8985a;
      --planting-dark: #a08550;
      --planting-bg: #faf8f0;
      
      /* コンバインセクションのテーマカラー */
      --combine-color: #c97c73;
      --combine-hover: #b86b62;
      --combine-light: #f8e8e6;
      --combine-bg: #faf5f4;
      
      /* エクスポートセクションのテーマカラー */
      --export-color: #808000;
      --export-hover: #666600;
      --export-light: #fef9c3;
      --export-bg: #fefce8;
      
      /* 修理セクションのテーマカラー */
      --repair-color: #9b7cb6;
      --repair-hover: #826a9a;
      --repair-light: #ede9fe;
      --repair-bg: #f7f6fb;
      
      /* バージョン情報のテーマカラー */
      --version-color: #7e837f;
      --version-hover: #696d6a;
      --version-light: #f1f5f9;
      --version-bg: #f8fafc;
      
      /* メンテナンスセクションのテーマカラー */
      --maintenance-color: #5f9ea0;
      --maintenance-hover: #4a8385;
      --maintenance-light: #e0f2f2;
      --maintenance-bg: #f0f9f9;
    }
    
    /* --- 基本スタイル --- */
    html, body {
      margin: 0;
      padding: 0;
    }
    
    body {
      color: #3a3a3a;
      font-family: "Hiragino Sans", "Noto Sans JP", sans-serif;
      min-height: 100vh;
    }

    .view {
      display: none;
      min-height: 100vh;
    }

    .view.active {
      display: block;
    }
    
    .view.fullscreen-view {
      min-height: 100vh;
    }
    
    #mainContainer {
      margin: 0;
      padding: 0;
    }
    
    /* PC表示時にサイドバーがある場合の調整 */
    @media (min-width: 1024px) {
      body.show-sidebar .view.active {
        display: block;
      }
    }

    .sideMenu, #sideMenu, #tractorSideMenu, #plantingSideMenu, #combineSideMenu {
      position: fixed;
      top: 0;
      left: -280px;
      width: 280px;
      height: 100%;
      background: white;
      z-index: 9999;
      transition: left 0.3s ease;
      padding: 20px;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
    }

    /* PC表示時：サイドバーを常時表示（データ分析ページを除く） */
    @media (min-width: 1024px) {
      /* アクティブなメニューのみ表示 */
      body.show-sidebar .sideMenu.active-menu,
      body.show-sidebar #sideMenu.active-menu,
      body.show-sidebar #tractorSideMenu.active-menu,
      body.show-sidebar #plantingSideMenu.active-menu,
      body.show-sidebar #combineSideMenu.active-menu {
        left: 0;
      }

      /* サイドバー表示時にコンテンツにマージンを適用 */
      body.show-sidebar #mainContainer {
        margin-left: 280px;
        margin-right: 0;
      }
      
      /* サイドバー表示時、各viewのmax-widthコンテナを適切に配置 */
      body.show-sidebar .view.active > div {
        margin-left: auto;
        margin-right: auto;
      }

      body.show-sidebar #overlay {
        display: none !important;
      }

      /* PC表示時にサイドメニューの×ボタンを非表示 */
      body.show-sidebar .close-menu-btn {
        display: none;
      }

      /* ハンバーガーメニューボタンをPC表示時は非表示 */
      body.show-sidebar .view.active header button[onclick="openMenu()"],
      body.show-sidebar .view.active .bi-header button[onclick="openMenu()"] {
        display: none;
      }
    }

    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: 9998;
      display: none;
    }

    .menu-item {
      width: 100%;
      text-align: left;
      padding: 0.8rem;
      border-radius: 0.5rem;
      font-weight: bold;
      color: #6b8f71;
      display: flex;
      align-items: center;
      font-size: 0.9rem;
    }

    #plantingSideMenu .menu-item {
      color: var(--planting-color);
    }

    #combineSideMenu .menu-item {
      color: var(--combine-color);
    }

    #maintenanceSideMenu .menu-item {
      color: var(--maintenance-color);
    }

    #exportSideMenu .menu-item {
      color: var(--export-color);
    }

    #versionSideMenu .menu-item {
      color: var(--version-color);
    }

    select,
    input,
    textarea {
      color: #3a3a3a !important;
      background-color: #ffffff !important;
      border: 1px solid #ddd;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 6px 16px rgba(107, 143, 113, 0.10);
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }

    /* Override Tailwind shadows to use a greenish-gray tint for cards */
    .shadow-sm {
      box-shadow: 0 4px 10px rgba(107, 143, 113, 0.06) !important;
    }
    .shadow {
      box-shadow: 0 8px 22px rgba(107, 143, 113, 0.10) !important;
    }

    .btn-main {
      color: white;
      padding: 14px;
      border-radius: 12px;
      text-align: center;
      font-weight: bold;
      width: 100%;
      display: block;
    }

    .btn-sub {
      color: white;
      padding: 12px;
      border-radius: 10px;
      text-align: center;
      font-weight: bold;
      width: 160px;
      max-width: 40%;
      margin: 20px auto 0;
      display: block;
      border: none;
      cursor: pointer;
    }

    /* トラクターセクション用のボタンスタイル */
    #tractor-section .btn-main {
      background-color: var(--tractor-color);
    }

    #tractor-section .btn-main:hover {
      background-color: var(--tractor-hover);
    }

    #tractor-section .btn-sub {
      background-color: var(--tractor-color);
    }

    #tractor-section .btn-sub:hover {
      background-color: var(--tractor-hover);
    }

    /* 移植機セクション用のボタンスタイル */
    #planting-section .btn-main {
      background-color: var(--planting-color);
    }

    #planting-section .btn-main:hover {
      background-color: var(--planting-hover);
    }

    #planting-section .btn-sub {
      background-color: var(--planting-color);
    }

    #planting-section .btn-sub:hover {
      background-color: var(--planting-hover);
    }

    /* コンバインセクション用のボタンスタイル */
    #combine-section .btn-main {
      background-color: var(--combine-color);
    }

    #combine-section .btn-main:hover {
      background-color: var(--combine-hover);
    }

    #combine-section .btn-sub {
      background-color: var(--combine-color);
    }

    #combine-section .btn-sub:hover {
      background-color: var(--combine-hover);
    }

    /* メンテナンスセクション用のボタンスタイル */
    #maintenanceMachineListView .btn-main,
    #maintenanceDetailView .btn-main {
      background-color: var(--maintenance-color);
    }

    #maintenanceMachineListView .btn-main:hover,
    #maintenanceDetailView .btn-main:hover {
      background-color: var(--maintenance-hover);
    }

    #maintenanceMachineListView .btn-sub,
    #maintenanceDetailView .btn-sub {
      background-color: var(--maintenance-color);
    }

    #maintenanceMachineListView .btn-sub:hover,
    #maintenanceDetailView .btn-sub:hover {
      background-color: var(--maintenance-hover);
    }

    /* 修理セクション用のボタンスタイル */
    #repair-section .btn-main {
      background-color: var(--repair-color);
    }

    #repair-section .btn-main:hover {
      background-color: var(--repair-hover);
    }

    #repair-section .btn-sub {
      background-color: var(--repair-color);
    }

    #repair-section .btn-sub:hover {
      background-color: var(--repair-hover);
    }

    /* エクスポートビュー用のボタンスタイル */
    #exportView .btn-main {
      background-color: var(--export-color);
    }

    #exportView .btn-main:hover {
      background-color: var(--export-hover);
    }

    #exportView .btn-sub {
      background-color: var(--export-color);
    }

    #exportView .btn-sub:hover {
      background-color: var(--export-hover);
    }

    /* バージョン情報用のボタンスタイル */
    #versionView .btn-main {
      background-color: var(--version-color);
    }

    #versionView .btn-main:hover {
      background-color: var(--version-hover);
    }

    #versionView .btn-sub {
      background-color: var(--version-color);
    }

    #versionView .btn-sub:hover {
      background-color: var(--version-hover);
    }

    /* dashboardPlanting専用のスタイル（ブルーグリーン系） */
    #dashboardPlanting .bi-header {
      background: var(--planting-dark) !important;
    }

    #dashboardPlanting .kpi-card {
      background: var(--planting-color) !important;
    }

    #dashboardPlanting .chart-title {
      color: var(--planting-color) !important;
    }

    #dashboardPlanting .donut-icon {
      color: var(--planting-color) !important;
    }

    #dashboardPlanting .tab-btn.active {
      background: var(--planting-dark) !important;
    }

    #dashboardPlanting .tab-btn.inactive {
      color: var(--planting-color) !important;
    }

    #dashboardPlanting .nav-item.active {
      border-left-color: var(--planting-color) !important;
    }

    /* combineView専用の背景色 */
    #tractor-section {
      background-color: #e2e8e3;
      margin: 0;
      padding: 0;
    }

    #tractorView,
    #todayView,
    #historyView {
      background-color: #e2e8e3;
      min-height: 100vh;
    }
    
    #maintenanceMachineListView,
    #maintenanceDetailView {
      background-color: var(--maintenance-bg);
      min-height: 100vh;
    }

    #dashboard {
      background-color: #e2e8e3;
    }

    #repair-section {
      background-color: var(--repair-bg);
      margin: 0;
      padding: 0;
    }

    #repairView,
    #invoiceOCRView {
      background-color: var(--repair-bg);
      min-height: 100vh;
    }

    #planting-section {
      background-color: var(--planting-bg);
      margin: 0;
      padding: 0;
    }

    #plantingView,
    #todayViewPlanting,
    #historyViewPlanting,
    #maintenanceMachineListViewPlanting,
    #maintenanceDetailViewPlanting {
      background-color: var(--planting-bg);
      min-height: 100vh;
    }

    #dashboardPlanting {
      background-color: var(--planting-bg);
    }

    #exportView {
      background-color: var(--export-bg);
      min-height: 100vh;
    }
    
    #versionView {
      background-color: var(--version-bg);
      min-height: 100vh;
    }

    #combine-section {
      background-color: var(--combine-bg);
      margin: 0;
      padding: 0;
    }

    #combineView,
    #todayViewCombine,
    #historyViewCombine,
    #maintenanceMachineListViewCombine,
    #maintenanceDetailViewCombine {
      background-color: var(--combine-bg);
      min-height: 100vh;
    }

    #dashboardCombine {
      background-color: var(--combine-bg);
    }

    /* dashboardCombine専用のスタイル（ゴールド系） */
    #dashboardCombine .bi-header {
      background: #8b7344 !important;
    }

    #dashboardCombine .kpi-card {
      background: var(--combine-color) !important;
    }

    #dashboardCombine .chart-title {
      color: var(--combine-color) !important;
    }

    #dashboardCombine .donut-icon {
      color: var(--combine-color) !important;
    }

    #dashboardCombine .tab-btn.active {
      background: #8b7344 !important;
    }

    #dashboardCombine .tab-btn.inactive {
      color: var(--combine-color) !important;
    }

    #dashboardCombine .nav-item.active {
      border-left-color: var(--combine-color) !important;
    }

    .log-badge {
      background-color: #f3f4f6;
      color: #374151;
    }

    #dashboard.active {
      display: flex !important;
      flex-direction: column;
      overflow-x: hidden;
    }

    .bi-header {
      height: 65px;
      display: flex;
      align-items: center;
      background: #2d4031;
      color: white;
      flex-shrink: 0;
      width: 100%;
      padding: 0 20px;
    }

    .dashboard-top-bar {
      flex-shrink: 0;
      padding: 10px 15px;
    }

    .main-top-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: stretch;
    }

    .kpi-section {
      flex: 1;
      min-width: 320px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .ranking-section {
      flex: 0.4;
      min-width: 250px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 12px;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
    }

    .kpi-card {
      background: var(--tractor-color);
      color: white;
      padding: 8px 2px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .kpi-label {
      font-size: 9px;
      font-weight: bold;
      opacity: 0.9;
    }

    .kpi-value-container {
      display: flex;
      align-items: baseline;
      gap: 1px;
    }

    .kpi-value {
      font-size: 15px;
      font-weight: 900;
    }

    .kpi-unit {
      font-size: 12px;
      opacity: 0.8;
      font-weight: bold;
    }

    .bi-container {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      padding: 12px;
      gap: 12px;
      align-items: stretch;
    }

    .bi-left-col {
      flex: 1.1;
      min-width: 280px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .bi-main-col {
      flex: 1.8;
      min-width: 320px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .bi-right-col {
      flex: 0.8;
      min-width: 280px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-self: stretch;
    }

    .bi-right-col>.yoy-card {
      flex: 1 1 0% !important;
      min-height: 0;
      max-height: 33%;
      display: flex;
      flex-direction: column;
    }

    .bi-right-col>.maint-card {
      flex: 2 2 0% !important;
      min-height: 0;
      max-height: 67%;
      display: flex;
      flex-direction: column;
    }

    #maintenanceLog {
      flex: 1;
      overflow-y: auto;
    }

    @media (max-width: 1024px) {
      .bi-right-col {
        width: 100%;
        flex: 1;
      }
    }

    .bi-container>div>.card {
      margin-bottom: 0 !important;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .chart-title {
      font-size: 14px !important;
      font-weight: bold !important;
      color: var(--tractor-color) !important;
      margin-bottom: 8px;
      display: block;
    }

    .chart-wrapper {
      flex: 1;
      position: relative;
      width: 100%;
      min-height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .donut-icon {
      position: absolute;
      font-size: 24px;
      color: var(--tractor-color);
      opacity: 0.3;
      pointer-events: none;
    }

    #customModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
      padding: 20px;
    }

    #customModal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      width: 100%;
      max-width: 320px;
      border-radius: 20px;
      overflow: hidden;
    }

    .tab-btn {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: bold;
      cursor: pointer;
      white-space: nowrap;
      border: none;
    }

    .tab-btn.active {
      background: #2d4031;
      color: white;
    }

    .tab-btn.inactive {
      background: rgba(255, 255, 255, 0.5);
      color: var(--tractor-color);
    }

    .dashboard-sidebar {
      width: 200px;
      min-width: 200px;
      background: #2d4031;
      color: white;
      height: 100vh;
      position: sticky;
      top: 0;
      display: flex;
      flex-direction: column;
      padding: 20px 0;
    }

    .nav-item {
      width: 100%;
      padding: 15px 20px;
      text-align: left;
      color: rgba(255, 255, 255, 0.7);
      font-size: 13px;
      border: none;
      background: none;
      cursor: pointer;
      transition: 0.3s;
    }

    .nav-item i {
      margin-right: 10px;
    }

    .nav-item.active {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border-left: 4px solid var(--tractor-color);
    }

    .dashboard-main-content {
      overflow-y: auto;
      height: 100vh;
    }

    /* --- Portal view styles --- */
    #portalView {
      display: none;
      margin: 0 !important;
      padding: 0 !important;
      min-height: 100vh !important;
      background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%) !important;
    }

    .portal-hero {
      width: 100%;
      margin: 0;
      border-radius: 0;
      position: relative;
      color: #ffffff;
      padding: 40px;
      background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 60px;
      align-items: center;
      overflow: visible;
      min-height: 100vh;
    }
    
    .portal-hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(74, 144, 226, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 90% 80%, rgba(138, 43, 226, 0.06) 0%, transparent 50%);
      pointer-events: none;
    }

    .portal-title { 
      font-family: 'Zen Kaku Gothic New', sans-serif;
      font-size: 56px; 
      font-weight: 900; 
      letter-spacing: -0.02em;
      line-height: 1.1;
      margin-bottom: 16px;
      background: linear-gradient(135deg, #ffffff 0%, #a0d8d8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .portal-subtitle {
      font-family: 'Zen Kaku Gothic New', sans-serif;
      font-size: 13px;
      font-weight: 400;
      letter-spacing: 0.05em;
      color: rgba(255,255,255,0.6);
      margin-bottom: 32px;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .portal-description {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 14px;
      line-height: 1.8;
      color: rgba(255,255,255,0.7);
      margin-bottom: 24px;
    }
    
    .portal-author {
      font-family: 'Space Grotesk', monospace;
      font-size: 13px;
      color: rgba(255,255,255,0.5);
      margin-top: auto;
      padding-top: 40px;
    }
    
    .portal-author a {
      color: #4fd1c5;
      text-decoration: none;
      transition: color 0.3s;
    }
    
    .portal-author a:hover {
      color: #81e6d9;
    }
    
    .portal-left {
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    .portal-sub { opacity: 0.95; margin-top: 8px; color: rgba(255,255,255,0.95); }
    /* Ensure title/sub are explicitly visible on all devices */
    .portal-title, .portal-sub { color: rgba(234,242,234,1); text-shadow: 0 1px 2px rgba(0,0,0,0.35); }
    .portal-hero > div { position: relative; z-index: 2; }
    
    /* ベントーグリッドレイアウト */
    .portal-grid {
      position: relative;
      z-index: 2;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-auto-rows: 160px;
      gap: 20px;
      margin-bottom: 0;
    }
    
    .portal-grid .portal-card {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 32px;
      text-align: center;
      transition: all .3s ease;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #ffffff;
      border: 1px solid rgba(255,255,255,0.1);
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }
    
    .portal-grid .portal-card .card-icon {
      font-size: 2.5rem;
      margin-bottom: 16px;
      opacity: 0.9;
    }
    
    .portal-grid .portal-card .card-title {
      font-family: 'Outfit', sans-serif;
      font-size: 18px;
      font-weight: 700;
      margin-top: 16px;
      margin-bottom: 8px;
    }
    
    .portal-grid .portal-card .card-subtitle {
      font-family: 'Space Grotesk', monospace;
      font-size: 11px;
      letter-spacing: 0.05em;
      opacity: 0.6;
      text-transform: uppercase;
    }
    
    .portal-grid .portal-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.05) 100%);
      opacity: 0;
      transition: opacity .4s ease;
    }
    
    .portal-grid .portal-card::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      opacity: 0;
      transition: opacity .4s ease;
    }
    
    .portal-grid .portal-card:hover::before {
      opacity: 1;
    }
    
    .portal-grid .portal-card:hover::after {
      opacity: 1;
    }
    
    .portal-grid .portal-card i { 
      color: inherit !important; 
      filter: drop-shadow(0 4px 12px rgba(0,0,0,0.25));
      transition: all .4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    .portal-grid .portal-card:hover {
      transform: translateY(-8px) scale(1.03) rotate(0.5deg);
      box-shadow: 
        0 20px 60px rgba(0,0,0,0.2),
        inset 0 1px 0 rgba(255,255,255,0.3),
        0 1px 3px rgba(0,0,0,0.1);
      background: linear-gradient(145deg, rgba(255,255,255,0.35) 0%, rgba(255,255,255,0.15) 100%);
      border-color: rgba(255,255,255,0.3);
    }
    
    .portal-grid .portal-card:hover i {
      transform: scale(1.1) rotate(-5deg);
      filter: drop-shadow(0 6px 16px rgba(0,0,0,0.3));
    }
    
    /* 各カードに微妙な色付け */
    .portal-card:nth-child(1) { 
      background: linear-gradient(145deg, rgba(107,143,113,0.3) 0%, rgba(107,143,113,0.15) 100%);
    }
    .portal-card:nth-child(2) { 
      background: linear-gradient(145deg, rgba(74,155,155,0.3) 0%, rgba(74,155,155,0.15) 100%);
    }
    .portal-card:nth-child(3) { 
      background: linear-gradient(145deg, rgba(201,169,97,0.3) 0%, rgba(201,169,97,0.15) 100%);
    }
    .portal-card:nth-child(4) { 
      background: linear-gradient(145deg, rgba(139,92,246,0.3) 0%, rgba(139,92,246,0.15) 100%);
    }
    .portal-card:nth-child(5) { 
      background: linear-gradient(145deg, rgba(239,68,68,0.3) 0%, rgba(239,68,68,0.15) 100%);
    }
    .portal-card:nth-child(6) { 
      background: linear-gradient(145deg, rgba(59,130,246,0.3) 0%, rgba(59,130,246,0.15) 100%);
    }
    .portal-card:nth-child(7) { 
      background: linear-gradient(145deg, rgba(234,179,8,0.3) 0%, rgba(234,179,8,0.15) 100%);
    }
    .portal-card:nth-child(8) { 
      background: linear-gradient(145deg, rgba(148,163,184,0.3) 0%, rgba(148,163,184,0.15) 100%);
    }
    
    /* ベントーグリッドのアイテム配置 */
    /* 左半分 */
    .portal-card:nth-child(1) { grid-column: 1 / 3; grid-row: 1 / 3; } /* トラクター - 上（大）*/
    .portal-card:nth-child(3) { grid-column: 1 / 3; grid-row: 3; } /* 田植え機 - 中 */
    .portal-card:nth-child(5) { grid-column: 1 / 3; grid-row: 4; } /* コンバイン - 下 */
    /* 右半分 */
    .portal-card:nth-child(2) { grid-column: 3 / 5; grid-row: 1; } /* メンテナンス - 上 */
    .portal-card:nth-child(4) { grid-column: 3 / 5; grid-row: 2; } /* 修理 - 中 */
    .portal-card:nth-child(6) { grid-column: 3; grid-row: 3 / 5; } /* その他の機械 - 下左（縦長）*/
    .portal-card:nth-child(7) { grid-column: 4; grid-row: 3; } /* エクスポート - 下右上 */
    .portal-card:nth-child(8) { grid-column: 4; grid-row: 4; } /* バージョン情報 - 下右下 */
    
    /* トラクターカード（最初のカード）のアイコンを大きく */
    .portal-card:nth-child(1) i {
      font-size: 5rem;
    }
    
    @media (max-width: 1024px) {
      .portal-grid { 
        grid-template-columns: repeat(4, 1fr);
        grid-auto-rows: 120px;
      }
      .portal-card:nth-child(1) { grid-column: 1 / 3; grid-row: 1 / 3; }
      .portal-card:nth-child(2) { grid-column: 3 / 5; grid-row: 1; }
      .portal-card:nth-child(3) { grid-column: 1 / 3; grid-row: 3; }
      .portal-card:nth-child(4) { grid-column: 3 / 5; grid-row: 2; }
      .portal-card:nth-child(5) { grid-column: 1 / 3; grid-row: 4; }
      .portal-card:nth-child(6) { grid-column: 3; grid-row: 3 / 5; }
      .portal-card:nth-child(7) { grid-column: 4; grid-row: 3; }
      .portal-card:nth-child(8) { grid-column: 4; grid-row: 4; }
    }
    
    @media (max-width: 640px) {
      .portal-grid { 
        grid-template-columns: repeat(2, 1fr);
        grid-auto-rows: 100px;
        gap: 12px;
      }
      /* スマホでの並び順: トラクター、田植え機、コンバイン、その他の機械、メンテナンス、修理、エクスポート、バージョン */
      .portal-card:nth-child(1) { grid-column: 1 / 3; grid-row: 1; order: 1; } /* トラクター */
      .portal-card:nth-child(2) { grid-column: 1 / 3; grid-row: 5; order: 5; } /* メンテナンス */
      .portal-card:nth-child(3) { grid-column: 1 / 3; grid-row: 2; order: 2; } /* 田植え機 */
      .portal-card:nth-child(4) { grid-column: 1 / 3; grid-row: 6; order: 6; } /* 修理 */
      .portal-card:nth-child(5) { grid-column: 1 / 3; grid-row: 3; order: 3; } /* コンバイン */
      .portal-card:nth-child(6) { grid-column: 1 / 3; grid-row: 4; order: 4; } /* その他の機械 */
      .portal-card:nth-child(7) { grid-column: 1 / 3; grid-row: 7; order: 7; } /* エクスポート */
      .portal-card:nth-child(8) { grid-column: 1 / 3; grid-row: 8; order: 8; } /* バージョン情報 */
      .portal-hero { padding: calc(12px + env(safe-area-inset-top)) 18px 0; justify-content: flex-start; }
      .portal-hero { grid-template-columns: 1fr; gap: 32px; }
      .portal-left { text-align: center; padding-top: 0 !important; }
      .portal-title { font-size: 32px; }
      .portal-subtitle { font-size: 9px; }
      .portal-grid .portal-card { padding: 12px; }
      .portal-card:nth-child(1) i { font-size: 2.5rem !important; }
      .portal-card i { font-size: 2rem !important; }
      .portal-card .card-title { font-size: 14px; margin-top: 0 !important; }
    }

    /* ページ下部の余白 */
    .view {
      padding-bottom: 60px !important;
    }

    /* 印刷時のスタイル */
    @media print {
      /* ヘッダーを非表示 */
      header,
      .bi-header {
        display: none !important;
      }

      /* サイドメニューとその影を非表示 */
      .sideMenu,
      #sideMenu,
      #tractorSideMenu,
      #plantingSideMenu,
      #combineSideMenu,
      #overlay {
        display: none !important;
      }

      /* ボタン類を非表示 */
      button,
      .btn,
      .btn-main,
      .btn-sub {
        display: none !important;
      }

      /* 入力欄を非表示 */
      input,
      select,
      textarea {
        display: none !important;
      }

      /* 印刷機能カード全体を非表示 */
      #exportView .card:has(button[onclick="window.print()"]) {
        display: none !important;
      }

      /* ヘッダーのハンバーガーメニューボタンを非表示 */
      header button[onclick="openMenu()"],
      .bi-header button[onclick="openMenu()"] {
        display: none !important;
      }

      /* コンテンツの左マージンをリセット */
      #mainContainer {
        margin-left: 0 !important;
      }

      /* ページの余白を調整 */
      body {
        background: white;
      }

      .view {
        padding-bottom: 20px !important;
      }

      /* 絞り込み条件のカードを非表示 */
      #exportView .card:has(#exportDataType),
      #exportView .card:has(#exportStartDate) {
        display: none !important;
      }

      /* エクスポートボタンのカードを非表示 */
      #exportView .card:has(#exportButton) {
        display: none !important;
      }
    }

  </style>

</head>

<body style="visibility:hidden">

  <div id="overlay" onclick="closeMenu()"></div>
  <!-- Tractor Side Menu -->
  <div id="tractorSideMenu" class="sideMenu">
    <div class="flex justify-between items-center mb-6">
      <h2 class="font-bold text-lg" style="color: var(--tractor-color)">Tractor Menu</h2>
      <button onclick="closeMenu()" class="close-menu-btn text-2xl text-gray-400">&times;</button>
    </div>
    <nav class="space-y-1">
      <button onclick="switchView('portalView')" class="menu-item"><i
          class="fa-solid fa-home w-8 text-lg"></i>Portal</button>
      <button onclick="switchView('tractorView')" class="menu-item"><i
          class="fa-solid fa-tractor w-8 text-lg"></i>ログ入力</button>
      <button onclick="switchView('todayView')" class="menu-item"><i
          class="fa-solid fa-calendar-day w-8 text-lg"></i>本日の稼働状況</button>
      <button onclick="switchView('historyView')" class="menu-item"><i
          class="fa-solid fa-magnifying-glass w-8 text-lg"></i>稼働履歴・検索</button>
      <button onclick="switchView('dashboard')" class="menu-item"><i
          class="fa-solid fa-chart-line w-8 text-lg"></i>データ分析</button>
    </nav>
  </div>

  <!-- Planting Side Menu -->
  <div id="plantingSideMenu" class="sideMenu">
    <div class="flex justify-between items-center mb-6">
      <h2 class="font-bold text-lg" style="color: var(--planting-color)">Transplanter Menu</h2>
      <button onclick="closeMenu()" class="close-menu-btn text-2xl text-gray-400">&times;</button>
    </div>
    <nav class="space-y-1">
      <button onclick="switchView('portalView')" class="menu-item"><i
          class="fa-solid fa-home w-8 text-lg"></i>Portal</button>
      <button onclick="switchView('plantingView')" class="menu-item"><i
          class="fa-solid fa-seedling w-8 text-lg"></i>田植え機ログ入力</button>
      <button onclick="switchView('todayViewPlanting')" class="menu-item"><i
          class="fa-solid fa-calendar-day w-8 text-lg"></i>本日の稼働状況</button>
      <button onclick="switchView('historyViewPlanting')" class="menu-item"><i
          class="fa-solid fa-magnifying-glass w-8 text-lg"></i>稼働履歴・検索</button>
      <button onclick="switchView('dashboardPlanting')" class="menu-item"><i
          class="fa-solid fa-chart-line w-8 text-lg"></i>データ分析</button>
    </nav>
  </div>

  <!-- Combine Side Menu -->
  <div id="combineSideMenu" class="sideMenu">
    <div class="flex justify-between items-center mb-6">
      <h2 class="font-bold text-lg" style="color: var(--combine-color)">Combine Menu</h2>
      <button onclick="closeMenu()" class="close-menu-btn text-2xl text-gray-400">&times;</button>
    </div>
    <nav class="space-y-1">
      <button onclick="switchView('portalView')" class="menu-item"><i
          class="fa-solid fa-home w-8 text-lg"></i>Portal</button>
      <button onclick="switchView('combineView')" class="menu-item"><i
          class="fa-solid fa-wheat-awn w-8 text-lg"></i>コンバインログ入力</button>
      <button onclick="switchView('todayViewCombine')" class="menu-item"><i
          class="fa-solid fa-calendar-day w-8 text-lg"></i>本日の稼働状況</button>
      <button onclick="switchView('historyViewCombine')" class="menu-item"><i
          class="fa-solid fa-magnifying-glass w-8 text-lg"></i>稼働履歴・検索</button>
      <button onclick="switchView('dashboardCombine')" class="menu-item"><i
          class="fa-solid fa-chart-line w-8 text-lg"></i>データ分析</button>
    </nav>
  </div>

  <!-- Export Side Menu -->
  <div id="exportSideMenu" class="sideMenu">
    <div class="flex justify-between items-center mb-6">
      <h2 class="font-bold text-lg" style="color: var(--export-color);">Data Export Menu</h2>
      <button onclick="closeMenu()" class="close-menu-btn text-2xl text-gray-400">&times;</button>
    </div>
    <nav class="space-y-1">
      <button onclick="switchView('portalView')" class="menu-item"><i
          class="fa-solid fa-home w-8 text-lg"></i>Portal</button>
      <button onclick="switchView('exportView')" class="menu-item"><i
          class="fa-solid fa-file-export w-8 text-lg"></i>エクスポート/印刷</button>
      <button onclick="switchView('versionView')" class="menu-item"><i
          class="fa-solid fa-code-branch w-8 text-lg"></i>バージョン情報</button>
    </nav>
  </div>

  <!-- Maintenance Side Menu -->
  <div id="maintenanceSideMenu" class="sideMenu">
    <div class="flex justify-between items-center mb-6">
      <h2 class="font-bold text-lg" style="color: var(--maintenance-color);">Maintenance Menu</h2>
      <button onclick="closeMenu()" class="close-menu-btn text-2xl text-gray-400">&times;</button>
    </div>
    <nav class="space-y-1">
      <button onclick="switchView('portalView')" class="menu-item"><i
          class="fa-solid fa-home w-8 text-lg"></i>Portal</button>
      <button onclick="switchView('maintenanceMachineListView')" class="menu-item"><i
          class="fa-solid fa-toolbox w-8 text-lg"></i>メンテナンス記録</button>
    </nav>
  </div>

  <!-- Version Side Menu -->
  <div id="versionSideMenu" class="sideMenu">
    <div class="flex justify-between items-center mb-6">
      <h2 class="font-bold text-lg" style="color: var(--version-color);">Version情報</h2>
      <button onclick="closeMenu()" class="close-menu-btn text-2xl text-gray-400">&times;</button>
    </div>
    <nav class="space-y-1">
      <button onclick="switchView('portalView')" class="menu-item"><i
          class="fa-solid fa-home w-8 text-lg"></i>Portal</button>
      <button onclick="switchView('versionView')" class="menu-item"><i
          class="fa-solid fa-code-branch w-8 text-lg"></i>バージョン情報</button>
    </nav>
  </div>

  <!-- Portal/Global Side Menu -->
  <div id="sideMenu">
    <div class="flex justify-between items-center mb-6">
      <h2 class="font-bold text-lg text-[#6b8f71]">Menu</h2>
      <button onclick="closeMenu()" class="close-menu-btn text-2xl text-gray-400">&times;</button>
    </div>
    <nav class="space-y-1">
      <button onclick="switchView('portalView')" class="menu-item"><i
          class="fa-solid fa-home w-8 text-lg"></i>Portal</button>
      <button onclick="switchView('tractorView')" class="menu-item"><i
          class="fa-solid fa-tractor w-8 text-lg"></i>トラクター</button>
      <button onclick="switchView('plantingView')" class="menu-item"><i
          class="fa-solid fa-seedling w-8 text-lg"></i>田植え機</button>
      <button onclick="switchView('combineView')" class="menu-item"><i
          class="fa-solid fa-wheat-awn w-8 text-lg"></i>コンバイン</button>
      <button onclick="switchView('maintenanceMachineListView'); loadMachineList();" class="menu-item"><i
          class="fa-solid fa-toolbox w-8 text-lg"></i>メンテナンス記録</button>
    </nav>
  </div>

  <div id="customModal">
    <div class="modal-content">
      <div class="modal-header bg-[#2d4031] p-4 text-white text-center">
        <h3 id="modalTitle" class="font-bold">CONFIRM</h3>
      </div>
      <div class="modal-body p-6 text-center font-bold" id="modalMessage">メッセージ</div>
      <div class="modal-footer p-4 bg-gray-50 flex gap-2">
        <button class="flex-1 p-2 bg-gray-200 rounded-lg" onclick="closeModal()">戻る</button>
        <button id="modalOkBtn" class="flex-1 p-2 bg-[#6b8f71] text-white rounded-lg">実行する</button>
      </div>
    </div>
  </div>



  <div id="customModal">
    <div class="modal-content">
      <div class="modal-header bg-[#2d4031] p-4 text-white text-center">
        <h3 id="modalTitle" class="font-bold">CONFIRM</h3>
      </div>
      <div class="modal-body p-6 text-center font-bold" id="modalMessage">メッセージ</div>
      <div class="modal-footer p-4 bg-gray-50 flex gap-2">
        <button class="flex-1 p-2 bg-gray-200 rounded-lg" onclick="closeModal()">戻る</button>
        <button id="modalOkBtn" class="flex-1 p-2 bg-[#6b8f71] text-white rounded-lg">実行する</button>
      </div>
    </div>
  </div>



  <div id="mainContainer">
    <!-- Portal View: entry hub -->
    <div id="portalView" class="view fullscreen-view min-h-screen">
      <div class="portal-hero">
        <!-- 左側: タイトルエリア -->
        <div class="portal-left">
          <div class="portal-title">和農日向<br>機械管理App</div>
          <div class="portal-subtitle">Agricultural Machinery Management System</div>
        </div>

        <!-- 右側: ベントーグリッド -->
        <div class="portal-grid">
          <div class="portal-card" onclick="switchView('tractorView')" style="cursor:pointer;">
            <i class="fa-solid fa-tractor text-6xl"></i>
            <div class="card-title">トラクター</div>
          </div>

          <div class="portal-card" onclick="switchView('maintenanceMachineListView'); loadMachineList();" style="cursor:pointer;">
            <i class="fa-solid fa-toolbox text-5xl"></i>
            <div class="card-title">メンテナンス</div>
          </div>

          <div class="portal-card" onclick="switchView('plantingView')" style="cursor:pointer;">
            <i class="fa-solid fa-seedling text-5xl"></i>
            <div class="card-title">田植え機</div>
          </div>

          <div class="portal-card" onclick="switchView('repairView'); loadRepairDashboard();" style="cursor:pointer;">
            <i class="fa-solid fa-screwdriver-wrench text-5xl"></i>
            <div class="card-title">修理</div>
          </div>

          <div class="portal-card" onclick="switchView('combineView')" style="cursor:pointer;">
            <i class="fa-solid fa-wheat-awn text-5xl"></i>
            <div class="card-title">コンバイン</div>
          </div>

          <div class="portal-card" onclick="showModal('その他の機械', 'その他の機械の管理ページは準備中です')" style="cursor:pointer;">
            <i class="fa-solid fa-gears text-4xl"></i>
          </div>

          <div class="portal-card" onclick="switchView('exportView')" style="cursor:pointer;">
            <i class="fa-solid fa-file-export text-4xl"></i>
            <div class="card-title">エクスポート/印刷</div>
          </div>

          <div class="portal-card version-card" onclick="switchView('versionView')" style="cursor:pointer;">
            <span class="version-badge" id="versionBadge"></span>
            <i class="fa-solid fa-info-circle text-5xl"></i>
            <div class="card-title">バージョン情報</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tractor Section -->
    <div id="tractor-section">
      <div id="tractorView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
        <!-- トラクター専用ヘッダー -->
        <header id="pageHeader" class="flex flex-col items-center justify-center py-4 relative">
          <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--tractor-color)"><i
              class="fa-solid fa-bars"></i></button>
          <i class="fa-solid fa-tractor text-5xl" style="color: var(--tractor-color)"></i>
          <h1 class="text-xl font-bold" style="color: var(--tractor-color)">和農日向 機械管理アプリ</h1>
        </header>

        <div class="flex items-center gap-2 mb-1 mt-4">
          <i class="fa-solid fa-pen-to-square text-lg" style="color: var(--tractor-color)"></i>
          <span class="text-lg font-bold" style="color: var(--tractor-color)">ログ入力</span>
        </div>
        <div class="border-t-2 mb-6 opacity-50" style="border-color: var(--tractor-color)"></div>

        <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">機械を選択</label>
        <select id="machineSelect" class="w-full p-3 rounded-lg" onchange="autoFillHour()"></select>
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">作業日</label>
        <input type="date" id="workDate" class="w-full p-3 rounded-lg" />
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">オペレーター</label>
        <select id="operator" class="w-full p-3 rounded-lg">
          <option value="">読込中...</option>
        </select>
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">種別</label>
        <select id="category" class="w-full p-3 rounded-lg">
          <option value="">読込中...</option>
        </select>
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">作業内容</label>
        <select id="work_name" class="w-full p-3 rounded-lg">
          <option value="">先に種別を選択</option>
        </select>
      </div>

      <div class="card">
        <div class="flex space-x-4">
          <div class="flex-1">
            <label class="block text-xs font-bold text-gray-400 mb-1">稼働前</label>
            <input type="number" id="hourBefore" class="w-full p-3 rounded-lg font-bold" step="0.1"
              oninput="calcDiff()" />
          </div>
          <div class="flex-1 min-w-0">
            <label class="block text-xs font-bold text-gray-400 mb-1">稼働後</label>
            <div class="flex items-center gap-2 min-w-0">
              <input type="number" id="hourAfter" class="flex-1 min-w-0 p-3 rounded-lg font-bold" step="0.1" oninput="calcDiff()" />
              <input type="file" id="hourAfterImage" accept="image/*" capture="environment" class="hidden" onchange="handleHourAfterImage(this)">
              <button type="button" onclick="document.getElementById('hourAfterImage').click()"
                class="flex-none p-2 bg-white border rounded-lg text-[#6b8f71] shadow-sm hover:bg-[#f0f7f1]"><i class="fa-solid fa-camera"></i></button>
            </div>
          </div>
        </div>
      </div>

      <div id="hourDiffDisplay" class="text-right font-black mb-6 text-xl" style="color: var(--tractor-color)">稼働時間: 0.0 h</div>

      <div class="card">
        <div class="flex gap-4">
          <div class="flex-1">
            <label class="block text-xs font-bold text-gray-400 mb-1">油種</label>
            <select id="fuelType" class="w-full p-3 rounded-lg">
              <option value="">読込中...</option>
            </select>
          </div>
          <div class="flex-[2]">
            <label class="block text-xs font-bold text-gray-400 mb-1">給油量 (L)</label>
            <input type="number" id="fuelAmount" class="w-full p-3 rounded-lg" />
          </div>
        </div>
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
        <textarea id="memoInput" class="w-full p-3 rounded-lg" rows="2"></textarea>
      </div>

      <button id="saveBtn" class="btn-main" onclick="saveLog()">ログを保存する</button>
      </div>
    </div>

    <!-- Planting Section -->
    <div id="planting-section">
      <!-- 田植え機 Dashboard -->
      <div id="dashboardPlanting" class="view fullscreen-view">
        <div class="bi-header">
          <button onclick="openMenu()" class="text-2xl mr-6 hover:opacity-70 transition-opacity"><i
              class="fa-solid fa-bars"></i></button>
          <h1 class="text-lg md:text-2xl font-black tracking-widest flex items-center">
            <i class="fa-solid fa-chart-column mr-3"></i> 2026 Transplanter data analysis
          </h1>
        </div>

        <div class="dashboard-top-bar">
          <div class="main-top-row">
            <div class="kpi-section">
              <div id="machineTabsPlanting" class="flex gap-2 overflow-x-auto pb-1"></div>
              <div class="kpi-grid">
                <div class="kpi-card"><span class="kpi-label">総 稼 働</span>
                  <div class="kpi-value-container"><span class="kpi-value" id="kpi-hours-planting">0.0</span><span
                      class="kpi-unit">h</span></div>
                </div>
                <div class="kpi-card"><span class="kpi-label">給 油</span>
                  <div class="kpi-value-container"><span class="kpi-value" id="kpi-fuel-planting">0.0</span><span
                      class="kpi-unit">L</span></div>
                </div>
                <div class="kpi-card"><span class="kpi-label">燃 費</span>
                  <div class="kpi-value-container"><span class="kpi-value" id="kpi-avg-planting">0.0</span><span
                      class="kpi-unit">L/h</span></div>
                </div>
                <div class="kpi-card"><span class="kpi-label">日 数</span>
                  <div class="kpi-value-container"><span class="kpi-value" id="kpi-days-planting">0</span><span
                      class="kpi-unit">日</span></div>
                </div>
                <div class="kpi-card bg-[#4a6b50]"><span class="kpi-label">状 態</span><span
                    class="kpi-value text-[15px]">良好</span></div>
              </div>
            </div>
            <div class="ranking-section">
              <p class="text-[11px] font-bold mb-2 text-center" style="color: var(--planting-color)"><i
                  class="fa-solid fa-trophy mr-1"></i>稼働ランキング</p>
              <div id="rankListPlanting" class="flex justify-around items-center"></div>
            </div>
          </div>
        </div>

        <div class="bi-container">
          <div class="bi-left-col">
            <div class="card">
              <p class="chart-title" style="display: flex; align-items: center;">
                <i class="fa-solid fa-screwdriver-wrench" style="margin-right: 8px; color: var(--planting-color);"></i>
                機械別修理コスト
              </p>
              <div class="chart-wrapper relative">
                <canvas id="categoryShareChartPlanting"></canvas>
              </div>
            </div>

            <div class="card">
              <p class="chart-title" style="display: flex; align-items: center;">
                <i class="fa-solid fa-wheat-awn" style="margin-right: 8px; color: var(--planting-color);"></i>
                作物別比率
              </p>
              <div class="chart-wrapper relative">
                <canvas id="taskShareChartPlanting"></canvas>
              </div>
            </div>

            <div class="card">
              <p class="chart-title" style="display: flex; align-items: center;">
                <i class="fa-solid fa-user-check" style="margin-right: 8px; color: var(--planting-color);"></i>
                オペレーター比率
              </p>

              <div class="chart-wrapper relative">
                <canvas id="operatorShareChartPlanting"></canvas>
              </div>
            </div>
          </div>
          <div class="bi-main-col">
            <div class="lg:col-span-2 space-y-4">
              <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <p class="chart-title" style="display: flex; align-items: center;">
                  <i class="fa-solid fa-calendar-days" style="margin-right: 8px; color: var(--planting-color);"></i>
                  月別稼働推移
                </p>
                <div class="relative h-40"> <canvas id="detailChartPlanting"></canvas>
                </div>
              </div>
              <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <p class="chart-title" style="display: flex; align-items: center;">
                  <i class="fa-solid fa-list-check" style="margin-right: 8px; color: var(--planting-color);"></i>
                  作業内容分析
                </p>
                <div class="relative h-[480px]">
                  <canvas id="gradientBarChartPlanting"></canvas>
                </div>
              </div>
            </div>
          </div>

          <div class="bi-right-col">
            <div class="card yoy-card text-center relative">
              <p class="chart-title" style="display: flex; align-items: center; justify-content: center;">
                <i class="fa-solid fa-chart-line" style="margin-right: 8px; color: var(--planting-color);"></i>
                前年実績比 (YoY)
              </p>
              <div class="chart-wrapper relative">
                <canvas id="yearComparisonGaugePlanting"></canvas>
                <div class="absolute inset-0 flex items-center justify-center pt-14">
                  <p id="detailCompareValuePlanting" class="text-2xl font-black" style="color: var(--planting-color)">--%</p>
                </div>
              </div>
            </div>

            <div class="card maint-card overflow-hidden">
              <p class="chart-title border-b pb-1" style="display: flex; align-items: center;">
                <i class="fa-solid fa-clipboard-list" style="margin-right: 8px; color: var(--planting-color);"></i>
                メンテナンス情報
              </p>
              <div id="maintenanceLogPlanting" class="text-[10px] space-y-2 opacity-80 pt-2 flex-1 overflow-y-auto">
                <p class="italic text-gray-400 text-center py-4">履歴はありません</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="plantingView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
        <!-- 田植え機専用ヘッダー -->
        <header id="plantingHeader" class="flex flex-col items-center justify-center py-4 relative">
          <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--planting-color)"><i
              class="fa-solid fa-bars"></i></button>
          <i class="fa-solid fa-seedling text-5xl" style="color: var(--planting-color)"></i>
          <h1 class="text-xl font-bold" style="color: var(--planting-color)">和農日向 機械管理アプリ</h1>
        </header>

        <div class="flex items-center gap-2 mb-1 mt-4">
          <i class="fa-solid fa-seedling text-lg" style="color: var(--planting-color)"></i>
          <span class="text-lg font-bold" style="color: var(--planting-color)">田植え機ログ入力</span>
        </div>
        <div class="border-t-2 mb-6 opacity-50" style="border-color: var(--planting-color)"></div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">機械を選択</label>
          <select id="taue_machineSelect" class="w-full p-3 rounded-lg" onchange="taue_autoFillHour()"></select>
        </div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">作業日</label>
          <input type="date" id="taue_workDate" class="w-full p-3 rounded-lg" />
        </div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">オペレーター</label>
          <select id="taue_operator" class="w-full p-3 rounded-lg">
            <option value="">読込中...</option>
          </select>
        </div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">作業内容</label>
          <select id="taue_work_name" class="w-full p-3 rounded-lg">
            <option value="">読込中...</option>
          </select>
        </div>

        <div class="card">
          <div class="flex gap-2">
            <div style="flex: 1 1 0; min-width: 0;">
              <label class="block text-xs font-bold text-gray-400 mb-1">稼働前</label>
              <input type="number" id="taue_hourBefore" class="w-full p-3 rounded-lg font-bold" step="0.1"
                oninput="taue_calcDiff()" />
            </div>
            <div style="flex: 1 1 0; min-width: 0;">
              <label class="block text-xs font-bold text-gray-400 mb-1">稼働後</label>
              <input type="number" id="taue_hourAfter" class="w-full p-3 rounded-lg font-bold" step="0.1" oninput="taue_calcDiff()" />
            </div>
            <div class="flex items-end">
              <input type="file" id="taue_hourAfterImage" accept="image/*" capture="environment" class="hidden" onchange="taue_handleHourAfterImage(this)">
              <button type="button" onclick="document.getElementById('taue_hourAfterImage').click()"
                class="p-3 bg-white border rounded-lg shadow-sm hover:bg-[#e0f2f2]" style="color: var(--planting-color)"><i class="fa-solid fa-camera"></i></button>
            </div>
          </div>
        </div>

        <div id="taue_hourDiffDisplay" class="text-right font-black mb-6 text-xl" style="color: var(--planting-color)">稼働時間: 0.0 h</div>

        <div class="card">
          <div class="flex gap-4">
            <div class="flex-1">
              <label class="block text-xs font-bold text-gray-400 mb-1">油種</label>
              <select id="taue_fuelType" class="w-full p-3 rounded-lg">
                <option value="">読込中...</option>
              </select>
            </div>
            <div class="flex-[2]">
              <label class="block text-xs font-bold text-gray-400 mb-1">給油量 (L)</label>
              <input type="number" id="taue_fuelAmount" class="w-full p-3 rounded-lg" />
            </div>
          </div>
        </div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
          <textarea id="taue_memoInput" class="w-full p-3 rounded-lg" rows="2"></textarea>
        </div>

        <button id="taue_saveBtn" class="btn-main" onclick="taue_saveLog()">ログを保存する</button>
      </div>

      <!-- 本日の稼働状況 (田植え機) -->
      <div id="todayViewPlanting" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
        <!-- 田植え機専用ヘッダー -->
        <header class="flex flex-col items-center justify-center py-4 relative">
          <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--planting-color)"><i
              class="fa-solid fa-bars"></i></button>
          <i class="fa-solid fa-seedling text-5xl" style="color: var(--planting-color)"></i>
          <h1 class="text-xl font-bold" style="color: var(--planting-color)">和農日向 機械管理アプリ</h1>
        </header>

        <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg" style="color: var(--planting-color); border-bottom: 2px solid var(--planting-color)"><i
            class="fa-solid fa-calendar-day"></i> 本日の稼働状況</div>
        <div id="todayLogListPlanting" class="space-y-4"></div>
        <button onclick="switchView('plantingView')" class="btn-sub">TOPに戻る</button>
      </div>

      <!-- 稼働履歴・検索 (田植え機) -->
      <div id="historyViewPlanting" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
        <!-- 田植え機専用ヘッダー -->
        <header class="flex flex-col items-center justify-center py-4 relative">
          <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--planting-color)"><i
              class="fa-solid fa-bars"></i></button>
          <i class="fa-solid fa-seedling text-5xl" style="color: var(--planting-color)"></i>
          <h1 class="text-xl font-bold" style="color: var(--planting-color)">和農日向 機械管理アプリ</h1>
        </header>

        <div class="flex items-center gap-2 mb-6 font-bold pb-3 text-lg w-full" style="color: var(--planting-color); border-bottom: 2px solid var(--planting-color)">
          <i class="fa-solid fa-magnifying-glass"></i>
          <span>稼働履歴検索</span>
        </div>

        <div class="card space-y-3 text-sm mb-6">
          <div class="grid grid-cols-2 gap-3">
            <div class="flex flex-col gap-1">
              <label class="text-[10px] text-gray-400 font-bold ml-1">対象月</label>
              <input type="month" id="filterMonthPlanting" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm">
            </div>
            <div class="flex flex-col gap-1">
              <label class="text-[10px] text-gray-400 font-bold ml-1">機械</label>
              <select id="filterMachinePlanting" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm">
                <option value="">すべての機械</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3 mt-1">
            <div class="flex flex-col gap-1">
              <label class="text-[10px] text-gray-400 font-bold ml-1">オペレーター</label>
              <select id="filterOperatorPlanting" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm text-sm text-gray-600">
                <option value="">全オペレーター</option>
              </select>
            </div>

            <div class="flex flex-col gap-1">
              <label class="text-[10px] text-gray-400 font-bold ml-1">作業内容</label>
              <select id="filterCategoryPlanting" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm text-sm text-gray-600">
                <option value="">全作業内容</option>
              </select>
            </div>
          </div>

          <button onclick="loadLogsPlanting('historyLogListPlanting', false)" class="btn-main mt-2 shadow-md">
            検索を実行
          </button>
        </div>

        <div class="flex justify-end items-center mb-4 px-1">
          <div id="historyTotalHoursPlanting" class="text-sm font-black opacity-80 bg-white px-4 py-2 rounded-full shadow-sm" style="color: var(--planting-color)">
            合計: 0.0 h
          </div>
        </div>

        <div id="historyLogListPlanting" class="space-y-4"></div>

        <button onclick="switchView('plantingView')" class="btn-sub mt-8">
          <i class="fa-solid fa-house mr-2"></i>TOPに戻る
        </button>
      </div>
    </div>

    <!-- 田植え機 メンテナンス機械一覧 -->
    <div id="maintenanceMachineListViewPlanting" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
      <!-- 田植え機専用ヘッダー -->
      <header class="flex flex-col items-center justify-center py-4 relative">
        <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--planting-color)"><i
            class="fa-solid fa-bars"></i></button>
        <i class="fa-solid fa-seedling text-5xl" style="color: var(--planting-color)"></i>
        <h1 class="text-xl font-bold" style="color: var(--planting-color)">和農日向 機械管理アプリ</h1>
      </header>

      <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg" style="color: var(--planting-color); border-bottom: 2px solid var(--planting-color)">
        <i class="fa-solid fa-wrench"></i> 田植え機 メンテナンス記録
      </div>

      <div id="maintenanceMachineGridPlanting" class="space-y-6">
      </div>

      <button onclick="switchView('plantingView')" class="btn-sub mt-6 w-full">
        <i class="fa-solid fa-house mr-2"></i>TOPに戻る
      </button>
    </div>

    <!-- 田植え機 メンテナンス詳細 -->
    <div id="maintenanceDetailViewPlanting" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
      <!-- 田植え機専用ヘッダー -->
      <header class="flex flex-col items-center justify-center py-4 relative">
        <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--planting-color)"><i
            class="fa-solid fa-bars"></i></button>
        <i class="fa-solid fa-seedling text-5xl" style="color: var(--planting-color)"></i>
        <h1 class="text-xl font-bold" style="color: var(--planting-color)">和農日向 機械管理アプリ</h1>
      </header>

      <!-- タイトル（機械名は JS で差し替える） -->
      <div class="flex items-center gap-2 mb-4 font-bold text-[#4a9b9b] border-b-2 border-[#4a9b9b] pb-2 text-lg">
        <i class="fa-solid fa-seedling"></i>
        <span id="maintenanceMachineNamePlanting">機械名</span>
      </div>

      <div class="card mb-4">
        <p class="font-bold text-sm text-gray-500 mb-2">メンテナンス進捗</p>
        <div id="maintenanceSummaryPlanting" class="text-xs mt-1">
          未着手
        </div>
      </div>

      <div class="card mb-4">
        <p class="font-bold text-sm text-gray-500 mb-2">点検項目</p>
        <div id="maintenanceChecklistPlanting" class="space-y-2">
        </div>
      </div>

      <!-- 作業履歴タイムライン -->
      <div class="card mb-4">
        <p class="font-bold text-sm text-gray-500 mb-2">作業履歴</p>
        <div id="maintenanceHistoryLogPlanting" class="space-y-3 text-sm">
          <p class="italic text-gray-400 text-center py-4">履歴はありません</p>
        </div>
      </div>

      <div class="card mb-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
        <p class="font-bold text-sm mb-4 flex items-center" style="color: var(--planting-color)">
          <i class="fas fa-tools mr-2"></i>部品交換を記録
        </p>

        <label class="block text-xs font-bold text-gray-400 mb-1">交換部品・項目名</label>
        <input id="newMaintenanceItemPlanting" type="text"
          class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#4a9b9b] outline-none"
          placeholder="例：オイルエレメント">

        <label class="block text-xs font-bold text-gray-400 mb-1">担当者</label>
        <select id="newMaintenanceOperatorPlanting"
          class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#4a9b9b] outline-none">
          <option value="">担当者を選択</option>
        </select>

        <label class="block text-xs font-bold text-gray-400 mb-1">状態</label>
        <select id="newMaintenanceStatusPlanting"
          class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#4a9b9b] outline-none">
          <option value="done">完了</option>
          <option value="progress">作業中</option>
        </select>

        <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
        <textarea id="newMaintenanceMemoPlanting" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-4" rows="2"
          placeholder="備考"></textarea>

        <button onclick="saveMaintenanceRecordPlanting()"
          class="btn-main w-full py-3 bg-[#4a9b9b] text-white rounded-lg font-bold hover:bg-[#3a8080] transition-all shadow-md">
          部品交換を保存する
        </button>
      </div>

      <div class="flex justify-center w-full mt-6 mb-8">
        <button onclick="switchView('maintenanceMachineListViewPlanting')"
          class="bg-gray-500 text-white px-6 py-2.5 rounded-lg hover:bg-gray-600 transition-colors whitespace-nowrap text-[13px] sm:text-sm shadow-md flex items-center justify-center">
          <i class="fas fa-arrow-left mr-2"></i>
          <span>機械一覧ページに戻る</span>
        </button>
      </div>
    </div>
    </div>

    <!-- Combine Section -->
    <div id="combine-section">
      <div id="combineView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
        <!-- コンバイン専用ヘッダー -->
        <header class="flex flex-col items-center justify-center py-4 relative">
          <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--combine-color)"><i
              class="fa-solid fa-bars"></i></button>
          <i class="fa-solid fa-wheat-awn text-5xl" style="color: var(--combine-color)"></i>
          <h1 class="text-xl font-bold" style="color: var(--combine-color)">和農日向 機械管理アプリ</h1>
        </header>

        <div class="flex items-center gap-2 mb-1 mt-4">
          <i class="fa-solid fa-wheat-awn text-lg" style="color: var(--combine-color)"></i>
          <span class="text-lg font-bold" style="color: var(--combine-color)">コンバインログ入力</span>
        </div>
        <div class="border-t-2 mb-6 opacity-50" style="border-color: var(--combine-color)"></div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">機械を選択</label>
          <select id="combine_machineSelect" class="w-full p-3 rounded-lg" onchange="combine_autoFillHour()"></select>
        </div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">作業日</label>
          <input type="date" id="combine_workDate" class="w-full p-3 rounded-lg" />
        </div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">オペレーター</label>
          <select id="combine_operator" class="w-full p-3 rounded-lg">
            <option value="">読込中...</option>
          </select>
        </div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">作業内容</label>
          <select id="combine_work_name" class="w-full p-3 rounded-lg">
            <option value="">読込中...</option>
          </select>
        </div>

        <div class="card">
          <div class="flex gap-2">
            <div style="flex: 1 1 0; min-width: 0;">
              <label class="block text-xs font-bold text-gray-400 mb-1">稼働前</label>
              <input type="number" id="combine_hourBefore" class="w-full p-3 rounded-lg font-bold" step="0.1"
                oninput="combine_calcDiff()" />
            </div>
            <div style="flex: 1 1 0; min-width: 0;">
              <label class="block text-xs font-bold text-gray-400 mb-1">稼働後</label>
              <input type="number" id="combine_hourAfter" class="w-full p-3 rounded-lg font-bold" step="0.1" oninput="combine_calcDiff()" />
            </div>
            <div class="flex items-end">
              <input type="file" id="combine_hourAfterImage" accept="image/*" capture="environment" class="hidden" onchange="combine_handleHourAfterImage(this)">
              <button type="button" onclick="document.getElementById('combine_hourAfterImage').click()"
                class="p-3 bg-white border rounded-lg shadow-sm hover:bg-[#faf6ed]" style="color: var(--combine-color)"><i class="fa-solid fa-camera"></i></button>
            </div>
          </div>
        </div>

        <div id="combine_hourDiffDisplay" class="text-right font-black mb-6 text-xl" style="color: var(--combine-color)">稼働時間: 0.0 h</div>

        <div class="card">
          <div class="flex gap-4">
            <div class="flex-1">
              <label class="block text-xs font-bold text-gray-400 mb-1">油種</label>
              <select id="combine_fuelType" class="w-full p-3 rounded-lg">
                <option value="">読込中...</option>
              </select>
            </div>
            <div class="flex-[2]">
              <label class="block text-xs font-bold text-gray-400 mb-1">給油量 (L)</label>
              <input type="number" id="combine_fuelAmount" class="w-full p-3 rounded-lg" />
            </div>
          </div>
        </div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
          <textarea id="combine_memoInput" class="w-full p-3 rounded-lg" rows="2"></textarea>
        </div>

        <button id="combine_saveBtn" class="btn-main" onclick="combine_saveLog()">ログを保存する</button>
      </div>

      <!-- 本日の稼働状況 (コンバイン) -->
      <div id="todayViewCombine" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
        <!-- コンバイン専用ヘッダー -->
        <header class="flex flex-col items-center justify-center py-4 relative">
          <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--combine-color)"><i
              class="fa-solid fa-bars"></i></button>
          <i class="fa-solid fa-wheat-awn text-5xl" style="color: var(--combine-color)"></i>
          <h1 class="text-xl font-bold" style="color: var(--combine-color)">和農日向 機械管理アプリ</h1>
        </header>

        <div class="flex items-center gap-2 mb-4 font-bold border-b-2 pb-2 text-lg" style="color: var(--combine-color); border-color: var(--combine-color)"><i
            class="fa-solid fa-calendar-day"></i> 本日の稼働状況</div>
        <div id="todayLogListCombine" class="space-y-4"></div>
        <button onclick="switchView('combineView')" class="btn-sub">TOPに戻る</button>
      </div>

      <!-- 稼働履歴・検索 (コンバイン) -->
      <div id="historyViewCombine" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
        <!-- コンバイン専用ヘッダー -->
        <header class="flex flex-col items-center justify-center py-4 relative">
          <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--combine-color)"><i
              class="fa-solid fa-bars"></i></button>
          <i class="fa-solid fa-wheat-awn text-5xl" style="color: var(--combine-color)"></i>
          <h1 class="text-xl font-bold" style="color: var(--combine-color)">和農日向 機械管理アプリ</h1>
        </header>

        <div class="flex items-center gap-2 mb-6 font-bold border-b-2 pb-3 text-lg w-full" style="color: var(--combine-color); border-color: var(--combine-color)">
          <i class="fa-solid fa-magnifying-glass"></i>
          <span>稼働履歴検索</span>
        </div>

        <div class="card space-y-3 text-sm mb-6">
          <div class="grid grid-cols-2 gap-3">
            <div class="flex flex-col gap-1">
              <label class="text-[10px] text-gray-400 font-bold ml-1">対象月</label>
              <input type="month" id="filterMonthCombine" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm">
            </div>
            <div class="flex flex-col gap-1">
              <label class="text-[10px] text-gray-400 font-bold ml-1">機械</label>
              <select id="filterMachineCombine" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm">
                <option value="">すべての機械</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3 mt-1">
            <div class="flex flex-col gap-1">
              <label class="text-[10px] text-gray-400 font-bold ml-1">オペレーター</label>
              <select id="filterOperatorCombine" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm text-sm text-gray-600">
                <option value="">全オペレーター</option>
              </select>
            </div>

            <div class="flex flex-col gap-1">
              <label class="text-[10px] text-gray-400 font-bold ml-1">作業内容</label>
              <select id="filterCategoryCombine" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm text-sm text-gray-600">
                <option value="">全作業内容</option>
              </select>
            </div>
          </div>

          <button onclick="loadLogsCombine('historyLogListCombine', false)" class="btn-main mt-2 shadow-md">
            検索を実行
          </button>
        </div>

        <div class="flex justify-end items-center mb-4 px-1">
          <div id="historyTotalHoursCombine" class="text-sm font-black opacity-80 bg-white px-4 py-2 rounded-full shadow-sm" style="color: var(--combine-color)">
            合計: 0.0 h
          </div>
        </div>

        <div id="historyLogListCombine" class="space-y-4"></div>

        <button onclick="switchView('combineView')" class="btn-sub mt-8">
          <i class="fa-solid fa-house mr-2"></i>TOPに戻る
        </button>
      </div>

      <!-- コンバイン メンテナンス機械一覧 -->
      <div id="maintenanceMachineListViewCombine" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
        <!-- コンバイン専用ヘッダー -->
        <header class="flex flex-col items-center justify-center py-4 relative">
          <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--combine-color)"><i
              class="fa-solid fa-bars"></i></button>
          <i class="fa-solid fa-wheat-awn text-5xl" style="color: var(--combine-color)"></i>
          <h1 class="text-xl font-bold" style="color: var(--combine-color)">和農日向 機械管理アプリ</h1>
        </header>

        <div class="flex items-center gap-2 mb-4 font-bold text-[#c9a961] border-b-2 border-[#c9a961] pb-2 text-lg">
          <i class="fa-solid fa-wrench"></i> コンバイン メンテナンス記録
        </div>

        <div id="maintenanceMachineGridCombine" class="space-y-6">
        </div>

        <button onclick="switchView('combineView')" class="btn-sub mt-6 w-full">
          <i class="fa-solid fa-house mr-2"></i>TOPに戻る
        </button>
      </div>

      <!-- コンバイン メンテナンス詳細 -->
      <div id="maintenanceDetailViewCombine" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
        <!-- コンバイン専用ヘッダー -->
        <header class="flex flex-col items-center justify-center py-4 relative">
          <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl text-[#c9a961] p-2"><i
              class="fa-solid fa-bars"></i></button>
          <i class="fa-solid fa-wheat-awn text-5xl text-[#c9a961]"></i>
          <h1 class="text-xl font-bold text-[#c9a961]">和農日向 機械管理アプリ</h1>
        </header>

        <!-- タイトル（機械名は JS で差し替える） -->
        <div class="flex items-center gap-2 mb-4 font-bold text-[#c9a961] border-b-2 border-[#c9a961] pb-2 text-lg">
          <i class="fa-solid fa-wheat-awn"></i>
          <span id="maintenanceMachineNameCombine">機械名</span>
        </div>

        <div class="card mb-4">
          <p class="font-bold text-sm text-gray-500 mb-2">メンテナンス進捗</p>
          <div id="maintenanceSummaryCombine" class="text-xs mt-1">
            未着手
          </div>
        </div>

        <div class="card mb-4">
          <p class="font-bold text-sm text-gray-500 mb-2">点検項目</p>
          <div id="maintenanceChecklistCombine" class="space-y-2">
          </div>
        </div>

        <!-- 作業履歴タイムライン -->
        <div class="card mb-4">
          <p class="font-bold text-sm text-gray-500 mb-2">作業履歴</p>
          <div id="maintenanceHistoryLogCombine" class="space-y-3 text-sm">
            <p class="italic text-gray-400 text-center py-4">履歴はありません</p>
          </div>
        </div>

        <div class="card mb-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
          <p class="font-bold text-sm text-[#c9a961] mb-4 flex items-center">
            <i class="fas fa-tools mr-2"></i>部品交換を記録
          </p>

          <label class="block text-xs font-bold text-gray-400 mb-1">交換部品・項目名</label>
          <input id="newMaintenanceItemCombine" type="text"
            class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#c9a961] outline-none"
            placeholder="例：オイルエレメント">

          <label class="block text-xs font-bold text-gray-400 mb-1">担当者</label>
          <select id="newMaintenanceOperatorCombine"
            class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#c9a961] outline-none">
            <option value="">担当者を選択</option>
          </select>

          <label class="block text-xs font-bold text-gray-400 mb-1">状態</label>
          <select id="newMaintenanceStatusCombine"
            class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#c9a961] outline-none">
            <option value="done">完了</option>
            <option value="progress">作業中</option>
          </select>

          <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
          <textarea id="newMaintenanceMemoCombine" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-4" rows="2"
            placeholder="備考"></textarea>

          <button onclick="saveMaintenanceRecordCombine()"
            class="btn-main w-full py-3 bg-[#c9a961] text-white rounded-lg font-bold hover:bg-[#b8985a] transition-all shadow-md">
            部品交換を保存する
          </button>
        </div>

        <div class="flex justify-center w-full mt-6 mb-8">
          <button onclick="switchView('maintenanceMachineListViewCombine')"
            class="bg-gray-500 text-white px-6 py-2.5 rounded-lg hover:bg-gray-600 transition-colors whitespace-nowrap text-[13px] sm:text-sm shadow-md flex items-center justify-center">
            <i class="fas fa-arrow-left mr-2"></i>
            <span>機械一覧ページに戻る</span>
          </button>
        </div>
      </div>

      <!-- コンバイン Dashboard (準備中) -->
      <div id="dashboardCombine" class="view fullscreen-view">
        <div class="bi-header">
          <button onclick="openMenu()" class="text-2xl mr-6 hover:opacity-70 transition-opacity"><i
              class="fa-solid fa-bars"></i></button>
          <h1 class="text-lg md:text-2xl font-black tracking-widest flex items-center">
            <i class="fa-solid fa-chart-column mr-3"></i> 2026 Combine data-analysis
          </h1>
        </div>
        <div class="card mt-8">
          <p class="text-center text-gray-500 py-8">準備中...</p>
        </div>
      </div>
    </div>

    <div id="dashboard" class="view fullscreen-view">
      <div class="bi-header">
        <button onclick="openMenu()" class="text-2xl mr-6 hover:opacity-70 transition-opacity"><i
            class="fa-solid fa-bars"></i></button>
        <h1 class="text-lg md:text-2xl font-black tracking-widest flex items-center">
          <i class="fa-solid fa-chart-column mr-3"></i> 2026 Tractor data analysis
        </h1>
      </div>

      <div class="dashboard-top-bar">
        <div class="main-top-row">
          <div class="kpi-section">
            <div id="machineTabs" class="flex gap-2 overflow-x-auto pb-1"></div>
            <div class="kpi-grid">
              <div class="kpi-card"><span class="kpi-label">総 稼 働</span>
                <div class="kpi-value-container"><span class="kpi-value" id="kpi-hours">0.0</span><span
                    class="kpi-unit">h</span></div>
              </div>
              <div class="kpi-card"><span class="kpi-label">給 油</span>
                <div class="kpi-value-container"><span class="kpi-value" id="kpi-fuel">0.0</span><span
                    class="kpi-unit">L</span></div>
              </div>
              <div class="kpi-card"><span class="kpi-label">燃 費</span>
                <div class="kpi-value-container"><span class="kpi-value" id="kpi-avg">0.0</span><span
                    class="kpi-unit">L/h</span></div>
              </div>
              <div class="kpi-card"><span class="kpi-label">日 数</span>
                <div class="kpi-value-container"><span class="kpi-value" id="kpi-days">0</span><span
                    class="kpi-unit">日</span></div>
              </div>
              <div class="kpi-card bg-[#4a6b50]"><span class="kpi-label">状 態</span><span
                  class="kpi-value text-[15px]">良好</span></div>
            </div>
          </div>
          <div class="ranking-section">
            <p class="text-[11px] font-bold mb-2 text-center" style="color: var(--tractor-color)"><i
                class="fa-solid fa-trophy mr-1"></i>稼働ランキング</p>
            <div id="rankList" class="flex justify-around items-center"></div>
          </div>
        </div>
      </div>

      <div class="bi-container">
        <div class="bi-left-col">
          <div class="card">
            <p class="chart-title" style="display: flex; align-items: center;">
              <i class="fa-solid fa-screwdriver-wrench" style="margin-right: 8px; color: #6b8f71;"></i>
              機械別修理コスト
            </p>
            <div class="chart-wrapper relative">
              <canvas id="categoryShareChart"></canvas>
            </div>
          </div>

          <div class="card">
            <p class="chart-title" style="display: flex; align-items: center;">
              <i class="fa-solid fa-wheat-awn" style="margin-right: 8px; color: #6b8f71;"></i>
              作物別比率
            </p>
            <div class="chart-wrapper relative">
              <canvas id="taskShareChart"></canvas>
            </div>
          </div>

          <div class="card">
            <p class="chart-title" style="display: flex; align-items: center;">
              <i class="fa-solid fa-user-check" style="margin-right: 8px; color: #6b8f71;"></i>
              オペレーター比率
            </p>

            <div class="chart-wrapper relative">
              <canvas id="operatorShareChart"></canvas>
            </div>
          </div>
        </div>
        <div class="bi-main-col">
          <div class="lg:col-span-2 space-y-4">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
              <p class="chart-title" style="display: flex; align-items: center;">
                <i class="fa-solid fa-calendar-days" style="margin-right: 8px; color: #6b8f71;"></i>
                月別稼働推移
              </p>
              <div class="relative h-40"> <canvas id="detailChart"></canvas>
              </div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
              <p class="chart-title" style="display: flex; align-items: center;">
                <i class="fa-solid fa-list-check" style="margin-right: 8px; color: #6b8f71;"></i>
                作業内容分析
              </p>
              <div class="relative h-[480px]">
                <canvas id="gradientBarChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="bi-right-col">
          <div class="card yoy-card text-center relative">
            <p class="chart-title" style="display: flex; align-items: center; justify-content: center;">
              <i class="fa-solid fa-chart-line" style="margin-right: 8px; color: #6b8f71;"></i>
              前年実績比 (YoY)
            </p>
            <div class="chart-wrapper relative">
              <canvas id="yearComparisonGauge"></canvas>
              <div class="absolute inset-0 flex items-center justify-center pt-14">
                <p id="detailCompareValue" class="text-2xl font-black" style="color: var(--tractor-color)">--%</p>
              </div>
            </div>
          </div>

          <div class="card maint-card overflow-hidden">
            <p class="chart-title border-b pb-1" style="display: flex; align-items: center;">
              <i class="fa-solid fa-clipboard-list" style="margin-right: 8px; color: #6b8f71;"></i>
              メンテナンス情報
            </p>
            <div id="maintenanceLog" class="text-[10px] space-y-2 opacity-80 pt-2 flex-1 overflow-y-auto">
              <p class="italic text-gray-400 text-center py-4">履歴はありません</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="todayView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
      <header class="flex flex-col items-center justify-center py-4 relative">
        <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--tractor-color)"><i
            class="fa-solid fa-bars"></i></button>
        <i class="fa-solid fa-tractor text-5xl" style="color: var(--tractor-color)"></i>
        <h1 class="text-xl font-bold" style="color: var(--tractor-color)">和農日向 機械管理アプリ</h1>
      </header>

      <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg" style="color: var(--tractor-color); border-bottom: 2px solid var(--tractor-color)"><i
          class="fa-solid fa-calendar-day"></i> 本日の稼働状況</div>
      <div id="todayLogList" class="space-y-4"></div>
      <button onclick="switchView('tractorView')" class="btn-sub">TOPに戻る</button>
    </div>

    <div id="historyView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
      <header class="flex flex-col items-center justify-center py-4 relative">
        <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--tractor-color)"><i
            class="fa-solid fa-bars"></i></button>
        <i class="fa-solid fa-tractor text-5xl" style="color: var(--tractor-color)"></i>
        <h1 class="text-xl font-bold" style="color: var(--tractor-color)">和農日向 機械管理アプリ</h1>
      </header>

      <div
        class="flex items-center gap-2 mb-6 font-bold pb-3 text-lg w-full" style="color: var(--tractor-color); border-bottom: 2px solid var(--tractor-color)">
        <i class="fa-solid fa-magnifying-glass"></i>
        <span>稼働履歴検索</span>
      </div>

      <div class="card space-y-3 text-sm mb-6">
        <div class="grid grid-cols-2 gap-3">
          <div class="flex flex-col gap-1">
            <label class="text-[10px] text-gray-400 font-bold ml-1">対象月</label>
            <input type="month" id="filterMonth" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm">
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-[10px] text-gray-400 font-bold ml-1">機械</label>
            <select id="filterMachine" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm">
              <option value="">すべての機械</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mt-1">
          <div class="flex flex-col gap-1">
            <label class="text-[10px] text-gray-400 font-bold ml-1">オペレーター</label>
            <select id="filterOperator"
              class="p-3 rounded-lg w-full border border-gray-100 shadow-sm text-sm text-gray-600">
              <option value="">全オペレーター</option>
            </select>
          </div>

          <div class="flex flex-col gap-1">
            <label class="text-[10px] text-gray-400 font-bold ml-1">作業内容</label>
            <select id="filterCategory"
              class="p-3 rounded-lg w-full border border-gray-100 shadow-sm text-sm text-gray-600">
              <option value="">全作業内容</option>
            </select>
          </div>
        </div>

        <button onclick="loadLogs('historyLogList', false)" class="btn-main mt-2 shadow-md">
          検索を実行
        </button>
      </div>

      <div class="flex justify-end items-center mb-4 px-1">
        <div id="historyTotalHours"
          class="text-sm font-black text-[#6b8f71] opacity-80 bg-white px-4 py-2 rounded-full shadow-sm">
          合計: 0.0 h
        </div>
      </div>

      <div id="historyLogList" class="space-y-4"></div>

      <button onclick="switchView('tractorView')" class="btn-sub mt-8">
        <i class="fa-solid fa-house mr-2"></i>TOPに戻る
      </button>
    </div>

    <div id="maintenanceMachineListView" class="view fullscreen-view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
      <!-- メンテナンス専用ヘッダー -->
      <header class="flex flex-col items-center justify-center py-4 relative">
        <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--maintenance-color);"><i
            class="fa-solid fa-bars"></i></button>
        <i class="fa-solid fa-toolbox text-5xl" style="color: var(--maintenance-color);"></i>
        <h1 class="text-xl font-bold" style="color: var(--maintenance-color);">和農日向 機械管理アプリ</h1>
      </header>

      <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg" style="color: var(--maintenance-color); border-bottom: 2px solid var(--maintenance-color);">
        <i class="fa-solid fa-wrench"></i> メンテナンス記録
      </div>

      <div id="maintenanceMachineGrid" class="space-y-6">
      </div>

      <button onclick="switchView('portalView')" class="btn-sub mt-6 w-full">
        <i class="fa-solid fa-home mr-2"></i>Portalに戻る
      </button>
    </div>

    <!-- Repair Section -->
    <div id="repair-section">
    <div id="repairView" class="view px-4 max-w-5xl mx-auto pb-0 hidden" style="background-color: var(--repair-bg);">
      <!-- 修理専用ヘッダー -->
      <header class="flex flex-col items-center justify-center py-4 relative">
        <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--repair-color);"><i
            class="fa-solid fa-bars"></i></button>
        <i class="fa-solid fa-screwdriver-wrench text-5xl" style="color: var(--repair-color);"></i>
        <h1 class="text-xl font-bold" style="color: var(--repair-color);">和農日向 機械管理アプリ</h1>
      </header>

      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl md:text-2xl font-extrabold flex items-center gap-2" style="color: var(--repair-color);">
          <i class="fa-solid fa-screwdriver-wrench"></i> 修理履歴
        </h2>
        <button onclick="switchView('invoiceOCRView'); populateMachineSelect();"
          class="text-white px-5 py-2 rounded-full shadow-lg active:scale-95 transition-all text-xs font-bold" style="background-color: var(--repair-color);">
          <i class="fa-solid fa-plus mr-1"></i> 新規登録
        </button>
      </div>

      <div class="rounded-[2rem] p-6 text-white shadow-xl mb-8 relative overflow-hidden" style="background: linear-gradient(to bottom right, var(--repair-color), var(--repair-hover));">
        <div class="relative z-10">
          <p class="text-white/80 text-[16px] md:text-xs font-medium mb-1 uppercase tracking-widest">2026年度 累計修理費</p>
          <h3 id="totalRepairCost" class="text-3xl md:text-5xl font-black tracking-wider">¥ 0</h3>
          <div class="mt-4 flex gap-4 text-[12px] text-white/80">
            <span><i class="fa-solid fa-screwdriver-wrench mr-1"></i> 修理の登録は右上の「+新規登録」から</span>
          </div>
        </div>
        <i class="fa-solid fa-gears absolute -right-4 -bottom-4 text-white/10 text-7xl md:text-8xl rotate-12"></i>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col">
          <div class="flex items-center gap-2 mb-4 font-bold border-b border-gray-50 pb-2 text-sm" style="color: var(--repair-color);">
            <i class="fa-solid fa-calendar-days"></i> 年ごとの修理費
          </div>
          <div id="yearlyRepairContainer" class="space-y-2 flex-grow text-sm">
          </div>
        </div>

        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col">
          <div class="flex items-center gap-2 mb-4 font-bold border-b border-gray-50 pb-2 text-sm" style="color: var(--repair-color);">
            <i class="fa-solid fa-microchip"></i> 機械ごとの集計
          </div>
          <div id="machineRepairContainer" class="space-y-2 flex-grow text-sm">
          </div>
        </div>

        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col">
          <div class="flex items-center gap-2 mb-4 font-bold border-b border-gray-50 pb-2 text-sm" style="color: var(--repair-color);">
            <i class="fa-solid fa-clock-rotate-left"></i> 最近の修理
          </div>
          <div id="recentRepairContainer" class="space-y-3 flex-grow">
          </div>
        </div>
      </div>

      <div class="flex justify-center w-full mt-6 mb-8">
        <button onclick="switchView('tractorView')" class="btn-sub w-full">
          <i class="fa-solid fa-house mr-2"></i>TOPに戻る
        </button>
      </div>
    </div>

    <div id="invoiceOCRView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0 hidden">
      <!-- トラクター専用ヘッダー -->
      <header class="flex flex-col items-center justify-center py-4 relative">
        <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl text-[#6b8f71] p-2"><i
            class="fa-solid fa-bars"></i></button>
        <i class="fa-solid fa-tractor text-5xl text-[#6b8f71]"></i>
        <h1 class="text-xl font-bold text-[#6b8f71]">和農日向 機械管理アプリ</h1>
      </header>

      <div class="flex items-center gap-2 mb-4 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-2 text-lg">
        <i class="fa-solid fa-screwdriver-wrench"></i> 修理の登録
      </div>

      <!-- 請求書の読み取り -->
      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">請求書・領収書の撮影</label>

        <input type="file" id="invoiceImage" accept="image/*" capture="environment" class="hidden"
          onchange="previewInvoice(this)">

        <button onclick="document.getElementById('invoiceImage').click()"
          class="w-full py-4 border-2 border-dashed border-[#6b8f71] rounded-lg text-[#6b8f71] flex flex-col items-center gap-2 hover:bg-[#f0f7f1] transition-colors">
          <i class="fa-solid fa-camera text-2xl"></i>
          <span class="text-sm font-bold">カメラを起動 / 画像を選択</span>
        </button>

        <div id="invoicePreviewArea" class="mt-4 hidden text-center">
          <img id="invoicePreviewImg" src="" class="w-full rounded-lg shadow-md mb-2 opacity-50">
          <p class="text-[10px] text-gray-500">解析用プレビュー（画像は保存されません）</p>
        </div>
      </div>

      <!-- 種別選択 -->
      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">種別</label>
        <select id="repairMachineType" class="w-full p-3 rounded-lg" onchange="filterMachinesByType()">
          <option value="">選択してください</option>
        </select>
      </div>

      <!-- 自動入力される項目 -->
      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">対象の機械</label>
        <select id="repairMachineSelect" class="w-full p-3 rounded-lg border bg-white">
        </select>
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">修理日</label>
        <input type="date" id="repairDate" class="w-full p-3 rounded-lg">
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">店舗名</label>
        <input type="text" id="repairShop" class="w-full p-3 rounded-lg">
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">金額</label>
        <input type="number" id="repairCost" class="w-full p-3 rounded-lg">
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
        <textarea id="repairMemo" class="w-full p-3 rounded-lg" rows="3"></textarea>
      </div>

      <button id="saveRepairBtn" class="btn-main" onclick="saveRepairLog()">修理履歴を保存</button>
      <button onclick="switchView('repairView'); loadRepairDashboard();" class="btn-sub mt-4 w-full">修理履歴へ戻る</button>

    </div>

    <div id="maintenanceDetailView" class="view fullscreen-view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">

      <!-- タイトル（機械名は JS で差し替える） -->
      <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg" style="color: var(--maintenance-color); border-bottom: 2px solid var(--maintenance-color);">
        <i class="fa-solid fa-toolbox"></i>
        <span id="maintenanceMachineName">機械名</span>
      </div>

      <div class="card mb-4">
        <p class="font-bold text-sm text-gray-500 mb-2">メンテナンス進捗</p>
        <div id="maintenanceSummary" class="text-xs mt-1">
          未着手
        </div>
      </div>

      <div class="card mb-4">
        <p class="font-bold text-sm text-gray-500 mb-2">点検項目</p>
        <div id="maintenanceChecklist" class="space-y-2">
        </div>
      </div>

      <!-- 作業履歴タイムライン -->
      <div class="card mb-4">
        <p class="font-bold text-sm text-gray-500 mb-2">作業履歴</p>
        <div id="maintenanceHistoryLog" class="space-y-3 text-sm">
          <p class="italic text-gray-400 text-center py-4">履歴はありません</p>
        </div>
      </div>

      <div class="card mb-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
        <p class="font-bold text-sm text-[#6b8f71] mb-4 flex items-center">
          <i class="fas fa-tools mr-2"></i>部品交換を記録
        </p>

        <label class="block text-xs font-bold text-gray-400 mb-1">交換部品・項目名</label>
        <input id="newMaintenanceItem" type="text"
          class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#6b8f71] outline-none"
          placeholder="例：オイルエレメント">

        <label class="block text-xs font-bold text-gray-400 mb-1">担当者</label>
        <select id="newMaintenanceOperator"
          class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#6b8f71] outline-none">
          <option value="">担当者を選択</option>
        </select>

        <label class="block text-xs font-bold text-gray-400 mb-1">状態</label>
        <select id="newMaintenanceStatus"
          class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#6b8f71] outline-none">
          <option value="done">完了</option>
          <option value="progress">作業中</option>
        </select>

        <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
        <textarea id="newMaintenanceMemo" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-4" rows="2"
          placeholder="備考"></textarea>

        <button onclick="saveMaintenanceRecord()"
          class="btn-main w-full py-3 bg-[#6b8f71] text-white rounded-lg font-bold hover:bg-[#5a7a5f] transition-all shadow-md">
          部品交換を保存する
        </button>
      </div>

      <div class="flex justify-center w-full mt-6 mb-8">
        <button onclick="switchView('maintenanceMachineListView')"
          class="bg-gray-500 text-white px-6 py-2.5 rounded-lg hover:bg-gray-600 transition-colors whitespace-nowrap text-[13px] sm:text-sm shadow-md flex items-center justify-center">
          <i class="fas fa-arrow-left mr-2"></i>
          <span>機械一覧ページに戻る</span>
        </button>
      </div>
    </div>
    </div>

    <!-- Export View -->
    <div id="exportView" class="view fullscreen-view" style="background: #faf9f6;">
      <div class="px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
        <header class="flex flex-col items-center justify-center py-4 relative">
          <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--export-color);"><i class="fa-solid fa-bars"></i></button>
          <i class="fa-solid fa-file-export text-5xl" style="color: var(--export-color);"></i>
          <h1 class="text-xl font-bold" style="color: var(--export-color);">和農日向 機械管理アプリ</h1>
        </header>

        <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg" style="color: var(--export-color); border-bottom: 2px solid var(--export-color);">
          <i class="fa-solid fa-file-export"></i> Data Export
        </div>

      <!-- 絞り込み条件 -->
      <div class="card mb-4">
        <h3 class="font-bold mb-3 flex items-center gap-2" style="color: var(--export-color);">
          <i class="fa-solid fa-filter"></i>絞り込み条件
        </h3>
        
        <div class="space-y-3">
          <!-- データタイプ選択 -->
          <div>
            <label class="block text-xs font-bold text-gray-400 mb-1">データタイプ</label>
            <select id="exportDataType" class="w-full p-3 rounded-lg" onchange="updateExportPreview()">
              <option value="tractor">トラクター稼働ログ</option>
              <option value="planting">田植え機稼働ログ</option>
              <option value="combine">コンバイン稼働ログ</option>
              <option value="maintenance">メンテナンス記録</option>
              <option value="repair">修理記録</option>
            </select>
          </div>

          <!-- 期間選択 -->
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-bold text-gray-400 mb-1">開始日</label>
              <input type="date" id="exportStartDate" class="w-full p-3 rounded-lg" onchange="updateExportPreview()">
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-400 mb-1">終了日</label>
              <input type="date" id="exportEndDate" class="w-full p-3 rounded-lg" onchange="updateExportPreview()">
            </div>
          </div>

          <!-- 機械選択 -->
          <div id="exportMachineFilter">
            <label class="block text-xs font-bold text-gray-400 mb-1">機械（オプション）</label>
            <select id="exportMachine" class="w-full p-3 rounded-lg" onchange="updateExportPreview()">
              <option value="">全ての機械</option>
            </select>
          </div>

          <!-- オペレーター選択 -->
          <div id="exportOperatorFilter">
            <label class="block text-xs font-bold text-gray-400 mb-1">オペレーター（オプション）</label>
            <select id="exportOperator" class="w-full p-3 rounded-lg" onchange="updateExportPreview()">
              <option value="">全てのオペレーター</option>
            </select>
          </div>
        </div>
      </div>

      <!-- データプレビュー -->
      <div class="card mb-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-bold flex items-center gap-2" style="color: var(--export-color);">
            <i class="fa-solid fa-table"></i>Data Preview
          </h3>
          <span id="previewCount" class="text-sm text-gray-600">0件</span>
        </div>
        
        <div class="overflow-x-auto">
          <div id="exportPreviewTable" class="text-sm">
            <p class="text-center text-gray-500 py-8">条件を選択してください</p>
          </div>
        </div>
      </div>

      <!-- エクスポートボタン -->
      <div class="card mb-4">
        <button id="exportButton" onclick="executeExport()" class="btn w-full" disabled>
          <i class="fa-solid fa-download mr-2"></i>このデータをExcelでダウンロード
        </button>
      </div>

      <div class="card mb-4" style="background-color: #e8f0f2;">
        <div class="flex items-center gap-2 mb-2">
          <i class="fa-solid fa-print text-xl" style="color: var(--export-color);"></i>
          <h3 class="font-bold" style="color: var(--export-color);">印刷機能</h3>
        </div>
        <p class="text-sm mb-3" style="color: var(--export-color); opacity: 0.8;">現在表示しているページをそのまま印刷できます。印刷時にはボタンや入力欄などが自動的に非表示になります。</p>
        <button onclick="window.print()" class="w-full py-3 px-6 rounded-lg font-bold transition-all shadow-md" style="background-color: var(--export-color); color: white;">
          <i class="fa-solid fa-print mr-2"></i>このページを印刷
        </button>
      </div>

      <button onclick="switchView('portalView')" class="btn-sub mt-8">
        <i class="fa-solid fa-home mr-2"></i>portalに戻る
      </button>
      </div>
    </div>

    <div id="versionView" class="view fullscreen-view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0" data-version="1.0.0">
      <!-- バージョン情報専用ヘッダー -->
      <header class="flex flex-col items-center justify-center py-4 relative">
        <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--version-color);"><i
            class="fa-solid fa-bars"></i></button>
        <i class="fa-solid fa-code-branch text-5xl" style="color: var(--version-color);"></i>
        <h1 class="text-xl font-bold" style="color: var(--version-color);">和農日向 機械管理アプリ</h1>
      </header>

      <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg" style="color: var(--version-color); border-bottom: 2px solid var(--version-color);">
        <i class="fa-solid fa-code-branch"></i> バージョン情報
      </div>

      <div class="card text-sm leading-relaxed space-y-3">
        <p><span class="font-bold">バージョン:</span> 1.0.0</p>
        <p><span class="font-bold">最終更新日:</span> 2026-01-19</p>

        <div>
          <p class="font-bold mb-1" style="color: var(--version-color);">更新内容</p>
          <ul class="list-disc pl-5 space-y-1">
            <li>初期リリース</li>
          </ul>
        </div>

        <div>
          <p class="font-bold mb-1" style="color: var(--version-color);">使用技術</p>
          <ul class="list-disc pl-5 space-y-1">
            <li>HTML / CSS / JavaScript</li>
            <li>Tailwind CSS</li>
            <li>Supabase</li>
            <li>Chart.js</li>
            <li>GitHub Pages</li>
          </ul>
        </div>
      </div>

      <button onclick="switchView('portalView')" class="btn-sub mt-6">portalに戻る</button>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const SUPABASE_URL = "https://txsqxnwgolybcdclazdx.supabase.co";
    const SUPABASE_KEY = "sb_publishable_8JEM6Yyg5_oQpF-grdaxIw_rrxZBQYj";
    const GOOGLE_VISION_API_KEY = 'AIzaSyCdX_rYEeovClhxRAwAOhPxG4CPTX6fqlg';
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let allMachines = []; let currentMachineId = 'all'; window.charts = {};

    window.drawCharts = function (data) {
      console.log("📊 全カラムのグラフを最適化します");
      if (typeof Chart === 'undefined') return;

      if (window.charts) {
        Object.values(window.charts).forEach(c => c && typeof c.destroy === 'function' && c.destroy());
      }
      window.charts = {};

      // データ集計
      const stats = { cat: {}, op: {}, task: {}, time: new Array(12).fill(0) };
      let totalH = 0;
      data.forEach(d => {
        const h = Math.max(0, (parseFloat(d.end_hour) || 0) - (parseFloat(d.start_hour) || 0));
        totalH += h;
        stats.cat[d.category || "その他"] = (stats.cat[d.category || "その他"] || 0) + h;
        stats.op[d.operator || "不明"] = (stats.op[d.operator || "不明"] || 0) + h;
        stats.task[d.task || "その他"] = (stats.task[d.task || "その他"] || 0) + h;
        if (d.date) {
          const m = new Date(d.date).getMonth();
          stats.time[m] += h;
        }
      });

      const colors = ['#6b8f71', '#9eb3a2', '#d1dbd3', '#3a4d3f', '#b5c9b8'];

      // --- 【左】上段：機械別修理コスト (金額順にソート & グラデーション) ---
      const ctxRepair = document.getElementById('categoryShareChart');
      if (ctxRepair) {
        // 1. データをオブジェクトの配列にする
        const rawData = [
          { label: 'SL54', value: 80000 },
          { label: 'YT333', value: 30000 },
          { label: 'TJV95', value: 7000 },
          { label: 'SL60', value: 20000 },
          { label: 'MZ70', value: 4000 }
        ];

        // 2. 金額が高い順に並べ替える (降順)
        rawData.sort((a, b) => b.value - a.value);

        // 3. グラフ用にラベルと数値を切り分ける
        const sortedLabels = rawData.map(d => d.label);
        const sortedValues = rawData.map(d => d.value);

        // 4. グラデーション色の計算
        const maxVal = sortedValues[0];
        const backgroundColors = sortedValues.map(val => {
          const opacity = 0.3 + (val / maxVal) * 0.7;
          return `rgba(139, 0, 0, ${opacity})`;
        });

        window.charts.c1 = new Chart(ctxRepair, {
          type: 'bar',
          data: {
            labels: sortedLabels,
            datasets: [{
              label: 'コスト',
              data: sortedValues,
              backgroundColor: backgroundColors,
              borderRadius: 4,
              barThickness: 15
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { display: false },
              y: {
                grid: { display: false },
                ticks: { font: { size: 11, weight: 'bold' } }
              }
            },
            plugins: { legend: { display: false } }
          }
        });
      }

      // --- 【左】下段：作物比率 (ドーナツ) ---
      const ctxCrop = document.getElementById('taskShareChart');
      if (ctxCrop) {
        window.charts.c2 = new Chart(ctxCrop, {
          type: 'doughnut',
          data: { labels: Object.keys(stats.cat), datasets: [{ data: Object.values(stats.cat), backgroundColor: colors }] },
          options: {
            cutout: '45%', // 🔥 70%→45%に下げることで「肉厚」なドーナツになります
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } }
          }
        });
      }

      // --- 【中央】上段：月別稼働推移 (以前の折れ線グラフ) ---
      const ctxLine = document.getElementById('detailChart');
      if (ctxLine) {
        window.charts.line = new Chart(ctxLine, {
          type: 'line',
          data: {
            labels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'],
            datasets: [{ label: 'h', data: stats.time, borderColor: '#6b8f71', backgroundColor: 'rgba(107,143,113,0.1)', fill: true, tension: 0.4 }]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
      }

      // --- 【中央】下段：作業内容分析 (グラデーション棒グラフ) ---
      const ctxBar = document.getElementById('gradientBarChart');
      if (ctxBar) {
        const sorted = Object.entries(stats.task).sort((a, b) => b[1] - a[1]);
        window.charts.bar = new Chart(ctxBar, {
          type: 'bar',
          data: {
            labels: sorted.map(t => t[0]),
            datasets: [{
              label: 'h',
              data: sorted.map(t => t[1]),
              backgroundColor: sorted.map((_, i) => `rgba(107, 143, 113, ${Math.max(0.2, 1 - (i / 5))})`),
              borderRadius: 4
            }]
          },
          options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
      }

      // --- 【右】上段：前年実績比 (半円ゲージ) ---
      const ctxGauge = document.getElementById('yearComparisonGauge');
      if (ctxGauge) {
        const ratio = Math.min(100, (totalH / 500) * 100);
        window.charts.gauge = new Chart(ctxGauge, {
          type: 'doughnut',
          data: { datasets: [{ data: [ratio, 100 - ratio], backgroundColor: ['#6b8f71', '#eee'], borderWidth: 0 }] },
          options: { rotation: -90, circumference: 180, cutout: '75%', maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
        const valEl = document.getElementById("detailCompareValue");
        if (valEl) valEl.innerText = ratio.toFixed(1) + "%";
      }

      // --- 【右】下段：担当者比率 (ドーナツ) ---
      const ctxOp = document.getElementById('operatorShareChart');
      if (ctxOp) {
        window.charts.c4 = new Chart(ctxOp, {
          type: 'doughnut',
          data: { labels: Object.keys(stats.op), datasets: [{ data: Object.values(stats.op), backgroundColor: colors }] },
          options: { cutout: '45%', responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } } }
        });
      }
    };

    function openMenu() {
      // 現在アクティブなビューに応じて適切なメニューを開く
      const tractorSection = document.querySelector('#tractor-section .view.active');
      const plantingSection = document.querySelector('#planting-section .view.active');
      const combineSection = document.querySelector('#combine-section .view.active');
      
      let menuId = 'sideMenu'; // デフォルトはグローバルメニュー
      
      if (tractorSection) {
        menuId = 'tractorSideMenu';
      } else if (plantingSection) {
        menuId = 'plantingSideMenu';
      } else if (combineSection) {
        menuId = 'combineSideMenu';
      }
      
      document.getElementById(menuId).style.left = "0px";
      document.getElementById("overlay").style.display = "block";
    }
    
    function closeMenu() {
      // PC表示でサイドバー常時表示モードの場合は閉じない
      const isDesktop = window.innerWidth >= 1024;
      const showSidebar = document.body.classList.contains('show-sidebar');
      
      if (isDesktop && showSidebar) {
        // PC表示時はオーバーレイだけ閉じる（サイドバーは閉じない）
        document.getElementById("overlay").style.display = "none";
        return;
      }
      
      // モバイル表示時は通常通りすべて閉じる
      document.getElementById("sideMenu").style.left = "-280px";
      document.getElementById("tractorSideMenu").style.left = "-280px";
      document.getElementById("plantingSideMenu").style.left = "-280px";
      document.getElementById("combineSideMenu").style.left = "-280px";
      document.getElementById("overlay").style.display = "none";
    }

    function showModal(title, message, onOk) {
      const modal = document.getElementById("customModal");
      document.getElementById("modalTitle").innerText = title;
      document.getElementById("modalMessage").innerText = message;
      const okBtn = document.getElementById("modalOkBtn");
      okBtn.onclick = () => { closeModal(); if (onOk) onOk(); };
      modal.classList.add("active");
    }
    function closeModal() { document.getElementById("customModal").classList.remove("active"); }

    function switchView(id) {
      console.log("Switching to:", id);

      // 全てのビューからactiveを取り除く
      document.querySelectorAll('.view').forEach(v => {
        v.classList.remove('active');
        v.style.display = 'none';
      });

      // 対象のビューを取得
      const targetView = document.getElementById(id);
      if (targetView) {
        targetView.classList.add('active');
        targetView.style.display = 'block';
        
        // サイドバーを表示しないページのリスト
        const noSidebarPages = ['portalView', 'dashboard', 'dashboardPlanting', 'dashboardCombine'];
        
        // サイドバー表示の制御
        if (noSidebarPages.includes(id)) {
          document.body.classList.remove('show-sidebar');
          document.body.classList.add('fullscreen-mode');
          // 全てのサイドメニューを閉じる
          document.querySelectorAll('.sideMenu, #sideMenu, #tractorSideMenu, #plantingSideMenu, #combineSideMenu, #exportSideMenu, #maintenanceSideMenu, #versionSideMenu').forEach(menu => {
            menu.style.left = '-280px';
          });
        } else {
          document.body.classList.add('show-sidebar');
          document.body.classList.remove('fullscreen-mode');
        }
        
        // 適切なサイドメニューにactive-menuクラスを付与（ビューIDベース）
        const tractorViews = ['tractorView', 'todayView', 'historyView'];
        const plantingViews = ['plantingView', 'todayViewPlanting', 'historyViewPlanting', 'maintenanceMachineListViewPlanting', 'maintenanceDetailViewPlanting'];
        const combineViews = ['combineView', 'todayViewCombine', 'historyViewCombine', 'maintenanceMachineListViewCombine', 'maintenanceDetailViewCombine'];
        const exportViews = ['exportView'];
        const maintenanceViews = ['maintenanceMachineListView', 'maintenanceDetailView'];
        const versionViews = ['versionView'];
        const repairViews = ['repairView', 'invoiceOCRView'];
        const dashboardViews = ['dashboard', 'dashboardPlanting', 'dashboardCombine'];
        
        // body背景色を変更
        if (tractorViews.includes(id) || dashboardViews.includes(id)) {
          document.body.style.backgroundColor = '#e2e8e3';
        } else if (plantingViews.includes(id)) {
          document.body.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--planting-bg');
        } else if (combineViews.includes(id)) {
          document.body.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--combine-bg');
        } else if (maintenanceViews.includes(id)) {
          document.body.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--maintenance-bg');
        } else if (repairViews.includes(id)) {
          document.body.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--repair-bg');
        } else if (exportViews.includes(id)) {
          document.body.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--export-bg');
        } else if (versionViews.includes(id)) {
          document.body.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--version-bg');
        } else if (id === 'portalView') {
          document.body.style.backgroundColor = '#faf9f6';
        }
        
        // 全てのメニューからactive-menuクラスを削除
        document.getElementById("sideMenu").classList.remove('active-menu');
        document.getElementById("tractorSideMenu").classList.remove('active-menu');
        document.getElementById("plantingSideMenu").classList.remove('active-menu');
        document.getElementById("combineSideMenu").classList.remove('active-menu');
        document.getElementById("exportSideMenu").classList.remove('active-menu');
        document.getElementById("maintenanceSideMenu").classList.remove('active-menu');
        document.getElementById("versionSideMenu").classList.remove('active-menu');
        
        // 適切なメニューにactive-menuクラスを追加
        let activeMenuId = 'sideMenu';
        if (tractorViews.includes(id)) {
          activeMenuId = 'tractorSideMenu';
          document.getElementById("tractorSideMenu").classList.add('active-menu');
        } else if (plantingViews.includes(id)) {
          activeMenuId = 'plantingSideMenu';
          document.getElementById("plantingSideMenu").classList.add('active-menu');
        } else if (combineViews.includes(id)) {
          activeMenuId = 'combineSideMenu';
          document.getElementById("combineSideMenu").classList.add('active-menu');
        } else if (exportViews.includes(id)) {
          activeMenuId = 'exportSideMenu';
          document.getElementById("exportSideMenu").classList.add('active-menu');
        } else if (maintenanceViews.includes(id)) {
          activeMenuId = 'maintenanceSideMenu';
          document.getElementById("maintenanceSideMenu").classList.add('active-menu');
        } else if (versionViews.includes(id)) {
          activeMenuId = 'versionSideMenu';
          document.getElementById("versionSideMenu").classList.add('active-menu');
        } else {
          document.getElementById("sideMenu").classList.add('active-menu');
        }
        
        // PC表示でサイドバー表示モードの場合、アクティブメニューを明示的に開く
        const isDesktop = window.innerWidth >= 1024;
        if (isDesktop && !noSidebarPages.includes(id)) {
          document.getElementById(activeMenuId).style.left = "0px";
        }
        
        // バージョン情報ページを開いたら通知バッジを消す
        if (id === 'versionView') {
          const currentVersion = targetView.dataset.version || '1.0.0';
          localStorage.setItem('lastViewedVersion', currentVersion);
          checkVersionUpdate();
        }
        
        // portalページ表示時に通知バッジをチェック
        if (id === 'portalView') {
          checkVersionUpdate();
        }
      } else {
        console.error("エラー: ID '" + id + "' のビューが見つかりません。");
      }

      // ヘッダーの制御（portalView, dashboard, dashboardPlanting, versionView では非表示）
      const header = document.getElementById("pageHeader");
      if (header) {
        header.style.display = (id === 'dashboard' || id === 'dashboardPlanting' || id === 'portalView' || id === 'versionView') ? 'none' : 'flex';
      }

      closeMenu();

      // 各ページごとの読み込み処理
      if (id === 'dashboard') {
        setTimeout(() => renderDashboard('all'), 100);
      }
      if (id === 'dashboardPlanting') {
        setTimeout(() => renderDashboardPlanting('all'), 100);
      }
      if (id === 'todayView') {
        console.log("本日ログ読込実行");
        loadLogs("todayLogList", true);
      }
      if (id === 'historyView') {
        console.log("履歴ログ読込実行");
        loadLogs("historyLogList", false);
      }
      if (id === 'todayViewPlanting') {
        console.log("田植え機 本日ログ読込実行");
        loadLogsPlanting("todayLogListPlanting", true);
      }
      if (id === 'historyViewPlanting') {
        console.log("田植え機 履歴ログ読込実行");
        loadLogsPlanting("historyLogListPlanting", false);
      }
      if (id === 'todayViewCombine') {
        console.log("コンバイン 本日ログ読込実行");
        loadLogsCombine("todayLogListCombine", true);
      }
      if (id === 'historyViewCombine') {
        console.log("コンバイン 履歴ログ読込実行");
        loadLogsCombine("historyLogListCombine", false);
      }
      if (id === 'repairView') {
        loadRepairDashboard();
      }
      if (id === 'repairViewPlanting') {
        loadRepairDashboardPlanting();
      }
      if (id === 'maintenanceMachineListView') {
        loadMachineList();
      }
      if (id === 'maintenanceView') {
        console.log("メンテナンス状態を復元中...");
        restoreMaintenanceChecks();
      }
      if (id === 'maintenanceMachineListViewPlanting') {
        loadMachineListPlanting();
      }
      if (id === 'maintenanceMachineListViewCombine') {
        if (typeof loadMachineListCombine === 'function') {
          loadMachineListCombine();
        }
      }
      if (id === 'maintenanceDetailViewPlanting') {
        console.log("田植え機メンテナンス状態を復元中...");
        restoreMaintenanceChecksPlanting();
      }
      if (id === 'exportView') {
        initExportPage();
      }
    }
    
    // バージョン更新チェック
    function checkVersionUpdate() {
      const versionView = document.getElementById('versionView');
      const currentVersion = versionView ? versionView.dataset.version || '1.0.0' : '1.0.0';
      const lastViewedVersion = localStorage.getItem('lastViewedVersion') || '0.0.0';
      const badge = document.getElementById('versionBadge');
      
      if (badge) {
        if (currentVersion !== lastViewedVersion) {
          badge.classList.add('show');
        } else {
          badge.classList.remove('show');
        }
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      // 1. 機械（トラクターのみ）の取得
      const { data: machines } = await client
        .from("machines")
        .select("*")
        .eq("machine_type", "tractor")
        .order("name");

      allMachines = machines || [];

      // 2. オペレーターの取得
      const { data: operators } = await client
        .from("operators")
        .select("*")
        .order("id");

      // 3. 作業内容の取得
      const { data: workTypes } = await client
        .from("work_types")
        .select("*")
        .order("id");

      // --- 各画面要素への反映 ---

      // 入力フォームの機械選択
      const machineSelect = document.getElementById("machineSelect");
      if (machineSelect) {
        machineSelect.innerHTML = '<option value="">選択</option>' +
          allMachines.map(m => `<option value="${m.id}">${m.name}</option>`).join("");
      }

      // 検索条件の機械選択
      const filterMachine = document.getElementById("filterMachine");
      if (filterMachine) {
        filterMachine.innerHTML = '<option value="">すべての機械</option>' +
          allMachines.map(m => `<option value="${m.id}">${m.name}</option>`).join("");
      }

      // 4. オペレーター選択の反映
      const operatorSelect = document.getElementById("operatorSelect");
      if (operatorSelect) {
        operatorSelect.innerHTML = '<option value="">選択</option>' +
          (operators || []).map(o => `<option value="${o.name}">${o.name}</option>`).join("");
      }

      // 5. 作業種別選択の反映
      const workTypeSelect = document.getElementById("workTypeSelect");
      if (workTypeSelect) {
        workTypeSelect.innerHTML = '<option value="">選択</option>' +
          (workTypes || []).map(w => `<option value="${w.name}">${w.name}</option>`).join("");
      }

      // 最後に、ダッシュボードを表示する（ダッシュボード画面にいる場合のみ）
      if (typeof renderDashboard === 'function') {
        renderDashboard('all');
      }

      // ダッシュボードの機械別タブ
      const machineTabs = document.getElementById("machineTabs");
      if (machineTabs) {
        // 今選ばれているIDを確実に取得（関数の引数 machineId を使用）
        const currentId = 'all';

        // 1. 「全体」ボタン
        const allBtnClass = (currentId === 'all') ? 'active' : 'inactive';
        let tabsHTML = `
          <button onclick="renderDashboard('all')" 
                  id="tab-all" 
                  class="tab-btn ${allBtnClass}" 
                  style="min-width: 80px; letter-spacing: 0.2em;">全 体</button>
        `;

        // 2. 各機械のボタン（allMachines.map）
        if (typeof allMachines !== 'undefined' && allMachines.length > 0) {
          tabsHTML += allMachines.map(m => {
            // IDを比較して active か inactive か決める
            const isActive = (String(m.id) === String(currentId)) ? 'active' : 'inactive';
            return `
              <button onclick="renderDashboard(${m.id})" 
                      id="tab-${m.id}" 
                      class="tab-btn ${isActive}">${m.name}</button>
            `;
          }).join("");
        }

        machineTabs.innerHTML = tabsHTML;
      }

      // オペレーター選択の反映（検索と入力両方）
      if (operators) {
        const opList = operators.map(o => `<option value="${o.name}">${o.name}</option>`).join("");
        const fOp = document.getElementById("filterOperator");
        if (fOp) fOp.innerHTML = '<option value="">全オペレーター</option>' + opList;

        const iOp = document.getElementById("operator");
        if (iOp) iOp.innerHTML = '<option value="">選択してください</option>' + opList;
      }

      // 作業内容の反映（連動ロジック含む）
      if (workTypes) {
        // 検索条件側
        const fCat = document.getElementById("filterCategory");
        if (fCat) {
          fCat.innerHTML = '<option value="">全作業内容</option>' +
            workTypes.map(w => `<option value="${w.work_name || w.category}">${w.work_name || w.category}</option>`).join("");
        }

        // 入力フォーム側（種別）
        const iCat = document.getElementById("category");
        if (iCat) {
          const categories = [...new Set(workTypes.map(w => w.category))];
          iCat.innerHTML = '<option value="">種別を選択</option>' +
            categories.map(c => `<option value="${c}">${c}</option>`).join("");

          // 種別を選んだら作業内容を出す連動設定
          iCat.onchange = () => {
            const selected = iCat.value;
            const iWork = document.getElementById("work_name");
            if (iWork) {
              const filtered = workTypes.filter(t => t.category === selected);
              iWork.innerHTML = '<option value="">作業内容を選択</option>' +
                filtered.map(t => `<option value="${t.work_name}">${t.work_name}</option>`).join("");
            }
          };
        }
      }

      // 日付の初期
      const today = new Date().toISOString().split('T')[0];
      if (document.getElementById("workDate")) {
        document.getElementById("workDate").value = today;
      }
      if (document.getElementById("taue_workDate")) {
        document.getElementById("taue_workDate").value = today;
      }
      if (document.getElementById("combine_workDate")) {
        document.getElementById("combine_workDate").value = today;
      }
      if (document.getElementById("filterMonth")) {
        document.getElementById("filterMonth").value = today.substring(0, 7);
      }

      // 油種の取得と設定（トラクター用）
      const { data: fuelTypes } = await client.from("fuel_types").select("*");
      const fuelTypeSelect = document.getElementById("fuelType");
      if (fuelTypeSelect && fuelTypes) {
        fuelTypeSelect.innerHTML = '<option value="">選択</option>' +
          fuelTypes.map(f => `<option value="${f.id}">${f.name}</option>`).join("");
      }

      // 安全のため、機械選択に change リスナを確実に追加
      const msEl = document.getElementById('machineSelect');
      if (msEl && !msEl.onchange) msEl.addEventListener('change', autoFillHour);

      // 田植え機用の初期化
      await initTauePage();

      // コンバイン用の初期化
      await initCombinePage();

      console.log("全データの初期化と日付セットが完了しました");
    });

    // 修理履歴ダッシュボードを読み込む
    async function loadRepairDashboard() {
      try {
        // repair_logs をすべて取得
        const { data: logs, error } = await client
          .from('repair_logs')
          .select('*')
          .order('date', { ascending: false });

        if (error) {
          console.error('Error loading repair logs:', error);
          return;
        }

        // -----------------------------
        // ① 累計修理費
        // -----------------------------
        const totalCost = logs.reduce((sum, log) => sum + (log.cost || 0), 0);
        document.getElementById('totalRepairCost').textContent =
          '¥ ' + totalCost.toLocaleString();

        // -----------------------------
        // ② 年ごとの修理費
        // -----------------------------
        const yearly = {};
        logs.forEach(log => {
          const year = new Date(log.date).getFullYear();
          if (!yearly[year]) yearly[year] = 0;
          yearly[year] += log.cost || 0;
        });

        const yearlyContainer = document.getElementById('yearlyRepairContainer');
        yearlyContainer.innerHTML = '';

        Object.keys(yearly)
          .sort((a, b) => b - a)
          .forEach(year => {
            const card = document.createElement('div');
            card.className =
              'p-3 bg-white rounded-md shadow text-center border border-gray-100';
            card.innerHTML = `
          <div class="text-sm text-gray-500">${year}年</div>
          <div class="text-lg font-bold text-[#6b8f71]">¥ ${yearly[year].toLocaleString()}</div>
        `;
            yearlyContainer.appendChild(card);
          });

        // -----------------------------
        // ③ 機械ごとの修理費
        // -----------------------------
        const machineTotals = {};

        logs.forEach(log => {
          if (!machineTotals[log.machine_id]) machineTotals[log.machine_id] = 0;
          machineTotals[log.machine_id] += log.cost || 0;
        });

        // machines テーブルから名前を取得
        const { data: machines } = await client.from('machines').select('*');

        const machineContainer = document.getElementById('machineRepairContainer');
        machineContainer.innerHTML = '';

        Object.keys(machineTotals).forEach(machineId => {
          const machine = machines.find(m => m.id === Number(machineId));
          const name = machine ? machine.name : '不明な機械';

          const card = document.createElement('div');
          card.className =
            'p-3 bg-white rounded-md shadow text-center border border-gray-100';
          card.innerHTML = `
        <div class="text-sm text-gray-500">${name}</div>
        <div class="text-lg font-bold text-[#6b8f71]">¥ ${machineTotals[machineId].toLocaleString()}</div>
      `;
          machineContainer.appendChild(card);
        });

        // -----------------------------
        // ④ 最近の修理履歴（最新5件）
        // -----------------------------
        const recentContainer = document.getElementById('recentRepairContainer');
        recentContainer.innerHTML = '';

        logs.slice(0, 5).forEach(log => {
          const item = document.createElement('div');
          item.className =
            'p-3 bg-white rounded-md shadow border border-gray-100';

          item.innerHTML = `
        <div class="text-sm text-gray-500">${log.date}</div>
        <div class="font-bold">${log.memo || '(内容なし)'}</div>
        <div class="text-[#6b8f71] font-bold mt-1">¥ ${log.cost.toLocaleString()}</div>
        <div class="text-xs text-gray-400 mt-1">${log.shop || ''}</div>
      `;

          recentContainer.appendChild(item);
        });

      } catch (err) {
        console.error('Unexpected error:', err);
      }
    }

    async function autoFillHour() {
      const mId = document.getElementById("machineSelect").value;
      if (!mId) return;
      const { data } = await client.from("hour_logs").select("end_hour").eq("machine_id", mId).order("date", { ascending: false }).order("created_at", { ascending: false }).limit(1);
      if (data && data.length > 0) { document.getElementById("hourBefore").value = data[0].end_hour; calcDiff(); }
    }

    function calcDiff() {
      const b = parseFloat(document.getElementById("hourBefore").value) || 0;
      const a = parseFloat(document.getElementById("hourAfter").value) || 0;
      const d = a - b;
      const disp = document.getElementById("hourDiffDisplay");

      // ① 稼働後のほうが小さい場合に文字を赤くするロジック
      if (a > 0 && a < b) {
        disp.classList.remove("text-[#6b8f71]");
        disp.classList.add("text-red-500");
        disp.textContent = `稼働時間: 0.0 h (入力エラー)`;
      } else {
        disp.classList.remove("text-red-500");
        disp.classList.add("text-[#6b8f71]");
        disp.textContent = `稼働時間: ${d > 0 ? d.toFixed(1) : "0.0"} h`;
      }
    }

    async function previewInvoice(input) {
      const file = input.files[0];
      if (!file) return;

      const previewImg = document.getElementById('invoicePreviewImg');
      const previewArea = document.getElementById('invoicePreviewArea');
      const saveBtn = document.getElementById('saveRepairBtn');

      // プレビュー表示
      previewImg.src = URL.createObjectURL(file);
      previewArea.classList.remove('hidden');

      const memoField = document.getElementById('repairMemo');
      memoField.value = "📄 Google AIが解析中... ⏳";
      if (saveBtn) saveBtn.disabled = true; // 解析中は二重押し防止で無効化

      try {
        const base64Image = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.readAsDataURL(file);
        });

        const url = `https://vision.googleapis.com/v1/images:annotate?key=${GOOGLE_VISION_API_KEY}`;
        const response = await fetch(url, {
          method: "POST",
          body: JSON.stringify({
            requests: [{ image: { content: base64Image }, features: [{ type: "TEXT_DETECTION" }] }]
          })
        });
        const result = await response.json();

        const fullText = result.responses[0]?.textAnnotations[0]?.description || "";

        // --- 抽出処理 ---
        const cleanText = fullText.replace(/\s/g, '');
        const costMatch = cleanText.match(/(?:金額|合計|税込|￥|¥|請求額)[:：]?([0-9,]{3,})/);
        if (costMatch) document.getElementById('repairCost').value = costMatch[1].replace(/,/g, '');

        const dateMatch = cleanText.match(/(\d{4})[年\/-](\d{1,2})[月\/-](\d{1,2})/);
        if (dateMatch) {
          document.getElementById('repairDate').value = `${dateMatch[1]}-${dateMatch[2].padStart(2, '0')}-${dateMatch[3].padStart(2, '0')}`;
        }

        // ✨ 解析が終わったらプレビューを消す
        previewArea.classList.add('hidden');
        previewImg.src = "";
        memoField.value = "解析完了: " + fullText.substring(0, 50) + "..."; // 冒頭だけメモに残す

        showModal("解析完了", "内容を確認して保存してください。");

      } catch (error) {
        console.error("OCR Error:", error);
        memoField.value = "❌ 解析エラー";
      } finally {
        if (saveBtn) saveBtn.disabled = false; // エラーでも成功でもボタンを復活させる
      }
    }

    async function populateMachineSelect() {
      const { data: machines } = await client
        .from('machines')
        .select('*')
        .order('name');

      // 全機械を保存（フィルタリング用）
      window.allMachinesForRepair = machines || [];

      // 種別セレクトボックスを設定
      const typeSelect = document.getElementById('repairMachineType');
      if (typeSelect && machines) {
        const uniqueTypes = [...new Set(machines.map(m => m.machine_type))].filter(Boolean);
        typeSelect.innerHTML = '<option value="">選択してください</option>';
        uniqueTypes.forEach(type => {
          const opt = document.createElement('option');
          opt.value = type;
          opt.textContent = type === 'tractor' ? 'トラクター' : type === 'transplanter' ? '田植え機' : type;
          typeSelect.appendChild(opt);
        });
      }

      // 機械セレクトボックスは初期状態では空
      const select = document.getElementById('repairMachineSelect');
      if (select) {
        select.innerHTML = '<option value="">まず種別を選択してください</option>';
      }
    }

    function filterMachinesByType() {
      const typeSelect = document.getElementById('repairMachineType');
      const machineSelect = document.getElementById('repairMachineSelect');
      const selectedType = typeSelect.value;

      if (!machineSelect || !window.allMachinesForRepair) return;

      machineSelect.innerHTML = '<option value="">選択してください</option>';

      if (!selectedType) {
        machineSelect.innerHTML = '<option value="">まず種別を選択してください</option>';
        return;
      }

      const filteredMachines = window.allMachinesForRepair.filter(m => m.machine_type === selectedType);

      if (filteredMachines.length > 0) {
        filteredMachines.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.id;
          opt.textContent = m.name;
          machineSelect.appendChild(opt);
        });
      } else {
        const opt = document.createElement('option');
        opt.textContent = `${selectedType}が登録されていません`;
        machineSelect.appendChild(opt);
      }
    }

    async function saveRepairLog() {
      console.log("保存処理を開始します...");

      // 1. 画面から入力値を取得
      const dateValue = document.getElementById('repairDate').value;
      const shopValue = document.getElementById('repairShop').value;
      const costValue = document.getElementById('repairCost').value;
      const memoValue = document.getElementById('repairMemo').value;
      const machineId = document.getElementById('repairMachineSelect').value;

      // 2. 必須チェック
      if (!dateValue || !costValue) {
        showModal("入力エラー", "「修理日」と「金額」を入力してください。");
        return;
      }

      const btn = document.getElementById('saveRepairBtn');
      btn.disabled = true;
      btn.innerText = "保存中...";

      try {
        // 3. Supabaseへ保存
        const { error } = await client
          .from('repair_logs')
          .insert([
            {
              date: dateValue,
              shop: shopValue,
              cost: parseInt(costValue),
              memo: memoValue,
              machine_id: machineId || null // IDが空でも保存できるようにする
            }
          ]);

        if (error) throw error;

        // --- ここをオシャレに書き換え ---
        btn.innerText = "保存完了！";

        // 1. 成功したらダッシュボードの数字を再計算
        loadRepairDashboard();

        // 2. モーダルで通知（もしモーダルが動くなら）
        if (typeof showCustomModal === 'function') {
          showCustomModal("保存完了", "修理履歴を記録しました。ダッシュボードを更新します。");
        } else {
          showModal("保存完了", "保存完了しました！🚜🌾");
        }

        // 3. 自動的に履歴トップ画面に戻す
        setTimeout(() => {
          switchView('repairView');
          btn.disabled = false;
          btn.innerText = "修理履歴を保存";
        }, 1500);

      } catch (err) {
        console.error("❌ 保存に失敗しました:", err);
        showModal("保存エラー", "エラーで保存できませんでした: " + err.message);
        btn.disabled = false;
        btn.innerText = "修理履歴を保存";
      }
    }

    function prepareMachineSelect() {
      const select = document.getElementById('repairMachineSelect');
      if (!select) return;

      select.innerHTML = '';

      if (allMachines && allMachines.length > 0) {
        allMachines.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.id;
          opt.textContent = m.name;
          select.appendChild(opt);
        });
      } else {
        const opt = document.createElement('option');
        opt.textContent = "機械が登録されていません";
        select.appendChild(opt);
      }
    }

    function goToRepairRegistration() {
      prepareMachineSelect(); // リストを作成
      switchView('invoiceOCRView'); // 画面を切り替え
    }

    async function loadLogs(elId, todayOnly) {
      const list = document.getElementById(elId);
      list.innerHTML = "<p class='text-center py-10 opacity-50 text-xs'>読込中...</p>";

      // 基本のクエリ作成
      let query = client.from("hour_logs").select("*, machines(name)").order("date", { ascending: false });

      if (todayOnly) {
        // 【本日の稼働状況】日本時間（JST）の今日の日付で絞り込み
        const jstToday = new Date().toLocaleDateString('sv-SE');
        query = query.eq("date", jstToday);
      } else {

        // 【稼働履歴】画面の入力値を取得してフィルターをかける
        const month = document.getElementById("filterMonth").value; // YYYY-MM
        const machine = document.getElementById("filterMachine").value;
        const operator = document.getElementById("filterOperator").value;
        const category = document.getElementById("filterCategory").value;

        // 月で絞り込み (前方一致)
        if (month) query = query.gte("date", `${month}-01`).lte("date", `${month}-31`);
        // 機械で絞り込み
        if (machine) query = query.eq("machine_id", machine);
        // オペレーターで絞り込み
        if (operator) query = query.eq("operator", operator);
        // 種別（水稲・そば等）で絞り込み
        if (category) query = query.eq("category", category);
      }

      const { data, error } = await query;
      if (error) {
        console.error("データ取得エラー:", error);
        return;
      }

      let total = 0;
      const displayData = todayOnly ? [...(data || [])].reverse() : (data || []);

      list.innerHTML = displayData.map(l => {
        const diff = (l.end_hour - l.start_hour);
        total += diff;
        return `<div class="card border-l-4 border-[#6b8f71] !mb-3 !py-3 flex justify-between items-center">
              <div>
                <b class="text-sm">${l.date} - ${l.machines?.name}</b>
                <p class="text-xs opacity-70 mt-1">${l.operator} | ${l.task}</p>
                <div class="flex gap-4 mt-2">
                  <span class="text-[11px] font-bold log-badge px-2 py-1 rounded"><i class="fa-solid fa-clock mr-1 text-[#6b8f71]"></i>${diff.toFixed(1)} h</span>
                  <span class="text-[11px] font-bold log-badge px-2 py-1 rounded"><i class="fa-solid fa-gas-pump mr-1 text-[#6b8f71]"></i>${l.fuel_amount || 0} L</span>
                </div>
              </div>
              <button onclick="deleteLog(${l.id})" class="text-gray-400 p-2 hover:text-red-500 transition-colors">
                <i class="fa-regular fa-trash-can text-lg"></i>
              </button>
            </div>`;
      }).join("");

      if (!todayOnly) {
        const totalEl = document.getElementById("historyTotalHours");
        if (totalEl) totalEl.innerText = `合計: ${total.toFixed(1)} h`;
      }
    }

    async function deleteLog(id) {
      showModal("削除確認", "このログを削除しますか？", async () => {
        const { error } = await client.from("hour_logs").delete().eq("id", id);
        if (!error) {
          if (document.getElementById("todayView").classList.contains("active")) loadLogs("todayLogList", true);
          else loadLogs("historyLogList", false);
        }
      });
    }

    // メンテナンス履歴をDBから取得して表示する関数
    async function loadMaintenanceLogs() {
      const logContainer = document.getElementById('maintenanceLog');
      if (!logContainer) return;

      try {
        // 1. 最新のメンテナンス履歴を5件ほど取得
        const { data: logs, error } = await client
          .from('maintenance_status') // メンテナンス状態テーブル
          .select('item_id, updated_at, status')
          .eq('status', true)        // 完了したものだけ
          .order('updated_at', { ascending: false }) // 新しい順
          .limit(5);
        if (error) throw error;

        if (logs && logs.length > 0) {
          logContainer.innerHTML = logs.map(log => {
            // item_id が "tractor1_oil" のような形式だと仮定して整形
            const [machine, item] = log.item_id.split('_');
            const date = new Date(log.updated_at).toLocaleDateString('ja-JP', {
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit'
            });

            return `
          <div class="flex flex-col border-b border-gray-50 pb-1 mb-1 last:border-0">
            <div class="flex justify-between items-center">
              <span class="font-bold text-gray-700">${machine.toUpperCase()}</span>
              <span class="text-[9px] text-gray-400">${date}</span>
            </div>
            <div class="text-[#6b8f71] flex items-center gap-1">
              <i class="fa-solid fa-check-circle"></i> ${item} 完了
            </div>
          </div>
        `;
          }).join('');
        } else {
          logContainer.innerHTML = `<p class="italic text-gray-400 text-center py-4">直近の整備履歴はありません</p>`;
        }
      } catch (err) {
        console.error('履歴取得エラー:', err);
        logContainer.innerHTML = `<p class="text-red-400 text-center py-4">データ取得失敗</p>`;
      }
    }

    loadMaintenanceLogs();

    // 1. メンテナンス一覧（トラクター一覧）を表示する
    async function loadMachineList() {
      try {
        const { data: machines, error } = await client
          .from("machines")
          .select("*")
          .eq("machine_type", "tractor")
          .order("id");

        if (error) throw error;

        const container = document.getElementById("maintenanceMachineGrid");
        if (!container) return;
        container.innerHTML = "";

        const grouped = {};
        machines.forEach(m => {
          const manufacturer = m.manufacturer || "その他";
          if (!grouped[manufacturer]) grouped[manufacturer] = [];
          grouped[manufacturer].push(m);
        });

        for (const brand of Object.keys(grouped)) {
          const brandHeader = document.createElement("h3");
          brandHeader.className = "text-[#6b8f71] font-bold text-sm mb-2 mt-4 flex items-center gap-2";
          brandHeader.innerHTML = `<i class="fa-solid fa-tag opacity-50"></i> ${brand}`;
          container.appendChild(brandHeader);

          const grid = document.createElement("div");
          grid.className = "grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-4";

          // 各マシンのカードを作成
          for (const m of grouped[brand]) {
            const card = document.createElement("div");
            card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-all active:scale-95";
            card.onclick = () => openMaintenanceDetail(m.id);

            card.innerHTML = `
              <div class="flex flex-col gap-2">
                <div class="flex items-center gap-3">
                  <div style="color: var(--tractor-color);" class="text-xl flex-shrink-0">
                    <i class="fa-solid fa-tractor"></i>
                  </div>
                  <div class="font-bold text-gray-900 text-lg truncate">${m.name}</div>
                </div>
                <div class="border-t border-gray-50 pt-2" id="card-progress-${m.id}">
                  <div class="text-[11px] text-gray-400 flex items-center gap-1">
                    <i class="fa-solid fa-circle-notch fa-spin text-[9px]"></i> 確認中...
                  </div>
                </div>
              </div>
            `;
            grid.appendChild(card);

            // 進捗状況を非同期で取得して反映
            (async () => {
              try {
                const { data: checks } = await client
                  .from('maintenance_status')
                  .select('item_id, status')
                  .filter('item_id', 'ilike', `${m.id}_%`);

                const totalItems = 20;
                const uniqueChecks = {};
                if (checks) {
                  checks.forEach(c => { uniqueChecks[c.item_id] = c.status; });
                }

                const completedCount = Object.values(uniqueChecks).filter(status => status === true || status === "true").length;
                let percent = Math.round((completedCount / totalItems) * 100);
                percent = Math.min(100, percent);

                const progressDiv = document.getElementById(`card-progress-${m.id}`);
                if (progressDiv) {
                  let statusHTML = percent === 0
                    ? `<span class="text-red-600 font-black"><i class="fa-solid fa-circle-exclamation text-[9px]"></i> 未着手</span>`
                    : percent === 100
                      ? `<span class="text-[#6b8f71] font-black"><i class="fa-solid fa-circle-check text-[9px]"></i> 完了</span>`
                      : `<span class="text-orange-500 font-black"><i class="fa-solid fa-spinner text-[9px]"></i> ${percent}% 完了</span>`;

                  progressDiv.innerHTML = `
                    <div class="text-[11px] flex items-center gap-1">${statusHTML}</div>
                    <div class="w-full bg-gray-100 rounded-full h-1 mt-1">
                      <div class="bg-[#6b8f71] h-1 rounded-full transition-all duration-500" style="width: ${percent}%"></div>
                    </div>
                  `;
                }
              } catch (err) { console.error("カード進捗更新エラー:", err); }
            })();
          }
          container.appendChild(grid);
        }
      } catch (e) { console.error("一覧読み込みエラー:", e); }
    }
    async function loadMaintenanceLogs() {
      const logContainer = document.getElementById('maintenanceLog');
      if (!logContainer) return;

      try {
        // 1. 全てのメンテナンス状態を取得
        const { data: allStatus, error: statusError } = await client
          .from('maintenance_status')
          .select('item_id, status, updated_at');

        if (statusError) throw statusError;

        // 2. 機械ごとに「全項目数」と「完了数」をカウント
        const machineProgress = {};
        allStatus.forEach(item => {
          const mId = item.item_id.split('_')[0];
          if (!machineProgress[mId]) {
            machineProgress[mId] = { total: 0, completed: 0, lastUpdate: item.updated_at };
          }
          machineProgress[mId].total++;
          if (item.status) {
            machineProgress[mId].completed++;
            // 一番新しい完了日時を保持
            if (new Date(item.updated_at) > new Date(machineProgress[mId].lastUpdate)) {
              machineProgress[mId].lastUpdate = item.updated_at;
            }
          }
        });

        // 3. 判定ロジック
        const finishedMachineIds = Object.keys(machineProgress).filter(mId => {
          const p = machineProgress[mId];
          // 1つ以上項目があり、かつ（完了数 ＝ 項目数）であること
          // かつ、特定の「少なすぎるデータ（テスト用）」を除外するために 3項目以上 とする
          return p.total >= 3 && p.completed === p.total;
        });

        // 4. 機械名を取得
        const { data: machines, error: mError } = await client
          .from('machines')
          .select('id, name')
          .in('id', finishedMachineIds);

        if (mError) throw mError;

        const machineMap = {};
        machines.forEach(m => { machineMap[m.id.toString()] = m.name; });

        // 5. 完了した機械を最新順に並べて表示
        const displayData = finishedMachineIds
          .map(mId => ({
            id: mId,
            name: machineMap[mId] || `機械(ID:${mId})`,
            date: machineProgress[mId].lastUpdate
          }))
          .sort((a, b) => new Date(b.date) - new Date(a.date));

        logContainer.innerHTML = displayData.map(data => {
          const date = new Date(data.date);
          const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;

          return `
        <div class="flex items-center justify-between border-b border-gray-50 py-3 last:border-0">
          <div class="flex flex-col">
            <span class="text-[13px] font-black text-gray-800">${data.name}</span>
            <div class="flex items-center gap-1">
              <span class="w-2 h-2 rounded-full bg-[#6b8f71] flex items-center justify-center">
                <i class="fa-solid fa-check text-[5px] text-white"></i>
              </span>
              <span class="text-[10px] text-[#6b8f71] font-bold tracking-wider">ALL MAINTENANCE COMPLETE</span>
            </div>
          </div>
          <div class="text-right">
            <div class="text-[11px] text-gray-500 font-mono font-bold">${dateStr}</div>
          </div>
        </div>
      `;
        }).join('');

      } catch (err) {
        console.error('履歴取得エラー:', err);
      }
    }

    // 2. 詳細画面を開く
    async function openMaintenanceDetail(machineId) {
      window.currentMachineId = machineId;
      switchView('maintenanceDetailView');

      try {
        const { data: machine } = await client.from("machines").select("*").eq("id", machineId).single();
        document.getElementById("maintenanceMachineName").textContent = machine.name;

        const { data: operators } = await client.from('operators').select('name').order('id');
        const opSelect = document.getElementById('newMaintenanceOperator');
        if (opSelect && operators) {
          opSelect.innerHTML = '<option value="">担当者を選択</option>';
          operators.forEach(op => {
            const opt = document.createElement('option');
            opt.value = op.name; opt.textContent = op.name;
            opSelect.appendChild(opt);
          });
        }

        loadMaintenanceHistory(machineId);
        const { data: items } = await client.from("maintenance_items_tractor").select("*").order("id");
        const checklistContainer = document.getElementById("maintenanceChecklist");
        if (checklistContainer && items) {
          checklistContainer.innerHTML = "";
          items.forEach(item => {
            const uniqueId = `${machineId}_${item.id}`;
            const div = document.createElement("div");
            div.className = "flex items-center justify-between p-3 border-b border-gray-50 last:border-0 hover:bg-gray-50 transition-colors";
            div.innerHTML = `
              <div class="flex flex-col flex-1 text-left">
                  <span class="text-sm font-bold text-gray-700">${item.item_name}</span>
                  <span class="text-[10px] text-gray-400">${item.description || ''}</span>
              </div>
              <input type="checkbox" id="${uniqueId}" class="maintenance-check w-6 h-6 rounded border-gray-300 text-[#6b8f71]"
                     onchange="saveSingleCheck('${machineId}', '${item.id}', this.checked)">
            `;
            checklistContainer.appendChild(div);
          });
        }
        await restoreMaintenanceChecks();
      } catch (e) { console.error(e); }
    }

    // 3. 進捗表示の更新
    function updateMaintenanceProgress() {
      const checkboxes = document.querySelectorAll('#maintenanceChecklist input[type="checkbox"]');
      const total = checkboxes.length;
      if (total === 0) return;
      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
      const percentage = Math.round((checkedCount / total) * 100);
      const summaryDiv = document.getElementById('maintenanceSummary');
      if (summaryDiv) {
        summaryDiv.innerHTML = `
          <div class="flex justify-between items-center mb-1">
            <span class="font-bold text-[#6b8f71]">${percentage}% 完了</span>
            <span class="text-xs text-gray-400">${checkedCount} / ${total} 項目</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="bg-[#6b8f71] h-2 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
          </div>
        `;
      }
    }

    // 4. 保存
    async function saveSingleCheck(machineId, itemId, isChecked) {
      try {
        const uniqueId = `${machineId}_${itemId}`;
        await client.from('maintenance_status').upsert({
          item_id: uniqueId, status: Boolean(isChecked), updated_at: new Date()
        }, { onConflict: 'item_id' });
        updateMaintenanceProgress();
        loadMachineList();
      } catch (e) { console.error(e); }
    }

    // 5. 復元
    async function restoreMaintenanceChecks() {
      try {
        const { data } = await client.from('maintenance_status').select('item_id, status');
        if (data) {
          data.forEach(row => {
            const el = document.getElementById(row.item_id);
            if (el) el.checked = row.status;
          });
        }
        updateMaintenanceProgress();
      } catch (e) { console.error(e); }
    }

    async function loadMaintenanceHistory(machineId) {
      try {
        const { data } = await client.from('maintenance_records').select('*').eq('machine_id', machineId).order('created_at', { ascending: false });
        const container = document.getElementById('maintenanceHistoryLog');
        if (!container) return;
        if (!data || data.length === 0) {
          container.innerHTML = '<p class="italic text-gray-400 text-center py-4">履歴はありません</p>';
          return;
        }
        container.innerHTML = data.map(rec => `
          <div class="border-b border-gray-100 pb-2 mb-2 last:border-0 text-left">
            <div class="flex justify-between font-bold text-gray-700"><span>${rec.item_name}</span><span class="text-gray-400 text-[9px]">${rec.date}</span></div>
            <div class="text-gray-500">担当: ${rec.operator}</div>
            ${rec.memo ? `<div class="text-gray-400 italic">"${rec.memo}"</div>` : ''}
          </div>`).join('');
      } catch (e) { console.error(e); }
    }

    // ==========================================
    // 1. ページ読み込み時の初期化（DOMContentLoaded）
    // ==========================================
    document.addEventListener('DOMContentLoaded', async () => {
      console.log("🚀 全データの初期化を開始します...");

      // メンテナンス・ログ入力・履歴の読み込み
      if (typeof loadMachineList === 'function') await loadMachineList();
      if (typeof restoreMaintenanceChecks === 'function') await restoreMaintenanceChecks();
      if (typeof loadOperators === 'function') await loadOperators();
      if (typeof loadCategories === 'function') await loadCategories();
      if (typeof loadLogs === 'function') loadLogs('historyLogList', false);

      // 日付セット
      const dateInput = document.getElementById('workDate');
      if (dateInput) dateInput.value = new Date().toLocaleDateString('sv-SE');
      const monthInput = document.getElementById('filterMonth');
      if (monthInput) monthInput.value = new Date().toISOString().substring(0, 7);

      // ★ダッシュボードの初期表示（全体を表示）
      if (typeof renderDashboard === 'function') {
        renderDashboard('all');
      }

      if (typeof switchView === 'function') {
        switchView('portalView');
      }

      // Reveal the page after initial view switch to avoid flash of other views
      try { document.body.style.visibility = 'visible'; } catch(e) { /* ignore */ }
      
      // バージョン更新チェック
      checkVersionUpdate();
      
      console.log("✅ 全データの初期化命令を完了しました");
    }); // ← ここで DOMContentLoaded がスッキリ終了！


    // ==========================================
    // 2. 実務をこなす関数たち
    // ==========================================

    // --- ダッシュボード全体を制御する関数 ---
    async function renderDashboard(machineId = 'all') {
      const machineTabs = document.getElementById("machineTabs");
      if (!machineTabs) return;

      window.currentViewMachineId = machineId;
      console.log("🛠️ ダッシュボード描画中... ID:", machineId);
      const currentId = machineId;
      const allBtnClass = (currentId === 'all') ? 'active' : 'inactive';

      let tabsHTML = `
      <button onclick="renderDashboard('all')" 
              class="tab-btn ${allBtnClass}" 
              style="min-width: 80px; letter-spacing: 0.2em;">全 体</button>
    `;

      if (typeof allMachines !== 'undefined' && allMachines.length > 0) {
        tabsHTML += allMachines.map(m => {
          const isActive = (String(m.id) === String(currentId)) ? 'active' : 'inactive';
          return `
          <button onclick="renderDashboard(${m.id})" 
                  class="tab-btn ${isActive}">${m.name}</button>
        `;
        }).join("");
      }
      machineTabs.innerHTML = tabsHTML;


      try {
        // 1. まずベースのクエリを作る（2026年以降＋日付順）
        let query = client
          .from("hour_logs")
          .select("*")
          .gte("date", "2026-01-01")
          .order("date", { ascending: false });

        // 2. 「すべて」以外が選ばれている場合だけ、さらにマシンIDで絞り込む
        if (machineId !== 'all') {
          query = query.eq("machine_id", machineId);
        }

        const { data, error } = await query;
        if (error) throw error;

        // もしデータが0件なら「データなし」と表示して終わる（エラーで止めない）
        if (!data || data.length === 0) {
          console.warn("⚠️ 2026年のデータが見つかりません");
          const rankingContainer = document.getElementById("rankList");
          if (rankingContainer) rankingContainer.innerHTML = "データなし";
          return;
        }

        // 集計
        const summary = {};
        data.forEach(log => {
          let name = "不明";
          if (typeof allMachines !== 'undefined') {
            const m = allMachines.find(item => String(item.id) === String(log.machine_id));
            if (m) name = m.name;
          }
          const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
          summary[name] = (summary[name] || 0) + (h > 0 ? h : 0);
        });

        // ランキング表示（上位3位）
        const sorted = Object.entries(summary).sort((a, b) => b[1] - a[1]);
        const rankingContainer = document.getElementById("rankList");
        if (rankingContainer) {
          const crownColors = ['text-yellow-500', 'text-gray-400', 'text-amber-600'];
          rankingContainer.innerHTML = sorted.slice(0, 3).map(([name, hours], i) => `
            <div class="flex flex-col items-center px-1 text-center" style="min-width: 75px;">
              <div class="mb-1"><i class="fa-solid fa-crown ${crownColors[i]} text-xl"></i></div>
              <span class="text-[10px] font-bold text-gray-700 truncate w-20 leading-tight">${name}</span>
            </div>
          `).join('');
        }

        // --- KPIカードの集計と反映 ---
        if (data) {
          let totalH = 0;
          let totalF = 0;
          const daysSet = new Set();

          data.forEach(log => {
            // 稼働時間の計算
            const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
            totalH += (h > 0 ? h : 0);

            // ✅ 給油量を fuel_amount から取得
            totalF += (parseFloat(log.fuel_amount) || 0);

            // 作業日数のカウント
            if (log.date) daysSet.add(log.date);
          });

          // 燃費計算 (給油合計 ÷ 稼働時間合計)
          const fuelAvg = totalH > 0 ? (totalF / totalH).toFixed(2) : "0.00";

          // HTML要素への反映
          const elH = document.getElementById("kpi-hours");
          const elF = document.getElementById("kpi-fuel");
          const elA = document.getElementById("kpi-avg");
          const elD = document.getElementById("kpi-days");

          if (elH) elH.innerText = totalH.toFixed(1);
          if (elF) elF.innerText = totalF.toFixed(1);
          if (elA) elA.innerText = fuelAvg;
          if (elD) elD.innerText = daysSet.size;

          console.log("✅ KPI更新完了 (fuel_amount使用):", { totalH, totalF, fuelAvg });
        }

        if (typeof drawCharts === 'function') {
          drawCharts(data);
        }

      } catch (e) {
        console.error("❌ ダッシュボード描画エラー:", e);
      }
    }

    async function saveMaintenanceRecord() {
      const item = document.getElementById('newMaintenanceItem')?.value;
      const operator = document.getElementById('newMaintenanceOperator')?.value;
      const status = document.getElementById('newMaintenanceStatus')?.value;
      const memo = document.getElementById('newMaintenanceMemo')?.value;

      // window.currentMachineId を明示的に数値として取得する
      let mId = window.currentMachineId;
      const numericMachineId = parseInt(mId);

      // 数値じゃない（"all"や空っぽ）場合はエラーを出す
      if (isNaN(numericMachineId)) {
        showModal("エラー", "機械の情報を読み取れませんでした。一度一覧に戻って選び直してください🌸");
        return;
      }

      if (!item) {
        showModal("入力エラー", "交換部品・項目名を入力してくださいね🌸");
        return;
      }

      try {
        const { error } = await client.from('maintenance_records').insert([
          {
            item_name: item,
            operator: operator,
            status: status,
            memo: memo,
            date: new Date().toISOString().split('T')[0],
            machine_id: numericMachineId // ここで数値を使う
          }
        ]);

        if (error) throw error;

        showModal("保存完了", "メンテナンス情報を記録しました！✨");

        // 入力欄をクリア
        document.getElementById('newMaintenanceItem').value = '';
        document.getElementById('newMaintenanceMemo').value = '';

        // 履歴の表示を更新（この関数がある場合）
        if (typeof loadMaintenanceHistory === 'function') {
          loadMaintenanceHistory(numericMachineId);
        }

      } catch (err) {
        console.error("Maint Save Error:", err);
        showModal("保存エラー", "保存に失敗しました: " + (err.message || JSON.stringify(err)));
      }
    }

    async function saveLog() {
      const machineId = document.getElementById('machineSelect')?.value;
      const workDate = document.getElementById('workDate')?.value;
      const operator = document.getElementById('operator')?.value;
      const category = document.getElementById('category')?.value;
      const workName = document.getElementById('work_name')?.value;
      const hourBefore = parseFloat(document.getElementById('hourBefore')?.value) || 0;
      const hourAfter = parseFloat(document.getElementById('hourAfter')?.value) || 0;
      const fuelType = document.getElementById('fuelType')?.value;
      const fuel = parseFloat(document.getElementById('fuelAmount')?.value) || 0;
      const memo = document.getElementById('memoInput')?.value;

      // バリデーション（入力チェック）
      if (!machineId) return showModal("入力エラー", "機械を選択してください");
      if (!workDate || !workName) return showModal("入力エラー", "「作業日」「作業内容」は必須項目です");
      if (hourAfter < hourBefore) return showModal("入力エラー", "稼働後の数値が稼働前より小さくなっています。");

      // 以前のスタイル：showModal を使って確認してから保存
      showModal("登録確認", "ログを登録しますか？", async () => {
        try {
          const { error } = await client.from('hour_logs').insert([{
            date: workDate,
            operator: operator,
            machine_id: parseInt(machineId),
            start_hour: hourBefore,
            end_hour: hourAfter,
            category: category,
            task: workName,
            fuel_type_id: fuelType ? parseInt(fuelType) : null,
            fuel_amount: fuel,
            memo: memo
          }]);

          if (error) throw error;

          // 保存成功後、以前のようにページをリロードしてすべてリセット
          location.reload();

        } catch (err) {
          console.error("Log Save Error:", err);
          showModal("保存エラー", "保存に失敗しました: " + (err.message));
        }
      });
    }

    // --- Google Vision APIを使って画像から数字を読み取る関数 ---
    async function performOCR(base64Image) {
      const url = `https://vision.googleapis.com/v1/images:annotate?key=${GOOGLE_VISION_API_KEY}`;

      const requestData = {
        requests: [{
          image: { content: base64Image },
          features: [{ type: "TEXT_DETECTION" }]
        }]
      };

      try {
        const response = await fetch(url, {
          method: "POST",
          body: JSON.stringify(requestData)
        });
        const result = await response.json();

        // 読み取った全テキストを結合
        const detections = result.responses[0].textAnnotations;
        if (!detections || detections.length === 0) return null;

        const fullText = detections[0].description;
        console.log("🔍 OCR読み取り結果:", fullText);

        // テキストから「数字（小数点含む）」だけを抽出する（例: "123.4"）
        const match = fullText.match(/\d+(\.\d+)?/);
        return match ? match[0] : null;
      } catch (err) {
        console.error("❌ OCRエラー:", err);
        return null;
      }
    }

    // ハンドラ：稼働後の数値を画像から読み取る
    async function handleHourAfterImage(input) {
      const file = input.files[0];
      if (!file) return;

      try {
        const base64Image = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.readAsDataURL(file);
        });

        // OCR 実行
        const text = await performOCR(base64Image);
        if (!text) return showModal('読み取り失敗', '読み取りに失敗しました。写真を変えて再試行してください。');

        // 数字（小数点含む）を抽出して input に反映
        const m = text.match(/\d+(?:\.\d+)?/);
        if (m) {
          document.getElementById('hourAfter').value = m[0];
          calcDiff();
        } else {
          showModal('検出失敗', '数字が検出されませんでした。読み取り結果:\n' + (text.substring(0,200) || '-----'));
        }
      } catch (err) {
        console.error('HourAfter OCR error', err);
        showModal('エラー', '読み取り中にエラーが発生しました');
      } finally {
        // ファイル入力をクリアして同じ画像を再選択できるようにする
        input.value = '';
      }
    }

    // ========== 田植え機用の関数 ==========
    async function initTauePage() {
      // 田植え機の機械リストを取得
      const { data: taueMachines } = await client
        .from("machines")
        .select("*")
        .eq("machine_type", "transplanter")
        .order("name");

      // オペレーター取得
      const { data: operators } = await client
        .from("operators")
        .select("*")
        .order("id");

      // 油種取得
      const { data: fuelTypes } = await client
        .from("fuel_types")
        .select("*");

      // 作業内容取得（category = '田植え'）
      const { data: workTypes, error: workTypesError } = await client
        .from("work_types")
        .select("*")
        .eq("category", "田植え");

      console.log("田植え機 作業内容データ:", workTypes);
      console.log("田植え機 作業内容エラー:", workTypesError);
      if (workTypes && workTypes.length > 0) {
        console.log("最初のデータのキー:", Object.keys(workTypes[0]));
      }

      // 機械選択
      const taue_machineSelect = document.getElementById("taue_machineSelect");
      if (taue_machineSelect) {
        taue_machineSelect.innerHTML = '<option value="">選択</option>' +
          (taueMachines || []).map(m => `<option value="${m.id}">${m.name}</option>`).join("");
      }

      // オペレーター選択
      const taue_operator = document.getElementById("taue_operator");
      if (taue_operator) {
        taue_operator.innerHTML = '<option value="">選択</option>' +
          (operators || []).map(o => `<option value="${o.name}">${o.name}</option>`).join("");
      }

      // 油種選択
      const taue_fuelType = document.getElementById("taue_fuelType");
      if (taue_fuelType) {
        taue_fuelType.innerHTML = '<option value="">選択</option>' +
          (fuelTypes || []).map(f => `<option value="${f.name}">${f.name}</option>`).join("");
      }

      // 作業内容選択
      const taue_work_name = document.getElementById("taue_work_name");
      if (taue_work_name) {
        taue_work_name.innerHTML = '<option value="">選択</option>' +
          (workTypes || []).map(w => `<option value="${w.work_name}">${w.work_name}</option>`).join("");
        console.log("田植え機 作業内容セレクトボックス設定完了:", taue_work_name.innerHTML);
      }

      // 履歴検索フィルター - 機械選択
      const filterMachinePlanting = document.getElementById("filterMachinePlanting");
      if (filterMachinePlanting) {
        filterMachinePlanting.innerHTML = '<option value="">すべて</option>' +
          (taueMachines || []).map(m => `<option value="${m.id}">${m.name}</option>`).join("");
      }

      // 履歴検索フィルター - オペレーター選択
      const filterOperatorPlanting = document.getElementById("filterOperatorPlanting");
      if (filterOperatorPlanting) {
        filterOperatorPlanting.innerHTML = '<option value="">すべて</option>' +
          (operators || []).map(o => `<option value="${o.id}">${o.name}</option>`).join("");
      }

      // 履歴検索フィルター - 作業内容選択
      const filterCategoryPlanting = document.getElementById("filterCategoryPlanting");
      if (filterCategoryPlanting) {
        filterCategoryPlanting.innerHTML = '<option value="">すべて</option>' +
          (workTypes || []).map(w => `<option value="${w.work_name}">${w.work_name}</option>`).join("");
      }

      // 履歴検索フィルター - 月の初期値設定
      const filterMonthPlanting = document.getElementById("filterMonthPlanting");
      if (filterMonthPlanting) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        filterMonthPlanting.value = `${year}-${month}`;
      }
    }

    async function taue_autoFillHour() {
      const mId = document.getElementById("taue_machineSelect").value;
      if (!mId) return;
      const { data } = await client.from("planting_logs").select("end_hour").eq("machine_id", mId).order("date", { ascending: false }).order("created_at", { ascending: false }).limit(1);
      if (data && data.length > 0) { document.getElementById("taue_hourBefore").value = data[0].end_hour; taue_calcDiff(); }
    }

    function taue_calcDiff() {
      const b = parseFloat(document.getElementById("taue_hourBefore").value) || 0;
      const a = parseFloat(document.getElementById("taue_hourAfter").value) || 0;
      const d = a - b;
      const disp = document.getElementById("taue_hourDiffDisplay");

      if (a > 0 && a < b) {
        disp.classList.remove("text-[#6b8f71]");
        disp.classList.add("text-red-500");
        disp.textContent = `稼働時間: 0.0 h (入力エラー)`;
      } else {
        disp.classList.remove("text-red-500");
        disp.classList.add("text-[#6b8f71]");
        disp.textContent = `稼働時間: ${d > 0 ? d.toFixed(1) : "0.0"} h`;
      }
    }

    async function taue_saveLog() {
      const machineId = document.getElementById('taue_machineSelect')?.value;
      const workDate = document.getElementById('taue_workDate')?.value;
      const operator = document.getElementById('taue_operator')?.value;
      const workName = document.getElementById('taue_work_name')?.value;
      const hourBefore = parseFloat(document.getElementById('taue_hourBefore')?.value) || 0;
      const hourAfter = parseFloat(document.getElementById('taue_hourAfter')?.value) || 0;
      const fuelType = document.getElementById('taue_fuelType')?.value;
      const fuel = parseFloat(document.getElementById('taue_fuelAmount')?.value) || 0;
      const memo = document.getElementById('taue_memoInput')?.value;

      if (!machineId) return showModal("入力エラー", "機械を選択してください");
      if (!workDate || !workName) return showModal("入力エラー", "「作業日」「作業内容」は必須項目です");
      if (hourAfter < hourBefore) return showModal("入力エラー", "稼働後の数値が稼働前より小さくなっています。");

      showModal("登録確認", "ログを登録しますか？", async () => {
        try {
          const { error } = await client.from('planting_logs').insert([{
            date: workDate,
            operator_id: operator ? parseInt(operator) : null,
            machine_id: parseInt(machineId),
            start_hour: hourBefore,
            end_hour: hourAfter,
            task: workName,
            fuel_type_id: fuelType ? parseInt(fuelType) : null,
            fuel_amount: fuel,
            memo: memo
          }]);

          if (error) throw error;
          location.reload();

        } catch (err) {
          console.error("Log Save Error:", err);
          showModal("保存エラー", "保存に失敗しました: " + (err.message));
        }
      });
    }

    async function taue_handleHourAfterImage(input) {
      const file = input.files[0];
      if (!file) return;

      try {
        const base64Image = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.readAsDataURL(file);
        });

        // OCR 実行
        const text = await performOCR(base64Image);
        if (!text) return showModal('読み取り失敗', '読み取りに失敗しました。写真を変えて再試行してください。');

        // 数字（小数点含む）を抽出して input に反映
        const m = text.match(/\d+(?:\.\d+)?/);
        if (m) {
          document.getElementById('taue_hourAfter').value = m[0];
          taue_calcDiff();
        } else {
          showModal('検出失敗', '数字が検出されませんでした。読み取り結果:\n' + (text.substring(0,200) || '-----'));
        }
      } catch (err) {
        console.error('TaueHourAfter OCR error', err);
        showModal('エラー', '読み取り中にエラーが発生しました');
      } finally {
        // ファイル入力をクリアして同じ画像を再選択できるようにする
        input.value = '';
      }
    }

    // ========== コンバイン用の関数 ==========
    async function initCombinePage() {
      // コンバインの機械リストを取得
      const { data: combineMachines } = await client
        .from("machines")
        .select("*")
        .eq("machine_type", "combine")
        .order("name");

      // オペレーター取得
      const { data: operators } = await client
        .from("operators")
        .select("*")
        .order("id");

      // 油種取得
      const { data: fuelTypes } = await client
        .from("fuel_types")
        .select("*");

      // 作業内容取得（category = '刈取り'）
      const { data: workTypes, error: workTypesError } = await client
        .from("work_types")
        .select("*")
        .eq("category", "刈取り");

      console.log("コンバイン 作業内容データ:", workTypes);
      console.log("コンバイン 作業内容エラー:", workTypesError);
      if (workTypes && workTypes.length > 0) {
        console.log("最初のデータのキー:", Object.keys(workTypes[0]));
      }

      // 機械選択
      const combine_machineSelect = document.getElementById("combine_machineSelect");
      if (combine_machineSelect) {
        combine_machineSelect.innerHTML = '<option value="">選択</option>' +
          (combineMachines || []).map(m => `<option value="${m.id}">${m.name}</option>`).join("");
      }

      // オペレーター選択
      const combine_operator = document.getElementById("combine_operator");
      if (combine_operator) {
        combine_operator.innerHTML = '<option value="">選択</option>' +
          (operators || []).map(o => `<option value="${o.id}">${o.name}</option>`).join("");
      }

      // 油種選択
      const combine_fuelType = document.getElementById("combine_fuelType");
      if (combine_fuelType) {
        combine_fuelType.innerHTML = '<option value="">選択</option>' +
          (fuelTypes || []).map(f => `<option value="${f.id}">${f.name}</option>`).join("");
      }

      // 作業内容選択
      const combine_work_name = document.getElementById("combine_work_name");
      if (combine_work_name) {
        combine_work_name.innerHTML = '<option value="">選択</option>' +
          (workTypes || []).map(w => `<option value="${w.work_name}">${w.work_name}</option>`).join("");
        console.log("コンバイン 作業内容セレクトボックス設定完了:", combine_work_name.innerHTML);
      }

      // 履歴検索フィルター - 機械選択
      const filterMachineCombine = document.getElementById("filterMachineCombine");
      if (filterMachineCombine) {
        filterMachineCombine.innerHTML = '<option value="">すべて</option>' +
          (combineMachines || []).map(m => `<option value="${m.id}">${m.name}</option>`).join("");
      }

      // 履歴検索フィルター - オペレーター選択
      const filterOperatorCombine = document.getElementById("filterOperatorCombine");
      if (filterOperatorCombine) {
        filterOperatorCombine.innerHTML = '<option value="">すべて</option>' +
          (operators || []).map(o => `<option value="${o.id}">${o.name}</option>`).join("");
      }

      // 履歴検索フィルター - 作業内容選択
      const filterCategoryCombine = document.getElementById("filterCategoryCombine");
      if (filterCategoryCombine) {
        filterCategoryCombine.innerHTML = '<option value="">すべて</option>' +
          (workTypes || []).map(w => `<option value="${w.work_name}">${w.work_name}</option>`).join("");
      }

      // 履歴検索フィルター - 月の初期値設定
      const filterMonthCombine = document.getElementById("filterMonthCombine");
      if (filterMonthCombine) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        filterMonthCombine.value = `${year}-${month}`;
      }
    }

    async function combine_autoFillHour() {
      const mId = document.getElementById("combine_machineSelect").value;
      if (!mId) return;
      const { data } = await client.from("combine_logs").select("end_hour").eq("machine_id", mId).order("date", { ascending: false }).order("created_at", { ascending: false }).limit(1);
      if (data && data.length > 0) { document.getElementById("combine_hourBefore").value = data[0].end_hour; combine_calcDiff(); }
    }

    function combine_calcDiff() {
      const b = parseFloat(document.getElementById("combine_hourBefore").value) || 0;
      const a = parseFloat(document.getElementById("combine_hourAfter").value) || 0;
      const d = a - b;
      const disp = document.getElementById("combine_hourDiffDisplay");

      if (a > 0 && a < b) {
        disp.classList.remove("text-[#c9a961]");
        disp.classList.add("text-red-500");
        disp.textContent = `稼働時間: 0.0 h (入力エラー)`;
      } else {
        disp.classList.remove("text-red-500");
        disp.classList.add("text-[#c9a961]");
        disp.textContent = `稼働時間: ${d > 0 ? d.toFixed(1) : "0.0"} h`;
      }
    }

    async function combine_saveLog() {
      const machineId = document.getElementById('combine_machineSelect')?.value;
      const workDate = document.getElementById('combine_workDate')?.value;
      const operator = document.getElementById('combine_operator')?.value;
      const workName = document.getElementById('combine_work_name')?.value;
      const hourBefore = parseFloat(document.getElementById('combine_hourBefore')?.value) || 0;
      const hourAfter = parseFloat(document.getElementById('combine_hourAfter')?.value) || 0;
      const fuelType = document.getElementById('combine_fuelType')?.value;
      const fuel = parseFloat(document.getElementById('combine_fuelAmount')?.value) || 0;
      const memo = document.getElementById('combine_memoInput')?.value;

      if (!machineId) return showModal("入力エラー", "機械を選択してください");
      if (!workDate || !workName) return showModal("入力エラー", "「作業日」「作業内容」は必須項目です");
      if (hourAfter < hourBefore) return showModal("入力エラー", "稼働後の数値が稼働前より小さくなっています。");

      showModal("登録確認", "ログを登録しますか？", async () => {
        try {
          const { error } = await client.from('combine_logs').insert([{
            date: workDate,
            operator_id: operator ? parseInt(operator) : null,
            machine_id: parseInt(machineId),
            start_hour: hourBefore,
            end_hour: hourAfter,
            task: workName,
            fuel_type_id: fuelType ? parseInt(fuelType) : null,
            fuel_amount: fuel,
            memo: memo
          }]);

          if (error) throw error;
          location.reload();

        } catch (err) {
          console.error("Log Save Error:", err);
          showModal("保存エラー", "保存に失敗しました: " + (err.message));
        }
      });
    }

    async function combine_handleHourAfterImage(input) {
      const file = input.files[0];
      if (!file) return;

      try {
        const base64Image = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.readAsDataURL(file);
        });

        const text = await performOCR(base64Image);
        if (!text) return showModal('読み取り失敗', '読み取りに失敗しました。写真を変えて再試行してください。');

        const m = text.match(/\d+(?:\.\d+)?/);
        if (m) {
          document.getElementById('combine_hourAfter').value = m[0];
          combine_calcDiff();
        } else {
          showModal('検出失敗', '数字が検出されませんでした。読み取り結果:\n' + (text.substring(0,200) || '-----'));
        }
      } catch (err) {
        console.error('CombineHourAfter OCR error', err);
        showModal('エラー', '読み取り中にエラーが発生しました');
      } finally {
        input.value = '';
      }
    }

    // ========== 田植え機用のログ読み込み関数 ==========
    async function loadLogsPlanting(elId, todayOnly) {
      const list = document.getElementById(elId);
      list.innerHTML = "<p class='text-center py-10 opacity-50 text-xs'>読込中...</p>";

      let query = client.from("planting_logs").select("*, machines(name), operators(name)").order("date", { ascending: false });

      if (todayOnly) {
        const jstToday = new Date().toLocaleDateString('sv-SE');
        query = query.eq("date", jstToday);
      } else {
        const month = document.getElementById("filterMonthPlanting").value;
        const machine = document.getElementById("filterMachinePlanting").value;
        const operator = document.getElementById("filterOperatorPlanting").value;
        const category = document.getElementById("filterCategoryPlanting").value;

        if (month) query = query.gte("date", `${month}-01`).lte("date", `${month}-31`);
        if (machine) query = query.eq("machine_id", machine);
        if (operator) query = query.eq("operator_id", operator);
        if (category) query = query.eq("task", category);
      }

      const { data, error } = await query;
      if (error) {
        console.error("データ取得エラー:", error);
        console.error("エラー詳細:", error.message, error.details, error.hint);
        list.innerHTML = `<p class='text-center py-10 text-red-500 text-xs'>エラー: ${error.message}</p>`;
        return;
      }

      let total = 0;
      const displayData = todayOnly ? [...(data || [])].reverse() : (data || []);

      list.innerHTML = displayData.map(l => {
        const diff = (l.end_hour - l.start_hour);
        total += diff;
        return `<div class="card border-l-4 border-[#6b8f71] !mb-3 !py-3 flex justify-between items-center">
              <div>
                <b class="text-sm">${l.date} - ${l.machines?.name}</b>
                <p class="text-xs opacity-70 mt-1">${l.operators?.name || '不明'} | ${l.task}</p>
                <div class="flex gap-4 mt-2">
                  <span class="text-[11px] font-bold log-badge px-2 py-1 rounded"><i class="fa-solid fa-clock mr-1 text-[#6b8f71]"></i>${diff.toFixed(1)} h</span>
                  <span class="text-[11px] font-bold log-badge px-2 py-1 rounded"><i class="fa-solid fa-gas-pump mr-1 text-[#6b8f71]"></i>${l.fuel_amount || 0} L</span>
                  ${l.fuel_type_id ? `<span class="text-[11px] font-bold log-badge px-2 py-1 rounded">ID:${l.fuel_type_id}</span>` : ''}
                </div>
              </div>
              <button onclick="deleteLogPlanting(${l.id})" class="text-gray-400 p-2 hover:text-red-500 transition-colors">
                <i class="fa-regular fa-trash-can text-lg"></i>
              </button>
            </div>`;
      }).join("");

      if (!todayOnly) {
        const totalEl = document.getElementById("historyTotalHoursPlanting");
        if (totalEl) totalEl.innerText = `合計: ${total.toFixed(1)} h`;
      }
    }

    async function deleteLogPlanting(id) {
      showModal("削除確認", "このログを削除しますか？", async () => {
        const { error } = await client.from("planting_logs").delete().eq("id", id);
        if (!error) {
          if (document.getElementById("todayViewPlanting").classList.contains("active")) loadLogsPlanting("todayLogListPlanting", true);
          else loadLogsPlanting("historyLogListPlanting", false);
        }
      });
    }

    // ========== コンバイン用のログ読み込み関数 ==========
    async function loadLogsCombine(elId, todayOnly) {
      const list = document.getElementById(elId);
      list.innerHTML = "<p class='text-center py-10 opacity-50 text-xs'>読込中...</p>";

      try {
        // まず機械とオペレーターのマスタデータを取得
        const { data: machines } = await client.from("machines").select("id, name");
        const { data: operators } = await client.from("operators").select("id, name");

        const machineMap = {};
        const operatorMap = {};
        (machines || []).forEach(m => machineMap[m.id] = m.name);
        (operators || []).forEach(o => operatorMap[o.id] = o.name);

        // combine_logsを取得
        let query = client.from("combine_logs").select("*").order("date", { ascending: false });

        if (todayOnly) {
          const jstToday = new Date().toLocaleDateString('sv-SE');
          query = query.eq("date", jstToday);
        } else {
          const month = document.getElementById("filterMonthCombine").value;
          const machine = document.getElementById("filterMachineCombine").value;
          const operator = document.getElementById("filterOperatorCombine").value;
          const category = document.getElementById("filterCategoryCombine").value;

          if (month) query = query.gte("date", `${month}-01`).lte("date", `${month}-31`);
          if (machine) query = query.eq("machine_id", machine);
          if (operator) query = query.eq("operator_id", operator);
          if (category) query = query.eq("task", category);
        }

        const { data, error } = await query;
        if (error) throw error;

        let total = 0;
        const displayData = todayOnly ? [...(data || [])].reverse() : (data || []);

        list.innerHTML = displayData.map(l => {
          const diff = (l.end_hour - l.start_hour);
          total += diff;
          const machineName = machineMap[l.machine_id] || '不明';
          const operatorName = operatorMap[l.operator_id] || '不明';
          
          return `<div class="card border-l-4 border-[#c9a961] !mb-3 !py-3 flex justify-between items-center">
                <div>
                  <b class="text-sm">${l.date} - ${machineName}</b>
                  <p class="text-xs opacity-70 mt-1">${operatorName} | ${l.task}</p>
                  <div class="flex gap-4 mt-2">
                    <span class="text-[11px] font-bold log-badge px-2 py-1 rounded"><i class="fa-solid fa-clock mr-1 text-[#c9a961]"></i>${diff.toFixed(1)} h</span>
                    <span class="text-[11px] font-bold log-badge px-2 py-1 rounded"><i class="fa-solid fa-gas-pump mr-1 text-[#c9a961]"></i>${l.fuel_amount || 0} L</span>
                    ${l.fuel_type_id ? `<span class="text-[11px] font-bold log-badge px-2 py-1 rounded">ID:${l.fuel_type_id}</span>` : ''}
                  </div>
                </div>
                <button onclick="deleteLogCombine(${l.id})" class="text-gray-400 p-2 hover:text-red-500 transition-colors">
                  <i class="fa-regular fa-trash-can text-lg"></i>
                </button>
              </div>`;
        }).join("");

        if (!todayOnly) {
          const totalEl = document.getElementById("historyTotalHoursCombine");
          if (totalEl) totalEl.innerText = `合計: ${total.toFixed(1)} h`;
        }
      } catch (error) {
        console.error("データ取得エラー:", error);
        console.error("エラー詳細:", error.message, error.details, error.hint);
        list.innerHTML = `<p class='text-center py-10 text-red-500 text-xs'>エラー: ${error.message}</p>`;
      }
    }

    async function deleteLogCombine(id) {
      showModal("削除確認", "このログを削除しますか？", async () => {
        const { error } = await client.from("combine_logs").delete().eq("id", id);
        if (!error) {
          if (document.getElementById("todayViewCombine").classList.contains("active")) loadLogsCombine("todayLogListCombine", true);
          else loadLogsCombine("historyLogListCombine", false);
        }
      });
    }

    // ========== 田植え機用 メンテナンス記録関数 ==========
    async function loadMachineListPlanting() {
      try {
        const { data: machines, error } = await client
          .from("machines")
          .select("*")
          .eq("machine_type", "transplanter")
          .order("id");

        if (error) throw error;

        const container = document.getElementById("maintenanceMachineGridPlanting");
        if (!container) return;
        container.innerHTML = "";

        const grouped = {};
        machines.forEach(m => {
          const manufacturer = m.manufacturer || "その他";
          if (!grouped[manufacturer]) grouped[manufacturer] = [];
          grouped[manufacturer].push(m);
        });

        for (const brand of Object.keys(grouped)) {
          const brandHeader = document.createElement("h3");
          brandHeader.className = "text-[#6b8f71] font-bold text-sm mb-2 mt-4 flex items-center gap-2";
          brandHeader.innerHTML = `<i class="fa-solid fa-tag opacity-50"></i> ${brand}`;
          container.appendChild(brandHeader);

          const grid = document.createElement("div");
          grid.className = "grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-4";

          for (const m of grouped[brand]) {
            const card = document.createElement("div");
            card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-all active:scale-95";
            card.onclick = () => openMaintenanceDetailPlanting(m.id);

            card.innerHTML = `
              <div class="flex flex-col gap-2">
                <div class="flex items-center gap-3">
                  <div style="color: var(--tractor-color);" class="text-xl flex-shrink-0">
                    <i class="fa-solid fa-seedling"></i>
                  </div>
                  <div class="font-bold text-gray-900 text-lg truncate">${m.name}</div>
                </div>
                <div class="border-t border-gray-50 pt-2" id="card-progress-planting-${m.id}">
                  <div class="text-[11px] text-gray-400 flex items-center gap-1">
                    <i class="fa-solid fa-circle-notch fa-spin text-[9px]"></i> 確認中...
                  </div>
                </div>
              </div>
            `;
            grid.appendChild(card);

            (async () => {
              try {
                const { data: checks } = await client
                  .from('maintenance_status')
                  .select('item_id, status')
                  .filter('item_id', 'ilike', `${m.id}_%`);

                const totalItems = 16;
                const uniqueChecks = {};
                if (checks) {
                  checks.forEach(c => { uniqueChecks[c.item_id] = c.status; });
                }

                const completedCount = Object.values(uniqueChecks).filter(status => status === true || status === "true").length;
                let percent = Math.round((completedCount / totalItems) * 100);
                percent = Math.min(100, percent);

                const progressDiv = document.getElementById(`card-progress-planting-${m.id}`);
                if (progressDiv) {
                  let statusHTML = percent === 0
                    ? `<span class="text-red-600 font-black"><i class="fa-solid fa-circle-exclamation text-[9px]"></i> 未着手</span>`
                    : percent === 100
                      ? `<span class="text-[#6b8f71] font-black"><i class="fa-solid fa-circle-check text-[9px]"></i> 完了</span>`
                      : `<span class="text-orange-500 font-black"><i class="fa-solid fa-spinner text-[9px]"></i> ${percent}% 完了</span>`;

                  progressDiv.innerHTML = `
                    <div class="text-[11px] flex items-center gap-1">${statusHTML}</div>
                    <div class="w-full bg-gray-100 rounded-full h-1 mt-1">
                      <div class="bg-[#6b8f71] h-1 rounded-full transition-all duration-500" style="width: ${percent}%"></div>
                    </div>
                  `;
                }
              } catch (err) { console.error("カード進捗更新エラー:", err); }
            })();
          }
          container.appendChild(grid);
        }
      } catch (e) { console.error("一覧読み込みエラー:", e); }
    }

    async function openMaintenanceDetailPlanting(machineId) {
      window.currentMachineIdPlanting = machineId;
      switchView('maintenanceDetailViewPlanting');

      try {
        const { data: machine } = await client.from("machines").select("*").eq("id", machineId).single();
        document.getElementById("maintenanceMachineNamePlanting").textContent = machine.name;

        const { data: operators } = await client.from('operators').select('name').order('id');
        const opSelect = document.getElementById('newMaintenanceOperatorPlanting');
        if (opSelect && operators) {
          opSelect.innerHTML = '<option value="">担当者を選択</option>';
          operators.forEach(op => {
            const opt = document.createElement('option');
            opt.value = op.name; opt.textContent = op.name;
            opSelect.appendChild(opt);
          });
        }

        loadMaintenanceHistoryPlanting(machineId);
        const { data: items } = await client.from("maintenance_items_transplanter").select("*").order("id");
        const checklistContainer = document.getElementById("maintenanceChecklistPlanting");
        if (checklistContainer && items) {
          checklistContainer.innerHTML = "";
          items.forEach(item => {
            const uniqueId = `${machineId}_${item.id}`;
            const div = document.createElement("div");
            div.className = "flex items-center justify-between p-3 border-b border-gray-50 last:border-0 hover:bg-gray-50 transition-colors";
            div.innerHTML = `
              <div class="flex flex-col flex-1 text-left">
                  <span class="text-sm font-bold text-gray-700">${item.item_name}</span>
                  <span class="text-[10px] text-gray-400">${item.description || ''}</span>
              </div>
              <input type="checkbox" id="${uniqueId}" class="maintenance-check w-6 h-6 rounded border-gray-300 text-[#6b8f71]"
                     onchange="saveSingleCheckPlanting('${machineId}', '${item.id}', this.checked)">
            `;
            checklistContainer.appendChild(div);
          });
        }
        await restoreMaintenanceChecksPlanting();
      } catch (e) { console.error(e); }
    }

    function updateMaintenanceProgressPlanting() {
      const checkboxes = document.querySelectorAll('#maintenanceChecklistPlanting input[type="checkbox"]');
      const total = checkboxes.length;
      if (total === 0) return;
      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
      const percentage = Math.round((checkedCount / total) * 100);
      const summaryDiv = document.getElementById('maintenanceSummaryPlanting');
      if (summaryDiv) {
        summaryDiv.innerHTML = `
          <div class="flex justify-between items-center mb-1">
            <span class="font-bold text-[#6b8f71]">${percentage}% 完了</span>
            <span class="text-xs text-gray-400">${checkedCount} / ${total} 項目</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="bg-[#6b8f71] h-2 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
          </div>
        `;
      }
    }

    async function saveSingleCheckPlanting(machineId, itemId, isChecked) {
      try {
        const uniqueId = `${machineId}_${itemId}`;
        await client.from('maintenance_status').upsert({
          item_id: uniqueId, status: Boolean(isChecked), updated_at: new Date()
        }, { onConflict: 'item_id' });
        updateMaintenanceProgressPlanting();
        loadMachineListPlanting();
      } catch (e) { console.error(e); }
    }

    async function restoreMaintenanceChecksPlanting() {
      try {
        const { data } = await client.from('maintenance_status').select('item_id, status');
        if (data) {
          data.forEach(row => {
            const el = document.getElementById(row.item_id);
            if (el) el.checked = row.status;
          });
        }
        updateMaintenanceProgressPlanting();
      } catch (e) { console.error(e); }
    }

    async function loadMaintenanceHistoryPlanting(machineId) {
      try {
        const { data } = await client.from('maintenance_records').select('*').eq('machine_id', machineId).order('created_at', { ascending: false });
        const container = document.getElementById('maintenanceHistoryLogPlanting');
        if (!container) return;
        if (!data || data.length === 0) {
          container.innerHTML = '<p class="italic text-gray-400 text-center py-4">履歴はありません</p>';
          return;
        }
        container.innerHTML = data.map(rec => `
          <div class="border-b border-gray-100 pb-2 mb-2 last:border-0 text-left">
            <div class="flex justify-between font-bold text-gray-700"><span>${rec.item_name}</span><span class="text-gray-400 text-[9px]">${rec.date}</span></div>
            <div class="text-gray-500">担当: ${rec.operator}</div>
            ${rec.memo ? `<div class="text-gray-400 italic">"${rec.memo}"</div>` : ''}
          </div>`).join('');
      } catch (e) { console.error(e); }
    }

    async function saveMaintenanceRecordPlanting() {
      const item = document.getElementById('newMaintenanceItemPlanting')?.value;
      const operator = document.getElementById('newMaintenanceOperatorPlanting')?.value;
      const status = document.getElementById('newMaintenanceStatusPlanting')?.value;
      const memo = document.getElementById('newMaintenanceMemoPlanting')?.value;

      let mId = window.currentMachineIdPlanting;
      const numericMachineId = parseInt(mId);

      if (isNaN(numericMachineId)) {
        showModal("エラー", "機械の情報を読み取れませんでした。一度一覧に戻って選び直してください🌸");
        return;
      }

      if (!item) {
        showModal("入力エラー", "交換部品・項目名を入力してくださいね🌸");
        return;
      }

      try {
        const { error } = await client.from('maintenance_records').insert([
          {
            item_name: item,
            operator: operator,
            status: status,
            memo: memo,
            date: new Date().toISOString().split('T')[0],
            machine_id: numericMachineId
          }
        ]);

        if (error) throw error;

        showModal("保存完了", "メンテナンス情報を記録しました！✨");

        document.getElementById('newMaintenanceItemPlanting').value = '';
        document.getElementById('newMaintenanceMemoPlanting').value = '';

        if (typeof loadMaintenanceHistoryPlanting === 'function') {
          loadMaintenanceHistoryPlanting(numericMachineId);
        }

      } catch (err) {
        console.error("Maint Save Error:", err);
        showModal("保存エラー", "保存に失敗しました: " + (err.message || JSON.stringify(err)));
      }
    }

    // ========== 田植え機用 Dashboard 描画関数 ==========
    async function renderDashboardPlanting(machineId = 'all') {
      const machineTabs = document.getElementById("machineTabsPlanting");
      if (!machineTabs) return;

      window.currentViewMachineIdPlanting = machineId;
      console.log("🌾 田植え機ダッシュボード描画中... ID:", machineId);
      const currentId = machineId;
      const allBtnClass = (currentId === 'all') ? 'active' : 'inactive';

      // 田植え機リストを取得
      const { data: plantingMachines } = await client
        .from("machines")
        .select("*")
        .eq("machine_type", "transplanter")
        .order("name");

      let tabsHTML = `
        <button onclick="renderDashboardPlanting('all')" 
                class="tab-btn ${allBtnClass}" 
                style="min-width: 80px; letter-spacing: 0.2em;">全 体</button>
      `;

      if (plantingMachines && plantingMachines.length > 0) {
        tabsHTML += plantingMachines.map(m => {
          const isActive = (String(m.id) === String(currentId)) ? 'active' : 'inactive';
          return `
            <button onclick="renderDashboardPlanting(${m.id})" 
                    class="tab-btn ${isActive}">${m.name}</button>
          `;
        }).join("");
      }
      machineTabs.innerHTML = tabsHTML;

      try {
        // 2026年以降のplanting_logsデータを取得
        let query = client
          .from("planting_logs")
          .select("*")
          .gte("date", "2026-01-01")
          .order("date", { ascending: false });

        if (machineId !== 'all') {
          query = query.eq("machine_id", machineId);
        }

        const { data, error } = await query;
        if (error) throw error;

        if (!data || data.length === 0) {
          console.warn("⚠️ 2026年の田植え機データが見つかりません");
          const rankingContainer = document.getElementById("rankListPlanting");
          if (rankingContainer) rankingContainer.innerHTML = "データなし";
          return;
        }

        // 機械ごとの稼働時間集計
        const summary = {};
        data.forEach(log => {
          let name = "不明";
          if (plantingMachines) {
            const m = plantingMachines.find(item => String(item.id) === String(log.machine_id));
            if (m) name = m.name;
          }
          const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
          summary[name] = (summary[name] || 0) + (h > 0 ? h : 0);
        });

        // ランキング表示（上位3位）
        const sorted = Object.entries(summary).sort((a, b) => b[1] - a[1]);
        const rankingContainer = document.getElementById("rankListPlanting");
        if (rankingContainer) {
          const crownColors = ['text-yellow-500', 'text-gray-400', 'text-amber-600'];
          rankingContainer.innerHTML = sorted.slice(0, 3).map(([name, hours], i) => `
            <div class="flex flex-col items-center px-1 text-center" style="min-width: 75px;">
              <div class="mb-1"><i class="fa-solid fa-crown ${crownColors[i]} text-xl"></i></div>
              <span class="text-[10px] font-bold text-gray-700 truncate w-20 leading-tight">${name}</span>
            </div>
          `).join('');
        }

        // KPIカードの集計と反映
        if (data) {
          let totalH = 0;
          let totalF = 0;
          const daysSet = new Set();

          data.forEach(log => {
            const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
            totalH += (h > 0 ? h : 0);
            totalF += (parseFloat(log.fuel_amount) || 0);
            if (log.date) daysSet.add(log.date);
          });

          const fuelAvg = totalH > 0 ? (totalF / totalH).toFixed(2) : "0.00";

          const elH = document.getElementById("kpi-hours-planting");
          const elF = document.getElementById("kpi-fuel-planting");
          const elA = document.getElementById("kpi-avg-planting");
          const elD = document.getElementById("kpi-days-planting");

          if (elH) elH.innerText = totalH.toFixed(1);
          if (elF) elF.innerText = totalF.toFixed(1);
          if (elA) elA.innerText = fuelAvg;
          if (elD) elD.innerText = daysSet.size;

          console.log("✅ 田植え機 KPI更新完了:", { totalH, totalF, fuelAvg });
        }

        // チャート描画（田植え機用のチャートを描画する関数があればここで呼び出す）
        if (typeof drawChartsPlanting === 'function') {
          drawChartsPlanting(data);
        }

      } catch (e) {
        console.error("❌ 田植え機ダッシュボード描画エラー:", e);
      }
    }

    // Duplicate/old secondary `loadRepairDashboard` removed.
    // The primary `loadRepairDashboard` (defined earlier) is used to populate
    // 年ごとの修理費 / 機械ごとの修理費 / 最近の修理一覧 など。

    // ========== 田植え機用の修理履歴読み込み関数 ==========
    async function loadRepairDashboardPlanting() {
      try {
        // repair_logs をすべて取得し、machine_type='transplanter'でフィルタリング
        const { data: machines, error: machinesError } = await client
          .from('machines')
          .select('id')
          .eq('machine_type', 'transplanter');

        if (machinesError) {
          console.error('Error loading machines:', machinesError);
          return;
        }

        const transplantMachineIds = machines.map(m => m.id);

        const { data: logs, error } = await client
          .from('repair_logs')
          .select('*')
          .in('machine_id', transplantMachineIds)
          .order('date', { ascending: false });

        if (error) {
          console.error('Error loading repair logs:', error);
          return;
        }

        // -----------------------------
        // ① 累計修理費
        // -----------------------------
        const totalCost = logs.reduce((sum, log) => sum + (log.cost || 0), 0);
        document.getElementById('totalRepairCostPlanting').textContent =
          '¥ ' + totalCost.toLocaleString();

        // -----------------------------
        // ② 年ごとの修理費
        // -----------------------------
        const yearly = {};
        logs.forEach(log => {
          const year = new Date(log.date).getFullYear();
          if (!yearly[year]) yearly[year] = 0;
          yearly[year] += log.cost || 0;
        });

        const yearlyContainer = document.getElementById('yearlyRepairContainerPlanting');
        yearlyContainer.innerHTML = '';

        Object.keys(yearly)
          .sort((a, b) => b - a)
          .forEach(year => {
            const card = document.createElement('div');
            card.className =
              'p-3 bg-white rounded-md shadow text-center border border-gray-100';
            card.innerHTML = `
          <div class="text-sm text-gray-500">${year}年</div>
          <div class="text-lg font-bold text-[#6b8f71]">¥ ${yearly[year].toLocaleString()}</div>
        `;
            yearlyContainer.appendChild(card);
          });

        // -----------------------------
        // ③ 機械ごとの修理費
        // -----------------------------
        const machineTotals = {};

        logs.forEach(log => {
          if (!machineTotals[log.machine_id]) machineTotals[log.machine_id] = 0;
          machineTotals[log.machine_id] += log.cost || 0;
        });

        // machines テーブルから名前を取得
        const { data: allMachines } = await client.from('machines').select('*');

        const machineContainer = document.getElementById('machineRepairContainerPlanting');
        machineContainer.innerHTML = '';

        Object.keys(machineTotals).forEach(machineId => {
          const machine = allMachines.find(m => m.id === Number(machineId));
          const name = machine ? machine.name : '不明な機械';

          const card = document.createElement('div');
          card.className =
            'p-3 bg-white rounded-md shadow text-center border border-gray-100';
          card.innerHTML = `
        <div class="text-sm text-gray-500">${name}</div>
        <div class="text-lg font-bold text-[#6b8f71]">¥ ${machineTotals[machineId].toLocaleString()}</div>
      `;
          machineContainer.appendChild(card);
        });

        // -----------------------------
        // ④ 最近の修理履歴（最新5件）
        // -----------------------------
        const recentContainer = document.getElementById('recentRepairContainerPlanting');
        recentContainer.innerHTML = '';

        logs.slice(0, 5).forEach(log => {
          const item = document.createElement('div');
          item.className =
            'p-3 bg-white rounded-md shadow border border-gray-100';

          item.innerHTML = `
        <div class="text-sm text-gray-500">${log.date}</div>
        <div class="font-bold">${log.memo || '(内容なし)'}</div>
        <div class="text-[#6b8f71] font-bold mt-1">¥ ${log.cost.toLocaleString()}</div>
        <div class="text-xs text-gray-400 mt-1">${log.shop || ''}</div>
      `;

          recentContainer.appendChild(item);
        });

      } catch (err) {
        console.error('Unexpected error:', err);
      }
    }

    async function populateMachineSelectPlanting() {
      const { data: machines } = await client
        .from('machines')
        .select('*')
        .eq('machine_type', 'transplanter')
        .order('name');

      const select = document.getElementById('repairMachineSelectPlanting');
      if (!select) return;

      select.innerHTML = '<option value="">選択してください</option>';

      if (machines && machines.length > 0) {
        machines.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.id;
          opt.textContent = m.name;
          select.appendChild(opt);
        });
      } else {
        const opt = document.createElement('option');
        opt.textContent = "田植え機が登録されていません";
        select.appendChild(opt);
      }
    }

    async function previewInvoicePlanting(input) {
      const file = input.files[0];
      if (!file) return;

      const previewImg = document.getElementById('invoicePreviewImgPlanting');
      const previewArea = document.getElementById('invoicePreviewAreaPlanting');
      const saveBtn = document.getElementById('saveRepairBtnPlanting');

      // プレビュー表示
      previewImg.src = URL.createObjectURL(file);
      previewArea.classList.remove('hidden');

      const memoField = document.getElementById('repairMemoPlanting');
      const dateField = document.getElementById('repairDatePlanting');
      const shopField = document.getElementById('repairShopPlanting');
      const costField = document.getElementById('repairCostPlanting');

      saveBtn.disabled = true;
      saveBtn.innerText = "解析中...";

      try {
        const base64 = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });

        const response = await fetch(
          `https://vision.googleapis.com/v1/images:annotate?key=${VISION_API_KEY}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              requests: [{
                image: { content: base64 },
                features: [{ type: 'TEXT_DETECTION', maxResults: 1 }]
              }]
            })
          }
        );

        const data = await response.json();
        const text = data.responses[0]?.fullTextAnnotation?.text || '';

        console.log("OCR解析結果:", text);

        // 日付を抽出（YYYY/MM/DD または YYYY-MM-DD）
        const dateMatch = text.match(/(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})/);
        if (dateMatch) {
          const [_, year, month, day] = dateMatch;
          dateField.value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        }

        // 店舗名（仮のロジック：最初の行を店舗名とする）
        const lines = text.split('\n').filter(line => line.trim());
        if (lines.length > 0) {
          shopField.value = lines[0];
        }

        // 金額を抽出（¥または￥または「円」の前の数字）
        const costMatch = text.match(/[¥￥]?\s*([\d,]+)\s*円?/);
        if (costMatch) {
          costField.value = costMatch[1].replace(/,/g, '');
        }

        memoField.value = text.substring(0, 200);

        saveBtn.disabled = false;
        saveBtn.innerText = "修理履歴を保存";

      } catch (err) {
        console.error("OCR読み取りエラー:", err);
        showModal("エラー", "画像の読み取りに失敗しました");
        saveBtn.disabled = false;
        saveBtn.innerText = "修理履歴を保存";
      }
    }

    async function saveRepairLogPlanting() {
      const machineId = document.getElementById('repairMachineSelectPlanting').value;
      const dateValue = document.getElementById('repairDatePlanting').value;
      const shopValue = document.getElementById('repairShopPlanting').value;
      const costValue = document.getElementById('repairCostPlanting').value;
      const memoValue = document.getElementById('repairMemoPlanting').value;

      if (!dateValue || !costValue) {
        showModal("入力エラー", "修理日と金額は必須です");
        return;
      }

      const btn = document.getElementById('saveRepairBtnPlanting');
      btn.disabled = true;
      btn.innerText = "保存中...";

      try {
        const { error } = await client
          .from('repair_logs')
          .insert([
            {
              date: dateValue,
              shop: shopValue,
              cost: parseInt(costValue),
              memo: memoValue,
              machine_id: machineId || null
            }
          ]);

        if (error) throw error;

        btn.innerText = "保存完了！";

        loadRepairDashboardPlanting();

        if (typeof showCustomModal === 'function') {
          showCustomModal("保存完了", "修理履歴を記録しました。ダッシュボードを更新します。");
        } else {
          showModal("保存完了", "保存完了しました！🌾");
        }

        setTimeout(() => {
          switchView('repairViewPlanting');
          btn.disabled = false;
          btn.innerText = "修理履歴を保存";
        }, 1500);

      } catch (err) {
        console.error("❌ 保存に失敗しました:", err);
        showModal("保存エラー", "エラーで保存できませんでした: " + err.message);
        btn.disabled = false;
        btn.innerText = "修理履歴を保存";
      }
    }

    // ==========================================
    // エクスポート機能
    // ==========================================

    // エクスポートページ用のグローバル変数
    let currentExportData = [];

    // エクスポートページ初期化
    async function initExportPage() {
      // 機械リストを読み込み
      const { data: machines } = await client
        .from('machines')
        .select('*')
        .order('name');
      
      const machineSelect = document.getElementById('exportMachine');
      if (machineSelect && machines) {
        // 機械タイプごとにグループ化
        const tractors = machines.filter(m => m.machine_type === 'tractor');
        const transplanters = machines.filter(m => m.machine_type === 'transplanter');
        const combines = machines.filter(m => m.machine_type === 'combine');
        const others = machines.filter(m => !['tractor', 'transplanter', 'combine'].includes(m.machine_type));
        
        let optionsHTML = '<option value="">全ての機械</option>';
        
        if (tractors.length > 0) {
          optionsHTML += '<optgroup label="トラクター">';
          optionsHTML += tractors.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
          optionsHTML += '</optgroup>';
        }
        
        if (transplanters.length > 0) {
          optionsHTML += '<optgroup label="田植え機">';
          optionsHTML += transplanters.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
          optionsHTML += '</optgroup>';
        }
        
        if (combines.length > 0) {
          optionsHTML += '<optgroup label="コンバイン">';
          optionsHTML += combines.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
          optionsHTML += '</optgroup>';
        }
        
        if (others.length > 0) {
          optionsHTML += '<optgroup label="その他">';
          optionsHTML += others.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
          optionsHTML += '</optgroup>';
        }
        
        machineSelect.innerHTML = optionsHTML;
      }

      // オペレーターリストを読み込み
      const { data: operators } = await client
        .from('operators')
        .select('*')
        .order('name');
      
      const operatorSelect = document.getElementById('exportOperator');
      if (operatorSelect && operators) {
        operatorSelect.innerHTML = '<option value="">全てのオペレーター</option>' +
          operators.map(o => `<option value="${o.id}">${o.name}</option>`).join('');
      }

      // デフォルトで過去30日間を設定
      const endDate = new Date();
      const startDate = new Date();
      startDate.setDate(startDate.getDate() - 30);
      
      document.getElementById('exportEndDate').valueAsDate = endDate;
      document.getElementById('exportStartDate').valueAsDate = startDate;

      // 初回プレビュー表示
      updateExportPreview();
    }

    // データプレビュー更新
    async function updateExportPreview() {
      const dataType = document.getElementById('exportDataType').value;
      const startDate = document.getElementById('exportStartDate').value;
      const endDate = document.getElementById('exportEndDate').value;
      const machineId = document.getElementById('exportMachine').value;
      const operatorId = document.getElementById('exportOperator').value;

      const previewDiv = document.getElementById('exportPreviewTable');
      const countSpan = document.getElementById('previewCount');
      const exportButton = document.getElementById('exportButton');

      // ローディング表示
      previewDiv.innerHTML = '<p class="text-center text-gray-500 py-8"><i class="fa-solid fa-spinner fa-spin mr-2"></i>読み込み中...</p>';

      try {
        // マスターデータを取得
        const { data: machines } = await client.from("machines").select("id, name");
        const { data: operators } = await client.from("operators").select("id, name");
        const { data: workTypes } = await client.from("work_types").select("id, work_name, category");

        const machineMap = {};
        const operatorMap = {};
        const workTypeMap = {};
        
        (machines || []).forEach(m => machineMap[m.id] = m.name);
        (operators || []).forEach(o => operatorMap[o.id] = o.name);
        (workTypes || []).forEach(w => workTypeMap[w.id] = w);

        let query;
        let tableName;
        let dateField;

        // データタイプに応じてクエリを構築
        if (dataType === 'tractor') {
          tableName = 'hour_logs';
          dateField = 'date';
          query = client.from(tableName).select('*');
        } else if (dataType === 'planting') {
          tableName = 'planting_logs';
          dateField = 'date';
          query = client.from(tableName).select('*');
        } else if (dataType === 'combine') {
          tableName = 'combine_logs';
          dateField = 'date';
          query = client.from(tableName).select('*');
        } else if (dataType === 'maintenance') {
          tableName = 'maintenance_records';
          dateField = 'maintenance_date';
          query = client.from(tableName).select('*');
        } else if (dataType === 'repair') {
          tableName = 'repair_logs';
          dateField = 'repair_date';
          query = client.from(tableName).select('*');
        }

        // 期間フィルター
        if (startDate) {
          query = query.gte(dateField, startDate);
        }
        if (endDate) {
          query = query.lte(dateField, endDate);
        }

        // 機械フィルター
        if (machineId) {
          query = query.eq('machine_id', machineId);
        }

        // オペレーターフィルター（稼働ログのみ）
        if (operatorId && ['tractor', 'planting', 'combine'].includes(dataType)) {
          query = query.eq('operator_id', operatorId);
        }

        query = query.order(dateField, { ascending: false }).limit(100);

        const { data, error } = await query;

        if (error) throw error;

        // データにマスターデータを結合
        currentExportData = (data || []).map(row => {
          const enrichedRow = { ...row };
          enrichedRow.machine_name = machineMap[row.machine_id] || '';
          enrichedRow.operator_name = operatorMap[row.operator_id] || '';
          
          if (dataType === 'tractor' && row.work_type_id) {
            const workType = workTypeMap[row.work_type_id];
            enrichedRow.work_type_category = workType?.category || '';
            enrichedRow.work_type_name = workType?.work_name || '';
          }
          
          // 稼働時間を計算
          if (row.start_hour !== undefined && row.end_hour !== undefined) {
            enrichedRow.diff_hour = (row.end_hour - row.start_hour).toFixed(1);
          }
          
          return enrichedRow;
        });

        // プレビュー表示
        if (currentExportData.length === 0) {
          previewDiv.innerHTML = '<p class="text-center text-gray-500 py-8">該当するデータがありません</p>';
          countSpan.textContent = '0件';
          exportButton.disabled = true;
        } else {
          countSpan.textContent = `${currentExportData.length}件`;
          exportButton.disabled = false;
          
          // テーブル生成
          let tableHTML = '<table class="w-full text-xs border-collapse"><thead><tr class="bg-gray-100">';
          
          // ヘッダー
          if (['tractor', 'planting', 'combine'].includes(dataType)) {
            tableHTML += `
              <th class="border p-2">作業日</th>
              <th class="border p-2">機械名</th>
              <th class="border p-2">オペレーター</th>
              <th class="border p-2">種別</th>
              <th class="border p-2">作業内容</th>
              <th class="border p-2">稼働前(h)</th>
              <th class="border p-2">稼働後(h)</th>
              <th class="border p-2">稼働時間(h)</th>
              <th class="border p-2">備考</th>
            `;
          } else if (dataType === 'maintenance') {
            tableHTML += `
              <th class="border p-2">メンテナンス日</th>
              <th class="border p-2">機械名</th>
              <th class="border p-2">内容</th>
              <th class="border p-2">詳細</th>
              <th class="border p-2">次回予定</th>
              <th class="border p-2">費用</th>
            `;
          } else if (dataType === 'repair') {
            tableHTML += `
              <th class="border p-2">修理日</th>
              <th class="border p-2">機械名</th>
              <th class="border p-2">故障内容</th>
              <th class="border p-2">修理内容</th>
              <th class="border p-2">修理先</th>
              <th class="border p-2">費用</th>
            `;
          }
          
          tableHTML += '</tr></thead><tbody>';

          // データ行（最大10件まで表示）
          currentExportData.slice(0, 10).forEach(row => {
            tableHTML += '<tr>';
            
            if (['tractor', 'planting', 'combine'].includes(dataType)) {
              let category = '';
              let workName = '';
              
              if (dataType === 'tractor') {
                category = row.work_type_category || row.category || '';
                workName = row.work_type_name || row.task || '';
              } else if (dataType === 'planting' || dataType === 'combine') {
                category = row.task || '';
                workName = '';
              }
              
              tableHTML += `
                <td class="border p-2">${row.date || ''}</td>
                <td class="border p-2">${row.machine_name}</td>
                <td class="border p-2">${row.operator_name}</td>
                <td class="border p-2">${category}</td>
                <td class="border p-2">${workName}</td>
                <td class="border p-2">${row.start_hour || ''}</td>
                <td class="border p-2">${row.end_hour || ''}</td>
                <td class="border p-2">${row.diff_hour || ''}</td>
                <td class="border p-2">${row.memo || ''}</td>
              `;
            } else if (dataType === 'maintenance') {
              tableHTML += `
                <td class="border p-2">${row.maintenance_date || ''}</td>
                <td class="border p-2">${row.machine_name}</td>
                <td class="border p-2">${row.maintenance_type || ''}</td>
                <td class="border p-2">${row.details || ''}</td>
                <td class="border p-2">${row.next_maintenance_date || ''}</td>
                <td class="border p-2">${row.cost || ''}</td>
              `;
            } else if (dataType === 'repair') {
              tableHTML += `
                <td class="border p-2">${row.repair_date || ''}</td>
                <td class="border p-2">${row.machine_name}</td>
                <td class="border p-2">${row.issue || ''}</td>
                <td class="border p-2">${row.repair_details || ''}</td>
                <td class="border p-2">${row.shop || ''}</td>
                <td class="border p-2">${row.cost || ''}</td>
              `;
            }
            
            tableHTML += '</tr>';
          });

          if (currentExportData.length > 10) {
            tableHTML += `<tr><td colspan="9" class="border p-2 text-center text-gray-500">...他${currentExportData.length - 10}件</td></tr>`;
          }

          tableHTML += '</tbody></table>';
          previewDiv.innerHTML = tableHTML;
        }

      } catch (error) {
        console.error('プレビューエラー:', error);
        previewDiv.innerHTML = '<p class="text-center text-red-500 py-8">データの読み込みに失敗しました</p>';
        exportButton.disabled = true;
      }
    }

    // Excelエクスポート実行
    function executeExport() {
      if (currentExportData.length === 0) {
        showModal('エクスポート', 'エクスポートするデータがありません');
        return;
      }

      const dataType = document.getElementById('exportDataType').value;
      let exportData, fileName, sheetName;

      try {
        if (['tractor', 'planting', 'combine'].includes(dataType)) {
          exportData = currentExportData.map(row => {
            let category = '';
            let workName = '';
            
            if (dataType === 'tractor') {
              category = row.work_type_category || row.category || '';
              workName = row.work_type_name || row.task || '';
            } else if (dataType === 'planting' || dataType === 'combine') {
              category = row.task || '';
              workName = '';
            }
            
            return {
              '作業日': row.date || '',
              '機械名': row.machine_name,
              'オペレーター': row.operator_name,
              '種別': category,
              '作業内容': workName,
              '稼働前(h)': row.start_hour || '',
              '稼働後(h)': row.end_hour || '',
              '稼働時間(h)': row.diff_hour || '',
              '備考': row.memo || ''
            };
          });
          sheetName = dataType === 'tractor' ? 'トラクター稼働ログ' : 
                      dataType === 'planting' ? '田植え機稼働ログ' : 'コンバイン稼働ログ';
        } else if (dataType === 'maintenance') {
          exportData = currentExportData.map(row => ({
            'メンテナンス日': row.maintenance_date || '',
            '機械名': row.machine_name,
            'メンテナンス内容': row.maintenance_type || '',
            '詳細': row.details || '',
            '次回予定日': row.next_maintenance_date || '',
            '費用(円)': row.cost || '',
            '備考': row.memo || ''
          }));
          sheetName = 'メンテナンス記録';
        } else if (dataType === 'repair') {
          exportData = currentExportData.map(row => ({
            '修理日': row.repair_date || '',
            '機械名': row.machine_name,
            '故障内容': row.issue || '',
            '修理内容': row.repair_details || '',
            '修理先': row.shop || '',
            '費用(円)': row.cost || '',
            '備考': row.memo || ''
          }));
          sheetName = '修理記録';
        }

        // SheetJSでExcel生成
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, sheetName);

        // ファイル名生成
        const now = new Date();
        fileName = `${sheetName}_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}.xlsx`;

        // ダウンロード
        XLSX.writeFile(wb, fileName);
        
        showModal('エクスポート完了', `${currentExportData.length}件のデータをエクスポートしました`);
      } catch (error) {
        console.error('エクスポートエラー:', error);
        showModal('エラー', 'データのエクスポートに失敗しました');
      }
    }

    // トラクターデータエクスポート（旧関数 - 削除予定）
    async function exportTractorData() {
      try {
        const { data, error } = await client
          .from('hour_logs')
          .select(`
            *,
            machines(name),
            operators(name),
            work_types(work_name, category)
          `)
          .order('work_date', { ascending: false });

        if (error) throw error;

        if (!data || data.length === 0) {
          showModal('エクスポート', 'エクスポートするデータがありません');
          return;
        }

        // データを整形
        const exportData = data.map(row => ({
          '作業日': row.work_date || '',
          '機械名': row.machines?.name || '',
          'オペレーター': row.operators?.name || '',
          '種別': row.work_types?.category || '',
          '作業内容': row.work_types?.work_name || '',
          '稼働前(h)': row.start_hour || '',
          '稼働後(h)': row.end_hour || '',
          '稼働時間(h)': row.diff_hour || '',
          '備考': row.memo || ''
        }));

        // SheetJSでExcel生成
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'トラクター稼働ログ');

        // ファイル名生成（現在日時）
        const now = new Date();
        const fileName = `トラクター稼働ログ_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}.xlsx`;

        // ダウンロード
        XLSX.writeFile(wb, fileName);
        
        showModal('エクスポート完了', `${data.length}件のデータをエクスポートしました`);
      } catch (error) {
        console.error('エクスポートエラー:', error);
        showModal('エラー', 'データのエクスポートに失敗しました');
      }
    }

    // 田植え機データエクスポート
    async function exportPlantingData() {
      try {
        const { data, error } = await client
          .from('planting_logs')
          .select(`
            *,
            machines(name),
            operators(name),
            work_types(work_name, category)
          `)
          .order('work_date', { ascending: false });

        if (error) throw error;

        if (!data || data.length === 0) {
          showModal('エクスポート', 'エクスポートするデータがありません');
          return;
        }

        const exportData = data.map(row => ({
          '作業日': row.work_date || '',
          '機械名': row.machines?.name || '',
          'オペレーター': row.operators?.name || '',
          '種別': row.work_types?.category || '',
          '作業内容': row.work_types?.work_name || '',
          '稼働前(h)': row.start_hour || '',
          '稼働後(h)': row.end_hour || '',
          '稼働時間(h)': row.diff_hour || '',
          '備考': row.memo || ''
        }));

        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, '田植え機稼働ログ');

        const now = new Date();
        const fileName = `田植え機稼働ログ_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}.xlsx`;

        XLSX.writeFile(wb, fileName);
        
        showModal('エクスポート完了', `${data.length}件のデータをエクスポートしました`);
      } catch (error) {
        console.error('エクスポートエラー:', error);
        showModal('エラー', 'データのエクスポートに失敗しました');
      }
    }

    // コンバインデータエクスポート
    async function exportCombineData() {
      try {
        const { data, error } = await client
          .from('combine_logs')
          .select(`
            *,
            machines(name),
            operators(name),
            work_types(work_name, category)
          `)
          .order('work_date', { ascending: false });

        if (error) throw error;

        if (!data || data.length === 0) {
          showModal('エクスポート', 'エクスポートするデータがありません');
          return;
        }

        const exportData = data.map(row => ({
          '作業日': row.work_date || '',
          '機械名': row.machines?.name || '',
          'オペレーター': row.operators?.name || '',
          '種別': row.work_types?.category || '',
          '作業内容': row.work_types?.work_name || '',
          '稼働前(h)': row.start_hour || '',
          '稼働後(h)': row.end_hour || '',
          '稼働時間(h)': row.diff_hour || '',
          '備考': row.memo || ''
        }));

        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'コンバイン稼働ログ');

        const now = new Date();
        const fileName = `コンバイン稼働ログ_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}.xlsx`;

        XLSX.writeFile(wb, fileName);
        
        showModal('エクスポート完了', `${data.length}件のデータをエクスポートしました`);
      } catch (error) {
        console.error('エクスポートエラー:', error);
        showModal('エラー', 'データのエクスポートに失敗しました');
      }
    }

    // メンテナンスデータエクスポート
    async function exportMaintenanceData() {
      try {
        const { data, error } = await client
          .from('maintenance_records')
          .select(`
            *,
            machines(name)
          `)
          .order('maintenance_date', { ascending: false });

        if (error) throw error;

        if (!data || data.length === 0) {
          showModal('エクスポート', 'エクスポートするデータがありません');
          return;
        }

        const exportData = data.map(row => ({
          'メンテナンス日': row.maintenance_date || '',
          '機械名': row.machines?.name || '',
          'メンテナンス内容': row.maintenance_type || '',
          '詳細': row.details || '',
          '次回予定日': row.next_maintenance_date || '',
          '費用(円)': row.cost || '',
          '備考': row.memo || ''
        }));

        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'メンテナンス記録');

        const now = new Date();
        const fileName = `メンテナンス記録_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}.xlsx`;

        XLSX.writeFile(wb, fileName);
        
        showModal('エクスポート完了', `${data.length}件のデータをエクスポートしました`);
      } catch (error) {
        console.error('エクスポートエラー:', error);
        showModal('エラー', 'データのエクスポートに失敗しました');
      }
    }

    // 修理データエクスポート
    async function exportRepairData() {
      try {
        const { data, error } = await client
          .from('repair_logs')
          .select(`
            *,
            machines(name)
          `)
          .order('repair_date', { ascending: false });

        if (error) throw error;

        if (!data || data.length === 0) {
          showModal('エクスポート', 'エクスポートするデータがありません');
          return;
        }

        const exportData = data.map(row => ({
          '修理日': row.repair_date || '',
          '機械名': row.machines?.name || '',
          '故障内容': row.issue || '',
          '修理内容': row.repair_details || '',
          '修理先': row.shop || '',
          '費用(円)': row.cost || '',
          '備考': row.memo || ''
        }));

        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, '修理記録');

        const now = new Date();
        const fileName = `修理記録_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}.xlsx`;

        XLSX.writeFile(wb, fileName);
        
        showModal('エクスポート完了', `${data.length}件のデータをエクスポートしました`);
      } catch (error) {
        console.error('エクスポートエラー:', error);
        showModal('エラー', 'データのエクスポートに失敗しました');
      }
    }

  </script>
</body>

</html>