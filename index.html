<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex">
  <link rel="manifest" href="/tractorlog/manifest.json">
  <title>和農日向 Tractor Log</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* --- 基本スタイル --- */
    body {
      background-color: #e2e8e3;
      color: #3a3a3a;
      font-family: "Hiragino Sans", "Noto Sans JP", sans-serif;
      margin: 0;
    }

    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    .sideMenu, #sideMenu, #tractorSideMenu, #plantingSideMenu, #combineSideMenu {
      position: fixed;
      top: 0;
      left: -280px;
      width: 280px;
      height: 100%;
      background: white;
      z-index: 9999;
      transition: left 0.3s ease;
      padding: 20px;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
    }

    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: 9998;
      display: none;
    }

    .menu-item {
      width: 100%;
      text-align: left;
      padding: 0.8rem;
      border-radius: 0.5rem;
      font-weight: bold;
      color: #6b8f71;
      display: flex;
      align-items: center;
      font-size: 0.9rem;
    }

    #plantingSideMenu .menu-item {
      color: #4a9b9b;
    }

    #combineSideMenu .menu-item {
      color: #c9a961;
    }

    select,
    input,
    textarea {
      color: #3a3a3a !important;
      background-color: #ffffff !important;
      border: 1px solid #ddd;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 6px 16px rgba(107, 143, 113, 0.10);
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }

    /* Override Tailwind shadows to use a greenish-gray tint for cards */
    .shadow-sm {
      box-shadow: 0 4px 10px rgba(107, 143, 113, 0.06) !important;
    }
    .shadow {
      box-shadow: 0 8px 22px rgba(107, 143, 113, 0.10) !important;
    }

    .btn-main {
      background-color: #6b8f71;
      color: white;
      padding: 14px;
      border-radius: 12px;
      text-align: center;
      font-weight: bold;
      width: 100%;
      display: block;
    }

    .btn-sub {
      background-color: #6b8f71;
      color: white;
      padding: 12px;
      border-radius: 10px;
      text-align: center;
      font-weight: bold;
      width: 160px;
      max-width: 40%;
      margin: 20px auto 0;
      display: block;
      border: none;
      cursor: pointer;
    }

    /* plantingView専用のボタンスタイル */
    #plantingView .btn-main,
    #todayViewPlanting .btn-main,
    #historyViewPlanting .btn-main,
    #maintenanceMachineListViewPlanting .btn-main,
    #maintenanceDetailViewPlanting .btn-main,
    #repairViewPlanting .btn-main,
    #invoiceOCRViewPlanting .btn-main {
      background-color: #4a9b9b;
    }

    #plantingView .btn-main:hover,
    #todayViewPlanting .btn-main:hover,
    #historyViewPlanting .btn-main:hover,
    #maintenanceMachineListViewPlanting .btn-main:hover,
    #maintenanceDetailViewPlanting .btn-main:hover,
    #repairViewPlanting .btn-main:hover,
    #invoiceOCRViewPlanting .btn-main:hover {
      background-color: #3a8080;
    }

    #plantingView .btn-sub,
    #todayViewPlanting .btn-sub,
    #historyViewPlanting .btn-sub,
    #maintenanceMachineListViewPlanting .btn-sub,
    #maintenanceDetailViewPlanting .btn-sub,
    #repairViewPlanting .btn-sub,
    #invoiceOCRViewPlanting .btn-sub {
      background-color: #4a9b9b;
    }

    #plantingView .btn-sub:hover,
    #todayViewPlanting .btn-sub:hover,
    #historyViewPlanting .btn-sub:hover,
    #maintenanceMachineListViewPlanting .btn-sub:hover,
    #maintenanceDetailViewPlanting .btn-sub:hover,
    #repairViewPlanting .btn-sub:hover,
    #invoiceOCRViewPlanting .btn-sub:hover {
      background-color: #3a8080;
    }

    /* combineView専用のボタンスタイル */
    #combineView .btn-main,
    #todayViewCombine .btn-main,
    #historyViewCombine .btn-main,
    #maintenanceMachineListViewCombine .btn-main,
    #maintenanceDetailViewCombine .btn-main {
      background-color: #c9a961;
    }

    #combineView .btn-main:hover,
    #todayViewCombine .btn-main:hover,
    #historyViewCombine .btn-main:hover,
    #maintenanceMachineListViewCombine .btn-main:hover,
    #maintenanceDetailViewCombine .btn-main:hover {
      background-color: #b8985a;
    }

    #combineView .btn-sub,
    #todayViewCombine .btn-sub,
    #historyViewCombine .btn-sub,
    #maintenanceMachineListViewCombine .btn-sub,
    #maintenanceDetailViewCombine .btn-sub {
      background-color: #c9a961;
    }

    #combineView .btn-sub:hover,
    #todayViewCombine .btn-sub:hover,
    #historyViewCombine .btn-sub:hover,
    #maintenanceMachineListViewCombine .btn-sub:hover,
    #maintenanceDetailViewCombine .btn-sub:hover {
      background-color: #b8985a;
    }

    /* combineView専用の背景色 */
    #combine-section {
      background-color: #faf8f3;
    }

    #combineView,
    #todayViewCombine,
    #historyViewCombine,
    #maintenanceMachineListViewCombine,
    #maintenanceDetailViewCombine,
    #dashboardCombine {
      background-color: #faf8f3;
    }

    .log-badge {
      background-color: #f3f4f6;
      color: #374151;
    }

    #dashboard.active {
      display: flex !important;
      flex-direction: column;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .bi-header {
      height: 65px;
      display: flex;
      align-items: center;
      background: #2d4031;
      color: white;
      flex-shrink: 0;
      width: 100%;
      padding: 0 20px;
    }

    .dashboard-top-bar {
      flex-shrink: 0;
      padding: 10px 15px;
    }

    .main-top-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: stretch;
    }

    .kpi-section {
      flex: 1;
      min-width: 320px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .ranking-section {
      flex: 0.4;
      min-width: 250px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 12px;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
    }

    .kpi-card {
      background: #6b8f71;
      color: white;
      padding: 8px 2px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .kpi-label {
      font-size: 9px;
      font-weight: bold;
      opacity: 0.9;
    }

    .kpi-value-container {
      display: flex;
      align-items: baseline;
      gap: 1px;
    }

    .kpi-value {
      font-size: 15px;
      font-weight: 900;
    }

    .kpi-unit {
      font-size: 12px;
      opacity: 0.8;
      font-weight: bold;
    }

    .bi-container {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      padding: 12px;
      gap: 12px;
      align-items: stretch;
    }

    .bi-left-col {
      flex: 1.1;
      min-width: 280px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .bi-main-col {
      flex: 1.8;
      min-width: 320px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .bi-right-col {
      flex: 0.8;
      min-width: 280px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-self: stretch;
    }

    .bi-right-col>.yoy-card {
      flex: 1 1 0% !important;
      min-height: 0;
      max-height: 33%;
      display: flex;
      flex-direction: column;
    }

    .bi-right-col>.maint-card {
      flex: 2 2 0% !important;
      min-height: 0;
      max-height: 67%;
      display: flex;
      flex-direction: column;
    }

    #maintenanceLog {
      flex: 1;
      overflow-y: auto;
    }

    @media (max-width: 1024px) {
      .bi-right-col {
        width: 100%;
        flex: 1;
      }
    }

    .bi-container>div>.card {
      margin-bottom: 0 !important;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .chart-title {
      font-size: 14px !important;
      font-weight: bold !important;
      color: #6b8f71 !important;
      margin-bottom: 8px;
      display: block;
    }

    .chart-wrapper {
      flex: 1;
      position: relative;
      width: 100%;
      min-height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .donut-icon {
      position: absolute;
      font-size: 24px;
      color: #6b8f71;
      opacity: 0.3;
      pointer-events: none;
    }

    #customModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
      padding: 20px;
    }

    #customModal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      width: 100%;
      max-width: 320px;
      border-radius: 20px;
      overflow: hidden;
    }

    .tab-btn {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: bold;
      cursor: pointer;
      white-space: nowrap;
      border: none;
    }

    .tab-btn.active {
      background: #2d4031;
      color: white;
    }

    .tab-btn.inactive {
      background: rgba(255, 255, 255, 0.5);
      color: #6b8f71;
    }

    .dashboard-sidebar {
      width: 200px;
      min-width: 200px;
      background: #2d4031;
      color: white;
      height: 100vh;
      position: sticky;
      top: 0;
      display: flex;
      flex-direction: column;
      padding: 20px 0;
    }

    .nav-item {
      width: 100%;
      padding: 15px 20px;
      text-align: left;
      color: rgba(255, 255, 255, 0.7);
      font-size: 13px;
      border: none;
      background: none;
      cursor: pointer;
      transition: 0.3s;
    }

    .nav-item i {
      margin-right: 10px;
    }

    .nav-item.active {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border-left: 4px solid #6b8f71;
    }

    .dashboard-main-content {
      overflow-y: auto;
      height: 100vh;
    }

    /* --- Portal view styles --- */
    #portalView {
      min-height: 100vh;
      display: none;
    }

    .portal-hero {
      width: 100%;
      min-height: 100vh;
      margin: 0;
      border-radius: 0;
      position: relative;
      justify-content: center;
      color: #ffffff;
      padding: 80px 40px;
      background-image: url('https://images.unsplash.com/photo-1614831884597-ff157b5656f1?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');
      background-size: cover;
      background-position: center center;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .portal-title { font-size: 36px; font-weight: 900; letter-spacing: .06em; }
    .portal-sub { opacity: 0.95; margin-top: 8px; color: rgba(255,255,255,0.95); }
    /* Ensure title/sub are explicitly visible on all devices */
    .portal-title, .portal-sub { color: rgba(234,242,234,1); text-shadow: 0 1px 2px rgba(0,0,0,0.35); }
    .portal-hero > div { position: relative; z-index: 2; }
    .portal-grid {
      display: grid;
      /* narrower cards with centered grid to allow side gutters */
      grid-template-columns: repeat(3, minmax(180px, 260px));
      gap: 24px;
      margin-top: 40px;
      justify-content: center;
    }
    .portal-grid .portal-card {
      background: rgba(245,245,245,0.25);
      border-radius: 12px;
      padding: 24px;
      min-height: 120px;
      text-align: center;
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
      box-shadow: 0 8px 20px rgba(107,143,113,0.06);
      display: flex;
      flex-direction: column;
      justify-content: center;
      color: rgba(234,242,234,1);
    }
    .portal-grid .portal-card i { color: inherit !important; }
    .portal-grid .portal-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 22px 48px rgba(107,143,113,0.12);
      background: rgba(245,245,245,0.45);
    }
    @media (max-width: 1024px) {
      .portal-grid { grid-template-columns: repeat(2, minmax(180px, 320px)); }
    }
    @media (max-width: 640px) {
      .portal-grid { grid-template-columns: repeat(1, 1fr); }
      .portal-hero { padding: calc(24px + env(safe-area-inset-top)) 18px 18px; justify-content: flex-start; }
      .portal-title { font-size: 24px; }
      .portal-sub { font-size: 14px; }
      .portal-grid .portal-card { padding: 18px; min-height: 100px; }
    }

    /* Version card centered on desktop; on narrower screens it becomes full-width */
    .portal-card.version-card { grid-column: 2 / 3; }
    @media (max-width: 1024px) {
      .portal-card.version-card { grid-column: 1 / -1; justify-self: center; max-width: 520px; }
    }

  </style>

</head>

<body style="visibility:hidden">

  <div id="overlay" onclick="closeMenu()"></div>
  <!-- Tractor Side Menu -->
  <div id="tractorSideMenu" class="sideMenu">
    <div class="flex justify-between items-center mb-6">
      <h2 class="font-bold text-lg text-[#6b8f71]">トラクターメニュー</h2>
      <button onclick="closeMenu()" class="text-2xl text-gray-400">&times;</button>
    </div>
    <nav class="space-y-1">
      <button onclick="switchView('portalView')" class="menu-item"><i
          class="fa-solid fa-home w-8 text-lg"></i>Portal</button>
      <button onclick="switchView('tractorView')" class="menu-item"><i
          class="fa-solid fa-tractor w-8 text-lg"></i>ログ入力</button>
      <button onclick="switchView('todayView')" class="menu-item"><i
          class="fa-solid fa-calendar-day w-8 text-lg"></i>本日の稼働状況</button>
      <button onclick="switchView('historyView')" class="menu-item"><i
          class="fa-solid fa-magnifying-glass w-8 text-lg"></i>稼働履歴・検索</button>
      <button onclick="switchView('dashboard')" class="menu-item"><i
          class="fa-solid fa-chart-line w-8 text-lg"></i>DASHBOARD</button>
      <button onclick="switchView('maintenanceMachineListView'); loadMachineList();" class="menu-item"><i
          class="fa-solid fa-toolbox w-8 text-lg"></i>メンテナンス記録</button>
    </nav>
  </div>

  <!-- Planting Side Menu -->
  <div id="plantingSideMenu" class="sideMenu">
    <div class="flex justify-between items-center mb-6">
      <h2 class="font-bold text-lg text-[#4a9b9b]">田植え機メニュー</h2>
      <button onclick="closeMenu()" class="text-2xl text-gray-400">&times;</button>
    </div>
    <nav class="space-y-1">
      <button onclick="switchView('portalView')" class="menu-item"><i
          class="fa-solid fa-home w-8 text-lg"></i>Portal</button>
      <button onclick="switchView('plantingView')" class="menu-item"><i
          class="fa-solid fa-seedling w-8 text-lg"></i>田植え機ログ入力</button>
      <button onclick="switchView('todayViewPlanting')" class="menu-item"><i
          class="fa-solid fa-calendar-day w-8 text-lg"></i>本日の稼働状況</button>
      <button onclick="switchView('historyViewPlanting')" class="menu-item"><i
          class="fa-solid fa-magnifying-glass w-8 text-lg"></i>稼働履歴・検索</button>
      <button onclick="switchView('maintenanceMachineListViewPlanting'); loadMachineListPlanting();" class="menu-item"><i
          class="fa-solid fa-wrench w-8 text-lg"></i>メンテナンス情報</button>
      <button onclick="switchView('dashboardPlanting')" class="menu-item"><i
          class="fa-solid fa-chart-line w-8 text-lg"></i>分析</button>
    </nav>
  </div>

  <!-- Combine Side Menu -->
  <div id="combineSideMenu" class="sideMenu">
    <div class="flex justify-between items-center mb-6">
      <h2 class="font-bold text-lg text-[#c9a961]">コンバインメニュー</h2>
      <button onclick="closeMenu()" class="text-2xl text-gray-400">&times;</button>
    </div>
    <nav class="space-y-1">
      <button onclick="switchView('portalView')" class="menu-item"><i
          class="fa-solid fa-home w-8 text-lg"></i>Portal</button>
      <button onclick="switchView('combineView')" class="menu-item"><i
          class="fa-solid fa-wheat-awn w-8 text-lg"></i>コンバインログ入力</button>
      <button onclick="switchView('todayViewCombine')" class="menu-item"><i
          class="fa-solid fa-calendar-day w-8 text-lg"></i>本日の稼働状況</button>
      <button onclick="switchView('historyViewCombine')" class="menu-item"><i
          class="fa-solid fa-magnifying-glass w-8 text-lg"></i>稼働履歴・検索</button>
      <button onclick="switchView('maintenanceMachineListViewCombine'); loadMachineListCombine();" class="menu-item"><i
          class="fa-solid fa-wrench w-8 text-lg"></i>メンテナンス情報</button>
      <button onclick="switchView('dashboardCombine')" class="menu-item"><i
          class="fa-solid fa-chart-line w-8 text-lg"></i>分析</button>
    </nav>
  </div>

  <!-- Portal/Global Side Menu -->
  <div id="sideMenu">
    <div class="flex justify-between items-center mb-6">
      <h2 class="font-bold text-lg text-[#6b8f71]">メニュー</h2>
      <button onclick="closeMenu()" class="text-2xl text-gray-400">&times;</button>
    </div>
    <nav class="space-y-1">
      <button onclick="switchView('portalView')" class="menu-item"><i
          class="fa-solid fa-home w-8 text-lg"></i>Portal</button>
      <button onclick="switchView('tractorView')" class="menu-item"><i
          class="fa-solid fa-tractor w-8 text-lg"></i>トラクター</button>
      <button onclick="switchView('plantingView')" class="menu-item"><i
          class="fa-solid fa-seedling w-8 text-lg"></i>田植え機</button>
      <button onclick="switchView('combineView')" class="menu-item"><i
          class="fa-solid fa-wheat-awn w-8 text-lg"></i>コンバイン</button>
      <button onclick="switchView('maintenanceMachineListView'); loadMachineList();" class="menu-item"><i
          class="fa-solid fa-toolbox w-8 text-lg"></i>メンテナンス記録</button>
    </nav>
  </div>

  <div id="customModal">
    <div class="modal-content">
      <div class="modal-header bg-[#2d4031] p-4 text-white text-center">
        <h3 id="modalTitle" class="font-bold">CONFIRM</h3>
      </div>
      <div class="modal-body p-6 text-center font-bold" id="modalMessage">メッセージ</div>
      <div class="modal-footer p-4 bg-gray-50 flex gap-2">
        <button class="flex-1 p-2 bg-gray-200 rounded-lg" onclick="closeModal()">戻る</button>
        <button id="modalOkBtn" class="flex-1 p-2 bg-[#6b8f71] text-white rounded-lg">実行する</button>
      </div>
    </div>
  </div>



  <div id="customModal">
    <div class="modal-content">
      <div class="modal-header bg-[#2d4031] p-4 text-white text-center">
        <h3 id="modalTitle" class="font-bold">CONFIRM</h3>
      </div>
      <div class="modal-body p-6 text-center font-bold" id="modalMessage">メッセージ</div>
      <div class="modal-footer p-4 bg-gray-50 flex gap-2">
        <button class="flex-1 p-2 bg-gray-200 rounded-lg" onclick="closeModal()">戻る</button>
        <button id="modalOkBtn" class="flex-1 p-2 bg-[#6b8f71] text-white rounded-lg">実行する</button>
      </div>
    </div>
  </div>



  <div id="mainContainer">
    <!-- Portal View: entry hub -->
    <div id="portalView" class="view">
      <div class="portal-hero" style="min-height:100vh; padding:80px 48px; border-radius:0;">
        <div style="text-align:center; width:100%;">
          <i class="fa-solid fa-seedling text-6xl" style="color: #eaf2ea;"></i>
          <div class="portal-title" style="margin-top:14px;">和農日向 機械管理App</div>
          <div class="portal-sub">機械の稼働・メンテナンス・修理履歴・分析を一元管理</div>
        </div>

        <div class="portal-grid">
          <div class="portal-card" onclick="switchView('tractorView')" style="cursor:pointer;">
            <div class="text-4xl"><i class="fa-solid fa-tractor"></i></div>
            <div class="font-bold mt-2">トラクター</div>
          </div>

          <div class="portal-card" onclick="switchView('plantingView')" style="cursor:pointer;">
            <div class="text-4xl"><i class="fa-solid fa-seedling"></i></div>
            <div class="font-bold mt-2">田植え機</div>
          </div>

          <div class="portal-card" onclick="switchView('combineView')" style="cursor:pointer;">
            <div class="text-4xl"><i class="fa-solid fa-wheat-awn"></i></div>
            <div class="font-bold mt-2">コンバイン</div>
          </div>

          <div class="portal-card" onclick="switchView('maintenanceMachineListView'); loadMachineList();" style="cursor:pointer;">
            <div class="text-4xl"><i class="fa-solid fa-toolbox"></i></div>
            <div class="font-bold mt-2">メンテナンス</div>
          </div>

          <div class="portal-card" onclick="switchView('repairView'); loadRepairDashboard();" style="cursor:pointer;">
            <div class="text-4xl"><i class="fa-solid fa-screwdriver-wrench"></i></div>
            <div class="font-bold mt-2">修理</div>
          </div>

          <div class="portal-card" onclick="showModal('エクスポート', 'エクスポート/印刷機能は準備中です')" style="cursor:pointer;">
            <div class="text-4xl"><i class="fa-solid fa-file-export"></i></div>
            <div class="font-bold mt-2">エクスポート/印刷</div>
          </div>

          <div class="portal-card version-card" onclick="switchView('versionView')" style="cursor:pointer;">
            <div class="text-4xl"><i class="fa-solid fa-info-circle"></i></div>
            <div class="font-bold mt-2">バージョン情報</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tractor Section -->
    <div id="tractor-section">
      <div id="tractorView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">
        <!-- トラクター専用ヘッダー -->
        <header id="pageHeader" class="flex flex-col items-center justify-center py-8 relative">
          <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl text-[#6b8f71] p-2"><i
              class="fa-solid fa-bars"></i></button>
          <i class="fa-solid fa-tractor text-5xl text-[#6b8f71]"></i>
          <h1 class="text-xl font-bold text-[#6b8f71]">和農日向 機械管理アプリ</h1>
        </header>

        <div class="flex items-center gap-2 mb-1 mt-4">
          <i class="fa-solid fa-pen-to-square text-[#6b8f71] text-lg"></i>
          <span class="text-lg font-bold text-[#6b8f71]">ログ入力</span>
        </div>
        <div class="border-t-2 border-[#6b8f71] mb-6 opacity-50"></div>

        <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">機械を選択</label>
        <select id="machineSelect" class="w-full p-3 rounded-lg" onchange="autoFillHour()"></select>
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">作業日</label>
        <input type="date" id="workDate" class="w-full p-3 rounded-lg" />
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">オペレーター</label>
        <select id="operator" class="w-full p-3 rounded-lg">
          <option value="">読込中...</option>
        </select>
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">種別</label>
        <select id="category" class="w-full p-3 rounded-lg">
          <option value="">読込中...</option>
        </select>
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">作業内容</label>
        <select id="work_name" class="w-full p-3 rounded-lg">
          <option value="">先に種別を選択</option>
        </select>
      </div>

      <div class="card">
        <div class="flex space-x-4">
          <div class="flex-1">
            <label class="block text-xs font-bold text-gray-400 mb-1">稼働前</label>
            <input type="number" id="hourBefore" class="w-full p-3 rounded-lg font-bold" step="0.1"
              oninput="calcDiff()" />
          </div>
          <div class="flex-1 min-w-0">
            <label class="block text-xs font-bold text-gray-400 mb-1">稼働後</label>
            <div class="flex items-center gap-2 min-w-0">
              <input type="number" id="hourAfter" class="flex-1 min-w-0 p-3 rounded-lg font-bold" step="0.1" oninput="calcDiff()" />
              <input type="file" id="hourAfterImage" accept="image/*" capture="environment" class="hidden" onchange="handleHourAfterImage(this)">
              <button type="button" onclick="document.getElementById('hourAfterImage').click()"
                class="flex-none p-2 bg-white border rounded-lg text-[#6b8f71] shadow-sm hover:bg-[#f0f7f1]"><i class="fa-solid fa-camera"></i></button>
            </div>
          </div>
        </div>
      </div>

      <div id="hourDiffDisplay" class="text-right font-black text-[#6b8f71] mb-6 text-xl">稼働時間: 0.0 h</div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">給油量 (L)</label>
        <input type="number" id="fuelAmount" class="w-full p-3 rounded-lg" />
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
        <textarea id="memoInput" class="w-full p-3 rounded-lg" rows="2"></textarea>
      </div>

      <button id="saveBtn" class="btn-main" onclick="saveLog()">ログを保存する</button>
      </div>
    </div>

    <!-- Planting Section -->
    <div id="planting-section">
      <!-- 田植え機 Dashboard -->
      <div id="dashboardPlanting" class="view">
        <div class="bi-header">
          <button onclick="openMenu()" class="text-2xl mr-6 hover:opacity-70 transition-opacity"><i
              class="fa-solid fa-bars"></i></button>
          <h1 class="text-lg md:text-2xl font-black tracking-widest flex items-center">
            <i class="fa-solid fa-chart-column mr-3"></i> 2026 PLANTING DASHBOARD
          </h1>
        </div>

        <div class="dashboard-top-bar">
          <div class="main-top-row">
            <div class="kpi-section">
              <div id="machineTabsPlanting" class="flex gap-2 overflow-x-auto pb-1"></div>
              <div class="kpi-grid">
                <div class="kpi-card"><span class="kpi-label">総 稼 働</span>
                  <div class="kpi-value-container"><span class="kpi-value" id="kpi-hours-planting">0.0</span><span
                      class="kpi-unit">h</span></div>
                </div>
                <div class="kpi-card"><span class="kpi-label">給 油</span>
                  <div class="kpi-value-container"><span class="kpi-value" id="kpi-fuel-planting">0.0</span><span
                      class="kpi-unit">L</span></div>
                </div>
                <div class="kpi-card"><span class="kpi-label">燃 費</span>
                  <div class="kpi-value-container"><span class="kpi-value" id="kpi-avg-planting">0.0</span><span
                      class="kpi-unit">L/h</span></div>
                </div>
                <div class="kpi-card"><span class="kpi-label">日 数</span>
                  <div class="kpi-value-container"><span class="kpi-value" id="kpi-days-planting">0</span><span
                      class="kpi-unit">日</span></div>
                </div>
                <div class="kpi-card bg-[#4a6b50]"><span class="kpi-label">状 態</span><span
                    class="kpi-value text-[15px]">良好</span></div>
              </div>
            </div>
            <div class="ranking-section">
              <p class="text-[11px] font-bold text-[#4a9b9b] mb-2 text-center"><i
                  class="fa-solid fa-trophy mr-1"></i>稼働ランキング</p>
              <div id="rankListPlanting" class="flex justify-around items-center"></div>
            </div>
          </div>
        </div>

        <div class="bi-container">
          <div class="bi-left-col">
            <div class="card">
              <p class="chart-title" style="display: flex; align-items: center;">
                <i class="fa-solid fa-screwdriver-wrench" style="margin-right: 8px; color: #4a9b9b;"></i>
                機械別修理コスト
              </p>
              <div class="chart-wrapper relative">
                <canvas id="categoryShareChartPlanting"></canvas>
              </div>
            </div>

            <div class="card">
              <p class="chart-title" style="display: flex; align-items: center;">
                <i class="fa-solid fa-wheat-awn" style="margin-right: 8px; color: #4a9b9b;"></i>
                作物別比率
              </p>
              <div class="chart-wrapper relative">
                <canvas id="taskShareChartPlanting"></canvas>
              </div>
            </div>

            <div class="card">
              <p class="chart-title" style="display: flex; align-items: center;">
                <i class="fa-solid fa-user-check" style="margin-right: 8px; color: #4a9b9b;"></i>
                オペレーター比率
              </p>

              <div class="chart-wrapper relative">
                <canvas id="operatorShareChartPlanting"></canvas>
              </div>
            </div>
          </div>
          <div class="bi-main-col">
            <div class="lg:col-span-2 space-y-4">
              <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <p class="chart-title" style="display: flex; align-items: center;">
                  <i class="fa-solid fa-calendar-days" style="margin-right: 8px; color: #4a9b9b;"></i>
                  月別稼働推移
                </p>
                <div class="relative h-40"> <canvas id="detailChartPlanting"></canvas>
                </div>
              </div>
              <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <p class="chart-title" style="display: flex; align-items: center;">
                  <i class="fa-solid fa-list-check" style="margin-right: 8px; color: #4a9b9b;"></i>
                  作業内容分析
                </p>
                <div class="relative h-[480px]">
                  <canvas id="gradientBarChartPlanting"></canvas>
                </div>
              </div>
            </div>
          </div>

          <div class="bi-right-col">
            <div class="card yoy-card text-center relative">
              <p class="chart-title" style="display: flex; align-items: center; justify-content: center;">
                <i class="fa-solid fa-chart-line" style="margin-right: 8px; color: #4a9b9b;"></i>
                前年実績比 (YoY)
              </p>
              <div class="chart-wrapper relative">
                <canvas id="yearComparisonGaugePlanting"></canvas>
                <div class="absolute inset-0 flex items-center justify-center pt-14">
                  <p id="detailCompareValuePlanting" class="text-2xl font-black text-[#4a9b9b]">--%</p>
                </div>
              </div>
            </div>

            <div class="card maint-card overflow-hidden">
              <p class="chart-title border-b pb-1" style="display: flex; align-items: center;">
                <i class="fa-solid fa-clipboard-list" style="margin-right: 8px; color: #4a9b9b;"></i>
                メンテナンス情報
              </p>
              <div id="maintenanceLogPlanting" class="text-[10px] space-y-2 opacity-80 pt-2 flex-1 overflow-y-auto">
                <p class="italic text-gray-400 text-center py-4">履歴はありません</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="plantingView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">
        <!-- 田植え機専用ヘッダー -->
        <header id="plantingHeader" class="flex flex-col items-center justify-center py-8 relative">
          <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl text-[#4a9b9b] p-2"><i
              class="fa-solid fa-bars"></i></button>
          <i class="fa-solid fa-seedling text-5xl text-[#4a9b9b]"></i>
          <h1 class="text-xl font-bold text-[#4a9b9b]">和農日向 機械管理アプリ</h1>
        </header>

        <div class="flex items-center gap-2 mb-1 mt-4">
          <i class="fa-solid fa-seedling text-[#4a9b9b] text-lg"></i>
          <span class="text-lg font-bold text-[#4a9b9b]">田植え機ログ入力</span>
        </div>
        <div class="border-t-2 border-[#4a9b9b] mb-6 opacity-50"></div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">機械を選択</label>
          <select id="taue_machineSelect" class="w-full p-3 rounded-lg" onchange="taue_autoFillHour()"></select>
        </div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">作業日</label>
          <input type="date" id="taue_workDate" class="w-full p-3 rounded-lg" />
        </div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">オペレーター</label>
          <select id="taue_operator" class="w-full p-3 rounded-lg">
            <option value="">読込中...</option>
          </select>
        </div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">作業内容</label>
          <select id="taue_work_name" class="w-full p-3 rounded-lg">
            <option value="">読込中...</option>
          </select>
        </div>

        <div class="card">
          <div class="flex gap-2">
            <div style="flex: 1 1 0; min-width: 0;">
              <label class="block text-xs font-bold text-gray-400 mb-1">稼働前</label>
              <input type="number" id="taue_hourBefore" class="w-full p-3 rounded-lg font-bold" step="0.1"
                oninput="taue_calcDiff()" />
            </div>
            <div style="flex: 1 1 0; min-width: 0;">
              <label class="block text-xs font-bold text-gray-400 mb-1">稼働後</label>
              <input type="number" id="taue_hourAfter" class="w-full p-3 rounded-lg font-bold" step="0.1" oninput="taue_calcDiff()" />
            </div>
            <div class="flex items-end">
              <input type="file" id="taue_hourAfterImage" accept="image/*" capture="environment" class="hidden" onchange="taue_handleHourAfterImage(this)">
              <button type="button" onclick="document.getElementById('taue_hourAfterImage').click()"
                class="p-3 bg-white border rounded-lg text-[#4a9b9b] shadow-sm hover:bg-[#e0f2f2]"><i class="fa-solid fa-camera"></i></button>
            </div>
          </div>
        </div>

        <div id="taue_hourDiffDisplay" class="text-right font-black text-[#4a9b9b] mb-6 text-xl">稼働時間: 0.0 h</div>

        <div class="card">
          <div class="flex gap-4">
            <div class="flex-1">
              <label class="block text-xs font-bold text-gray-400 mb-1">油種</label>
              <select id="taue_fuelType" class="w-full p-3 rounded-lg">
                <option value="">読込中...</option>
              </select>
            </div>
            <div class="flex-[2]">
              <label class="block text-xs font-bold text-gray-400 mb-1">給油量 (L)</label>
              <input type="number" id="taue_fuelAmount" class="w-full p-3 rounded-lg" />
            </div>
          </div>
        </div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
          <textarea id="taue_memoInput" class="w-full p-3 rounded-lg" rows="2"></textarea>
        </div>

        <button id="taue_saveBtn" class="btn-main" onclick="taue_saveLog()">ログを保存する</button>
      </div>

      <!-- 本日の稼働状況 (田植え機) -->
      <div id="todayViewPlanting" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">
        <!-- 田植え機専用ヘッダー -->
        <header class="flex flex-col items-center justify-center py-8 relative">
          <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl text-[#4a9b9b] p-2"><i
              class="fa-solid fa-bars"></i></button>
          <i class="fa-solid fa-seedling text-5xl text-[#4a9b9b]"></i>
          <h1 class="text-xl font-bold text-[#4a9b9b]">和農日向 機械管理アプリ</h1>
        </header>

        <div class="flex items-center gap-2 mb-4 font-bold text-[#4a9b9b] border-b-2 border-[#4a9b9b] pb-2 text-lg"><i
            class="fa-solid fa-calendar-day"></i> 本日の稼働状況</div>
        <div id="todayLogListPlanting" class="space-y-4"></div>
        <button onclick="switchView('plantingView')" class="btn-sub">TOPに戻る</button>
      </div>

      <!-- 稼働履歴・検索 (田植え機) -->
      <div id="historyViewPlanting" class="view px-4 py-6 max-w-3xl mx-auto pb-10">
        <!-- 田植え機専用ヘッダー -->
        <header class="flex flex-col items-center justify-center py-8 relative">
          <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl text-[#4a9b9b] p-2"><i
              class="fa-solid fa-bars"></i></button>
          <i class="fa-solid fa-seedling text-5xl text-[#4a9b9b]"></i>
          <h1 class="text-xl font-bold text-[#4a9b9b]">和農日向 機械管理アプリ</h1>
        </header>

        <div class="flex items-center gap-2 mb-6 font-bold text-[#4a9b9b] border-b-2 border-[#4a9b9b] pb-3 text-lg w-full">
          <i class="fa-solid fa-magnifying-glass"></i>
          <span>稼働履歴検索</span>
        </div>

        <div class="card space-y-3 text-sm mb-6">
          <div class="grid grid-cols-2 gap-3">
            <div class="flex flex-col gap-1">
              <label class="text-[10px] text-gray-400 font-bold ml-1">対象月</label>
              <input type="month" id="filterMonthPlanting" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm">
            </div>
            <div class="flex flex-col gap-1">
              <label class="text-[10px] text-gray-400 font-bold ml-1">機械</label>
              <select id="filterMachinePlanting" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm">
                <option value="">すべての機械</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3 mt-1">
            <div class="flex flex-col gap-1">
              <label class="text-[10px] text-gray-400 font-bold ml-1">オペレーター</label>
              <select id="filterOperatorPlanting" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm text-sm text-gray-600">
                <option value="">全オペレーター</option>
              </select>
            </div>

            <div class="flex flex-col gap-1">
              <label class="text-[10px] text-gray-400 font-bold ml-1">作業内容</label>
              <select id="filterCategoryPlanting" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm text-sm text-gray-600">
                <option value="">全作業内容</option>
              </select>
            </div>
          </div>

          <button onclick="loadLogsPlanting('historyLogListPlanting', false)" class="btn-main mt-2 shadow-md">
            検索を実行
          </button>
        </div>

        <div class="flex justify-end items-center mb-4 px-1">
          <div id="historyTotalHoursPlanting" class="text-sm font-black text-[#4a9b9b] opacity-80 bg-white px-4 py-2 rounded-full shadow-sm">
            合計: 0.0 h
          </div>
        </div>

        <div id="historyLogListPlanting" class="space-y-4"></div>

        <button onclick="switchView('plantingView')" class="btn-sub mt-8">
          <i class="fa-solid fa-house mr-2"></i>TOPに戻る
        </button>
      </div>
    </div>

    <!-- 田植え機 メンテナンス機械一覧 -->
    <div id="maintenanceMachineListViewPlanting" class="view px-4 max-w-3xl mx-auto pb-10">
      <!-- 田植え機専用ヘッダー -->
      <header class="flex flex-col items-center justify-center py-8 relative">
        <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl text-[#4a9b9b] p-2"><i
            class="fa-solid fa-bars"></i></button>
        <i class="fa-solid fa-seedling text-5xl text-[#4a9b9b]"></i>
        <h1 class="text-xl font-bold text-[#4a9b9b]">和農日向 機械管理アプリ</h1>
      </header>

      <div class="flex items-center gap-2 mb-4 font-bold text-[#4a9b9b] border-b-2 border-[#4a9b9b] pb-2 text-lg">
        <i class="fa-solid fa-wrench"></i> 田植え機 メンテナンス記録
      </div>

      <div id="maintenanceMachineGridPlanting" class="space-y-6">
      </div>

      <button onclick="switchView('plantingView')" class="btn-sub mt-10 w-full">
        <i class="fa-solid fa-house mr-2"></i>TOPに戻る
      </button>
    </div>

    <!-- 田植え機 メンテナンス詳細 -->
    <div id="maintenanceDetailViewPlanting" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">
      <!-- 田植え機専用ヘッダー -->
      <header class="flex flex-col items-center justify-center py-8 relative">
        <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl text-[#4a9b9b] p-2"><i
            class="fa-solid fa-bars"></i></button>
        <i class="fa-solid fa-seedling text-5xl text-[#4a9b9b]"></i>
        <h1 class="text-xl font-bold text-[#4a9b9b]">和農日向 機械管理アプリ</h1>
      </header>

      <!-- タイトル（機械名は JS で差し替える） -->
      <div class="flex items-center gap-2 mb-4 font-bold text-[#4a9b9b] border-b-2 border-[#4a9b9b] pb-2 text-lg">
        <i class="fa-solid fa-seedling"></i>
        <span id="maintenanceMachineNamePlanting">機械名</span>
      </div>

      <div class="card mb-4">
        <p class="font-bold text-sm text-gray-500 mb-2">メンテナンス進捗</p>
        <div id="maintenanceSummaryPlanting" class="text-xs mt-1">
          未着手
        </div>
      </div>

      <div class="card mb-4">
        <p class="font-bold text-sm text-gray-500 mb-2">点検項目</p>
        <div id="maintenanceChecklistPlanting" class="space-y-2">
        </div>
      </div>

      <!-- 作業履歴タイムライン -->
      <div class="card mb-4">
        <p class="font-bold text-sm text-gray-500 mb-2">作業履歴</p>
        <div id="maintenanceHistoryLogPlanting" class="space-y-3 text-sm">
          <p class="italic text-gray-400 text-center py-4">履歴はありません</p>
        </div>
      </div>

      <div class="card mb-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
        <p class="font-bold text-sm text-[#4a9b9b] mb-4 flex items-center">
          <i class="fas fa-tools mr-2"></i>部品交換を記録
        </p>

        <label class="block text-xs font-bold text-gray-400 mb-1">交換部品・項目名</label>
        <input id="newMaintenanceItemPlanting" type="text"
          class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#4a9b9b] outline-none"
          placeholder="例：オイルエレメント">

        <label class="block text-xs font-bold text-gray-400 mb-1">担当者</label>
        <select id="newMaintenanceOperatorPlanting"
          class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#4a9b9b] outline-none">
          <option value="">担当者を選択</option>
        </select>

        <label class="block text-xs font-bold text-gray-400 mb-1">状態</label>
        <select id="newMaintenanceStatusPlanting"
          class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#4a9b9b] outline-none">
          <option value="done">完了</option>
          <option value="progress">作業中</option>
        </select>

        <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
        <textarea id="newMaintenanceMemoPlanting" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-4" rows="2"
          placeholder="備考"></textarea>

        <button onclick="saveMaintenanceRecordPlanting()"
          class="btn-main w-full py-3 bg-[#4a9b9b] text-white rounded-lg font-bold hover:bg-[#3a8080] transition-all shadow-md">
          部品交換を保存する
        </button>
      </div>

      <div class="flex justify-center w-full mt-6 mb-8">
        <button onclick="switchView('maintenanceMachineListViewPlanting')"
          class="bg-gray-500 text-white px-6 py-2.5 rounded-lg hover:bg-gray-600 transition-colors whitespace-nowrap text-[13px] sm:text-sm shadow-md flex items-center justify-center">
          <i class="fas fa-arrow-left mr-2"></i>
          <span>機械一覧ページに戻る</span>
        </button>
      </div>
    </div>
    </div>

    <!-- Combine Section -->
    <div id="combine-section">
      <div id="combineView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">
        <!-- コンバイン専用ヘッダー -->
        <header class="flex flex-col items-center justify-center py-8 relative">
          <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl text-[#c9a961] p-2"><i
              class="fa-solid fa-bars"></i></button>
          <i class="fa-solid fa-wheat-awn text-5xl text-[#c9a961]"></i>
          <h1 class="text-xl font-bold text-[#c9a961]">和農日向 機械管理アプリ</h1>
        </header>

        <div class="flex items-center gap-2 mb-1 mt-4">
          <i class="fa-solid fa-wheat-awn text-[#c9a961] text-lg"></i>
          <span class="text-lg font-bold text-[#c9a961]">コンバインログ入力</span>
        </div>
        <div class="border-t-2 border-[#c9a961] mb-6 opacity-50"></div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">機械を選択</label>
          <select id="combine_machineSelect" class="w-full p-3 rounded-lg" onchange="combine_autoFillHour()"></select>
        </div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">作業日</label>
          <input type="date" id="combine_workDate" class="w-full p-3 rounded-lg" />
        </div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">オペレーター</label>
          <select id="combine_operator" class="w-full p-3 rounded-lg">
            <option value="">読込中...</option>
          </select>
        </div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">作業内容</label>
          <select id="combine_work_name" class="w-full p-3 rounded-lg">
            <option value="">読込中...</option>
          </select>
        </div>

        <div class="card">
          <div class="flex gap-2">
            <div style="flex: 1 1 0; min-width: 0;">
              <label class="block text-xs font-bold text-gray-400 mb-1">稼働前</label>
              <input type="number" id="combine_hourBefore" class="w-full p-3 rounded-lg font-bold" step="0.1"
                oninput="combine_calcDiff()" />
            </div>
            <div style="flex: 1 1 0; min-width: 0;">
              <label class="block text-xs font-bold text-gray-400 mb-1">稼働後</label>
              <input type="number" id="combine_hourAfter" class="w-full p-3 rounded-lg font-bold" step="0.1" oninput="combine_calcDiff()" />
            </div>
            <div class="flex items-end">
              <input type="file" id="combine_hourAfterImage" accept="image/*" capture="environment" class="hidden" onchange="combine_handleHourAfterImage(this)">
              <button type="button" onclick="document.getElementById('combine_hourAfterImage').click()"
                class="p-3 bg-white border rounded-lg text-[#c9a961] shadow-sm hover:bg-[#faf6ed]"><i class="fa-solid fa-camera"></i></button>
            </div>
          </div>
        </div>

        <div id="combine_hourDiffDisplay" class="text-right font-black text-[#c9a961] mb-6 text-xl">稼働時間: 0.0 h</div>

        <div class="card">
          <div class="flex gap-4">
            <div class="flex-1">
              <label class="block text-xs font-bold text-gray-400 mb-1">油種</label>
              <select id="combine_fuelType" class="w-full p-3 rounded-lg">
                <option value="">読込中...</option>
              </select>
            </div>
            <div class="flex-[2]">
              <label class="block text-xs font-bold text-gray-400 mb-1">給油量 (L)</label>
              <input type="number" id="combine_fuelAmount" class="w-full p-3 rounded-lg" />
            </div>
          </div>
        </div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
          <textarea id="combine_memoInput" class="w-full p-3 rounded-lg" rows="2"></textarea>
        </div>

        <button id="combine_saveBtn" class="btn-main" onclick="combine_saveLog()">ログを保存する</button>
      </div>

      <!-- 本日の稼働状況 (コンバイン) -->
      <div id="todayViewCombine" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">
        <!-- コンバイン専用ヘッダー -->
        <header class="flex flex-col items-center justify-center py-8 relative">
          <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl text-[#c9a961] p-2"><i
              class="fa-solid fa-bars"></i></button>
          <i class="fa-solid fa-wheat-awn text-5xl text-[#c9a961]"></i>
          <h1 class="text-xl font-bold text-[#c9a961]">和農日向 機械管理アプリ</h1>
        </header>

        <div class="flex items-center gap-2 mb-4 font-bold text-[#c9a961] border-b-2 border-[#c9a961] pb-2 text-lg"><i
            class="fa-solid fa-calendar-day"></i> 本日の稼働状況</div>
        <div id="todayLogListCombine" class="space-y-4"></div>
        <button onclick="switchView('combineView')" class="btn-sub">TOPに戻る</button>
      </div>

      <!-- 稼働履歴・検索 (コンバイン) -->
      <div id="historyViewCombine" class="view px-4 py-6 max-w-3xl mx-auto pb-10">
        <!-- コンバイン専用ヘッダー -->
        <header class="flex flex-col items-center justify-center py-8 relative">
          <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl text-[#c9a961] p-2"><i
              class="fa-solid fa-bars"></i></button>
          <i class="fa-solid fa-wheat-awn text-5xl text-[#c9a961]"></i>
          <h1 class="text-xl font-bold text-[#c9a961]">和農日向 機械管理アプリ</h1>
        </header>

        <div class="flex items-center gap-2 mb-6 font-bold text-[#c9a961] border-b-2 border-[#c9a961] pb-3 text-lg w-full">
          <i class="fa-solid fa-magnifying-glass"></i>
          <span>稼働履歴検索</span>
        </div>

        <div class="card space-y-3 text-sm mb-6">
          <div class="grid grid-cols-2 gap-3">
            <div class="flex flex-col gap-1">
              <label class="text-[10px] text-gray-400 font-bold ml-1">対象月</label>
              <input type="month" id="filterMonthCombine" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm">
            </div>
            <div class="flex flex-col gap-1">
              <label class="text-[10px] text-gray-400 font-bold ml-1">機械</label>
              <select id="filterMachineCombine" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm">
                <option value="">すべての機械</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3 mt-1">
            <div class="flex flex-col gap-1">
              <label class="text-[10px] text-gray-400 font-bold ml-1">オペレーター</label>
              <select id="filterOperatorCombine" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm text-sm text-gray-600">
                <option value="">全オペレーター</option>
              </select>
            </div>

            <div class="flex flex-col gap-1">
              <label class="text-[10px] text-gray-400 font-bold ml-1">作業内容</label>
              <select id="filterCategoryCombine" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm text-sm text-gray-600">
                <option value="">全作業内容</option>
              </select>
            </div>
          </div>

          <button onclick="loadLogsCombine('historyLogListCombine', false)" class="btn-main mt-2 shadow-md">
            検索を実行
          </button>
        </div>

        <div class="flex justify-end items-center mb-4 px-1">
          <div id="historyTotalHoursCombine" class="text-sm font-black text-[#c9a961] opacity-80 bg-white px-4 py-2 rounded-full shadow-sm">
            合計: 0.0 h
          </div>
        </div>

        <div id="historyLogListCombine" class="space-y-4"></div>

        <button onclick="switchView('combineView')" class="btn-sub mt-8">
          <i class="fa-solid fa-house mr-2"></i>TOPに戻る
        </button>
      </div>

      <!-- コンバイン メンテナンス機械一覧 -->
      <div id="maintenanceMachineListViewCombine" class="view px-4 max-w-3xl mx-auto pb-10">
        <!-- コンバイン専用ヘッダー -->
        <header class="flex flex-col items-center justify-center py-8 relative">
          <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl text-[#c9a961] p-2"><i
              class="fa-solid fa-bars"></i></button>
          <i class="fa-solid fa-wheat-awn text-5xl text-[#c9a961]"></i>
          <h1 class="text-xl font-bold text-[#c9a961]">和農日向 機械管理アプリ</h1>
        </header>

        <div class="flex items-center gap-2 mb-4 font-bold text-[#c9a961] border-b-2 border-[#c9a961] pb-2 text-lg">
          <i class="fa-solid fa-wrench"></i> コンバイン メンテナンス記録
        </div>

        <div id="maintenanceMachineGridCombine" class="space-y-6">
        </div>

        <button onclick="switchView('combineView')" class="btn-sub mt-10 w-full">
          <i class="fa-solid fa-house mr-2"></i>TOPに戻る
        </button>
      </div>

      <!-- コンバイン メンテナンス詳細 -->
      <div id="maintenanceDetailViewCombine" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">
        <!-- コンバイン専用ヘッダー -->
        <header class="flex flex-col items-center justify-center py-8 relative">
          <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl text-[#c9a961] p-2"><i
              class="fa-solid fa-bars"></i></button>
          <i class="fa-solid fa-wheat-awn text-5xl text-[#c9a961]"></i>
          <h1 class="text-xl font-bold text-[#c9a961]">和農日向 機械管理アプリ</h1>
        </header>

        <!-- タイトル（機械名は JS で差し替える） -->
        <div class="flex items-center gap-2 mb-4 font-bold text-[#c9a961] border-b-2 border-[#c9a961] pb-2 text-lg">
          <i class="fa-solid fa-wheat-awn"></i>
          <span id="maintenanceMachineNameCombine">機械名</span>
        </div>

        <div class="card mb-4">
          <p class="font-bold text-sm text-gray-500 mb-2">メンテナンス進捗</p>
          <div id="maintenanceSummaryCombine" class="text-xs mt-1">
            未着手
          </div>
        </div>

        <div class="card mb-4">
          <p class="font-bold text-sm text-gray-500 mb-2">点検項目</p>
          <div id="maintenanceChecklistCombine" class="space-y-2">
          </div>
        </div>

        <!-- 作業履歴タイムライン -->
        <div class="card mb-4">
          <p class="font-bold text-sm text-gray-500 mb-2">作業履歴</p>
          <div id="maintenanceHistoryLogCombine" class="space-y-3 text-sm">
            <p class="italic text-gray-400 text-center py-4">履歴はありません</p>
          </div>
        </div>

        <div class="card mb-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
          <p class="font-bold text-sm text-[#c9a961] mb-4 flex items-center">
            <i class="fas fa-tools mr-2"></i>部品交換を記録
          </p>

          <label class="block text-xs font-bold text-gray-400 mb-1">交換部品・項目名</label>
          <input id="newMaintenanceItemCombine" type="text"
            class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#c9a961] outline-none"
            placeholder="例：オイルエレメント">

          <label class="block text-xs font-bold text-gray-400 mb-1">担当者</label>
          <select id="newMaintenanceOperatorCombine"
            class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#c9a961] outline-none">
            <option value="">担当者を選択</option>
          </select>

          <label class="block text-xs font-bold text-gray-400 mb-1">状態</label>
          <select id="newMaintenanceStatusCombine"
            class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#c9a961] outline-none">
            <option value="done">完了</option>
            <option value="progress">作業中</option>
          </select>

          <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
          <textarea id="newMaintenanceMemoCombine" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-4" rows="2"
            placeholder="備考"></textarea>

          <button onclick="saveMaintenanceRecordCombine()"
            class="btn-main w-full py-3 bg-[#c9a961] text-white rounded-lg font-bold hover:bg-[#b8985a] transition-all shadow-md">
            部品交換を保存する
          </button>
        </div>

        <div class="flex justify-center w-full mt-6 mb-8">
          <button onclick="switchView('maintenanceMachineListViewCombine')"
            class="bg-gray-500 text-white px-6 py-2.5 rounded-lg hover:bg-gray-600 transition-colors whitespace-nowrap text-[13px] sm:text-sm shadow-md flex items-center justify-center">
            <i class="fas fa-arrow-left mr-2"></i>
            <span>機械一覧ページに戻る</span>
          </button>
        </div>
      </div>

      <!-- コンバイン Dashboard (準備中) -->
      <div id="dashboardCombine" class="view">
        <div class="bi-header">
          <button onclick="openMenu()" class="text-2xl mr-6 hover:opacity-70 transition-opacity"><i
              class="fa-solid fa-bars"></i></button>
          <h1 class="text-lg md:text-2xl font-black tracking-widest flex items-center">
            <i class="fa-solid fa-chart-column mr-3"></i> 2026 COMBINE DASHBOARD
          </h1>
        </div>
        <div class="card mt-8">
          <p class="text-center text-gray-500 py-8">準備中...</p>
        </div>
      </div>
    </div>

    <div id="dashboard" class="view">
      <div class="bi-header">
        <button onclick="openMenu()" class="text-2xl mr-6 hover:opacity-70 transition-opacity"><i
            class="fa-solid fa-bars"></i></button>
        <h1 class="text-lg md:text-2xl font-black tracking-widest flex items-center">
          <i class="fa-solid fa-chart-column mr-3"></i> 2026 OPERATION DASHBOARD
        </h1>
      </div>

      <div class="dashboard-top-bar">
        <div class="main-top-row">
          <div class="kpi-section">
            <div id="machineTabs" class="flex gap-2 overflow-x-auto pb-1"></div>
            <div class="kpi-grid">
              <div class="kpi-card"><span class="kpi-label">総 稼 働</span>
                <div class="kpi-value-container"><span class="kpi-value" id="kpi-hours">0.0</span><span
                    class="kpi-unit">h</span></div>
              </div>
              <div class="kpi-card"><span class="kpi-label">給 油</span>
                <div class="kpi-value-container"><span class="kpi-value" id="kpi-fuel">0.0</span><span
                    class="kpi-unit">L</span></div>
              </div>
              <div class="kpi-card"><span class="kpi-label">燃 費</span>
                <div class="kpi-value-container"><span class="kpi-value" id="kpi-avg">0.0</span><span
                    class="kpi-unit">L/h</span></div>
              </div>
              <div class="kpi-card"><span class="kpi-label">日 数</span>
                <div class="kpi-value-container"><span class="kpi-value" id="kpi-days">0</span><span
                    class="kpi-unit">日</span></div>
              </div>
              <div class="kpi-card bg-[#4a6b50]"><span class="kpi-label">状 態</span><span
                  class="kpi-value text-[15px]">良好</span></div>
            </div>
          </div>
          <div class="ranking-section">
            <p class="text-[11px] font-bold text-[#6b8f71] mb-2 text-center"><i
                class="fa-solid fa-trophy mr-1"></i>稼働ランキング</p>
            <div id="rankList" class="flex justify-around items-center"></div>
          </div>
        </div>
      </div>

      <div class="bi-container">
        <div class="bi-left-col">
          <div class="card">
            <p class="chart-title" style="display: flex; align-items: center;">
              <i class="fa-solid fa-screwdriver-wrench" style="margin-right: 8px; color: #6b8f71;"></i>
              機械別修理コスト
            </p>
            <div class="chart-wrapper relative">
              <canvas id="categoryShareChart"></canvas>
            </div>
          </div>

          <div class="card">
            <p class="chart-title" style="display: flex; align-items: center;">
              <i class="fa-solid fa-wheat-awn" style="margin-right: 8px; color: #6b8f71;"></i>
              作物別比率
            </p>
            <div class="chart-wrapper relative">
              <canvas id="taskShareChart"></canvas>
            </div>
          </div>

          <div class="card">
            <p class="chart-title" style="display: flex; align-items: center;">
              <i class="fa-solid fa-user-check" style="margin-right: 8px; color: #6b8f71;"></i>
              オペレーター比率
            </p>

            <div class="chart-wrapper relative">
              <canvas id="operatorShareChart"></canvas>
            </div>
          </div>
        </div>
        <div class="bi-main-col">
          <div class="lg:col-span-2 space-y-4">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
              <p class="chart-title" style="display: flex; align-items: center;">
                <i class="fa-solid fa-calendar-days" style="margin-right: 8px; color: #6b8f71;"></i>
                月別稼働推移
              </p>
              <div class="relative h-40"> <canvas id="detailChart"></canvas>
              </div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
              <p class="chart-title" style="display: flex; align-items: center;">
                <i class="fa-solid fa-list-check" style="margin-right: 8px; color: #6b8f71;"></i>
                作業内容分析
              </p>
              <div class="relative h-[480px]">
                <canvas id="gradientBarChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="bi-right-col">
          <div class="card yoy-card text-center relative">
            <p class="chart-title" style="display: flex; align-items: center; justify-content: center;">
              <i class="fa-solid fa-chart-line" style="margin-right: 8px; color: #6b8f71;"></i>
              前年実績比 (YoY)
            </p>
            <div class="chart-wrapper relative">
              <canvas id="yearComparisonGauge"></canvas>
              <div class="absolute inset-0 flex items-center justify-center pt-14">
                <p id="detailCompareValue" class="text-2xl font-black text-[#6b8f71]">--%</p>
              </div>
            </div>
          </div>

          <div class="card maint-card overflow-hidden">
            <p class="chart-title border-b pb-1" style="display: flex; align-items: center;">
              <i class="fa-solid fa-clipboard-list" style="margin-right: 8px; color: #6b8f71;"></i>
              メンテナンス情報
            </p>
            <div id="maintenanceLog" class="text-[10px] space-y-2 opacity-80 pt-2 flex-1 overflow-y-auto">
              <p class="italic text-gray-400 text-center py-4">履歴はありません</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="todayView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">
      <div class="flex items-center gap-2 mb-4 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-2 text-lg"><i
          class="fa-solid fa-calendar-day"></i> 本日の稼働状況</div>
      <div id="todayLogList" class="space-y-4"></div>
      <button onclick="switchView('tractorView')" class="btn-sub">TOPに戻る</button>
    </div>

    <div id="historyView" class="view px-4 py-6 max-w-3xl mx-auto pb-10">

      <div
        class="flex items-center gap-2 mb-6 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-3 text-lg w-full">
        <i class="fa-solid fa-magnifying-glass"></i>
        <span>稼働履歴検索</span>
      </div>

      <div class="card space-y-3 text-sm mb-6">
        <div class="grid grid-cols-2 gap-3">
          <div class="flex flex-col gap-1">
            <label class="text-[10px] text-gray-400 font-bold ml-1">対象月</label>
            <input type="month" id="filterMonth" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm">
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-[10px] text-gray-400 font-bold ml-1">機械</label>
            <select id="filterMachine" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm">
              <option value="">すべての機械</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mt-1">
          <div class="flex flex-col gap-1">
            <label class="text-[10px] text-gray-400 font-bold ml-1">オペレーター</label>
            <select id="filterOperator"
              class="p-3 rounded-lg w-full border border-gray-100 shadow-sm text-sm text-gray-600">
              <option value="">全オペレーター</option>
            </select>
          </div>

          <div class="flex flex-col gap-1">
            <label class="text-[10px] text-gray-400 font-bold ml-1">作業内容</label>
            <select id="filterCategory"
              class="p-3 rounded-lg w-full border border-gray-100 shadow-sm text-sm text-gray-600">
              <option value="">全作業内容</option>
            </select>
          </div>
        </div>

        <button onclick="loadLogs('historyLogList', false)" class="btn-main mt-2 shadow-md">
          検索を実行
        </button>
      </div>

      <div class="flex justify-end items-center mb-4 px-1">
        <div id="historyTotalHours"
          class="text-sm font-black text-[#6b8f71] opacity-80 bg-white px-4 py-2 rounded-full shadow-sm">
          合計: 0.0 h
        </div>
      </div>

      <div id="historyLogList" class="space-y-4"></div>

      <button onclick="switchView('tractorView')" class="btn-sub mt-8">
        <i class="fa-solid fa-house mr-2"></i>TOPに戻る
      </button>
    </div>

    <div id="maintenanceMachineListView" class="view px-4 max-w-3xl mx-auto pb-10">
      <!-- トラクター専用ヘッダー -->
      <header class="flex flex-col items-center justify-center py-8 relative">
        <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl text-[#6b8f71] p-2"><i
            class="fa-solid fa-bars"></i></button>
        <i class="fa-solid fa-tractor text-5xl text-[#6b8f71]"></i>
        <h1 class="text-xl font-bold text-[#6b8f71]">和農日向 機械管理アプリ</h1>
      </header>

      <div class="flex items-center gap-2 mb-4 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-2 text-lg">
        <i class="fa-solid fa-wrench"></i> トラクター メンテナンス記録
      </div>

      <div id="maintenanceMachineGrid" class="space-y-6">
      </div>

      <button onclick="switchView('tractorView')" class="btn-sub mt-10 w-full">
        <i class="fa-solid fa-house mr-2"></i>TOPに戻る
      </button>
    </div>

    <div id="repairView" class="view px-4 max-w-5xl mx-auto pb-16 hidden" style="background-color: #e2e8e3;">
      <!-- トラクター専用ヘッダー -->
      <header class="flex flex-col items-center justify-center py-8 relative">
        <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl text-[#6b8f71] p-2"><i
            class="fa-solid fa-bars"></i></button>
        <i class="fa-solid fa-tractor text-5xl text-[#6b8f71]"></i>
        <h1 class="text-xl font-bold text-[#6b8f71]">和農日向 機械管理アプリ</h1>
      </header>

      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl md:text-2xl font-extrabold text-[#6b8f71] flex items-center gap-2">
          <i class="fa-solid fa-screwdriver-wrench"></i> 修理履歴
        </h2>
        <button onclick="switchView('invoiceOCRView'); populateMachineSelect();"
          class="bg-[#6b8f71] text-white px-5 py-2 rounded-full shadow-lg active:scale-95 transition-all text-xs font-bold">
          <i class="fa-solid fa-plus mr-1"></i> 新規登録
        </button>
      </div>

      <div class="bg-gradient-to-br from-[#6b8f71] to-[#4b634d] rounded-[2rem] p-6 text-white shadow-xl mb-8 relative overflow-hidden">
        <div class="relative z-10">
          <p class="text-[#d1e0d3] text-[10px] md:text-xs font-medium mb-1 uppercase tracking-widest">2026年度 累計修理費</p>
          <h3 id="totalRepairCost" class="text-3xl md:text-5xl font-black tracking-wider">¥ 0</h3>
          <div class="mt-4 flex gap-4 text-[10px] text-[#d1e0d3]">
            <span><i class="fa-solid fa-tractor mr-1"></i> トラクターのみの修理費</span>
          </div>
        </div>
        <i class="fa-solid fa-gears absolute -right-4 -bottom-4 text-white/10 text-7xl md:text-8xl rotate-12"></i>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col">
          <div class="flex items-center gap-2 mb-4 text-[#6b8f71] font-bold border-b border-gray-50 pb-2 text-sm">
            <i class="fa-solid fa-calendar-days"></i> 年ごとの修理費
          </div>
          <div id="yearlyRepairContainer" class="space-y-2 flex-grow text-sm">
          </div>
        </div>

        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col">
          <div class="flex items-center gap-2 mb-4 text-[#6b8f71] font-bold border-b border-gray-50 pb-2 text-sm">
            <i class="fa-solid fa-microchip"></i> 機械ごとの集計
          </div>
          <div id="machineRepairContainer" class="space-y-2 flex-grow text-sm">
          </div>
        </div>

        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col">
          <div class="flex items-center gap-2 mb-4 text-[#6b8f71] font-bold border-b border-gray-50 pb-2 text-sm">
            <i class="fa-solid fa-clock-rotate-left"></i> 最近の修理
          </div>
          <div id="recentRepairContainer" class="space-y-3 flex-grow">
          </div>
        </div>
      </div>

      <div class="flex justify-center w-full mt-6 mb-8">
        <button onclick="switchView('tractorView')" class="btn-sub w-full">
          <i class="fa-solid fa-house mr-2"></i>TOPに戻る
        </button>
      </div>
    </div>

    <div id="invoiceOCRView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10 hidden">
      <!-- トラクター専用ヘッダー -->
      <header class="flex flex-col items-center justify-center py-8 relative">
        <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl text-[#6b8f71] p-2"><i
            class="fa-solid fa-bars"></i></button>
        <i class="fa-solid fa-tractor text-5xl text-[#6b8f71]"></i>
        <h1 class="text-xl font-bold text-[#6b8f71]">和農日向 機械管理アプリ</h1>
      </header>

      <div class="flex items-center gap-2 mb-4 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-2 text-lg">
        <i class="fa-solid fa-screwdriver-wrench"></i> 修理の登録
      </div>

      <!-- 請求書の読み取り -->
      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">請求書・領収書の撮影</label>

        <input type="file" id="invoiceImage" accept="image/*" capture="environment" class="hidden"
          onchange="previewInvoice(this)">

        <button onclick="document.getElementById('invoiceImage').click()"
          class="w-full py-4 border-2 border-dashed border-[#6b8f71] rounded-lg text-[#6b8f71] flex flex-col items-center gap-2 hover:bg-[#f0f7f1] transition-colors">
          <i class="fa-solid fa-camera text-2xl"></i>
          <span class="text-sm font-bold">カメラを起動 / 画像を選択</span>
        </button>

        <div id="invoicePreviewArea" class="mt-4 hidden text-center">
          <img id="invoicePreviewImg" src="" class="w-full rounded-lg shadow-md mb-2 opacity-50">
          <p class="text-[10px] text-gray-500">解析用プレビュー（画像は保存されません）</p>
        </div>
      </div>

      <!-- 種別選択 -->
      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">種別</label>
        <select id="repairMachineType" class="w-full p-3 rounded-lg" onchange="filterMachinesByType()">
          <option value="">選択してください</option>
        </select>
      </div>

      <!-- 自動入力される項目 -->
      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">対象の機械</label>
        <select id="repairMachineSelect" class="w-full p-3 rounded-lg border bg-white">
        </select>
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">修理日</label>
        <input type="date" id="repairDate" class="w-full p-3 rounded-lg">
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">店舗名</label>
        <input type="text" id="repairShop" class="w-full p-3 rounded-lg">
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">金額</label>
        <input type="number" id="repairCost" class="w-full p-3 rounded-lg">
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
        <textarea id="repairMemo" class="w-full p-3 rounded-lg" rows="3"></textarea>
      </div>

      <button id="saveRepairBtn" class="btn-main" onclick="saveRepairLog()">修理履歴を保存</button>
      <button onclick="switchView('repairView'); loadRepairDashboard();" class="btn-sub mt-4 w-full">修理履歴へ戻る</button>

    </div>

    <div id="maintenanceDetailView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">

      <!-- タイトル（機械名は JS で差し替える） -->
      <div class="flex items-center gap-2 mb-4 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-2 text-lg">
        <i class="fa-solid fa-tractor"></i>
        <span id="maintenanceMachineName">機械名</span>
      </div>

      <div class="card mb-4">
        <p class="font-bold text-sm text-gray-500 mb-2">メンテナンス進捗</p>
        <div id="maintenanceSummary" class="text-xs mt-1">
          未着手
        </div>
      </div>

      <div class="card mb-4">
        <p class="font-bold text-sm text-gray-500 mb-2">点検項目</p>
        <div id="maintenanceChecklist" class="space-y-2">
        </div>
      </div>

      <!-- 作業履歴タイムライン -->
      <div class="card mb-4">
        <p class="font-bold text-sm text-gray-500 mb-2">作業履歴</p>
        <div id="maintenanceHistoryLog" class="space-y-3 text-sm">
          <p class="italic text-gray-400 text-center py-4">履歴はありません</p>
        </div>
      </div>

      <div class="card mb-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
        <p class="font-bold text-sm text-[#6b8f71] mb-4 flex items-center">
          <i class="fas fa-tools mr-2"></i>部品交換を記録
        </p>

        <label class="block text-xs font-bold text-gray-400 mb-1">交換部品・項目名</label>
        <input id="newMaintenanceItem" type="text"
          class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#6b8f71] outline-none"
          placeholder="例：オイルエレメント">

        <label class="block text-xs font-bold text-gray-400 mb-1">担当者</label>
        <select id="newMaintenanceOperator"
          class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#6b8f71] outline-none">
          <option value="">担当者を選択</option>
        </select>

        <label class="block text-xs font-bold text-gray-400 mb-1">状態</label>
        <select id="newMaintenanceStatus"
          class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#6b8f71] outline-none">
          <option value="done">完了</option>
          <option value="progress">作業中</option>
        </select>

        <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
        <textarea id="newMaintenanceMemo" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-4" rows="2"
          placeholder="備考"></textarea>

        <button onclick="saveMaintenanceRecord()"
          class="btn-main w-full py-3 bg-[#6b8f71] text-white rounded-lg font-bold hover:bg-[#5a7a5f] transition-all shadow-md">
          部品交換を保存する
        </button>
      </div>

      <div class="flex justify-center w-full mt-6 mb-8">
        <button onclick="switchView('maintenanceMachineListView')"
          class="bg-gray-500 text-white px-6 py-2.5 rounded-lg hover:bg-gray-600 transition-colors whitespace-nowrap text-[13px] sm:text-sm shadow-md flex items-center justify-center">
          <i class="fas fa-arrow-left mr-2"></i>
          <span>機械一覧ページに戻る</span>
        </button>
      </div>
    </div>

    <div id="versionView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">
      <!-- トラクター専用ヘッダー -->
      <header class="flex flex-col items-center justify-center py-8 relative">
        <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl text-[#6b8f71] p-2"><i
            class="fa-solid fa-bars"></i></button>
        <i class="fa-solid fa-tractor text-5xl text-[#6b8f71]"></i>
        <h1 class="text-xl font-bold text-[#6b8f71]">和農日向 機械管理アプリ</h1>
      </header>

      <div class="flex items-center gap-2 mb-4 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-2 text-lg">
        <i class="fa-solid fa-code-branch"></i> バージョン情報
      </div>

      <div class="card text-sm leading-relaxed space-y-3">
        <p><span class="font-bold">バージョン:</span> 1.0.0</p>
        <p><span class="font-bold">最終更新日:</span> 2026-01-19</p>

        <div>
          <p class="font-bold text-[#6b8f71] mb-1">更新内容</p>
          <ul class="list-disc pl-5 space-y-1">
            <li>初期リリース</li>
          </ul>
        </div>

        <div>
          <p class="font-bold text-[#6b8f71] mb-1">使用技術</p>
          <ul class="list-disc pl-5 space-y-1">
            <li>HTML / CSS / JavaScript</li>
            <li>Tailwind CSS</li>
            <li>Supabase</li>
            <li>Chart.js</li>
            <li>GitHub Pages</li>
          </ul>
        </div>
      </div>

      <button onclick="switchView('portalView')" class="btn-sub mt-6">portalに戻る</button>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const SUPABASE_URL = "https://txsqxnwgolybcdclazdx.supabase.co";
    const SUPABASE_KEY = "sb_publishable_8JEM6Yyg5_oQpF-grdaxIw_rrxZBQYj";
    const GOOGLE_VISION_API_KEY = 'AIzaSyCdX_rYEeovClhxRAwAOhPxG4CPTX6fqlg';
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let allMachines = []; let currentMachineId = 'all'; window.charts = {};

    window.drawCharts = function (data) {
      console.log("📊 全カラムのグラフを最適化します");
      if (typeof Chart === 'undefined') return;

      if (window.charts) {
        Object.values(window.charts).forEach(c => c && typeof c.destroy === 'function' && c.destroy());
      }
      window.charts = {};

      // データ集計
      const stats = { cat: {}, op: {}, task: {}, time: new Array(12).fill(0) };
      let totalH = 0;
      data.forEach(d => {
        const h = Math.max(0, (parseFloat(d.end_hour) || 0) - (parseFloat(d.start_hour) || 0));
        totalH += h;
        stats.cat[d.category || "その他"] = (stats.cat[d.category || "その他"] || 0) + h;
        stats.op[d.operator || "不明"] = (stats.op[d.operator || "不明"] || 0) + h;
        stats.task[d.task || "その他"] = (stats.task[d.task || "その他"] || 0) + h;
        if (d.date) {
          const m = new Date(d.date).getMonth();
          stats.time[m] += h;
        }
      });

      const colors = ['#6b8f71', '#9eb3a2', '#d1dbd3', '#3a4d3f', '#b5c9b8'];

      // --- 【左】上段：機械別修理コスト (金額順にソート & グラデーション) ---
      const ctxRepair = document.getElementById('categoryShareChart');
      if (ctxRepair) {
        // 1. データをオブジェクトの配列にする
        const rawData = [
          { label: 'SL54', value: 80000 },
          { label: 'YT333', value: 30000 },
          { label: 'TJV95', value: 7000 },
          { label: 'SL60', value: 20000 },
          { label: 'MZ70', value: 4000 }
        ];

        // 2. 金額が高い順に並べ替える (降順)
        rawData.sort((a, b) => b.value - a.value);

        // 3. グラフ用にラベルと数値を切り分ける
        const sortedLabels = rawData.map(d => d.label);
        const sortedValues = rawData.map(d => d.value);

        // 4. グラデーション色の計算
        const maxVal = sortedValues[0];
        const backgroundColors = sortedValues.map(val => {
          const opacity = 0.3 + (val / maxVal) * 0.7;
          return `rgba(139, 0, 0, ${opacity})`;
        });

        window.charts.c1 = new Chart(ctxRepair, {
          type: 'bar',
          data: {
            labels: sortedLabels,
            datasets: [{
              label: 'コスト',
              data: sortedValues,
              backgroundColor: backgroundColors,
              borderRadius: 4,
              barThickness: 15
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { display: false },
              y: {
                grid: { display: false },
                ticks: { font: { size: 11, weight: 'bold' } }
              }
            },
            plugins: { legend: { display: false } }
          }
        });
      }

      // --- 【左】下段：作物比率 (ドーナツ) ---
      const ctxCrop = document.getElementById('taskShareChart');
      if (ctxCrop) {
        window.charts.c2 = new Chart(ctxCrop, {
          type: 'doughnut',
          data: { labels: Object.keys(stats.cat), datasets: [{ data: Object.values(stats.cat), backgroundColor: colors }] },
          options: {
            cutout: '45%', // 🔥 70%→45%に下げることで「肉厚」なドーナツになります
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } }
          }
        });
      }

      // --- 【中央】上段：月別稼働推移 (以前の折れ線グラフ) ---
      const ctxLine = document.getElementById('detailChart');
      if (ctxLine) {
        window.charts.line = new Chart(ctxLine, {
          type: 'line',
          data: {
            labels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'],
            datasets: [{ label: 'h', data: stats.time, borderColor: '#6b8f71', backgroundColor: 'rgba(107,143,113,0.1)', fill: true, tension: 0.4 }]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
      }

      // --- 【中央】下段：作業内容分析 (グラデーション棒グラフ) ---
      const ctxBar = document.getElementById('gradientBarChart');
      if (ctxBar) {
        const sorted = Object.entries(stats.task).sort((a, b) => b[1] - a[1]);
        window.charts.bar = new Chart(ctxBar, {
          type: 'bar',
          data: {
            labels: sorted.map(t => t[0]),
            datasets: [{
              label: 'h',
              data: sorted.map(t => t[1]),
              backgroundColor: sorted.map((_, i) => `rgba(107, 143, 113, ${Math.max(0.2, 1 - (i / 5))})`),
              borderRadius: 4
            }]
          },
          options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
      }

      // --- 【右】上段：前年実績比 (半円ゲージ) ---
      const ctxGauge = document.getElementById('yearComparisonGauge');
      if (ctxGauge) {
        const ratio = Math.min(100, (totalH / 500) * 100);
        window.charts.gauge = new Chart(ctxGauge, {
          type: 'doughnut',
          data: { datasets: [{ data: [ratio, 100 - ratio], backgroundColor: ['#6b8f71', '#eee'], borderWidth: 0 }] },
          options: { rotation: -90, circumference: 180, cutout: '75%', maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
        const valEl = document.getElementById("detailCompareValue");
        if (valEl) valEl.innerText = ratio.toFixed(1) + "%";
      }

      // --- 【右】下段：担当者比率 (ドーナツ) ---
      const ctxOp = document.getElementById('operatorShareChart');
      if (ctxOp) {
        window.charts.c4 = new Chart(ctxOp, {
          type: 'doughnut',
          data: { labels: Object.keys(stats.op), datasets: [{ data: Object.values(stats.op), backgroundColor: colors }] },
          options: { cutout: '45%', responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } } }
        });
      }
    };

    function openMenu() {
      // 現在アクティブなビューに応じて適切なメニューを開く
      const tractorSection = document.querySelector('#tractor-section .view.active');
      const plantingSection = document.querySelector('#planting-section .view.active');
      const combineSection = document.querySelector('#combine-section .view.active');
      
      let menuId = 'sideMenu'; // デフォルトはグローバルメニュー
      
      if (tractorSection) {
        menuId = 'tractorSideMenu';
      } else if (plantingSection) {
        menuId = 'plantingSideMenu';
      } else if (combineSection) {
        menuId = 'combineSideMenu';
      }
      
      document.getElementById(menuId).style.left = "0px";
      document.getElementById("overlay").style.display = "block";
    }
    
    function closeMenu() {
      // すべてのメニューを閉じる
      document.getElementById("sideMenu").style.left = "-280px";
      document.getElementById("tractorSideMenu").style.left = "-280px";
      document.getElementById("plantingSideMenu").style.left = "-280px";
      document.getElementById("combineSideMenu").style.left = "-280px";
      document.getElementById("overlay").style.display = "none";
    }

    function showModal(title, message, onOk) {
      const modal = document.getElementById("customModal");
      document.getElementById("modalTitle").innerText = title;
      document.getElementById("modalMessage").innerText = message;
      const okBtn = document.getElementById("modalOkBtn");
      okBtn.onclick = () => { closeModal(); if (onOk) onOk(); };
      modal.classList.add("active");
    }
    function closeModal() { document.getElementById("customModal").classList.remove("active"); }

    function switchView(id) {
      console.log("Switching to:", id);

      // 全てのビューからactiveを取り除く
      document.querySelectorAll('.view').forEach(v => {
        v.classList.remove('active');
        v.style.display = 'none';
      });

      // 対象のビューを取得
      const targetView = document.getElementById(id);
      if (targetView) {
        targetView.classList.add('active');
        targetView.style.display = 'block';
      } else {
        console.error("エラー: ID '" + id + "' のビューが見つかりません。");
      }

      // ヘッダーの制御（portalView, dashboard, dashboardPlanting, versionView では非表示）
      const header = document.getElementById("pageHeader");
      if (header) {
        header.style.display = (id === 'dashboard' || id === 'dashboardPlanting' || id === 'portalView' || id === 'versionView') ? 'none' : 'flex';
      }

      closeMenu();

      // 各ページごとの読み込み処理
      if (id === 'dashboard') {
        setTimeout(() => renderDashboard('all'), 100);
      }
      if (id === 'dashboardPlanting') {
        setTimeout(() => renderDashboardPlanting('all'), 100);
      }
      if (id === 'todayView') {
        console.log("本日ログ読込実行");
        loadLogs("todayLogList", true);
      }
      if (id === 'historyView') {
        console.log("履歴ログ読込実行");
        loadLogs("historyLogList", false);
      }
      if (id === 'todayViewPlanting') {
        console.log("田植え機 本日ログ読込実行");
        loadLogsPlanting("todayLogListPlanting", true);
      }
      if (id === 'historyViewPlanting') {
        console.log("田植え機 履歴ログ読込実行");
        loadLogsPlanting("historyLogListPlanting", false);
      }
      if (id === 'repairView') {
        loadRepairDashboard();
      }
      if (id === 'repairViewPlanting') {
        loadRepairDashboardPlanting();
      }
      if (id === 'maintenanceMachineListView') {
        loadMachineList();
      }
      if (id === 'maintenanceView') {
        console.log("メンテナンス状態を復元中...");
        restoreMaintenanceChecks();
      }
      if (id === 'maintenanceMachineListViewPlanting') {
        loadMachineListPlanting();
      }
      if (id === 'maintenanceDetailViewPlanting') {
        console.log("田植え機メンテナンス状態を復元中...");
        restoreMaintenanceChecksPlanting();
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      // 1. 機械（トラクターのみ）の取得
      const { data: machines } = await client
        .from("machines")
        .select("*")
        .eq("machine_type", "tractor")
        .order("name");

      allMachines = machines || [];

      // 2. オペレーターの取得
      const { data: operators } = await client
        .from("operators")
        .select("*")
        .order("id");

      // 3. 作業内容の取得
      const { data: workTypes } = await client
        .from("work_types")
        .select("*")
        .order("id");

      // --- 各画面要素への反映 ---

      // 入力フォームの機械選択
      const machineSelect = document.getElementById("machineSelect");
      if (machineSelect) {
        machineSelect.innerHTML = '<option value="">選択</option>' +
          allMachines.map(m => `<option value="${m.id}">${m.name}</option>`).join("");
      }

      // 検索条件の機械選択
      const filterMachine = document.getElementById("filterMachine");
      if (filterMachine) {
        filterMachine.innerHTML = '<option value="">すべての機械</option>' +
          allMachines.map(m => `<option value="${m.id}">${m.name}</option>`).join("");
      }

      // 4. オペレーター選択の反映
      const operatorSelect = document.getElementById("operatorSelect");
      if (operatorSelect) {
        operatorSelect.innerHTML = '<option value="">選択</option>' +
          (operators || []).map(o => `<option value="${o.name}">${o.name}</option>`).join("");
      }

      // 5. 作業種別選択の反映
      const workTypeSelect = document.getElementById("workTypeSelect");
      if (workTypeSelect) {
        workTypeSelect.innerHTML = '<option value="">選択</option>' +
          (workTypes || []).map(w => `<option value="${w.name}">${w.name}</option>`).join("");
      }

      // 最後に、ダッシュボードを表示する（ダッシュボード画面にいる場合のみ）
      if (typeof renderDashboard === 'function') {
        renderDashboard('all');
      }

      // ダッシュボードの機械別タブ
      const machineTabs = document.getElementById("machineTabs");
      if (machineTabs) {
        // 今選ばれているIDを確実に取得（関数の引数 machineId を使用）
        const currentId = 'all';

        // 1. 「全体」ボタン
        const allBtnClass = (currentId === 'all') ? 'active' : 'inactive';
        let tabsHTML = `
          <button onclick="renderDashboard('all')" 
                  id="tab-all" 
                  class="tab-btn ${allBtnClass}" 
                  style="min-width: 80px; letter-spacing: 0.2em;">全 体</button>
        `;

        // 2. 各機械のボタン（allMachines.map）
        if (typeof allMachines !== 'undefined' && allMachines.length > 0) {
          tabsHTML += allMachines.map(m => {
            // IDを比較して active か inactive か決める
            const isActive = (String(m.id) === String(currentId)) ? 'active' : 'inactive';
            return `
              <button onclick="renderDashboard(${m.id})" 
                      id="tab-${m.id}" 
                      class="tab-btn ${isActive}">${m.name}</button>
            `;
          }).join("");
        }

        machineTabs.innerHTML = tabsHTML;
      }

      // オペレーター選択の反映（検索と入力両方）
      if (operators) {
        const opList = operators.map(o => `<option value="${o.name}">${o.name}</option>`).join("");
        const fOp = document.getElementById("filterOperator");
        if (fOp) fOp.innerHTML = '<option value="">全オペレーター</option>' + opList;

        const iOp = document.getElementById("operator");
        if (iOp) iOp.innerHTML = '<option value="">選択してください</option>' + opList;
      }

      // 作業内容の反映（連動ロジック含む）
      if (workTypes) {
        // 検索条件側
        const fCat = document.getElementById("filterCategory");
        if (fCat) {
          fCat.innerHTML = '<option value="">全作業内容</option>' +
            workTypes.map(w => `<option value="${w.work_name || w.category}">${w.work_name || w.category}</option>`).join("");
        }

        // 入力フォーム側（種別）
        const iCat = document.getElementById("category");
        if (iCat) {
          const categories = [...new Set(workTypes.map(w => w.category))];
          iCat.innerHTML = '<option value="">種別を選択</option>' +
            categories.map(c => `<option value="${c}">${c}</option>`).join("");

          // 種別を選んだら作業内容を出す連動設定
          iCat.onchange = () => {
            const selected = iCat.value;
            const iWork = document.getElementById("work_name");
            if (iWork) {
              const filtered = workTypes.filter(t => t.category === selected);
              iWork.innerHTML = '<option value="">作業内容を選択</option>' +
                filtered.map(t => `<option value="${t.work_name}">${t.work_name}</option>`).join("");
            }
          };
        }
      }

      // 日付の初期
      const today = new Date().toISOString().split('T')[0];
      if (document.getElementById("workDate")) {
        document.getElementById("workDate").value = today;
      }
      if (document.getElementById("taue_workDate")) {
        document.getElementById("taue_workDate").value = today;
      }
      if (document.getElementById("filterMonth")) {
        document.getElementById("filterMonth").value = today.substring(0, 7);
      }

      // 安全のため、機械選択に change リスナを確実に追加
      const msEl = document.getElementById('machineSelect');
      if (msEl && !msEl.onchange) msEl.addEventListener('change', autoFillHour);

      // 田植え機用の初期化
      await initTauePage();

      console.log("全データの初期化と日付セットが完了しました");
    });

    // 修理履歴ダッシュボードを読み込む
    async function loadRepairDashboard() {
      try {
        // repair_logs をすべて取得
        const { data: logs, error } = await client
          .from('repair_logs')
          .select('*')
          .order('date', { ascending: false });

        if (error) {
          console.error('Error loading repair logs:', error);
          return;
        }

        // -----------------------------
        // ① 累計修理費
        // -----------------------------
        const totalCost = logs.reduce((sum, log) => sum + (log.cost || 0), 0);
        document.getElementById('totalRepairCost').textContent =
          '¥ ' + totalCost.toLocaleString();

        // -----------------------------
        // ② 年ごとの修理費
        // -----------------------------
        const yearly = {};
        logs.forEach(log => {
          const year = new Date(log.date).getFullYear();
          if (!yearly[year]) yearly[year] = 0;
          yearly[year] += log.cost || 0;
        });

        const yearlyContainer = document.getElementById('yearlyRepairContainer');
        yearlyContainer.innerHTML = '';

        Object.keys(yearly)
          .sort((a, b) => b - a)
          .forEach(year => {
            const card = document.createElement('div');
            card.className =
              'p-3 bg-white rounded-md shadow text-center border border-gray-100';
            card.innerHTML = `
          <div class="text-sm text-gray-500">${year}年</div>
          <div class="text-lg font-bold text-[#6b8f71]">¥ ${yearly[year].toLocaleString()}</div>
        `;
            yearlyContainer.appendChild(card);
          });

        // -----------------------------
        // ③ 機械ごとの修理費
        // -----------------------------
        const machineTotals = {};

        logs.forEach(log => {
          if (!machineTotals[log.machine_id]) machineTotals[log.machine_id] = 0;
          machineTotals[log.machine_id] += log.cost || 0;
        });

        // machines テーブルから名前を取得
        const { data: machines } = await client.from('machines').select('*');

        const machineContainer = document.getElementById('machineRepairContainer');
        machineContainer.innerHTML = '';

        Object.keys(machineTotals).forEach(machineId => {
          const machine = machines.find(m => m.id === Number(machineId));
          const name = machine ? machine.name : '不明な機械';

          const card = document.createElement('div');
          card.className =
            'p-3 bg-white rounded-md shadow text-center border border-gray-100';
          card.innerHTML = `
        <div class="text-sm text-gray-500">${name}</div>
        <div class="text-lg font-bold text-[#6b8f71]">¥ ${machineTotals[machineId].toLocaleString()}</div>
      `;
          machineContainer.appendChild(card);
        });

        // -----------------------------
        // ④ 最近の修理履歴（最新5件）
        // -----------------------------
        const recentContainer = document.getElementById('recentRepairContainer');
        recentContainer.innerHTML = '';

        logs.slice(0, 5).forEach(log => {
          const item = document.createElement('div');
          item.className =
            'p-3 bg-white rounded-md shadow border border-gray-100';

          item.innerHTML = `
        <div class="text-sm text-gray-500">${log.date}</div>
        <div class="font-bold">${log.memo || '(内容なし)'}</div>
        <div class="text-[#6b8f71] font-bold mt-1">¥ ${log.cost.toLocaleString()}</div>
        <div class="text-xs text-gray-400 mt-1">${log.shop || ''}</div>
      `;

          recentContainer.appendChild(item);
        });

      } catch (err) {
        console.error('Unexpected error:', err);
      }
    }

    async function autoFillHour() {
      const mId = document.getElementById("machineSelect").value;
      if (!mId) return;
      const { data } = await client.from("hour_logs").select("end_hour").eq("machine_id", mId).order("date", { ascending: false }).order("created_at", { ascending: false }).limit(1);
      if (data && data.length > 0) { document.getElementById("hourBefore").value = data[0].end_hour; calcDiff(); }
    }

    function calcDiff() {
      const b = parseFloat(document.getElementById("hourBefore").value) || 0;
      const a = parseFloat(document.getElementById("hourAfter").value) || 0;
      const d = a - b;
      const disp = document.getElementById("hourDiffDisplay");

      // ① 稼働後のほうが小さい場合に文字を赤くするロジック
      if (a > 0 && a < b) {
        disp.classList.remove("text-[#6b8f71]");
        disp.classList.add("text-red-500");
        disp.textContent = `稼働時間: 0.0 h (入力エラー)`;
      } else {
        disp.classList.remove("text-red-500");
        disp.classList.add("text-[#6b8f71]");
        disp.textContent = `稼働時間: ${d > 0 ? d.toFixed(1) : "0.0"} h`;
      }
    }

    async function previewInvoice(input) {
      const file = input.files[0];
      if (!file) return;

      const previewImg = document.getElementById('invoicePreviewImg');
      const previewArea = document.getElementById('invoicePreviewArea');
      const saveBtn = document.getElementById('saveRepairBtn');

      // プレビュー表示
      previewImg.src = URL.createObjectURL(file);
      previewArea.classList.remove('hidden');

      const memoField = document.getElementById('repairMemo');
      memoField.value = "📄 Google AIが解析中... ⏳";
      if (saveBtn) saveBtn.disabled = true; // 解析中は二重押し防止で無効化

      try {
        const base64Image = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.readAsDataURL(file);
        });

        const url = `https://vision.googleapis.com/v1/images:annotate?key=${GOOGLE_VISION_API_KEY}`;
        const response = await fetch(url, {
          method: "POST",
          body: JSON.stringify({
            requests: [{ image: { content: base64Image }, features: [{ type: "TEXT_DETECTION" }] }]
          })
        });
        const result = await response.json();

        const fullText = result.responses[0]?.textAnnotations[0]?.description || "";

        // --- 抽出処理 ---
        const cleanText = fullText.replace(/\s/g, '');
        const costMatch = cleanText.match(/(?:金額|合計|税込|￥|¥|請求額)[:：]?([0-9,]{3,})/);
        if (costMatch) document.getElementById('repairCost').value = costMatch[1].replace(/,/g, '');

        const dateMatch = cleanText.match(/(\d{4})[年\/-](\d{1,2})[月\/-](\d{1,2})/);
        if (dateMatch) {
          document.getElementById('repairDate').value = `${dateMatch[1]}-${dateMatch[2].padStart(2, '0')}-${dateMatch[3].padStart(2, '0')}`;
        }

        // ✨ 解析が終わったらプレビューを消す
        previewArea.classList.add('hidden');
        previewImg.src = "";
        memoField.value = "解析完了: " + fullText.substring(0, 50) + "..."; // 冒頭だけメモに残す

        alert("解析完了！内容を確認して保存してください。");

      } catch (error) {
        console.error("OCR Error:", error);
        memoField.value = "❌ 解析エラー";
      } finally {
        if (saveBtn) saveBtn.disabled = false; // エラーでも成功でもボタンを復活させる
      }
    }

    async function populateMachineSelect() {
      const { data: machines } = await client
        .from('machines')
        .select('*')
        .order('name');

      // 全機械を保存（フィルタリング用）
      window.allMachinesForRepair = machines || [];

      // 種別セレクトボックスを設定
      const typeSelect = document.getElementById('repairMachineType');
      if (typeSelect && machines) {
        const uniqueTypes = [...new Set(machines.map(m => m.machine_type))].filter(Boolean);
        typeSelect.innerHTML = '<option value="">選択してください</option>';
        uniqueTypes.forEach(type => {
          const opt = document.createElement('option');
          opt.value = type;
          opt.textContent = type === 'tractor' ? 'トラクター' : type === 'transplanter' ? '田植え機' : type;
          typeSelect.appendChild(opt);
        });
      }

      // 機械セレクトボックスは初期状態では空
      const select = document.getElementById('repairMachineSelect');
      if (select) {
        select.innerHTML = '<option value="">まず種別を選択してください</option>';
      }
    }

    function filterMachinesByType() {
      const typeSelect = document.getElementById('repairMachineType');
      const machineSelect = document.getElementById('repairMachineSelect');
      const selectedType = typeSelect.value;

      if (!machineSelect || !window.allMachinesForRepair) return;

      machineSelect.innerHTML = '<option value="">選択してください</option>';

      if (!selectedType) {
        machineSelect.innerHTML = '<option value="">まず種別を選択してください</option>';
        return;
      }

      const filteredMachines = window.allMachinesForRepair.filter(m => m.machine_type === selectedType);

      if (filteredMachines.length > 0) {
        filteredMachines.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.id;
          opt.textContent = m.name;
          machineSelect.appendChild(opt);
        });
      } else {
        const opt = document.createElement('option');
        opt.textContent = `${selectedType}が登録されていません`;
        machineSelect.appendChild(opt);
      }
    }

    async function saveRepairLog() {
      console.log("保存処理を開始します...");

      // 1. 画面から入力値を取得
      const dateValue = document.getElementById('repairDate').value;
      const shopValue = document.getElementById('repairShop').value;
      const costValue = document.getElementById('repairCost').value;
      const memoValue = document.getElementById('repairMemo').value;
      const machineId = document.getElementById('repairMachineSelect').value;

      // 2. 必須チェック
      if (!dateValue || !costValue) {
        alert("「修理日」と「金額」を入力してください。");
        return;
      }

      const btn = document.getElementById('saveRepairBtn');
      btn.disabled = true;
      btn.innerText = "保存中...";

      try {
        // 3. Supabaseへ保存
        const { error } = await client
          .from('repair_logs')
          .insert([
            {
              date: dateValue,
              shop: shopValue,
              cost: parseInt(costValue),
              memo: memoValue,
              machine_id: machineId || null // IDが空でも保存できるようにする
            }
          ]);

        if (error) throw error;

        // --- ここをオシャレに書き換え ---
        btn.innerText = "保存完了！";

        // 1. 成功したらダッシュボードの数字を再計算
        loadRepairDashboard();

        // 2. モーダルで通知（もしモーダルが動くなら）
        if (typeof showCustomModal === 'function') {
          showCustomModal("保存完了", "修理履歴を記録しました。ダッシュボードを更新します。");
        } else {
          alert("保存完了しました！🚜🌾");
        }

        // 3. 自動的に履歴トップ画面に戻す
        setTimeout(() => {
          switchView('repairView');
          btn.disabled = false;
          btn.innerText = "修理履歴を保存";
        }, 1500);

      } catch (err) {
        console.error("❌ 保存に失敗しました:", err);
        alert("エラーで保存できませんでした: " + err.message);
        btn.disabled = false;
        btn.innerText = "修理履歴を保存";
      }
    }

    function prepareMachineSelect() {
      const select = document.getElementById('repairMachineSelect');
      if (!select) return;

      select.innerHTML = '';

      if (allMachines && allMachines.length > 0) {
        allMachines.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.id;
          opt.textContent = m.name;
          select.appendChild(opt);
        });
      } else {
        const opt = document.createElement('option');
        opt.textContent = "機械が登録されていません";
        select.appendChild(opt);
      }
    }

    function goToRepairRegistration() {
      prepareMachineSelect(); // リストを作成
      switchView('invoiceOCRView'); // 画面を切り替え
    }

    async function loadLogs(elId, todayOnly) {
      const list = document.getElementById(elId);
      list.innerHTML = "<p class='text-center py-10 opacity-50 text-xs'>読込中...</p>";

      // 基本のクエリ作成
      let query = client.from("hour_logs").select("*, machines(name)").order("date", { ascending: false });

      if (todayOnly) {
        // 【本日の稼働状況】日本時間（JST）の今日の日付で絞り込み
        const jstToday = new Date().toLocaleDateString('sv-SE');
        query = query.eq("date", jstToday);
      } else {

        // 【稼働履歴】画面の入力値を取得してフィルターをかける
        const month = document.getElementById("filterMonth").value; // YYYY-MM
        const machine = document.getElementById("filterMachine").value;
        const operator = document.getElementById("filterOperator").value;
        const category = document.getElementById("filterCategory").value;

        // 月で絞り込み (前方一致)
        if (month) query = query.gte("date", `${month}-01`).lte("date", `${month}-31`);
        // 機械で絞り込み
        if (machine) query = query.eq("machine_id", machine);
        // オペレーターで絞り込み
        if (operator) query = query.eq("operator", operator);
        // 種別（水稲・そば等）で絞り込み
        if (category) query = query.eq("category", category);
      }

      const { data, error } = await query;
      if (error) {
        console.error("データ取得エラー:", error);
        return;
      }

      let total = 0;
      const displayData = todayOnly ? [...(data || [])].reverse() : (data || []);

      list.innerHTML = displayData.map(l => {
        const diff = (l.end_hour - l.start_hour);
        total += diff;
        return `<div class="card border-l-4 border-[#6b8f71] !mb-3 !py-3 flex justify-between items-center">
              <div>
                <b class="text-sm">${l.date} - ${l.machines?.name}</b>
                <p class="text-xs opacity-70 mt-1">${l.operator} | ${l.task}</p>
                <div class="flex gap-4 mt-2">
                  <span class="text-[11px] font-bold log-badge px-2 py-1 rounded"><i class="fa-solid fa-clock mr-1 text-[#6b8f71]"></i>${diff.toFixed(1)} h</span>
                  <span class="text-[11px] font-bold log-badge px-2 py-1 rounded"><i class="fa-solid fa-gas-pump mr-1 text-[#6b8f71]"></i>${l.fuel_amount || 0} L</span>
                </div>
              </div>
              <button onclick="deleteLog(${l.id})" class="text-gray-400 p-2 hover:text-red-500 transition-colors">
                <i class="fa-regular fa-trash-can text-lg"></i>
              </button>
            </div>`;
      }).join("");

      if (!todayOnly) {
        const totalEl = document.getElementById("historyTotalHours");
        if (totalEl) totalEl.innerText = `合計: ${total.toFixed(1)} h`;
      }
    }

    async function deleteLog(id) {
      showModal("削除確認", "このログを削除しますか？", async () => {
        const { error } = await client.from("hour_logs").delete().eq("id", id);
        if (!error) {
          if (document.getElementById("todayView").classList.contains("active")) loadLogs("todayLogList", true);
          else loadLogs("historyLogList", false);
        }
      });
    }

    // メンテナンス履歴をDBから取得して表示する関数
    async function loadMaintenanceLogs() {
      const logContainer = document.getElementById('maintenanceLog');
      if (!logContainer) return;

      try {
        // 1. 最新のメンテナンス履歴を5件ほど取得
        const { data: logs, error } = await client
          .from('maintenance_status') // メンテナンス状態テーブル
          .select('item_id, updated_at, status')
          .eq('status', true)        // 完了したものだけ
          .order('updated_at', { ascending: false }) // 新しい順
          .limit(5);
        if (error) throw error;

        if (logs && logs.length > 0) {
          logContainer.innerHTML = logs.map(log => {
            // item_id が "tractor1_oil" のような形式だと仮定して整形
            const [machine, item] = log.item_id.split('_');
            const date = new Date(log.updated_at).toLocaleDateString('ja-JP', {
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit'
            });

            return `
          <div class="flex flex-col border-b border-gray-50 pb-1 mb-1 last:border-0">
            <div class="flex justify-between items-center">
              <span class="font-bold text-gray-700">${machine.toUpperCase()}</span>
              <span class="text-[9px] text-gray-400">${date}</span>
            </div>
            <div class="text-[#6b8f71] flex items-center gap-1">
              <i class="fa-solid fa-check-circle"></i> ${item} 完了
            </div>
          </div>
        `;
          }).join('');
        } else {
          logContainer.innerHTML = `<p class="italic text-gray-400 text-center py-4">直近の整備履歴はありません</p>`;
        }
      } catch (err) {
        console.error('履歴取得エラー:', err);
        logContainer.innerHTML = `<p class="text-red-400 text-center py-4">データ取得失敗</p>`;
      }
    }

    loadMaintenanceLogs();

    // 1. メンテナンス一覧（トラクター一覧）を表示する
    async function loadMachineList() {
      try {
        const { data: machines, error } = await client
          .from("machines")
          .select("*")
          .eq("machine_type", "tractor")
          .order("id");

        if (error) throw error;

        const container = document.getElementById("maintenanceMachineGrid");
        if (!container) return;
        container.innerHTML = "";

        const grouped = {};
        machines.forEach(m => {
          const manufacturer = m.manufacturer || "その他";
          if (!grouped[manufacturer]) grouped[manufacturer] = [];
          grouped[manufacturer].push(m);
        });

        for (const brand of Object.keys(grouped)) {
          const brandHeader = document.createElement("h3");
          brandHeader.className = "text-[#6b8f71] font-bold text-sm mb-2 mt-4 flex items-center gap-2";
          brandHeader.innerHTML = `<i class="fa-solid fa-tag opacity-50"></i> ${brand}`;
          container.appendChild(brandHeader);

          const grid = document.createElement("div");
          grid.className = "grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-4";

          // 各マシンのカードを作成
          for (const m of grouped[brand]) {
            const card = document.createElement("div");
            card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-all active:scale-95";
            card.onclick = () => openMaintenanceDetail(m.id);

            card.innerHTML = `
              <div class="flex flex-col gap-2">
                <div class="flex items-center gap-3">
                  <div style="color: #6b8f71;" class="text-xl flex-shrink-0">
                    <i class="fa-solid fa-tractor"></i>
                  </div>
                  <div class="font-bold text-gray-900 text-lg truncate">${m.name}</div>
                </div>
                <div class="border-t border-gray-50 pt-2" id="card-progress-${m.id}">
                  <div class="text-[11px] text-gray-400 flex items-center gap-1">
                    <i class="fa-solid fa-circle-notch fa-spin text-[9px]"></i> 確認中...
                  </div>
                </div>
              </div>
            `;
            grid.appendChild(card);

            // 進捗状況を非同期で取得して反映
            (async () => {
              try {
                const { data: checks } = await client
                  .from('maintenance_status')
                  .select('item_id, status')
                  .filter('item_id', 'ilike', `${m.id}_%`);

                const totalItems = 20;
                const uniqueChecks = {};
                if (checks) {
                  checks.forEach(c => { uniqueChecks[c.item_id] = c.status; });
                }

                const completedCount = Object.values(uniqueChecks).filter(status => status === true || status === "true").length;
                let percent = Math.round((completedCount / totalItems) * 100);
                percent = Math.min(100, percent);

                const progressDiv = document.getElementById(`card-progress-${m.id}`);
                if (progressDiv) {
                  let statusHTML = percent === 0
                    ? `<span class="text-red-600 font-black"><i class="fa-solid fa-circle-exclamation text-[9px]"></i> 未着手</span>`
                    : percent === 100
                      ? `<span class="text-[#6b8f71] font-black"><i class="fa-solid fa-circle-check text-[9px]"></i> 完了</span>`
                      : `<span class="text-orange-500 font-black"><i class="fa-solid fa-spinner text-[9px]"></i> ${percent}% 完了</span>`;

                  progressDiv.innerHTML = `
                    <div class="text-[11px] flex items-center gap-1">${statusHTML}</div>
                    <div class="w-full bg-gray-100 rounded-full h-1 mt-1">
                      <div class="bg-[#6b8f71] h-1 rounded-full transition-all duration-500" style="width: ${percent}%"></div>
                    </div>
                  `;
                }
              } catch (err) { console.error("カード進捗更新エラー:", err); }
            })();
          }
          container.appendChild(grid);
        }
      } catch (e) { console.error("一覧読み込みエラー:", e); }
    }
    async function loadMaintenanceLogs() {
      const logContainer = document.getElementById('maintenanceLog');
      if (!logContainer) return;

      try {
        // 1. 全てのメンテナンス状態を取得
        const { data: allStatus, error: statusError } = await client
          .from('maintenance_status')
          .select('item_id, status, updated_at');

        if (statusError) throw statusError;

        // 2. 機械ごとに「全項目数」と「完了数」をカウント
        const machineProgress = {};
        allStatus.forEach(item => {
          const mId = item.item_id.split('_')[0];
          if (!machineProgress[mId]) {
            machineProgress[mId] = { total: 0, completed: 0, lastUpdate: item.updated_at };
          }
          machineProgress[mId].total++;
          if (item.status) {
            machineProgress[mId].completed++;
            // 一番新しい完了日時を保持
            if (new Date(item.updated_at) > new Date(machineProgress[mId].lastUpdate)) {
              machineProgress[mId].lastUpdate = item.updated_at;
            }
          }
        });

        // 3. 判定ロジック
        const finishedMachineIds = Object.keys(machineProgress).filter(mId => {
          const p = machineProgress[mId];
          // 1つ以上項目があり、かつ（完了数 ＝ 項目数）であること
          // かつ、特定の「少なすぎるデータ（テスト用）」を除外するために 3項目以上 とする
          return p.total >= 3 && p.completed === p.total;
        });

        // 4. 機械名を取得
        const { data: machines, error: mError } = await client
          .from('machines')
          .select('id, name')
          .in('id', finishedMachineIds);

        if (mError) throw mError;

        const machineMap = {};
        machines.forEach(m => { machineMap[m.id.toString()] = m.name; });

        // 5. 完了した機械を最新順に並べて表示
        const displayData = finishedMachineIds
          .map(mId => ({
            id: mId,
            name: machineMap[mId] || `機械(ID:${mId})`,
            date: machineProgress[mId].lastUpdate
          }))
          .sort((a, b) => new Date(b.date) - new Date(a.date));

        logContainer.innerHTML = displayData.map(data => {
          const date = new Date(data.date);
          const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;

          return `
        <div class="flex items-center justify-between border-b border-gray-50 py-3 last:border-0">
          <div class="flex flex-col">
            <span class="text-[13px] font-black text-gray-800">${data.name}</span>
            <div class="flex items-center gap-1">
              <span class="w-2 h-2 rounded-full bg-[#6b8f71] flex items-center justify-center">
                <i class="fa-solid fa-check text-[5px] text-white"></i>
              </span>
              <span class="text-[10px] text-[#6b8f71] font-bold tracking-wider">ALL MAINTENANCE COMPLETE</span>
            </div>
          </div>
          <div class="text-right">
            <div class="text-[11px] text-gray-500 font-mono font-bold">${dateStr}</div>
          </div>
        </div>
      `;
        }).join('');

      } catch (err) {
        console.error('履歴取得エラー:', err);
      }
    }

    // 2. 詳細画面を開く
    async function openMaintenanceDetail(machineId) {
      window.currentMachineId = machineId;
      switchView('maintenanceDetailView');

      try {
        const { data: machine } = await client.from("machines").select("*").eq("id", machineId).single();
        document.getElementById("maintenanceMachineName").textContent = machine.name;

        const { data: operators } = await client.from('operators').select('name').order('id');
        const opSelect = document.getElementById('newMaintenanceOperator');
        if (opSelect && operators) {
          opSelect.innerHTML = '<option value="">担当者を選択</option>';
          operators.forEach(op => {
            const opt = document.createElement('option');
            opt.value = op.name; opt.textContent = op.name;
            opSelect.appendChild(opt);
          });
        }

        loadMaintenanceHistory(machineId);
        const { data: items } = await client.from("maintenance_items_tractor").select("*").order("id");
        const checklistContainer = document.getElementById("maintenanceChecklist");
        if (checklistContainer && items) {
          checklistContainer.innerHTML = "";
          items.forEach(item => {
            const uniqueId = `${machineId}_${item.id}`;
            const div = document.createElement("div");
            div.className = "flex items-center justify-between p-3 border-b border-gray-50 last:border-0 hover:bg-gray-50 transition-colors";
            div.innerHTML = `
              <div class="flex flex-col flex-1 text-left">
                  <span class="text-sm font-bold text-gray-700">${item.item_name}</span>
                  <span class="text-[10px] text-gray-400">${item.description || ''}</span>
              </div>
              <input type="checkbox" id="${uniqueId}" class="maintenance-check w-6 h-6 rounded border-gray-300 text-[#6b8f71]"
                     onchange="saveSingleCheck('${machineId}', '${item.id}', this.checked)">
            `;
            checklistContainer.appendChild(div);
          });
        }
        await restoreMaintenanceChecks();
      } catch (e) { console.error(e); }
    }

    // 3. 進捗表示の更新
    function updateMaintenanceProgress() {
      const checkboxes = document.querySelectorAll('#maintenanceChecklist input[type="checkbox"]');
      const total = checkboxes.length;
      if (total === 0) return;
      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
      const percentage = Math.round((checkedCount / total) * 100);
      const summaryDiv = document.getElementById('maintenanceSummary');
      if (summaryDiv) {
        summaryDiv.innerHTML = `
          <div class="flex justify-between items-center mb-1">
            <span class="font-bold text-[#6b8f71]">${percentage}% 完了</span>
            <span class="text-xs text-gray-400">${checkedCount} / ${total} 項目</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="bg-[#6b8f71] h-2 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
          </div>
        `;
      }
    }

    // 4. 保存
    async function saveSingleCheck(machineId, itemId, isChecked) {
      try {
        const uniqueId = `${machineId}_${itemId}`;
        await client.from('maintenance_status').upsert({
          item_id: uniqueId, status: Boolean(isChecked), updated_at: new Date()
        }, { onConflict: 'item_id' });
        updateMaintenanceProgress();
        loadMachineList();
      } catch (e) { console.error(e); }
    }

    // 5. 復元
    async function restoreMaintenanceChecks() {
      try {
        const { data } = await client.from('maintenance_status').select('item_id, status');
        if (data) {
          data.forEach(row => {
            const el = document.getElementById(row.item_id);
            if (el) el.checked = row.status;
          });
        }
        updateMaintenanceProgress();
      } catch (e) { console.error(e); }
    }

    async function loadMaintenanceHistory(machineId) {
      try {
        const { data } = await client.from('maintenance_records').select('*').eq('machine_id', machineId).order('created_at', { ascending: false });
        const container = document.getElementById('maintenanceHistoryLog');
        if (!container) return;
        if (!data || data.length === 0) {
          container.innerHTML = '<p class="italic text-gray-400 text-center py-4">履歴はありません</p>';
          return;
        }
        container.innerHTML = data.map(rec => `
          <div class="border-b border-gray-100 pb-2 mb-2 last:border-0 text-left">
            <div class="flex justify-between font-bold text-gray-700"><span>${rec.item_name}</span><span class="text-gray-400 text-[9px]">${rec.date}</span></div>
            <div class="text-gray-500">担当: ${rec.operator}</div>
            ${rec.memo ? `<div class="text-gray-400 italic">"${rec.memo}"</div>` : ''}
          </div>`).join('');
      } catch (e) { console.error(e); }
    }

    // ==========================================
    // 1. ページ読み込み時の初期化（DOMContentLoaded）
    // ==========================================
    document.addEventListener('DOMContentLoaded', async () => {
      console.log("🚀 全データの初期化を開始します...");

      // メンテナンス・ログ入力・履歴の読み込み
      if (typeof loadMachineList === 'function') await loadMachineList();
      if (typeof restoreMaintenanceChecks === 'function') await restoreMaintenanceChecks();
      if (typeof loadOperators === 'function') await loadOperators();
      if (typeof loadCategories === 'function') await loadCategories();
      if (typeof loadLogs === 'function') loadLogs('historyLogList', false);

      // 日付セット
      const dateInput = document.getElementById('workDate');
      if (dateInput) dateInput.value = new Date().toLocaleDateString('sv-SE');
      const monthInput = document.getElementById('filterMonth');
      if (monthInput) monthInput.value = new Date().toISOString().substring(0, 7);

      // ★ダッシュボードの初期表示（全体を表示）
      if (typeof renderDashboard === 'function') {
        renderDashboard('all');
      }

      if (typeof switchView === 'function') {
        switchView('portalView');
      }

      // Reveal the page after initial view switch to avoid flash of other views
      try { document.body.style.visibility = 'visible'; } catch(e) { /* ignore */ }
      console.log("✅ 全データの初期化命令を完了しました");
    }); // ← ここで DOMContentLoaded がスッキリ終了！


    // ==========================================
    // 2. 実務をこなす関数たち
    // ==========================================

    // --- ダッシュボード全体を制御する関数 ---
    async function renderDashboard(machineId = 'all') {
      const machineTabs = document.getElementById("machineTabs");
      if (!machineTabs) return;

      window.currentViewMachineId = machineId;
      console.log("🛠️ ダッシュボード描画中... ID:", machineId);
      const currentId = machineId;
      const allBtnClass = (currentId === 'all') ? 'active' : 'inactive';

      let tabsHTML = `
      <button onclick="renderDashboard('all')" 
              class="tab-btn ${allBtnClass}" 
              style="min-width: 80px; letter-spacing: 0.2em;">全 体</button>
    `;

      if (typeof allMachines !== 'undefined' && allMachines.length > 0) {
        tabsHTML += allMachines.map(m => {
          const isActive = (String(m.id) === String(currentId)) ? 'active' : 'inactive';
          return `
          <button onclick="renderDashboard(${m.id})" 
                  class="tab-btn ${isActive}">${m.name}</button>
        `;
        }).join("");
      }
      machineTabs.innerHTML = tabsHTML;


      try {
        // 1. まずベースのクエリを作る（2026年以降＋日付順）
        let query = client
          .from("hour_logs")
          .select("*")
          .gte("date", "2026-01-01")
          .order("date", { ascending: false });

        // 2. 「すべて」以外が選ばれている場合だけ、さらにマシンIDで絞り込む
        if (machineId !== 'all') {
          query = query.eq("machine_id", machineId);
        }

        const { data, error } = await query;
        if (error) throw error;

        // もしデータが0件なら「データなし」と表示して終わる（エラーで止めない）
        if (!data || data.length === 0) {
          console.warn("⚠️ 2026年のデータが見つかりません");
          const rankingContainer = document.getElementById("rankList");
          if (rankingContainer) rankingContainer.innerHTML = "データなし";
          return;
        }

        // 集計
        const summary = {};
        data.forEach(log => {
          let name = "不明";
          if (typeof allMachines !== 'undefined') {
            const m = allMachines.find(item => String(item.id) === String(log.machine_id));
            if (m) name = m.name;
          }
          const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
          summary[name] = (summary[name] || 0) + (h > 0 ? h : 0);
        });

        // ランキング表示（上位3位）
        const sorted = Object.entries(summary).sort((a, b) => b[1] - a[1]);
        const rankingContainer = document.getElementById("rankList");
        if (rankingContainer) {
          const crownColors = ['text-yellow-500', 'text-gray-400', 'text-amber-600'];
          rankingContainer.innerHTML = sorted.slice(0, 3).map(([name, hours], i) => `
            <div class="flex flex-col items-center px-1 text-center" style="min-width: 75px;">
              <div class="mb-1"><i class="fa-solid fa-crown ${crownColors[i]} text-xl"></i></div>
              <span class="text-[10px] font-bold text-gray-700 truncate w-20 leading-tight">${name}</span>
            </div>
          `).join('');
        }

        // --- KPIカードの集計と反映 ---
        if (data) {
          let totalH = 0;
          let totalF = 0;
          const daysSet = new Set();

          data.forEach(log => {
            // 稼働時間の計算
            const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
            totalH += (h > 0 ? h : 0);

            // ✅ 給油量を fuel_amount から取得
            totalF += (parseFloat(log.fuel_amount) || 0);

            // 作業日数のカウント
            if (log.date) daysSet.add(log.date);
          });

          // 燃費計算 (給油合計 ÷ 稼働時間合計)
          const fuelAvg = totalH > 0 ? (totalF / totalH).toFixed(2) : "0.00";

          // HTML要素への反映
          const elH = document.getElementById("kpi-hours");
          const elF = document.getElementById("kpi-fuel");
          const elA = document.getElementById("kpi-avg");
          const elD = document.getElementById("kpi-days");

          if (elH) elH.innerText = totalH.toFixed(1);
          if (elF) elF.innerText = totalF.toFixed(1);
          if (elA) elA.innerText = fuelAvg;
          if (elD) elD.innerText = daysSet.size;

          console.log("✅ KPI更新完了 (fuel_amount使用):", { totalH, totalF, fuelAvg });
        }

        if (typeof drawCharts === 'function') {
          drawCharts(data);
        }

      } catch (e) {
        console.error("❌ ダッシュボード描画エラー:", e);
      }
    }

    async function saveMaintenanceRecord() {
      const item = document.getElementById('newMaintenanceItem')?.value;
      const operator = document.getElementById('newMaintenanceOperator')?.value;
      const status = document.getElementById('newMaintenanceStatus')?.value;
      const memo = document.getElementById('newMaintenanceMemo')?.value;

      // window.currentMachineId を明示的に数値として取得する
      let mId = window.currentMachineId;
      const numericMachineId = parseInt(mId);

      // 数値じゃない（"all"や空っぽ）場合はエラーを出す
      if (isNaN(numericMachineId)) {
        alert("機械の情報を読み取れませんでした。一度一覧に戻って選び直してください🌸");
        return;
      }

      if (!item) {
        alert("交換部品・項目名を入力してくださいね🌸");
        return;
      }

      try {
        const { error } = await client.from('maintenance_records').insert([
          {
            item_name: item,
            operator: operator,
            status: status,
            memo: memo,
            date: new Date().toISOString().split('T')[0],
            machine_id: numericMachineId // ここで数値を使う
          }
        ]);

        if (error) throw error;

        alert("メンテナンス情報を記録しました！✨");

        // 入力欄をクリア
        document.getElementById('newMaintenanceItem').value = '';
        document.getElementById('newMaintenanceMemo').value = '';

        // 履歴の表示を更新（この関数がある場合）
        if (typeof loadMaintenanceHistory === 'function') {
          loadMaintenanceHistory(numericMachineId);
        }

      } catch (err) {
        console.error("Maint Save Error:", err);
        alert("保存に失敗しました: " + (err.message || JSON.stringify(err)));
      }
    }

    async function saveLog() {
      const machineId = document.getElementById('machineSelect')?.value;
      const workDate = document.getElementById('workDate')?.value;
      const operator = document.getElementById('operator')?.value;
      const category = document.getElementById('category')?.value;
      const workName = document.getElementById('work_name')?.value;
      const hourBefore = parseFloat(document.getElementById('hourBefore')?.value) || 0;
      const hourAfter = parseFloat(document.getElementById('hourAfter')?.value) || 0;
      const fuel = parseFloat(document.getElementById('fuelAmount')?.value) || 0;
      const memo = document.getElementById('memoInput')?.value;

      // バリデーション（入力チェック）
      if (!machineId) return alert("機械を選択してください");
      if (!workDate || !workName) return alert("「作業日」「作業内容」は必須項目です");
      if (hourAfter < hourBefore) return alert("エラー：稼働後の数値が稼働前より小さくなっています。");

      // 以前のスタイル：showModal を使って確認してから保存
      showModal("登録確認", "ログを登録しますか？", async () => {
        try {
          const { error } = await client.from('hour_logs').insert([{
            date: workDate,
            operator: operator,
            machine_id: parseInt(machineId),
            start_hour: hourBefore,
            end_hour: hourAfter,
            category: category,
            task: workName,
            fuel_amount: fuel,
            memo: memo
          }]);

          if (error) throw error;

          // 保存成功後、以前のようにページをリロードしてすべてリセット
          location.reload();

        } catch (err) {
          console.error("Log Save Error:", err);
          alert("保存に失敗しました: " + (err.message));
        }
      });
    }

    // --- Google Vision APIを使って画像から数字を読み取る関数 ---
    async function performOCR(base64Image) {
      const url = `https://vision.googleapis.com/v1/images:annotate?key=${GOOGLE_VISION_API_KEY}`;

      const requestData = {
        requests: [{
          image: { content: base64Image },
          features: [{ type: "TEXT_DETECTION" }]
        }]
      };

      try {
        const response = await fetch(url, {
          method: "POST",
          body: JSON.stringify(requestData)
        });
        const result = await response.json();

        // 読み取った全テキストを結合
        const detections = result.responses[0].textAnnotations;
        if (!detections || detections.length === 0) return null;

        const fullText = detections[0].description;
        console.log("🔍 OCR読み取り結果:", fullText);

        // テキストから「数字（小数点含む）」だけを抽出する（例: "123.4"）
        const match = fullText.match(/\d+(\.\d+)?/);
        return match ? match[0] : null;
      } catch (err) {
        console.error("❌ OCRエラー:", err);
        return null;
      }
    }

    // ハンドラ：稼働後の数値を画像から読み取る
    async function handleHourAfterImage(input) {
      const file = input.files[0];
      if (!file) return;

      try {
        const base64Image = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.readAsDataURL(file);
        });

        // OCR 実行
        const text = await performOCR(base64Image);
        if (!text) return alert('読み取りに失敗しました。写真を変えて再試行してください。');

        // 数字（小数点含む）を抽出して input に反映
        const m = text.match(/\d+(?:\.\d+)?/);
        if (m) {
          document.getElementById('hourAfter').value = m[0];
          calcDiff();
        } else {
          alert('数字が検出されませんでした。読み取り結果:\n' + (text.substring(0,200) || '-----'));
        }
      } catch (err) {
        console.error('HourAfter OCR error', err);
        alert('読み取り中にエラーが発生しました');
      } finally {
        // ファイル入力をクリアして同じ画像を再選択できるようにする
        input.value = '';
      }
    }

    // ========== 田植え機用の関数 ==========
    async function initTauePage() {
      // 田植え機の機械リストを取得
      const { data: taueMachines } = await client
        .from("machines")
        .select("*")
        .eq("machine_type", "transplanter")
        .order("name");

      // オペレーター取得
      const { data: operators } = await client
        .from("operators")
        .select("*")
        .order("id");

      // 油種取得
      const { data: fuelTypes } = await client
        .from("fuel_types")
        .select("*");

      // 作業内容取得（category = '田植え'）
      const { data: workTypes, error: workTypesError } = await client
        .from("work_types")
        .select("*")
        .eq("category", "田植え");

      console.log("田植え機 作業内容データ:", workTypes);
      console.log("田植え機 作業内容エラー:", workTypesError);
      if (workTypes && workTypes.length > 0) {
        console.log("最初のデータのキー:", Object.keys(workTypes[0]));
      }

      // 機械選択
      const taue_machineSelect = document.getElementById("taue_machineSelect");
      if (taue_machineSelect) {
        taue_machineSelect.innerHTML = '<option value="">選択</option>' +
          (taueMachines || []).map(m => `<option value="${m.id}">${m.name}</option>`).join("");
      }

      // オペレーター選択
      const taue_operator = document.getElementById("taue_operator");
      if (taue_operator) {
        taue_operator.innerHTML = '<option value="">選択</option>' +
          (operators || []).map(o => `<option value="${o.name}">${o.name}</option>`).join("");
      }

      // 油種選択
      const taue_fuelType = document.getElementById("taue_fuelType");
      if (taue_fuelType) {
        taue_fuelType.innerHTML = '<option value="">選択</option>' +
          (fuelTypes || []).map(f => `<option value="${f.name}">${f.name}</option>`).join("");
      }

      // 作業内容選択
      const taue_work_name = document.getElementById("taue_work_name");
      if (taue_work_name) {
        taue_work_name.innerHTML = '<option value="">選択</option>' +
          (workTypes || []).map(w => `<option value="${w.work_name}">${w.work_name}</option>`).join("");
        console.log("田植え機 作業内容セレクトボックス設定完了:", taue_work_name.innerHTML);
      }

      // 履歴検索フィルター - 機械選択
      const filterMachinePlanting = document.getElementById("filterMachinePlanting");
      if (filterMachinePlanting) {
        filterMachinePlanting.innerHTML = '<option value="">すべて</option>' +
          (taueMachines || []).map(m => `<option value="${m.id}">${m.name}</option>`).join("");
      }

      // 履歴検索フィルター - オペレーター選択
      const filterOperatorPlanting = document.getElementById("filterOperatorPlanting");
      if (filterOperatorPlanting) {
        filterOperatorPlanting.innerHTML = '<option value="">すべて</option>' +
          (operators || []).map(o => `<option value="${o.id}">${o.name}</option>`).join("");
      }

      // 履歴検索フィルター - 作業内容選択
      const filterCategoryPlanting = document.getElementById("filterCategoryPlanting");
      if (filterCategoryPlanting) {
        filterCategoryPlanting.innerHTML = '<option value="">すべて</option>' +
          (workTypes || []).map(w => `<option value="${w.work_name}">${w.work_name}</option>`).join("");
      }

      // 履歴検索フィルター - 月の初期値設定
      const filterMonthPlanting = document.getElementById("filterMonthPlanting");
      if (filterMonthPlanting) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        filterMonthPlanting.value = `${year}-${month}`;
      }
    }

    async function taue_autoFillHour() {
      const mId = document.getElementById("taue_machineSelect").value;
      if (!mId) return;
      const { data } = await client.from("planting_logs").select("end_hour").eq("machine_id", mId).order("date", { ascending: false }).order("created_at", { ascending: false }).limit(1);
      if (data && data.length > 0) { document.getElementById("taue_hourBefore").value = data[0].end_hour; taue_calcDiff(); }
    }

    function taue_calcDiff() {
      const b = parseFloat(document.getElementById("taue_hourBefore").value) || 0;
      const a = parseFloat(document.getElementById("taue_hourAfter").value) || 0;
      const d = a - b;
      const disp = document.getElementById("taue_hourDiffDisplay");

      if (a > 0 && a < b) {
        disp.classList.remove("text-[#6b8f71]");
        disp.classList.add("text-red-500");
        disp.textContent = `稼働時間: 0.0 h (入力エラー)`;
      } else {
        disp.classList.remove("text-red-500");
        disp.classList.add("text-[#6b8f71]");
        disp.textContent = `稼働時間: ${d > 0 ? d.toFixed(1) : "0.0"} h`;
      }
    }

    async function taue_saveLog() {
      const machineId = document.getElementById('taue_machineSelect')?.value;
      const workDate = document.getElementById('taue_workDate')?.value;
      const operator = document.getElementById('taue_operator')?.value;
      const workName = document.getElementById('taue_work_name')?.value;
      const hourBefore = parseFloat(document.getElementById('taue_hourBefore')?.value) || 0;
      const hourAfter = parseFloat(document.getElementById('taue_hourAfter')?.value) || 0;
      const fuelType = document.getElementById('taue_fuelType')?.value;
      const fuel = parseFloat(document.getElementById('taue_fuelAmount')?.value) || 0;
      const memo = document.getElementById('taue_memoInput')?.value;

      if (!machineId) return alert("機械を選択してください");
      if (!workDate || !workName) return alert("「作業日」「作業内容」は必須項目です");
      if (hourAfter < hourBefore) return alert("エラー：稼働後の数値が稼働前より小さくなっています。");

      showModal("登録確認", "ログを登録しますか？", async () => {
        try {
          const { error } = await client.from('planting_logs').insert([{
            date: workDate,
            operator_id: operator ? parseInt(operator) : null,
            machine_id: parseInt(machineId),
            start_hour: hourBefore,
            end_hour: hourAfter,
            task: workName,
            fuel_type_id: fuelType ? parseInt(fuelType) : null,
            fuel_amount: fuel,
            memo: memo
          }]);

          if (error) throw error;
          location.reload();

        } catch (err) {
          console.error("Log Save Error:", err);
          alert("保存に失敗しました: " + (err.message));
        }
      });
    }

    async function taue_handleHourAfterImage(input) {
      const file = input.files[0];
      if (!file) return;

      try {
        const base64Image = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.readAsDataURL(file);
        });

        const text = await performOCR(base64Image);
        if (!text) return alert('読み取りに失敗しました。写真を変えて再試行してください。');

        const m = text.match(/\d+(?:\.\d+)?/);
        if (m) {
          document.getElementById('taue_hourAfter').value = m[0];
          taue_calcDiff();
        } else {
          alert('数字が検出されませんでした。読み取り結果:\n' + (text.substring(0,200) || '-----'));
        }
      } catch (err) {
        console.error('HourAfter OCR error', err);
        alert('読み取り中にエラーが発生しました');
      } finally {
        input.value = '';
      }
    }

    // ========== 田植え機用のログ読み込み関数 ==========
    async function loadLogsPlanting(elId, todayOnly) {
      const list = document.getElementById(elId);
      list.innerHTML = "<p class='text-center py-10 opacity-50 text-xs'>読込中...</p>";

      let query = client.from("planting_logs").select("*, machines(name), operators(name)").order("date", { ascending: false });

      if (todayOnly) {
        const jstToday = new Date().toLocaleDateString('sv-SE');
        query = query.eq("date", jstToday);
      } else {
        const month = document.getElementById("filterMonthPlanting").value;
        const machine = document.getElementById("filterMachinePlanting").value;
        const operator = document.getElementById("filterOperatorPlanting").value;
        const category = document.getElementById("filterCategoryPlanting").value;

        if (month) query = query.gte("date", `${month}-01`).lte("date", `${month}-31`);
        if (machine) query = query.eq("machine_id", machine);
        if (operator) query = query.eq("operator_id", operator);
        if (category) query = query.eq("task", category);
      }

      const { data, error } = await query;
      if (error) {
        console.error("データ取得エラー:", error);
        console.error("エラー詳細:", error.message, error.details, error.hint);
        list.innerHTML = `<p class='text-center py-10 text-red-500 text-xs'>エラー: ${error.message}</p>`;
        return;
      }

      let total = 0;
      const displayData = todayOnly ? [...(data || [])].reverse() : (data || []);

      list.innerHTML = displayData.map(l => {
        const diff = (l.end_hour - l.start_hour);
        total += diff;
        return `<div class="card border-l-4 border-[#6b8f71] !mb-3 !py-3 flex justify-between items-center">
              <div>
                <b class="text-sm">${l.date} - ${l.machines?.name}</b>
                <p class="text-xs opacity-70 mt-1">${l.operators?.name || '不明'} | ${l.task}</p>
                <div class="flex gap-4 mt-2">
                  <span class="text-[11px] font-bold log-badge px-2 py-1 rounded"><i class="fa-solid fa-clock mr-1 text-[#6b8f71]"></i>${diff.toFixed(1)} h</span>
                  <span class="text-[11px] font-bold log-badge px-2 py-1 rounded"><i class="fa-solid fa-gas-pump mr-1 text-[#6b8f71]"></i>${l.fuel_amount || 0} L</span>
                  ${l.fuel_type_id ? `<span class="text-[11px] font-bold log-badge px-2 py-1 rounded">ID:${l.fuel_type_id}</span>` : ''}
                </div>
              </div>
              <button onclick="deleteLogPlanting(${l.id})" class="text-gray-400 p-2 hover:text-red-500 transition-colors">
                <i class="fa-regular fa-trash-can text-lg"></i>
              </button>
            </div>`;
      }).join("");

      if (!todayOnly) {
        const totalEl = document.getElementById("historyTotalHoursPlanting");
        if (totalEl) totalEl.innerText = `合計: ${total.toFixed(1)} h`;
      }
    }

    async function deleteLogPlanting(id) {
      showModal("削除確認", "このログを削除しますか？", async () => {
        const { error } = await client.from("planting_logs").delete().eq("id", id);
        if (!error) {
          if (document.getElementById("todayViewPlanting").classList.contains("active")) loadLogsPlanting("todayLogListPlanting", true);
          else loadLogsPlanting("historyLogListPlanting", false);
        }
      });
    }

    // ========== 田植え機用 メンテナンス記録関数 ==========
    async function loadMachineListPlanting() {
      try {
        const { data: machines, error } = await client
          .from("machines")
          .select("*")
          .eq("machine_type", "transplanter")
          .order("id");

        if (error) throw error;

        const container = document.getElementById("maintenanceMachineGridPlanting");
        if (!container) return;
        container.innerHTML = "";

        const grouped = {};
        machines.forEach(m => {
          const manufacturer = m.manufacturer || "その他";
          if (!grouped[manufacturer]) grouped[manufacturer] = [];
          grouped[manufacturer].push(m);
        });

        for (const brand of Object.keys(grouped)) {
          const brandHeader = document.createElement("h3");
          brandHeader.className = "text-[#6b8f71] font-bold text-sm mb-2 mt-4 flex items-center gap-2";
          brandHeader.innerHTML = `<i class="fa-solid fa-tag opacity-50"></i> ${brand}`;
          container.appendChild(brandHeader);

          const grid = document.createElement("div");
          grid.className = "grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-4";

          for (const m of grouped[brand]) {
            const card = document.createElement("div");
            card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-all active:scale-95";
            card.onclick = () => openMaintenanceDetailPlanting(m.id);

            card.innerHTML = `
              <div class="flex flex-col gap-2">
                <div class="flex items-center gap-3">
                  <div style="color: #6b8f71;" class="text-xl flex-shrink-0">
                    <i class="fa-solid fa-seedling"></i>
                  </div>
                  <div class="font-bold text-gray-900 text-lg truncate">${m.name}</div>
                </div>
                <div class="border-t border-gray-50 pt-2" id="card-progress-planting-${m.id}">
                  <div class="text-[11px] text-gray-400 flex items-center gap-1">
                    <i class="fa-solid fa-circle-notch fa-spin text-[9px]"></i> 確認中...
                  </div>
                </div>
              </div>
            `;
            grid.appendChild(card);

            (async () => {
              try {
                const { data: checks } = await client
                  .from('maintenance_status')
                  .select('item_id, status')
                  .filter('item_id', 'ilike', `${m.id}_%`);

                const totalItems = 16;
                const uniqueChecks = {};
                if (checks) {
                  checks.forEach(c => { uniqueChecks[c.item_id] = c.status; });
                }

                const completedCount = Object.values(uniqueChecks).filter(status => status === true || status === "true").length;
                let percent = Math.round((completedCount / totalItems) * 100);
                percent = Math.min(100, percent);

                const progressDiv = document.getElementById(`card-progress-planting-${m.id}`);
                if (progressDiv) {
                  let statusHTML = percent === 0
                    ? `<span class="text-red-600 font-black"><i class="fa-solid fa-circle-exclamation text-[9px]"></i> 未着手</span>`
                    : percent === 100
                      ? `<span class="text-[#6b8f71] font-black"><i class="fa-solid fa-circle-check text-[9px]"></i> 完了</span>`
                      : `<span class="text-orange-500 font-black"><i class="fa-solid fa-spinner text-[9px]"></i> ${percent}% 完了</span>`;

                  progressDiv.innerHTML = `
                    <div class="text-[11px] flex items-center gap-1">${statusHTML}</div>
                    <div class="w-full bg-gray-100 rounded-full h-1 mt-1">
                      <div class="bg-[#6b8f71] h-1 rounded-full transition-all duration-500" style="width: ${percent}%"></div>
                    </div>
                  `;
                }
              } catch (err) { console.error("カード進捗更新エラー:", err); }
            })();
          }
          container.appendChild(grid);
        }
      } catch (e) { console.error("一覧読み込みエラー:", e); }
    }

    async function openMaintenanceDetailPlanting(machineId) {
      window.currentMachineIdPlanting = machineId;
      switchView('maintenanceDetailViewPlanting');

      try {
        const { data: machine } = await client.from("machines").select("*").eq("id", machineId).single();
        document.getElementById("maintenanceMachineNamePlanting").textContent = machine.name;

        const { data: operators } = await client.from('operators').select('name').order('id');
        const opSelect = document.getElementById('newMaintenanceOperatorPlanting');
        if (opSelect && operators) {
          opSelect.innerHTML = '<option value="">担当者を選択</option>';
          operators.forEach(op => {
            const opt = document.createElement('option');
            opt.value = op.name; opt.textContent = op.name;
            opSelect.appendChild(opt);
          });
        }

        loadMaintenanceHistoryPlanting(machineId);
        const { data: items } = await client.from("maintenance_items_transplanter").select("*").order("id");
        const checklistContainer = document.getElementById("maintenanceChecklistPlanting");
        if (checklistContainer && items) {
          checklistContainer.innerHTML = "";
          items.forEach(item => {
            const uniqueId = `${machineId}_${item.id}`;
            const div = document.createElement("div");
            div.className = "flex items-center justify-between p-3 border-b border-gray-50 last:border-0 hover:bg-gray-50 transition-colors";
            div.innerHTML = `
              <div class="flex flex-col flex-1 text-left">
                  <span class="text-sm font-bold text-gray-700">${item.item_name}</span>
                  <span class="text-[10px] text-gray-400">${item.description || ''}</span>
              </div>
              <input type="checkbox" id="${uniqueId}" class="maintenance-check w-6 h-6 rounded border-gray-300 text-[#6b8f71]"
                     onchange="saveSingleCheckPlanting('${machineId}', '${item.id}', this.checked)">
            `;
            checklistContainer.appendChild(div);
          });
        }
        await restoreMaintenanceChecksPlanting();
      } catch (e) { console.error(e); }
    }

    function updateMaintenanceProgressPlanting() {
      const checkboxes = document.querySelectorAll('#maintenanceChecklistPlanting input[type="checkbox"]');
      const total = checkboxes.length;
      if (total === 0) return;
      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
      const percentage = Math.round((checkedCount / total) * 100);
      const summaryDiv = document.getElementById('maintenanceSummaryPlanting');
      if (summaryDiv) {
        summaryDiv.innerHTML = `
          <div class="flex justify-between items-center mb-1">
            <span class="font-bold text-[#6b8f71]">${percentage}% 完了</span>
            <span class="text-xs text-gray-400">${checkedCount} / ${total} 項目</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="bg-[#6b8f71] h-2 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
          </div>
        `;
      }
    }

    async function saveSingleCheckPlanting(machineId, itemId, isChecked) {
      try {
        const uniqueId = `${machineId}_${itemId}`;
        await client.from('maintenance_status').upsert({
          item_id: uniqueId, status: Boolean(isChecked), updated_at: new Date()
        }, { onConflict: 'item_id' });
        updateMaintenanceProgressPlanting();
        loadMachineListPlanting();
      } catch (e) { console.error(e); }
    }

    async function restoreMaintenanceChecksPlanting() {
      try {
        const { data } = await client.from('maintenance_status').select('item_id, status');
        if (data) {
          data.forEach(row => {
            const el = document.getElementById(row.item_id);
            if (el) el.checked = row.status;
          });
        }
        updateMaintenanceProgressPlanting();
      } catch (e) { console.error(e); }
    }

    async function loadMaintenanceHistoryPlanting(machineId) {
      try {
        const { data } = await client.from('maintenance_records').select('*').eq('machine_id', machineId).order('created_at', { ascending: false });
        const container = document.getElementById('maintenanceHistoryLogPlanting');
        if (!container) return;
        if (!data || data.length === 0) {
          container.innerHTML = '<p class="italic text-gray-400 text-center py-4">履歴はありません</p>';
          return;
        }
        container.innerHTML = data.map(rec => `
          <div class="border-b border-gray-100 pb-2 mb-2 last:border-0 text-left">
            <div class="flex justify-between font-bold text-gray-700"><span>${rec.item_name}</span><span class="text-gray-400 text-[9px]">${rec.date}</span></div>
            <div class="text-gray-500">担当: ${rec.operator}</div>
            ${rec.memo ? `<div class="text-gray-400 italic">"${rec.memo}"</div>` : ''}
          </div>`).join('');
      } catch (e) { console.error(e); }
    }

    async function saveMaintenanceRecordPlanting() {
      const item = document.getElementById('newMaintenanceItemPlanting')?.value;
      const operator = document.getElementById('newMaintenanceOperatorPlanting')?.value;
      const status = document.getElementById('newMaintenanceStatusPlanting')?.value;
      const memo = document.getElementById('newMaintenanceMemoPlanting')?.value;

      let mId = window.currentMachineIdPlanting;
      const numericMachineId = parseInt(mId);

      if (isNaN(numericMachineId)) {
        alert("機械の情報を読み取れませんでした。一度一覧に戻って選び直してください🌸");
        return;
      }

      if (!item) {
        alert("交換部品・項目名を入力してくださいね🌸");
        return;
      }

      try {
        const { error } = await client.from('maintenance_records').insert([
          {
            item_name: item,
            operator: operator,
            status: status,
            memo: memo,
            date: new Date().toISOString().split('T')[0],
            machine_id: numericMachineId
          }
        ]);

        if (error) throw error;

        alert("メンテナンス情報を記録しました！✨");

        document.getElementById('newMaintenanceItemPlanting').value = '';
        document.getElementById('newMaintenanceMemoPlanting').value = '';

        if (typeof loadMaintenanceHistoryPlanting === 'function') {
          loadMaintenanceHistoryPlanting(numericMachineId);
        }

      } catch (err) {
        console.error("Maint Save Error:", err);
        alert("保存に失敗しました: " + (err.message || JSON.stringify(err)));
      }
    }

    // ========== 田植え機用 Dashboard 描画関数 ==========
    async function renderDashboardPlanting(machineId = 'all') {
      const machineTabs = document.getElementById("machineTabsPlanting");
      if (!machineTabs) return;

      window.currentViewMachineIdPlanting = machineId;
      console.log("🌾 田植え機ダッシュボード描画中... ID:", machineId);
      const currentId = machineId;
      const allBtnClass = (currentId === 'all') ? 'active' : 'inactive';

      // 田植え機リストを取得
      const { data: plantingMachines } = await client
        .from("machines")
        .select("*")
        .eq("machine_type", "transplanter")
        .order("name");

      let tabsHTML = `
        <button onclick="renderDashboardPlanting('all')" 
                class="tab-btn ${allBtnClass}" 
                style="min-width: 80px; letter-spacing: 0.2em;">全 体</button>
      `;

      if (plantingMachines && plantingMachines.length > 0) {
        tabsHTML += plantingMachines.map(m => {
          const isActive = (String(m.id) === String(currentId)) ? 'active' : 'inactive';
          return `
            <button onclick="renderDashboardPlanting(${m.id})" 
                    class="tab-btn ${isActive}">${m.name}</button>
          `;
        }).join("");
      }
      machineTabs.innerHTML = tabsHTML;

      try {
        // 2026年以降のplanting_logsデータを取得
        let query = client
          .from("planting_logs")
          .select("*")
          .gte("date", "2026-01-01")
          .order("date", { ascending: false });

        if (machineId !== 'all') {
          query = query.eq("machine_id", machineId);
        }

        const { data, error } = await query;
        if (error) throw error;

        if (!data || data.length === 0) {
          console.warn("⚠️ 2026年の田植え機データが見つかりません");
          const rankingContainer = document.getElementById("rankListPlanting");
          if (rankingContainer) rankingContainer.innerHTML = "データなし";
          return;
        }

        // 機械ごとの稼働時間集計
        const summary = {};
        data.forEach(log => {
          let name = "不明";
          if (plantingMachines) {
            const m = plantingMachines.find(item => String(item.id) === String(log.machine_id));
            if (m) name = m.name;
          }
          const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
          summary[name] = (summary[name] || 0) + (h > 0 ? h : 0);
        });

        // ランキング表示（上位3位）
        const sorted = Object.entries(summary).sort((a, b) => b[1] - a[1]);
        const rankingContainer = document.getElementById("rankListPlanting");
        if (rankingContainer) {
          const crownColors = ['text-yellow-500', 'text-gray-400', 'text-amber-600'];
          rankingContainer.innerHTML = sorted.slice(0, 3).map(([name, hours], i) => `
            <div class="flex flex-col items-center px-1 text-center" style="min-width: 75px;">
              <div class="mb-1"><i class="fa-solid fa-crown ${crownColors[i]} text-xl"></i></div>
              <span class="text-[10px] font-bold text-gray-700 truncate w-20 leading-tight">${name}</span>
            </div>
          `).join('');
        }

        // KPIカードの集計と反映
        if (data) {
          let totalH = 0;
          let totalF = 0;
          const daysSet = new Set();

          data.forEach(log => {
            const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
            totalH += (h > 0 ? h : 0);
            totalF += (parseFloat(log.fuel_amount) || 0);
            if (log.date) daysSet.add(log.date);
          });

          const fuelAvg = totalH > 0 ? (totalF / totalH).toFixed(2) : "0.00";

          const elH = document.getElementById("kpi-hours-planting");
          const elF = document.getElementById("kpi-fuel-planting");
          const elA = document.getElementById("kpi-avg-planting");
          const elD = document.getElementById("kpi-days-planting");

          if (elH) elH.innerText = totalH.toFixed(1);
          if (elF) elF.innerText = totalF.toFixed(1);
          if (elA) elA.innerText = fuelAvg;
          if (elD) elD.innerText = daysSet.size;

          console.log("✅ 田植え機 KPI更新完了:", { totalH, totalF, fuelAvg });
        }

        // チャート描画（田植え機用のチャートを描画する関数があればここで呼び出す）
        if (typeof drawChartsPlanting === 'function') {
          drawChartsPlanting(data);
        }

      } catch (e) {
        console.error("❌ 田植え機ダッシュボード描画エラー:", e);
      }
    }

    // Duplicate/old secondary `loadRepairDashboard` removed.
    // The primary `loadRepairDashboard` (defined earlier) is used to populate
    // 年ごとの修理費 / 機械ごとの修理費 / 最近の修理一覧 など。

    // ========== 田植え機用の修理履歴読み込み関数 ==========
    async function loadRepairDashboardPlanting() {
      try {
        // repair_logs をすべて取得し、machine_type='transplanter'でフィルタリング
        const { data: machines, error: machinesError } = await client
          .from('machines')
          .select('id')
          .eq('machine_type', 'transplanter');

        if (machinesError) {
          console.error('Error loading machines:', machinesError);
          return;
        }

        const transplantMachineIds = machines.map(m => m.id);

        const { data: logs, error } = await client
          .from('repair_logs')
          .select('*')
          .in('machine_id', transplantMachineIds)
          .order('date', { ascending: false });

        if (error) {
          console.error('Error loading repair logs:', error);
          return;
        }

        // -----------------------------
        // ① 累計修理費
        // -----------------------------
        const totalCost = logs.reduce((sum, log) => sum + (log.cost || 0), 0);
        document.getElementById('totalRepairCostPlanting').textContent =
          '¥ ' + totalCost.toLocaleString();

        // -----------------------------
        // ② 年ごとの修理費
        // -----------------------------
        const yearly = {};
        logs.forEach(log => {
          const year = new Date(log.date).getFullYear();
          if (!yearly[year]) yearly[year] = 0;
          yearly[year] += log.cost || 0;
        });

        const yearlyContainer = document.getElementById('yearlyRepairContainerPlanting');
        yearlyContainer.innerHTML = '';

        Object.keys(yearly)
          .sort((a, b) => b - a)
          .forEach(year => {
            const card = document.createElement('div');
            card.className =
              'p-3 bg-white rounded-md shadow text-center border border-gray-100';
            card.innerHTML = `
          <div class="text-sm text-gray-500">${year}年</div>
          <div class="text-lg font-bold text-[#6b8f71]">¥ ${yearly[year].toLocaleString()}</div>
        `;
            yearlyContainer.appendChild(card);
          });

        // -----------------------------
        // ③ 機械ごとの修理費
        // -----------------------------
        const machineTotals = {};

        logs.forEach(log => {
          if (!machineTotals[log.machine_id]) machineTotals[log.machine_id] = 0;
          machineTotals[log.machine_id] += log.cost || 0;
        });

        // machines テーブルから名前を取得
        const { data: allMachines } = await client.from('machines').select('*');

        const machineContainer = document.getElementById('machineRepairContainerPlanting');
        machineContainer.innerHTML = '';

        Object.keys(machineTotals).forEach(machineId => {
          const machine = allMachines.find(m => m.id === Number(machineId));
          const name = machine ? machine.name : '不明な機械';

          const card = document.createElement('div');
          card.className =
            'p-3 bg-white rounded-md shadow text-center border border-gray-100';
          card.innerHTML = `
        <div class="text-sm text-gray-500">${name}</div>
        <div class="text-lg font-bold text-[#6b8f71]">¥ ${machineTotals[machineId].toLocaleString()}</div>
      `;
          machineContainer.appendChild(card);
        });

        // -----------------------------
        // ④ 最近の修理履歴（最新5件）
        // -----------------------------
        const recentContainer = document.getElementById('recentRepairContainerPlanting');
        recentContainer.innerHTML = '';

        logs.slice(0, 5).forEach(log => {
          const item = document.createElement('div');
          item.className =
            'p-3 bg-white rounded-md shadow border border-gray-100';

          item.innerHTML = `
        <div class="text-sm text-gray-500">${log.date}</div>
        <div class="font-bold">${log.memo || '(内容なし)'}</div>
        <div class="text-[#6b8f71] font-bold mt-1">¥ ${log.cost.toLocaleString()}</div>
        <div class="text-xs text-gray-400 mt-1">${log.shop || ''}</div>
      `;

          recentContainer.appendChild(item);
        });

      } catch (err) {
        console.error('Unexpected error:', err);
      }
    }

    async function populateMachineSelectPlanting() {
      const { data: machines } = await client
        .from('machines')
        .select('*')
        .eq('machine_type', 'transplanter')
        .order('name');

      const select = document.getElementById('repairMachineSelectPlanting');
      if (!select) return;

      select.innerHTML = '<option value="">選択してください</option>';

      if (machines && machines.length > 0) {
        machines.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.id;
          opt.textContent = m.name;
          select.appendChild(opt);
        });
      } else {
        const opt = document.createElement('option');
        opt.textContent = "田植え機が登録されていません";
        select.appendChild(opt);
      }
    }

    async function previewInvoicePlanting(input) {
      const file = input.files[0];
      if (!file) return;

      const previewImg = document.getElementById('invoicePreviewImgPlanting');
      const previewArea = document.getElementById('invoicePreviewAreaPlanting');
      const saveBtn = document.getElementById('saveRepairBtnPlanting');

      // プレビュー表示
      previewImg.src = URL.createObjectURL(file);
      previewArea.classList.remove('hidden');

      const memoField = document.getElementById('repairMemoPlanting');
      const dateField = document.getElementById('repairDatePlanting');
      const shopField = document.getElementById('repairShopPlanting');
      const costField = document.getElementById('repairCostPlanting');

      saveBtn.disabled = true;
      saveBtn.innerText = "解析中...";

      try {
        const base64 = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });

        const response = await fetch(
          `https://vision.googleapis.com/v1/images:annotate?key=${VISION_API_KEY}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              requests: [{
                image: { content: base64 },
                features: [{ type: 'TEXT_DETECTION', maxResults: 1 }]
              }]
            })
          }
        );

        const data = await response.json();
        const text = data.responses[0]?.fullTextAnnotation?.text || '';

        console.log("OCR解析結果:", text);

        // 日付を抽出（YYYY/MM/DD または YYYY-MM-DD）
        const dateMatch = text.match(/(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})/);
        if (dateMatch) {
          const [_, year, month, day] = dateMatch;
          dateField.value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        }

        // 店舗名（仮のロジック：最初の行を店舗名とする）
        const lines = text.split('\n').filter(line => line.trim());
        if (lines.length > 0) {
          shopField.value = lines[0];
        }

        // 金額を抽出（¥または￥または「円」の前の数字）
        const costMatch = text.match(/[¥￥]?\s*([\d,]+)\s*円?/);
        if (costMatch) {
          costField.value = costMatch[1].replace(/,/g, '');
        }

        memoField.value = text.substring(0, 200);

        saveBtn.disabled = false;
        saveBtn.innerText = "修理履歴を保存";

      } catch (err) {
        console.error("OCR読み取りエラー:", err);
        alert("画像の読み取りに失敗しました");
        saveBtn.disabled = false;
        saveBtn.innerText = "修理履歴を保存";
      }
    }

    async function saveRepairLogPlanting() {
      const machineId = document.getElementById('repairMachineSelectPlanting').value;
      const dateValue = document.getElementById('repairDatePlanting').value;
      const shopValue = document.getElementById('repairShopPlanting').value;
      const costValue = document.getElementById('repairCostPlanting').value;
      const memoValue = document.getElementById('repairMemoPlanting').value;

      if (!dateValue || !costValue) {
        alert("修理日と金額は必須です");
        return;
      }

      const btn = document.getElementById('saveRepairBtnPlanting');
      btn.disabled = true;
      btn.innerText = "保存中...";

      try {
        const { error } = await client
          .from('repair_logs')
          .insert([
            {
              date: dateValue,
              shop: shopValue,
              cost: parseInt(costValue),
              memo: memoValue,
              machine_id: machineId || null
            }
          ]);

        if (error) throw error;

        btn.innerText = "保存完了！";

        loadRepairDashboardPlanting();

        if (typeof showCustomModal === 'function') {
          showCustomModal("保存完了", "修理履歴を記録しました。ダッシュボードを更新します。");
        } else {
          alert("保存完了しました！🌾");
        }

        setTimeout(() => {
          switchView('repairViewPlanting');
          btn.disabled = false;
          btn.innerText = "修理履歴を保存";
        }, 1500);

      } catch (err) {
        console.error("❌ 保存に失敗しました:", err);
        alert("エラーで保存できませんでした: " + err.message);
        btn.disabled = false;
        btn.innerText = "修理履歴を保存";
      }
    }
  </script>
</body>

</html>