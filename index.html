<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex">
  <link rel="manifest" href="/tractorlog/manifest.json">
  <title>和農日向 Tractor Log</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* --- 基本スタイル --- */
    body { background-color: #e2e8e3; color: #3a3a3a; font-family: "Hiragino Sans", "Noto Sans JP", sans-serif; margin: 0; }
    .view { display: none; }
    .view.active { display: block; }
    
    #sideMenu { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: white; z-index: 9999; transition: left 0.3s ease; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
    #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 9998; display: none; }
    .menu-item { width: 100%; text-align: left; padding: 0.8rem; border-radius: 0.5rem; font-weight: bold; color: #6b8f71; display: flex; align-items: center; font-size: 0.9rem; }
    
    select, input, textarea { color: #3a3a3a !important; background-color: #ffffff !important; border: 1px solid #ddd; }

    .card { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); margin-bottom: 16px; position: relative; overflow: hidden; }
    .btn-main { background-color: #6b8f71; color: white; padding: 14px; border-radius: 12px; text-align: center; font-weight: bold; width: 100%; display: block; }
    .btn-sub { background-color: #6b8f71; color: white; padding: 12px; border-radius: 10px; text-align: center; font-weight: bold; width: 100%; margin-top: 20px; display: block; }

    .log-badge { background-color: #f3f4f6; color: #374151; }

    /* --- DASHBOARD --- */
    #dashboard.active { display: flex !important; flex-direction: column; min-height: 100vh; overflow-x: hidden; }
    .bi-header { height: 65px; display: flex; align-items: center; background: #2d4031; color: white; flex-shrink: 0; width: 100%; padding: 0 20px; }
    
    .dashboard-top-bar { flex-shrink: 0; padding: 10px 15px; }
    
    .main-top-row { display: flex; flex-wrap: wrap; gap: 15px; align-items: stretch; }
    .kpi-section { flex: 1; min-width: 320px; display: flex; flex-direction: column; gap: 10px; }
    .ranking-section { flex: 0.4; min-width: 250px; background: rgba(255,255,255,0.6); border-radius: 12px; padding: 10px 12px; display: flex; flex-direction: column; justify-content: center; }

    .kpi-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
    .kpi-card { background: #6b8f71; color: white; padding: 8px 2px; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .kpi-label { font-size: 9px; font-weight: bold; opacity: 0.9; }
    .kpi-value-container { display: flex; align-items: baseline; gap: 1px; }
    .kpi-value { font-size: 14px; font-weight: 900; }
    .kpi-unit { font-size: 8px; opacity: 0.8; font-weight: bold; }

    .bi-container { flex: 1; display: flex; flex-wrap: wrap; padding: 12px; gap: 12px; align-items: stretch; }
    .bi-left-col { flex: 1.1; min-width: 280px; display: flex; flex-direction: column; gap: 12px; }
    .bi-main-col { flex: 1.8; min-width: 320px; display: flex; flex-direction: column; gap: 12px; }
    .bi-right-col { width: 300px; display: flex; flex-direction: column; gap: 12px; flex-shrink: 0; }

    @media (max-width: 1024px) {
      .bi-right-col { width: 100%; flex: 1; }
    }

    .bi-container > div > .card { margin-bottom: 0 !important; flex: 1; display: flex; flex-direction: column; }
    
    .chart-title { font-size: 12px; font-weight: bold; color: #6b8f71; margin-bottom: 8px; }
    .chart-wrapper { flex: 1; position: relative; width: 100%; min-height: 150px; display: flex; align-items: center; justify-content: center; }
    .donut-icon { position: absolute; font-size: 24px; color: #6b8f71; opacity: 0.3; pointer-events: none; }

    #customModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(4px); padding: 20px; }
    #customModal.active { display: flex; }
    .modal-content { background: white; width: 100%; max-width: 320px; border-radius: 20px; overflow: hidden; }

    .tab-btn { padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: bold; cursor: pointer; white-space: nowrap; border: none; }
    .tab-btn.active { background: #2d4031; color: white; }
    .tab-btn.inactive { background: rgba(255,255,255,0.5); color: #6b8f71; }
  </style>
</head>
<body>

<div id="overlay" onclick="closeMenu()"></div>
<div id="sideMenu">
  <div class="flex justify-between items-center mb-6">
    <h2 class="font-bold text-lg text-[#6b8f71]">メニュー</h2>
    <button onclick="closeMenu()" class="text-2xl text-gray-400">&times;</button>
  </div>
  <nav class="space-y-1">
    <button onclick="switchView('inputView')" class="menu-item"><i class="fa-solid fa-pen-to-square w-8 text-lg"></i>ログ入力</button>
    <button onclick="switchView('todayView')" class="menu-item"><i class="fa-solid fa-calendar-day w-8 text-lg"></i>本日の稼働状況</button>
    <button onclick="switchView('historyView')" class="menu-item"><i class="fa-solid fa-magnifying-glass w-8 text-lg"></i>稼働履歴・検索</button>
    <button onclick="switchView('dashboard')" class="menu-item"><i class="fa-solid fa-chart-line w-8 text-lg"></i>DASHBOARD</button>
    <button onclick="switchView('repairView')" class="menu-item"><i class="fa-solid fa-tools w-8 text-lg"></i>修理履歴</button>
    <button onclick="switchView('maintenanceMachineListView'); loadMachineList();" class="menu-item"><i class="fa-solid fa-toolbox w-8 text-lg"></i>メンテナンス記録</button>
    <button onclick="switchView('versionView')" class="menu-item"><i class="fa-solid fa-info-circle w-8 text-lg"></i>バージョン情報</button>
  </nav>
</div>

<div id="customModal">
  <div class="modal-content">
    <div class="modal-header bg-[#2d4031] p-4 text-white text-center">
      <h3 id="modalTitle" class="font-bold">CONFIRM</h3>
    </div>
    <div class="modal-body p-6 text-center font-bold" id="modalMessage">メッセージ</div>
    <div class="modal-footer p-4 bg-gray-50 flex gap-2">
      <button class="flex-1 p-2 bg-gray-200 rounded-lg" onclick="closeModal()">戻る</button>
      <button id="modalOkBtn" class="flex-1 p-2 bg-[#6b8f71] text-white rounded-lg">実行する</button>
    </div>
  </div>
</div>

<div id="mainContainer">
  <header id="pageHeader" class="flex flex-col items-center justify-center py-8 relative">
    <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl text-[#6b8f71] p-2"><i class="fa-solid fa-bars"></i></button>
    <i class="fa-solid fa-tractor text-6xl text-[#6b8f71]"></i>
    <h1 class="text-xl font-bold text-[#6b8f71]">和農日向 Tractor log</h1>
  </header>

  <div id="inputView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">
    <div class="card"><label class="block text-xs font-bold text-gray-400 mb-1">機械を選択</label><select id="machineSelect" class="w-full p-3 rounded-lg" onchange="autoFillHour()"></select></div>
    <div class="card"><label class="block text-xs font-bold text-gray-400 mb-1">作業日</label><input type="date" id="workDate" class="w-full p-3 rounded-lg" /></div>
    <div class="card"><label class="block text-xs font-bold text-gray-400 mb-1">オペレーター</label>
      <select id="operatorSelect" class="w-full p-3 rounded-lg">
        <option value="">選択</option><option>阿曽 千一</option><option>阿曽 右貢</option><option>菅原 亜美</option><option>土井 達也</option><option>阿曽 文平</option><option>田中 武志</option><option>赤塚 かおり</option><option>土門 元義</option>
      </select>
    </div>
    <div class="card"><label class="block text-xs font-bold text-gray-400 mb-1">種別</label><select id="categorySelect" class="w-full p-3 rounded-lg"><option value="">選択</option><option value="水稲">水稲</option><option value="そば">そば</option><option value="保全会">保全会</option><option value="小規模工事">小規模工事</option></select></div>
    <div class="card"><label class="block text-xs font-bold text-gray-400 mb-1">作業内容</label><select id="taskSelect" class="w-full p-3 rounded-lg"></select></div>
    <div class="card"><div class="flex space-x-4"><div class="flex-1"><label class="block text-xs font-bold text-gray-400 mb-1">稼働前</label><input type="number" id="hourBefore" class="w-full p-3 rounded-lg font-bold" step="0.1" oninput="calcDiff()" /></div><div class="flex-1"><label class="block text-xs font-bold text-gray-400 mb-1">稼働後</label><input type="number" id="hourAfter" class="w-full p-3 rounded-lg font-bold" step="0.1" oninput="calcDiff()" /></div></div></div>
    <div id="hourDiffDisplay" class="text-right font-black text-[#6b8f71] mb-6 text-xl">稼働時間: 0.0 h</div>
    <div class="card"><label class="block text-xs font-bold text-gray-400 mb-1">給油量 (L)</label><input type="number" id="fuelAmount" class="w-full p-3 rounded-lg" /></div>
    <div class="card"><label class="block text-xs font-bold text-gray-400 mb-1">メモ</label><textarea id="memoInput" class="w-full p-3 rounded-lg" rows="2"></textarea></div>
    <button id="saveBtn" class="btn-main">ログを保存する</button>
  </div>

  <div id="dashboard" class="view">
    <div class="bi-header">
      <button onclick="openMenu()" class="text-2xl mr-6 hover:opacity-70 transition-opacity"><i class="fa-solid fa-bars"></i></button>
      <h1 class="text-sm md:text-lg font-black tracking-widest flex items-center">
        <i class="fa-solid fa-chart-column mr-3"></i> OPERATION DASHBOARD
      </h1>
    </div>
    
    <div class="dashboard-top-bar">
      <div class="main-top-row">
        <div class="kpi-section">
          <div id="machineTabs" class="flex gap-2 overflow-x-auto pb-1"></div>
          <div class="kpi-grid">
            <div class="kpi-card"><span class="kpi-label">総稼働</span><div class="kpi-value-container"><span class="kpi-value" id="kpi-hours">0.0</span><span class="kpi-unit">h</span></div></div>
            <div class="kpi-card"><span class="kpi-label">給油</span><div class="kpi-value-container"><span class="kpi-value" id="kpi-fuel">0.0</span><span class="kpi-unit">L</span></div></div>
            <div class="kpi-card"><span class="kpi-label">燃費</span><div class="kpi-value-container"><span class="kpi-value" id="kpi-avg">0.0</span><span class="kpi-unit">L/h</span></div></div>
            <div class="kpi-card"><span class="kpi-label">日数</span><div class="kpi-value-container"><span class="kpi-value" id="kpi-days">0</span><span class="kpi-unit">日</span></div></div>
            <div class="kpi-card bg-[#4a6b50]"><span class="kpi-label">状態</span><span class="kpi-value text-[10px]">良好</span></div>
          </div>
        </div>
        <div class="ranking-section">
          <p class="text-[11px] font-bold text-[#6b8f71] mb-2 text-center"><i class="fa-solid fa-trophy mr-1"></i>稼働ランキング</p>
          <div id="rankList" class="flex justify-around items-center"></div>
        </div>
      </div>
    </div>

    <div class="bi-container">
      <div class="bi-left-col">
        <div class="card"><p class="chart-title">作物別比率</p><div class="chart-wrapper"><i class="fa-solid fa-seedling donut-icon"></i><canvas id="categoryShareChart"></canvas></div></div>
        <div class="card"><p class="chart-title">作業内容分析</p><div class="chart-wrapper"><i class="fa-solid fa-gears donut-icon"></i><canvas id="taskShareChart"></canvas></div></div>
        <div class="card"><p class="chart-title">担当者別比率</p><div class="chart-wrapper"><i class="fa-solid fa-user-check donut-icon"></i><canvas id="operatorShareChart"></canvas></div></div>
      </div>
      <div class="bi-main-col">
        <div class="card"><p class="chart-title">月別稼働推移</p><div class="chart-wrapper"><canvas id="detailChart"></canvas></div></div>
        <div class="card"><p class="chart-title">工程分布分析</p><div class="chart-wrapper"><canvas id="gradientBarChart"></canvas></div></div>
      </div>
      <div class="bi-right-col">
        <div class="card yoy-card text-center relative">
          <p class="chart-title">前年実績比 (YoY)</p>
          <div class="chart-wrapper relative">
            <canvas id="yearComparisonGauge"></canvas>
            <div class="absolute inset-0 flex items-center justify-center pt-14">
              <p id="detailCompareValue" class="text-2xl font-black text-[#6b8f71]">--%</p>
            </div>
          </div>
        </div>
        <div class="card maint-card overflow-hidden">
          <p class="chart-title border-b pb-1">メンテナンス情報</p>
          <div id="maintenanceLog" class="text-[10px] space-y-2 opacity-80 pt-2 flex-1 overflow-y-auto">
            <p class="italic text-gray-400 text-center py-4">履歴はありません</p>
          </div>
        </div>
        <button onclick="switchView('inputView')" class="btn-sub py-3 mt-0 w-full"><i class="fa-solid fa-house mr-2"></i>TOPに戻る</button>
      </div>
    </div>
  </div>

  <div id="todayView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">
    <div class="flex items-center gap-2 mb-4 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-2 text-lg"><i class="fa-solid fa-calendar-day"></i> 本日の稼働状況</div>
    <div id="todayLogList" class="space-y-4"></div>
    <button onclick="switchView('inputView')" class="btn-sub">TOPに戻る</button>
  </div>

  <div id="historyView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">
    <div class="flex justify-between items-center mb-4"><div class="font-bold text-[#6b8f71] text-lg"><i class="fa-solid fa-magnifying-glass"></i> 稼働履歴</div><div id="historyTotalHours" class="text-sm font-black opacity-60">合計: 0.0 h</div></div>
    <div class="card space-y-2 text-sm">
      <div class="grid grid-cols-2 gap-2"><input type="month" id="filterMonth" class="p-2 rounded-lg w-full"><select id="filterMachine" class="p-2 rounded-lg w-full"><option value="">すべての機械</option></select></div>
      <div class="grid grid-cols-2 gap-2"><select id="filterOperator" class="p-2 rounded-lg w-full"><option value="">オペレーター</option><option>阿曽 千一</option><option>阿曽 右貢</option><option>菅原 亜美</option><option>土井 達也</option><option>阿曽 文平</option><option>田中 武志</option><option>赤塚 かおり</option><option>土門 元義</option></select><select id="filterCategory" class="p-2 rounded-lg w-full"><option value="">種別</option><option>水稲</option><option>そば</option><option>保全会</option><option>小規模工事</option></select></div>
      <button onclick="loadLogs('historyLogList', false)" class="btn-main py-2">検索を実行</button>
    </div>
    <div id="historyLogList" class="space-y-4"></div>
    <button onclick="switchView('inputView')" class="btn-sub">TOPに戻る</button>
  </div>
</div>

<div id="maintenanceMachineListView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">

  <div class="flex items-center gap-2 mb-4 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-2 text-lg">
    <i class="fa-solid fa-wrench"></i> メンテナンス記録
  </div>

  <div id="machineListContainer" class="grid grid-cols-1 gap-4">
    <!-- ここに機械カードが JS で追加される -->
  </div>

  <button onclick="switchView('inputView')" class="btn-sub mt-6">TOPに戻る</button>
</div>

<div id="repairView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">
  <div class="flex items-center gap-2 mb-4 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-2 text-lg">
    <i class="fa-solid fa-screwdriver-wrench"></i> 修理履歴の登録
  </div>

  <!-- 請求書の読み取り -->
  <div class="card">
    <label class="block text-xs font-bold text-gray-400 mb-1">請求書の読み取り</label>
    <input type="file" id="invoiceImage" accept="image/*" capture="camera" class="w-full p-2 rounded-lg">
    <button onclick="runInvoiceOCR()" class="btn-sub mt-2"><i class="fa-solid fa-camera mr-2"></i>スマホカメラで読み取る</button>
  </div>

  <!-- 自動入力される項目 -->
  <div class="card">
    <label class="block text-xs font-bold text-gray-400 mb-1">修理日</label>
    <input type="date" id="repairDate" class="w-full p-3 rounded-lg">
  </div>

  <div class="card">
    <label class="block text-xs font-bold text-gray-400 mb-1">店舗名</label>
    <input type="text" id="repairShop" class="w-full p-3 rounded-lg">
  </div>

  <div class="card">
    <label class="block text-xs font-bold text-gray-400 mb-1">金額</label>
    <input type="number" id="repairCost" class="w-full p-3 rounded-lg">
  </div>

  <div class="card">
    <label class="block text-xs font-bold text-gray-400 mb-1">メモ（OCR全文）</label>
    <textarea id="repairMemo" class="w-full p-3 rounded-lg" rows="3"></textarea>
  </div>

  <button id="saveRepairBtn" class="btn-main">修理履歴を保存</button>
  <button onclick="switchView('inputView')" class="btn-sub mt-4">TOPに戻る</button>
</div>

<div id="maintenanceDetailView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">

  <!-- タイトル（機械名は JS で差し替える） -->
  <div class="flex items-center gap-2 mb-4 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-2 text-lg">
    <i class="fa-solid fa-tractor"></i>
    <span id="maintenanceMachineName">機械名</span>
  </div>

  <!-- メンテナンス進捗（チェックリスト） -->
  <div class="card mb-4">
    <p class="font-bold text-sm text-gray-500 mb-2">メンテナンス項目</p>
    <div id="maintenanceChecklist" class="space-y-2">
      <!-- JSで項目を追加 -->
    </div>
    <p id="maintenanceSummary" class="text-xs text-gray-400 mt-3">未完了: -- / --</p>
  </div>

  <!-- 作業履歴タイムライン -->
  <div class="card mb-4">
    <p class="font-bold text-sm text-gray-500 mb-2">作業履歴</p>
    <div id="maintenanceTimeline" class="space-y-3 text-sm">
      <p class="italic text-gray-400 text-center py-4">履歴はありません</p>
    </div>
  </div>

  <!-- 新規メンテナンス追加フォーム -->
  <div class="card mb-4">
    <p class="font-bold text-sm text-gray-500 mb-2">メンテナンスを追加</p>

    <label class="block text-xs font-bold text-gray-400 mb-1">項目名</label>
    <input id="newMaintenanceItem" type="text" class="w-full p-2 rounded-lg mb-3">

    <label class="block text-xs font-bold text-gray-400 mb-1">担当者</label>
    <input id="newMaintenanceOperator" type="text" class="w-full p-2 rounded-lg mb-3">

    <label class="block text-xs font-bold text-gray-400 mb-1">状態</label>
    <select id="newMaintenanceStatus" class="w-full p-2 rounded-lg mb-3">
      <option value="done">完了</option>
      <option value="progress">途中</option>
    </select>

    <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
    <textarea id="newMaintenanceMemo" class="w-full p-2 rounded-lg mb-3" rows="2"></textarea>

    <button onclick="saveMaintenanceRecord()" class="btn-main w-full">追加する</button>
  </div>

  <button onclick="switchView('maintenanceMachineListView')" class="btn-sub w-full">
    <i class="fa-solid fa-arrow-left mr-2"></i>機械一覧に戻る
  </button>

</div>

<div id="versionView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">
  <div class="flex items-center gap-2 mb-4 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-2 text-lg">
    <i class="fa-solid fa-code-branch"></i> バージョン情報
  </div>

  <div class="card text-sm leading-relaxed space-y-3">
    <p><span class="font-bold">バージョン:</span> 1.0.0</p>
    <p><span class="font-bold">最終更新日:</span> 2026-01-19</p>

    <div>
      <p class="font-bold text-[#6b8f71] mb-1">更新内容</p>
      <ul class="list-disc pl-5 space-y-1">
        <li>初期リリース</li>
      </ul>
    </div>

    <div>
      <p class="font-bold text-[#6b8f71] mb-1">使用技術</p>
      <ul class="list-disc pl-5 space-y-1">
        <li>HTML / CSS / JavaScript</li>
        <li>Tailwind CSS</li>
        <li>Supabase</li>
        <li>Chart.js</li>
        <li>GitHub Pages</li>
      </ul>
    </div>

  <button onclick="switchView('inputView')" class="btn-sub mt-6">TOPに戻る</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const SUPABASE_URL = "https://txsqxnwgolybcdclazdx.supabase.co";
  const SUPABASE_KEY = "sb_publishable_8JEM6Yyg5_oQpF-grdaxIw_rrxZBQYj";
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  let allMachines = []; let currentMachineId = 'all'; window.charts = {};

  function openMenu() { document.getElementById("sideMenu").style.left = "0px"; document.getElementById("overlay").style.display = "block"; }
  function closeMenu() { document.getElementById("sideMenu").style.left = "-280px"; document.getElementById("overlay").style.display = "none"; }

  function showModal(title, message, onOk) {
    const modal = document.getElementById("customModal");
    document.getElementById("modalTitle").innerText = title;
    document.getElementById("modalMessage").innerText = message;
    const okBtn = document.getElementById("modalOkBtn");
    okBtn.onclick = () => { closeModal(); if(onOk) onOk(); };
    modal.classList.add("active");
  }
  function closeModal() { document.getElementById("customModal").classList.remove("active"); }

  function switchView(id) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.getElementById("pageHeader").style.display = (id === 'dashboard') ? 'none' : 'flex';
    closeMenu();
    if (id === 'dashboard') { setTimeout(() => renderDashboard('all'), 100); }
    if (id === 'todayView') loadLogs("todayLogList", true);
    if (id === 'historyView') loadLogs("historyLogList", false);
  }

  document.addEventListener("DOMContentLoaded", async () => {
    const { data: machines } = await client.from("machines").select("*").order("name");
    allMachines = machines || [];
    document.getElementById("machineSelect").innerHTML = '<option value="">選択</option>' + allMachines.map(m => `<option value="${m.id}">${m.name}</option>`).join("");
    document.getElementById("filterMachine").innerHTML = '<option value="">すべての機械</option>' + allMachines.map(m => `<option value="${m.id}">${m.name}</option>`).join("");
    document.getElementById("machineTabs").innerHTML = `<button onclick="renderDashboard('all')" id="tab-all" class="tab-btn active">全体</button>` +  allMachines.map(m => `<button onclick="renderDashboard(${m.id})" id="tab-${m.id}" class="tab-btn inactive">${m.name}</button>`).join("");
    document.getElementById("workDate").value = new Date().toISOString().split('T')[0];
    document.getElementById("filterMonth").value = document.getElementById("workDate").value.substring(0, 7);
  });

  const tasksMap = { "水稲": ["あぜ塗り", "起耕", "粗代", "本代", "代かき", "田植え", "溝切り", "草刈り", "防除", "追肥", "稲刈り", "秋耕"], "そば": ["起耕", "播種", "防除", "刈取り"], "保全会": ["ハンマーモア", "草刈り"], "小規模工事": ["整地", "掘削", "運搬"] };
  document.getElementById("categorySelect").onchange = function() { document.getElementById("taskSelect").innerHTML = (tasksMap[this.value] || ["その他"]).map(t => `<option value="${t}">${t}</option>`).join(""); };

  async function autoFillHour() {
    const mId = document.getElementById("machineSelect").value;
    if(!mId) return;
    const { data } = await client.from("hour_logs").select("end_hour").eq("machine_id", mId).order("date", {ascending: false}).order("created_at", {ascending: false}).limit(1);
    if(data && data.length > 0) { document.getElementById("hourBefore").value = data[0].end_hour; calcDiff(); }
  }

  function calcDiff() {
    const b = parseFloat(document.getElementById("hourBefore").value) || 0;
    const a = parseFloat(document.getElementById("hourAfter").value) || 0;
    const d = a - b; 
    const disp = document.getElementById("hourDiffDisplay");
    
    // ① 稼働後のほうが小さい場合に文字を赤くするロジック
    if (a > 0 && a < b) {
      disp.classList.remove("text-[#6b8f71]");
      disp.classList.add("text-red-500");
      disp.textContent = `稼働時間: 0.0 h (入力エラー)`;
    } else {
      disp.classList.remove("text-red-500");
      disp.classList.add("text-[#6b8f71]");
      disp.textContent = `稼働時間: ${d > 0 ? d.toFixed(1) : "0.0"} h`;
    }
  }

  document.getElementById("saveBtn").onclick = async () => {
    const mId = document.getElementById("machineSelect").value;
    const hBefore = parseFloat(document.getElementById("hourBefore").value) || 0;
    const hAfter = parseFloat(document.getElementById("hourAfter").value) || 0;

    if(!mId) return alert("機械を選択してください");
    if (hAfter < hBefore) return alert("エラー：稼働後の数値が稼働前より小さくなっています。");

    showModal("登録確認", "ログを登録しますか？", async () => {
      const logData = { 
        machine_id: mId, date: document.getElementById("workDate").value, 
        operator: document.getElementById("operatorSelect").value, 
        category: document.getElementById("categorySelect").value, 
        task: document.getElementById("taskSelect").value, 
        start_hour: hBefore, end_hour: hAfter, 
        fuel_amount: parseFloat(document.getElementById("fuelAmount").value)||0, 
        memo: document.getElementById("memoInput").value 
      };
      const { error } = await client.from("hour_logs").insert([logData]);
      if (!error) location.reload();
    });
  };

  async function loadLogs(elId, todayOnly) {
    const list = document.getElementById(elId);
    list.innerHTML = "<p class='text-center py-10 opacity-50 text-xs'>読込中...</p>";
    let query = client.from("hour_logs").select("*, machines(name)").order("date", { ascending: false });
    if (todayOnly) query = query.eq("date", new Date().toISOString().split('T')[0]);
    const { data } = await query;
    let total = 0;
    list.innerHTML = (data || []).map(l => {
      const diff = (l.end_hour - l.start_hour);
      total += diff;
      return `<div class="card border-l-4 border-[#6b8f71] !mb-3 !py-3 flex justify-between items-center"><div><b class="text-sm">${l.date} - ${l.machines?.name}</b><p class="text-xs opacity-70 mt-1">${l.operator} | ${l.task}</p><div class="flex gap-4 mt-2"><span class="text-[11px] font-bold log-badge px-2 py-1 rounded"><i class="fa-solid fa-clock mr-1 text-[#6b8f71]"></i>${diff.toFixed(1)} h</span><span class="text-[11px] font-bold log-badge px-2 py-1 rounded"><i class="fa-solid fa-gas-pump mr-1 text-orange-500"></i>${l.fuel_amount || 0} L</span></div></div><button onclick="deleteLog(${l.id})" class="text-red-400 p-2"><i class="fa-solid fa-trash-can text-lg"></i></button></div>`;
    }).join("");
    if (!todayOnly) document.getElementById("historyTotalHours").innerText = `合計: ${total.toFixed(1)} h`;
  }

  async function deleteLog(id) {
    showModal("削除確認", "このログを削除しますか？", async () => {
      const { error } = await client.from("hour_logs").delete().eq("id", id);
      if (!error) {
        if (document.getElementById("todayView").classList.contains("active")) loadLogs("todayLogList", true);
        else loadLogs("historyLogList", false);
      }
    });
  }

  async function loadMachineList() {
    const { data: machines } = await client
      .from("machines")
      .select("*")
      .order("id");

    const container = document.getElementById("machineListContainer");
    container.innerHTML = "";

    // ① メーカーごとにグループ化
    const grouped = {};
    machines.forEach(m => {
      if (!grouped[m.manufacturer]) grouped[m.manufacturer] = [];
      grouped[m.manufacturer].push(m);
    });

    // ② メーカーごとに HTML を生成
    Object.keys(grouped).forEach(brand => {
      // メーカー名の見出し
      const title = document.createElement("h2");
      title.className = "font-bold text-[#6b8f71] mt-4 mb-2";
      title.textContent = brand;
      container.appendChild(title);

      // カードを並べるグリッド
      const grid = document.createElement("div");
      grid.className = "grid grid-cols-2 gap-4";

      grouped[brand].forEach(m => {
        const card = document.createElement("div");
        card.className = "card cursor-pointer hover:bg-gray-50 transition";
        card.onclick = () => openMaintenanceDetail(m.id);

        card.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="text-3xl text-[#6b8f71]">
              <i class="fa-solid fa-tractor"></i>
            </div>
            <div>
              <div class="font-bold text-lg">${m.name}</div>

              <!-- メンテナンス状況（仮） -->
              <div class="text-xs mt-1">
                <span class="font-bold text-[#6b8f71]">${m.status || "メンテナンス中"}</span>
              </div>
            </div>
          </div>
        `;


        grid.appendChild(card);
      });

      container.appendChild(grid);
    });
  }

  async function renderDashboard(mId) {
    currentMachineId = mId;
    document.querySelectorAll('.tab-btn').forEach(btn => { btn.classList.replace('active', 'inactive'); if (btn.id === `tab-${mId}`) btn.classList.replace('inactive', 'active'); });
    let { data: logs } = await client.from("hour_logs").select("*, machines(name)");
    if (mId !== 'all') logs = logs.filter(l => l.machine_id == mId);
    if(!logs) return;

    const l26 = logs.filter(l => l.date.startsWith("2026"));
    const l25 = logs.filter(l => l.date.startsWith("2025"));
    const totalH = l26.reduce((s,l) => s + (l.end_hour - l.start_hour), 0);
    const totalF = l26.reduce((s,l) => s + (l.fuel_amount || 0), 0);
    document.getElementById("kpi-hours").innerText = totalH.toFixed(1);
    document.getElementById("kpi-fuel").innerText = totalF.toFixed(1);
    document.getElementById("kpi-avg").innerText = totalH > 0 ? (totalF/totalH).toFixed(1) : "0.0";
    document.getElementById("kpi-days").innerText = new Set(l26.map(l => l.date)).size;
    
    const mRank = {}; l26.forEach(l => { const n = l.machines?.name || "他"; mRank[n] = (mRank[n]||0)+(l.end_hour-l.start_hour); });
    const sorted = Object.entries(mRank).sort((a,b)=>b[1]-a[1]);
    document.getElementById("rankList").innerHTML = [0,1,2].map(i => sorted[i] ? `<div class="text-center"><i class="fa-solid fa-crown ${['text-yellow-500', 'text-gray-400', 'text-amber-600'][i]} text-xl"></i><p class="text-[10px] font-bold mt-1">${sorted[i][0]}</p></div>` : '').join("");

    const cat={}, tsk={}, opr={}, mon=Array(12).fill(0);
    l26.forEach(l => { 
      const h=l.end_hour-l.start_hour; 
      cat[l.category||"他"]=(cat[l.category||"他"]||0)+h; 
      tsk[l.task||"他"]=(tsk[l.task||"他"]||0)+h; 
      opr[l.operator||"他"]=(opr[l.operator||"他"]||0)+h; 
      if(l.date.split("-")[1]) mon[parseInt(l.date.split("-")[1])-1]+=h; 
    });
    drawCharts(cat, tsk, opr, mon, totalH, l25);
  }

  function drawCharts(cat, task, op, monthly, totalH, l25) {
    Object.values(window.charts).forEach(c => c && c.destroy());
    const txt = '#3a3a3a';
    const colorSet = ['#1b4332', '#2d6a4f', '#40916c', '#52b788', '#74c69d'];

    const donut = (id, data) => new Chart(document.getElementById(id), { 
      type: 'doughnut', 
      data: { labels: Object.keys(data), datasets: [{ data: Object.values(data), backgroundColor: colorSet, borderWidth: 0 }] }, 
      options: { 
        cutout: '75%', maintainAspectRatio: false, 
        plugins: { legend: { display: true, position: 'right', labels: { boxWidth: 12, padding: 15, font: { size: 11, weight: 'bold' }, color: txt } } } 
      } 
    });
    
    window.charts.c1 = donut('categoryShareChart', cat);
    window.charts.c2 = donut('taskShareChart', task);
    window.charts.c3 = donut('operatorShareChart', op);
    
    window.charts.line = new Chart(document.getElementById('detailChart'), { 
      type: 'line', 
      data: { labels: ['1','2','3','4','5','6','7','8','9','10','11','12'], datasets: [{ data: monthly, borderColor: '#6b8f71', backgroundColor: 'rgba(107,143,113,0.1)', fill: true, tension: 0.4 }] }, 
      options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: txt, font: {size: 9} } }, y: { ticks: { color: txt, font: {size: 9} } } } } 
    });
    
    const barCtx = document.getElementById('gradientBarChart').getContext('2d');
    const tLabels = Object.keys(task);
    const tData = Object.values(task);
    window.charts.bar = new Chart(barCtx, { 
      type: 'bar', 
      data: { labels: tLabels, datasets: [{ data: tData, backgroundColor: tData.map((_, i) => `rgba(45, 64, 49, ${Math.max(0.2, 1-(i/tLabels.length))})`), borderRadius: 4 }] }, 
      options: { indexAxis: 'y', maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: txt, font: {size: 9} } }, y: { ticks: { color: txt, font: {size: 9} } } } } 
    });
    
    const lastH = l25.reduce((s, l) => s + (l.end_hour - l.start_hour), 0) || 1; 
    const ratio = Math.min(100, (totalH / lastH) * 100);
    window.charts.gauge = new Chart(document.getElementById('yearComparisonGauge'), { 
      type: 'doughnut', 
      data: { datasets: [{ data: [ratio, 100 - ratio], backgroundColor: ['#6b8f71', '#eee'], borderWidth: 0 }] }, 
      options: { rotation: -90, circumference: 180, cutout: '75%', maintainAspectRatio: false, plugins: { legend: { display: false } } } 
    });
    document.getElementById("detailCompareValue").innerText = ratio.toFixed(1) + "%";
  }
</script>
</body>
</html>