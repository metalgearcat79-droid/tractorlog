<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex">
  <link rel="manifest" href="/tractorlog/manifest.json">
  <title>å’Œè¾²æ—¥å‘ Tractor Log</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* --- åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« --- */
    body {
      background-color: #e2e8e3;
      color: #3a3a3a;
      font-family: "Hiragino Sans", "Noto Sans JP", sans-serif;
      margin: 0;
    }

    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    #sideMenu {
      position: fixed;
      top: 0;
      left: -280px;
      width: 280px;
      height: 100%;
      background: white;
      z-index: 9999;
      transition: left 0.3s ease;
      padding: 20px;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
    }

    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: 9998;
      display: none;
    }

    .menu-item {
      width: 100%;
      text-align: left;
      padding: 0.8rem;
      border-radius: 0.5rem;
      font-weight: bold;
      color: #6b8f71;
      display: flex;
      align-items: center;
      font-size: 0.9rem;
    }

    select,
    input,
    textarea {
      color: #3a3a3a !important;
      background-color: #ffffff !important;
      border: 1px solid #ddd;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }

    .btn-main {
      background-color: #6b8f71;
      color: white;
      padding: 14px;
      border-radius: 12px;
      text-align: center;
      font-weight: bold;
      width: 100%;
      display: block;
    }

    .btn-sub {
      background-color: #6b8f71;
      color: white;
      padding: 12px;
      border-radius: 10px;
      text-align: center;
      font-weight: bold;
      width: 160px;
      max-width: 40%;
      margin: 20px auto 0;
      display: block;
      border: none;
      cursor: pointer;
    }

    .log-badge {
      background-color: #f3f4f6;
      color: #374151;
    }

    #dashboard.active {
      display: flex !important;
      flex-direction: column;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .bi-header {
      height: 65px;
      display: flex;
      align-items: center;
      background: #2d4031;
      color: white;
      flex-shrink: 0;
      width: 100%;
      padding: 0 20px;
    }

    .dashboard-top-bar {
      flex-shrink: 0;
      padding: 10px 15px;
    }

    .main-top-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: stretch;
    }

    .kpi-section {
      flex: 1;
      min-width: 320px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .ranking-section {
      flex: 0.4;
      min-width: 250px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 12px;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
    }

    .kpi-card {
      background: #6b8f71;
      color: white;
      padding: 8px 2px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .kpi-label {
      font-size: 9px;
      font-weight: bold;
      opacity: 0.9;
    }

    .kpi-value-container {
      display: flex;
      align-items: baseline;
      gap: 1px;
    }

    .kpi-value {
      font-size: 14px;
      font-weight: 900;
    }

    .kpi-unit {
      font-size: 8px;
      opacity: 0.8;
      font-weight: bold;
    }

    .bi-container {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      padding: 12px;
      gap: 12px;
      align-items: stretch;
    }

    .bi-left-col {
      flex: 1.1;
      min-width: 280px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .bi-main-col {
      flex: 1.8;
      min-width: 320px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* å³ã‚«ãƒ©ãƒ è‡ªä½“ã®å®šç¾© */
    .bi-right-col {
      flex: 0.8;
      min-width: 280px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-self: stretch;
      /* ã“ã‚Œã§è¦ªã®é«˜ã•ä¸€æ¯ã«ä¼¸ã³ã¾ã™ */
    }

    /* YoYã‚«ãƒ¼ãƒ‰ (å…¨ä½“ã®1/4ã®é«˜ã•) */
    .bi-right-col>.yoy-card {
      flex: 1;
      display: flex;
      flex-direction: column;
      margin-bottom: 0 !important;
    }

    /* ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚«ãƒ¼ãƒ‰ (å…¨ä½“ã®3/4ã®é«˜ã•) */
    .bi-right-col>.maint-card {
      flex: 3;
      display: flex;
      flex-direction: column;
      margin-bottom: 0 !important;
      overflow: hidden;
      /* ã¯ã¿å‡ºã—é˜²æ­¢ */
    }

    /* ãƒ­ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ */
    #maintenanceLog {
      flex: 1;
      overflow-y: auto;
    }

    @media (max-width: 1024px) {
      .bi-right-col {
        width: 100%;
        flex: 1;
      }
    }

    .bi-container>div>.card {
      margin-bottom: 0 !important;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .chart-title {
      font-size: 12px;
      font-weight: bold;
      color: #6b8f71;
      margin-bottom: 8px;
    }

    .chart-wrapper {
      flex: 1;
      position: relative;
      width: 100%;
      min-height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .donut-icon {
      position: absolute;
      font-size: 24px;
      color: #6b8f71;
      opacity: 0.3;
      pointer-events: none;
    }

    #customModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
      padding: 20px;
    }

    #customModal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      width: 100%;
      max-width: 320px;
      border-radius: 20px;
      overflow: hidden;
    }

    .tab-btn {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: bold;
      cursor: pointer;
      white-space: nowrap;
      border: none;
    }

    .tab-btn.active {
      background: #2d4031;
      color: white;
    }

    .tab-btn.inactive {
      background: rgba(255, 255, 255, 0.5);
      color: #6b8f71;
    }

    .dashboard-sidebar {
      width: 200px;
      min-width: 200px;
      background: #2d4031;
      color: white;
      height: 100vh;
      position: sticky;
      top: 0;
      display: flex;
      flex-direction: column;
      padding: 20px 0;
    }

    .nav-item {
      width: 100%;
      padding: 15px 20px;
      text-align: left;
      color: rgba(255, 255, 255, 0.7);
      font-size: 13px;
      border: none;
      background: none;
      cursor: pointer;
      transition: 0.3s;
    }

    .nav-item i {
      margin-right: 10px;
    }

    .nav-item.active {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border-left: 4px solid #6b8f71;
    }

    .dashboard-main-content {
      overflow-y: auto;
      height: 100vh;
    }
  </style>
</head>

<body>

  <div id="overlay" onclick="closeMenu()"></div>
  <div id="sideMenu">
    <div class="flex justify-between items-center mb-6">
      <h2 class="font-bold text-lg text-[#6b8f71]">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
      <button onclick="closeMenu()" class="text-2xl text-gray-400">&times;</button>
    </div>
    <nav class="space-y-1">
      <button onclick="switchView('inputView')" class="menu-item"><i
          class="fa-solid fa-pen-to-square w-8 text-lg"></i>ãƒ­ã‚°å…¥åŠ›</button>
      <button onclick="switchView('todayView')" class="menu-item"><i
          class="fa-solid fa-calendar-day w-8 text-lg"></i>æœ¬æ—¥ã®ç¨¼åƒçŠ¶æ³</button>
      <button onclick="switchView('historyView')" class="menu-item"><i
          class="fa-solid fa-magnifying-glass w-8 text-lg"></i>ç¨¼åƒå±¥æ­´ãƒ»æ¤œç´¢</button>
      <button onclick="switchView('dashboard')" class="menu-item"><i
          class="fa-solid fa-chart-line w-8 text-lg"></i>DASHBOARD</button>
      <button onclick="switchView('repairView')" class="menu-item"><i
          class="fa-solid fa-tools w-8 text-lg"></i>ä¿®ç†å±¥æ­´</button>
      <button onclick="switchView('maintenanceMachineListView'); loadMachineList();" class="menu-item"><i
          class="fa-solid fa-toolbox w-8 text-lg"></i>ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹è¨˜éŒ²</button>
      <button onclick="switchView('versionView')" class="menu-item"><i
          class="fa-solid fa-info-circle w-8 text-lg"></i>ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±</button>
    </nav>
  </div>

  <div id="customModal">
    <div class="modal-content">
      <div class="modal-header bg-[#2d4031] p-4 text-white text-center">
        <h3 id="modalTitle" class="font-bold">CONFIRM</h3>
      </div>
      <div class="modal-body p-6 text-center font-bold" id="modalMessage">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
      <div class="modal-footer p-4 bg-gray-50 flex gap-2">
        <button class="flex-1 p-2 bg-gray-200 rounded-lg" onclick="closeModal()">æˆ»ã‚‹</button>
        <button id="modalOkBtn" class="flex-1 p-2 bg-[#6b8f71] text-white rounded-lg">å®Ÿè¡Œã™ã‚‹</button>
      </div>
    </div>
  </div>

  <div id="mainContainer">
    <header id="pageHeader" class="flex flex-col items-center justify-center py-8 relative">
      <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl text-[#6b8f71] p-2"><i
          class="fa-solid fa-bars"></i></button>
      <i class="fa-solid fa-tractor text-5xl text-[#6b8f71]"></i>
      <h1 class="text-xl font-bold text-[#6b8f71]">å’Œè¾²æ—¥å‘ Tractor log</h1>
    </header>

    <div id="inputView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">
      <div class="flex items-center gap-2 mb-1 mt-4">
        <i class="fa-solid fa-pen-to-square text-[#6b8f71] text-lg"></i>
        <span class="text-lg font-bold text-[#6b8f71]">ãƒ­ã‚°å…¥åŠ›</span>
      </div>
      <div class="border-t-2 border-[#6b8f71] mb-6 opacity-50"></div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">æ©Ÿæ¢°ã‚’é¸æŠ</label>
        <select id="machineSelect" class="w-full p-3 rounded-lg" onchange="autoFillHour()"></select>
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">ä½œæ¥­æ—¥</label>
        <input type="date" id="workDate" class="w-full p-3 rounded-lg" />
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼</label>
        <select id="operator" class="w-full p-3 rounded-lg">
          <option value="">èª­è¾¼ä¸­...</option>
        </select>
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">ç¨®åˆ¥</label>
        <select id="category" class="w-full p-3 rounded-lg">
          <option value="">èª­è¾¼ä¸­...</option>
        </select>
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">ä½œæ¥­å†…å®¹</label>
        <select id="work_name" class="w-full p-3 rounded-lg">
          <option value="">å…ˆã«ç¨®åˆ¥ã‚’é¸æŠ</option>
        </select>
      </div>

      <div class="card">
        <div class="flex space-x-4">
          <div class="flex-1">
            <label class="block text-xs font-bold text-gray-400 mb-1">ç¨¼åƒå‰</label>
            <input type="number" id="hourBefore" class="w-full p-3 rounded-lg font-bold" step="0.1"
              oninput="calcDiff()" />
          </div>
          <div class="flex-1">
            <label class="block text-xs font-bold text-gray-400 mb-1">ç¨¼åƒå¾Œ</label>
            <input type="number" id="hourAfter" class="w-full p-3 rounded-lg font-bold" step="0.1"
              oninput="calcDiff()" />
          </div>
        </div>
      </div>

      <div id="hourDiffDisplay" class="text-right font-black text-[#6b8f71] mb-6 text-xl">ç¨¼åƒæ™‚é–“: 0.0 h</div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">çµ¦æ²¹é‡ (L)</label>
        <input type="number" id="fuelAmount" class="w-full p-3 rounded-lg" />
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">ãƒ¡ãƒ¢</label>
        <textarea id="memoInput" class="w-full p-3 rounded-lg" rows="2"></textarea>
      </div>

      <button id="saveBtn" class="btn-main">ãƒ­ã‚°ã‚’ä¿å­˜ã™ã‚‹</button>
    </div>

    <div id="dashboard" class="view">
      <div class="bi-header">
        <button onclick="openMenu()" class="text-2xl mr-6 hover:opacity-70 transition-opacity"><i
            class="fa-solid fa-bars"></i></button>
        <h1 class="text-lg md:text-2xl font-black tracking-widest flex items-center">
          <i class="fa-solid fa-chart-column mr-3"></i> 2026 OPERATION DASHBOARD
        </h1>
      </div>

      <div class="dashboard-top-bar">
        <div class="main-top-row">
          <div class="kpi-section">
            <div id="machineTabs" class="flex gap-2 overflow-x-auto pb-1"></div>
            <div class="kpi-grid">
              <div class="kpi-card"><span class="kpi-label">ç·ç¨¼åƒ</span>
                <div class="kpi-value-container"><span class="kpi-value" id="kpi-hours">0.0</span><span
                    class="kpi-unit">h</span></div>
              </div>
              <div class="kpi-card"><span class="kpi-label">çµ¦æ²¹</span>
                <div class="kpi-value-container"><span class="kpi-value" id="kpi-fuel">0.0</span><span
                    class="kpi-unit">L</span></div>
              </div>
              <div class="kpi-card"><span class="kpi-label">ç‡ƒè²»</span>
                <div class="kpi-value-container"><span class="kpi-value" id="kpi-avg">0.0</span><span
                    class="kpi-unit">L/h</span></div>
              </div>
              <div class="kpi-card"><span class="kpi-label">æ—¥æ•°</span>
                <div class="kpi-value-container"><span class="kpi-value" id="kpi-days">0</span><span
                    class="kpi-unit">æ—¥</span></div>
              </div>
              <div class="kpi-card bg-[#4a6b50]"><span class="kpi-label">çŠ¶æ…‹</span><span
                  class="kpi-value text-[10px]">è‰¯å¥½</span></div>
            </div>
          </div>
          <div class="ranking-section">
            <p class="text-[11px] font-bold text-[#6b8f71] mb-2 text-center"><i
                class="fa-solid fa-trophy mr-1"></i>ç¨¼åƒãƒ©ãƒ³ã‚­ãƒ³ã‚°</p>
            <div id="rankList" class="flex justify-around items-center"></div>
          </div>
        </div>
      </div>

      <div class="bi-container">
        <div class="bi-left-col">
          <div class="card">
            <p class="chart-title">ä½œç‰©åˆ¥æ¯”ç‡</p>
            <div class="chart-wrapper relative">
              <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <i class="fa-solid fa-seedling text-2xl text-[#6b8f71] opacity-20"></i>
              </div>
              <canvas id="categoryShareChart"></canvas>
            </div>
          </div>

          <div class="card">
            <p class="chart-title">ä½œæ¥­å†…å®¹åˆ†æ</p>
            <div class="chart-wrapper relative">
              <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <i class="fa-solid fa-gears text-2xl text-[#6b8f71] opacity-20"></i>
              </div>
              <canvas id="taskShareChart"></canvas>
            </div>
          </div>

          <div class="card">
            <p class="chart-title">æ‹…å½“è€…åˆ¥æ¯”ç‡</p>
            <div class="chart-wrapper relative">
              <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <i class="fa-solid fa-user-check text-2xl text-[#6b8f71] opacity-20"></i>
              </div>
              <canvas id="operatorShareChart"></canvas>
            </div>
          </div>
        </div>
        <div class="bi-main-col">
          <div class="lg:col-span-2 space-y-4">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
              <h3 class="text-sm font-bold text-gray-700 mb-2">æœˆåˆ¥ç¨¼åƒæ¨ç§»</h3>
              <div class="relative h-40"> <canvas id="detailChart"></canvas>
              </div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
              <h3 class="text-sm font-bold text-gray-700 mb-2">ä½œæ¥­å†…å®¹åˆ†æ</h3>
              <div class="relative h-[480px]">
                <canvas id="gradientBarChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="bi-right-col">
          <div class="card yoy-card text-center relative">
            <p class="chart-title">å‰å¹´å®Ÿç¸¾æ¯” (YoY)</p>
            <div class="chart-wrapper relative">
              <canvas id="yearComparisonGauge"></canvas>
              <div class="absolute inset-0 flex items-center justify-center pt-14">
                <p id="detailCompareValue" class="text-2xl font-black text-[#6b8f71]">--%</p>
              </div>
            </div>
          </div>

          <div class="card maint-card overflow-hidden">
            <p class="chart-title border-b pb-1">ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æƒ…å ±</p>
            <div id="maintenanceLog" class="text-[10px] space-y-2 opacity-80 pt-2 flex-1 overflow-y-auto">
              <p class="italic text-gray-400 text-center py-4">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="todayView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">
      <div class="flex items-center gap-2 mb-4 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-2 text-lg"><i
          class="fa-solid fa-calendar-day"></i> æœ¬æ—¥ã®ç¨¼åƒçŠ¶æ³</div>
      <div id="todayLogList" class="space-y-4"></div>
      <button onclick="switchView('inputView')" class="btn-sub">TOPã«æˆ»ã‚‹</button>
    </div>

    <div id="historyView" class="view px-4 py-6 max-w-3xl mx-auto pb-10">

      <div
        class="flex items-center gap-2 mb-6 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-3 text-lg w-full">
        <i class="fa-solid fa-magnifying-glass"></i>
        <span>ç¨¼åƒå±¥æ­´æ¤œç´¢</span>
      </div>

      <div class="card space-y-3 text-sm mb-6">
        <div class="grid grid-cols-2 gap-3">
          <div class="flex flex-col gap-1">
            <label class="text-[10px] text-gray-400 font-bold ml-1">å¯¾è±¡æœˆ</label>
            <input type="month" id="filterMonth" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm">
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-[10px] text-gray-400 font-bold ml-1">æ©Ÿæ¢°</label>
            <select id="filterMachine" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm">
              <option value="">ã™ã¹ã¦ã®æ©Ÿæ¢°</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mt-1">
          <div class="flex flex-col gap-1">
            <label class="text-[10px] text-gray-400 font-bold ml-1">ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼</label>
            <select id="filterOperator"
              class="p-3 rounded-lg w-full border border-gray-100 shadow-sm text-sm text-gray-600">
              <option value="">å…¨ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼</option>
            </select>
          </div>

          <div class="flex flex-col gap-1">
            <label class="text-[10px] text-gray-400 font-bold ml-1">ä½œæ¥­å†…å®¹</label>
            <select id="filterCategory"
              class="p-3 rounded-lg w-full border border-gray-100 shadow-sm text-sm text-gray-600">
              <option value="">å…¨ä½œæ¥­å†…å®¹</option>
            </select>
          </div>
        </div>

        <button onclick="loadLogs('historyLogList', false)" class="btn-main mt-2 shadow-md">
          æ¤œç´¢ã‚’å®Ÿè¡Œ
        </button>
      </div>

      <div class="flex justify-end items-center mb-4 px-1">
        <div id="historyTotalHours"
          class="text-sm font-black text-[#6b8f71] opacity-80 bg-white px-4 py-2 rounded-full shadow-sm">
          åˆè¨ˆ: 0.0 h
        </div>
      </div>

      <div id="historyLogList" class="space-y-4"></div>

      <button onclick="switchView('inputView')" class="btn-sub mt-8">
        <i class="fa-solid fa-house mr-2"></i>TOPã«æˆ»ã‚‹
      </button>
    </div>

    <div id="maintenanceMachineListView" class="view px-4 max-w-3xl mx-auto pb-10">
      <div class="flex items-center gap-2 mb-4 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-2 text-lg">
        <i class="fa-solid fa-wrench"></i> ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹è¨˜éŒ²
      </div>

      <div id="maintenanceMachineGrid" class="space-y-6">
      </div>

      <button onclick="switchView('inputView')" class="btn-sub mt-10 w-full">
        <i class="fa-solid fa-house mr-2"></i>TOPã«æˆ»ã‚‹
      </button>
    </div>

    <div id="repairView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10 hidden">

      <button onclick="switchView('invoiceOCRView')" class="btn-main w-full mb-6">
        ä¿®ç†ã®ç™»éŒ²</button>

      <!-- ç´¯è¨ˆä¿®ç†è²» -->
      <div class="text-center my-6">
        <div class="text-sm text-gray-500">ç´¯è¨ˆä¿®ç†è²»</div>
        <div id="totalRepairCost" class="text-3xl font-bold text-[#6b8f71]">Â¥ 0</div>
      </div>

      <!-- å¹´ã”ã¨ã®ä¿®ç†è²» -->
      <h2 class="font-bold text-lg mt-6 mb-2">å¹´ã”ã¨ã®ä¿®ç†è²»</h2>
      <div id="yearlyRepairContainer" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>

      <!-- æ©Ÿæ¢°ã”ã¨ã®ä¿®ç†è²» -->
      <h2 class="font-bold text-lg mt-6 mb-2">æ©Ÿæ¢°ã”ã¨ã®ä¿®ç†è²»</h2>
      <div id="machineRepairContainer" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>

      <!-- æœ€è¿‘ã®ä¿®ç†å±¥æ­´ -->
      <h2 class="font-bold text-lg mt-6 mb-2">æœ€è¿‘ã®ä¿®ç†</h2>
      <div id="recentRepairContainer" class="space-y-3"></div>

    </div>

    <div id="invoiceOCRView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10 hidden">

      <div class="flex items-center gap-2 mb-4 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-2 text-lg">
        <i class="fa-solid fa-screwdriver-wrench"></i> ä¿®ç†å±¥æ­´ã®ç™»éŒ²
      </div>

      <!-- è«‹æ±‚æ›¸ã®èª­ã¿å–ã‚Š -->
      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">è«‹æ±‚æ›¸ãƒ»é ˜åæ›¸ã®æ’®å½±</label>

        <input type="file" id="invoiceImage" accept="image/*" capture="environment" class="hidden"
          onchange="previewInvoice(this)">

        <button onclick="document.getElementById('invoiceImage').click()"
          class="w-full py-4 border-2 border-dashed border-[#6b8f71] rounded-lg text-[#6b8f71] flex flex-col items-center gap-2 hover:bg-[#f0f7f1] transition-colors">
          <i class="fa-solid fa-camera text-2xl"></i>
          <span class="text-sm font-bold">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹• / ç”»åƒã‚’é¸æŠ</span>
        </button>

        <div id="invoicePreviewArea" class="mt-4 hidden text-center">
          <img id="invoicePreviewImg" src="" class="w-full rounded-lg shadow-md mb-2">
          <p class="text-[10px] text-gray-500">ã“ã®ç”»åƒã‚’ä¿®ç†å±¥æ­´ã¨ã—ã¦ä¿å­˜ã—ã¾ã™</p>
        </div>
      </div>

      <!-- è‡ªå‹•å…¥åŠ›ã•ã‚Œã‚‹é …ç›® -->
      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">ä¿®ç†æ—¥</label>
        <input type="date" id="repairDate" class="w-full p-3 rounded-lg">
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">åº—èˆ—å</label>
        <input type="text" id="repairShop" class="w-full p-3 rounded-lg">
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">é‡‘é¡</label>
        <input type="number" id="repairCost" class="w-full p-3 rounded-lg">
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">ãƒ¡ãƒ¢ï¼ˆOCRå…¨æ–‡ï¼‰</label>
        <textarea id="repairMemo" class="w-full p-3 rounded-lg" rows="3"></textarea>
      </div>

      <button id="saveRepairBtn" class="btn-main">ä¿®ç†å±¥æ­´ã‚’ä¿å­˜</button>
      <button onclick="switchView('repairView')" class="btn-sub mt-4">ä¿®ç†å±¥æ­´ã¸æˆ»ã‚‹</button>

    </div>

    <div id="maintenanceDetailView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">

      <!-- ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆæ©Ÿæ¢°åã¯ JS ã§å·®ã—æ›¿ãˆã‚‹ï¼‰ -->
      <div class="flex items-center gap-2 mb-4 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-2 text-lg">
        <i class="fa-solid fa-tractor"></i>
        <span id="maintenanceMachineName">æ©Ÿæ¢°å</span>
      </div>

      <div class="card mb-4">
        <p class="font-bold text-sm text-gray-500 mb-2">ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹é€²æ—</p>
        <div id="maintenanceSummary" class="text-xs mt-1">
          æœªç€æ‰‹
        </div>
      </div>

      <div class="card mb-4">
        <p class="font-bold text-sm text-gray-500 mb-2">ç‚¹æ¤œé …ç›®</p>
        <div id="maintenanceChecklist" class="space-y-2">
        </div>
      </div>

      <!-- ä½œæ¥­å±¥æ­´ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ -->
      <div class="card mb-4">
        <p class="font-bold text-sm text-gray-500 mb-2">ä½œæ¥­å±¥æ­´</p>
        <div id="maintenanceHistoryLog" class="space-y-3 text-sm">
          <p class="italic text-gray-400 text-center py-4">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>
        </div>
      </div>

      <div class="card mb-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
        <p class="font-bold text-sm text-[#6b8f71] mb-4 flex items-center">
          <i class="fas fa-tools mr-2"></i>éƒ¨å“äº¤æ›ã‚’è¨˜éŒ²
        </p>

        <label class="block text-xs font-bold text-gray-400 mb-1">äº¤æ›éƒ¨å“ãƒ»é …ç›®å</label>
        <input id="newMaintenanceItem" type="text"
          class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#6b8f71] outline-none"
          placeholder="ä¾‹ï¼šã‚ªã‚¤ãƒ«ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆ">

        <label class="block text-xs font-bold text-gray-400 mb-1">æ‹…å½“è€…</label>
        <select id="newMaintenanceOperator"
          class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#6b8f71] outline-none">
          <option value="">æ‹…å½“è€…ã‚’é¸æŠ</option>
        </select>

        <label class="block text-xs font-bold text-gray-400 mb-1">çŠ¶æ…‹</label>
        <select id="newMaintenanceStatus"
          class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#6b8f71] outline-none">
          <option value="done">å®Œäº†</option>
          <option value="progress">ä½œæ¥­ä¸­</option>
        </select>

        <label class="block text-xs font-bold text-gray-400 mb-1">ãƒ¡ãƒ¢</label>
        <textarea id="newMaintenanceMemo" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-4" rows="2"
          placeholder="å‚™è€ƒ"></textarea>

        <button onclick="saveMaintenanceRecord()"
          class="btn-main w-full py-3 bg-[#6b8f71] text-white rounded-lg font-bold hover:bg-[#5a7a5f] transition-all shadow-md">
          éƒ¨å“äº¤æ›ã‚’ä¿å­˜ã™ã‚‹
        </button>
      </div>

      <div class="flex justify-center w-full mt-6 mb-8">
        <button onclick="switchView('maintenanceMachineListView')"
          class="bg-gray-500 text-white px-6 py-2.5 rounded-lg hover:bg-gray-600 transition-colors whitespace-nowrap text-[13px] sm:text-sm shadow-md flex items-center justify-center">
          <i class="fas fa-arrow-left mr-2"></i>
          <span>æ©Ÿæ¢°ä¸€è¦§ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</span>
        </button>
      </div>
    </div>

    <div id="versionView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">
      <div class="flex items-center gap-2 mb-4 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-2 text-lg">
        <i class="fa-solid fa-code-branch"></i> ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±
      </div>

      <div class="card text-sm leading-relaxed space-y-3">
        <p><span class="font-bold">ãƒãƒ¼ã‚¸ãƒ§ãƒ³:</span> 1.0.0</p>
        <p><span class="font-bold">æœ€çµ‚æ›´æ–°æ—¥:</span> 2026-01-19</p>

        <div>
          <p class="font-bold text-[#6b8f71] mb-1">æ›´æ–°å†…å®¹</p>
          <ul class="list-disc pl-5 space-y-1">
            <li>åˆæœŸãƒªãƒªãƒ¼ã‚¹</li>
          </ul>
        </div>

        <div>
          <p class="font-bold text-[#6b8f71] mb-1">ä½¿ç”¨æŠ€è¡“</p>
          <ul class="list-disc pl-5 space-y-1">
            <li>HTML / CSS / JavaScript</li>
            <li>Tailwind CSS</li>
            <li>Supabase</li>
            <li>Chart.js</li>
            <li>GitHub Pages</li>
          </ul>
        </div>
      </div>

      <button onclick="switchView('inputView')" class="btn-sub mt-6">TOPã«æˆ»ã‚‹</button>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const SUPABASE_URL = "https://txsqxnwgolybcdclazdx.supabase.co";
    const SUPABASE_KEY = "sb_publishable_8JEM6Yyg5_oQpF-grdaxIw_rrxZBQYj";
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let allMachines = []; let currentMachineId = 'all'; window.charts = {};

    function openMenu() { document.getElementById("sideMenu").style.left = "0px"; document.getElementById("overlay").style.display = "block"; }
    function closeMenu() { document.getElementById("sideMenu").style.left = "-280px"; document.getElementById("overlay").style.display = "none"; }

    function showModal(title, message, onOk) {
      const modal = document.getElementById("customModal");
      document.getElementById("modalTitle").innerText = title;
      document.getElementById("modalMessage").innerText = message;
      const okBtn = document.getElementById("modalOkBtn");
      okBtn.onclick = () => { closeModal(); if (onOk) onOk(); };
      modal.classList.add("active");
    }
    function closeModal() { document.getElementById("customModal").classList.remove("active"); }

    function switchView(id) {
      console.log("Switching to:", id); // ã©ã“ã«åˆ‡ã‚Šæ›¿ãˆã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã‹ç¢ºèª

      // å…¨ã¦ã®ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰activeã‚’å–ã‚Šé™¤ã
      document.querySelectorAll('.view').forEach(v => {
        v.classList.remove('active');
        v.style.display = 'none';
      });

      // å¯¾è±¡ã®ãƒ“ãƒ¥ãƒ¼ã‚’å–å¾—
      const targetView = document.getElementById(id);
      if (targetView) {
        targetView.classList.add('active');
        targetView.style.display = 'block'; // å¼·åˆ¶çš„ã«è¡¨ç¤º
      } else {
        console.error("ã‚¨ãƒ©ãƒ¼: ID '" + id + "' ã®ãƒ“ãƒ¥ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
      }

      // ãƒ˜ãƒƒãƒ€ãƒ¼ã®åˆ¶å¾¡
      const header = document.getElementById("pageHeader");
      if (header) {
        header.style.display = (id === 'dashboard') ? 'none' : 'flex';
      }

      closeMenu();

      // å„ãƒšãƒ¼ã‚¸ã”ã¨ã®èª­ã¿è¾¼ã¿å‡¦ç†
      if (id === 'dashboard') {
        setTimeout(() => renderDashboard('all'), 100);
      }
      if (id === 'todayView') {
        console.log("æœ¬æ—¥ãƒ­ã‚°èª­è¾¼å®Ÿè¡Œ");
        loadLogs("todayLogList", true);
      }
      if (id === 'historyView') {
        console.log("å±¥æ­´ãƒ­ã‚°èª­è¾¼å®Ÿè¡Œ");
        loadLogs("historyLogList", false);
      }
      if (id === 'repairView') {
        loadRepairDashboard();
      }
      if (id === 'maintenanceMachineListView') {
        loadMachineList();
      }
      if (id === 'maintenanceView') {
        console.log("ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹çŠ¶æ…‹ã‚’å¾©å…ƒä¸­...");
        restoreMaintenanceChecks();
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      // 1. æ©Ÿæ¢°ï¼ˆãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ã®ã¿ï¼‰ã®å–å¾—
      const { data: machines } = await client
        .from("machines")
        .select("*")
        .eq("machine_type", "tractor")
        .order("name");

      allMachines = machines || [];

      // 2. ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã®å–å¾—
      const { data: operators } = await client
        .from("operators")
        .select("*")
        .order("id");

      // 3. ä½œæ¥­å†…å®¹ã®å–å¾—
      const { data: workTypes } = await client
        .from("work_types")
        .select("*")
        .order("id");

      // --- å„ç”»é¢è¦ç´ ã¸ã®åæ˜  ---

      // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®æ©Ÿæ¢°é¸æŠ
      const machineSelect = document.getElementById("machineSelect");
      if (machineSelect) {
        machineSelect.innerHTML = '<option value="">é¸æŠ</option>' +
          allMachines.map(m => `<option value="${m.id}">${m.name}</option>`).join("");
      }

      // æ¤œç´¢æ¡ä»¶ã®æ©Ÿæ¢°é¸æŠ
      const filterMachine = document.getElementById("filterMachine");
      if (filterMachine) {
        filterMachine.innerHTML = '<option value="">ã™ã¹ã¦ã®æ©Ÿæ¢°</option>' +
          allMachines.map(m => `<option value="${m.id}">${m.name}</option>`).join("");
      }

      // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®æ©Ÿæ¢°åˆ¥ã‚¿ãƒ–
      const machineTabs = document.getElementById("machineTabs");
      if (machineTabs) {
        machineTabs.innerHTML = `<button onclick="renderDashboard('all')" id="tab-all" class="tab-btn active">å…¨ä½“</button>` +
          allMachines.map(m => `<button onclick="renderDashboard(${m.id})" id="tab-${m.id}" class="tab-btn inactive">${m.name}</button>`).join("");
      }

      // ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼é¸æŠã®åæ˜ ï¼ˆæ¤œç´¢ã¨å…¥åŠ›ä¸¡æ–¹ï¼‰
      if (operators) {
        const opList = operators.map(o => `<option value="${o.name}">${o.name}</option>`).join("");
        const fOp = document.getElementById("filterOperator");
        if (fOp) fOp.innerHTML = '<option value="">å…¨ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼</option>' + opList;

        const iOp = document.getElementById("operator");
        if (iOp) iOp.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' + opList;
      }

      // ä½œæ¥­å†…å®¹ã®åæ˜ ï¼ˆé€£å‹•ãƒ­ã‚¸ãƒƒã‚¯å«ã‚€ï¼‰
      if (workTypes) {
        // æ¤œç´¢æ¡ä»¶å´
        const fCat = document.getElementById("filterCategory");
        if (fCat) {
          fCat.innerHTML = '<option value="">å…¨ä½œæ¥­å†…å®¹</option>' +
            workTypes.map(w => `<option value="${w.work_name || w.category}">${w.work_name || w.category}</option>`).join("");
        }

        // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ å´ï¼ˆç¨®åˆ¥ï¼‰
        const iCat = document.getElementById("category");
        if (iCat) {
          const categories = [...new Set(workTypes.map(w => w.category))];
          iCat.innerHTML = '<option value="">ç¨®åˆ¥ã‚’é¸æŠ</option>' +
            categories.map(c => `<option value="${c}">${c}</option>`).join("");

          // ç¨®åˆ¥ã‚’é¸ã‚“ã ã‚‰ä½œæ¥­å†…å®¹ã‚’å‡ºã™é€£å‹•è¨­å®š
          iCat.onchange = () => {
            const selected = iCat.value;
            const iWork = document.getElementById("work_name");
            if (iWork) {
              const filtered = workTypes.filter(t => t.category === selected);
              iWork.innerHTML = '<option value="">ä½œæ¥­å†…å®¹ã‚’é¸æŠ</option>' +
                filtered.map(t => `<option value="${t.work_name}">${t.work_name}</option>`).join("");
            }
          };
        }
      }

      // æ—¥ä»˜ã®åˆæœŸ
      const today = new Date().toISOString().split('T')[0];
      if (document.getElementById("workDate")) {
        document.getElementById("workDate").value = today;
      }
      if (document.getElementById("filterMonth")) {
        document.getElementById("filterMonth").value = today.substring(0, 7);
      }

      console.log("å…¨ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ã¨æ—¥ä»˜ã‚»ãƒƒãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ");
    });

    // ä¿®ç†å±¥æ­´ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚€
    async function loadRepairDashboard() {
      try {
        // repair_logs ã‚’ã™ã¹ã¦å–å¾—
        const { data: logs, error } = await client
          .from('repair_logs')
          .select('*')
          .order('date', { ascending: false });

        if (error) {
          console.error('Error loading repair logs:', error);
          return;
        }

        // -----------------------------
        // â‘  ç´¯è¨ˆä¿®ç†è²»
        // -----------------------------
        const totalCost = logs.reduce((sum, log) => sum + (log.cost || 0), 0);
        document.getElementById('totalRepairCost').textContent =
          'Â¥ ' + totalCost.toLocaleString();

        // -----------------------------
        // â‘¡ å¹´ã”ã¨ã®ä¿®ç†è²»
        // -----------------------------
        const yearly = {};
        logs.forEach(log => {
          const year = new Date(log.date).getFullYear();
          if (!yearly[year]) yearly[year] = 0;
          yearly[year] += log.cost || 0;
        });

        const yearlyContainer = document.getElementById('yearlyRepairContainer');
        yearlyContainer.innerHTML = '';

        Object.keys(yearly)
          .sort((a, b) => b - a)
          .forEach(year => {
            const card = document.createElement('div');
            card.className =
              'p-3 bg-white rounded shadow text-center border border-gray-100';
            card.innerHTML = `
          <div class="text-sm text-gray-500">${year}å¹´</div>
          <div class="text-lg font-bold text-[#6b8f71]">Â¥ ${yearly[year].toLocaleString()}</div>
        `;
            yearlyContainer.appendChild(card);
          });

        // -----------------------------
        // â‘¢ æ©Ÿæ¢°ã”ã¨ã®ä¿®ç†è²»
        // -----------------------------
        const machineTotals = {};

        logs.forEach(log => {
          if (!machineTotals[log.machine_id]) machineTotals[log.machine_id] = 0;
          machineTotals[log.machine_id] += log.cost || 0;
        });

        // machines ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰åå‰ã‚’å–å¾—
        const { data: machines } = await client.from('machines').select('*');

        const machineContainer = document.getElementById('machineRepairContainer');
        machineContainer.innerHTML = '';

        Object.keys(machineTotals).forEach(machineId => {
          const machine = machines.find(m => m.id === Number(machineId));
          const name = machine ? machine.name : 'ä¸æ˜ãªæ©Ÿæ¢°';

          const card = document.createElement('div');
          card.className =
            'p-3 bg-white rounded shadow text-center border border-gray-100';
          card.innerHTML = `
        <div class="text-sm text-gray-500">${name}</div>
        <div class="text-lg font-bold text-[#6b8f71]">Â¥ ${machineTotals[machineId].toLocaleString()}</div>
      `;
          machineContainer.appendChild(card);
        });

        // -----------------------------
        // â‘£ æœ€è¿‘ã®ä¿®ç†å±¥æ­´ï¼ˆæœ€æ–°5ä»¶ï¼‰
        // -----------------------------
        const recentContainer = document.getElementById('recentRepairContainer');
        recentContainer.innerHTML = '';

        logs.slice(0, 5).forEach(log => {
          const item = document.createElement('div');
          item.className =
            'p-3 bg-white rounded shadow border border-gray-100';

          item.innerHTML = `
        <div class="text-sm text-gray-500">${log.date}</div>
        <div class="font-bold">${log.memo || '(å†…å®¹ãªã—)'}</div>
        <div class="text-[#6b8f71] font-bold mt-1">Â¥ ${log.cost.toLocaleString()}</div>
        <div class="text-xs text-gray-400 mt-1">${log.shop || ''}</div>
      `;

          recentContainer.appendChild(item);
        });

      } catch (err) {
        console.error('Unexpected error:', err);
      }
    }

    async function autoFillHour() {
      const mId = document.getElementById("machineSelect").value;
      if (!mId) return;
      const { data } = await client.from("hour_logs").select("end_hour").eq("machine_id", mId).order("date", { ascending: false }).order("created_at", { ascending: false }).limit(1);
      if (data && data.length > 0) { document.getElementById("hourBefore").value = data[0].end_hour; calcDiff(); }
    }

    function calcDiff() {
      const b = parseFloat(document.getElementById("hourBefore").value) || 0;
      const a = parseFloat(document.getElementById("hourAfter").value) || 0;
      const d = a - b;
      const disp = document.getElementById("hourDiffDisplay");

      // â‘  ç¨¼åƒå¾Œã®ã»ã†ãŒå°ã•ã„å ´åˆã«æ–‡å­—ã‚’èµ¤ãã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
      if (a > 0 && a < b) {
        disp.classList.remove("text-[#6b8f71]");
        disp.classList.add("text-red-500");
        disp.textContent = `ç¨¼åƒæ™‚é–“: 0.0 h (å…¥åŠ›ã‚¨ãƒ©ãƒ¼)`;
      } else {
        disp.classList.remove("text-red-500");
        disp.classList.add("text-[#6b8f71]");
        disp.textContent = `ç¨¼åƒæ™‚é–“: ${d > 0 ? d.toFixed(1) : "0.0"} h`;
      }
    }

    function previewInvoice(input) {
      const previewArea = document.getElementById('invoicePreviewArea');
      const previewImg = document.getElementById('invoicePreviewImg');

      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
          previewImg.src = e.target.result;
          previewArea.classList.remove('hidden');
        }
        reader.readAsDataURL(input.files[0]);
      }
    }

    document.getElementById("saveBtn").onclick = async () => {
      const mId = document.getElementById("machineSelect").value;
      const hBefore = parseFloat(document.getElementById("hourBefore").value) || 0;
      const hAfter = parseFloat(document.getElementById("hourAfter").value) || 0;

      if (!mId) return alert("æ©Ÿæ¢°ã‚’é¸æŠã—ã¦ãã ã•ã„");
      if (hAfter < hBefore) return alert("ã‚¨ãƒ©ãƒ¼ï¼šç¨¼åƒå¾Œã®æ•°å€¤ãŒç¨¼åƒå‰ã‚ˆã‚Šå°ã•ããªã£ã¦ã„ã¾ã™ã€‚");

      showModal("ç™»éŒ²ç¢ºèª", "ãƒ­ã‚°ã‚’ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ", async () => {
        const logData = {
          machine_id: mId,
          date: document.getElementById("workDate").value,
          // â†“ã“ã“ã‚’ä¿®æ­£ï¼šoperatorSelect ã§ã¯ãªã operator
          operator: document.getElementById("operator").value,
          // â†“ã“ã“ã‚’ä¿®æ­£ï¼šcategorySelect ã§ã¯ãªã category
          category: document.getElementById("category").value,
          // â†“ã“ã“ã‚’ä¿®æ­£ï¼štaskSelect ã§ã¯ãªã work_name
          task: document.getElementById("work_name").value,
          start_hour: hBefore,
          end_hour: hAfter,
          fuel_amount: parseFloat(document.getElementById("fuelAmount").value) || 0,
          memo: document.getElementById("memoInput").value
        };

        const { error } = await client.from("hour_logs").insert([logData]);

        if (!error) {
          // ä¿å­˜ã«æˆåŠŸã—ãŸã‚‰ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°ã®çŠ¶æ…‹ã«ã™ã‚‹
          location.reload();
        } else {
          alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
          console.error("Supabaseã‚¨ãƒ©ãƒ¼:", error);
        }
      });
    };

    async function loadLogs(elId, todayOnly) {
      const list = document.getElementById(elId);
      list.innerHTML = "<p class='text-center py-10 opacity-50 text-xs'>èª­è¾¼ä¸­...</p>";

      // åŸºæœ¬ã®ã‚¯ã‚¨ãƒªä½œæˆ
      let query = client.from("hour_logs").select("*, machines(name)").order("date", { ascending: false });

      if (todayOnly) {
        // ã€æœ¬æ—¥ã®ç¨¼åƒçŠ¶æ³ã€‘æ—¥æœ¬æ™‚é–“ï¼ˆJSTï¼‰ã®ä»Šæ—¥ã®æ—¥ä»˜ã§çµã‚Šè¾¼ã¿
        const jstToday = new Date().toLocaleDateString('sv-SE');
        query = query.eq("date", jstToday);
      } else {

        // ã€ç¨¼åƒå±¥æ­´ã€‘ç”»é¢ã®å…¥åŠ›å€¤ã‚’å–å¾—ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‹ã‘ã‚‹
        const month = document.getElementById("filterMonth").value; // YYYY-MM
        const machine = document.getElementById("filterMachine").value;
        const operator = document.getElementById("filterOperator").value;
        const category = document.getElementById("filterCategory").value;

        // æœˆã§çµã‚Šè¾¼ã¿ (å‰æ–¹ä¸€è‡´)
        if (month) query = query.gte("date", `${month}-01`).lte("date", `${month}-31`);
        // æ©Ÿæ¢°ã§çµã‚Šè¾¼ã¿
        if (machine) query = query.eq("machine_id", machine);
        // ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã§çµã‚Šè¾¼ã¿
        if (operator) query = query.eq("operator", operator);
        // ç¨®åˆ¥ï¼ˆæ°´ç¨²ãƒ»ãã°ç­‰ï¼‰ã§çµã‚Šè¾¼ã¿
        if (category) query = query.eq("category", category);
      }

      const { data, error } = await query;
      if (error) {
        console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
        return;
      }

      let total = 0;
      const displayData = todayOnly ? [...(data || [])].reverse() : (data || []);

      list.innerHTML = displayData.map(l => {
        const diff = (l.end_hour - l.start_hour);
        total += diff;
        return `<div class="card border-l-4 border-[#6b8f71] !mb-3 !py-3 flex justify-between items-center">
              <div>
                <b class="text-sm">${l.date} - ${l.machines?.name}</b>
                <p class="text-xs opacity-70 mt-1">${l.operator} | ${l.task}</p>
                <div class="flex gap-4 mt-2">
                  <span class="text-[11px] font-bold log-badge px-2 py-1 rounded"><i class="fa-solid fa-clock mr-1 text-[#6b8f71]"></i>${diff.toFixed(1)} h</span>
                  <span class="text-[11px] font-bold log-badge px-2 py-1 rounded"><i class="fa-solid fa-gas-pump mr-1 text-[#6b8f71]"></i>${l.fuel_amount || 0} L</span>
                </div>
              </div>
              <button onclick="deleteLog(${l.id})" class="text-gray-400 p-2 hover:text-red-500 transition-colors">
                <i class="fa-regular fa-trash-can text-lg"></i>
              </button>
            </div>`;
      }).join("");

      if (!todayOnly) {
        const totalEl = document.getElementById("historyTotalHours");
        if (totalEl) totalEl.innerText = `åˆè¨ˆ: ${total.toFixed(1)} h`;
      }
    }

    async function deleteLog(id) {
      showModal("å‰Šé™¤ç¢ºèª", "ã“ã®ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ", async () => {
        const { error } = await client.from("hour_logs").delete().eq("id", id);
        if (!error) {
          if (document.getElementById("todayView").classList.contains("active")) loadLogs("todayLogList", true);
          else loadLogs("historyLogList", false);
        }
      });
    }

    // --- ã‚°ãƒ©ãƒ•æç”»ã®æ ¸å¿ƒéƒ¨ï¼ˆå®Œå…¨å¾©æ´»ç‰ˆï¼‰ ---
    function drawCharts(data) {
      console.log("ğŸ” å±Šã„ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã®1ä»¶ç›®ã‚’ç¢ºèª:", data[0]);

      if (typeof Chart === 'undefined') return;

      const ctx1 = document.getElementById('categoryShareChart');
      const ctx2 = document.getElementById('taskShareChart');
      const ctx3 = document.getElementById('detailChart');

      if (!ctx1 || !ctx2 || !ctx3) {
        console.error("âŒ ã‚­ãƒ£ãƒ³ãƒã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:", { ctx1, ctx2, ctx3 });
        return;
      }

      window.charts = window.charts || { c1: null, c2: null, c3: null };
      if (window.charts.c1) window.charts.c1.destroy();
      if (window.charts.c2) window.charts.c2.destroy();
      if (window.charts.c3) window.charts.c3.destroy();

      const catData = {};
      const taskData = {};
      const timeline = {};

      data.forEach(d => {
        const hours = (parseFloat(d.end_hour) || 0) - (parseFloat(d.start_hour) || 0);
        const h = hours > 0 ? hours : 0;

        // â‘  ä½œç‰©åˆ¥
        const cat = d.category || "ãã®ä»–";
        catData[cat] = (catData[cat] || 0) + h;

        // â‘¡ ä½œæ¥­å†…å®¹
        const task = d.work_name || d.task_name || d.work_type || d.note || "ä¸æ˜";
        taskData[task] = (taskData[task] || 0) + h;

        // â‘¢ æ—¥ä»˜ï¼ˆæ£’ã‚°ãƒ©ãƒ•ç”¨ï¼‰
        const dateKey = d.date || d.created_at?.substring(0, 10);
        if (dateKey) {
          timeline[dateKey] = (timeline[dateKey] || 0) + h;
        }
      });

      console.log("ğŸ“Š é›†è¨ˆçµæœ:", { catData, taskData, timeline });

      const farmColors = ['#6b8f71', '#9eb3a2', '#d1dbd3', '#3a4d3f', '#b5c9b8', '#e8f0e9'];

      // â‘  ä½œç‰©åˆ¥æ¯”ç‡
      window.charts.c1 = new Chart(ctx1, {
        type: 'doughnut',
        data: { labels: Object.keys(catData), datasets: [{ data: Object.values(catData), backgroundColor: farmColors }] },
        options: { responsive: true, maintainAspectRatio: false }
      });

      // â‘¡ ä½œæ¥­å†…å®¹åˆ†æï¼ˆæ¨ªæ£’ã‚°ãƒ©ãƒ•ï¼‰
      if (ctx2) {
        // ãƒ‡ãƒ¼ã‚¿ã®å¤šã„é †ã«ä¸¦ã³æ›¿ãˆã‚‹
        const sortedTask = Object.entries(taskData).sort((a, b) => b[1] - a[1]);

        window.charts.c2 = new Chart(ctx2, {
          type: 'bar',
          data: {
            labels: sortedTask.map(t => t[0]), // ä½œæ¥­å
            datasets: [{
              label: 'h',
              data: sortedTask.map(t => t[1]), // æ™‚é–“
              backgroundColor: '#6b8f71',       // è¾²æ¥­ã‚‰ã—ã„ç·‘è‰²
              borderRadius: 4,
              barThickness: 12                 // æ£’ã®å¤ªã•ï¼ˆã‚¹ãƒƒã‚­ãƒªè¦‹ãˆã¾ã™ï¼‰
            }]
          },
          options: {
            indexAxis: 'y', // â˜…ã“ã‚Œã§æ¨ªæ£’ã«ãªã‚Šã¾ã™
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false } // å³å´ã®å‡¡ä¾‹ã‚’æ¶ˆã—ã¦ã‚¹ãƒšãƒ¼ã‚¹ç¢ºä¿
            },
            scales: {
              x: {
                beginAtZero: true,
                grid: { display: false },
                ticks: { font: { size: 9 } }
              },
              y: {
                grid: { display: false },
                ticks: {
                  font: { size: 10, weight: 'bold' },
                  color: '#333'
                }
              }
            },
            layout: {
              padding: { left: 0, right: 15, top: 0, bottom: 0 }
            }
          }
        });
      }

      // â‘¢ ç¨¼åƒæ¨ç§»
      const sortedDates = Object.keys(timeline).sort();
      window.charts.c3 = new Chart(ctx3, {
        type: 'bar',
        data: {
          labels: sortedDates.map(d => d.slice(5)), // MM-DD
          datasets: [{ label: 'h', data: sortedDates.map(d => timeline[d]), backgroundColor: '#6b8f71' }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    // 1. ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸€è¦§ï¼ˆãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ä¸€è¦§ï¼‰ã‚’è¡¨ç¤ºã™ã‚‹
    async function loadMachineList() {
      try {
        const { data: machines, error } = await client
          .from("machines")
          .select("*")
          .eq("machine_type", "tractor")
          .order("id");

        if (error) throw error;

        const container = document.getElementById("maintenanceMachineGrid");
        if (!container) return;
        container.innerHTML = "";

        const grouped = {};
        machines.forEach(m => {
          const manufacturer = m.manufacturer || "ãã®ä»–";
          if (!grouped[manufacturer]) grouped[manufacturer] = [];
          grouped[manufacturer].push(m);
        });

        Object.keys(grouped).forEach(brand => {
          const brandHeader = document.createElement("h3");
          brandHeader.className = "text-[#6b8f71] font-bold text-sm mb-2 mt-4 flex items-center gap-2";
          brandHeader.innerHTML = `<i class="fa-solid fa-tag opacity-50"></i> ${brand}`;
          container.appendChild(brandHeader);

          const grid = document.createElement("div");
          grid.className = "grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-4";

          grouped[brand].forEach(m => {
            const card = document.createElement("div");
            card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-all active:scale-95";
            card.onclick = () => openMaintenanceDetail(m.id);

            card.innerHTML = `
              <div class="flex flex-col gap-2">
                <div class="flex items-center gap-3">
                  <div style="color: #6b8f71;" class="text-xl flex-shrink-0">
                    <i class="fa-solid fa-tractor"></i>
                  </div>
                  <div class="font-bold text-gray-900 text-lg truncate">${m.name}</div>
                </div>
                <div class="border-t border-gray-50 pt-2" id="card-progress-${m.id}">
                  <div class="text-[11px] text-gray-400 flex items-center gap-1">
                    <i class="fa-solid fa-circle-notch fa-spin text-[9px]"></i> ç¢ºèªä¸­...
                  </div>
                </div>
              </div>
            `;
            grid.appendChild(card);

            (async () => {
              try {
                const { data: checks } = await client
                  .from('maintenance_status')
                  .select('status')
                  .filter('item_id', 'ilike', `${m.id}_%`);

                const totalItems = 13;
                const completedCount = checks ? checks.filter(c => c.status).length : 0;
                const percent = Math.round((completedCount / totalItems) * 100);

                const progressDiv = document.getElementById(`card-progress-${m.id}`);
                if (progressDiv) {
                  let statusHTML = percent === 0
                    ? `<span class="text-red-600 font-black"><i class="fa-solid fa-circle-exclamation text-[9px]"></i> æœªç€æ‰‹</span>`
                    : percent === 100
                      ? `<span class="text-[#6b8f71] font-black"><i class="fa-solid fa-circle-check text-[9px]"></i> å®Œäº†</span>`
                      : `<span class="text-orange-500 font-black"><i class="fa-solid fa-spinner text-[9px]"></i> ${percent}% å®Œäº†</span>`;

                  progressDiv.innerHTML = `
                    <div class="text-[11px] flex items-center gap-1">${statusHTML}</div>
                    <div class="w-full bg-gray-100 rounded-full h-1 mt-1">
                      <div class="bg-[#6b8f71] h-1 rounded-full transition-all duration-500" style="width: ${percent}%"></div>
                    </div>
                  `;
                }
              } catch (err) { console.error(err); }
            })();
          });
          container.appendChild(grid);
        });
      } catch (e) { console.error(e); }
    }

    // 2. è©³ç´°ç”»é¢ã‚’é–‹ã
    async function openMaintenanceDetail(machineId) {
      window.currentMachineId = machineId;
      switchView('maintenanceDetailView');

      try {
        const { data: machine } = await client.from("machines").select("*").eq("id", machineId).single();
        document.getElementById("maintenanceMachineName").textContent = machine.name;

        const { data: operators } = await client.from('operators').select('name').order('id');
        const opSelect = document.getElementById('newMaintenanceOperator');
        if (opSelect && operators) {
          opSelect.innerHTML = '<option value="">æ‹…å½“è€…ã‚’é¸æŠ</option>';
          operators.forEach(op => {
            const opt = document.createElement('option');
            opt.value = op.name; opt.textContent = op.name;
            opSelect.appendChild(opt);
          });
        }

        loadMaintenanceHistory(machineId);
        const { data: items } = await client.from("maintenance_items_tractor").select("*").order("id");
        const checklistContainer = document.getElementById("maintenanceChecklist");
        if (checklistContainer && items) {
          checklistContainer.innerHTML = "";
          items.forEach(item => {
            const uniqueId = `${machineId}_${item.id}`;
            const div = document.createElement("div");
            div.className = "flex items-center justify-between p-3 border-b border-gray-50 last:border-0 hover:bg-gray-50 transition-colors";
            div.innerHTML = `
              <div class="flex flex-col flex-1 text-left">
                  <span class="text-sm font-bold text-gray-700">${item.item_name}</span>
                  <span class="text-[10px] text-gray-400">${item.description || ''}</span>
              </div>
              <input type="checkbox" id="${uniqueId}" class="maintenance-check w-6 h-6 rounded border-gray-300 text-[#6b8f71]"
                     onchange="saveSingleCheck('${machineId}', '${item.id}', this.checked)">
            `;
            checklistContainer.appendChild(div);
          });
        }
        await restoreMaintenanceChecks();
      } catch (e) { console.error(e); }
    }

    // 3. é€²æ—è¡¨ç¤ºã®æ›´æ–°
    function updateMaintenanceProgress() {
      const checkboxes = document.querySelectorAll('#maintenanceChecklist input[type="checkbox"]');
      const total = checkboxes.length;
      if (total === 0) return;
      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
      const percentage = Math.round((checkedCount / total) * 100);
      const summaryDiv = document.getElementById('maintenanceSummary');
      if (summaryDiv) {
        summaryDiv.innerHTML = `
          <div class="flex justify-between items-center mb-1">
            <span class="font-bold text-[#6b8f71]">${percentage}% å®Œäº†</span>
            <span class="text-xs text-gray-400">${checkedCount} / ${total} é …ç›®</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="bg-[#6b8f71] h-2 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
          </div>
        `;
      }
    }

    // 4. ä¿å­˜
    async function saveSingleCheck(machineId, itemId, isChecked) {
      try {
        const uniqueId = `${machineId}_${itemId}`;
        await client.from('maintenance_status').upsert({
          item_id: uniqueId, status: Boolean(isChecked), updated_at: new Date()
        }, { onConflict: 'item_id' });
        updateMaintenanceProgress();
        loadMachineList();
      } catch (e) { console.error(e); }
    }

    // 5. å¾©å…ƒ
    async function restoreMaintenanceChecks() {
      try {
        const { data } = await client.from('maintenance_status').select('item_id, status');
        if (data) {
          data.forEach(row => {
            const el = document.getElementById(row.item_id);
            if (el) el.checked = row.status;
          });
        }
        updateMaintenanceProgress();
      } catch (e) { console.error(e); }
    }

    // --- ãã®ä»–ã€è²¼ã‚Šä»˜ã‘ã«å«ã¾ã‚Œã¦ã„ãŸé–¢æ•° ---
    async function loadMaintenanceHistory(machineId) {
      try {
        const { data } = await client.from('maintenance_records').select('*').eq('machine_id', machineId).order('created_at', { ascending: false });
        const container = document.getElementById('maintenanceHistoryLog');
        if (!container) return;
        if (!data || data.length === 0) {
          container.innerHTML = '<p class="italic text-gray-400 text-center py-4">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
          return;
        }
        container.innerHTML = data.map(rec => `
          <div class="border-b border-gray-100 pb-2 mb-2 last:border-0 text-left">
            <div class="flex justify-between font-bold text-gray-700"><span>${rec.item_name}</span><span class="text-gray-400 text-[9px]">${rec.date}</span></div>
            <div class="text-gray-500">æ‹…å½“: ${rec.operator}</div>
            ${rec.memo ? `<div class="text-gray-400 italic">"${rec.memo}"</div>` : ''}
          </div>`).join('');
      } catch (e) { console.error(e); }
    }

    // ==========================================
    // 1. ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–ï¼ˆDOMContentLoadedï¼‰
    // ==========================================
    document.addEventListener('DOMContentLoaded', async () => {
      console.log("ğŸš€ å…¨ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ã‚’é–‹å§‹ã—ã¾ã™...");

      // ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ»ãƒ­ã‚°å…¥åŠ›ãƒ»å±¥æ­´ã®èª­ã¿è¾¼ã¿
      if (typeof loadMachineList === 'function') await loadMachineList();
      if (typeof restoreMaintenanceChecks === 'function') await restoreMaintenanceChecks();
      if (typeof loadOperators === 'function') await loadOperators();
      if (typeof loadCategories === 'function') await loadCategories();
      if (typeof loadLogs === 'function') loadLogs('historyLogList', false);

      // æ—¥ä»˜ã‚»ãƒƒãƒˆ
      const dateInput = document.getElementById('workDate');
      if (dateInput) dateInput.value = new Date().toLocaleDateString('sv-SE');
      const monthInput = document.getElementById('filterMonth');
      if (monthInput) monthInput.value = new Date().toISOString().substring(0, 7);

      // â˜…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®åˆæœŸè¡¨ç¤ºï¼ˆå…¨ä½“ã‚’è¡¨ç¤ºï¼‰
      if (typeof renderDashboard === 'function') {
        renderDashboard('all');
      }

      console.log("âœ… å…¨ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–å‘½ä»¤ã‚’å®Œäº†ã—ã¾ã—ãŸ");
    }); // â† ã“ã“ã§ DOMContentLoaded ãŒã‚¹ãƒƒã‚­ãƒªçµ‚äº†ï¼


    // ==========================================
    // 2. å®Ÿå‹™ã‚’ã“ãªã™é–¢æ•°ãŸã¡ï¼ˆå¤–å´ã«ç½®ãï¼‰
    // ==========================================

    // --- ã‚°ãƒ©ãƒ•ã‚’æç”»ã™ã‚‹é–¢æ•° ---
    function drawCharts(data) {
      console.log("ğŸ“ˆ ã‚°ãƒ©ãƒ•æç”»ã‚’å®Ÿè¡Œã—ã¾ã™...");

      if (typeof Chart === 'undefined') {
        console.error("âŒ Chart.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        return;
      }

      const ctx1 = document.getElementById('categoryShareChart');
      const ctx2 = document.getElementById('taskShareChart');
      const ctx3 = document.getElementById('detailChart');

      if (!ctx1 || !ctx2 || !ctx3) {
        console.warn("âš ï¸ ã‚°ãƒ©ãƒ•ç”¨ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚IDã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      window.charts = window.charts || { c1: null, c2: null, c3: null };
      if (window.charts.c1) window.charts.c1.destroy();
      if (window.charts.c2) window.charts.c2.destroy();
      if (window.charts.c3) window.charts.c3.destroy();

      const categories = {};
      data.forEach(d => { categories[d.category] = (categories[d.category] || 0) + 1; });

      window.charts.c1 = new Chart(ctx1, {
        type: 'doughnut',
        data: {
          labels: Object.keys(categories),
          datasets: [{
            data: Object.values(categories),
            backgroundColor: ['#6b8f71', '#9eb3a2', '#d1dbd3', '#e8f0e9', '#3a4d3f']
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });

      console.log("âœ… ã‚°ãƒ©ãƒ•ã®æç”»ãŒå®Œäº†ã—ã¾ã—ãŸ");
    }

    // --- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å…¨ä½“ã‚’åˆ¶å¾¡ã™ã‚‹é–¢æ•° ---
    async function renderDashboard(machineId) {
      window.currentViewMachineId = machineId;
      console.log("ğŸ› ï¸ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æç”»ä¸­... ID:", machineId);

      try {
        // 1. ã¾ãšãƒ™ãƒ¼ã‚¹ã®ã‚¯ã‚¨ãƒªã‚’ä½œã‚‹ï¼ˆ2026å¹´ä»¥é™ï¼‹æ—¥ä»˜é †ï¼‰
        let query = client
          .from("hour_logs")
          .select("*")
          .gte("date", "2026-01-01")
          .order("date", { ascending: false });

        // 2. ã€Œã™ã¹ã¦ã€ä»¥å¤–ãŒé¸ã°ã‚Œã¦ã„ã‚‹å ´åˆã ã‘ã€ã•ã‚‰ã«ãƒã‚·ãƒ³IDã§çµã‚Šè¾¼ã‚€
        // ã“ã“ãŒæŠœã‘ã¦ã„ãŸã‚Šã€é †ç•ªãŒé•ã†ã¨ãƒœã‚¿ãƒ³ãŒåå¿œã—ã¾ã›ã‚“ï¼
        if (machineId !== 'all') {
          query = query.eq("machine_id", machineId);
        }

        const { data, error } = await query;
        if (error) throw error;

        // ã‚‚ã—ãƒ‡ãƒ¼ã‚¿ãŒ0ä»¶ãªã‚‰ã€Œãƒ‡ãƒ¼ã‚¿ãªã—ã€ã¨è¡¨ç¤ºã—ã¦çµ‚ã‚ã‚‹ï¼ˆã‚¨ãƒ©ãƒ¼ã§æ­¢ã‚ãªã„ï¼‰
        if (!data || data.length === 0) {
          console.warn("âš ï¸ 2026å¹´ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚„ã‚°ãƒ©ãƒ•ã‚’ç©ºã«ã™ã‚‹å‡¦ç†ã‚’ã“ã“ã«å…¥ã‚Œã‚‹ã¨è¦ªåˆ‡ã§ã™
          const rankingContainer = document.getElementById("rankList");
          if (rankingContainer) rankingContainer.innerHTML = "ãƒ‡ãƒ¼ã‚¿ãªã—";
          return;
        }

        // é›†è¨ˆ
        const summary = {};
        data.forEach(log => {
          let name = "ä¸æ˜";
          if (typeof allMachines !== 'undefined') {
            const m = allMachines.find(item => String(item.id) === String(log.machine_id));
            if (m) name = m.name;
          }
          const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
          summary[name] = (summary[name] || 0) + (h > 0 ? h : 0);
        });

        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºï¼ˆä¸Šä½3ä½ï¼‰
        const sorted = Object.entries(summary).sort((a, b) => b[1] - a[1]);
        const rankingContainer = document.getElementById("rankList");
        if (rankingContainer) {
          const crownColors = ['text-yellow-500', 'text-gray-400', 'text-amber-600'];
          rankingContainer.innerHTML = sorted.slice(0, 3).map(([name, hours], i) => `
            <div class="flex flex-col items-center px-1 text-center" style="min-width: 75px;">
              <div class="mb-1"><i class="fa-solid fa-crown ${crownColors[i]} text-xl"></i></div>
              <span class="text-[10px] font-bold text-gray-700 truncate w-20 leading-tight">${name}</span>
            </div>
          `).join('');
        }

        // --- KPIã‚«ãƒ¼ãƒ‰ã®é›†è¨ˆã¨åæ˜  ---
        if (data) {
          let totalH = 0;
          let totalF = 0;
          const daysSet = new Set();

          data.forEach(log => {
            // ç¨¼åƒæ™‚é–“ã®è¨ˆç®—
            const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
            totalH += (h > 0 ? h : 0);

            // âœ… çµ¦æ²¹é‡ã‚’ fuel_amount ã‹ã‚‰å–å¾—
            totalF += (parseFloat(log.fuel_amount) || 0);

            // ä½œæ¥­æ—¥æ•°ã®ã‚«ã‚¦ãƒ³ãƒˆ
            if (log.date) daysSet.add(log.date);
          });

          // ç‡ƒè²»è¨ˆç®— (çµ¦æ²¹åˆè¨ˆ Ã· ç¨¼åƒæ™‚é–“åˆè¨ˆ)
          const fuelAvg = totalH > 0 ? (totalF / totalH).toFixed(2) : "0.00";

          // HTMLè¦ç´ ã¸ã®åæ˜ 
          const elH = document.getElementById("kpi-hours");
          const elF = document.getElementById("kpi-fuel");
          const elA = document.getElementById("kpi-avg");
          const elD = document.getElementById("kpi-days");

          if (elH) elH.innerText = totalH.toFixed(1);
          if (elF) elF.innerText = totalF.toFixed(1); // çµ¦æ²¹é‡
          if (elA) elA.innerText = fuelAvg;          // ç‡ƒè²»
          if (elD) elD.innerText = daysSet.size;      // æ—¥æ•°

          console.log("âœ… KPIæ›´æ–°å®Œäº† (fuel_amountä½¿ç”¨):", { totalH, totalF, fuelAvg });
        }

        // âœ… ã“ã“ãŒã€Œå‘¼ã³å‡ºã—ï¼ˆå‘½ä»¤ï¼‰ã€ã ã‘ã«ãªã£ã¦ã„ã‚‹ã®ãŒæ­£è§£ï¼
        if (typeof drawCharts === 'function') {
          drawCharts(data);
        }

      } catch (e) {
        console.error("âŒ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æç”»ã‚¨ãƒ©ãƒ¼:", e);
      }
    } // ğŸ‘ˆ renderDashboard ã¯ã“ã“ã§çµ‚ã‚ã‚Š

    // --- 2. ã‚°ãƒ©ãƒ•æç”»é–¢æ•°ï¼ˆå¤–å´ã§ã©ã£ã—ã‚Šæ§‹ãˆã‚‹ï¼‰ ---
    async function drawCharts(data) {
      console.log("ğŸ“Š ã‚°ãƒ©ãƒ•æç”»ã‚’é–‹å§‹ã—ã¾ã™...", data.length + "ä»¶");

      if (typeof Chart === 'undefined') return;

      // æ—¢å­˜ã‚°ãƒ©ãƒ•ã®ç ´æ£„
      if (window.charts) {
        Object.values(window.charts).forEach(c => c && typeof c.destroy === 'function' && c.destroy());
      }
      window.charts = {};

      const txt = '#3a3a3a';
      const colorSet = ['#1b4332', '#2d6a4f', '#40916c', '#52b788', '#74c69d'];

      // --- 1. ãƒ‡ãƒ¼ã‚¿é›†è¨ˆï¼ˆä»¥å‰ã®å¼•æ•°ã«åˆã‚ã›ã¦ä½œæˆï¼‰ ---
      const cat = {};     // ä½œç‰©
      const task = {};    // ä½œæ¥­
      const op = {};      // ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼
      const monthly = new Array(12).fill(0); // æœˆåˆ¥(1-12æœˆ)
      let totalH = 0;

      data.forEach(d => {
        const h = Math.max(0, (parseFloat(d.end_hour) || 0) - (parseFloat(d.start_hour) || 0));
        totalH += h;

        // â‘  ä½œç‰©åˆ¥
        cat[d.category || "ä»–"] = (cat[d.category || "ä»–"] || 0) + h;

        // â‘¡ ä½œæ¥­å†…å®¹
        const taskName = d.task || d.work_name || "ä»–";
        task[taskName] = (task[taskName] || 0) + h;

        // â‘¢ ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼
        op[d.operator || "ä¸æ˜"] = (op[d.operator || "ä¸æ˜"] || 0) + h;

        // â‘£ æœˆåˆ¥
        if (d.date) {
          const month = new Date(d.date).getMonth();
          monthly[month] += h;
        }
      });

      // ãƒ‰ãƒ¼ãƒŠãƒ„ã‚°ãƒ©ãƒ•ã®å…±é€šè¨­å®š
      const donut = (id, labelData) => {
        const el = document.getElementById(id);
        if (!el) return null;
        return new Chart(el, {
          type: 'doughnut',
          data: { labels: Object.keys(labelData), datasets: [{ data: Object.values(labelData), backgroundColor: colorSet, borderWidth: 0 }] },
          options: {
            cutout: '75%', maintainAspectRatio: false,
            plugins: { legend: { display: true, position: 'right', labels: { boxWidth: 10, font: { size: 10 }, color: txt } } }
          }
        });
      };

      // --- 2. å„ã‚°ãƒ©ãƒ•ã®æç”» ---
      window.charts.c1 = donut('categoryShareChart', cat);
      window.charts.c2 = donut('taskShareChart', task);
      window.charts.c3 = donut('operatorShareChart', op);

      // æœˆåˆ¥æ¨ç§»ï¼ˆæŠ˜ã‚Œç·šï¼‰
      const detailEl = document.getElementById('detailChart');
      if (detailEl) {
        window.charts.line = new Chart(detailEl, {
          type: 'line',
          data: {
            labels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'],
            datasets: [{ label: 'h', data: monthly, borderColor: '#6b8f71', backgroundColor: 'rgba(107,143,113,0.1)', fill: true, tension: 0.4 }]
          },
          options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
      }

      // æ¨ªæ£’ã‚°ãƒ©ãƒ• (ä½œæ¥­å†…å®¹åˆ†æï¼šãƒ©ãƒ³ã‚­ãƒ³ã‚°å½¢å¼)
      // æ¨ªæ£’ã‚°ãƒ©ãƒ• (ä½œæ¥­å†…å®¹åˆ†æï¼šãƒ©ãƒ³ã‚­ãƒ³ã‚° ï¼‹ ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¾©æ´»)
      const barEl = document.getElementById('gradientBarChart');
      if (barEl) {
        // 1. ç¨¼åƒæ™‚é–“ãŒå¤šã„é †ã«ä¸¦ã¹æ›¿ãˆ
        const sortedTask = Object.entries(task).sort((a, b) => b[1] - a[1]);
        const tLabels = sortedTask.map(t => t[0]);
        const tData = sortedTask.map(t => t[1]);

        window.charts.bar = new Chart(barEl, {
          type: 'bar',
          data: {
            labels: tLabels,
            datasets: [{
              label: 'h',
              data: tData,
              // â˜…ä»¥å‰ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šã‚’é©ç”¨
              backgroundColor: tData.map((_, i) => `rgba(45, 64, 49, ${Math.max(0.2, 1 - (i / tLabels.length))})`),
              borderRadius: 4,
              maxBarThickness: 28,
            }]
          },
          options: {
            indexAxis: 'y',
            maintainAspectRatio: false,
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
              x: {
                beginAtZero: true,
                grid: { color: '#f0f0f0' },
                ticks: { font: { size: 10 } }
              },
              y: {
                grid: { display: false },
                ticks: {
                  autoSkip: false,
                  font: { size: 11, weight: 'bold' },
                  color: '#333'
                }
              }
            }
          }
        });
      }
      // å‰å¹´æ¯”ã‚²ãƒ¼ã‚¸ (ç°¡æ˜“ç‰ˆ)
      const gaugeEl = document.getElementById('yearComparisonGauge');
      if (gaugeEl) {
        const ratio = Math.min(100, (totalH / 500) * 100); // ä»®ã«ç›®æ¨™ã‚’500hã¨ã—ã¦ã„ã¾ã™
        window.charts.gauge = new Chart(gaugeEl, {
          type: 'doughnut',
          data: { datasets: [{ data: [ratio, 100 - ratio], backgroundColor: ['#6b8f71', '#eee'], borderWidth: 0 }] },
          options: { rotation: -90, circumference: 180, cutout: '75%', maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
        const valEl = document.getElementById("detailCompareValue");
        if (valEl) valEl.innerText = ratio.toFixed(1) + "%";
      }

      console.log("âœ… è±ªè¯ç‰ˆã‚°ãƒ©ãƒ•ã®æç”»ãŒå®Œäº†ã—ã¾ã—ãŸ");
    }

  </script>
</body>

</html>