<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex">
  <link rel="manifest" href="/tractorlog/manifest.json">
  <title>å’Œè¾²æ—¥å‘ Tractor Log</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* --- åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« --- */
    body {
      background-color: #e2e8e3;
      color: #3a3a3a;
      font-family: "Hiragino Sans", "Noto Sans JP", sans-serif;
      margin: 0;
    }

    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    #sideMenu {
      position: fixed;
      top: 0;
      left: -280px;
      width: 280px;
      height: 100%;
      background: white;
      z-index: 9999;
      transition: left 0.3s ease;
      padding: 20px;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
    }

    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: 9998;
      display: none;
    }

    .menu-item {
      width: 100%;
      text-align: left;
      padding: 0.8rem;
      border-radius: 0.5rem;
      font-weight: bold;
      color: #6b8f71;
      display: flex;
      align-items: center;
      font-size: 0.9rem;
    }

    select,
    input,
    textarea {
      color: #3a3a3a !important;
      background-color: #ffffff !important;
      border: 1px solid #ddd;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 6px 16px rgba(107, 143, 113, 0.10);
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }

    /* Override Tailwind shadows to use a greenish-gray tint for cards */
    .shadow-sm {
      box-shadow: 0 4px 10px rgba(107, 143, 113, 0.06) !important;
    }
    .shadow {
      box-shadow: 0 8px 22px rgba(107, 143, 113, 0.10) !important;
    }

    .btn-main {
      background-color: #6b8f71;
      color: white;
      padding: 14px;
      border-radius: 12px;
      text-align: center;
      font-weight: bold;
      width: 100%;
      display: block;
    }

    .btn-sub {
      background-color: #6b8f71;
      color: white;
      padding: 12px;
      border-radius: 10px;
      text-align: center;
      font-weight: bold;
      width: 160px;
      max-width: 40%;
      margin: 20px auto 0;
      display: block;
      border: none;
      cursor: pointer;
    }

    .log-badge {
      background-color: #f3f4f6;
      color: #374151;
    }

    #dashboard.active {
      display: flex !important;
      flex-direction: column;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .bi-header {
      height: 65px;
      display: flex;
      align-items: center;
      background: #2d4031;
      color: white;
      flex-shrink: 0;
      width: 100%;
      padding: 0 20px;
    }

    .dashboard-top-bar {
      flex-shrink: 0;
      padding: 10px 15px;
    }

    .main-top-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: stretch;
    }

    .kpi-section {
      flex: 1;
      min-width: 320px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .ranking-section {
      flex: 0.4;
      min-width: 250px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 12px;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
    }

    .kpi-card {
      background: #6b8f71;
      color: white;
      padding: 8px 2px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .kpi-label {
      font-size: 9px;
      font-weight: bold;
      opacity: 0.9;
    }

    .kpi-value-container {
      display: flex;
      align-items: baseline;
      gap: 1px;
    }

    .kpi-value {
      font-size: 15px;
      font-weight: 900;
    }

    .kpi-unit {
      font-size: 12px;
      opacity: 0.8;
      font-weight: bold;
    }

    .bi-container {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      padding: 12px;
      gap: 12px;
      align-items: stretch;
    }

    .bi-left-col {
      flex: 1.1;
      min-width: 280px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .bi-main-col {
      flex: 1.8;
      min-width: 320px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .bi-right-col {
      flex: 0.8;
      min-width: 280px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-self: stretch;
    }

    .bi-right-col>.yoy-card {
      flex: 1 1 0% !important;
      min-height: 0;
      max-height: 33%;
      display: flex;
      flex-direction: column;
    }

    .bi-right-col>.maint-card {
      flex: 2 2 0% !important;
      min-height: 0;
      max-height: 67%;
      display: flex;
      flex-direction: column;
    }

    #maintenanceLog {
      flex: 1;
      overflow-y: auto;
    }

    @media (max-width: 1024px) {
      .bi-right-col {
        width: 100%;
        flex: 1;
      }
    }

    .bi-container>div>.card {
      margin-bottom: 0 !important;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .chart-title {
      font-size: 14px !important;
      font-weight: bold !important;
      color: #6b8f71 !important;
      margin-bottom: 8px;
      display: block;
    }

    .chart-wrapper {
      flex: 1;
      position: relative;
      width: 100%;
      min-height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .donut-icon {
      position: absolute;
      font-size: 24px;
      color: #6b8f71;
      opacity: 0.3;
      pointer-events: none;
    }

    #customModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
      padding: 20px;
    }

    #customModal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      width: 100%;
      max-width: 320px;
      border-radius: 20px;
      overflow: hidden;
    }

    .tab-btn {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: bold;
      cursor: pointer;
      white-space: nowrap;
      border: none;
    }

    .tab-btn.active {
      background: #2d4031;
      color: white;
    }

    .tab-btn.inactive {
      background: rgba(255, 255, 255, 0.5);
      color: #6b8f71;
    }

    .dashboard-sidebar {
      width: 200px;
      min-width: 200px;
      background: #2d4031;
      color: white;
      height: 100vh;
      position: sticky;
      top: 0;
      display: flex;
      flex-direction: column;
      padding: 20px 0;
    }

    .nav-item {
      width: 100%;
      padding: 15px 20px;
      text-align: left;
      color: rgba(255, 255, 255, 0.7);
      font-size: 13px;
      border: none;
      background: none;
      cursor: pointer;
      transition: 0.3s;
    }

    .nav-item i {
      margin-right: 10px;
    }

    .nav-item.active {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border-left: 4px solid #6b8f71;
    }

    .dashboard-main-content {
      overflow-y: auto;
      height: 100vh;
    }
  </style>
</head>

<body>

  <div id="overlay" onclick="closeMenu()"></div>
  <div id="sideMenu">
    <div class="flex justify-between items-center mb-6">
      <h2 class="font-bold text-lg text-[#6b8f71]">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
      <button onclick="closeMenu()" class="text-2xl text-gray-400">&times;</button>
    </div>
    <nav class="space-y-1">
      <button onclick="switchView('inputView')" class="menu-item"><i
          class="fa-solid fa-pen-to-square w-8 text-lg"></i>ãƒ­ã‚°å…¥åŠ›</button>
      <button onclick="switchView('todayView')" class="menu-item"><i
          class="fa-solid fa-calendar-day w-8 text-lg"></i>æœ¬æ—¥ã®ç¨¼åƒçŠ¶æ³</button>
      <button onclick="switchView('historyView')" class="menu-item"><i
          class="fa-solid fa-magnifying-glass w-8 text-lg"></i>ç¨¼åƒå±¥æ­´ãƒ»æ¤œç´¢</button>
      <button onclick="switchView('dashboard')" class="menu-item"><i
          class="fa-solid fa-chart-line w-8 text-lg"></i>DASHBOARD</button>
      <button onclick="switchView('repairView'); loadRepairDashboard(); closeMenu();" class="menu-item">
        <i class="fa-solid fa-tools w-8 text-lg"></i>ä¿®ç†å±¥æ­´ </button>
      <button onclick="switchView('maintenanceMachineListView'); loadMachineList();" class="menu-item"><i
          class="fa-solid fa-toolbox w-8 text-lg"></i>ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹è¨˜éŒ²</button>
      <button onclick="switchView('versionView')" class="menu-item"><i
          class="fa-solid fa-info-circle w-8 text-lg"></i>ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±</button>
    </nav>
  </div>

  <div id="customModal">
    <div class="modal-content">
      <div class="modal-header bg-[#2d4031] p-4 text-white text-center">
        <h3 id="modalTitle" class="font-bold">CONFIRM</h3>
      </div>
      <div class="modal-body p-6 text-center font-bold" id="modalMessage">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
      <div class="modal-footer p-4 bg-gray-50 flex gap-2">
        <button class="flex-1 p-2 bg-gray-200 rounded-lg" onclick="closeModal()">æˆ»ã‚‹</button>
        <button id="modalOkBtn" class="flex-1 p-2 bg-[#6b8f71] text-white rounded-lg">å®Ÿè¡Œã™ã‚‹</button>
      </div>
    </div>
  </div>



  <div id="customModal">
    <div class="modal-content">
      <div class="modal-header bg-[#2d4031] p-4 text-white text-center">
        <h3 id="modalTitle" class="font-bold">CONFIRM</h3>
      </div>
      <div class="modal-body p-6 text-center font-bold" id="modalMessage">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
      <div class="modal-footer p-4 bg-gray-50 flex gap-2">
        <button class="flex-1 p-2 bg-gray-200 rounded-lg" onclick="closeModal()">æˆ»ã‚‹</button>
        <button id="modalOkBtn" class="flex-1 p-2 bg-[#6b8f71] text-white rounded-lg">å®Ÿè¡Œã™ã‚‹</button>
      </div>
    </div>
  </div>



  <div id="mainContainer">
    <header id="pageHeader" class="flex flex-col items-center justify-center py-8 relative">
      <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl text-[#6b8f71] p-2"><i
          class="fa-solid fa-bars"></i></button>
      <i class="fa-solid fa-tractor text-5xl text-[#6b8f71]"></i>
      <h1 class="text-xl font-bold text-[#6b8f71]">å’Œè¾²æ—¥å‘ Tractor log</h1>
    </header>

    <div id="inputView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">
      <div class="flex items-center gap-2 mb-1 mt-4">
        <i class="fa-solid fa-pen-to-square text-[#6b8f71] text-lg"></i>
        <span class="text-lg font-bold text-[#6b8f71]">ãƒ­ã‚°å…¥åŠ›</span>
      </div>
      <div class="border-t-2 border-[#6b8f71] mb-6 opacity-50"></div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">æ©Ÿæ¢°ã‚’é¸æŠ</label>
        <select id="machineSelect" class="w-full p-3 rounded-lg" onchange="autoFillHour()"></select>
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">ä½œæ¥­æ—¥</label>
        <input type="date" id="workDate" class="w-full p-3 rounded-lg" />
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼</label>
        <select id="operator" class="w-full p-3 rounded-lg">
          <option value="">èª­è¾¼ä¸­...</option>
        </select>
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">ç¨®åˆ¥</label>
        <select id="category" class="w-full p-3 rounded-lg">
          <option value="">èª­è¾¼ä¸­...</option>
        </select>
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">ä½œæ¥­å†…å®¹</label>
        <select id="work_name" class="w-full p-3 rounded-lg">
          <option value="">å…ˆã«ç¨®åˆ¥ã‚’é¸æŠ</option>
        </select>
      </div>

      <div class="card">
        <div class="flex space-x-4">
          <div class="flex-1">
            <label class="block text-xs font-bold text-gray-400 mb-1">ç¨¼åƒå‰</label>
            <input type="number" id="hourBefore" class="w-full p-3 rounded-lg font-bold" step="0.1"
              oninput="calcDiff()" />
          </div>
          <div class="flex-1 min-w-0">
            <label class="block text-xs font-bold text-gray-400 mb-1">ç¨¼åƒå¾Œ</label>
            <div class="flex items-center gap-2 min-w-0">
              <input type="number" id="hourAfter" class="flex-1 min-w-0 p-3 rounded-lg font-bold" step="0.1" oninput="calcDiff()" />
              <input type="file" id="hourAfterImage" accept="image/*" capture="environment" class="hidden" onchange="handleHourAfterImage(this)">
              <button type="button" onclick="document.getElementById('hourAfterImage').click()"
                class="flex-none p-2 bg-white border rounded-lg text-[#6b8f71] shadow-sm hover:bg-[#f0f7f1]"><i class="fa-solid fa-camera"></i></button>
            </div>
          </div>
        </div>
      </div>

      <div id="hourDiffDisplay" class="text-right font-black text-[#6b8f71] mb-6 text-xl">ç¨¼åƒæ™‚é–“: 0.0 h</div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">çµ¦æ²¹é‡ (L)</label>
        <input type="number" id="fuelAmount" class="w-full p-3 rounded-lg" />
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">ãƒ¡ãƒ¢</label>
        <textarea id="memoInput" class="w-full p-3 rounded-lg" rows="2"></textarea>
      </div>

      <button id="saveBtn" class="btn-main" onclick="saveLog()">ãƒ­ã‚°ã‚’ä¿å­˜ã™ã‚‹</button>
    </div>

    <div id="dashboard" class="view">
      <div class="bi-header">
        <button onclick="openMenu()" class="text-2xl mr-6 hover:opacity-70 transition-opacity"><i
            class="fa-solid fa-bars"></i></button>
        <h1 class="text-lg md:text-2xl font-black tracking-widest flex items-center">
          <i class="fa-solid fa-chart-column mr-3"></i> 2026 OPERATION DASHBOARD
        </h1>
      </div>

      <div class="dashboard-top-bar">
        <div class="main-top-row">
          <div class="kpi-section">
            <div id="machineTabs" class="flex gap-2 overflow-x-auto pb-1"></div>
            <div class="kpi-grid">
              <div class="kpi-card"><span class="kpi-label">ç· ç¨¼ åƒ</span>
                <div class="kpi-value-container"><span class="kpi-value" id="kpi-hours">0.0</span><span
                    class="kpi-unit">h</span></div>
              </div>
              <div class="kpi-card"><span class="kpi-label">çµ¦ æ²¹</span>
                <div class="kpi-value-container"><span class="kpi-value" id="kpi-fuel">0.0</span><span
                    class="kpi-unit">L</span></div>
              </div>
              <div class="kpi-card"><span class="kpi-label">ç‡ƒ è²»</span>
                <div class="kpi-value-container"><span class="kpi-value" id="kpi-avg">0.0</span><span
                    class="kpi-unit">L/h</span></div>
              </div>
              <div class="kpi-card"><span class="kpi-label">æ—¥ æ•°</span>
                <div class="kpi-value-container"><span class="kpi-value" id="kpi-days">0</span><span
                    class="kpi-unit">æ—¥</span></div>
              </div>
              <div class="kpi-card bg-[#4a6b50]"><span class="kpi-label">çŠ¶ æ…‹</span><span
                  class="kpi-value text-[15px]">è‰¯å¥½</span></div>
            </div>
          </div>
          <div class="ranking-section">
            <p class="text-[11px] font-bold text-[#6b8f71] mb-2 text-center"><i
                class="fa-solid fa-trophy mr-1"></i>ç¨¼åƒãƒ©ãƒ³ã‚­ãƒ³ã‚°</p>
            <div id="rankList" class="flex justify-around items-center"></div>
          </div>
        </div>
      </div>

      <div class="bi-container">
        <div class="bi-left-col">
          <div class="card">
            <p class="chart-title" style="display: flex; align-items: center;">
              <i class="fa-solid fa-screwdriver-wrench" style="margin-right: 8px; color: #6b8f71;"></i>
              æ©Ÿæ¢°åˆ¥ä¿®ç†ã‚³ã‚¹ãƒˆ
            </p>
            <div class="chart-wrapper relative">
              <canvas id="categoryShareChart"></canvas>
            </div>
          </div>

          <div class="card">
            <p class="chart-title" style="display: flex; align-items: center;">
              <i class="fa-solid fa-wheat-awn" style="margin-right: 8px; color: #6b8f71;"></i>
              ä½œç‰©åˆ¥æ¯”ç‡
            </p>
            <div class="chart-wrapper relative">
              <canvas id="taskShareChart"></canvas>
            </div>
          </div>

          <div class="card">
            <p class="chart-title" style="display: flex; align-items: center;">
              <i class="fa-solid fa-user-check" style="margin-right: 8px; color: #6b8f71;"></i>
              ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼æ¯”ç‡
            </p>

            <div class="chart-wrapper relative">
              <canvas id="operatorShareChart"></canvas>
            </div>
          </div>
        </div>
        <div class="bi-main-col">
          <div class="lg:col-span-2 space-y-4">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
              <p class="chart-title" style="display: flex; align-items: center;">
                <i class="fa-solid fa-calendar-days" style="margin-right: 8px; color: #6b8f71;"></i>
                æœˆåˆ¥ç¨¼åƒæ¨ç§»
              </p>
              <div class="relative h-40"> <canvas id="detailChart"></canvas>
              </div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
              <p class="chart-title" style="display: flex; align-items: center;">
                <i class="fa-solid fa-list-check" style="margin-right: 8px; color: #6b8f71;"></i>
                ä½œæ¥­å†…å®¹åˆ†æ
              </p>
              <div class="relative h-[480px]">
                <canvas id="gradientBarChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="bi-right-col">
          <div class="card yoy-card text-center relative">
            <p class="chart-title" style="display: flex; align-items: center; justify-content: center;">
              <i class="fa-solid fa-chart-line" style="margin-right: 8px; color: #6b8f71;"></i>
              å‰å¹´å®Ÿç¸¾æ¯” (YoY)
            </p>
            <div class="chart-wrapper relative">
              <canvas id="yearComparisonGauge"></canvas>
              <div class="absolute inset-0 flex items-center justify-center pt-14">
                <p id="detailCompareValue" class="text-2xl font-black text-[#6b8f71]">--%</p>
              </div>
            </div>
          </div>

          <div class="card maint-card overflow-hidden">
            <p class="chart-title border-b pb-1" style="display: flex; align-items: center;">
              <i class="fa-solid fa-clipboard-list" style="margin-right: 8px; color: #6b8f71;"></i>
              ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æƒ…å ±
            </p>
            <div id="maintenanceLog" class="text-[10px] space-y-2 opacity-80 pt-2 flex-1 overflow-y-auto">
              <p class="italic text-gray-400 text-center py-4">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="todayView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">
      <div class="flex items-center gap-2 mb-4 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-2 text-lg"><i
          class="fa-solid fa-calendar-day"></i> æœ¬æ—¥ã®ç¨¼åƒçŠ¶æ³</div>
      <div id="todayLogList" class="space-y-4"></div>
      <button onclick="switchView('inputView')" class="btn-sub">TOPã«æˆ»ã‚‹</button>
    </div>

    <div id="historyView" class="view px-4 py-6 max-w-3xl mx-auto pb-10">

      <div
        class="flex items-center gap-2 mb-6 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-3 text-lg w-full">
        <i class="fa-solid fa-magnifying-glass"></i>
        <span>ç¨¼åƒå±¥æ­´æ¤œç´¢</span>
      </div>

      <div class="card space-y-3 text-sm mb-6">
        <div class="grid grid-cols-2 gap-3">
          <div class="flex flex-col gap-1">
            <label class="text-[10px] text-gray-400 font-bold ml-1">å¯¾è±¡æœˆ</label>
            <input type="month" id="filterMonth" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm">
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-[10px] text-gray-400 font-bold ml-1">æ©Ÿæ¢°</label>
            <select id="filterMachine" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm">
              <option value="">ã™ã¹ã¦ã®æ©Ÿæ¢°</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mt-1">
          <div class="flex flex-col gap-1">
            <label class="text-[10px] text-gray-400 font-bold ml-1">ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼</label>
            <select id="filterOperator"
              class="p-3 rounded-lg w-full border border-gray-100 shadow-sm text-sm text-gray-600">
              <option value="">å…¨ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼</option>
            </select>
          </div>

          <div class="flex flex-col gap-1">
            <label class="text-[10px] text-gray-400 font-bold ml-1">ä½œæ¥­å†…å®¹</label>
            <select id="filterCategory"
              class="p-3 rounded-lg w-full border border-gray-100 shadow-sm text-sm text-gray-600">
              <option value="">å…¨ä½œæ¥­å†…å®¹</option>
            </select>
          </div>
        </div>

        <button onclick="loadLogs('historyLogList', false)" class="btn-main mt-2 shadow-md">
          æ¤œç´¢ã‚’å®Ÿè¡Œ
        </button>
      </div>

      <div class="flex justify-end items-center mb-4 px-1">
        <div id="historyTotalHours"
          class="text-sm font-black text-[#6b8f71] opacity-80 bg-white px-4 py-2 rounded-full shadow-sm">
          åˆè¨ˆ: 0.0 h
        </div>
      </div>

      <div id="historyLogList" class="space-y-4"></div>

      <button onclick="switchView('inputView')" class="btn-sub mt-8">
        <i class="fa-solid fa-house mr-2"></i>TOPã«æˆ»ã‚‹
      </button>
    </div>

    <div id="maintenanceMachineListView" class="view px-4 max-w-3xl mx-auto pb-10">
      <div class="flex items-center gap-2 mb-4 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-2 text-lg">
        <i class="fa-solid fa-wrench"></i> ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹è¨˜éŒ²
      </div>

      <div id="maintenanceMachineGrid" class="space-y-6">
      </div>

      <button onclick="switchView('inputView')" class="btn-sub mt-10 w-full">
        <i class="fa-solid fa-house mr-2"></i>TOPã«æˆ»ã‚‹
      </button>
    </div>

    <div id="repairView" class="view px-4 max-w-5xl mx-auto pb-16 hidden" style="background-color: #e2e8e3;">

      <div class="flex justify-between items-center pt-8 mb-6">
        <h2 class="text-xl md:text-2xl font-extrabold text-[#6b8f71] flex items-center gap-2">
          <i class="fa-solid fa-screwdriver-wrench"></i> Tractor ä¿®ç†å±¥æ­´
        </h2>
        <button onclick="switchView('invoiceOCRView'); populateMachineSelect();"
          class="bg-[#6b8f71] text-white px-5 py-2 rounded-full shadow-lg active:scale-95 transition-all text-xs font-bold">
          <i class="fa-solid fa-plus mr-1"></i> æ–°è¦ç™»éŒ²
        </button>
      </div>

      <div class="bg-gradient-to-br from-[#6b8f71] to-[#4b634d] rounded-[2rem] p-6 text-white shadow-xl mb-8 relative overflow-hidden">
        <div class="relative z-10">
          <p class="text-[#d1e0d3] text-[10px] md:text-xs font-medium mb-1 uppercase tracking-widest">2026å¹´åº¦ ç´¯è¨ˆä¿®ç†è²»</p>
          <h3 id="totalRepairCost" class="text-3xl md:text-5xl font-black tracking-wider">Â¥ 0</h3>
          <div class="mt-4 flex gap-4 text-[10px] text-[#d1e0d3]">
            <span><i class="fa-solid fa-tractor mr-1"></i> ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ã®ã¿ã®ä¿®ç†è²»</span>
          </div>
        </div>
        <i class="fa-solid fa-gears absolute -right-4 -bottom-4 text-white/10 text-7xl md:text-8xl rotate-12"></i>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col">
          <div class="flex items-center gap-2 mb-4 text-[#6b8f71] font-bold border-b border-gray-50 pb-2 text-sm">
            <i class="fa-solid fa-calendar-days"></i> å¹´ã”ã¨ã®ä¿®ç†è²»
          </div>
          <div id="yearlyRepairContainer" class="space-y-2 flex-grow text-sm">
          </div>
        </div>

        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col">
          <div class="flex items-center gap-2 mb-4 text-[#6b8f71] font-bold border-b border-gray-50 pb-2 text-sm">
            <i class="fa-solid fa-microchip"></i> æ©Ÿæ¢°ã”ã¨ã®é›†è¨ˆ
          </div>
          <div id="machineRepairContainer" class="space-y-2 flex-grow text-sm">
          </div>
        </div>

        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col">
          <div class="flex items-center gap-2 mb-4 text-[#6b8f71] font-bold border-b border-gray-50 pb-2 text-sm">
            <i class="fa-solid fa-clock-rotate-left"></i> æœ€è¿‘ã®ä¿®ç†
          </div>
          <div id="recentRepairContainer" class="space-y-3 flex-grow">
          </div>
        </div>
      </div>

      <div class="flex justify-center w-full mt-6 mb-8">
        <button onclick="switchView('inputView')" class="btn-sub w-full">
          <i class="fa-solid fa-house mr-2"></i>TOPã«æˆ»ã‚‹
        </button>
      </div>
    </div>

    <div id="invoiceOCRView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10 hidden">

      <div class="flex items-center gap-2 mb-4 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-2 text-lg">
        <i class="fa-solid fa-screwdriver-wrench"></i> ä¿®ç†å±¥æ­´ã®ç™»éŒ²
      </div>

      <!-- è«‹æ±‚æ›¸ã®èª­ã¿å–ã‚Š -->
      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">è«‹æ±‚æ›¸ãƒ»é ˜åæ›¸ã®æ’®å½±</label>

        <input type="file" id="invoiceImage" accept="image/*" capture="environment" class="hidden"
          onchange="previewInvoice(this)">

        <button onclick="document.getElementById('invoiceImage').click()"
          class="w-full py-4 border-2 border-dashed border-[#6b8f71] rounded-lg text-[#6b8f71] flex flex-col items-center gap-2 hover:bg-[#f0f7f1] transition-colors">
          <i class="fa-solid fa-camera text-2xl"></i>
          <span class="text-sm font-bold">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹• / ç”»åƒã‚’é¸æŠ</span>
        </button>

        <div id="invoicePreviewArea" class="mt-4 hidden text-center">
          <img id="invoicePreviewImg" src="" class="w-full rounded-lg shadow-md mb-2 opacity-50">
          <p class="text-[10px] text-gray-500">è§£æç”¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆç”»åƒã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ï¼‰</p>
        </div>
      </div>

      <!-- è‡ªå‹•å…¥åŠ›ã•ã‚Œã‚‹é …ç›® -->
      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">å¯¾è±¡ã®æ©Ÿæ¢°</label>
        <select id="repairMachineSelect" class="w-full p-3 rounded-lg border bg-white">
        </select>
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">ä¿®ç†æ—¥</label>
        <input type="date" id="repairDate" class="w-full p-3 rounded-lg">
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">åº—èˆ—å</label>
        <input type="text" id="repairShop" class="w-full p-3 rounded-lg">
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">é‡‘é¡</label>
        <input type="number" id="repairCost" class="w-full p-3 rounded-lg">
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">ãƒ¡ãƒ¢</label>
        <textarea id="repairMemo" class="w-full p-3 rounded-lg" rows="3"></textarea>
      </div>

      <button id="saveRepairBtn" class="btn-main" onclick="saveRepairLog()">ä¿®ç†å±¥æ­´ã‚’ä¿å­˜</button>
      <button onclick="switchView('repairView'); loadRepairDashboard();" class="btn-sub mt-4 w-full">ä¿®ç†å±¥æ­´ã¸æˆ»ã‚‹</button>

    </div>

    <div id="maintenanceDetailView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">

      <!-- ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆæ©Ÿæ¢°åã¯ JS ã§å·®ã—æ›¿ãˆã‚‹ï¼‰ -->
      <div class="flex items-center gap-2 mb-4 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-2 text-lg">
        <i class="fa-solid fa-tractor"></i>
        <span id="maintenanceMachineName">æ©Ÿæ¢°å</span>
      </div>

      <div class="card mb-4">
        <p class="font-bold text-sm text-gray-500 mb-2">ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹é€²æ—</p>
        <div id="maintenanceSummary" class="text-xs mt-1">
          æœªç€æ‰‹
        </div>
      </div>

      <div class="card mb-4">
        <p class="font-bold text-sm text-gray-500 mb-2">ç‚¹æ¤œé …ç›®</p>
        <div id="maintenanceChecklist" class="space-y-2">
        </div>
      </div>

      <!-- ä½œæ¥­å±¥æ­´ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ -->
      <div class="card mb-4">
        <p class="font-bold text-sm text-gray-500 mb-2">ä½œæ¥­å±¥æ­´</p>
        <div id="maintenanceHistoryLog" class="space-y-3 text-sm">
          <p class="italic text-gray-400 text-center py-4">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>
        </div>
      </div>

      <div class="card mb-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
        <p class="font-bold text-sm text-[#6b8f71] mb-4 flex items-center">
          <i class="fas fa-tools mr-2"></i>éƒ¨å“äº¤æ›ã‚’è¨˜éŒ²
        </p>

        <label class="block text-xs font-bold text-gray-400 mb-1">äº¤æ›éƒ¨å“ãƒ»é …ç›®å</label>
        <input id="newMaintenanceItem" type="text"
          class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#6b8f71] outline-none"
          placeholder="ä¾‹ï¼šã‚ªã‚¤ãƒ«ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆ">

        <label class="block text-xs font-bold text-gray-400 mb-1">æ‹…å½“è€…</label>
        <select id="newMaintenanceOperator"
          class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#6b8f71] outline-none">
          <option value="">æ‹…å½“è€…ã‚’é¸æŠ</option>
        </select>

        <label class="block text-xs font-bold text-gray-400 mb-1">çŠ¶æ…‹</label>
        <select id="newMaintenanceStatus"
          class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#6b8f71] outline-none">
          <option value="done">å®Œäº†</option>
          <option value="progress">ä½œæ¥­ä¸­</option>
        </select>

        <label class="block text-xs font-bold text-gray-400 mb-1">ãƒ¡ãƒ¢</label>
        <textarea id="newMaintenanceMemo" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-4" rows="2"
          placeholder="å‚™è€ƒ"></textarea>

        <button onclick="saveMaintenanceRecord()"
          class="btn-main w-full py-3 bg-[#6b8f71] text-white rounded-lg font-bold hover:bg-[#5a7a5f] transition-all shadow-md">
          éƒ¨å“äº¤æ›ã‚’ä¿å­˜ã™ã‚‹
        </button>
      </div>

      <div class="flex justify-center w-full mt-6 mb-8">
        <button onclick="switchView('maintenanceMachineListView')"
          class="bg-gray-500 text-white px-6 py-2.5 rounded-lg hover:bg-gray-600 transition-colors whitespace-nowrap text-[13px] sm:text-sm shadow-md flex items-center justify-center">
          <i class="fas fa-arrow-left mr-2"></i>
          <span>æ©Ÿæ¢°ä¸€è¦§ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</span>
        </button>
      </div>
    </div>

    <div id="versionView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-10">
      <div class="flex items-center gap-2 mb-4 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-2 text-lg">
        <i class="fa-solid fa-code-branch"></i> ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±
      </div>

      <div class="card text-sm leading-relaxed space-y-3">
        <p><span class="font-bold">ãƒãƒ¼ã‚¸ãƒ§ãƒ³:</span> 1.0.0</p>
        <p><span class="font-bold">æœ€çµ‚æ›´æ–°æ—¥:</span> 2026-01-19</p>

        <div>
          <p class="font-bold text-[#6b8f71] mb-1">æ›´æ–°å†…å®¹</p>
          <ul class="list-disc pl-5 space-y-1">
            <li>åˆæœŸãƒªãƒªãƒ¼ã‚¹</li>
          </ul>
        </div>

        <div>
          <p class="font-bold text-[#6b8f71] mb-1">ä½¿ç”¨æŠ€è¡“</p>
          <ul class="list-disc pl-5 space-y-1">
            <li>HTML / CSS / JavaScript</li>
            <li>Tailwind CSS</li>
            <li>Supabase</li>
            <li>Chart.js</li>
            <li>GitHub Pages</li>
          </ul>
        </div>
      </div>

      <button onclick="switchView('inputView')" class="btn-sub mt-6">TOPã«æˆ»ã‚‹</button>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const SUPABASE_URL = "https://txsqxnwgolybcdclazdx.supabase.co";
    const SUPABASE_KEY = "sb_publishable_8JEM6Yyg5_oQpF-grdaxIw_rrxZBQYj";
    const GOOGLE_VISION_API_KEY = 'AIzaSyCdX_rYEeovClhxRAwAOhPxG4CPTX6fqlg';
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let allMachines = []; let currentMachineId = 'all'; window.charts = {};

    window.drawCharts = function (data) {
      console.log("ğŸ“Š å…¨ã‚«ãƒ©ãƒ ã®ã‚°ãƒ©ãƒ•ã‚’æœ€é©åŒ–ã—ã¾ã™");
      if (typeof Chart === 'undefined') return;

      if (window.charts) {
        Object.values(window.charts).forEach(c => c && typeof c.destroy === 'function' && c.destroy());
      }
      window.charts = {};

      // ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ
      const stats = { cat: {}, op: {}, task: {}, time: new Array(12).fill(0) };
      let totalH = 0;
      data.forEach(d => {
        const h = Math.max(0, (parseFloat(d.end_hour) || 0) - (parseFloat(d.start_hour) || 0));
        totalH += h;
        stats.cat[d.category || "ãã®ä»–"] = (stats.cat[d.category || "ãã®ä»–"] || 0) + h;
        stats.op[d.operator || "ä¸æ˜"] = (stats.op[d.operator || "ä¸æ˜"] || 0) + h;
        stats.task[d.task || "ãã®ä»–"] = (stats.task[d.task || "ãã®ä»–"] || 0) + h;
        if (d.date) {
          const m = new Date(d.date).getMonth();
          stats.time[m] += h;
        }
      });

      const colors = ['#6b8f71', '#9eb3a2', '#d1dbd3', '#3a4d3f', '#b5c9b8'];

      // --- ã€å·¦ã€‘ä¸Šæ®µï¼šæ©Ÿæ¢°åˆ¥ä¿®ç†ã‚³ã‚¹ãƒˆ (é‡‘é¡é †ã«ã‚½ãƒ¼ãƒˆ & ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³) ---
      const ctxRepair = document.getElementById('categoryShareChart');
      if (ctxRepair) {
        // 1. ãƒ‡ãƒ¼ã‚¿ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—ã«ã™ã‚‹
        const rawData = [
          { label: 'SL54', value: 80000 },
          { label: 'YT333', value: 30000 },
          { label: 'TJV95', value: 7000 },
          { label: 'SL60', value: 20000 },
          { label: 'MZ70', value: 4000 }
        ];

        // 2. é‡‘é¡ãŒé«˜ã„é †ã«ä¸¦ã¹æ›¿ãˆã‚‹ (é™é †)
        rawData.sort((a, b) => b.value - a.value);

        // 3. ã‚°ãƒ©ãƒ•ç”¨ã«ãƒ©ãƒ™ãƒ«ã¨æ•°å€¤ã‚’åˆ‡ã‚Šåˆ†ã‘ã‚‹
        const sortedLabels = rawData.map(d => d.label);
        const sortedValues = rawData.map(d => d.value);

        // 4. ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è‰²ã®è¨ˆç®—
        const maxVal = sortedValues[0];
        const backgroundColors = sortedValues.map(val => {
          const opacity = 0.3 + (val / maxVal) * 0.7;
          return `rgba(139, 0, 0, ${opacity})`;
        });

        window.charts.c1 = new Chart(ctxRepair, {
          type: 'bar',
          data: {
            labels: sortedLabels,
            datasets: [{
              label: 'ã‚³ã‚¹ãƒˆ',
              data: sortedValues,
              backgroundColor: backgroundColors,
              borderRadius: 4,
              barThickness: 15
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { display: false },
              y: {
                grid: { display: false },
                ticks: { font: { size: 11, weight: 'bold' } }
              }
            },
            plugins: { legend: { display: false } }
          }
        });
      }

      // --- ã€å·¦ã€‘ä¸‹æ®µï¼šä½œç‰©æ¯”ç‡ (ãƒ‰ãƒ¼ãƒŠãƒ„) ---
      const ctxCrop = document.getElementById('taskShareChart');
      if (ctxCrop) {
        window.charts.c2 = new Chart(ctxCrop, {
          type: 'doughnut',
          data: { labels: Object.keys(stats.cat), datasets: [{ data: Object.values(stats.cat), backgroundColor: colors }] },
          options: {
            cutout: '45%', // ğŸ”¥ 70%â†’45%ã«ä¸‹ã’ã‚‹ã“ã¨ã§ã€Œè‚‰åšã€ãªãƒ‰ãƒ¼ãƒŠãƒ„ã«ãªã‚Šã¾ã™
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } }
          }
        });
      }

      // --- ã€ä¸­å¤®ã€‘ä¸Šæ®µï¼šæœˆåˆ¥ç¨¼åƒæ¨ç§» (ä»¥å‰ã®æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•) ---
      const ctxLine = document.getElementById('detailChart');
      if (ctxLine) {
        window.charts.line = new Chart(ctxLine, {
          type: 'line',
          data: {
            labels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'],
            datasets: [{ label: 'h', data: stats.time, borderColor: '#6b8f71', backgroundColor: 'rgba(107,143,113,0.1)', fill: true, tension: 0.4 }]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
      }

      // --- ã€ä¸­å¤®ã€‘ä¸‹æ®µï¼šä½œæ¥­å†…å®¹åˆ†æ (ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ£’ã‚°ãƒ©ãƒ•) ---
      const ctxBar = document.getElementById('gradientBarChart');
      if (ctxBar) {
        const sorted = Object.entries(stats.task).sort((a, b) => b[1] - a[1]);
        window.charts.bar = new Chart(ctxBar, {
          type: 'bar',
          data: {
            labels: sorted.map(t => t[0]),
            datasets: [{
              label: 'h',
              data: sorted.map(t => t[1]),
              backgroundColor: sorted.map((_, i) => `rgba(107, 143, 113, ${Math.max(0.2, 1 - (i / 5))})`),
              borderRadius: 4
            }]
          },
          options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
      }

      // --- ã€å³ã€‘ä¸Šæ®µï¼šå‰å¹´å®Ÿç¸¾æ¯” (åŠå††ã‚²ãƒ¼ã‚¸) ---
      const ctxGauge = document.getElementById('yearComparisonGauge');
      if (ctxGauge) {
        const ratio = Math.min(100, (totalH / 500) * 100);
        window.charts.gauge = new Chart(ctxGauge, {
          type: 'doughnut',
          data: { datasets: [{ data: [ratio, 100 - ratio], backgroundColor: ['#6b8f71', '#eee'], borderWidth: 0 }] },
          options: { rotation: -90, circumference: 180, cutout: '75%', maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
        const valEl = document.getElementById("detailCompareValue");
        if (valEl) valEl.innerText = ratio.toFixed(1) + "%";
      }

      // --- ã€å³ã€‘ä¸‹æ®µï¼šæ‹…å½“è€…æ¯”ç‡ (ãƒ‰ãƒ¼ãƒŠãƒ„) ---
      const ctxOp = document.getElementById('operatorShareChart');
      if (ctxOp) {
        window.charts.c4 = new Chart(ctxOp, {
          type: 'doughnut',
          data: { labels: Object.keys(stats.op), datasets: [{ data: Object.values(stats.op), backgroundColor: colors }] },
          options: { cutout: '45%', responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } } }
        });
      }
    };

    function openMenu() { document.getElementById("sideMenu").style.left = "0px"; document.getElementById("overlay").style.display = "block"; }
    function closeMenu() { document.getElementById("sideMenu").style.left = "-280px"; document.getElementById("overlay").style.display = "none"; }

    function showModal(title, message, onOk) {
      const modal = document.getElementById("customModal");
      document.getElementById("modalTitle").innerText = title;
      document.getElementById("modalMessage").innerText = message;
      const okBtn = document.getElementById("modalOkBtn");
      okBtn.onclick = () => { closeModal(); if (onOk) onOk(); };
      modal.classList.add("active");
    }
    function closeModal() { document.getElementById("customModal").classList.remove("active"); }

    function switchView(id) {
      console.log("Switching to:", id);

      // å…¨ã¦ã®ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰activeã‚’å–ã‚Šé™¤ã
      document.querySelectorAll('.view').forEach(v => {
        v.classList.remove('active');
        v.style.display = 'none';
      });

      // å¯¾è±¡ã®ãƒ“ãƒ¥ãƒ¼ã‚’å–å¾—
      const targetView = document.getElementById(id);
      if (targetView) {
        targetView.classList.add('active');
        targetView.style.display = 'block';
      } else {
        console.error("ã‚¨ãƒ©ãƒ¼: ID '" + id + "' ã®ãƒ“ãƒ¥ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
      }

      // ãƒ˜ãƒƒãƒ€ãƒ¼ã®åˆ¶å¾¡
      const header = document.getElementById("pageHeader");
      if (header) {
        header.style.display = (id === 'dashboard') ? 'none' : 'flex';
      }

      closeMenu();

      // å„ãƒšãƒ¼ã‚¸ã”ã¨ã®èª­ã¿è¾¼ã¿å‡¦ç†
      if (id === 'dashboard') {
        setTimeout(() => renderDashboard('all'), 100);
      }
      if (id === 'todayView') {
        console.log("æœ¬æ—¥ãƒ­ã‚°èª­è¾¼å®Ÿè¡Œ");
        loadLogs("todayLogList", true);
      }
      if (id === 'historyView') {
        console.log("å±¥æ­´ãƒ­ã‚°èª­è¾¼å®Ÿè¡Œ");
        loadLogs("historyLogList", false);
      }
      if (id === 'repairView') {
        loadRepairDashboard();
      }
      if (id === 'maintenanceMachineListView') {
        loadMachineList();
      }
      if (id === 'maintenanceView') {
        console.log("ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹çŠ¶æ…‹ã‚’å¾©å…ƒä¸­...");
        restoreMaintenanceChecks();
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      // 1. æ©Ÿæ¢°ï¼ˆãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ã®ã¿ï¼‰ã®å–å¾—
      const { data: machines } = await client
        .from("machines")
        .select("*")
        .eq("machine_type", "tractor")
        .order("name");

      allMachines = machines || [];

      // 2. ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã®å–å¾—
      const { data: operators } = await client
        .from("operators")
        .select("*")
        .order("id");

      // 3. ä½œæ¥­å†…å®¹ã®å–å¾—
      const { data: workTypes } = await client
        .from("work_types")
        .select("*")
        .order("id");

      // --- å„ç”»é¢è¦ç´ ã¸ã®åæ˜  ---

      // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®æ©Ÿæ¢°é¸æŠ
      const machineSelect = document.getElementById("machineSelect");
      if (machineSelect) {
        machineSelect.innerHTML = '<option value="">é¸æŠ</option>' +
          allMachines.map(m => `<option value="${m.id}">${m.name}</option>`).join("");
      }

      // æ¤œç´¢æ¡ä»¶ã®æ©Ÿæ¢°é¸æŠ
      const filterMachine = document.getElementById("filterMachine");
      if (filterMachine) {
        filterMachine.innerHTML = '<option value="">ã™ã¹ã¦ã®æ©Ÿæ¢°</option>' +
          allMachines.map(m => `<option value="${m.id}">${m.name}</option>`).join("");
      }

      // 4. ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼é¸æŠã®åæ˜ 
      const operatorSelect = document.getElementById("operatorSelect");
      if (operatorSelect) {
        operatorSelect.innerHTML = '<option value="">é¸æŠ</option>' +
          (operators || []).map(o => `<option value="${o.name}">${o.name}</option>`).join("");
      }

      // 5. ä½œæ¥­ç¨®åˆ¥é¸æŠã®åæ˜ 
      const workTypeSelect = document.getElementById("workTypeSelect");
      if (workTypeSelect) {
        workTypeSelect.innerHTML = '<option value="">é¸æŠ</option>' +
          (workTypes || []).map(w => `<option value="${w.name}">${w.name}</option>`).join("");
      }

      // æœ€å¾Œã«ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã™ã‚‹ï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ã«ã„ã‚‹å ´åˆã®ã¿ï¼‰
      if (typeof renderDashboard === 'function') {
        renderDashboard('all');
      }

      // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®æ©Ÿæ¢°åˆ¥ã‚¿ãƒ–
      const machineTabs = document.getElementById("machineTabs");
      if (machineTabs) {
        // ä»Šé¸ã°ã‚Œã¦ã„ã‚‹IDã‚’ç¢ºå®Ÿã«å–å¾—ï¼ˆé–¢æ•°ã®å¼•æ•° machineId ã‚’ä½¿ç”¨ï¼‰
        const currentId = 'all';

        // 1. ã€Œå…¨ä½“ã€ãƒœã‚¿ãƒ³
        const allBtnClass = (currentId === 'all') ? 'active' : 'inactive';
        let tabsHTML = `
          <button onclick="renderDashboard('all')" 
                  id="tab-all" 
                  class="tab-btn ${allBtnClass}" 
                  style="min-width: 80px; letter-spacing: 0.2em;">å…¨ ä½“</button>
        `;

        // 2. å„æ©Ÿæ¢°ã®ãƒœã‚¿ãƒ³ï¼ˆallMachines.mapï¼‰
        if (typeof allMachines !== 'undefined' && allMachines.length > 0) {
          tabsHTML += allMachines.map(m => {
            // IDã‚’æ¯”è¼ƒã—ã¦ active ã‹ inactive ã‹æ±ºã‚ã‚‹
            const isActive = (String(m.id) === String(currentId)) ? 'active' : 'inactive';
            return `
              <button onclick="renderDashboard(${m.id})" 
                      id="tab-${m.id}" 
                      class="tab-btn ${isActive}">${m.name}</button>
            `;
          }).join("");
        }

        machineTabs.innerHTML = tabsHTML;
      }

      // ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼é¸æŠã®åæ˜ ï¼ˆæ¤œç´¢ã¨å…¥åŠ›ä¸¡æ–¹ï¼‰
      if (operators) {
        const opList = operators.map(o => `<option value="${o.name}">${o.name}</option>`).join("");
        const fOp = document.getElementById("filterOperator");
        if (fOp) fOp.innerHTML = '<option value="">å…¨ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼</option>' + opList;

        const iOp = document.getElementById("operator");
        if (iOp) iOp.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' + opList;
      }

      // ä½œæ¥­å†…å®¹ã®åæ˜ ï¼ˆé€£å‹•ãƒ­ã‚¸ãƒƒã‚¯å«ã‚€ï¼‰
      if (workTypes) {
        // æ¤œç´¢æ¡ä»¶å´
        const fCat = document.getElementById("filterCategory");
        if (fCat) {
          fCat.innerHTML = '<option value="">å…¨ä½œæ¥­å†…å®¹</option>' +
            workTypes.map(w => `<option value="${w.work_name || w.category}">${w.work_name || w.category}</option>`).join("");
        }

        // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ å´ï¼ˆç¨®åˆ¥ï¼‰
        const iCat = document.getElementById("category");
        if (iCat) {
          const categories = [...new Set(workTypes.map(w => w.category))];
          iCat.innerHTML = '<option value="">ç¨®åˆ¥ã‚’é¸æŠ</option>' +
            categories.map(c => `<option value="${c}">${c}</option>`).join("");

          // ç¨®åˆ¥ã‚’é¸ã‚“ã ã‚‰ä½œæ¥­å†…å®¹ã‚’å‡ºã™é€£å‹•è¨­å®š
          iCat.onchange = () => {
            const selected = iCat.value;
            const iWork = document.getElementById("work_name");
            if (iWork) {
              const filtered = workTypes.filter(t => t.category === selected);
              iWork.innerHTML = '<option value="">ä½œæ¥­å†…å®¹ã‚’é¸æŠ</option>' +
                filtered.map(t => `<option value="${t.work_name}">${t.work_name}</option>`).join("");
            }
          };
        }
      }

      // æ—¥ä»˜ã®åˆæœŸ
      const today = new Date().toISOString().split('T')[0];
      if (document.getElementById("workDate")) {
        document.getElementById("workDate").value = today;
      }
      if (document.getElementById("filterMonth")) {
        document.getElementById("filterMonth").value = today.substring(0, 7);
      }

      // å®‰å…¨ã®ãŸã‚ã€æ©Ÿæ¢°é¸æŠã« change ãƒªã‚¹ãƒŠã‚’ç¢ºå®Ÿã«è¿½åŠ 
      const msEl = document.getElementById('machineSelect');
      if (msEl && !msEl.onchange) msEl.addEventListener('change', autoFillHour);

      console.log("å…¨ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ã¨æ—¥ä»˜ã‚»ãƒƒãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ");
    });

    // ä¿®ç†å±¥æ­´ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚€
    async function loadRepairDashboard() {
      try {
        // repair_logs ã‚’ã™ã¹ã¦å–å¾—
        const { data: logs, error } = await client
          .from('repair_logs')
          .select('*')
          .order('date', { ascending: false });

        if (error) {
          console.error('Error loading repair logs:', error);
          return;
        }

        // -----------------------------
        // â‘  ç´¯è¨ˆä¿®ç†è²»
        // -----------------------------
        const totalCost = logs.reduce((sum, log) => sum + (log.cost || 0), 0);
        document.getElementById('totalRepairCost').textContent =
          'Â¥ ' + totalCost.toLocaleString();

        // -----------------------------
        // â‘¡ å¹´ã”ã¨ã®ä¿®ç†è²»
        // -----------------------------
        const yearly = {};
        logs.forEach(log => {
          const year = new Date(log.date).getFullYear();
          if (!yearly[year]) yearly[year] = 0;
          yearly[year] += log.cost || 0;
        });

        const yearlyContainer = document.getElementById('yearlyRepairContainer');
        yearlyContainer.innerHTML = '';

        Object.keys(yearly)
          .sort((a, b) => b - a)
          .forEach(year => {
            const card = document.createElement('div');
            card.className =
              'p-3 bg-white rounded-md shadow text-center border border-gray-100';
            card.innerHTML = `
          <div class="text-sm text-gray-500">${year}å¹´</div>
          <div class="text-lg font-bold text-[#6b8f71]">Â¥ ${yearly[year].toLocaleString()}</div>
        `;
            yearlyContainer.appendChild(card);
          });

        // -----------------------------
        // â‘¢ æ©Ÿæ¢°ã”ã¨ã®ä¿®ç†è²»
        // -----------------------------
        const machineTotals = {};

        logs.forEach(log => {
          if (!machineTotals[log.machine_id]) machineTotals[log.machine_id] = 0;
          machineTotals[log.machine_id] += log.cost || 0;
        });

        // machines ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰åå‰ã‚’å–å¾—
        const { data: machines } = await client.from('machines').select('*');

        const machineContainer = document.getElementById('machineRepairContainer');
        machineContainer.innerHTML = '';

        Object.keys(machineTotals).forEach(machineId => {
          const machine = machines.find(m => m.id === Number(machineId));
          const name = machine ? machine.name : 'ä¸æ˜ãªæ©Ÿæ¢°';

          const card = document.createElement('div');
          card.className =
            'p-3 bg-white rounded-md shadow text-center border border-gray-100';
          card.innerHTML = `
        <div class="text-sm text-gray-500">${name}</div>
        <div class="text-lg font-bold text-[#6b8f71]">Â¥ ${machineTotals[machineId].toLocaleString()}</div>
      `;
          machineContainer.appendChild(card);
        });

        // -----------------------------
        // â‘£ æœ€è¿‘ã®ä¿®ç†å±¥æ­´ï¼ˆæœ€æ–°5ä»¶ï¼‰
        // -----------------------------
        const recentContainer = document.getElementById('recentRepairContainer');
        recentContainer.innerHTML = '';

        logs.slice(0, 5).forEach(log => {
          const item = document.createElement('div');
          item.className =
            'p-3 bg-white rounded-md shadow border border-gray-100';

          item.innerHTML = `
        <div class="text-sm text-gray-500">${log.date}</div>
        <div class="font-bold">${log.memo || '(å†…å®¹ãªã—)'}</div>
        <div class="text-[#6b8f71] font-bold mt-1">Â¥ ${log.cost.toLocaleString()}</div>
        <div class="text-xs text-gray-400 mt-1">${log.shop || ''}</div>
      `;

          recentContainer.appendChild(item);
        });

      } catch (err) {
        console.error('Unexpected error:', err);
      }
    }

    async function autoFillHour() {
      const mId = document.getElementById("machineSelect").value;
      if (!mId) return;
      const { data } = await client.from("hour_logs").select("end_hour").eq("machine_id", mId).order("date", { ascending: false }).order("created_at", { ascending: false }).limit(1);
      if (data && data.length > 0) { document.getElementById("hourBefore").value = data[0].end_hour; calcDiff(); }
    }

    function calcDiff() {
      const b = parseFloat(document.getElementById("hourBefore").value) || 0;
      const a = parseFloat(document.getElementById("hourAfter").value) || 0;
      const d = a - b;
      const disp = document.getElementById("hourDiffDisplay");

      // â‘  ç¨¼åƒå¾Œã®ã»ã†ãŒå°ã•ã„å ´åˆã«æ–‡å­—ã‚’èµ¤ãã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
      if (a > 0 && a < b) {
        disp.classList.remove("text-[#6b8f71]");
        disp.classList.add("text-red-500");
        disp.textContent = `ç¨¼åƒæ™‚é–“: 0.0 h (å…¥åŠ›ã‚¨ãƒ©ãƒ¼)`;
      } else {
        disp.classList.remove("text-red-500");
        disp.classList.add("text-[#6b8f71]");
        disp.textContent = `ç¨¼åƒæ™‚é–“: ${d > 0 ? d.toFixed(1) : "0.0"} h`;
      }
    }

    async function previewInvoice(input) {
      const file = input.files[0];
      if (!file) return;

      const previewImg = document.getElementById('invoicePreviewImg');
      const previewArea = document.getElementById('invoicePreviewArea');
      const saveBtn = document.getElementById('saveRepairBtn');

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
      previewImg.src = URL.createObjectURL(file);
      previewArea.classList.remove('hidden');

      const memoField = document.getElementById('repairMemo');
      memoField.value = "ğŸ“„ Google AIãŒè§£æä¸­... â³";
      if (saveBtn) saveBtn.disabled = true; // è§£æä¸­ã¯äºŒé‡æŠ¼ã—é˜²æ­¢ã§ç„¡åŠ¹åŒ–

      try {
        const base64Image = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.readAsDataURL(file);
        });

        const url = `https://vision.googleapis.com/v1/images:annotate?key=${GOOGLE_VISION_API_KEY}`;
        const response = await fetch(url, {
          method: "POST",
          body: JSON.stringify({
            requests: [{ image: { content: base64Image }, features: [{ type: "TEXT_DETECTION" }] }]
          })
        });
        const result = await response.json();

        const fullText = result.responses[0]?.textAnnotations[0]?.description || "";

        // --- æŠ½å‡ºå‡¦ç† ---
        const cleanText = fullText.replace(/\s/g, '');
        const costMatch = cleanText.match(/(?:é‡‘é¡|åˆè¨ˆ|ç¨è¾¼|ï¿¥|Â¥|è«‹æ±‚é¡)[:ï¼š]?([0-9,]{3,})/);
        if (costMatch) document.getElementById('repairCost').value = costMatch[1].replace(/,/g, '');

        const dateMatch = cleanText.match(/(\d{4})[å¹´\/-](\d{1,2})[æœˆ\/-](\d{1,2})/);
        if (dateMatch) {
          document.getElementById('repairDate').value = `${dateMatch[1]}-${dateMatch[2].padStart(2, '0')}-${dateMatch[3].padStart(2, '0')}`;
        }

        // âœ¨ è§£æãŒçµ‚ã‚ã£ãŸã‚‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ¶ˆã™
        previewArea.classList.add('hidden');
        previewImg.src = "";
        memoField.value = "è§£æå®Œäº†: " + fullText.substring(0, 50) + "..."; // å†’é ­ã ã‘ãƒ¡ãƒ¢ã«æ®‹ã™

        alert("è§£æå®Œäº†ï¼å†…å®¹ã‚’ç¢ºèªã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");

      } catch (error) {
        console.error("OCR Error:", error);
        memoField.value = "âŒ è§£æã‚¨ãƒ©ãƒ¼";
      } finally {
        if (saveBtn) saveBtn.disabled = false; // ã‚¨ãƒ©ãƒ¼ã§ã‚‚æˆåŠŸã§ã‚‚ãƒœã‚¿ãƒ³ã‚’å¾©æ´»ã•ã›ã‚‹
      }
    }

    async function saveRepairLog() {
      console.log("ä¿å­˜å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...");

      // 1. ç”»é¢ã‹ã‚‰å…¥åŠ›å€¤ã‚’å–å¾—
      const dateValue = document.getElementById('repairDate').value;
      const shopValue = document.getElementById('repairShop').value;
      const costValue = document.getElementById('repairCost').value;
      const memoValue = document.getElementById('repairMemo').value;
      const machineId = document.getElementById('repairMachineSelect').value;

      // 2. å¿…é ˆãƒã‚§ãƒƒã‚¯
      if (!dateValue || !costValue) {
        alert("ã€Œä¿®ç†æ—¥ã€ã¨ã€Œé‡‘é¡ã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const btn = document.getElementById('saveRepairBtn');
      btn.disabled = true;
      btn.innerText = "ä¿å­˜ä¸­...";

      try {
        // 3. Supabaseã¸ä¿å­˜
        const { error } = await client
          .from('repair_logs')
          .insert([
            {
              date: dateValue,
              shop: shopValue,
              cost: parseInt(costValue),
              memo: memoValue,
              machine_id: machineId || null // IDãŒç©ºã§ã‚‚ä¿å­˜ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
            }
          ]);

        if (error) throw error;

        // --- ã“ã“ã‚’ã‚ªã‚·ãƒ£ãƒ¬ã«æ›¸ãæ›ãˆ ---
        btn.innerText = "ä¿å­˜å®Œäº†ï¼";

        // 1. æˆåŠŸã—ãŸã‚‰ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®æ•°å­—ã‚’å†è¨ˆç®—
        loadRepairDashboard();

        // 2. ãƒ¢ãƒ¼ãƒ€ãƒ«ã§é€šçŸ¥ï¼ˆã‚‚ã—ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒå‹•ããªã‚‰ï¼‰
        if (typeof showCustomModal === 'function') {
          showCustomModal("ä¿å­˜å®Œäº†", "ä¿®ç†å±¥æ­´ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã¾ã™ã€‚");
        } else {
          alert("ä¿å­˜å®Œäº†ã—ã¾ã—ãŸï¼ğŸšœğŸŒ¾");
        }

        // 3. è‡ªå‹•çš„ã«å±¥æ­´ãƒˆãƒƒãƒ—ç”»é¢ã«æˆ»ã™
        setTimeout(() => {
          switchView('repairView');
          btn.disabled = false;
          btn.innerText = "ä¿®ç†å±¥æ­´ã‚’ä¿å­˜";
        }, 1500);

      } catch (err) {
        console.error("âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:", err);
        alert("ã‚¨ãƒ©ãƒ¼ã§ä¿å­˜ã§ãã¾ã›ã‚“ã§ã—ãŸ: " + err.message);
        btn.disabled = false;
        btn.innerText = "ä¿®ç†å±¥æ­´ã‚’ä¿å­˜";
      }
    }

    function prepareMachineSelect() {
      const select = document.getElementById('repairMachineSelect');
      if (!select) return;

      select.innerHTML = '';

      if (allMachines && allMachines.length > 0) {
        allMachines.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.id;
          opt.textContent = m.name;
          select.appendChild(opt);
        });
      } else {
        const opt = document.createElement('option');
        opt.textContent = "æ©Ÿæ¢°ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“";
        select.appendChild(opt);
      }
    }

    function goToRepairRegistration() {
      prepareMachineSelect(); // ãƒªã‚¹ãƒˆã‚’ä½œæˆ
      switchView('invoiceOCRView'); // ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆ
    }

    async function loadLogs(elId, todayOnly) {
      const list = document.getElementById(elId);
      list.innerHTML = "<p class='text-center py-10 opacity-50 text-xs'>èª­è¾¼ä¸­...</p>";

      // åŸºæœ¬ã®ã‚¯ã‚¨ãƒªä½œæˆ
      let query = client.from("hour_logs").select("*, machines(name)").order("date", { ascending: false });

      if (todayOnly) {
        // ã€æœ¬æ—¥ã®ç¨¼åƒçŠ¶æ³ã€‘æ—¥æœ¬æ™‚é–“ï¼ˆJSTï¼‰ã®ä»Šæ—¥ã®æ—¥ä»˜ã§çµã‚Šè¾¼ã¿
        const jstToday = new Date().toLocaleDateString('sv-SE');
        query = query.eq("date", jstToday);
      } else {

        // ã€ç¨¼åƒå±¥æ­´ã€‘ç”»é¢ã®å…¥åŠ›å€¤ã‚’å–å¾—ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‹ã‘ã‚‹
        const month = document.getElementById("filterMonth").value; // YYYY-MM
        const machine = document.getElementById("filterMachine").value;
        const operator = document.getElementById("filterOperator").value;
        const category = document.getElementById("filterCategory").value;

        // æœˆã§çµã‚Šè¾¼ã¿ (å‰æ–¹ä¸€è‡´)
        if (month) query = query.gte("date", `${month}-01`).lte("date", `${month}-31`);
        // æ©Ÿæ¢°ã§çµã‚Šè¾¼ã¿
        if (machine) query = query.eq("machine_id", machine);
        // ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã§çµã‚Šè¾¼ã¿
        if (operator) query = query.eq("operator", operator);
        // ç¨®åˆ¥ï¼ˆæ°´ç¨²ãƒ»ãã°ç­‰ï¼‰ã§çµã‚Šè¾¼ã¿
        if (category) query = query.eq("category", category);
      }

      const { data, error } = await query;
      if (error) {
        console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
        return;
      }

      let total = 0;
      const displayData = todayOnly ? [...(data || [])].reverse() : (data || []);

      list.innerHTML = displayData.map(l => {
        const diff = (l.end_hour - l.start_hour);
        total += diff;
        return `<div class="card border-l-4 border-[#6b8f71] !mb-3 !py-3 flex justify-between items-center">
              <div>
                <b class="text-sm">${l.date} - ${l.machines?.name}</b>
                <p class="text-xs opacity-70 mt-1">${l.operator} | ${l.task}</p>
                <div class="flex gap-4 mt-2">
                  <span class="text-[11px] font-bold log-badge px-2 py-1 rounded"><i class="fa-solid fa-clock mr-1 text-[#6b8f71]"></i>${diff.toFixed(1)} h</span>
                  <span class="text-[11px] font-bold log-badge px-2 py-1 rounded"><i class="fa-solid fa-gas-pump mr-1 text-[#6b8f71]"></i>${l.fuel_amount || 0} L</span>
                </div>
              </div>
              <button onclick="deleteLog(${l.id})" class="text-gray-400 p-2 hover:text-red-500 transition-colors">
                <i class="fa-regular fa-trash-can text-lg"></i>
              </button>
            </div>`;
      }).join("");

      if (!todayOnly) {
        const totalEl = document.getElementById("historyTotalHours");
        if (totalEl) totalEl.innerText = `åˆè¨ˆ: ${total.toFixed(1)} h`;
      }
    }

    async function deleteLog(id) {
      showModal("å‰Šé™¤ç¢ºèª", "ã“ã®ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ", async () => {
        const { error } = await client.from("hour_logs").delete().eq("id", id);
        if (!error) {
          if (document.getElementById("todayView").classList.contains("active")) loadLogs("todayLogList", true);
          else loadLogs("historyLogList", false);
        }
      });
    }

    // ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹å±¥æ­´ã‚’DBã‹ã‚‰å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹é–¢æ•°
    async function loadMaintenanceLogs() {
      const logContainer = document.getElementById('maintenanceLog');
      if (!logContainer) return;

      try {
        // 1. æœ€æ–°ã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹å±¥æ­´ã‚’5ä»¶ã»ã©å–å¾—
        const { data: logs, error } = await client
          .from('maintenance_status') // ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹çŠ¶æ…‹ãƒ†ãƒ¼ãƒ–ãƒ«
          .select('item_id, updated_at, status')
          .eq('status', true)        // å®Œäº†ã—ãŸã‚‚ã®ã ã‘
          .order('updated_at', { ascending: false }) // æ–°ã—ã„é †
          .limit(5);
        if (error) throw error;

        if (logs && logs.length > 0) {
          logContainer.innerHTML = logs.map(log => {
            // item_id ãŒ "tractor1_oil" ã®ã‚ˆã†ãªå½¢å¼ã ã¨ä»®å®šã—ã¦æ•´å½¢
            const [machine, item] = log.item_id.split('_');
            const date = new Date(log.updated_at).toLocaleDateString('ja-JP', {
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit'
            });

            return `
          <div class="flex flex-col border-b border-gray-50 pb-1 mb-1 last:border-0">
            <div class="flex justify-between items-center">
              <span class="font-bold text-gray-700">${machine.toUpperCase()}</span>
              <span class="text-[9px] text-gray-400">${date}</span>
            </div>
            <div class="text-[#6b8f71] flex items-center gap-1">
              <i class="fa-solid fa-check-circle"></i> ${item} å®Œäº†
            </div>
          </div>
        `;
          }).join('');
        } else {
          logContainer.innerHTML = `<p class="italic text-gray-400 text-center py-4">ç›´è¿‘ã®æ•´å‚™å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>`;
        }
      } catch (err) {
        console.error('å±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
        logContainer.innerHTML = `<p class="text-red-400 text-center py-4">ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—</p>`;
      }
    }

    loadMaintenanceLogs();

    // 1. ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸€è¦§ï¼ˆãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ä¸€è¦§ï¼‰ã‚’è¡¨ç¤ºã™ã‚‹
    async function loadMachineList() {
      try {
        const { data: machines, error } = await client
          .from("machines")
          .select("*")
          .eq("machine_type", "tractor")
          .order("id");

        if (error) throw error;

        const container = document.getElementById("maintenanceMachineGrid");
        if (!container) return;
        container.innerHTML = "";

        const grouped = {};
        machines.forEach(m => {
          const manufacturer = m.manufacturer || "ãã®ä»–";
          if (!grouped[manufacturer]) grouped[manufacturer] = [];
          grouped[manufacturer].push(m);
        });

        for (const brand of Object.keys(grouped)) {
          const brandHeader = document.createElement("h3");
          brandHeader.className = "text-[#6b8f71] font-bold text-sm mb-2 mt-4 flex items-center gap-2";
          brandHeader.innerHTML = `<i class="fa-solid fa-tag opacity-50"></i> ${brand}`;
          container.appendChild(brandHeader);

          const grid = document.createElement("div");
          grid.className = "grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-4";

          // å„ãƒã‚·ãƒ³ã®ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
          for (const m of grouped[brand]) {
            const card = document.createElement("div");
            card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-all active:scale-95";
            card.onclick = () => openMaintenanceDetail(m.id);

            card.innerHTML = `
              <div class="flex flex-col gap-2">
                <div class="flex items-center gap-3">
                  <div style="color: #6b8f71;" class="text-xl flex-shrink-0">
                    <i class="fa-solid fa-tractor"></i>
                  </div>
                  <div class="font-bold text-gray-900 text-lg truncate">${m.name}</div>
                </div>
                <div class="border-t border-gray-50 pt-2" id="card-progress-${m.id}">
                  <div class="text-[11px] text-gray-400 flex items-center gap-1">
                    <i class="fa-solid fa-circle-notch fa-spin text-[9px]"></i> ç¢ºèªä¸­...
                  </div>
                </div>
              </div>
            `;
            grid.appendChild(card);

            // é€²æ—çŠ¶æ³ã‚’éåŒæœŸã§å–å¾—ã—ã¦åæ˜ 
            (async () => {
              try {
                const { data: checks } = await client
                  .from('maintenance_status')
                  .select('item_id, status')
                  .filter('item_id', 'ilike', `${m.id}_%`);

                const totalItems = 20;
                const uniqueChecks = {};
                if (checks) {
                  checks.forEach(c => { uniqueChecks[c.item_id] = c.status; });
                }

                const completedCount = Object.values(uniqueChecks).filter(status => status === true || status === "true").length;
                let percent = Math.round((completedCount / totalItems) * 100);
                percent = Math.min(100, percent);

                const progressDiv = document.getElementById(`card-progress-${m.id}`);
                if (progressDiv) {
                  let statusHTML = percent === 0
                    ? `<span class="text-red-600 font-black"><i class="fa-solid fa-circle-exclamation text-[9px]"></i> æœªç€æ‰‹</span>`
                    : percent === 100
                      ? `<span class="text-[#6b8f71] font-black"><i class="fa-solid fa-circle-check text-[9px]"></i> å®Œäº†</span>`
                      : `<span class="text-orange-500 font-black"><i class="fa-solid fa-spinner text-[9px]"></i> ${percent}% å®Œäº†</span>`;

                  progressDiv.innerHTML = `
                    <div class="text-[11px] flex items-center gap-1">${statusHTML}</div>
                    <div class="w-full bg-gray-100 rounded-full h-1 mt-1">
                      <div class="bg-[#6b8f71] h-1 rounded-full transition-all duration-500" style="width: ${percent}%"></div>
                    </div>
                  `;
                }
              } catch (err) { console.error("ã‚«ãƒ¼ãƒ‰é€²æ—æ›´æ–°ã‚¨ãƒ©ãƒ¼:", err); }
            })();
          }
          container.appendChild(grid);
        }
      } catch (e) { console.error("ä¸€è¦§èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e); }
    }
    async function loadMaintenanceLogs() {
      const logContainer = document.getElementById('maintenanceLog');
      if (!logContainer) return;

      try {
        // 1. å…¨ã¦ã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹çŠ¶æ…‹ã‚’å–å¾—
        const { data: allStatus, error: statusError } = await client
          .from('maintenance_status')
          .select('item_id, status, updated_at');

        if (statusError) throw statusError;

        // 2. æ©Ÿæ¢°ã”ã¨ã«ã€Œå…¨é …ç›®æ•°ã€ã¨ã€Œå®Œäº†æ•°ã€ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        const machineProgress = {};
        allStatus.forEach(item => {
          const mId = item.item_id.split('_')[0];
          if (!machineProgress[mId]) {
            machineProgress[mId] = { total: 0, completed: 0, lastUpdate: item.updated_at };
          }
          machineProgress[mId].total++;
          if (item.status) {
            machineProgress[mId].completed++;
            // ä¸€ç•ªæ–°ã—ã„å®Œäº†æ—¥æ™‚ã‚’ä¿æŒ
            if (new Date(item.updated_at) > new Date(machineProgress[mId].lastUpdate)) {
              machineProgress[mId].lastUpdate = item.updated_at;
            }
          }
        });

        // 3. åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
        const finishedMachineIds = Object.keys(machineProgress).filter(mId => {
          const p = machineProgress[mId];
          // 1ã¤ä»¥ä¸Šé …ç›®ãŒã‚ã‚Šã€ã‹ã¤ï¼ˆå®Œäº†æ•° ï¼ é …ç›®æ•°ï¼‰ã§ã‚ã‚‹ã“ã¨
          // ã‹ã¤ã€ç‰¹å®šã®ã€Œå°‘ãªã™ãã‚‹ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰ã€ã‚’é™¤å¤–ã™ã‚‹ãŸã‚ã« 3é …ç›®ä»¥ä¸Š ã¨ã™ã‚‹
          return p.total >= 3 && p.completed === p.total;
        });

        // 4. æ©Ÿæ¢°åã‚’å–å¾—
        const { data: machines, error: mError } = await client
          .from('machines')
          .select('id, name')
          .in('id', finishedMachineIds);

        if (mError) throw mError;

        const machineMap = {};
        machines.forEach(m => { machineMap[m.id.toString()] = m.name; });

        // 5. å®Œäº†ã—ãŸæ©Ÿæ¢°ã‚’æœ€æ–°é †ã«ä¸¦ã¹ã¦è¡¨ç¤º
        const displayData = finishedMachineIds
          .map(mId => ({
            id: mId,
            name: machineMap[mId] || `æ©Ÿæ¢°(ID:${mId})`,
            date: machineProgress[mId].lastUpdate
          }))
          .sort((a, b) => new Date(b.date) - new Date(a.date));

        logContainer.innerHTML = displayData.map(data => {
          const date = new Date(data.date);
          const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;

          return `
        <div class="flex items-center justify-between border-b border-gray-50 py-3 last:border-0">
          <div class="flex flex-col">
            <span class="text-[13px] font-black text-gray-800">${data.name}</span>
            <div class="flex items-center gap-1">
              <span class="w-2 h-2 rounded-full bg-[#6b8f71] flex items-center justify-center">
                <i class="fa-solid fa-check text-[5px] text-white"></i>
              </span>
              <span class="text-[10px] text-[#6b8f71] font-bold tracking-wider">ALL MAINTENANCE COMPLETE</span>
            </div>
          </div>
          <div class="text-right">
            <div class="text-[11px] text-gray-500 font-mono font-bold">${dateStr}</div>
          </div>
        </div>
      `;
        }).join('');

      } catch (err) {
        console.error('å±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
      }
    }

    // 2. è©³ç´°ç”»é¢ã‚’é–‹ã
    async function openMaintenanceDetail(machineId) {
      window.currentMachineId = machineId;
      switchView('maintenanceDetailView');

      try {
        const { data: machine } = await client.from("machines").select("*").eq("id", machineId).single();
        document.getElementById("maintenanceMachineName").textContent = machine.name;

        const { data: operators } = await client.from('operators').select('name').order('id');
        const opSelect = document.getElementById('newMaintenanceOperator');
        if (opSelect && operators) {
          opSelect.innerHTML = '<option value="">æ‹…å½“è€…ã‚’é¸æŠ</option>';
          operators.forEach(op => {
            const opt = document.createElement('option');
            opt.value = op.name; opt.textContent = op.name;
            opSelect.appendChild(opt);
          });
        }

        loadMaintenanceHistory(machineId);
        const { data: items } = await client.from("maintenance_items_tractor").select("*").order("id");
        const checklistContainer = document.getElementById("maintenanceChecklist");
        if (checklistContainer && items) {
          checklistContainer.innerHTML = "";
          items.forEach(item => {
            const uniqueId = `${machineId}_${item.id}`;
            const div = document.createElement("div");
            div.className = "flex items-center justify-between p-3 border-b border-gray-50 last:border-0 hover:bg-gray-50 transition-colors";
            div.innerHTML = `
              <div class="flex flex-col flex-1 text-left">
                  <span class="text-sm font-bold text-gray-700">${item.item_name}</span>
                  <span class="text-[10px] text-gray-400">${item.description || ''}</span>
              </div>
              <input type="checkbox" id="${uniqueId}" class="maintenance-check w-6 h-6 rounded border-gray-300 text-[#6b8f71]"
                     onchange="saveSingleCheck('${machineId}', '${item.id}', this.checked)">
            `;
            checklistContainer.appendChild(div);
          });
        }
        await restoreMaintenanceChecks();
      } catch (e) { console.error(e); }
    }

    // 3. é€²æ—è¡¨ç¤ºã®æ›´æ–°
    function updateMaintenanceProgress() {
      const checkboxes = document.querySelectorAll('#maintenanceChecklist input[type="checkbox"]');
      const total = checkboxes.length;
      if (total === 0) return;
      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
      const percentage = Math.round((checkedCount / total) * 100);
      const summaryDiv = document.getElementById('maintenanceSummary');
      if (summaryDiv) {
        summaryDiv.innerHTML = `
          <div class="flex justify-between items-center mb-1">
            <span class="font-bold text-[#6b8f71]">${percentage}% å®Œäº†</span>
            <span class="text-xs text-gray-400">${checkedCount} / ${total} é …ç›®</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="bg-[#6b8f71] h-2 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
          </div>
        `;
      }
    }

    // 4. ä¿å­˜
    async function saveSingleCheck(machineId, itemId, isChecked) {
      try {
        const uniqueId = `${machineId}_${itemId}`;
        await client.from('maintenance_status').upsert({
          item_id: uniqueId, status: Boolean(isChecked), updated_at: new Date()
        }, { onConflict: 'item_id' });
        updateMaintenanceProgress();
        loadMachineList();
      } catch (e) { console.error(e); }
    }

    // 5. å¾©å…ƒ
    async function restoreMaintenanceChecks() {
      try {
        const { data } = await client.from('maintenance_status').select('item_id, status');
        if (data) {
          data.forEach(row => {
            const el = document.getElementById(row.item_id);
            if (el) el.checked = row.status;
          });
        }
        updateMaintenanceProgress();
      } catch (e) { console.error(e); }
    }

    async function loadMaintenanceHistory(machineId) {
      try {
        const { data } = await client.from('maintenance_records').select('*').eq('machine_id', machineId).order('created_at', { ascending: false });
        const container = document.getElementById('maintenanceHistoryLog');
        if (!container) return;
        if (!data || data.length === 0) {
          container.innerHTML = '<p class="italic text-gray-400 text-center py-4">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
          return;
        }
        container.innerHTML = data.map(rec => `
          <div class="border-b border-gray-100 pb-2 mb-2 last:border-0 text-left">
            <div class="flex justify-between font-bold text-gray-700"><span>${rec.item_name}</span><span class="text-gray-400 text-[9px]">${rec.date}</span></div>
            <div class="text-gray-500">æ‹…å½“: ${rec.operator}</div>
            ${rec.memo ? `<div class="text-gray-400 italic">"${rec.memo}"</div>` : ''}
          </div>`).join('');
      } catch (e) { console.error(e); }
    }

    // ==========================================
    // 1. ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–ï¼ˆDOMContentLoadedï¼‰
    // ==========================================
    document.addEventListener('DOMContentLoaded', async () => {
      console.log("ğŸš€ å…¨ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ã‚’é–‹å§‹ã—ã¾ã™...");

      // ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ»ãƒ­ã‚°å…¥åŠ›ãƒ»å±¥æ­´ã®èª­ã¿è¾¼ã¿
      if (typeof loadMachineList === 'function') await loadMachineList();
      if (typeof restoreMaintenanceChecks === 'function') await restoreMaintenanceChecks();
      if (typeof loadOperators === 'function') await loadOperators();
      if (typeof loadCategories === 'function') await loadCategories();
      if (typeof loadLogs === 'function') loadLogs('historyLogList', false);

      // æ—¥ä»˜ã‚»ãƒƒãƒˆ
      const dateInput = document.getElementById('workDate');
      if (dateInput) dateInput.value = new Date().toLocaleDateString('sv-SE');
      const monthInput = document.getElementById('filterMonth');
      if (monthInput) monthInput.value = new Date().toISOString().substring(0, 7);

      // â˜…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®åˆæœŸè¡¨ç¤ºï¼ˆå…¨ä½“ã‚’è¡¨ç¤ºï¼‰
      if (typeof renderDashboard === 'function') {
        renderDashboard('all');
      }

      if (typeof switchView === 'function') {
        switchView('portalView');
      }

      console.log("âœ… å…¨ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–å‘½ä»¤ã‚’å®Œäº†ã—ã¾ã—ãŸ");
    }); // â† ã“ã“ã§ DOMContentLoaded ãŒã‚¹ãƒƒã‚­ãƒªçµ‚äº†ï¼


    // ==========================================
    // 2. å®Ÿå‹™ã‚’ã“ãªã™é–¢æ•°ãŸã¡
    // ==========================================

    // --- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å…¨ä½“ã‚’åˆ¶å¾¡ã™ã‚‹é–¢æ•° ---
    async function renderDashboard(machineId = 'all') {
      const machineTabs = document.getElementById("machineTabs");
      if (!machineTabs) return;

      window.currentViewMachineId = machineId;
      console.log("ğŸ› ï¸ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æç”»ä¸­... ID:", machineId);
      const currentId = machineId;
      const allBtnClass = (currentId === 'all') ? 'active' : 'inactive';

      let tabsHTML = `
      <button onclick="renderDashboard('all')" 
              class="tab-btn ${allBtnClass}" 
              style="min-width: 80px; letter-spacing: 0.2em;">å…¨ ä½“</button>
    `;

      if (typeof allMachines !== 'undefined' && allMachines.length > 0) {
        tabsHTML += allMachines.map(m => {
          const isActive = (String(m.id) === String(currentId)) ? 'active' : 'inactive';
          return `
          <button onclick="renderDashboard(${m.id})" 
                  class="tab-btn ${isActive}">${m.name}</button>
        `;
        }).join("");
      }
      machineTabs.innerHTML = tabsHTML;


      try {
        // 1. ã¾ãšãƒ™ãƒ¼ã‚¹ã®ã‚¯ã‚¨ãƒªã‚’ä½œã‚‹ï¼ˆ2026å¹´ä»¥é™ï¼‹æ—¥ä»˜é †ï¼‰
        let query = client
          .from("hour_logs")
          .select("*")
          .gte("date", "2026-01-01")
          .order("date", { ascending: false });

        // 2. ã€Œã™ã¹ã¦ã€ä»¥å¤–ãŒé¸ã°ã‚Œã¦ã„ã‚‹å ´åˆã ã‘ã€ã•ã‚‰ã«ãƒã‚·ãƒ³IDã§çµã‚Šè¾¼ã‚€
        if (machineId !== 'all') {
          query = query.eq("machine_id", machineId);
        }

        const { data, error } = await query;
        if (error) throw error;

        // ã‚‚ã—ãƒ‡ãƒ¼ã‚¿ãŒ0ä»¶ãªã‚‰ã€Œãƒ‡ãƒ¼ã‚¿ãªã—ã€ã¨è¡¨ç¤ºã—ã¦çµ‚ã‚ã‚‹ï¼ˆã‚¨ãƒ©ãƒ¼ã§æ­¢ã‚ãªã„ï¼‰
        if (!data || data.length === 0) {
          console.warn("âš ï¸ 2026å¹´ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          const rankingContainer = document.getElementById("rankList");
          if (rankingContainer) rankingContainer.innerHTML = "ãƒ‡ãƒ¼ã‚¿ãªã—";
          return;
        }

        // é›†è¨ˆ
        const summary = {};
        data.forEach(log => {
          let name = "ä¸æ˜";
          if (typeof allMachines !== 'undefined') {
            const m = allMachines.find(item => String(item.id) === String(log.machine_id));
            if (m) name = m.name;
          }
          const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
          summary[name] = (summary[name] || 0) + (h > 0 ? h : 0);
        });

        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºï¼ˆä¸Šä½3ä½ï¼‰
        const sorted = Object.entries(summary).sort((a, b) => b[1] - a[1]);
        const rankingContainer = document.getElementById("rankList");
        if (rankingContainer) {
          const crownColors = ['text-yellow-500', 'text-gray-400', 'text-amber-600'];
          rankingContainer.innerHTML = sorted.slice(0, 3).map(([name, hours], i) => `
            <div class="flex flex-col items-center px-1 text-center" style="min-width: 75px;">
              <div class="mb-1"><i class="fa-solid fa-crown ${crownColors[i]} text-xl"></i></div>
              <span class="text-[10px] font-bold text-gray-700 truncate w-20 leading-tight">${name}</span>
            </div>
          `).join('');
        }

        // --- KPIã‚«ãƒ¼ãƒ‰ã®é›†è¨ˆã¨åæ˜  ---
        if (data) {
          let totalH = 0;
          let totalF = 0;
          const daysSet = new Set();

          data.forEach(log => {
            // ç¨¼åƒæ™‚é–“ã®è¨ˆç®—
            const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
            totalH += (h > 0 ? h : 0);

            // âœ… çµ¦æ²¹é‡ã‚’ fuel_amount ã‹ã‚‰å–å¾—
            totalF += (parseFloat(log.fuel_amount) || 0);

            // ä½œæ¥­æ—¥æ•°ã®ã‚«ã‚¦ãƒ³ãƒˆ
            if (log.date) daysSet.add(log.date);
          });

          // ç‡ƒè²»è¨ˆç®— (çµ¦æ²¹åˆè¨ˆ Ã· ç¨¼åƒæ™‚é–“åˆè¨ˆ)
          const fuelAvg = totalH > 0 ? (totalF / totalH).toFixed(2) : "0.00";

          // HTMLè¦ç´ ã¸ã®åæ˜ 
          const elH = document.getElementById("kpi-hours");
          const elF = document.getElementById("kpi-fuel");
          const elA = document.getElementById("kpi-avg");
          const elD = document.getElementById("kpi-days");

          if (elH) elH.innerText = totalH.toFixed(1);
          if (elF) elF.innerText = totalF.toFixed(1);
          if (elA) elA.innerText = fuelAvg;
          if (elD) elD.innerText = daysSet.size;

          console.log("âœ… KPIæ›´æ–°å®Œäº† (fuel_amountä½¿ç”¨):", { totalH, totalF, fuelAvg });
        }

        if (typeof drawCharts === 'function') {
          drawCharts(data);
        }

      } catch (e) {
        console.error("âŒ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æç”»ã‚¨ãƒ©ãƒ¼:", e);
      }
    }

    async function saveMaintenanceRecord() {
      const item = document.getElementById('newMaintenanceItem')?.value;
      const operator = document.getElementById('newMaintenanceOperator')?.value;
      const status = document.getElementById('newMaintenanceStatus')?.value;
      const memo = document.getElementById('newMaintenanceMemo')?.value;

      // window.currentMachineId ã‚’æ˜ç¤ºçš„ã«æ•°å€¤ã¨ã—ã¦å–å¾—ã™ã‚‹
      let mId = window.currentMachineId;
      const numericMachineId = parseInt(mId);

      // æ•°å€¤ã˜ã‚ƒãªã„ï¼ˆ"all"ã‚„ç©ºã£ã½ï¼‰å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã™
      if (isNaN(numericMachineId)) {
        alert("æ©Ÿæ¢°ã®æƒ…å ±ã‚’èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ä¸€åº¦ä¸€è¦§ã«æˆ»ã£ã¦é¸ã³ç›´ã—ã¦ãã ã•ã„ğŸŒ¸");
        return;
      }

      if (!item) {
        alert("äº¤æ›éƒ¨å“ãƒ»é …ç›®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã­ğŸŒ¸");
        return;
      }

      try {
        const { error } = await client.from('maintenance_records').insert([
          {
            item_name: item,
            operator: operator,
            status: status,
            memo: memo,
            date: new Date().toISOString().split('T')[0],
            machine_id: numericMachineId // ã“ã“ã§æ•°å€¤ã‚’ä½¿ã†
          }
        ]);

        if (error) throw error;

        alert("ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æƒ…å ±ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼âœ¨");

        // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
        document.getElementById('newMaintenanceItem').value = '';
        document.getElementById('newMaintenanceMemo').value = '';

        // å±¥æ­´ã®è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆã“ã®é–¢æ•°ãŒã‚ã‚‹å ´åˆï¼‰
        if (typeof loadMaintenanceHistory === 'function') {
          loadMaintenanceHistory(numericMachineId);
        }

      } catch (err) {
        console.error("Maint Save Error:", err);
        alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (err.message || JSON.stringify(err)));
      }
    }

    async function saveLog() {
      const machineId = document.getElementById('machineSelect')?.value;
      const workDate = document.getElementById('workDate')?.value;
      const operator = document.getElementById('operator')?.value;
      const category = document.getElementById('category')?.value;
      const workName = document.getElementById('work_name')?.value;
      const hourBefore = parseFloat(document.getElementById('hourBefore')?.value) || 0;
      const hourAfter = parseFloat(document.getElementById('hourAfter')?.value) || 0;
      const fuel = parseFloat(document.getElementById('fuelAmount')?.value) || 0;
      const memo = document.getElementById('memoInput')?.value;

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå…¥åŠ›ãƒã‚§ãƒƒã‚¯ï¼‰
      if (!machineId) return alert("æ©Ÿæ¢°ã‚’é¸æŠã—ã¦ãã ã•ã„");
      if (!workDate || !workName) return alert("ã€Œä½œæ¥­æ—¥ã€ã€Œä½œæ¥­å†…å®¹ã€ã¯å¿…é ˆé …ç›®ã§ã™");
      if (hourAfter < hourBefore) return alert("ã‚¨ãƒ©ãƒ¼ï¼šç¨¼åƒå¾Œã®æ•°å€¤ãŒç¨¼åƒå‰ã‚ˆã‚Šå°ã•ããªã£ã¦ã„ã¾ã™ã€‚");

      // ä»¥å‰ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼šshowModal ã‚’ä½¿ã£ã¦ç¢ºèªã—ã¦ã‹ã‚‰ä¿å­˜
      showModal("ç™»éŒ²ç¢ºèª", "ãƒ­ã‚°ã‚’ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ", async () => {
        try {
          const { error } = await client.from('hour_logs').insert([{
            date: workDate,
            operator: operator,
            machine_id: parseInt(machineId),
            start_hour: hourBefore,
            end_hour: hourAfter,
            category: category,
            task: workName,
            fuel_amount: fuel,
            memo: memo
          }]);

          if (error) throw error;

          // ä¿å­˜æˆåŠŸå¾Œã€ä»¥å‰ã®ã‚ˆã†ã«ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆ
          location.reload();

        } catch (err) {
          console.error("Log Save Error:", err);
          alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (err.message));
        }
      });
    }

    // --- Google Vision APIã‚’ä½¿ã£ã¦ç”»åƒã‹ã‚‰æ•°å­—ã‚’èª­ã¿å–ã‚‹é–¢æ•° ---
    async function performOCR(base64Image) {
      const url = `https://vision.googleapis.com/v1/images:annotate?key=${GOOGLE_VISION_API_KEY}`;

      const requestData = {
        requests: [{
          image: { content: base64Image },
          features: [{ type: "TEXT_DETECTION" }]
        }]
      };

      try {
        const response = await fetch(url, {
          method: "POST",
          body: JSON.stringify(requestData)
        });
        const result = await response.json();

        // èª­ã¿å–ã£ãŸå…¨ãƒ†ã‚­ã‚¹ãƒˆã‚’çµåˆ
        const detections = result.responses[0].textAnnotations;
        if (!detections || detections.length === 0) return null;

        const fullText = detections[0].description;
        console.log("ğŸ” OCRèª­ã¿å–ã‚Šçµæœ:", fullText);

        // ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã€Œæ•°å­—ï¼ˆå°æ•°ç‚¹å«ã‚€ï¼‰ã€ã ã‘ã‚’æŠ½å‡ºã™ã‚‹ï¼ˆä¾‹: "123.4"ï¼‰
        const match = fullText.match(/\d+(\.\d+)?/);
        return match ? match[0] : null;
      } catch (err) {
        console.error("âŒ OCRã‚¨ãƒ©ãƒ¼:", err);
        return null;
      }
    }

    // ãƒãƒ³ãƒ‰ãƒ©ï¼šç¨¼åƒå¾Œã®æ•°å€¤ã‚’ç”»åƒã‹ã‚‰èª­ã¿å–ã‚‹
    async function handleHourAfterImage(input) {
      const file = input.files[0];
      if (!file) return;

      try {
        const base64Image = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.readAsDataURL(file);
        });

        // OCR å®Ÿè¡Œ
        const text = await performOCR(base64Image);
        if (!text) return alert('èª­ã¿å–ã‚Šã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†™çœŸã‚’å¤‰ãˆã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');

        // æ•°å­—ï¼ˆå°æ•°ç‚¹å«ã‚€ï¼‰ã‚’æŠ½å‡ºã—ã¦ input ã«åæ˜ 
        const m = text.match(/\d+(?:\.\d+)?/);
        if (m) {
          document.getElementById('hourAfter').value = m[0];
          calcDiff();
        } else {
          alert('æ•°å­—ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚èª­ã¿å–ã‚Šçµæœ:\n' + (text.substring(0,200) || '-----'));
        }
      } catch (err) {
        console.error('HourAfter OCR error', err);
        alert('èª­ã¿å–ã‚Šä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      } finally {
        // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢ã—ã¦åŒã˜ç”»åƒã‚’å†é¸æŠã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
        input.value = '';
      }
    }
    // Duplicate/old secondary `loadRepairDashboard` removed.
    // The primary `loadRepairDashboard` (defined earlier) is used to populate
    // å¹´ã”ã¨ã®ä¿®ç†è²» / æ©Ÿæ¢°ã”ã¨ã®ä¿®ç†è²» / æœ€è¿‘ã®ä¿®ç†ä¸€è¦§ ãªã©ã€‚
  </script>
</body>

</html>