<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>TractorLog - 山形酒田版</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+JP:wght@400;700;900&display=swap');
    body { font-family: 'Inter', 'Noto Sans JP', sans-serif; background-color: #f8f9fa; color: #333; transition: background-color 0.3s, color 0.3s; }
    .dark-mode { background-color: #1a1a1a; color: #f8f9fa; }
    .card { background: white; border-radius: 24px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); transition: all 0.3s ease; border: 1px solid rgba(0,0,0,0.03); }
    .dark-mode .card { background: #2d2d2d; border-color: rgba(255,255,255,0.05); }
    .view { display: none; }
    .view.active { display: block; }
    #sideMenu { transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000; }
    #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 999; }
    canvas { width: 100% !important; height: 100% !important; }
  </style>
</head>
<body>

  <div id="overlay"></div>
  <div id="sideMenu" class="fixed top-0 -left-[280px] w-[280px] h-full bg-white dark:bg-gray-900 p-6 shadow-2xl">
    <div class="flex justify-between items-center mb-10">
      <h2 class="text-2xl font-black text-[#6b8f71]">MENU</h2>
      <button id="closeMenuBtn" class="text-2xl opacity-50">&times;</button>
    </div>
    <nav class="space-y-2">
      <button onclick="switchView('inputView')" class="w-full flex items-center space-x-4 p-4 rounded-2xl hover:bg-gray-100 dark:hover:bg-gray-800 font-bold transition-all"><i class="fa-solid fa-pen-to-square"></i><span>稼働ログ入力</span></button>
      <button onclick="switchView('dashboard')" class="w-full flex items-center space-x-4 p-4 rounded-2xl hover:bg-gray-100 dark:hover:bg-gray-800 font-bold transition-all"><i class="fa-solid fa-chart-pie"></i><span>稼働分析</span></button>
      <button onclick="switchView('todayView')" class="w-full flex items-center space-x-4 p-4 rounded-2xl hover:bg-gray-100 dark:hover:bg-gray-800 font-bold transition-all"><i class="fa-solid fa-calendar-day"></i><span>本日の状況</span></button>
      <button onclick="switchView('historyView')" class="w-full flex items-center space-x-4 p-4 rounded-2xl hover:bg-gray-100 dark:hover:bg-gray-800 font-bold transition-all"><i class="fa-solid fa-list-ul"></i><span>稼働履歴・検索</span></button>
      <hr class="my-6 opacity-10">
      <button onclick="toggleDarkMode()" class="w-full flex items-center space-x-4 p-4 rounded-2xl bg-gray-50 dark:bg-gray-800 font-bold transition-all"><i class="fa-solid fa-circle-half-stroke"></i><span>モード切替</span></button>
    </nav>
  </div>

  <div class="max-w-4xl mx-auto px-4 py-6" id="mainContainer">
    <header class="flex justify-between items-center mb-8" id="pageHeader">
      <button id="menuBtn" class="w-12 h-12 flex items-center justify-center bg-white dark:bg-gray-800 rounded-2xl shadow-sm"><i class="fa-solid fa-bars-staggered text-xl"></i></button>
      <div class="text-right">
        <h1 class="text-xl font-black tracking-tight">Tractor<span class="text-[#6b8f71]">Log</span></h1>
        <p class="text-[10px] opacity-40 font-bold uppercase tracking-widest">Sakata - Yamagata</p>
      </div>
    </header>

    <div id="inputView" class="view active animate-fade-in">
      <div class="card p-8 space-y-6">
        <div><label class="text-xs font-black opacity-40 uppercase tracking-widest mb-2 block">日付</label><input type="date" id="workDate" class="w-full p-4 bg-gray-50 dark:bg-gray-800 rounded-2xl font-bold focus:ring-4 ring-[#6b8f71]/20 outline-none"></div>
        <div><label class="text-xs font-black opacity-40 uppercase tracking-widest mb-2 block">機械選択</label><select id="machineSelect" class="w-full p-4 bg-gray-50 dark:bg-gray-800 rounded-2xl font-bold outline-none"></select></div>
        <div><label class="text-xs font-black opacity-40 uppercase tracking-widest mb-2 block">オペレーター</label><select id="operatorSelect" class="w-full p-4 bg-gray-50 dark:bg-gray-800 rounded-2xl font-bold outline-none"><option>選択してください</option><option>父</option><option>母</option><option>私</option></select></div>
        <div class="grid grid-cols-2 gap-4">
          <div><label class="text-xs font-black opacity-40 uppercase tracking-widest mb-2 block">開始 (h)</label><input type="number" id="hourBefore" step="0.1" class="w-full p-4 bg-gray-100 dark:bg-gray-900/50 rounded-2xl font-bold opacity-60 outline-none" readonly></div>
          <div><label class="text-xs font-black opacity-40 uppercase tracking-widest mb-2 block">終了 (h)</label><input type="number" id="hourAfter" step="0.1" class="w-full p-4 bg-gray-50 dark:bg-gray-800 rounded-2xl font-bold focus:ring-4 ring-[#6b8f71]/20 outline-none"></div>
        </div>
        <div id="hourDiffDisplay" class="text-right text-sm font-black text-[#6b8f71] tracking-tighter">稼働時間: 0.0 h</div>
        <div class="grid grid-cols-2 gap-4">
          <div><label class="text-xs font-black opacity-40 uppercase tracking-widest mb-2 block">種別</label><select id="categorySelect" class="w-full p-4 bg-gray-50 dark:bg-gray-800 rounded-2xl font-bold outline-none"><option value="">選択</option><option value="水稲">水稲</option><option value="そば">そば</option><option value="保全会">保全会</option><option value="小規模工事">小規模工事</option><option value="その他">その他</option></select></div>
          <div><label class="text-xs font-black opacity-40 uppercase tracking-widest mb-2 block">作業内容</label><select id="taskSelect" class="w-full p-4 bg-gray-50 dark:bg-gray-800 rounded-2xl font-bold outline-none"></select></div>
        </div>
        <div><label class="text-xs font-black opacity-40 uppercase tracking-widest mb-2 block">給油量 (L)</label><input type="number" id="fuelAmount" step="0.1" class="w-full p-4 bg-gray-50 dark:bg-gray-800 rounded-2xl font-bold outline-none"></div>
        <div><label class="text-xs font-black opacity-40 uppercase tracking-widest mb-2 block">メモ</label><textarea id="memoInput" rows="2" class="w-full p-4 bg-gray-50 dark:bg-gray-800 rounded-2xl font-bold outline-none"></textarea></div>
        <button id="saveBtn" class="w-full py-5 bg-[#6b8f71] text-white rounded-2xl font-black shadow-lg shadow-[#6b8f71]/30 active:scale-95 transition-all">保存する</button>
      </div>
    </div>

    <div id="dashboard" class="view">
      <div id="allAnalysisArea" class="animate-fade-in">
        <div class="card bg-[#6b8f71] dark:bg-[#00ff9f]/20 text-white p-8 text-center rounded-3xl shadow-xl mb-10">
          <p class="text-[10px] font-black opacity-60 mb-2 uppercase tracking-widest">2026年度 総稼働時間</p>
          <h2 class="text-6xl sm:text-7xl font-black tracking-tighter" id="totalYearHours">0<span class="text-4xl opacity-40 ml-2">h</span></h2>
        </div>
        <div class="grid grid-cols-3 gap-3 sm:gap-6 mb-10" id="top3List"></div>
        <div id="machineTabs" class="flex overflow-x-auto space-x-2 pb-6 mb-6 no-scrollbar"></div>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="tractorGrid"></div>
      </div>

      <div id="analysisDetail" class="hidden animate-fade-in pb-20">
        <div class="card bg-[#6b8f71] dark:bg-[#00ff9f]/20 text-white p-8 text-center rounded-3xl shadow-xl relative overflow-hidden mb-6">
          <p class="text-sm font-bold opacity-80 mb-2 uppercase tracking-widest" id="detailMachineName">機械名</p>
          <div class="flex items-baseline justify-center">
            <h2 class="text-7xl font-black" id="detailTotalHours">0.0</h2>
            <span class="text-2xl ml-2 font-bold opacity-70">h</span>
          </div>
          <div id="compareYearTag" class="inline-flex items-center mt-4 px-3 py-1 bg-white/20 rounded-full text-xs font-bold">
            <span class="opacity-70 mr-1">前年同期比:</span><span id="detailCompareValue">--</span>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-6">
          <div class="card p-4 text-center">
            <p class="text-[10px] font-bold text-gray-400 uppercase">給油累計</p>
            <div class="flex items-baseline justify-center"><span class="text-2xl font-black" id="detailTotalFuel">0.0</span><span class="text-[10px] ml-0.5 opacity-50">L</span></div>
          </div>
          <div class="card p-4 text-center">
            <p class="text-[10px] font-bold text-gray-400 uppercase">平均燃費</p>
            <div class="flex items-baseline justify-center"><span class="text-2xl font-black" id="detailAvgFuel">0.0</span><span class="text-[10px] ml-0.5 opacity-50">L/h</span></div>
          </div>
        </div>
        <div class="card p-6 mb-6">
          <h4 class="text-sm font-bold mb-4 opacity-60">稼働推移 (前年比較)</h4>
          <div class="h-64 w-full"><canvas id="detailChart"></canvas></div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div class="card p-6">
            <h4 class="text-sm font-bold mb-4 opacity-60 flex items-center"><i class="fa-solid fa-mound mr-2"></i>作業種別・内容</h4>
            <div class="h-64"><canvas id="taskShareChart"></canvas></div>
          </div>
          <div class="card p-6">
            <h4 class="text-sm font-bold mb-4 opacity-60 flex items-center"><i class="fa-solid fa-users mr-2"></i>オペレーター比率</h4>
            <div class="h-64"><canvas id="operatorShareChart"></canvas></div>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
          <div class="card p-6 border-t-4 border-red-400">
            <h4 class="text-sm font-bold mb-2 opacity-60 text-red-500">累計修理費</h4>
            <div class="flex items-baseline">¥<span class="text-3xl font-black" id="detailTotalRepair">0</span></div>
          </div>
          <div class="card p-6 border-t-4 border-blue-400">
            <h4 class="text-sm font-bold mb-2 opacity-60 text-blue-500">直近のメンテナンス</h4>
            <div id="lastMaintenance" class="text-sm font-bold">記録なし</div>
          </div>
        </div>
        <div class="max-w-md mx-auto px-4 mt-12 mb-10">
          <button onclick="selectAnalysis('all', '全体')" class="w-full py-4 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-white rounded-2xl font-bold flex items-center justify-center shadow-md active:scale-95 transition-all">
            <i class="fa-solid fa-circle-arrow-left mr-2 text-xl"></i>マシン一覧に戻る
          </button>
        </div>
      </div>
    </div>

    <div id="todayView" class="view">
      <h3 class="text-lg font-black mb-6">本日の稼働状況</h3>
      <div id="todayLogList" class="space-y-4"></div>
    </div>

    <div id="historyView" class="view">
      <div class="card mb-6 p-6 flex justify-between items-center">
        <h3 class="font-black">稼働履歴</h3>
        <span id="historyTotalHours" class="text-sm font-bold text-[#6b8f71]">合計: 0.0 h</span>
      </div>
      <div id="historyLogList" class="space-y-4"></div>
    </div>

  </div>

  <div id="savePopup" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 bg-black text-white px-8 py-4 rounded-full font-bold shadow-2xl z-[2000] animate-bounce">保存しました！</div>
  <div id="deleteModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[2000] flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl w-full max-w-sm shadow-2xl">
      <h3 class="text-xl font-black mb-4">削除しますか？</h3>
      <p class="text-sm opacity-60 mb-8">この操作は取り消せません。</p>
      <div class="flex space-x-4">
        <button id="cancelDelete" class="flex-1 py-4 bg-gray-100 dark:bg-gray-700 font-bold rounded-2xl">戻る</button>
        <button id="confirmDelete" class="flex-1 py-4 bg-red-500 text-white font-bold rounded-2xl shadow-lg shadow-red-500/30">削除</button>
      </div>
    </div>
  </div>

<div id="savePopup" class="hidden fixed inset-0 flex items-center justify-center z-[10001]"><div class="px-6 py-3 rounded-lg text-white bg-[#2f5d3a] shadow-xl font-bold">保存しました</div></div>
<div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[10000]"><div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-sm w-full mx-4 text-center"><p class="text-lg font-bold mb-6">ログを削除しますか？</p><div class="flex space-x-4"><button id="cancelDelete" class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-lg font-bold">キャンセル</button><button id="confirmDelete" class="flex-1 py-3 bg-red-500 text-white rounded-lg font-bold">削除する</button></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const SUPABASE_URL = "https://txsqxnwgolybcdclazdx.supabase.co";
  const SUPABASE_KEY = "sb_publishable_8JEM6Yyg5_oQpF-grdaxIw_rrxZBQYj";
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const menu = document.getElementById("sideMenu");
  const overlay = document.getElementById("overlay");
  let deleteTargetId = null;

  // --- 初期化 ---
  document.addEventListener("DOMContentLoaded", () => {
    if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
    const now = new Date();
    now.setHours(now.getHours() + 9);
    document.getElementById("workDate").value = now.toISOString().split("T")[0];
    loadMachines();
  });

  function toggleDarkMode() {
    const isDark = document.body.classList.toggle('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    if (document.getElementById('dashboard').classList.contains('active')) loadDashboard();
    closeMenu();
  }

  function closeMenu() { menu.style.left = "-280px"; overlay.style.display = "none"; }
  document.getElementById("menuBtn").onclick = () => { menu.style.left = "0px"; overlay.style.display = "block"; };
  document.getElementById("closeMenuBtn").onclick = closeMenu;
  overlay.onclick = closeMenu;

  function switchView(id) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    closeMenu();
    const container = document.getElementById("mainContainer");
    const header = document.getElementById("pageHeader");
    if (id === 'dashboard') {
      container.classList.add("dashboard-active");
      if (header) header.style.display = 'none';
      loadDashboard();
    } else {
      container.classList.remove("dashboard-active");
      if (header) header.style.display = 'flex';
    }
    if (id === 'todayView') loadTodayLogs();
    if (id === 'historyView') loadHistoryLogs();
    window.scrollTo(0, 0);
  }

  async function loadMachines() {
    const { data } = await client.from("machines").select("*").order("name");
    const machineSelect = document.getElementById("machineSelect");
    machineSelect.innerHTML = '<option value="">選択してください</option>' +
      (data || []).map(m => `<option value="${m.id}">${m.manufacturer} ${m.name}</option>`).join("");
  }

  const taskOptions = {
    "水稲": ["あぜ塗り", "クロぶつし", "起耕", "起耕+基肥散布", "粗代", "本代", "ロール運搬", "その他"],
    "そば": ["起耕", "起耕+基肥散布", "その他"],
    "保全会": ["ハンマーモア(春作業)", "ハンマーモア(秋作業)", "スライドモア(春作業)", "スライドモア(秋作業)", "その他"],
    "小規模工事": ["整地", "掘削", "埋戻し", "土砂運搬", "その他"],
    "その他": ["その他"]
  };

  document.getElementById("categorySelect").addEventListener("change", function () {
    const taskSelect = document.getElementById("taskSelect");
    taskSelect.innerHTML = (taskOptions[this.value] || []).map(t => `<option value="${t}">${t}</option>`).join("");
  });

  document.getElementById("machineSelect").addEventListener("change", async function () {
    if (!this.value) return;
    const { data } = await client.from("hour_logs").select("end_hour").eq("machine_id", this.value).order("date", { ascending: false }).order("created_at", { ascending: false }).limit(1);
    if (data?.[0]) { document.getElementById("hourBefore").value = data[0].end_hour; calculate(); }
  });

  function calculate() {
    const diff = (parseFloat(document.getElementById("hourAfter").value) || 0) - (parseFloat(document.getElementById("hourBefore").value) || 0);
    const el = document.getElementById("hourDiffDisplay");
    el.textContent = `稼働時間: ${diff.toFixed(1)} h`;
    el.classList.toggle("text-red-500", diff < 0);
  }
  document.getElementById("hourAfter").addEventListener("input", calculate);

  document.getElementById("saveBtn").onclick = async function () {
    const mId = document.getElementById("machineSelect").value;
    const hA = parseFloat(document.getElementById("hourAfter").value);
    const op = document.getElementById("operatorSelect").value;
    const fuel = parseFloat(document.getElementById("fuelAmount").value) || 0;
    if (!mId || isNaN(hA) || op === "選択してください") { alert("必須項目を入力してください"); return; }
    const { error } = await client.from("hour_logs").insert([{
      machine_id: mId, date: document.getElementById("workDate").value, operator: op,
      category: document.getElementById("categorySelect").value, task: document.getElementById("taskSelect").value,
      start_hour: parseFloat(document.getElementById("hourBefore").value) || 0, end_hour: hA, fuel_amount: fuel, memo: document.getElementById("memoInput").value
    }]);
    if (error) alert("保存失敗: " + error.message);
    else { showSavePopup(); setTimeout(() => location.reload(), 1500); }
  };

  function showSavePopup() { const p = document.getElementById("savePopup"); p.classList.remove("hidden"); setTimeout(() => p.classList.add("hidden"), 1500); }

  // --- DASHBOARDロジック ---

  async function selectAnalysis(machineId, machineName) {
    window.selectedMachineId = machineId;
    window.selectedMachineName = machineName;

    const allTabs = document.querySelectorAll('.analysis-tab');
    allTabs.forEach(tab => {
      tab.classList.remove('bg-white', 'dark:bg-[#6b8f71]', 'shadow-sm', 'text-[#6b8f71]', 'dark:text-white');
      tab.classList.add('text-gray-500');
    });

    const activeTab = document.getElementById(`tab-${machineId}`);
    if (activeTab) {
      activeTab.classList.remove('text-gray-500');
      activeTab.classList.add('bg-white', 'dark:bg-[#6b8f71]', 'shadow-sm', 'text-[#6b8f71]', 'dark:text-white');
    }

    const allArea = document.getElementById("allAnalysisArea");
    const detailArea = document.getElementById("analysisDetail");

    if (machineId === 'all') {
      allArea.classList.remove("hidden");
      detailArea.classList.add("hidden");
    } else {
      allArea.classList.add("hidden");
      detailArea.classList.remove("hidden");
      await renderMachineDetail(machineId, machineName);
    }
  }

  // 個別詳細の集計と描画
  async function renderMachineDetail(mId, mName) {
    document.getElementById("detailMachineName").innerText = mName;
    const { data: allLogs } = await client.from("hour_logs").select("*").eq("machine_id", mId).order("date", { ascending: true });
    if (!allLogs) return;

    const logs2026 = allLogs.filter(l => l.date.startsWith('2026'));
    const logs2025 = allLogs.filter(l => l.date.startsWith('2025'));

    // 基本集計
    const totalH2026 = logs2026.reduce((s, l) => s + (l.end_hour - l.start_hour), 0);
    const totalF2026 = logs2026.reduce((s, l) => s + (parseFloat(l.fuel_amount) || 0), 0);
    const avgF2026 = totalH2026 > 0 ? (totalF2026 / totalH2026).toFixed(2) : "0.00";
    const totalH2025 = logs2025.reduce((s, l) => s + (l.end_hour - l.start_hour), 0);

    // 画面反映
    document.getElementById("detailTotalHours").innerText = totalH2026.toFixed(1);
    document.getElementById("detailTotalFuel").innerText = totalF2026.toFixed(1);
    document.getElementById("detailAvgFuel").innerText = avgF2026;

    // 前年比
    const compareEl = document.getElementById("detailCompareValue");
    if (totalH2025 > 0) {
      const ratio = ((totalH2026 / totalH2025) * 100).toFixed(1);
      const diff = (totalH2026 - totalH2025).toFixed(1);
      compareEl.innerText = `${ratio}% (${diff >= 0 ? '+' : ''}${diff}h)`;
    } else {
      compareEl.innerText = "前年データなし";
    }

    // --- 分析データ集計 (作業・オペレーター) ---
    const taskData = {};
    const opData = {};
    logs2026.forEach(l => {
      const h = l.end_hour - l.start_hour;
      const task = l.task || "未分類";
      const op = l.operator || "不明";
      taskData[task] = (taskData[task] || 0) + h;
      opData[op] = (opData[op] || 0) + h;
    });

    // グラフ呼び出し
    renderHistoryChart(logs2026, logs2025);
    renderTaskChart(taskData);
    renderOperatorChart(opData);
  }

  // ① 稼働推移グラフ (折れ線)
  function renderHistoryChart(logs2026, logs2025) {
    const ctx = document.getElementById('detailChart').getContext('2d');
    if (window.myDetailChart) window.myDetailChart.destroy();
    const getMonthly = (logs) => {
      const m = Array(12).fill(0);
      logs.forEach(l => { const mon = parseInt(l.date.split('-')[1]) - 1; m[mon] += (l.end_hour - l.start_hour); });
      return m;
    };
    const isDark = document.body.classList.contains('dark-mode');
    window.myDetailChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'],
        datasets: [
          { label: '2026年', data: getMonthly(logs2026), borderColor: isDark ? '#00ff9f' : '#6b8f71', backgroundColor: 'rgba(107,143,113,0.1)', fill: true, tension: 0.4 },
          { label: '2025年', data: getMonthly(logs2025), borderColor: 'rgba(156, 163, 175, 0.5)', borderDash: [5, 5], fill: false, tension: 0.4 }
        ]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: isDark ? '#fff' : '#000' } } } }
    });
  }

  // ② 作業内容グラフ (ドーナツ)
  function renderTaskChart(dataObj) {
    const ctx = document.getElementById('taskShareChart').getContext('2d');
    if (window.myTaskChart) window.myTaskChart.destroy();
    const isDark = document.body.classList.contains('dark-mode');
    window.myTaskChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: Object.keys(dataObj),
        datasets: [{
          data: Object.values(dataObj).map(v => v.toFixed(1)),
          backgroundColor: ['#6b8f71', '#9ab59f', '#c2d1c5', '#4a6b50', '#a3b18a', '#dce2d5'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'right', labels: { color: isDark ? '#fff' : '#000', boxWidth: 12, font: { size: 10 } } } }
      }
    });
  }

  // ③ オペレーターグラフ (横棒)
  function renderOperatorChart(dataObj) {
    const ctx = document.getElementById('operatorShareChart').getContext('2d');
    if (window.myOpChart) window.myOpChart.destroy();
    const isDark = document.body.classList.contains('dark-mode');
    window.myOpChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(dataObj),
        datasets: [{
          label: '稼働時間(h)',
          data: Object.values(dataObj).map(v => v.toFixed(1)),
          backgroundColor: isDark ? '#00ff9f' : '#6b8f71',
          borderRadius: 4
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { beginAtZero: true, grid: { color: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' }, ticks: { color: isDark ? '#fff' : '#000' } },
          y: { ticks: { color: isDark ? '#fff' : '#000' } }
        },
        plugins: { legend: { display: false } }
      }
    });
  }

  async function loadDashboard() {
    const grid = document.getElementById("tractorGrid");
    const top3List = document.getElementById("top3List");
    const tabContainer = document.getElementById("machineTabs");

    grid.innerHTML = "<p class='col-span-full text-center py-10'>読み込み中...</p>";
    top3List.innerHTML = "";
    
    const { data: machines } = await client.from("machines").select("*").order("manufacturer");
    const { data: logs } = await client.from("hour_logs").select("*, machines(name, manufacturer)");
    if (!machines || !logs) return;

    tabContainer.innerHTML = `<button onclick="selectAnalysis('all', '全体')" id="tab-all" class="analysis-tab flex-1 py-2 px-6 rounded-lg text-sm font-bold transition-all bg-white dark:bg-[#6b8f71] shadow-sm text-[#6b8f71] dark:text-white">全体</button>` + 
      machines.map(m => `<button onclick="selectAnalysis(${m.id}, '${m.name}')" id="tab-${m.id}" class="analysis-tab whitespace-nowrap py-2 px-6 rounded-lg text-sm font-bold transition-all text-gray-500 hover:text-[#6b8f71]">${m.name}</button>`).join("");

    const yearLogs = logs.filter(l => new Date(l.date).getFullYear() === 2026);
    const totalH = yearLogs.reduce((s, l) => s + (l.end_hour - l.start_hour), 0);
    document.getElementById("totalYearHours").innerHTML = `${totalH.toFixed(1)}<span class="text-4xl sm:text-5xl ml-2 font-bold opacity-100">h</span>`;

    const stats = machines.map(m => {
      const h = yearLogs.filter(l => l.machine_id === m.id).reduce((s, l) => s + (l.end_hour - l.start_hour), 0);
      return { ...m, hours: h };
    }).sort((a, b) => b.hours - a.hours);

    stats.slice(0, 3).forEach((m, i) => {
      const colors = ['text-yellow-500', 'text-gray-400', 'text-amber-600'];
      top3List.innerHTML += `<div class="text-center p-2 sm:p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl border-b-4 border-gray-200 dark:border-gray-700"><p class="text-[10px] sm:text-xs font-black ${colors[i]} uppercase">Rank ${i+1}</p><p class="font-bold truncate text-xs sm:text-sm mb-1">${m.name}</p><p class="text-lg sm:text-2xl font-black leading-none">${m.hours.toFixed(1)}<span class="text-[10px] sm:text-xs ml-0.5">h</span></p></div>`;
    });

    grid.innerHTML = "";
    const isDark = document.body.classList.contains('dark-mode');
    const chartColor = isDark ? '#00ff9f' : '#6b8f71';
    const chartBg = isDark ? 'rgba(255,255,255,0.05)' : '#f3f4f6';

    stats.forEach(m => {
      const card = document.createElement("div");
      card.className = "card flex flex-col items-center hover:shadow-2xl transition-all cursor-pointer";
      card.onclick = () => selectAnalysis(m.id, m.name);
      const target = 300;
      const percent = Math.min(100, (m.hours / target) * 100);
      card.innerHTML = `<div class="relative w-full h-32 flex justify-center mb-6 pointer-events-none"><canvas id="chart-${m.id}"></canvas><div class="absolute inset-0 flex flex-col items-center justify-center pt-4"><div class="flex items-baseline"><span class="text-3xl font-black">${m.hours.toFixed(1)}</span><span class="text-sm ml-1 font-bold opacity-40">h</span></div></div></div><div class="w-full text-center"><p class="text-[10px] font-black text-[#6b8f71] dark:text-[#00ff9f] uppercase tracking-[0.2em] mb-1">${m.manufacturer}</p><h4 class="text-lg font-bold leading-tight mb-4">${m.name}</h4><div class="w-full bg-gray-100 dark:bg-gray-800 h-1 rounded-full overflow-hidden"><div class="h-full rounded-full" style="width: ${percent}%; background-color: ${chartColor}"></div></div></div>`;
      grid.appendChild(card);
      setTimeout(() => {
        const el = document.getElementById(`chart-${m.id}`);
        if (!el) return;
        new Chart(el.getContext("2d"), { type: 'doughnut', data: { datasets: [{ data: [m.hours, Math.max(0.1, target - m.hours)], backgroundColor: [chartColor, chartBg], borderWidth: 0, cutout: '85%' }] }, options: { rotation: -120, circumference: 240, plugins: { legend: { display: false }, tooltip: { enabled: false } }, maintainAspectRatio: false } });
      }, 100);
    });
  }

  function renderLogs(data, elementId) {
    const list = document.getElementById(elementId);
    list.innerHTML = data?.length ? "" : "<p class='text-center opacity-40'>データがありません</p>";
    data?.forEach(log => {
      const diff = (log.end_hour - log.start_hour).toFixed(1);
      list.innerHTML += `<div class="card border-l-4 border-[#6b8f71] relative mb-4"><button onclick="openDeleteModal(${log.id})" class="absolute top-4 right-4 text-red-500 dark:text-red-400 opacity-80 hover:opacity-100 p-2"><i class="fa-solid fa-trash"></i></button><div class="flex items-center space-x-3 mb-2"><span class="text-xs font-bold opacity-50">${log.date}</span><span class="bg-[#f7f4ef] dark:bg-white/10 text-[#6b8f71] dark:text-[#00ff9f] px-2 py-0.5 rounded text-xs font-black ring-1 ring-[#6b8f71]/20">${diff} h</span></div><div class="font-bold pr-10">${log.machines?.name || '不明'} / ${log.operator}</div><div class="text-sm opacity-60">${log.category} - ${log.task}</div>${log.memo ? `<div class="text-xs mt-2 opacity-50 bg-black/5 dark:bg-white/5 p-2 rounded">${log.memo}</div>` : ""}</div>`;
    });
  }

  async function loadTodayLogs() { const { data } = await client.from("hour_logs").select("*, machines(name)").eq("date", new Date().toISOString().split("T")[0]).order("created_at", { ascending: false }); renderLogs(data, "todayLogList"); }
  async function loadHistoryLogs() { const { data } = await client.from("hour_logs").select("*, machines(name)").order("date", { ascending: false }); renderLogs(data, "historyLogList"); const total = (data || []).reduce((sum, log) => sum + (log.end_hour - log.start_hour), 0); document.getElementById("historyTotalHours").textContent = `合計: ${total.toFixed(1)} h`; }
  function openDeleteModal(id) { deleteTargetId = id; document.getElementById("deleteModal").classList.remove("hidden"); }
  document.getElementById("cancelDelete").onclick = () => document.getElementById("deleteModal").classList.add("hidden");
  document.getElementById("confirmDelete").onclick = async () => { await client.from("hour_logs").delete().eq("id", deleteTargetId); document.getElementById("deleteModal").classList.add("hidden"); loadTodayLogs(); loadHistoryLogs(); };

  if ("serviceWorker" in navigator) navigator.serviceWorker.register('/tractorlog/sw.js');
</script>
</body>
</html>