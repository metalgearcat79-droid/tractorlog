<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex">
  <link rel="manifest" href="/tractorlog/manifest.json">
  <title>和農日向 Tractor Log</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      background-color: #f7f4ef;
      color: #3a3a3a;
      font-family: "Hiragino Sans", "Noto Sans JP", sans-serif;
      margin: 0;
      padding: 0;
    }
    .hidden { display: none; }
    .fade-in { animation: fadeIn 0.3s forwards; }
    .fade-out { animation: fadeOut 0.3s forwards; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to   { opacity: 0; transform: translateY(10px); }
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      position: relative;
    }
    .btn-main {
      background-color: #6b8f71;
      color: white;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      width: 100%;
      transition: all 0.2s;
    }
    .btn-main:active {
      background-color: #587a5f;
      transform: scale(0.98);
    }
    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.4);
      z-index: 9998;
      display: none;
    }
    #sideMenu {
      position: fixed;
      top: 0;
      left: -280px;
      width: 280px;
      height: 100%;
      background: white;
      z-index: 9999;
      transition: left 0.3s ease;
      padding: 20px;
      padding-top: 60px;
    }
    @media (max-width: 480px) {
      #sideMenu { width: 240px; }
    }
    .view { display: none; padding: 20px; }
    .view.active { display: block; }

    /* メインコンテナの幅制御 */
    #mainContainer {
      width: 100%;
      max-width: 672px; /* 基本は 2xl 幅 */
      transition: max-width 0.3s ease;
    }
    /* ダッシュボード時のみ幅を広げる */
    #mainContainer.dashboard-active {
      max-width: 95% !important;
    }
  </style>
</head>

<body class="pb-10 bg-[#f7f4ef] text-gray-800">

<div id="overlay"></div>

<body class="pb-10 bg-[#f7f4ef] text-gray-800">

<div id="overlay"></div>

<div id="sideMenu">
  <div class="menuContent">
    <div class="flex justify-between items-center mb-8">
      <h2 class="font-bold text-xl text-[#6b8f71]">メニュー</h2>
      <button id="closeMenuBtn" style="font-size: 36px; color: #aaa; line-height: 1;">&times;</button>
    </div>
    <nav class="space-y-4">
      <button onclick="switchView('inputView')" class="w-full text-left p-4 bg-[#f7f4ef] rounded-lg font-bold text-[#6b8f71] flex items-center text-base lg:text-sm">
        <i class="fa-solid fa-pen-to-square mr-3 text-lg lg:text-base"></i>ログ入力
      </button>
      <button onclick="switchView('todayView')" class="w-full text-left p-4 hover:bg-[#f7f4ef] rounded-lg font-bold flex items-center text-[#6b8f71] text-base lg:text-sm">
        <i class="fa-solid fa-calendar-day mr-3 text-lg lg:text-base"></i>本日の稼働状況
      </button>
      <button onclick="switchView('historyView')" class="w-full text-left p-4 hover:bg-[#f7f4ef] rounded-lg font-bold flex items-center text-[#6b8f71] text-base lg:text-sm">
        <i class="fa-solid fa-magnifying-glass mr-3 text-lg lg:text-base"></i>稼働履歴・検索
      </button>
      <button onclick="switchView('dashboard')" class="w-full text-left p-4 hover:bg-[#f7f4ef] rounded-lg font-bold flex items-center text-[#6b8f71] text-base lg:text-sm">
        <i class="fa-solid fa-chart-line mr-3 text-lg lg:text-base"></i>DASHBOARD
      </button>
      <button onclick="switchView('maintenanceView')" class="w-full text-left p-4 hover:bg-[#f7f4ef] rounded-lg font-bold flex items-center text-[#6b8f71] text-base lg:text-sm">
        <i class="fa-solid fa-wrench mr-3 text-lg lg:text-base"></i>メンテナンス情報
      </button>
      <button onclick="switchView('repairView')" class="w-full text-left p-4 hover:bg-[#f7f4ef] rounded-lg font-bold flex items-center text-[#6b8f71] text-base lg:text-sm">
        <i class="fa-solid fa-tools mr-3 text-lg lg:text-base"></i>故障・修理履歴
      </button>
    </nav>
  </div>
</div>

<div id="mainContainer" class="mx-auto">
  <div id="dashboard" class="view bg-gradient-to-b from-[#efede8] to-[#f7f4ef] min-h-screen">
    <div class="max-w-full mx-auto"> 
      <div class="flex justify-between items-end border-b-2 border-[#6b8f71] pb-4 mb-8">
        <div>
          <h2 class="text-3xl font-black text-[#4a6b50] flex items-center tracking-tighter">
            <i class="fa-solid fa-chart-pie mr-4"></i>OPERATION DASHBOARD
          </h2>
          <p class="text-sm text-gray-500 font-bold ml-12 uppercase tracking-widest">2026年度 リアルタイム分析</p>
        </div>
        <button onclick="loadDashboard()" class="bg-[#6b8f71] text-white px-6 py-2 rounded-lg shadow-lg hover:bg-[#587a5f] transition-all active:scale-95 font-bold">
          <i class="fa-solid fa-rotate mr-2"></i>更新
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-10">
        <div class="bg-gradient-to-br from-[#4a6b50] to-[#2d4031] text-white p-8 rounded-xl shadow-2xl relative overflow-hidden">
          <div class="relative z-10">
            <p class="text-lg font-bold opacity-70 tracking-widest uppercase mb-1">年間総稼働時間</p>
            <h3 id="totalYearHours" class="text-7xl font-black flex items-baseline">
              0.0<span class="text-5xl ml-4 font-bold opacity-90">h</span>
            </h3>
          </div>
          <i class="fa-solid fa-calendar-check absolute -right-4 -top-4 text-9xl opacity-10"></i>
        </div>

        <div class="col-span-2 bg-white p-8 rounded-xl shadow-xl border border-gray-100">
          <p class="text-gray-500 text-sm font-black mb-6 flex items-center tracking-widest uppercase">
            <i class="fa-solid fa-crown text-yellow-500 mr-2"></i>年間稼働ランキング
          </p>
          <div id="top3List" class="grid grid-cols-3 gap-6"></div>
        </div>
      </div>
      
      <div id="tractorGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-8 mb-12"></div>
      </div>
  </div>
  
  <div id="maintenanceView" class="view">
    <h2 class="text-xl font-bold text-[#6b8f71] mb-4">メンテナンス情報</h2>
    <p class="text-gray-500">現在、詳細画面を構築中です...</p>
  </div>
  <div id="repairView" class="view">
    <h2 class="text-xl font-bold text-[#6b8f71] mb-4">故障・修理履歴</h2>
    <p class="text-gray-500">現在、詳細画面を構築中です...</p>
  </div>
</div>

<div id="mainContainer" class="mx-auto">
  <header class="flex flex-col items-center justify-center py-10 relative">
    <button id="menuBtn" class="absolute left-4 top-4 sm:top-8 z-50 text-3xl text-[#6b8f71] p-2">
      <i class="fa-solid fa-bars"></i>
    </button>
    <i class="fa-solid fa-tractor text-4xl sm:text-7xl text-[#6b8f71] mb-2"></i>
    <h1 class="text-lg sm:text-2xl font-bold text-[#6b8f71] tracking-wider text-center">和農日向 Tractor log</h1>
  </header>

  <div id="inputView" class="view active">
    <div class="card mb-4">
      <label class="block text-sm font-medium text-gray-500 mb-1">機械を選択</label>
      <select id="machineSelect" class="w-full p-3 border rounded-lg bg-white outline-none focus:border-[#6b8f71]">
        <option value="">機械を選択してください</option>
      </select>
    </div>
    <div class="card mb-4">
      <label class="block text-sm font-medium text-gray-500 mb-1">作業日</label>
      <input type="date" id="workDate" class="w-full p-3 border rounded-lg outline-none" />
    </div>
    <div class="card mb-4">
      <label class="block text-sm font-medium text-gray-500 mb-1">オペレーター</label>
      <select id="operatorSelect" class="w-full p-3 border rounded-lg outline-none">
        <option value="選択してください">選択してください</option>
        <option value="阿曽 千一">阿曽 千一</option>
        <option value="阿曽 右貢">阿曽 右貢</option>
        <option value="菅原 亜美">菅原 亜美</option>
        <option value="土井 達也">土井 達也</option>
        <option value="阿曽 文平">阿曽 文平</option>
        <option value="田中 武志">田中 武志</option>
        <option value="赤塚 かおり">赤塚 かおり</option>
        <option value="土門 元義">土門 元義</option>
        <option value="その他">その他</option>
      </select>
    </div>
    <div class="card mb-4">
      <label class="block text-sm font-medium text-gray-500 mb-1">種別</label>
      <select id="categorySelect" class="w-full p-3 border rounded-lg outline-none">
        <option value="">選択してください</option>
        <option value="水稲">水稲</option>
        <option value="そば">そば</option>
        <option value="保全会">保全会</option>
        <option value="小規模工事">小規模工事</option>
        <option value="その他">その他</option>
      </select>
    </div>
    <div class="card mb-4">
      <label class="block text-sm font-medium text-gray-500 mb-1">作業内容</label>
      <select id="taskSelect" class="w-full p-3 border rounded-lg outline-none"></select>
    </div>
    <div class="card mb-4">
      <div class="flex space-x-4">
        <div class="flex-1">
          <label class="block text-sm font-medium text-gray-500 mb-1">稼働前メーター</label>
          <input type="number" id="hourBefore" class="w-full p-3 border rounded-lg mt-1" step="0.1" />
        </div>
        <div class="flex-1">
          <label class="block text-sm font-medium text-gray-500 mb-1">稼働後メーター</label>
          <input type="number" id="hourAfter" class="w-full p-3 border rounded-lg mt-1" step="0.1" />
        </div>
      </div>
    </div>
    <div id="hourDiffDisplay" class="text-right font-bold text-[#6b8f71] mb-6 text-lg">
      稼働時間: 0.0 h
    </div>
    <div class="card mb-6">
      <label class="block text-sm font-medium text-gray-500 mb-1">メモ</label>
      <textarea id="memoInput" class="w-full p-3 border rounded-lg outline-none" rows="3" placeholder="備考など"></textarea>
    </div>
    <button id="saveBtn" class="btn-main text-base py-3">保存する</button>
  </div>

  <div id="savePopup" class="hidden fixed inset-0 flex items-center justify-center z-50">
    <div class="px-6 py-3 rounded-lg text-white text-lg shadow-lg" style="background-color: #2f5d3a;">
      保存しました
    </div>
  </div>

  <div id="todayView" class="view">
    <div class="flex justify-between items-center border-b-2 border-[#6b8f71] pb-3 mb-6">
      <h2 class="text-xl font-bold text-[#6b8f71] flex items-center">
        <i class="fa-solid fa-calendar-day mr-2"></i>本日の稼働状況
      </h2>
      <button onclick="loadTodayLogs()" class="text-sm bg-white px-3 py-1 rounded-lg shadow text-gray-600 active:scale-95">
        <i class="fa-solid fa-rotate"></i> 更新
      </button>
    </div>
    <div id="todayLogList" class="space-y-4 mb-10"></div>
    <button onclick="switchView('inputView')" class="w-full py-4 bg-gray-200 text-gray-700 rounded-xl font-bold flex items-center justify-center shadow-sm active:bg-gray-300">
      <i class="fa-solid fa-circle-arrow-left mr-2 text-xl"></i>TOPに戻る
    </button>
  </div>

  <div id="historyView" class="view">
    <div class="flex justify-between items-center border-b-2 border-[#6b8f71] pb-3 mb-6">
      <h2 class="text-xl font-bold text-[#6b8f71] flex items-center">
        <i class="fa-solid fa-magnifying-glass mr-2"></i>過去の履歴・検索
      </h2>
      <div id="historyTotalHours" class="text-sm font-bold bg-[#6b8f71] text-white px-3 py-1 rounded-full">
        合計: 0.0 h
      </div>
    </div>
    <div class="card mb-6 bg-white border border-gray-200">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="text-xs font-bold text-gray-500 mb-1 block">表示月</label>
          <input type="month" id="filterMonth" onchange="loadHistoryLogs()" class="w-full p-2 border rounded-lg bg-white" />
        </div>
        <div>
          <label class="text-xs font-bold text-gray-500 mb-1 block">日付</label>
          <input type="date" id="filterDay" onchange="loadHistoryLogs()" class="w-full p-2 border rounded-lg bg-white text-sm">
        </div>
        <div>
          <label class="text-xs font-bold text-gray-500 mb-1 block">オペレーター</label>
          <select id="filterOperator" onchange="loadHistoryLogs()" class="w-full p-2 border rounded-lg bg-white text-sm">
            <option value="すべて">すべて</option>
            <option value="阿曽 千一">阿曽 千一</option>
            <option value="阿曽 右貢">阿曽 右貢</option>
            <option value="菅原 亜美">菅原 亜美</option>
            <option value="土井 達也">土井 達也</option>
            <option value="阿曽 文平">阿曽 文平</option>
            <option value="田中 武志">田中 武志</option>
            <option value="赤塚 かおり">赤塚 かおり</option>
            <option value="土門 元義">土門 元義</option>
            <option value="その他">その他</option>
          </select>
        </div>
        <div>
          <label class="text-xs font-bold text-gray-500 mb-1 block">機械</label>
          <select id="filterMachine" onchange="loadHistoryLogs()" class="w-full p-2 border rounded-lg bg-white text-sm"></select>
        </div>
        <div>
          <label class="text-xs font-bold text-gray-500 mb-1 block">作業内容</label>
          <select id="filterTask" onchange="loadHistoryLogs()" class="w-full p-2 border rounded-lg bg-white text-sm">
            <option value="すべて">すべて</option>
          </select>
        </div>
      </div>
    </div>
    <div id="historyLogList" class="space-y-4 mb-10"></div>
    <button onclick="switchView('inputView')" class="w-full py-4 bg-gray-200 text-gray-700 rounded-xl font-bold flex items-center justify-center shadow-sm active:bg-gray-300">
      <i class="fa-solid fa-circle-arrow-left mr-2 text-xl"></i>TOPに戻る
    </button>
  </div>

  <div id="dashboard" class="view bg-gradient-to-b from-[#efede8] to-[#f7f4ef] min-h-screen">
    <div class="max-w-full mx-auto"> 
      <div class="flex justify-between items-end border-b-2 border-[#6b8f71] pb-4 mb-8">
        <div>
          <h2 class="text-3xl font-black text-[#4a6b50] flex items-center tracking-tighter">
            <i class="fa-solid fa-chart-pie mr-4"></i>OPERATION DASHBOARD
          </h2>
          <p class="text-sm text-gray-500 font-bold ml-12 uppercase tracking-widest">リアルタイム分析</p>
        </div>
        <button onclick="loadDashboard()" class="bg-[#6b8f71] text-white px-6 py-2 rounded-lg shadow-lg hover:bg-[#587a5f] transition-all active:scale-95 font-bold">
          <i class="fa-solid fa-rotate mr-2"></i>更新
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-10">
        <div class="bg-gradient-to-br from-[#4a6b50] to-[#2d4031] text-white p-8 rounded-xl shadow-2xl relative overflow-hidden">
          <div class="relative z-10">
            <p class="text-lg font-bold opacity-70 tracking-widest uppercase mb-1">月間稼働時間</p>
            <h3 id="totalMonthHours" class="text-7xl font-black flex items-baseline">
              0.0<span class="text-2xl ml-3 font-medium opacity-80 italic">h</span>
            </h3>
          </div>
          <i class="fa-solid fa-chart-line absolute -right-4 -top-4 text-9xl opacity-10"></i>
        </div>

        <div class="col-span-2 bg-white p-8 rounded-xl shadow-xl border border-gray-100">
          <p class="text-gray-500 text-sm font-black mb-6 flex items-center tracking-widest uppercase">
            <i class="fa-solid fa-crown text-yellow-500 mr-2"></i>月間稼働ランキング
          </p>
          <div id="top3List" class="grid grid-cols-3 gap-6"></div>
        </div>
      </div>

      <div id="tractorGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-8 mb-12"></div>

      <div class="flex justify-center pb-20">
        <button onclick="switchView('inputView')" class="px-10 py-4 bg-gray-800 text-white rounded-xl font-bold flex items-center justify-center shadow-xl hover:bg-black transition-colors">
          <i class="fa-solid fa-arrow-left-long mr-3"></i>TOPに戻る
        </button>
      </div>
    </div>
  </div>
</div>

<div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[10000]">
  <div class="bg-white p-6 rounded-xl shadow-xl max-w-sm w-full mx-4 text-center">
    <p class="text-lg font-bold mb-6">ログを削除しますか？</p>
    <div class="flex space-x-4">
      <button id="cancelDelete" class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-lg font-bold">キャンセル</button>
      <button id="confirmDelete" class="flex-1 py-3 bg-red-500 text-white rounded-lg font-bold">削除する</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // Supabase設定
  const SUPABASE_URL = "https://txsqxnwgolybcdclazdx.supabase.co";
  const SUPABASE_KEY = "sb_publishable_8JEM6Yyg5_oQpF-grdaxIw_rrxZBQYj";
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const menu = document.getElementById("sideMenu");
  const overlay = document.getElementById("overlay");
  let deleteTargetId = null;

  // 初期化
  document.addEventListener("DOMContentLoaded", () => {
    const now = new Date();
    now.setHours(now.getHours() + 9);
    const today = now.toISOString().split("T")[0];
    document.getElementById("workDate").value = today;
    loadMachines();
  });

  // メニュー
  document.getElementById("menuBtn").onclick = () => {
    menu.style.left = "0px";
    overlay.style.display = "block";
  };
  document.getElementById("closeMenuBtn").onclick = closeMenu;
  overlay.onclick = closeMenu;
  function closeMenu() {
    menu.style.left = "-280px";
    overlay.style.display = "none";
  }

  // 画面切り替え（幅制御含む）
  function switchView(id) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    
    closeMenu();
    const container = document.getElementById("mainContainer");
    const header = document.querySelector('header'); // header要素を取得

    if (id === 'dashboard') {
      container.classList.add("dashboard-active");
      if (header) header.style.display = 'none'; // ★ダッシュボードならheaderを隠す
      loadDashboard();
    } else {
      container.classList.remove("dashboard-active");
      if (header) header.style.display = 'flex'; // ★他の画面ならheaderを表示する
    }

    if (id === 'todayView') loadTodayLogs();
    if (id === 'historyView') {
      loadTaskFilterOptions();
      loadHistoryLogs();
    }
    window.scrollTo(0, 0);
  }

  // 機械マスタ
  async function loadMachines() {
    const { data } = await client.from("machines").select("*").order("name");
    const entrySelect = document.getElementById("machineSelect");
    const filterSelect = document.getElementById("filterMachine");
    const optionsHtml = '<option value="">選択してください</option>' +
      (data || []).map(m => `<option value="${m.id}">${m.manufacturer} ${m.name}</option>`).join("");
    entrySelect.innerHTML = optionsHtml;
    filterSelect.innerHTML = optionsHtml;
  }

  const taskOptions = {
    "水稲": ["あぜ塗り", "クロぶつし", "起耕", "起耕+基肥散布", "粗代", "本代", "ロール運搬", "その他"],
    "そば": ["起耕", "起耕+基肥散布", "その他"],
    "保全会": ["ハンマーモア(春作業)", "ハンマーモア(秋作業)", "スライドモア(春作業)", "スライドモア(秋作業)", "その他"],
    "小規模工事": ["整地", "掘削", "埋戻し", "土砂運搬", "その他"],
    "その他": ["その他"]
  };

  document.getElementById("categorySelect").addEventListener("change", function () {
    const taskSelect = document.getElementById("taskSelect");
    taskSelect.innerHTML = "";
    (taskOptions[this.value] || []).forEach(task => {
      const option = document.createElement("option");
      option.value = task;
      option.textContent = task;
      taskSelect.appendChild(option);
    });
  });

  document.getElementById("machineSelect").addEventListener("change", async function () {
    if (!this.value) return;
    const { data } = await client.from("hour_logs").select("end_hour").eq("machine_id", this.value).order("date", { ascending: false }).order("created_at", { ascending: false }).limit(1);
    if (data && data[0]) {
      document.getElementById("hourBefore").value = data[0].end_hour;
      calculate();
    }
  });

  function calculate() {
    const before = parseFloat(document.getElementById("hourBefore").value) || 0;
    const after = parseFloat(document.getElementById("hourAfter").value) || 0;
    const diff = after - before;
    const diffElement = document.getElementById("hourDiffDisplay");
    diffElement.textContent = `稼働時間: ${diff.toFixed(1)} h`;
    diffElement.classList.toggle("text-red-500", diff < 0);
    return diff;
  }
  document.getElementById("hourAfter").addEventListener("input", calculate);

  // 保存
  document.getElementById("saveBtn").onclick = async function () {
    const machineId = document.getElementById("machineSelect").value;
    const hAfter = parseFloat(document.getElementById("hourAfter").value);
    const operator = document.getElementById("operatorSelect").value;
    if (!machineId || isNaN(hAfter) || operator === "選択してください") {
      alert("必須項目を入力してください"); return;
    }
    const { error } = await client.from("hour_logs").insert([{
      machine_id: machineId,
      date: document.getElementById("workDate").value,
      operator: operator,
      category: document.getElementById("categorySelect").value,
      task: document.getElementById("taskSelect").value,
      start_hour: parseFloat(document.getElementById("hourBefore").value) || 0,
      end_hour: hAfter,
      memo: document.getElementById("memoInput").value
    }]);
    if (error) alert("保存失敗: " + error.message);
    else {
      showSavePopup();
      setTimeout(() => location.reload(), 1800);
    }
  };

  function showSavePopup() {
    const p = document.getElementById("savePopup");
    p.classList.remove("hidden"); p.classList.add("fade-in");
    setTimeout(() => {
      p.classList.replace("fade-in", "fade-out");
      setTimeout(() => p.classList.add("hidden"), 300);
    }, 1500);
  }

  // ログ描画
  function renderLogs(data, elementId) {
    const list = document.getElementById(elementId);
    list.innerHTML = data?.length ? "" : "<p class='text-center text-gray-400'>データがありません</p>";
    data?.forEach(log => {
      const diff = (log.end_hour - log.start_hour).toFixed(1);
      list.innerHTML += `
        <div class="mx-2 card border-l-4 border-[#6b8f71] relative mb-4">
          <button onclick="openDeleteModal(${log.id})" class="absolute top-3 right-4 text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
          <div class="flex justify-between items-start mb-2">
            <span class="text-xs font-bold text-gray-400">${log.date}</span>
            <span class="bg-[#f7f4ef] text-[#6b8f71] px-2 py-1 rounded text-xs font-bold mr-6">${diff} h</span>
          </div>
          <div class="font-bold text-gray-700">${log.machines?.name || '不明'} / ${log.operator}</div>
          <div class="text-sm text-gray-500">${log.category} - ${log.task}</div>
          ${log.memo ? `<div class="text-xs mt-2 text-gray-400 bg-gray-50 p-2 rounded">${log.memo}</div>` : ""}
        </div>`;
    });
  }

  async function loadTodayLogs() {
    const today = new Date().toISOString().split("T")[0];
    const { data } = await client.from("hour_logs").select("*, machines(name)").eq("date", today).order("created_at", { ascending: false });
    renderLogs(data, "todayLogList");
  }

  async function loadHistoryLogs() {
    let query = client.from("hour_logs").select("*, machines(name)");
    const month = document.getElementById("filterMonth").value;
    const day = document.getElementById("filterDay").value;
    const op = document.getElementById("filterOperator").value;
    const mach = document.getElementById("filterMachine").value;
    const task = document.getElementById("filterTask")?.value || "すべて";

    if (day) query = query.eq("date", day);
    else if (month) query = query.gte("date", `${month}-01`).lte("date", `${month}-31`);
    if (op !== "すべて") query = query.eq("operator", op);
    if (mach) query = query.eq("machine_id", mach);
    if (task !== "すべて") query = query.eq("task", task);

    const { data } = await query.order("date", { ascending: false });
    renderLogs(data, "historyLogList");
    const total = (data || []).reduce((sum, log) => sum + (log.end_hour - log.start_hour), 0);
    document.getElementById("historyTotalHours").textContent = `合計: ${total.toFixed(1)} h`;
  }

  async function loadTaskFilterOptions() {
    const { data } = await client.from("hour_logs").select("task");
    const uniqueTasks = [...new Set(data?.map(i => i.task))];
    const select = document.getElementById("filterTask");
    select.innerHTML = '<option value="すべて">すべて</option>';
    uniqueTasks.forEach(t => { if(t){ const o = document.createElement("option"); o.value=t; o.textContent=t; select.appendChild(o); }});
  }

  // ダッシュボード表示
  async function loadDashboard() {
    const grid = document.getElementById("tractorGrid");
    const top3List = document.getElementById("top3List");
    const totalDisplay = document.getElementById("totalMonthHours");
    
    grid.innerHTML = "";
    top3List.innerHTML = "";

    const { data: machines } = await client.from("machines").select("*").order("manufacturer");
    const { data: logs } = await client.from("hour_logs").select("*, machines(name, manufacturer)");

    const now = new Date();
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
    const monthLogs = logs.filter(l => l.date >= firstDay);
    const totalMonthHours = monthLogs.reduce((s, l) => s + (l.end_hour - l.start_hour), 0);
    totalDisplay.innerHTML = `${totalMonthHours.toFixed(1)}<span class="text-5xl ml-4 font-bold opacity-90">h</span>`;

    const stats = machines.map(m => {
      const mLogs = monthLogs.filter(l => l.machine_id === m.id);
      const hours = mLogs.reduce((s, l) => s + (l.end_hour - l.start_hour), 0);
      return { ...m, hours };
    }).sort((a, b) => b.hours - a.hours);

    // TOP3の表示
    stats.slice(0, 3).forEach((m, i) => {
      const colors = ['text-yellow-500', 'text-gray-400', 'text-amber-600'];
      top3List.innerHTML += `
        <div class="text-center p-4 bg-gray-50 rounded-xl border-b-4 border-gray-200">
          <p class="text-xs font-black ${colors[i]} uppercase">Rank ${i+1}</p>
          <p class="font-bold text-gray-700 truncate text-sm">${m.name}</p>
          <p class="text-2xl font-black text-gray-800">${m.hours.toFixed(1)}<span class="text-xs ml-1">h</span></p>
        </div>`;
    });

    // 各機械のカード
    stats.forEach(m => {
      const card = document.createElement("div");
      card.className = "bg-white rounded-xl p-6 shadow-md border border-gray-100 flex flex-col items-center hover:shadow-2xl transition-all";
      const target = 300;
      const percent = Math.min(100, (m.hours / target) * 100);

      card.innerHTML = `
        <div class="relative w-full h-32 flex justify-center mb-6">
          <canvas id="chart-${m.id}"></canvas>
          <div class="absolute inset-0 flex flex-col items-center justify-center pt-4">
            <div class="flex items-baseline">
              <span class="text-3xl font-black text-gray-800">${m.hours.toFixed(1)}</span>
              <span class="text-sm ml-1 font-bold text-gray-400">h</span>
            </div>
          </div>
        </div>
        <div class="w-full text-center">
          <p class="text-[10px] font-black text-[#6b8f71] uppercase tracking-[0.2em] mb-1">${m.manufacturer}</p>
          <h4 class="text-lg font-bold text-gray-800 leading-tight mb-4">${m.name}</h4>
          <div class="w-full bg-gray-100 h-1 rounded-full overflow-hidden">
            <div class="bg-[#6b8f71] h-full rounded-full transition-all duration-1000" style="width: ${percent}%"></div>
          </div>
        </div>`;
      grid.appendChild(card);

      requestAnimationFrame(() => {
        const canvas = document.getElementById(`chart-${m.id}`);
        if (!canvas) return;
        new Chart(canvas.getContext("2d"), {
          type: 'doughnut',
          data: {
            datasets: [{
              data: [m.hours, Math.max(0.1, target - m.hours)],
              backgroundColor: ['#6b8f71', '#f3f4f6'],
              borderWidth: 0,
              cutout: '85%'
            }]
          },
          options: {
            rotation: -120, circumference: 240,
            plugins: { legend: { display: false }, tooltip: { enabled: false } },
            maintainAspectRatio: false
          }
        });
      });
    });
  }

  // 削除モーダル
  function openDeleteModal(id) {
    deleteTargetId = id;
    document.getElementById("deleteModal").classList.remove("hidden");
  }
  document.getElementById("cancelDelete").onclick = () => document.getElementById("deleteModal").classList.add("hidden");
  document.getElementById("confirmDelete").onclick = async () => {
    await client.from("hour_logs").delete().eq("id", deleteTargetId);
    document.getElementById("deleteModal").classList.add("hidden");
    loadTodayLogs(); loadHistoryLogs();
  };

  if ("serviceWorker" in navigator) navigator.serviceWorker.register('/tractorlog/sw.js');
</script>
</body>
</html>