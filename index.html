<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex">
  <link rel="manifest" href="/tractorlog/manifest.json">
  <title>和農日向 Tractor Log</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* --- 基本設定 --- */
    body { background-color: #f7f4ef; color: #3a3a3a; font-family: "Hiragino Sans", "Noto Sans JP", sans-serif; margin: 0; padding: 0; }
    body.dark-mode { background: #1a1c1e; color: #e0e0e0; }

    /* 表示の切り替え */
    .view { display: none; }
    .view.active { display: block; }

    /* サイドメニュー（スライド式） */
    #sideMenu { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: white; z-index: 9999; transition: left 0.3s ease; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
    body.dark-mode #sideMenu { background-color: #1a1a1a; color: #e0e0e0; }
    #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 9998; display: none; }

    /* --- BIダッシュボード専用デザイン --- */
    #dashboard.active { display: flex !important; } /* DashboardのみFlexレイアウト */
    #dashboard { height: 100vh; background-color: #e2e8e3; overflow: hidden; }
    body.dark-mode #dashboard { background-color: #121412; }

    .bi-sidebar { width: 240px; background: #2d4031; color: white; height: 100vh; flex-shrink: 0; padding-top: 20px; }
    .bi-nav-item { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; opacity: 0.7; font-weight: bold; }
    .bi-nav-item.active { background: rgba(255,255,255,0.1); opacity: 1; border-left: 4px solid #a3b18a; }

    .bi-content-wrapper { flex: 1; display: flex; padding: 20px; gap: 20px; overflow-y: auto; }
    .bi-main-col { flex: 1; display: flex; flex-direction: column; gap: 15px; min-width: 0; }
    .bi-right-col { width: 300px; display: flex; flex-direction: column; gap: 15px; flex-shrink: 0; }

    /* カード・KPI */
    .bi-card { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    body.dark-mode .bi-card { background: rgba(45, 45, 45, 0.8); color: #fff; }
    .kpi-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
    .kpi-card { background: #6b8f71; color: white; padding: 12px; border-radius: 30px; text-align: center; }
    .kpi-card .val { font-size: 18px; font-weight: 900; }

    /* ドーナツ中央アイコン用 */
    .chart-wrapper { position: relative; height: 100px; }
    .chart-icon-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #6b8f71; font-size: 18px; pointer-events: none; }

    /* 汎用カード（入力画面等） */
    .card { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); margin-bottom: 16px; }
    body.dark-mode .card { background: #2d2d2d; }
    .btn-main { background-color: #6b8f71; color: white; padding: 14px; border-radius: 10px; text-align: center; font-weight: bold; width: 100%; display: block; }

    /* モバイルレスポンシブ（ダッシュボード） */
    @media (max-width: 1024px) {
      .bi-sidebar { display: none; }
      #dashboard { flex-direction: column; overflow-y: auto; height: auto; }
      .bi-content-wrapper { flex-direction: column; }
      .bi-right-col { width: 100%; }
      .kpi-row { grid-template-columns: repeat(3, 1fr); }
    }
  </style>
</head>
<body>

<div id="overlay"></div>

<div id="sideMenu">
  <div class="flex justify-between items-center mb-8">
    <h2 class="font-bold text-xl text-[#6b8f71]">メニュー</h2>
    <button id="closeMenuBtn" style="font-size: 32px; color: #aaa;">&times;</button>
  </div>
  <nav class="space-y-2">
    <button onclick="switchView('inputView')" class="w-full text-left p-4 hover:bg-gray-100 rounded-lg font-bold text-[#6b8f71] flex items-center"><i class="fa-solid fa-pen-to-square mr-3"></i>ログ入力</button>
    <button onclick="switchView('todayView')" class="w-full text-left p-4 hover:bg-gray-100 rounded-lg font-bold text-[#6b8f71] flex items-center"><i class="fa-solid fa-calendar-day mr-3"></i>本日の稼働状況</button>
    <button onclick="switchView('historyView')" class="w-full text-left p-4 hover:bg-gray-100 rounded-lg font-bold text-[#6b8f71] flex items-center"><i class="fa-solid fa-magnifying-glass mr-3"></i>稼働履歴</button>
    <button onclick="switchView('dashboard')" class="w-full text-left p-4 hover:bg-gray-100 rounded-lg font-bold text-[#6b8f71] flex items-center"><i class="fa-solid fa-chart-line mr-3"></i>DASHBOARD</button>
    <button onclick="toggleDarkMode()" class="w-full text-left p-4 hover:bg-gray-100 rounded-lg font-bold text-[#6b8f71] flex items-center"><i class="fa-solid fa-moon mr-3"></i>モード切替</button>
  </nav>
</div>

<div id="mainContainer">
  <header id="pageHeader" class="flex flex-col items-center justify-center py-8 relative">
    <button id="menuBtn" class="absolute left-4 top-4 text-3xl text-[#6b8f71] p-2"><i class="fa-solid fa-bars"></i></button>
    <i class="fa-solid fa-tractor text-6xl text-[#6b8f71] mb-2"></i>
    <h1 class="text-xl font-bold text-[#6b8f71]">和農日向 Tractor log</h1>
  </header>

  <div id="inputView" class="view active px-4 max-w-xl mx-auto pb-10">
    <div class="card"><label class="block text-xs font-bold text-gray-400 mb-1">機械を選択</label><select id="machineSelect" class="w-full p-3 border rounded-lg bg-white outline-none"></select></div>
    <div class="card"><label class="block text-xs font-bold text-gray-400 mb-1">作業日</label><input type="date" id="workDate" class="w-full p-3 border rounded-lg outline-none" /></div>
    <div class="card"><label class="block text-xs font-bold text-gray-400 mb-1">オペレーター</label><select id="operatorSelect" class="w-full p-3 border rounded-lg outline-none"><option>選択してください</option><option>阿曽 千一</option><option>阿曽 右貢</option><option>菅原 亜美</option><option>土井 達也</option><option>阿曽 文平</option><option>田中 武志</option><option>赤塚 かおり</option><option>土門 元義</option><option>その他</option></select></div>
    <div class="card"><label class="block text-xs font-bold text-gray-400 mb-1">種別</label><select id="categorySelect" class="w-full p-3 border rounded-lg outline-none"><option value="">選択してください</option><option value="水稲">水稲</option><option value="そば">そば</option><option value="保全会">保全会</option><option value="小規模工事">小規模工事</option><option value="その他">その他</option></select></div>
    <div class="card"><label class="block text-xs font-bold text-gray-400 mb-1">作業内容</label><select id="taskSelect" class="w-full p-3 border rounded-lg outline-none"></select></div>
    <div class="card"><div class="flex space-x-4"><div><label class="block text-xs font-bold text-gray-400 mb-1">稼働前</label><input type="number" id="hourBefore" class="w-full p-3 border rounded-lg" step="0.1" /></div><div><label class="block text-xs font-bold text-gray-400 mb-1">稼働後</label><input type="number" id="hourAfter" class="w-full p-3 border rounded-lg" step="0.1" /></div></div></div>
    <div id="hourDiffDisplay" class="text-right font-black text-[#6b8f71] mb-6 text-xl">稼働時間: 0.0 h</div>
    <div class="card"><label class="block text-xs font-bold text-gray-400 mb-1">給油量 (L)</label><input type="number" id="fuelAmount" class="w-full p-3 border rounded-lg" placeholder="給油した場合のみ" /></div>
    <div class="card"><label class="block text-xs font-bold text-gray-400 mb-1">メモ</label><textarea id="memoInput" class="w-full p-3 border rounded-lg" rows="2"></textarea></div>
    <button id="saveBtn" class="btn-main">ログを保存する</button>
  </div>

  <div id="todayView" class="view px-4 max-w-xl mx-auto">
    <h2 class="text-xl font-bold text-[#6b8f71] mb-4">本日の稼働状況</h2>
    <div id="todayLogList" class="space-y-4"></div>
  </div>
  <div id="historyView" class="view px-4 max-w-xl mx-auto">
    <h2 class="text-xl font-bold text-[#6b8f71] mb-4">稼働履歴</h2>
    <div id="historyLogList" class="space-y-4"></div>
  </div>

  <div id="dashboard" class="view">
    <div class="bi-sidebar">
      <div class="px-8 mb-10"><i class="fa-solid fa-chart-line text-3xl text-[#a3b18a]"></i></div>
      <div class="bi-nav-item active" onclick="switchView('dashboard')"><i class="fa-solid fa-gauge-high mr-3"></i>DASHBOARD</div>
      <div class="bi-nav-item" onclick="switchView('inputView')"><i class="fa-solid fa-pen-to-square mr-3"></i>INPUT</div>
      <div class="bi-nav-item" onclick="toggleDarkMode()"><i class="fa-solid fa-moon mr-3"></i>DARK MODE</div>
    </div>
    
    <div class="bi-content-wrapper">
      <div class="bi-main-col">
        <div id="machineTabs" class="flex gap-2 overflow-x-auto no-scrollbar pb-2"></div>
        
        <div class="kpi-row">
          <div class="kpi-card">
            <p class="text-[10px] opacity-80 uppercase">Hours</p>
            <p class="val" id="kpi-hours">0.0</p>
          </div>
          <div class="kpi-card">
            <p class="text-[10px] opacity-80 uppercase">Fuel</p>
            <p class="val" id="kpi-fuel">0</p>
          </div>
          <div class="kpi-card">
            <p class="text-[10px] opacity-80 uppercase">L/h</p>
            <p class="val" id="kpi-avg">0.0</p>
          </div>
          <div class="kpi-card">
            <p class="text-[10px] opacity-80 uppercase">Days</p>
            <p class="val" id="kpi-days">0</p>
          </div>
          <div class="kpi-card bg-[#4a6b50]">
            <p class="text-[10px] opacity-80 uppercase">Maint</p>
            <p class="val">OK</p>
          </div>
        </div>

        <div class="flex flex-col lg:flex-row gap-4">
          <div class="w-full lg:w-40 flex flex-col gap-4">
            <div class="bi-card">
              <p class="text-[10px] font-bold text-[#6b8f71] mb-2">作物</p>
              <div class="chart-wrapper"><canvas id="categoryShareChart"></canvas><i class="fa-solid fa-wheat-awn chart-icon-center"></i></div>
            </div>
            <div class="bi-card">
              <p class="text-[10px] font-bold text-[#6b8f71] mb-2">工程</p>
              <div class="chart-wrapper"><canvas id="taskShareChart"></canvas><i class="fa-solid fa-gears chart-icon-center"></i></div>
            </div>
            <div class="bi-card">
              <p class="text-[10px] font-bold text-[#6b8f71] mb-2">担当</p>
              <div class="chart-wrapper"><canvas id="operatorShareChart"></canvas><i class="fa-solid fa-user chart-icon-center"></i></div>
            </div>
          </div>
          <div class="flex-1 flex flex-col gap-4">
            <div class="bi-card h-52">
              <p class="text-xs font-bold mb-2">月別稼働推移</p>
              <canvas id="detailChart"></canvas>
            </div>
            <div class="bi-card flex-1">
              <p class="text-xs font-bold mb-2">作業内容分析</p>
              <canvas id="gradientBarChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="bi-right-col">
        <div class="bi-card text-center">
          <p class="text-xs font-bold mb-4 text-[#6b8f71]">前年同期比 (YoY)</p>
          <div class="h-28 relative"><canvas id="yearComparisonGauge"></canvas></div>
          <p id="detailCompareValue" class="text-2xl font-black mt-[-20px] text-[#6b8f71]">--%</p>
        </div>
        <div class="bi-card flex-1 overflow-hidden">
          <p class="text-xs font-bold mb-4">メンテナンス履歴</p>
          <div class="space-y-3 text-xs opacity-70">
            <p>2026-01-10 オイル交換</p>
            <p>2025-12-15 爪交換</p>
            <p>2025-11-20 洗車・点検</p>
          </div>
        </div>
        <button onclick="switchView('inputView')" class="btn-main">TOPへ戻る</button>
      </div>
    </div>
  </div>
</div>

<div id="savePopup" class="hidden fixed inset-0 flex items-center justify-center z-[10001]"><div class="px-6 py-3 rounded-lg text-white bg-[#2f5d3a] shadow-xl font-bold">保存しました</div></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const SUPABASE_URL = "https://txsqxnwgolybcdclazdx.supabase.co";
  const SUPABASE_KEY = "sb_publishable_8JEM6Yyg5_oQpF-grdaxIw_rrxZBQYj";
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let currentMachineId = null;
  window.charts = {};

  // --- メニュー操作 ---
  const sideMenu = document.getElementById("sideMenu");
  const overlay = document.getElementById("overlay");
  
  function openMenu() { sideMenu.style.left = "0px"; overlay.style.display = "block"; }
  function closeMenu() { sideMenu.style.left = "-280px"; overlay.style.display = "none"; }

  document.getElementById("menuBtn").onclick = openMenu;
  document.getElementById("closeMenuBtn").onclick = closeMenu;
  overlay.onclick = closeMenu;

  // --- 画面切り替え ---
  function switchView(id) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    
    const header = document.getElementById("pageHeader");
    if (id === 'dashboard') {
      header.style.display = 'none';
      loadDashboardData();
    } else {
      header.style.display = 'flex';
    }
    closeMenu();
    if (id === 'todayView') loadTodayLogs();
    if (id === 'historyView') loadHistoryLogs();
  }

  // --- 初期化 ---
  document.addEventListener("DOMContentLoaded", async () => {
    if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
    await loadMachines();
    const now = new Date();
    document.getElementById("workDate").value = new Date(now.getTime() + 9*60*60*1000).toISOString().split('T')[0];
  });

  async function loadMachines() {
    const { data } = await client.from("machines").select("*").order("name");
    const select = document.getElementById("machineSelect");
    select.innerHTML = '<option value="">選択してください</option>' + data.map(m => `<option value="${m.id}">${m.name}</option>`).join("");
    
    // ダッシュボード用タブ
    const tabs = document.getElementById("machineTabs");
    tabs.innerHTML = data.map(m => `<button onclick="renderMachineDetail(${m.id}, '${m.name}')" class="px-4 py-2 bg-white rounded-full text-xs font-bold shadow-sm whitespace-nowrap">${m.name}</button>`).join("");
  }

  // 作業内容の連動
  const taskOptions = { "水稲": ["あぜ塗り", "起耕", "粗代", "本代", "ロール運搬", "その他"], "そば": ["起耕", "その他"], "保全会": ["ハンマーモア", "スライドモア", "その他"], "小規模工事": ["整地", "掘削", "その他"], "その他": ["その他"] };
  document.getElementById("categorySelect").onchange = function() {
    document.getElementById("taskSelect").innerHTML = (taskOptions[this.value] || []).map(t => `<option value="${t}">${t}</option>`).join("");
  };

  // 稼働時間計算
  document.getElementById("hourAfter").oninput = () => {
    const diff = (parseFloat(document.getElementById("hourAfter").value) || 0) - (parseFloat(document.getElementById("hourBefore").value) || 0);
    document.getElementById("hourDiffDisplay").textContent = `稼働時間: ${diff.toFixed(1)} h`;
  };

  // 保存
  document.getElementById("saveBtn").onclick = async () => {
    const mId = document.getElementById("machineSelect").value;
    const hA = parseFloat(document.getElementById("hourAfter").value);
    if (!mId || isNaN(hA)) return alert("入力してください");

    const { error } = await client.from("hour_logs").insert([{
      machine_id: mId, date: document.getElementById("workDate").value, operator: document.getElementById("operatorSelect").value,
      category: document.getElementById("categorySelect").value, task: document.getElementById("taskSelect").value,
      start_hour: parseFloat(document.getElementById("hourBefore").value) || 0, end_hour: hA,
      fuel_amount: parseFloat(document.getElementById("fuelAmount").value) || 0, memo: document.getElementById("memoInput").value
    }]);

    if (!error) {
      document.getElementById("savePopup").classList.remove("hidden");
      setTimeout(() => location.reload(), 1500);
    }
  };

  // --- ダッシュボード描画ロジック ---
  async function loadDashboardData() {
    const { data } = await client.from("machines").select("*").limit(1);
    if (data[0]) renderMachineDetail(data[0].id, data[0].name);
  }

  async function renderMachineDetail(mId, mName) {
    currentMachineId = mId;
    const { data: logs } = await client.from("hour_logs").select("*").eq("machine_id", mId);
    const logs26 = logs.filter(l => l.date.startsWith("2026"));
    const logs25 = logs.filter(l => l.date.startsWith("2025"));

    const totalH = logs26.reduce((s,l) => s + (l.end_hour - l.start_hour), 0);
    const totalF = logs26.reduce((s,l) => s + (l.fuel_amount || 0), 0);
    
    document.getElementById("kpi-hours").innerText = totalH.toFixed(1);
    document.getElementById("kpi-fuel").innerText = Math.floor(totalF);
    document.getElementById("kpi-avg").innerText = totalH > 0 ? (totalF/totalH).toFixed(1) : "0.0";
    document.getElementById("kpi-days").innerText = new Set(logs26.map(l => l.date)).size;

    drawCharts(logs26, logs25);
  }

  function drawCharts(logs26, logs25) {
    Object.values(window.charts).forEach(c => { if(c) c.destroy(); });
    const ctxLine = document.getElementById('detailChart').getContext('2d');
    window.charts.line = new Chart(ctxLine, { type: 'line', data: { labels: ['4','5','6','7','8','9','10'], datasets: [{ label:'h', data:[10,40,65,30,20,80,10], borderColor:'#6b8f71', tension:0.4 }] }, options: { maintainAspectRatio:false } });

    const donutCfg = { type: 'doughnut', options: { cutout:'70%', plugins:{legend:{display:false}} } };
    window.charts.c1 = new Chart(document.getElementById('categoryShareChart'), { ...donutCfg, data:{ datasets:[{data:[60,40], backgroundColor:['#2d4031','#a3b18a']}] } });
    window.charts.c2 = new Chart(document.getElementById('taskShareChart'), { ...donutCfg, data:{ datasets:[{data:[30,70], backgroundColor:['#6b8f71','#dad7cd']}] } });
    window.charts.c3 = new Chart(document.getElementById('operatorShareChart'), { ...donutCfg, data:{ datasets:[{data:[50,50], backgroundColor:['#588157','#6b8f71']}] } });

    const ctxGauge = document.getElementById('yearComparisonGauge').getContext('2d');
    window.charts.gauge = new Chart(ctxGauge, { type:'doughnut', data:{ datasets:[{data:[75,25], backgroundColor:['#6b8f71','#eee']}] }, options:{ rotation:-90, circumference:180, cutout:'80%', plugins:{legend:{display:false}} } });
    document.getElementById("detailCompareValue").innerText = "75%";
  }

  function toggleDarkMode() {
    const isDark = document.body.classList.toggle('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    closeMenu();
  }

  async function loadTodayLogs() { /* 履歴描画ロジック */ }
</script>
</body>
</html>