<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <script src="config.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex">
  <link rel="manifest" href="./manifest.json">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;900&family=Space+Grotesk:wght@400;600;700&family=Zen+Kaku+Gothic+New:wght@400;500;700;900&display=swap"
    rel="stylesheet">
  <title>和農日向 機械管理App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <style>
    /* --- CSS変数でカラーテーマを管理 --- */
    :root {
      /* トラクターセクションのテーマカラー */
      --tractor-color: #6b8f71;
      --tractor-hover: #5a7760;
      --tractor-light: #f0f7f1;

      /* 田植え機セクションのテーマカラー */
      --planting-color: #c9a961;
      --planting-hover: #b8985a;
      --planting-dark: #a08550;
      --planting-bg: #faf8f0;

      /* コンバインセクションのテーマカラー */
      --combine-color: #c97c73;
      --combine-hover: #b86b62;
      --combine-dark: #a85a52;
      --combine-light: #f8e8e6;
      --combine-bg: #faf5f4;

      /* エクスポートセクションのテーマカラー */
      --export-color: #808000;
      --export-hover: #666600;
      --export-light: #fef9c3;
      --export-bg: #fefce8;

      /* 修理セクションのテーマカラー */
      --repair-color: #9b7cb6;
      --repair-hover: #826a9a;
      --repair-light: #ede9fe;
      --repair-bg: #f7f6fb;

      /* バージョン情報のテーマカラー */
      --version-color: #7e837f;
      --version-hover: #696d6a;
      --version-light: #f1f5f9;
      --version-bg: #f8fafc;

      /* メンテナンスセクションのテーマカラー */
      --maintenance-color: #483D8B;
      --maintenance-hover: #3a2f6f;
      --maintenance-light: #e0f2f2;
      --maintenance-bg: #f0f9f9;

      /* その他の機械セクションのテーマカラー */
      --other-color: #006888;
      --other-hover: #005270;
      --other-dark: #003d52;
      --other-light: #e0f2f7;
      --other-bg: #f0f8fa;

      /* ラップマシーンセクションのテーマカラー */
      --wrapper-color: #6b395f;
      --wrapper-hover: #552e4c;
      --wrapper-light: #f3ebf1;
      --wrapper-bg: #faf7f9;
    }

    /* --- 基本スタイル --- */
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      color: #3a3a3a;
      font-family: "Hiragino Sans", "Noto Sans JP", sans-serif;
      min-height: 100vh;
    }

    /* メンテナンス画面表示時の背景色 */
    html:has(#maintenanceDetailView.active),
    html:has(#maintenanceMachineListView.active),
    body:has(#maintenanceDetailView.active),
    body:has(#maintenanceMachineListView.active) {
      background-color: #faf8f3 !important;
    }

    /* ラップマシーンメンテナンス画面表示時の背景色 */
    html:has(#maintenanceMachineListViewWrapper.active),
    html:has(#maintenanceDetailViewWrapper.active),
    body:has(#maintenanceMachineListViewWrapper.active),
    body:has(#maintenanceDetailViewWrapper.active) {
      background-color: #faf8f3 !important;
    }

    .view {
      display: none;
      min-height: 100vh;
    }

    .view.active {
      display: block;
    }

    .view.fullscreen-view {
      min-height: 100vh;
    }

    #mainContainer {
      margin: 0;
      padding: 0;
    }

    /* メンテナンス画面のmainContainer背景 */
    #mainContainer:has(#maintenanceDetailView.active),
    #mainContainer:has(#maintenanceMachineListView.active) {
      background-color: #f0f7f1 !important;
    }

    /* PC表示時にサイドバーがある場合の調整 */
    @media (min-width: 1024px) {
      body.show-sidebar .view.active {
        display: block;
      }
    }

    .sideMenu,
    #sideMenu,
    #tractorSideMenu,
    #plantingSideMenu,
    #combineSideMenu,
    #otherMachinerySideMenu,
    #repairSideMenu {
      position: fixed;
      top: 0;
      left: -280px;
      width: 280px;
      height: 100%;
      background: white;
      z-index: 9999;
      transition: left 0.3s ease;
      padding: 20px;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
    }

    /* PC表示時：サイドバーを常時表示（データ分析ページを除く） */
    @media (min-width: 1024px) {

      /* アクティブなメニューのみ表示 */
      body.show-sidebar .sideMenu.active-menu,
      body.show-sidebar #sideMenu.active-menu,
      body.show-sidebar #tractorSideMenu.active-menu,
      body.show-sidebar #plantingSideMenu.active-menu,
      body.show-sidebar #combineSideMenu.active-menu,
      body.show-sidebar #otherMachinerySideMenu.active-menu,
      body.show-sidebar #repairSideMenu.active-menu {
        left: 0;
      }

      /* サイドバー表示時にコンテンツにマージンを適用 */
      body.show-sidebar #mainContainer {
        margin-left: 280px;
        margin-right: 0;
      }

      /* サイドバー表示時、各viewのmax-widthコンテナを適切に配置 */
      body.show-sidebar .view.active>div {
        margin-left: auto;
        margin-right: auto;
      }

      body.show-sidebar #overlay {
        display: none !important;
      }

      /* PC表示時にサイドメニューの×ボタンを非表示 */
      body.show-sidebar .close-menu-btn {
        display: none;
      }

      /* ハンバーガーメニューボタンをPC表示時は非表示 */
      body.show-sidebar .view.active header button[onclick="openMenu()"],
      body.show-sidebar .view.active .bi-header button[onclick="openMenu()"] {
        display: none;
      }
    }

    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: 9998;
      display: none;
    }

    .menu-item {
      width: 100%;
      text-align: left;
      padding: 0.8rem;
      border-radius: 0.5rem;
      font-weight: bold;
      color: #6b8f71;
      display: flex;
      align-items: center;
      font-size: 0.9rem;
    }

    #plantingSideMenu .menu-item {
      color: var(--planting-color);
    }

    #combineSideMenu .menu-item {
      color: var(--combine-color);
    }

    #maintenanceSideMenu .menu-item {
      color: var(--maintenance-color);
    }

    #exportSideMenu .menu-item {
      color: var(--export-color);
    }

    #versionSideMenu .menu-item {
      color: var(--version-color);
    }

    #otherMachinerySideMenu .menu-item {
      color: var(--other-color);
    }

    #repairSideMenu .menu-item {
      color: var(--repair-color);
    }

    select,
    input,
    textarea {
      color: #3a3a3a !important;
      background-color: #ffffff !important;
      border: 1px solid #ddd;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 6px 16px rgba(107, 143, 113, 0.10);
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }

    /* Override Tailwind shadows to use a greenish-gray tint for cards */
    .shadow-sm {
      box-shadow: 0 4px 10px rgba(107, 143, 113, 0.06) !important;
    }

    .shadow {
      box-shadow: 0 8px 22px rgba(107, 143, 113, 0.10) !important;
    }

    .btn-main {
      color: white;
      padding: 14px;
      border-radius: 12px;
      text-align: center;
      font-weight: bold;
      width: 100%;
      display: block;
    }

    .btn-sub {
      color: white;
      padding: 12px;
      border-radius: 10px;
      text-align: center;
      font-weight: bold;
      width: 160px;
      max-width: 40%;
      margin: 20px auto 0;
      display: block;
      border: none;
      cursor: pointer;
    }

    /* トラクターセクション用のボタンスタイル */
    #tractor-section .btn-main,
    #todayView .btn-main,
    #historyView .btn-main {
      background-color: var(--tractor-color);
    }

    #tractor-section .btn-main:hover,
    #todayView .btn-main:hover,
    #historyView .btn-main:hover {
      background-color: var(--tractor-hover);
    }

    #tractor-section .btn-sub,
    #todayView .btn-sub,
    #historyView .btn-sub {
      background-color: var(--tractor-color);
    }

    #tractor-section .btn-sub:hover,
    #todayView .btn-sub:hover,
    #historyView .btn-sub:hover {
      background-color: var(--tractor-hover);
    }

    /* 移植機セクション用のボタンスタイル */
    #planting-section .btn-main {
      background-color: var(--planting-color);
    }

    #planting-section .btn-main:hover {
      background-color: var(--planting-hover);
    }

    #planting-section .btn-sub,
    #todayViewPlanting .btn-sub,
    #historyViewPlanting .btn-sub {
      background-color: var(--planting-color);
    }

    #planting-section .btn-sub:hover,
    #todayViewPlanting .btn-sub:hover,
    #historyViewPlanting .btn-sub:hover {
      background-color: var(--planting-hover);
    }

    /* コンバインセクション用のボタンスタイル */
    #combine-section .btn-main {
      background-color: var(--combine-color);
    }

    #combine-section .btn-main:hover {
      background-color: var(--combine-hover);
    }

    #combine-section .btn-sub,
    #todayViewCombine .btn-sub,
    #historyViewCombine .btn-sub {
      background-color: var(--combine-color);
    }

    #combine-section .btn-sub:hover,
    #todayViewCombine .btn-sub:hover,
    #historyViewCombine .btn-sub:hover {
      background-color: var(--combine-hover);
    }

    /* メンテナンスセクション用のボタンスタイル（トラクター専用） */
    #maintenanceMachineListView .btn-main,
    #maintenanceDetailView .btn-main {
      background-color: #6b8f71;
    }

    #maintenanceMachineListView .btn-main:hover,
    #maintenanceDetailView .btn-main:hover {
      background-color: #5a7a60;
    }

    #maintenanceMachineListView .btn-sub,
    #maintenanceDetailView .btn-sub {
      background-color: #6b8f71;
    }

    #maintenanceMachineListView .btn-sub:hover,
    #maintenanceDetailView .btn-sub:hover {
      background-color: #5a7a60;
    }

    /* 修理セクション用のボタンスタイル */
    #repair-section .btn-main {
      background-color: var(--repair-color);
    }

    #repair-section .btn-main:hover {
      background-color: var(--repair-hover);
    }

    #repair-section .btn-sub {
      background-color: var(--repair-color);
    }

    #repair-section .btn-sub:hover {
      background-color: var(--repair-hover);
    }

    /* エクスポートビュー用のボタンスタイル */
    #exportView .btn-main {
      background-color: var(--export-color);
    }

    #exportView .btn-main:hover {
      background-color: var(--export-hover);
    }

    #exportView .btn-sub {
      background-color: var(--export-color);
    }

    #exportView .btn-sub:hover {
      background-color: var(--export-hover);
    }

    /* バージョン情報用のボタンスタイル */
    #versionView .btn-main {
      background-color: var(--version-color);
    }

    #versionView .btn-main:hover {
      background-color: var(--version-hover);
    }

    #versionView .btn-sub {
      background-color: var(--version-color);
    }

    #versionView .btn-sub:hover {
      background-color: var(--version-hover);
    }

    /* その他の機械セクション用のボタンスタイル */
    #other-machinery-section .btn-main {
      background-color: var(--other-color);
    }

    #other-machinery-section .btn-main:hover {
      background-color: var(--other-hover);
    }

    #other-machinery-section .btn-sub {
      background-color: var(--other-color);
    }

    #other-machinery-section .btn-sub:hover {
      background-color: var(--other-hover);
    }

    /* dashboardPlanting専用のスタイル（ブルーグリーン系） */
    #dashboardPlanting .bi-header {
      background: var(--planting-dark) !important;
    }

    #dashboardPlanting .kpi-card {
      background: var(--planting-color) !important;
    }

    #dashboardPlanting .chart-title {
      color: var(--planting-color) !important;
    }

    #dashboardPlanting .donut-icon {
      color: var(--planting-color) !important;
    }

    #dashboardPlanting .tab-btn.active {
      background: var(--planting-dark) !important;
    }

    #dashboardPlanting .tab-btn.inactive {
      background: rgba(255, 255, 255, 0.5) !important;
      color: var(--planting-color) !important;
    }

    #dashboardPlanting .nav-item.active {
      border-left-color: var(--planting-color) !important;
    }

    /* 田植え機データ分析 - 2カラムレイアウト */
    #dashboardPlanting .bi-container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
      align-items: start;
    }

    #dashboardPlanting .bi-left-col {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #dashboardPlanting .bi-left-col>.card {
      display: flex;
      flex-direction: column;
    }

    #dashboardPlanting .bi-main-col {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #dashboardPlanting .bi-right-col {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #dashboardPlanting .bi-right-col>.card {
      display: flex;
      flex-direction: column;
    }

    #dashboardPlanting .card .chart-container {
      width: 100%;
      height: 150px;
      padding: 0;
    }

    #dashboardPlanting .card .chart-wrapper {
      width: 100%;
      height: 100%;
      position: relative;
    }

    /* 機械別稼働ランキングカード専用の高さ調整 */
    #dashboardPlanting .bi-left-col>.card:nth-child(3) .chart-container {
      height: 200px !important;
    }

    /* オペレーター別比率カード専用の高さ調整 */
    #dashboardPlanting .operator-card {
      padding: 8px 12px;
      height: 220px !important;
      max-height: 220px;
      overflow: hidden;
    }

    #dashboardPlanting .operator-card .chart-container {
      height: 160px;
    }

    #dashboardPlanting .operator-card .chart-title {
      margin-bottom: 4px;
      font-size: 11px;
    }

    #dashboardPlanting .bi-right-col>.yoy-card {
      flex: 1 1 0% !important;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    #dashboardPlanting .bi-right-col>.maint-card {
      height: 360px !important;
      min-height: 360px;
      max-height: 360px;
      display: flex;
      flex-direction: column;
    }

    #dashboardPlanting .fuel-efficiency-card {
      height: 100px !important;
      min-height: 100px !important;
      max-height: 100px !important;
    }

    #dashboardPlanting #maintenanceLogPlanting {
      flex: 1;
      overflow-y: auto;
    }

    /* スマホ対応：田植え機ダッシュボード */
    @media (max-width: 1024px) {
      #dashboardPlanting .bi-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      #dashboardPlanting .bi-left-col,
      #dashboardPlanting .bi-right-col {
        width: 100%;
      }

      #dashboardPlanting .card {
        min-height: 200px;
      }

      #dashboardPlanting .operator-card {
        height: auto !important;
        min-height: 250px;
        max-height: none;
      }

      #dashboardPlanting .fuel-efficiency-card {
        height: auto !important;
        min-height: 100px;
        max-height: none;
      }

      #dashboardPlanting .maint-card {
        height: auto !important;
        min-height: 200px;
        max-height: none;
      }

      #dashboardPlanting .bi-right-col>.maint-card {
        height: auto !important;
        min-height: 200px;
        max-height: none;
      }
    }


    /* トラクターダッシュボード - グラフ高さ調整 */
    #dashboard .bi-container .card {
      display: flex;
      flex-direction: column;
    }

    #dashboard .bi-container .card>div.relative.h-40 {
      height: 150px !important;
    }

    #dashboard .bi-container .card>div.relative.h-\[480px\] {
      height: 450px !important;
    }

    #dashboard .bi-right-col .card {
      flex: 1;
      min-height: 0;
    }

    #dashboard .bi-right-col .yoy-card {
      display: flex;
      flex-direction: column;
      min-height: 285px;
    }

    #dashboard .bi-right-col .maint-card {
      min-height: 330px;
      max-height: 440px;
      overflow-y: auto;
    }

    #dashboard .bi-left-col {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #dashboard .bi-left-col .card {
      flex: 1;
      min-height: 0;
      max-height: calc((100% - 24px) / 3 * 0.99);
    }

    /* combineView専用の背景色 */
    #tractor-section {
      background-color: #e2e8e3;
      margin: 0;
      padding: 0;
    }

    #tractorView,
    #todayView,
    #historyView {
      background-color: #e2e8e3;
      min-height: 100vh;
    }

    #maintenanceMachineListView,
    #maintenanceDetailView {
      background-color: #faf8f3 !important;
      min-height: 100vh;
    }

    /* モアメンテナンスページの背景 */
    #maintenanceMachineListViewMower,
    #maintenanceDetailViewSpiderMower,
    #maintenanceDetailViewWingMower {
      background-color: #faf8f3 !important;
      min-height: 100vh;
    }

    /* 動力散布機メンテナンスページの背景 */
    #maintenanceMachineListViewSpreader,
    #maintenanceDetailViewSpreader {
      background-color: #faf8f3 !important;
      min-height: 100vh;
    }

    /* トラクターメンテナンスページの全体背景 */
    body:has(#maintenanceDetailView.active) {
      background-color: #faf8f3 !important;
    }

    /* モアメンテナンスページの全体背景 */
    html:has(#maintenanceMachineListViewMower.active),
    html:has(#maintenanceDetailViewSpiderMower.active),
    html:has(#maintenanceDetailViewWingMower.active),
    body:has(#maintenanceMachineListViewMower.active),
    body:has(#maintenanceDetailViewSpiderMower.active),
    body:has(#maintenanceDetailViewWingMower.active) {
      background-color: #faf8f3 !important;
    }

    /* 動力散布機メンテナンスページの全体背景 */
    html:has(#maintenanceMachineListViewSpreader.active),
    html:has(#maintenanceDetailViewSpreader.active),
    body:has(#maintenanceMachineListViewSpreader.active),
    body:has(#maintenanceDetailViewSpreader.active) {
      background-color: #faf8f3 !important;
    }

    /* その他の機械メンテナンスページの背景 */
    #maintenanceMachineListViewOtherMachinery,
    #maintenanceDetailViewOtherMachinery {
      background-color: #faf8f3 !important;
      min-height: 100vh;
    }

    /* その他の機械メンテナンスページの全体背景 */
    html:has(#maintenanceMachineListViewOtherMachinery.active),
    html:has(#maintenanceDetailViewOtherMachinery.active),
    body:has(#maintenanceMachineListViewOtherMachinery.active),
    body:has(#maintenanceDetailViewOtherMachinery.active) {
      background-color: #faf8f3 !important;
    }

    /* インプルメントメンテナンスページの背景 */
    #maintenanceMachineListViewImplement,
    #maintenanceDetailViewImplement {
      background-color: #faf8f3 !important;
      min-height: 100vh;
    }

    html:has(#maintenanceMachineListViewImplement.active),
    html:has(#maintenanceDetailViewImplement.active),
    body:has(#maintenanceMachineListViewImplement.active),
    body:has(#maintenanceDetailViewImplement.active) {
      background-color: #faf8f3 !important;
    }

    /* 刈払い機メンテナンスページの背景 */
    #maintenanceMachineListViewBrushCutter,
    #maintenanceDetailViewBrushCutter {
      background-color: #faf8f3 !important;
      min-height: 100vh;
    }

    html:has(#maintenanceMachineListViewBrushCutter.active),
    html:has(#maintenanceDetailViewBrushCutter.active),
    body:has(#maintenanceMachineListViewBrushCutter.active),
    body:has(#maintenanceDetailViewBrushCutter.active) {
      background-color: #faf8f3 !important;
    }

    /* 噴霧器メンテナンスページの背景 */
    #maintenanceMachineListViewSprayer {
      background-color: #faf8f3 !important;
      min-height: 100vh;
    }

    html:has(#maintenanceMachineListViewSprayer.active),
    body:has(#maintenanceMachineListViewSprayer.active) {
      background-color: #faf8f3 !important;
    }

    /* ラップマシーンメンテナンスページの背景 */
    #maintenanceMachineListViewWrapper,
    #maintenanceDetailViewWrapper {
      background-color: #faf8f3 !important;
      min-height: 100vh;
    }

    #dashboard {
      background-color: #e2e8e3;
    }

    #repair-section {
      background-color: var(--repair-bg);
      margin: 0;
      padding: 0;
    }

    #repairView,
    #invoiceOCRView {
      background-color: var(--repair-bg);
      min-height: 100vh;
    }

    #planting-section {
      background-color: var(--planting-bg);
      margin: 0;
      padding: 0;
    }

    #plantingView,
    #todayViewPlanting,
    #historyViewPlanting,
    #maintenanceMachineListViewPlanting,
    #maintenanceDetailViewPlanting {
      background-color: var(--planting-bg);
      min-height: 100vh;
    }

    #dashboardPlanting {
      background-color: var(--planting-bg);
    }

    #exportView {
      background-color: var(--export-bg);
      min-height: 100vh;
    }

    #versionView {
      background-color: var(--version-bg);
      min-height: 100vh;
    }

    #combine-section {
      background-color: var(--combine-bg);
      margin: 0;
      padding: 0;
    }

    #combineView,
    #todayViewCombine,
    #historyViewCombine,
    #maintenanceMachineListViewCombine,
    #maintenanceDetailViewCombine {
      background-color: var(--combine-bg);
      min-height: 100vh;
    }

    #dashboardCombine {
      background-color: var(--combine-bg);
    }

    /* dashboardCombine専用のスタイル（ゴールド系） */
    #dashboardCombine .bi-header {
      background: var(--combine-dark) !important;
    }

    #dashboardCombine .kpi-card {
      background: var(--combine-color) !important;
    }

    #dashboardCombine .chart-title {
      color: var(--combine-color) !important;
    }

    #dashboardCombine .donut-icon {
      color: var(--combine-color) !important;
    }

    #dashboardCombine .tab-btn.active {
      background: var(--combine-dark) !important;
    }

    #dashboardCombine .tab-btn.inactive {
      background: rgba(255, 255, 255, 0.5) !important;
      color: var(--combine-color) !important;
    }

    #dashboardCombine .nav-item.active {
      border-left-color: var(--combine-color) !important;
    }

    /* コンバインデータ分析の右カラムの高さ調整 */
    #dashboardCombine .bi-right-col .card {
      flex: 1;
      min-height: 0;
    }

    #dashboardCombine .bi-right-col .yoy-card {
      display: flex;
      flex-direction: column;
      min-height: 285px;
    }

    #dashboardCombine .bi-right-col .maint-card {
      min-height: 330px;
      max-height: 440px;
      overflow-y: auto;
    }

    #dashboardCombine .bi-left-col {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #dashboardCombine .bi-left-col .card {
      height: 230px !important;
      min-height: 230px;
      max-height: 230px;
      display: flex;
      flex-direction: column;
    }

    #dashboardCombine .bi-left-col .card .chart-container {
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    #dashboardCombine .bi-left-col .card .chart-wrapper {
      width: 100%;
      height: 100%;
      position: relative;
    }

    #dashboardCombine #maintenanceLogCombine {
      flex: 1;
      overflow-y: auto;
    }

    /* その他の機械ダッシュボード専用のスタイル */
    #dashboardOther .bi-header {
      background: var(--other-dark) !important;
    }

    #dashboardOther .kpi-card {
      background: var(--other-color) !important;
    }

    #dashboardOther .chart-title {
      color: var(--other-color) !important;
    }

    #dashboardOther .donut-icon {
      color: var(--other-color) !important;
    }

    #dashboardOther .tab-btn.active {
      background: var(--other-dark) !important;
    }

    #dashboardOther .tab-btn.inactive {
      background: rgba(255, 255, 255, 0.5) !important;
      color: var(--other-color) !important;
    }

    #dashboardOther .nav-item.active {
      border-left-color: var(--other-color) !important;
    }

    /* その他の機械データ分析の右カラムの高さ調整 */
    #dashboardOther .bi-right-col {
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-self: stretch;
    }

    #dashboardOther .bi-right-col>.yoy-card {
      flex: 1 1 0% !important;
      min-height: 0;
      max-height: 33%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #dashboardOther .yoy-card>div {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    #dashboardOther .bi-right-col>.maint-card {
      flex: 2 2 0% !important;
      min-height: 0;
      max-height: 67%;
      display: flex;
      flex-direction: column;
    }

    #dashboardOther #maintenanceLogOther {
      flex: 1;
      overflow-y: auto;
    }

    .log-badge {
      background-color: #f3f4f6;
      color: #374151;
    }

    #dashboard.active {
      display: flex !important;
      flex-direction: column;
      overflow-x: hidden;
    }

    .bi-header {
      height: 80px;
      display: flex;
      flex-direction: row;
      align-items: center;
      background: #2d4031;
      color: white;
      flex-shrink: 0;
      width: 100%;
      padding: 0 20px;
    }

    .dashboard-top-bar {
      flex-shrink: 0;
      padding: 10px 15px;
    }

    .main-top-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: stretch;
    }

    .kpi-section {
      flex: 1;
      min-width: 320px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .ranking-section {
      flex: 0.4;
      min-width: 250px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 12px;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
    }

    .kpi-card {
      background: var(--tractor-color);
      color: white;
      padding: 8px 2px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .kpi-label {
      font-size: 9px;
      font-weight: bold;
      opacity: 0.9;
    }

    .kpi-value-container {
      display: flex;
      align-items: baseline;
      gap: 1px;
    }

    .kpi-value {
      font-size: 15px;
      font-weight: 900;
    }

    .kpi-unit {
      font-size: 12px;
      opacity: 0.8;
      font-weight: bold;
    }

    .bi-container {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      padding: 12px;
      gap: 12px;
      align-items: stretch;
    }

    .bi-left-col {
      flex: 1.1;
      min-width: 280px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .bi-main-col {
      flex: 1.8;
      min-width: 320px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .bi-right-col {
      flex: 0.8;
      min-width: 280px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-self: stretch;
    }

    .bi-right-col>.yoy-card {
      flex: 1 1 0% !important;
      min-height: 0;
      max-height: 33%;
      display: flex;
      flex-direction: column;
    }

    .bi-right-col>.maint-card {
      flex: 2 2 0% !important;
      min-height: 0;
      max-height: 67%;
      display: flex;
      flex-direction: column;
    }

    #maintenanceLog {
      flex: 1;
      overflow-y: auto;
    }

    @media (max-width: 1024px) {
      .bi-right-col {
        width: 100%;
        flex: 1;
      }
    }

    .bi-container>div>.card {
      margin-bottom: 0 !important;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .chart-title {
      font-size: 14px !important;
      font-weight: bold !important;
      color: var(--tractor-color) !important;
      margin-bottom: 8px;
      display: block;
    }

    .chart-wrapper {
      flex: 1;
      position: relative;
      width: 100%;
      min-height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .donut-icon {
      position: absolute;
      font-size: 24px;
      color: var(--tractor-color);
      opacity: 0.3;
      pointer-events: none;
    }

    #customModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
      padding: 20px;
    }

    #customModal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      width: 100%;
      max-width: 320px;
      border-radius: 20px;
      overflow: hidden;
    }

    .tab-btn {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: bold;
      cursor: pointer;
      white-space: nowrap;
      border: none;
    }

    .tab-btn.active {
      background: #2d4031;
      color: white;
    }

    .tab-btn.inactive {
      background: rgba(255, 255, 255, 0.5);
      color: var(--tractor-color);
    }

    .dashboard-sidebar {
      width: 200px;
      min-width: 200px;
      background: #2d4031;
      color: white;
      height: 100vh;
      position: sticky;
      top: 0;
      display: flex;
      flex-direction: column;
      padding: 20px 0;
    }

    .nav-item {
      width: 100%;
      padding: 15px 20px;
      text-align: left;
      color: rgba(255, 255, 255, 0.7);
      font-size: 13px;
      border: none;
      background: none;
      cursor: pointer;
      transition: 0.3s;
    }

    .nav-item i {
      margin-right: 10px;
    }

    .nav-item.active {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border-left: 4px solid var(--tractor-color);
    }

    .dashboard-main-content {
      overflow-y: auto;
      height: 100vh;
    }

    /* --- Portal view styles --- */
    #portalView {
      display: none;
      margin: 0 !important;
      padding: 0 !important;
      min-height: 100vh !important;
      background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%) !important;
    }

    .portal-hero {
      width: 100%;
      margin: 0;
      border-radius: 0;
      position: relative;
      color: #ffffff;
      padding: 40px;
      background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 60px;
      align-items: center;
      overflow: visible;
      min-height: 100vh;
    }

    .portal-hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(74, 144, 226, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 90% 80%, rgba(138, 43, 226, 0.06) 0%, transparent 50%);
      pointer-events: none;
    }

    .portal-title {
      font-family: 'Zen Kaku Gothic New', sans-serif;
      font-size: 56px;
      font-weight: 900;
      letter-spacing: -0.02em;
      line-height: 1.1;
      margin-bottom: 16px;
      background: linear-gradient(135deg, #ffffff 0%, #a0d8d8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .portal-subtitle {
      font-family: 'Zen Kaku Gothic New', sans-serif;
      font-size: 13px;
      font-weight: 400;
      letter-spacing: 0.05em;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 32px;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .portal-description {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 14px;
      line-height: 1.8;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 24px;
    }

    .portal-author {
      font-family: 'Space Grotesk', monospace;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.5);
      margin-top: auto;
      padding-top: 40px;
    }

    .portal-author a {
      color: #4fd1c5;
      text-decoration: none;
      transition: color 0.3s;
    }

    .portal-author a:hover {
      color: #81e6d9;
    }

    .portal-left {
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .portal-sub {
      opacity: 0.95;
      margin-top: 8px;
      color: rgba(255, 255, 255, 0.95);
    }

    /* Ensure title/sub are explicitly visible on all devices */
    .portal-title,
    .portal-sub {
      color: rgba(234, 242, 234, 1);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.35);
    }

    .portal-hero>div {
      position: relative;
      z-index: 2;
    }

    /* ベントーグリッドレイアウト */
    .portal-grid {
      position: relative;
      z-index: 2;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-auto-rows: 160px;
      gap: 20px;
      margin-bottom: 0;
    }

    .portal-grid .portal-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 32px;
      text-align: center;
      transition: all .3s ease;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #ffffff;
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }

    .portal-grid .portal-card .card-icon {
      font-size: 2.5rem;
      margin-bottom: 16px;
      opacity: 0.9;
    }

    .portal-grid .portal-card .card-title {
      font-family: 'Outfit', sans-serif;
      font-size: 18px;
      font-weight: 700;
      margin-top: 16px;
      margin-bottom: 8px;
    }

    .portal-grid .portal-card .card-subtitle {
      font-family: 'Space Grotesk', monospace;
      font-size: 11px;
      letter-spacing: 0.05em;
      opacity: 0.6;
      text-transform: uppercase;
    }

    .portal-grid .portal-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.05) 100%);
      opacity: 0;
      transition: opacity .4s ease;
    }

    .portal-grid .portal-card::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
      opacity: 0;
      transition: opacity .4s ease;
    }

    .portal-grid .portal-card:hover::before {
      opacity: 1;
    }

    .portal-grid .portal-card:hover::after {
      opacity: 1;
    }

    .portal-grid .portal-card i {
      color: inherit !important;
      filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.25));
      transition: all .4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .portal-grid .portal-card:hover {
      transform: translateY(-8px) scale(1.03) rotate(0.5deg);
      box-shadow:
        0 20px 60px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.3),
        0 1px 3px rgba(0, 0, 0, 0.1);
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.35) 0%, rgba(255, 255, 255, 0.15) 100%);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .portal-grid .portal-card:hover i {
      transform: scale(1.1) rotate(-5deg);
      filter: drop-shadow(0 6px 16px rgba(0, 0, 0, 0.3));
    }

    /* 各カードに微妙な色付け */
    .portal-card:nth-child(1) {
      background: linear-gradient(145deg, rgba(107, 143, 113, 0.3) 0%, rgba(107, 143, 113, 0.15) 100%);
    }

    .portal-card:nth-child(2) {
      background: linear-gradient(145deg, rgba(74, 155, 155, 0.3) 0%, rgba(74, 155, 155, 0.15) 100%);
    }

    .portal-card:nth-child(3) {
      background: linear-gradient(145deg, rgba(201, 169, 97, 0.3) 0%, rgba(201, 169, 97, 0.15) 100%);
    }

    .portal-card:nth-child(4) {
      background: linear-gradient(145deg, rgba(139, 92, 246, 0.3) 0%, rgba(139, 92, 246, 0.15) 100%);
    }

    .portal-card:nth-child(5) {
      background: linear-gradient(145deg, rgba(239, 68, 68, 0.3) 0%, rgba(239, 68, 68, 0.15) 100%);
    }

    .portal-card:nth-child(6) {
      background: linear-gradient(145deg, rgba(59, 130, 246, 0.3) 0%, rgba(59, 130, 246, 0.15) 100%);
    }

    .portal-card:nth-child(7) {
      background: linear-gradient(145deg, rgba(234, 179, 8, 0.3) 0%, rgba(234, 179, 8, 0.15) 100%);
    }

    .portal-card:nth-child(8) {
      background: linear-gradient(145deg, rgba(148, 163, 184, 0.3) 0%, rgba(148, 163, 184, 0.15) 100%);
    }

    /* ベントーグリッドのアイテム配置 */
    /* 左半分 */
    .portal-card:nth-child(1) {
      grid-column: 1 / 3;
      grid-row: 1 / 3;
    }

    /* トラクター - 上（大）*/
    .portal-card:nth-child(3) {
      grid-column: 1 / 3;
      grid-row: 3;
    }

    /* 田植え機 - 中 */
    .portal-card:nth-child(5) {
      grid-column: 1 / 3;
      grid-row: 4;
    }

    /* コンバイン - 下 */
    /* 右半分 */
    .portal-card:nth-child(2) {
      grid-column: 3 / 5;
      grid-row: 1;
    }

    /* メンテナンス - 上 */
    .portal-card:nth-child(4) {
      grid-column: 3 / 5;
      grid-row: 2;
    }

    /* 修理 - 中 */
    .portal-card:nth-child(6) {
      grid-column: 3;
      grid-row: 3 / 5;
    }

    /* その他の機械 - 下左（縦長）*/
    .portal-card:nth-child(7) {
      grid-column: 4;
      grid-row: 3;
    }

    /* エクスポート - 下右上 */
    .portal-card:nth-child(8) {
      grid-column: 4;
      grid-row: 4;
    }

    /* バージョン情報 - 下右下 */

    /* トラクターカード（最初のカード）のアイコンを大きく */
    .portal-card:nth-child(1) i {
      font-size: 5rem;
    }

    @media (max-width: 1024px) {
      .portal-grid {
        grid-template-columns: repeat(4, 1fr);
        grid-auto-rows: 120px;
      }

      .portal-card:nth-child(1) {
        grid-column: 1 / 3;
        grid-row: 1 / 3;
      }

      .portal-card:nth-child(2) {
        grid-column: 3 / 5;
        grid-row: 1;
      }

      .portal-card:nth-child(3) {
        grid-column: 1 / 3;
        grid-row: 3;
      }

      .portal-card:nth-child(4) {
        grid-column: 3 / 5;
        grid-row: 2;
      }

      .portal-card:nth-child(5) {
        grid-column: 1 / 3;
        grid-row: 4;
      }

      .portal-card:nth-child(6) {
        grid-column: 3;
        grid-row: 3 / 5;
      }

      .portal-card:nth-child(7) {
        grid-column: 4;
        grid-row: 3;
      }

      .portal-card:nth-child(8) {
        grid-column: 4;
        grid-row: 4;
      }
    }

    @media (max-width: 640px) {
      .portal-grid {
        grid-template-columns: repeat(2, 1fr);
        grid-auto-rows: 100px;
        gap: 12px;
      }

      /* スマホでの並び順: トラクター、田植え機、コンバイン、その他の機械、メンテナンス、修理、エクスポート、バージョン */
      .portal-card:nth-child(1) {
        grid-column: 1 / 3;
        grid-row: 1;
        order: 1;
      }

      /* トラクター */
      .portal-card:nth-child(2) {
        grid-column: 1 / 3;
        grid-row: 5;
        order: 5;
      }

      /* メンテナンス */
      .portal-card:nth-child(3) {
        grid-column: 1 / 3;
        grid-row: 2;
        order: 2;
      }

      /* 田植え機 */
      .portal-card:nth-child(4) {
        grid-column: 1 / 3;
        grid-row: 6;
        order: 6;
      }

      /* 修理 */
      .portal-card:nth-child(5) {
        grid-column: 1 / 3;
        grid-row: 3;
        order: 3;
      }

      /* コンバイン */
      .portal-card:nth-child(6) {
        grid-column: 1 / 3;
        grid-row: 4;
        order: 4;
      }

      /* その他の機械 */
      .portal-card:nth-child(7) {
        grid-column: 1 / 3;
        grid-row: 7;
        order: 7;
      }

      /* エクスポート */
      .portal-card:nth-child(8) {
        grid-column: 1 / 3;
        grid-row: 8;
        order: 8;
      }

      /* バージョン情報 */
      .portal-hero {
        padding: calc(24px + env(safe-area-inset-top)) 18px 24px;
        justify-content: flex-start;
      }

      .portal-hero {
        grid-template-columns: 1fr;
        gap: 32px;
      }

      .portal-left {
        text-align: center;
        padding-top: 0 !important;
      }

      .portal-title {
        font-size: 32px;
      }

      .portal-subtitle {
        font-size: 9px;
      }

      .portal-grid .portal-card {
        padding: 12px;
        justify-content: center !important;
      }

      .portal-card:nth-child(1) i {
        font-size: 2.5rem !important;
      }

      .portal-card i {
        font-size: 2rem !important;
      }

      .portal-card .card-icon {
        margin-bottom: 8px !important;
      }

      .portal-card .card-title {
        font-size: 14px;
        margin-top: 8px !important;
        margin-bottom: 4px !important;
      }
    }

    /* ページ下部の余白 */
    .view {
      padding-bottom: 60px !important;
    }

    /* 印刷時のスタイル */
    @media print {

      /* ヘッダーを非表示 */
      header,
      .bi-header {
        display: none !important;
      }

      /* サイドメニューとその影を非表示 */
      .sideMenu,
      #sideMenu,
      #tractorSideMenu,
      #plantingSideMenu,
      #combineSideMenu,
      #otherMachinerySideMenu,
      #repairSideMenu,
      #overlay {
        display: none !important;
      }

      /* ボタン類を非表示 */
      button,
      .btn,
      .btn-main,
      .btn-sub {
        display: none !important;
      }

      /* 入力欄を非表示 */
      input,
      select,
      textarea {
        display: none !important;
      }

      /* 印刷機能カード全体を非表示 */
      #exportView .card:has(button[onclick="window.print()"]) {
        display: none !important;
      }

      /* ヘッダーのハンバーガーメニューボタンを非表示 */
      header button[onclick="openMenu()"],
      .bi-header button[onclick="openMenu()"] {
        display: none !important;
      }

      /* コンテンツの左マージンをリセット */
      #mainContainer {
        margin-left: 0 !important;
      }

      /* ページの余白を調整 */
      body {
        background: white;
      }

      .view {
        padding-bottom: 20px !important;
      }

      /* 絞り込み条件のカードを非表示 */
      #exportView .card:has(#exportDataType),
      #exportView .card:has(#exportStartDate) {
        display: none !important;
      }

      /* エクスポートボタンのカードを非表示 */
      #exportView .card:has(#exportButton) {
        display: none !important;
      }

      /* プレビュー用テーブルを非表示、印刷用テーブルを表示 */
      .preview-only {
        display: none !important;
      }

      .print-only {
        display: block !important;
      }

      /* 印刷用テーブルのスタイル調整 */
      .print-only table {
        font-size: 9px !important;
        line-height: 1.2 !important;
      }

      .print-only td,
      .print-only th {
        padding: 2px 4px !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
      }
    }
  </style>

</head>

<body style="visibility:hidden">

  <div id="overlay" onclick="closeMenu()"></div>
  <!-- Tractor Side Menu -->
  <div id="tractorSideMenu" class="sideMenu">
    <div class="flex justify-between items-center mb-6">
      <h2 class="font-bold text-lg" style="color: var(--tractor-color)">Tractor Menu</h2>
      <button onclick="closeMenu()" class="close-menu-btn text-2xl text-gray-400">&times;</button>
    </div>
    <nav class="space-y-1">
      <button onclick="switchView('portalView')" class="menu-item"><i
          class="fa-solid fa-home w-8 text-lg"></i>Portal</button>
      <button onclick="switchView('tractorView')" class="menu-item"><i
          class="fa-solid fa-tractor w-8 text-lg"></i>ログ入力</button>
      <button onclick="switchView('todayView')" class="menu-item"><i
          class="fa-solid fa-calendar-day w-8 text-lg"></i>本日の稼働状況</button>
      <button onclick="switchView('historyView')" class="menu-item"><i
          class="fa-solid fa-magnifying-glass w-8 text-lg"></i>稼働履歴・検索</button>
      <button onclick="switchView('dashboard')" class="menu-item"><i
          class="fa-solid fa-chart-line w-8 text-lg"></i>データ分析</button>
    </nav>
  </div>

  <!-- Planting Side Menu -->
  <div id="plantingSideMenu" class="sideMenu">
    <div class="flex justify-between items-center mb-6">
      <h2 class="font-bold text-lg" style="color: var(--planting-color)">Transplanter Menu</h2>
      <button onclick="closeMenu()" class="close-menu-btn text-2xl text-gray-400">&times;</button>
    </div>
    <nav class="space-y-1">
      <button onclick="switchView('portalView')" class="menu-item"><i
          class="fa-solid fa-home w-8 text-lg"></i>Portal</button>
      <button onclick="switchView('plantingView')" class="menu-item"><i
          class="fa-solid fa-seedling w-8 text-lg"></i>田植え機ログ入力</button>
      <button onclick="switchView('todayViewPlanting')" class="menu-item"><i
          class="fa-solid fa-calendar-day w-8 text-lg"></i>本日の稼働状況</button>
      <button onclick="switchView('historyViewPlanting')" class="menu-item"><i
          class="fa-solid fa-magnifying-glass w-8 text-lg"></i>稼働履歴・検索</button>
      <button onclick="switchView('dashboardPlanting')" class="menu-item"><i
          class="fa-solid fa-chart-line w-8 text-lg"></i>データ分析</button>
    </nav>
  </div>

  <!-- Combine Side Menu -->
  <div id="combineSideMenu" class="sideMenu">
    <div class="flex justify-between items-center mb-6">
      <h2 class="font-bold text-lg" style="color: var(--combine-color)">Combine Menu</h2>
      <button onclick="closeMenu()" class="close-menu-btn text-2xl text-gray-400">&times;</button>
    </div>
    <nav class="space-y-1">
      <button onclick="switchView('portalView')" class="menu-item"><i
          class="fa-solid fa-home w-8 text-lg"></i>Portal</button>
      <button onclick="switchView('combineView')" class="menu-item"><i
          class="fa-solid fa-wheat-awn w-8 text-lg"></i>コンバインログ入力</button>
      <button onclick="switchView('todayViewCombine')" class="menu-item"><i
          class="fa-solid fa-calendar-day w-8 text-lg"></i>本日の稼働状況</button>
      <button onclick="switchView('historyViewCombine')" class="menu-item"><i
          class="fa-solid fa-magnifying-glass w-8 text-lg"></i>稼働履歴・検索</button>
      <button onclick="switchView('dashboardCombine')" class="menu-item"><i
          class="fa-solid fa-chart-line w-8 text-lg"></i>データ分析</button>
    </nav>
  </div>

  <!-- Export Side Menu -->
  <div id="exportSideMenu" class="sideMenu">
    <div class="flex justify-between items-center mb-6">
      <h2 class="font-bold text-lg" style="color: var(--export-color);">Menu</h2>
      <button onclick="closeMenu()" class="close-menu-btn text-2xl text-gray-400">&times;</button>
    </div>
    <nav class="space-y-1">
      <button onclick="switchView('portalView')" class="menu-item"><i
          class="fa-solid fa-home w-8 text-lg"></i>Portal</button>
      <button onclick="switchView('tractorView')" class="menu-item"><i
          class="fa-solid fa-tractor w-8 text-lg"></i>トラクター</button>
      <button onclick="switchView('plantingView')" class="menu-item"><i
          class="fa-solid fa-seedling w-8 text-lg"></i>田植え機</button>
      <button onclick="switchView('combineView')" class="menu-item"><i
          class="fa-solid fa-wheat-awn w-8 text-lg"></i>コンバイン</button>
      <button onclick="switchView('maintenanceListView');" class="menu-item"><i
          class="fa-solid fa-toolbox w-8 text-lg"></i>メンテナンス一覧</button>
    </nav>
  </div>

  <!-- Maintenance Side Menu -->
  <div id="maintenanceSideMenu" class="sideMenu">
    <div class="flex justify-between items-center mb-6">
      <h2 class="font-bold text-lg" style="color: var(--maintenance-color);">Menu</h2>
      <button onclick="closeMenu()" class="close-menu-btn text-2xl text-gray-400">&times;</button>
    </div>
    <nav class="space-y-1">
      <button onclick="switchView('portalView')" class="menu-item"><i
          class="fa-solid fa-home w-8 text-lg"></i>Portal</button>
      <button onclick="switchView('tractorView')" class="menu-item"><i
          class="fa-solid fa-tractor w-8 text-lg"></i>トラクター</button>
      <button onclick="switchView('plantingView')" class="menu-item"><i
          class="fa-solid fa-seedling w-8 text-lg"></i>田植え機</button>
      <button onclick="switchView('combineView')" class="menu-item"><i
          class="fa-solid fa-wheat-awn w-8 text-lg"></i>コンバイン</button>
      <button onclick="switchView('maintenanceListView');" class="menu-item"><i
          class="fa-solid fa-toolbox w-8 text-lg"></i>メンテナンス一覧</button>
    </nav>
  </div>

  <!-- Version Side Menu -->
  <div id="versionSideMenu" class="sideMenu">
    <div class="flex justify-between items-center mb-6">
      <h2 class="font-bold text-lg" style="color: var(--version-color);">Menu</h2>
      <button onclick="closeMenu()" class="close-menu-btn text-2xl text-gray-400">&times;</button>
    </div>
    <nav class="space-y-1">
      <button onclick="switchView('portalView')" class="menu-item"><i
          class="fa-solid fa-home w-8 text-lg"></i>Portal</button>
      <button onclick="switchView('tractorView')" class="menu-item"><i
          class="fa-solid fa-tractor w-8 text-lg"></i>トラクター</button>
      <button onclick="switchView('plantingView')" class="menu-item"><i
          class="fa-solid fa-seedling w-8 text-lg"></i>田植え機</button>
      <button onclick="switchView('combineView')" class="menu-item"><i
          class="fa-solid fa-wheat-awn w-8 text-lg"></i>コンバイン</button>
      <button onclick="switchView('maintenanceListView');" class="menu-item"><i
          class="fa-solid fa-toolbox w-8 text-lg"></i>メンテナンス一覧</button>
    </nav>
  </div>

  <!-- Other Machinery Side Menu -->
  <div id="otherMachinerySideMenu" class="sideMenu">
    <div class="flex justify-between items-center mb-6">
      <h2 class="font-bold text-lg" style="color: var(--other-color);">Other Machinery Menu</h2>
      <button onclick="closeMenu()" class="close-menu-btn text-2xl text-gray-400">&times;</button>
    </div>
    <nav class="space-y-1">
      <button onclick="switchView('portalView')" class="menu-item"><i
          class="fa-solid fa-home w-8 text-lg"></i>Portal</button>
      <button onclick="switchView('otherMachineryView')" class="menu-item"><i
          class="fas fa-tachometer-alt w-8 text-lg"></i>ログ入力</button>
      <button onclick="switchView('todayViewOther')" class="menu-item"><i
          class="fa-solid fa-calendar-day w-8 text-lg"></i>本日の稼働状況</button>
      <button onclick="switchView('historyViewOther')" class="menu-item"><i
          class="fa-solid fa-magnifying-glass w-8 text-lg"></i>稼働履歴・検索</button>
      <button onclick="switchView('dashboardOther')" class="menu-item"><i
          class="fa-solid fa-chart-line w-8 text-lg"></i>データ分析</button>
    </nav>
  </div>

  <!-- Repair Side Menu -->
  <div id="repairSideMenu" class="sideMenu">
    <div class="flex justify-between items-center mb-6">
      <h2 class="font-bold text-lg" style="color: var(--repair-color);">Menu</h2>
      <button onclick="closeMenu()" class="close-menu-btn text-2xl text-gray-400">&times;</button>
    </div>
    <nav class="space-y-1">
      <button onclick="switchView('portalView')" class="menu-item"><i
          class="fa-solid fa-home w-8 text-lg"></i>Portal</button>
      <button onclick="switchView('tractorView')" class="menu-item"><i
          class="fa-solid fa-tractor w-8 text-lg"></i>トラクター</button>
      <button onclick="switchView('plantingView')" class="menu-item"><i
          class="fa-solid fa-seedling w-8 text-lg"></i>田植え機</button>
      <button onclick="switchView('combineView')" class="menu-item"><i
          class="fa-solid fa-wheat-awn w-8 text-lg"></i>コンバイン</button>
      <button onclick="switchView('maintenanceListView');" class="menu-item"><i
          class="fa-solid fa-toolbox w-8 text-lg"></i>メンテナンス一覧</button>
    </nav>
  </div>

  <!-- Portal/Global Side Menu -->
  <div id="sideMenu">
    <div class="flex justify-between items-center mb-6">
      <h2 class="font-bold text-lg text-[#6b8f71]">Menu</h2>
      <button onclick="closeMenu()" class="close-menu-btn text-2xl text-gray-400">&times;</button>
    </div>
    <nav class="space-y-1">
      <button onclick="switchView('portalView')" class="menu-item"><i
          class="fa-solid fa-home w-8 text-lg"></i>Portal</button>
      <button onclick="switchView('tractorView')" class="menu-item"><i
          class="fa-solid fa-tractor w-8 text-lg"></i>トラクター</button>
      <button onclick="switchView('plantingView')" class="menu-item"><i
          class="fa-solid fa-seedling w-8 text-lg"></i>田植え機</button>
      <button onclick="switchView('combineView')" class="menu-item"><i
          class="fa-solid fa-wheat-awn w-8 text-lg"></i>コンバイン</button>
      <button onclick="switchView('maintenanceMachineListView'); loadMachineList();" class="menu-item"><i
          class="fa-solid fa-toolbox w-8 text-lg"></i>メンテナンス記録</button>
    </nav>
  </div>

  <div id="customModal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width: 300px; margin: 20vh auto; border-radius: 15px; overflow: hidden;">
      <div class="modal-body p-6 text-center">
        <p id="modalMessage" class="font-bold text-lg mb-4">メッセージ</p>
        <div class="flex gap-2">
          <button id="modalCancelBtn" class="flex-1 p-2 bg-gray-200 rounded-lg text-sm"
            onclick="closeModal()">戻る</button>
          <button id="modalOkBtn" class="flex-1 p-2 bg-[#6b8f71] text-white rounded-lg text-sm font-bold">実行する</button>
        </div>
      </div>
    </div>
  </div>

  <div id="mainContainer">
    <!-- Portal View: entry hub -->
    <div id="portalView" class="view fullscreen-view min-h-screen">
      <div class="portal-hero">
        <!-- 左側: タイトルエリア -->
        <div class="portal-left">
          <div class="portal-title">和農日向<br>機械管理App</div>
          <div class="portal-subtitle">Agricultural Machinery Management System</div>
        </div>

        <!-- 右側: ベントーグリッド -->
        <div class="portal-grid">
          <div class="portal-card" onclick="switchView('tractorView')" style="cursor:pointer;">
            <i class="fa-solid fa-tractor text-6xl"></i>
            <div class="card-title">トラクター</div>
          </div>

          <div class="portal-card" onclick="switchView('maintenanceListView');" style="cursor:pointer;">
            <i class="fa-solid fa-toolbox text-5xl"></i>
            <div class="card-title">メンテナンス</div>
          </div>

          <div class="portal-card" onclick="switchView('plantingView')" style="cursor:pointer;">
            <i class="fa-solid fa-seedling text-5xl"></i>
            <div class="card-title">田植え機</div>
          </div>

          <div class="portal-card" onclick="switchView('repairView'); loadRepairDashboard();" style="cursor:pointer;">
            <i class="fa-solid fa-screwdriver-wrench text-5xl"></i>
            <div class="card-title">修理</div>
          </div>

          <div class="portal-card" onclick="switchView('combineView')" style="cursor:pointer;">
            <i class="fa-solid fa-wheat-awn text-5xl"></i>
            <div class="card-title">コンバイン</div>
          </div>

          <div class="portal-card" onclick="switchView('otherMachineryView')" style="cursor:pointer;">
            <i class="fas fa-tachometer-alt text-5xl"></i>
            <div class="card-title">その他の機械</div>
          </div>

          <div class="portal-card" onclick="switchView('exportView')" style="cursor:pointer;">
            <i class="fa-solid fa-file-export text-4xl"></i>
            <div class="card-title">エクスポート/印刷</div>
          </div>

          <div class="portal-card version-card" onclick="switchView('versionView')" style="cursor:pointer;">
            <span class="version-badge" id="versionBadge"></span>
            <i class="fa-solid fa-info-circle text-5xl"></i>
            <div class="card-title">バージョン情報</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tractor Section -->
    <div id="tractor-section">
      <div id="tractorView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
        <!-- トラクター専用ヘッダー -->
        <header id="pageHeader" class="flex flex-col items-center justify-center py-4 relative">
          <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--tractor-color)"><i
              class="fa-solid fa-bars"></i></button>
          <!-- オフライン同期バッジ -->
          <button onclick="syncLocalStorageToSupabase()" class="absolute right-4 top-4 p-2 relative"
            style="color: var(--tractor-color)" title="未同期データを手動同期">
            <i class="fa-solid fa-cloud-arrow-up text-2xl"></i>
            <span id="syncBadge"
              class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold">0</span>
          </button>
          <i class="fa-solid fa-tractor text-5xl" style="color: var(--tractor-color)"></i>
          <h1 class="text-xl font-bold" style="color: var(--tractor-color)">和農日向 機械管理アプリ</h1>
        </header>

        <div class="flex items-center gap-2 mb-1 mt-4">
          <i class="fa-solid fa-pen-to-square text-lg" style="color: var(--tractor-color)"></i>
          <span class="text-lg font-bold" style="color: var(--tractor-color)">ログ入力</span>
        </div>
        <div class="border-t-2 mb-6 opacity-50" style="border-color: var(--tractor-color)"></div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">機械を選択</label>
          <select id="machineSelect" class="w-full p-3 rounded-lg" onchange="autoFillHour()"></select>
        </div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">作業日</label>
          <input type="date" id="workDate" class="w-full p-3 rounded-lg" />
        </div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">オペレーター</label>
          <select id="operator" class="w-full p-3 rounded-lg">
            <option value="">読込中...</option>
          </select>
        </div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">種別</label>
          <select id="category" class="w-full p-3 rounded-lg">
            <option value="">読込中...</option>
          </select>
        </div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">作業内容</label>
          <select id="work_name" class="w-full p-3 rounded-lg">
            <option value="">先に種別を選択</option>
          </select>
        </div>

        <div class="card">
          <div class="flex space-x-4">
            <div class="flex-1">
              <label class="block text-xs font-bold text-gray-400 mb-1">稼働前</label>
              <input type="number" id="hourBefore" class="w-full p-3 rounded-lg font-bold" step="0.1"
                oninput="calcDiff()" />
            </div>
            <div class="flex-1 min-w-0">
              <label class="block text-xs font-bold text-gray-400 mb-1">稼働後</label>
              <div class="flex items-center gap-2 min-w-0">
                <input type="number" id="hourAfter" class="flex-1 min-w-0 p-3 rounded-lg font-bold" step="0.1"
                  oninput="calcDiff()" />
                <input type="file" id="hourAfterImage" accept="image/*" capture="environment" class="hidden"
                  onchange="handleHourAfterImage(this)">
                <button type="button" onclick="document.getElementById('hourAfterImage').click()"
                  class="flex-none p-2 bg-white border rounded-lg text-[#6b8f71] shadow-sm hover:bg-[#f0f7f1]"><i
                    class="fa-solid fa-camera"></i></button>
              </div>
            </div>
          </div>
        </div>

        <div id="hourDiffDisplay" class="text-right font-black mb-6 text-xl" style="color: var(--tractor-color)">稼働時間:
          0.0 h</div>

        <div class="card">
          <div class="flex gap-4">
            <div class="flex-1">
              <label class="block text-xs font-bold text-gray-400 mb-1">油種</label>
              <select id="fuelType" class="w-full p-3 rounded-lg">
                <option value="">読込中...</option>
              </select>
            </div>
            <div class="flex-[2]">
              <label class="block text-xs font-bold text-gray-400 mb-1">給油量 (L)</label>
              <input type="number" id="fuelAmount" class="w-full p-3 rounded-lg" />
            </div>
          </div>
        </div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
          <textarea id="memoInput" class="w-full p-3 rounded-lg" rows="2"></textarea>
        </div>

        <button id="saveBtn" class="btn-main" onclick="saveLog()">ログを保存する</button>
      </div>
    </div>

    <!-- Planting Section -->
    <div id="planting-section">
      <!-- 田植え機 Dashboard -->
      <div id="dashboardPlanting" class="view fullscreen-view">
        <div class="bi-header">
          <button onclick="openMenu()" class="text-2xl mr-6 hover:opacity-70 transition-opacity"><i
              class="fa-solid fa-bars"></i></button>
          <h1 class="text-lg md:text-2xl font-black tracking-widest flex items-center">
            <i class="fa-solid fa-chart-column mr-3"></i> 2026 Transplanter data analysis
          </h1>
        </div>

        <div class="dashboard-top-bar">
          <div class="main-top-row">
            <div class="kpi-section">
              <div id="machineTabsPlanting" class="flex gap-2 overflow-x-auto pb-1"></div>
              <div class="kpi-grid">
                <div class="kpi-card"><span class="kpi-label">総 稼 働</span>
                  <div class="kpi-value-container"><span class="kpi-value" id="kpi-hours-planting">0.0</span><span
                      class="kpi-unit">h</span></div>
                </div>
                <div class="kpi-card"><span class="kpi-label">給 油</span>
                  <div class="kpi-value-container"><span class="kpi-value" id="kpi-fuel-planting">0.0</span><span
                      class="kpi-unit">L</span></div>
                </div>
                <div class="kpi-card"><span class="kpi-label">燃 費</span>
                  <div class="kpi-value-container"><span class="kpi-value" id="kpi-avg-planting">0.0</span><span
                      class="kpi-unit">L/h</span></div>
                </div>
                <div class="kpi-card"><span class="kpi-label">日 数</span>
                  <div class="kpi-value-container"><span class="kpi-value" id="kpi-days-planting">0</span><span
                      class="kpi-unit">日</span></div>
                </div>
                <div class="kpi-card" style="background-color: var(--planting-color);"><span class="kpi-label">状
                    態</span><span class="kpi-value text-[15px]">良好</span></div>
              </div>
            </div>
            <div class="ranking-section">
              <p class="text-[11px] font-bold mb-2 text-center" style="color: var(--planting-color)"><i
                  class="fa-solid fa-trophy mr-1"></i>稼働ランキング</p>
              <div id="rankListPlanting" class="flex justify-around items-center"></div>
            </div>
          </div>
        </div>

        <div class="bi-container">
          <!-- 左カラム：メイングラフエリア -->
          <div class="bi-left-col">
            <!-- 月別稼働推移 -->
            <div class="card">
              <p class="chart-title" style="display: flex; align-items: center;">
                <i class="fa-solid fa-chart-line" style="margin-right: 8px; color: var(--planting-color);"></i>
                月別稼働推移
              </p>
              <div class="chart-container" style="flex: 1; min-height: 0;">
                <div class="chart-wrapper" style="position: relative; height: 100%; width: 100%;">
                  <canvas id="monthlyTrendChartPlanting"></canvas>
                </div>
              </div>
            </div>

            <!-- 作業内容別稼働時間 -->
            <div class="card">
              <p class="chart-title" style="display: flex; align-items: center;">
                <i class="fa-solid fa-list-check" style="margin-right: 8px; color: var(--planting-color);"></i>
                作業内容別稼働時間
              </p>
              <div class="chart-container" style="flex: 1; min-height: 0;">
                <div class="chart-wrapper" style="position: relative; height: 100%; width: 100%;">
                  <canvas id="taskHoursChartPlanting"></canvas>
                </div>
              </div>
            </div>

            <!-- 機械別稼働ランキング -->
            <div class="card">
              <p class="chart-title" style="display: flex; align-items: center;">
                <i class="fa-solid fa-ranking-star" style="margin-right: 8px; color: var(--planting-color);"></i>
                機械別稼働ランキング
              </p>
              <div class="chart-container">
                <div class="chart-wrapper" style="position: relative; height: 100%; width: 100%;">
                  <canvas id="machineRankingChartPlanting"></canvas>
                </div>
              </div>
            </div>
          </div>

          <!-- 右カラム：サマリーエリア -->
          <div class="bi-right-col">
            <!-- 燃費効率 -->
            <div class="card fuel-efficiency-card">
              <div
                style="display: flex; align-items: center; justify-content: center; height: 100%; padding: 8px 12px; gap: 32px;">
                <!-- 左：アイコン+テキスト -->
                <div
                  style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 60px;">
                  <i class="fa-solid fa-gas-pump" style="font-size: 20px; color: #DC143C; margin-bottom: 4px;"></i>
                  <div
                    style="font-size: 10px; font-weight: bold; text-align: center; white-space: nowrap; color: #DC143C;">
                    燃費効率</div>
                </div>

                <!-- 中央：数値 -->
                <div
                  style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 80px;">
                  <div class="text-3xl font-bold" style="color: #DC143C;" id="fuelEfficiencyValuePlanting">-</div>
                  <div class="text-xs" style="color: #DC143C;">L/h</div>
                </div>

                <!-- 右：詳細 -->
                <div
                  style="display: flex; flex-direction: column; justify-content: center; text-align: right; font-size: 10px; color: #DC143C; min-width: 90px;">
                  <div>総燃料: <span id="totalFuelPlanting">-</span> L</div>
                  <div>総稼働: <span id="totalHoursPlanting">-</span> h</div>
                </div>
              </div>
            </div>

            <!-- オペレーター別比率 -->
            <div class="card operator-card">
              <p class="chart-title" style="display: flex; align-items: center;">
                <i class="fa-solid fa-user-check" style="margin-right: 8px; color: var(--planting-color);"></i>
                オペレーター別比率
              </p>
              <div class="chart-container" style="flex: 1; min-height: 0;">
                <div class="chart-wrapper" style="position: relative; height: 100%; width: 100%;">
                  <canvas id="operatorShareChartPlanting"></canvas>
                </div>
              </div>
            </div>

            <!-- メンテナンス情報 -->
            <div class="card maint-card overflow-hidden">
              <p class="chart-title border-b pb-1" style="display: flex; align-items: center;">
                <i class="fa-solid fa-clipboard-list" style="margin-right: 8px; color: var(--planting-color);"></i>
                メンテナンス情報
              </p>
              <div id="maintenanceLogPlanting" class="text-[10px] space-y-2 opacity-80 pt-2 flex-1 overflow-y-auto">
                <p class="italic text-gray-400 text-center py-4">履歴はありません</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="plantingView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
        <!-- 田植え機専用ヘッダー -->
        <header id="plantingHeader" class="flex flex-col items-center justify-center py-4 relative">
          <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2"
            style="color: var(--planting-color)"><i class="fa-solid fa-bars"></i></button>
          <i class="fa-solid fa-seedling text-5xl" style="color: var(--planting-color)"></i>
          <h1 class="text-xl font-bold" style="color: var(--planting-color)">和農日向 機械管理アプリ</h1>
        </header>

        <div class="flex items-center gap-2 mb-1 mt-4">
          <i class="fa-solid fa-seedling text-lg" style="color: var(--planting-color)"></i>
          <span class="text-lg font-bold" style="color: var(--planting-color)">田植え機ログ入力</span>
        </div>
        <div class="border-t-2 mb-6 opacity-50" style="border-color: var(--planting-color)"></div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">機械を選択</label>
          <select id="taue_machineSelect" class="w-full p-3 rounded-lg" onchange="taue_autoFillHour()"></select>
        </div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">作業日</label>
          <input type="date" id="taue_workDate" class="w-full p-3 rounded-lg" />
        </div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">オペレーター</label>
          <select id="taue_operator" class="w-full p-3 rounded-lg">
            <option value="">読込中...</option>
          </select>
        </div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">作業内容</label>
          <select id="taue_work_name" class="w-full p-3 rounded-lg">
            <option value="">読込中...</option>
          </select>
        </div>

        <div class="card">
          <div class="flex gap-2">
            <div style="flex: 1 1 0; min-width: 0;">
              <label class="block text-xs font-bold text-gray-400 mb-1">稼働前</label>
              <input type="number" id="taue_hourBefore" class="w-full p-3 rounded-lg font-bold" step="0.1"
                oninput="taue_calcDiff()" />
            </div>
            <div style="flex: 1 1 0; min-width: 0;">
              <label class="block text-xs font-bold text-gray-400 mb-1">稼働後</label>
              <input type="number" id="taue_hourAfter" class="w-full p-3 rounded-lg font-bold" step="0.1"
                oninput="taue_calcDiff()" />
            </div>
            <div class="flex items-end">
              <input type="file" id="taue_hourAfterImage" accept="image/*" capture="environment" class="hidden"
                onchange="taue_handleHourAfterImage(this)">
              <button type="button" onclick="document.getElementById('taue_hourAfterImage').click()"
                class="p-3 bg-white border rounded-lg shadow-sm hover:bg-[#e0f2f2]"
                style="color: var(--planting-color)"><i class="fa-solid fa-camera"></i></button>
            </div>
          </div>
        </div>

        <div id="taue_hourDiffDisplay" class="text-right font-black mb-6 text-xl" style="color: var(--planting-color)">
          稼働時間: 0.0 h</div>

        <div class="card">
          <div class="flex gap-4">
            <div class="flex-1">
              <label class="block text-xs font-bold text-gray-400 mb-1">油種</label>
              <select id="taue_fuelType" class="w-full p-3 rounded-lg">
                <option value="">読込中...</option>
              </select>
            </div>
            <div class="flex-[2]">
              <label class="block text-xs font-bold text-gray-400 mb-1">給油量 (L)</label>
              <input type="number" id="taue_fuelAmount" class="w-full p-3 rounded-lg" />
            </div>
          </div>
        </div>

        <div class="card">
          <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
          <textarea id="taue_memoInput" class="w-full p-3 rounded-lg" rows="2"></textarea>
        </div>

        <button id="taue_saveBtn" class="btn-main" onclick="taue_saveLog()">ログを保存する</button>
      </div>

      <!-- 本日の稼働状況 (田植え機) -->
      <div id="todayViewPlanting" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
        <!-- 田植え機専用ヘッダー -->
        <header class="flex flex-col items-center justify-center py-4 relative">
          <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2"
            style="color: var(--planting-color)"><i class="fa-solid fa-bars"></i></button>
          <i class="fa-solid fa-seedling text-5xl" style="color: var(--planting-color)"></i>
          <h1 class="text-xl font-bold" style="color: var(--planting-color)">和農日向 機械管理アプリ</h1>
        </header>

        <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg"
          style="color: var(--planting-color); border-bottom: 2px solid var(--planting-color)"><i
            class="fa-solid fa-calendar-day"></i> 本日の稼働状況</div>
        <div id="todayLogListPlanting" class="space-y-4"></div>
        <button onclick="switchView('plantingView')" class="btn-sub">
          <i class="fa-solid fa-arrow-left mr-2"></i>ログ入力に戻る
        </button>
      </div>

      <!-- 稼働履歴・検索 (田植え機) -->
      <div id="historyViewPlanting" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
        <!-- 田植え機専用ヘッダー -->
        <header class="flex flex-col items-center justify-center py-4 relative">
          <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2"
            style="color: var(--planting-color)"><i class="fa-solid fa-bars"></i></button>
          <i class="fa-solid fa-seedling text-5xl" style="color: var(--planting-color)"></i>
          <h1 class="text-xl font-bold" style="color: var(--planting-color)">和農日向 機械管理アプリ</h1>
        </header>

        <div class="flex items-center gap-2 mb-6 font-bold pb-3 text-lg w-full"
          style="color: var(--planting-color); border-bottom: 2px solid var(--planting-color)">
          <i class="fa-solid fa-magnifying-glass"></i>
          <span>稼働履歴検索</span>
        </div>

        <div class="card space-y-3 text-sm mb-6">
          <div class="grid grid-cols-3 gap-3">
            <div class="flex flex-col gap-1">
              <label class="text-[10px] text-gray-400 font-bold ml-1">期間選択</label>
              <select id="filterPeriodTypePlanting" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm"
                onchange="togglePeriodInputPlanting()">
                <option value="month">月単位</option>
                <option value="year">年単位</option>
              </select>
            </div>
            <div class="flex flex-col gap-1" id="filterMonthContainerPlanting">
              <label class="text-[10px] text-gray-400 font-bold ml-1">対象月</label>
              <input type="month" id="filterMonthPlanting"
                class="p-3 rounded-lg w-full border border-gray-100 shadow-sm">
            </div>
            <div class="flex flex-col gap-1" id="filterYearContainerPlanting" style="display: none;">
              <label class="text-[10px] text-gray-400 font-bold ml-1">対象年</label>
              <input type="number" id="filterYearPlanting"
                class="p-3 rounded-lg w-full border border-gray-100 shadow-sm" min="2000" max="2100"
                placeholder="例: 2026">
            </div>
            <div class="flex flex-col gap-1">
              <label class="text-[10px] text-gray-400 font-bold ml-1">機械</label>
              <select id="filterMachinePlanting" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm">
                <option value="">すべての機械</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3 mt-1">
            <div class="flex flex-col gap-1">
              <label class="text-[10px] text-gray-400 font-bold ml-1">オペレーター</label>
              <select id="filterOperatorPlanting"
                class="p-3 rounded-lg w-full border border-gray-100 shadow-sm text-sm text-gray-600">
                <option value="">全オペレーター</option>
              </select>
            </div>

            <div class="flex flex-col gap-1">
              <label class="text-[10px] text-gray-400 font-bold ml-1">作業内容</label>
              <select id="filterCategoryPlanting"
                class="p-3 rounded-lg w-full border border-gray-100 shadow-sm text-sm text-gray-600">
                <option value="">全作業内容</option>
              </select>
            </div>
          </div>

          <button onclick="loadLogsPlanting('historyLogListPlanting', false)" class="btn-main mt-2 shadow-md">
            検索を実行
          </button>
        </div>

        <div class="flex justify-end items-center mb-4 px-1">
          <div id="historyTotalHoursPlanting"
            class="text-sm font-black opacity-80 bg-white px-4 py-2 rounded-full shadow-sm"
            style="color: var(--planting-color)">
            合計: 0.0 h
          </div>
        </div>

        <div id="historyLogListPlanting" class="space-y-4"></div>

        <button onclick="switchView('plantingView')" class="btn-sub mt-8">
          <i class="fa-solid fa-arrow-left mr-2"></i>ログ入力に戻る
        </button>
      </div>
    </div>

    <!-- 田植え機 メンテナンス機械一覧 -->
    <div id="maintenanceMachineListViewPlanting" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
      <!-- 田植え機専用ヘッダー -->
      <header class="flex flex-col items-center justify-center py-4 relative">
        <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--planting-color)"><i
            class="fa-solid fa-bars"></i></button>
        <i class="fa-solid fa-seedling text-5xl" style="color: var(--planting-color)"></i>
        <h1 class="text-xl font-bold" style="color: var(--planting-color)">和農日向 機械管理アプリ</h1>
      </header>

      <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg"
        style="color: var(--planting-color); border-bottom: 2px solid var(--planting-color)">
        <i class="fa-solid fa-wrench"></i> 田植え機 メンテナンス記録
      </div>

      <div id="maintenanceMachineGridPlanting" class="space-y-6">
      </div>

      <button onclick="switchView('maintenanceListView')" class="btn-sub mt-6 w-full"
        style="background: #c9a961; color: white; border: 2px solid #c9a961;">
        <i class="fa-solid fa-arrow-left mr-2"></i>メンテナンス管理に戻る
      </button>
    </div>

    <!-- 田植え機 メンテナンス詳細 -->
    <div id="maintenanceDetailViewPlanting" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
      <!-- 田植え機専用ヘッダー -->
      <header class="flex flex-col items-center justify-center py-4 relative">
        <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--planting-color)"><i
            class="fa-solid fa-bars"></i></button>
        <i class="fa-solid fa-seedling text-5xl" style="color: var(--planting-color)"></i>
        <h1 class="text-xl font-bold" style="color: var(--planting-color)">和農日向 機械管理アプリ</h1>
      </header>

      <!-- タイトル（機械名は JS で差し替える） -->
      <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg"
        style="color: #c9a961; border-bottom: 2px solid #c9a961;">
        <i class="fa-solid fa-seedling"></i>
        <span id="maintenanceMachineNamePlanting">機械名</span>
      </div>

      <div class="card mb-4">
        <p class="font-bold text-sm text-gray-500 mb-2">メンテナンス進捗</p>
        <div id="maintenanceSummaryPlanting" class="text-xs mt-1">
          未着手
        </div>
      </div>

      <div class="card mb-4">
        <p class="font-bold text-sm text-gray-500 mb-2">点検項目</p>
        <div id="maintenanceChecklistPlanting" class="space-y-2">
        </div>
      </div>

      <!-- 作業履歴タイムライン -->
      <div class="card mb-4">
        <p class="font-bold text-sm text-gray-500 mb-2">作業履歴</p>
        <div id="maintenanceHistoryLogPlanting" class="space-y-3 text-sm">
          <p class="italic text-gray-400 text-center py-4">履歴はありません</p>
        </div>
      </div>

      <div class="card mb-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
        <p class="font-bold text-sm mb-4 flex items-center" style="color: var(--planting-color)">
          <i class="fas fa-tools mr-2"></i>部品交換を記録
        </p>

        <label class="block text-xs font-bold text-gray-400 mb-1">交換部品・項目名</label>
        <input id="newMaintenanceItemPlanting" type="text"
          class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 outline-none focus:ring-2 focus:border-[#c9a961]">

        <label class="block text-xs font-bold text-gray-400 mb-1">担当者</label>
        <select id="newMaintenanceOperatorPlanting"
          class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 outline-none focus:ring-2 focus:border-[#c9a961]">
          <option value="">担当者を選択</option>
        </select>

        <label class="block text-xs font-bold text-gray-400 mb-1">状態</label>
        <select id="newMaintenanceStatusPlanting"
          class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 outline-none focus:ring-2 focus:border-[#c9a961]">
          <option value="done">完了</option>
          <option value="progress">作業中</option>
        </select>

        <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
        <textarea id="newMaintenanceMemoPlanting" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-4"
          rows="2" placeholder="備考"></textarea>

        <button onclick="saveMaintenanceRecordPlanting()"
          class="btn-main w-full py-3 text-white rounded-lg font-bold transition-all shadow-md"
          style="background: #c9a961;" onmouseover="this.style.background='#b8944f'"
          onmouseout="this.style.background='#c9a961'">
          部品交換を保存する
        </button>
      </div>

      <div class="flex justify-center w-full mt-6 mb-8">
        <button onclick="switchView('maintenanceMachineListViewPlanting')"
          class="px-6 py-3 rounded-lg font-medium transition-all shadow-md text-white hover:bg-[#b8944f] flex items-center justify-center"
          style="background: #c9a961;">
          <i class="fa-solid fa-arrow-left mr-2"></i>
          <span>メンテナンス一覧に戻る</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Combine Section -->
  <div id="combine-section">
    <div id="combineView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
      <!-- コンバイン専用ヘッダー -->
      <header class="flex flex-col items-center justify-center py-4 relative">
        <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--combine-color)"><i
            class="fa-solid fa-bars"></i></button>
        <i class="fa-solid fa-wheat-awn text-5xl" style="color: var(--combine-color)"></i>
        <h1 class="text-xl font-bold" style="color: var(--combine-color)">和農日向 機械管理アプリ</h1>
      </header>

      <div class="flex items-center gap-2 mb-1 mt-4">
        <i class="fa-solid fa-wheat-awn text-lg" style="color: var(--combine-color)"></i>
        <span class="text-lg font-bold" style="color: var(--combine-color)">コンバインログ入力</span>
      </div>
      <div class="border-t-2 mb-6 opacity-50" style="border-color: var(--combine-color)"></div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">機械を選択</label>
        <select id="combine_machineSelect" class="w-full p-3 rounded-lg" onchange="combine_autoFillHour()"></select>
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">作業日</label>
        <input type="date" id="combine_workDate" class="w-full p-3 rounded-lg" />
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">オペレーター</label>
        <select id="combine_operator" class="w-full p-3 rounded-lg">
          <option value="">読込中...</option>
        </select>
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">作業内容</label>
        <select id="combine_work_name" class="w-full p-3 rounded-lg">
          <option value="">読込中...</option>
        </select>
      </div>

      <div class="card">
        <div class="flex gap-2">
          <div style="flex: 1 1 0; min-width: 0;">
            <label class="block text-xs font-bold text-gray-400 mb-1">稼働前</label>
            <input type="number" id="combine_hourBefore" class="w-full p-3 rounded-lg font-bold" step="0.1"
              oninput="combine_calcDiff()" />
          </div>
          <div style="flex: 1 1 0; min-width: 0;">
            <label class="block text-xs font-bold text-gray-400 mb-1">稼働後</label>
            <input type="number" id="combine_hourAfter" class="w-full p-3 rounded-lg font-bold" step="0.1"
              oninput="combine_calcDiff()" />
          </div>
          <div class="flex items-end">
            <input type="file" id="combine_hourAfterImage" accept="image/*" capture="environment" class="hidden"
              onchange="combine_handleHourAfterImage(this)">
            <button type="button" onclick="document.getElementById('combine_hourAfterImage').click()"
              class="p-3 bg-white border rounded-lg shadow-sm hover:bg-[#faf6ed]" style="color: var(--combine-color)"><i
                class="fa-solid fa-camera"></i></button>
          </div>
        </div>
      </div>

      <div id="combine_hourDiffDisplay" class="text-right font-black mb-6 text-xl" style="color: var(--combine-color)">
        稼働時間: 0.0 h</div>

      <div class="card">
        <div class="flex gap-4">
          <div class="flex-1">
            <label class="block text-xs font-bold text-gray-400 mb-1">油種</label>
            <select id="combine_fuelType" class="w-full p-3 rounded-lg">
              <option value="">読込中...</option>
            </select>
          </div>
          <div class="flex-[2]">
            <label class="block text-xs font-bold text-gray-400 mb-1">給油量 (L)</label>
            <input type="number" id="combine_fuelAmount" class="w-full p-3 rounded-lg" />
          </div>
        </div>
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
        <textarea id="combine_memoInput" class="w-full p-3 rounded-lg" rows="2"></textarea>
      </div>

      <button id="combine_saveBtn" class="btn-main" onclick="combine_saveLog()">ログを保存する</button>
    </div>

    <!-- 本日の稼働状況 (コンバイン) -->
    <div id="todayViewCombine" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
      <!-- コンバイン専用ヘッダー -->
      <header class="flex flex-col items-center justify-center py-4 relative">
        <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--combine-color)"><i
            class="fa-solid fa-bars"></i></button>
        <i class="fa-solid fa-wheat-awn text-5xl" style="color: var(--combine-color)"></i>
        <h1 class="text-xl font-bold" style="color: var(--combine-color)">和農日向 機械管理アプリ</h1>
      </header>

      <div class="flex items-center gap-2 mb-4 font-bold border-b-2 pb-2 text-lg"
        style="color: var(--combine-color); border-color: var(--combine-color)"><i class="fa-solid fa-calendar-day"></i>
        本日の稼働状況</div>
      <div id="todayLogListCombine" class="space-y-4"></div>
      <button onclick="switchView('combineView')" class="btn-sub">
        <i class="fa-solid fa-arrow-left mr-2"></i>ログ入力に戻る
      </button>
    </div>

    <!-- 稼働履歴・検索 (コンバイン) -->
    <div id="historyViewCombine" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
      <!-- コンバイン専用ヘッダー -->
      <header class="flex flex-col items-center justify-center py-4 relative">
        <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--combine-color)"><i
            class="fa-solid fa-bars"></i></button>
        <i class="fa-solid fa-wheat-awn text-5xl" style="color: var(--combine-color)"></i>
        <h1 class="text-xl font-bold" style="color: var(--combine-color)">和農日向 機械管理アプリ</h1>
      </header>

      <div class="flex items-center gap-2 mb-6 font-bold border-b-2 pb-3 text-lg w-full"
        style="color: var(--combine-color); border-color: var(--combine-color)">
        <i class="fa-solid fa-magnifying-glass"></i>
        <span>稼働履歴検索</span>
      </div>

      <div class="card space-y-3 text-sm mb-6">
        <div class="grid grid-cols-3 gap-3">
          <div class="flex flex-col gap-1">
            <label class="text-[10px] text-gray-400 font-bold ml-1">期間選択</label>
            <select id="filterPeriodTypeCombine" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm"
              onchange="togglePeriodInputCombine()">
              <option value="month">月単位</option>
              <option value="year">年単位</option>
            </select>
          </div>
          <div class="flex flex-col gap-1" id="filterMonthContainerCombine">
            <label class="text-[10px] text-gray-400 font-bold ml-1">対象月</label>
            <input type="month" id="filterMonthCombine" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm">
          </div>
          <div class="flex flex-col gap-1" id="filterYearContainerCombine" style="display: none;">
            <label class="text-[10px] text-gray-400 font-bold ml-1">対象年</label>
            <input type="number" id="filterYearCombine" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm"
              min="2000" max="2100" placeholder="例: 2026">
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-[10px] text-gray-400 font-bold ml-1">機械</label>
            <select id="filterMachineCombine" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm">
              <option value="">すべての機械</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mt-1">
          <div class="flex flex-col gap-1">
            <label class="text-[10px] text-gray-400 font-bold ml-1">オペレーター</label>
            <select id="filterOperatorCombine"
              class="p-3 rounded-lg w-full border border-gray-100 shadow-sm text-sm text-gray-600">
              <option value="">全オペレーター</option>
            </select>
          </div>

          <div class="flex flex-col gap-1">
            <label class="text-[10px] text-gray-400 font-bold ml-1">作業内容</label>
            <select id="filterCategoryCombine"
              class="p-3 rounded-lg w-full border border-gray-100 shadow-sm text-sm text-gray-600">
              <option value="">全作業内容</option>
            </select>
          </div>
        </div>

        <button onclick="loadLogsCombine('historyLogListCombine', false)" class="btn-main mt-2 shadow-md">
          検索を実行
        </button>
      </div>

      <div class="flex justify-end items-center mb-4 px-1">
        <div id="historyTotalHoursCombine"
          class="text-sm font-black opacity-80 bg-white px-4 py-2 rounded-full shadow-sm"
          style="color: var(--combine-color)">
          合計: 0.0 h
        </div>
      </div>

      <div id="historyLogListCombine" class="space-y-4"></div>

      <button onclick="switchView('combineView')" class="btn-sub mt-8">
        <i class="fa-solid fa-arrow-left mr-2"></i>ログ入力に戻る
      </button>
    </div>

    <!-- コンバイン メンテナンス機械一覧 -->
    <div id="maintenanceMachineListViewCombine" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
      <!-- コンバイン専用ヘッダー -->
      <header class="flex flex-col items-center justify-center py-4 relative">
        <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--combine-color)"><i
            class="fa-solid fa-bars"></i></button>
        <i class="fa-solid fa-wheat-awn text-5xl" style="color: var(--combine-color)"></i>
        <h1 class="text-xl font-bold" style="color: var(--combine-color)">和農日向 機械管理アプリ</h1>
      </header>

      <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg"
        style="color: var(--combine-color); border-bottom: 2px solid var(--combine-color);">
        <i class="fa-solid fa-wrench"></i> コンバイン メンテナンス記録
      </div>

      <div id="maintenanceMachineGridCombine" class="space-y-6">
      </div>

      <button onclick="switchView('maintenanceListView')" class="btn-sub mt-6 w-full">
        <i class="fa-solid fa-arrow-left mr-2"></i>メンテナンス管理に戻る
      </button>
    </div>

    <!-- コンバイン メンテナンス詳細 -->
    <div id="maintenanceDetailViewCombine" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
      <!-- コンバイン専用ヘッダー -->
      <header class="flex flex-col items-center justify-center py-4 relative">
        <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl text-[#c9a961] p-2"><i
            class="fa-solid fa-bars"></i></button>
        <i class="fa-solid fa-wheat-awn text-5xl text-[#c9a961]"></i>
        <h1 class="text-xl font-bold text-[#c9a961]">和農日向 機械管理アプリ</h1>
      </header>

      <!-- タイトル（機械名は JS で差し替える） -->
      <div class="flex items-center gap-2 mb-4 font-bold text-[#c9a961] border-b-2 border-[#c9a961] pb-2 text-lg">
        <i class="fa-solid fa-wheat-awn"></i>
        <span id="maintenanceMachineNameCombine">機械名</span>
      </div>

      <div class="card mb-4">
        <p class="font-bold text-sm text-gray-500 mb-2">メンテナンス進捗</p>
        <div id="maintenanceSummaryCombine" class="text-xs mt-1">
          未着手
        </div>
      </div>

      <div class="card mb-4">
        <p class="font-bold text-sm text-gray-500 mb-2">点検項目</p>
        <div id="maintenanceChecklistCombine" class="space-y-2">
        </div>
      </div>

      <!-- 作業履歴タイムライン -->
      <div class="card mb-4">
        <p class="font-bold text-sm text-gray-500 mb-2">作業履歴</p>
        <div id="maintenanceHistoryLogCombine" class="space-y-3 text-sm">
          <p class="italic text-gray-400 text-center py-4">履歴はありません</p>
        </div>
      </div>

      <div class="card mb-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
        <p class="font-bold text-sm text-[#c9a961] mb-4 flex items-center">
          <i class="fas fa-tools mr-2"></i>部品交換を記録
        </p>

        <label class="block text-xs font-bold text-gray-400 mb-1">交換部品・項目名</label>
        <input id="newMaintenanceItemCombine" type="text"
          class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#c9a961] outline-none">

        <label class="block text-xs font-bold text-gray-400 mb-1">担当者</label>
        <select id="newMaintenanceOperatorCombine"
          class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#c9a961] outline-none">
          <option value="">担当者を選択</option>
        </select>

        <label class="block text-xs font-bold text-gray-400 mb-1">状態</label>
        <select id="newMaintenanceStatusCombine"
          class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#c9a961] outline-none">
          <option value="done">完了</option>
          <option value="progress">作業中</option>
        </select>

        <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
        <textarea id="newMaintenanceMemoCombine" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-4"
          rows="2" placeholder="備考"></textarea>

        <button onclick="saveMaintenanceRecordCombine()"
          class="btn-main w-full py-3 bg-[#c9a961] text-white rounded-lg font-bold hover:bg-[#b8985a] transition-all shadow-md">
          部品交換を保存する
        </button>
      </div>

      <div class="flex justify-center w-full mt-6 mb-8">
        <button onclick="switchView('maintenanceMachineListViewCombine')"
          class="bg-gray-500 text-white px-6 py-2.5 rounded-lg hover:bg-gray-600 transition-colors whitespace-nowrap text-[13px] sm:text-sm shadow-md flex items-center justify-center">
          <i class="fas fa-arrow-left mr-2"></i>
          <span>メンテナンス一覧に戻る</span>
        </button>
      </div>
    </div>

    <!-- コンバイン Dashboard -->
    <div id="dashboardCombine" class="view fullscreen-view">
      <div class="bi-header">
        <button onclick="openMenu()" class="text-2xl mr-6 hover:opacity-70 transition-opacity"><i
            class="fa-solid fa-bars"></i></button>
        <h1 class="text-lg md:text-2xl font-black tracking-widest flex items-center">
          <i class="fa-solid fa-chart-column mr-3"></i> 2026 Combine data analysis
        </h1>
      </div>

      <div class="dashboard-top-bar">
        <div class="main-top-row">
          <div class="kpi-section">
            <div id="machineTabsCombine" class="flex gap-2 overflow-x-auto pb-1"></div>
            <div class="kpi-grid">
              <div class="kpi-card"><span class="kpi-label">総 稼 働</span>
                <div class="kpi-value-container"><span class="kpi-value" id="kpi-hours-combine">0.0</span><span
                    class="kpi-unit">h</span></div>
              </div>
              <div class="kpi-card"><span class="kpi-label">給 油</span>
                <div class="kpi-value-container"><span class="kpi-value" id="kpi-fuel-combine">0.0</span><span
                    class="kpi-unit">L</span></div>
              </div>
              <div class="kpi-card"><span class="kpi-label">燃 費</span>
                <div class="kpi-value-container"><span class="kpi-value" id="kpi-avg-combine">0.0</span><span
                    class="kpi-unit">L/h</span></div>
              </div>
              <div class="kpi-card"><span class="kpi-label">日 数</span>
                <div class="kpi-value-container"><span class="kpi-value" id="kpi-days-combine">0</span><span
                    class="kpi-unit">日</span></div>
              </div>
              <div class="kpi-card" style="background-color: var(--combine-color);"><span class="kpi-label">状
                  態</span><span class="kpi-value text-[15px]">良好</span></div>
            </div>
          </div>
          <div class="ranking-section">
            <p class="text-[11px] font-bold mb-2 text-center" style="color: var(--combine-color)"><i
                class="fa-solid fa-trophy mr-1"></i>稼働ランキング</p>
            <div id="rankListCombine" class="flex justify-around items-center"></div>
          </div>
        </div>
      </div>

      <div class="bi-container">
        <div class="bi-left-col">
          <div class="card">
            <p class="chart-title" style="display: flex; align-items: center;">
              <i class="fa-solid fa-screwdriver-wrench" style="margin-right: 8px; color: var(--combine-color);"></i>
              機械別修理コスト
            </p>
            <div class="chart-container">
              <div class="chart-wrapper">
                <canvas id="categoryShareChartCombine"></canvas>
              </div>
            </div>
          </div>

          <div class="card">
            <p class="chart-title" style="display: flex; align-items: center;">
              <i class="fa-solid fa-list-check" style="margin-right: 8px; color: var(--combine-color);"></i>
              作業内容比率
            </p>
            <div class="chart-container">
              <div class="chart-wrapper">
                <canvas id="taskShareChartCombine"></canvas>
              </div>
            </div>
          </div>

          <div class="card">
            <p class="chart-title" style="display: flex; align-items: center;">
              <i class="fa-solid fa-user-check" style="margin-right: 8px; color: var(--combine-color);"></i>
              オペレーター比率
            </p>
            <div class="chart-container">
              <div class="chart-wrapper">
                <canvas id="operatorShareChartCombine"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="bi-main-col">
          <div class="lg:col-span-2 space-y-4">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
              <p class="chart-title" style="display: flex; align-items: center;">
                <i class="fa-solid fa-calendar-days" style="margin-right: 8px; color: var(--combine-color);"></i>
                月別稼働推移
              </p>
              <div class="relative" style="height: 140px;"> <canvas id="detailChartCombine"></canvas>
              </div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
              <p class="chart-title" style="display: flex; align-items: center;">
                <i class="fa-solid fa-list-check" style="margin-right: 8px; color: var(--combine-color);"></i>
                作業内容分析
              </p>
              <div class="relative" style="height: 430px;">
                <canvas id="gradientBarChartCombine"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="bi-right-col">
          <div class="card yoy-card text-center relative">
            <p class="chart-title" style="display: flex; align-items: center; justify-content: center;">
              <i class="fa-solid fa-chart-line" style="margin-right: 8px; color: var(--combine-color);"></i>
              前年実績比 (YoY)
            </p>
            <div class="chart-wrapper relative">
              <canvas id="yearComparisonGaugeCombine"></canvas>
              <div class="absolute inset-0 flex items-center justify-center pt-14">
                <p id="detailCompareValueCombine" class="text-2xl font-black" style="color: var(--combine-color)">--%
                </p>
              </div>
            </div>
          </div>

          <div class="card maint-card overflow-hidden">
            <p class="chart-title border-b pb-1" style="display: flex; align-items: center;">
              <i class="fa-solid fa-clipboard-list" style="margin-right: 8px; color: var(--combine-color);"></i>
              メンテナンス情報
            </p>
            <div id="maintenanceLogCombine" class="text-[10px] space-y-2 opacity-80 pt-2 flex-1 overflow-y-auto">
              <p class="italic text-gray-400 text-center py-4">履歴はありません</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="dashboard" class="view fullscreen-view">
    <div class="bi-header">
      <button onclick="openMenu()" class="text-2xl hover:opacity-70 transition-opacity"><i
          class="fa-solid fa-bars"></i></button>
      <h1 class="text-3xl md:text-2xl font-black tracking-widest flex items-center" style="margin-left: 50px;">
        <i class="fa-solid fa-chart-column mr-3"></i> 2026 Tractor data analysis
      </h1>
    </div>

    <div class="dashboard-top-bar">
      <div class="main-top-row">
        <div class="kpi-section">
          <div id="machineTabs" class="flex gap-2 overflow-x-auto pb-1"></div>
          <div class="kpi-grid">
            <div class="kpi-card"><span class="kpi-label">総 稼 働</span>
              <div class="kpi-value-container"><span class="kpi-value" id="kpi-hours">0.0</span><span
                  class="kpi-unit">h</span></div>
            </div>
            <div class="kpi-card"><span class="kpi-label">給 油</span>
              <div class="kpi-value-container"><span class="kpi-value" id="kpi-fuel">0.0</span><span
                  class="kpi-unit">L</span></div>
            </div>
            <div class="kpi-card"><span class="kpi-label">燃 費</span>
              <div class="kpi-value-container"><span class="kpi-value" id="kpi-avg">0.0</span><span
                  class="kpi-unit">L/h</span></div>
            </div>
            <div class="kpi-card"><span class="kpi-label">日 数</span>
              <div class="kpi-value-container"><span class="kpi-value" id="kpi-days">0</span><span
                  class="kpi-unit">日</span></div>
            </div>
            <div class="kpi-card bg-[#4a6b50]"><span class="kpi-label">状 態</span><span
                class="kpi-value text-[15px]">良好</span></div>
          </div>
        </div>
        <div class="ranking-section">
          <p class="text-[11px] font-bold mb-2 text-center" style="color: var(--tractor-color)"><i
              class="fa-solid fa-trophy mr-1"></i>稼働ランキング</p>
          <div id="rankList" class="flex justify-around items-center"></div>
        </div>
      </div>
    </div>

    <div class="bi-container">
      <div class="bi-left-col">
        <div class="card">
          <p class="chart-title" style="display: flex; align-items: center;">
            <i class="fa-solid fa-screwdriver-wrench" style="margin-right: 8px; color: #6b8f71;"></i>
            機械別修理コスト
          </p>
          <div class="chart-wrapper relative">
            <canvas id="categoryShareChart"></canvas>
          </div>
        </div>

        <div class="card">
          <p class="chart-title" style="display: flex; align-items: center;">
            <i class="fa-solid fa-wheat-awn" style="margin-right: 8px; color: #6b8f71;"></i>
            作物別比率
          </p>
          <div class="chart-wrapper relative">
            <canvas id="taskShareChart"></canvas>
          </div>
        </div>

        <div class="card">
          <p class="chart-title" style="display: flex; align-items: center;">
            <i class="fa-solid fa-user-check" style="margin-right: 8px; color: #6b8f71;"></i>
            オペレーター比率
          </p>

          <div class="chart-wrapper relative">
            <canvas id="operatorShareChart"></canvas>
          </div>
        </div>
      </div>
      <div class="bi-main-col">
        <div class="lg:col-span-2 space-y-4">
          <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <p class="chart-title" style="display: flex; align-items: center;">
              <i class="fa-solid fa-calendar-days" style="margin-right: 8px; color: #6b8f71;"></i>
              月別稼働推移
            </p>
            <div class="relative" style="height: 150px;"> <canvas id="detailChart"></canvas>
            </div>
          </div>
          <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <p class="chart-title" style="display: flex; align-items: center;">
              <i class="fa-solid fa-list-check" style="margin-right: 8px; color: #6b8f71;"></i>
              作業内容分析
            </p>
            <div class="relative" style="height: 450px;">
              <canvas id="gradientBarChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="bi-right-col">
        <div class="card yoy-card text-center relative">
          <p class="chart-title" style="display: flex; align-items: center; justify-content: center;">
            <i class="fa-solid fa-chart-line" style="margin-right: 8px; color: #6b8f71;"></i>
            前年実績比 (YoY)
          </p>
          <div class="chart-wrapper relative">
            <canvas id="yearComparisonGauge"></canvas>
            <div class="absolute inset-0 flex items-center justify-center pt-14">
              <p id="detailCompareValue" class="text-2xl font-black" style="color: var(--tractor-color)">--%</p>
            </div>
          </div>
        </div>

        <div class="card maint-card overflow-hidden">
          <p class="chart-title border-b pb-1" style="display: flex; align-items: center;">
            <i class="fa-solid fa-clipboard-list" style="margin-right: 8px; color: #6b8f71;"></i>
            メンテナンス情報
          </p>
          <div id="maintenanceLog" class="text-[10px] space-y-2 opacity-80 pt-2 flex-1 overflow-y-auto">
            <p class="italic text-gray-400 text-center py-4">履歴はありません</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="todayView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
    <header class="flex flex-col items-center justify-center py-4 relative">
      <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--tractor-color)"><i
          class="fa-solid fa-bars"></i></button>
      <i class="fa-solid fa-tractor text-5xl" style="color: var(--tractor-color)"></i>
      <h1 class="text-xl font-bold" style="color: var(--tractor-color)">和農日向 機械管理アプリ</h1>
    </header>

    <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg"
      style="color: var(--tractor-color); border-bottom: 2px solid var(--tractor-color)"><i
        class="fa-solid fa-calendar-day"></i> 本日の稼働状況</div>
    <div id="todayLogList" class="space-y-4"></div>
    <button onclick="switchView('tractorView')" class="btn-sub">
      <i class="fa-solid fa-arrow-left mr-2"></i>ログ入力に戻る
    </button>
  </div>

  <div id="historyView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
    <header class="flex flex-col items-center justify-center py-4 relative">
      <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--tractor-color)"><i
          class="fa-solid fa-bars"></i></button>
      <i class="fa-solid fa-tractor text-5xl" style="color: var(--tractor-color)"></i>
      <h1 class="text-xl font-bold" style="color: var(--tractor-color)">和農日向 機械管理アプリ</h1>
    </header>

    <div class="flex items-center gap-2 mb-6 font-bold pb-3 text-lg w-full"
      style="color: var(--tractor-color); border-bottom: 2px solid var(--tractor-color)">
      <i class="fa-solid fa-magnifying-glass"></i>
      <span>稼働履歴検索</span>
    </div>

    <div class="card space-y-3 text-sm mb-6">
      <div class="grid grid-cols-3 gap-3">
        <div class="flex flex-col gap-1">
          <label class="text-[10px] text-gray-400 font-bold ml-1">期間選択</label>
          <select id="filterPeriodType" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm"
            onchange="togglePeriodInput()">
            <option value="month">月単位</option>
            <option value="year">年単位</option>
          </select>
        </div>
        <div class="flex flex-col gap-1" id="filterMonthContainer">
          <label class="text-[10px] text-gray-400 font-bold ml-1">対象月</label>
          <input type="month" id="filterMonth" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm">
        </div>
        <div class="flex flex-col gap-1" id="filterYearContainer" style="display: none;">
          <label class="text-[10px] text-gray-400 font-bold ml-1">対象年</label>
          <input type="number" id="filterYear" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm" min="2000"
            max="2100" placeholder="例: 2026">
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-[10px] text-gray-400 font-bold ml-1">機械</label>
          <select id="filterMachine" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm">
            <option value="">すべての機械</option>
          </select>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3 mt-1">
        <div class="flex flex-col gap-1">
          <label class="text-[10px] text-gray-400 font-bold ml-1">オペレーター</label>
          <select id="filterOperator"
            class="p-3 rounded-lg w-full border border-gray-100 shadow-sm text-sm text-gray-600">
            <option value="">全オペレーター</option>
          </select>
        </div>

        <div class="flex flex-col gap-1">
          <label class="text-[10px] text-gray-400 font-bold ml-1">作業内容</label>
          <select id="filterCategory"
            class="p-3 rounded-lg w-full border border-gray-100 shadow-sm text-sm text-gray-600">
            <option value="">全作業内容</option>
          </select>
        </div>
      </div>

      <button onclick="loadLogs('historyLogList', false)" class="btn-main mt-2 shadow-md">
        検索を実行
      </button>
    </div>

    <div class="flex justify-end items-center mb-4 px-1">
      <div id="historyTotalHours"
        class="text-sm font-black text-[#6b8f71] opacity-80 bg-white px-4 py-2 rounded-full shadow-sm">
        合計: 0.0 h
      </div>
    </div>

    <div id="historyLogList" class="space-y-4"></div>

    <button onclick="switchView('tractorView')" class="btn-sub mt-8">
      <i class="fa-solid fa-arrow-left mr-2"></i>ログ入力に戻る
    </button>
  </div>

  <!-- Maintenance List View -->
  <div id="maintenanceListView" class="view fullscreen-view">
    <div class="min-h-screen" style="background-color: #faf8f3;">
      <div class="max-w-6xl mx-auto px-4 py-12">
        <!-- ヘッダー -->
        <div class="text-center mb-12">
          <div class="inline-flex items-center justify-center w-20 h-20 rounded-full mb-6"
            style="background: linear-gradient(135deg, var(--maintenance-color) 0%, var(--maintenance-hover) 100%); box-shadow: 0 8px 24px rgba(95, 158, 160, 0.3);">
            <i class="fa-solid fa-toolbox text-4xl text-white"></i>
          </div>
          <h1 class="text-4xl font-bold mb-3" style="color: var(--maintenance-color);">メンテナンス管理</h1>
        </div>

        <!-- カードグリッド -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <!-- トラクター -->
          <div onclick="switchView('maintenanceMachineListView'); loadMachineList();"
            class="bg-white rounded-2xl p-5 shadow-lg hover:shadow-2xl transition-all duration-300 cursor-pointer transform hover:-translate-y-2"
            style="border-top: 4px solid var(--tractor-color);">
            <div class="flex flex-col items-center text-center">
              <div class="w-12 h-12 rounded-full flex items-center justify-center mb-3"
                style="background: linear-gradient(135deg, #3a4d3f 0%, #6b8f71 40%, #d1dbd3 100%); box-shadow: 0 4px 16px rgba(107,143,113,0.18);">
                <i class="fa-solid fa-tractor text-2xl text-white"></i>
              </div>
              <h3 class="text-lg font-bold" style="color: var(--tractor-color);">トラクター</h3>
            </div>
          </div>

          <!-- 田植え機 -->
          <div onclick="switchView('maintenanceMachineListViewPlanting');"
            class="bg-white rounded-2xl p-5 shadow-lg hover:shadow-2xl transition-all duration-300 cursor-pointer transform hover:-translate-y-2"
            style="border-top: 4px solid var(--planting-color);">
            <div class="flex flex-col items-center text-center">
              <div class="w-12 h-12 rounded-full flex items-center justify-center mb-3"
                style="background: linear-gradient(135deg, #2e5e4e 0%, #90b068 40%, #c9a961 100%); box-shadow: 0 4px 16px rgba(144,176,104,0.18);">
                <i class="fa-solid fa-seedling text-2xl text-white"></i>
              </div>
              <h3 class="text-lg font-bold" style="color: var(--planting-color);">田植え機</h3>
            </div>
          </div>

          <!-- コンバイン -->
          <div onclick="switchView('maintenanceMachineListViewCombine');"
            class="bg-white rounded-2xl p-5 shadow-lg hover:shadow-2xl transition-all duration-300 cursor-pointer transform hover:-translate-y-2"
            style="border-top: 4px solid var(--combine-color);">
            <div class="flex flex-col items-center text-center">
              <div class="w-12 h-12 rounded-full flex items-center justify-center mb-3"
                style="background: linear-gradient(135deg, #7c3f2c 0%, #C97C73 40%, #f2c9b6 100%); box-shadow: 0 4px 16px rgba(201,124,115,0.18);">
                <i class="fa-solid fa-wheat-awn text-2xl text-white"></i>
              </div>
              <h3 class="text-lg font-bold" style="color: var(--combine-color);">コンバイン</h3>
            </div>
          </div>

          <!-- ラップマシーン -->
          <div onclick="switchView('maintenanceMachineListViewWrapper'); loadMachineListWrapper();"
            class="bg-white rounded-2xl p-5 shadow-lg hover:shadow-2xl transition-all duration-300 cursor-pointer transform hover:-translate-y-2"
            style="border-top: 4px solid #6b395f;">
            <div class="flex flex-col items-center text-center">
              <div class="w-12 h-12 rounded-full flex items-center justify-center mb-3"
                style="background: linear-gradient(135deg, #3a1d2e 0%, #6b395f 40%, #bfa2c9 100%); box-shadow: 0 4px 16px rgba(107,57,95,0.18);">
                <i class="fa-solid fa-tape text-2xl text-white"></i>
              </div>
              <h3 class="text-lg font-bold" style="color: #6b395f;">ラップマシーン</h3>
            </div>
          </div>

          <!-- その他の機械 -->
          <div onclick="switchView('maintenanceMachineListViewOtherMachinery'); loadMachineListOtherMachinery();"
            class="bg-white rounded-2xl p-5 shadow-lg hover:shadow-2xl transition-all duration-300 cursor-pointer transform hover:-translate-y-2"
            style="border-top: 4px solid var(--other-color);">
            <div class="flex flex-col items-center text-center">
              <div class="w-12 h-12 rounded-full flex items-center justify-center mb-3"
                style="background: linear-gradient(135deg, #5c4632 0%, #8B7355 40%, #e2c9a0 100%); box-shadow: 0 4px 16px rgba(139,115,85,0.18);">
                <i class="fas fa-tachometer-alt text-2xl text-white"></i>
              </div>
              <h3 class="text-lg font-bold" style="color: var(--other-color);">その他の機械</h3>
            </div>
          </div>

          <!-- 刈払い機 -->
          <div onclick="switchView('maintenanceMachineListViewBrushCutter'); loadMachineListBrushCutter();"
            class="bg-white rounded-2xl p-5 shadow-lg hover:shadow-2xl transition-all duration-300 cursor-pointer transform hover:-translate-y-2"
            style="border-top: 4px solid #418b89;">
            <div class="flex flex-col items-center text-center">
              <div class="w-12 h-12 rounded-full flex items-center justify-center mb-3"
                style="background: linear-gradient(135deg, #1b3c3b 0%, #418b89 40%, #a2d4d4 100%); box-shadow: 0 4px 16px rgba(65,139,137,0.18);">
                <i class="fa-solid fa-scissors text-2xl text-white"></i>
              </div>
              <h3 class="text-lg font-bold" style="color: #418b89;">刈払い機</h3>
            </div>
          </div>

          <!-- スパイダーモア -->
          <div onclick="switchView('maintenanceMachineListViewMower'); loadMachineListMower();"
            class="bg-white rounded-2xl p-5 shadow-lg hover:shadow-2xl transition-all duration-300 cursor-pointer transform hover:-translate-y-2"
            style="border-top: 4px solid #666633;">
            <div class="flex flex-col items-center text-center">
              <div class="w-12 h-12 rounded-full flex items-center justify-center mb-3"
                style="background: linear-gradient(135deg, #33331a 0%, #666633 40%, #d1d1a3 100%); box-shadow: 0 4px 16px rgba(102,102,51,0.18);">
                <i class="fa-solid fa-spider text-2xl text-white"></i>
              </div>
              <h3 class="text-lg font-bold" style="color: #666633;">モア</h3>
            </div>
          </div>

          <!-- インプルメント -->
          <div onclick="switchView('maintenanceMachineListViewImplement'); loadMachineListImplement();"
            class="bg-white rounded-2xl p-5 shadow-lg hover:shadow-2xl transition-all duration-300 cursor-pointer transform hover:-translate-y-2"
            style="border-top: 4px solid #483D8B;">
            <div class="flex flex-col items-center text-center">
              <div class="w-12 h-12 rounded-full flex items-center justify-center mb-3"
                style="background: linear-gradient(135deg, #241c4b 0%, #483D8B 40%, #b3a6e0 100%); box-shadow: 0 4px 16px rgba(72,61,139,0.18);">
                <i class="fa-solid fa-gears text-2xl text-white"></i>
              </div>
              <h3 class="text-lg font-bold" style="color: #483D8B;">インプルメント</h3>
            </div>
          </div>

          <!-- 動力散布機 -->
          <div onclick="switchView('maintenanceMachineListViewSpreader'); loadMachineListSpreader();"
            class="bg-white rounded-2xl p-5 shadow-lg hover:shadow-2xl transition-all duration-300 cursor-pointer transform hover:-translate-y-2"
            style="border-top: 4px solid #DB7093;">
            <div class="flex flex-col items-center text-center">
              <div class="w-12 h-12 rounded-full flex items-center justify-center mb-3"
                style="background: linear-gradient(135deg, #7a3457 0%, #DB7093 40%, #f7c6e0 100%); box-shadow: 0 4px 16px rgba(219,112,147,0.18);">
                <i class="fa-solid fa-seedling text-2xl text-white"></i>
              </div>
              <h3 class="text-lg font-bold" style="color: #DB7093;">動力散布機</h3>
            </div>
          </div>

          <!-- 動力噴霧機 -->
          <div onclick="switchView('maintenanceMachineListViewSprayer'); loadMachineListSprayer();"
            class="bg-white rounded-2xl p-5 shadow-lg hover:shadow-2xl transition-all duration-300 cursor-pointer transform hover:-translate-y-2"
            style="border-top: 4px solid #06b6d4;">
            <div class="flex flex-col items-center text-center">
              <div class="w-12 h-12 rounded-full flex items-center justify-center mb-3"
                style="background: linear-gradient(135deg, #0284c7 0%, #06b6d4 40%, #164e63 100%); box-shadow: 0 4px 16px rgba(6,182,212,0.25);">
                <i class="fa-solid fa-droplet text-2xl text-white"></i>
              </div>
              <h3 class="text-lg font-bold" style="color: #06b6d4;">動力噴霧機</h3>
              <p class="text-xs text-gray-400 mt-1">準備中…</p>
            </div>
          </div>
        </div>

        <!-- ポータルに戻るボタン -->
        <div class="text-center">
          <button onclick="switchView('portalView')"
            class="inline-flex items-center px-8 py-3 text-white rounded-xl font-medium shadow-md hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1"
            style="background: linear-gradient(135deg, var(--maintenance-color) 0%, var(--maintenance-hover) 100%);"
            onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 28px rgba(95, 158, 160, 0.4)';"
            onmouseout="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 6px rgba(0, 0, 0, 0.1)';">
            <i class="fa-solid fa-house mr-2"></i>
            portalに戻る
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="maintenanceMachineListView"
    class="view fullscreen-view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
    <!-- メンテナンス専用ヘッダー -->
    <header class="flex flex-col items-center justify-center py-4 relative">
      <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: #6b8f71;"><i
          class="fa-solid fa-bars"></i></button>
      <i class="fa-solid fa-tractor text-5xl" style="color: #6b8f71;"></i>
      <h1 class="text-xl font-bold" style="color: #6b8f71;">和農日向 機械管理アプリ</h1>
    </header>

    <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg"
      style="color: #6b8f71; border-bottom: 2px solid #6b8f71;">
      <i class="fa-solid fa-wrench"></i> トラクターメンテナンス記録
    </div>

    <div id="maintenanceMachineGrid" class="space-y-6">
    </div>

    <button onclick="switchView('maintenanceListView')" class="btn-sub mt-6 w-full"
      style="background: #6b8f71; color: white; border: 2px solid #6b8f71;">
      <i class="fa-solid fa-arrow-left mr-2"></i>メンテナンス管理に戻る
    </button>
  </div>

  <!-- Mower (スパイダーモア・ウイングモア) メンテナンス一覧 -->
  <div id="maintenanceMachineListViewMower"
    class="view fullscreen-view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
    <header class="flex flex-col items-center justify-center py-4 relative">
      <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: #666633;"><i
          class="fa-solid fa-bars"></i></button>
      <i class="fa-solid fa-spider text-5xl" style="color: #666633;"></i>
      <h1 class="text-xl font-bold" style="color: #666633;">和農日向 機械管理アプリ</h1>
    </header>

    <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg"
      style="color: #666633; border-bottom: 2px solid #666633;">
      <i class="fa-solid fa-wrench"></i> モア メンテナンス記録
    </div>

    <div id="maintenanceMachineGridMower" class="space-y-6">
    </div>

    <button onclick="switchView('maintenanceListView')" class="btn-sub mt-6 w-full"
      style="background: #666633; color: white; border: 2px solid #666633;">
      <i class="fa-solid fa-arrow-left mr-2"></i>メンテナンス管理に戻る
    </button>
  </div>

  <!-- 刈払い機メンテナンス -->
  <div id="maintenanceMachineListViewBrushCutter"
    class="view fullscreen-view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
    <header class="flex flex-col items-center justify-center py-4 relative">
      <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: #418b89;"><i
          class="fa-solid fa-bars"></i></button>
      <i class="fa-solid fa-scissors text-5xl" style="color: #418b89;"></i>
      <h1 class="text-xl font-bold" style="color: #418b89;">和農日向 機械管理アプリ</h1>
    </header>

    <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg"
      style="color: #418b89; border-bottom: 2px solid #418b89;">
      <i class="fa-solid fa-wrench"></i> 刈払い機メンテナンス記録
    </div>

    <div id="maintenanceMachineGridBrushCutter" class="space-y-6">
    </div>

    <button onclick="switchView('maintenanceListView')" class="btn-sub mt-6 w-full"
      style="background: #418b89; color: white; border: 2px solid #418b89;">
      <i class="fa-solid fa-arrow-left mr-2"></i>メンテナンス管理に戻る
    </button>
  </div>

  <!-- 刈払い機メンテナンス詳細 -->
  <div id="maintenanceDetailViewBrushCutter"
    class="view fullscreen-view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
    <header class="flex flex-col items-center justify-center py-4 relative">
      <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: #418b89;"><i
          class="fa-solid fa-bars"></i></button>
      <i class="fa-solid fa-scissors text-5xl" style="color: #418b89;"></i>
      <h1 class="text-xl font-bold" style="color: #418b89;">和農日向 機械管理アプリ</h1>
    </header>

    <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg"
      style="color: #418b89; border-bottom: 2px solid #418b89;">
      <i class="fa-solid fa-scissors"></i>
      <span id="maintenanceMachineNameBrushCutter">機械名</span>
    </div>

    <div class="card mb-4">
      <p class="font-bold text-sm text-gray-500 mb-2">メンテナンス進捗</p>
      <div id="maintenanceSummaryBrushCutter" class="text-xs mt-1">
        未着手
      </div>
    </div>

    <div class="card mb-4">
      <p class="font-bold text-sm text-gray-500 mb-2">点検項目</p>
      <div id="maintenanceChecklistBrushCutter" class="space-y-2">
      </div>
    </div>

    <div class="card mb-4">
      <p class="font-bold text-sm text-gray-500 mb-2">作業履歴</p>
      <div id="maintenanceHistoryLogBrushCutter" class="space-y-3 text-sm">
        <p class="italic text-gray-400 text-center py-4">履歴はありません</p>
      </div>
    </div>

    <div class="card mb-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
      <p class="font-bold text-sm mb-4 flex items-center" style="color: #418b89;">
        <i class="fas fa-tools mr-2"></i>部品交換を記録
      </p>

      <label class="block text-xs font-bold text-gray-400 mb-1">交換部品・項目名</label>
      <input id="newMaintenanceItemBrushCutter" type="text"
        class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#418b89] outline-none">

      <label class="block text-xs font-bold text-gray-400 mb-1">担当者</label>
      <select id="newMaintenanceOperatorBrushCutter"
        class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#418b89] outline-none">
        <option value="">担当者を選択</option>
      </select>

      <label class="block text-xs font-bold text-gray-400 mb-1">状態</label>
      <select id="newMaintenanceStatusBrushCutter"
        class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#418b89] outline-none">
        <option value="done">完了</option>
        <option value="progress">作業中</option>
      </select>

      <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
      <textarea id="newMaintenanceMemoBrushCutter" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-4"
        rows="2" placeholder="備考"></textarea>

      <button onclick="saveMaintenanceRecordBrushCutter()"
        class="btn-main w-full py-3 text-white rounded-lg font-bold hover:bg-[#336d6b] transition-all shadow-md"
        style="background: #418b89;">
        部品交換を保存する
      </button>
    </div>

    <div class="flex justify-center w-full mt-6 mb-8">
      <button onclick="switchView('maintenanceMachineListViewBrushCutter')"
        class="px-6 py-3 rounded-lg font-medium transition-all shadow-md text-white hover:bg-[#336d6b] flex items-center justify-center"
        style="background: #418b89;">
        <i class="fa-solid fa-list mr-2"></i>
        <span>メンテナンス一覧に戻る</span>
      </button>
    </div>
  </div>

  <!-- スパイダーモアメンテナンス -->
  <div id="maintenanceMachineListViewSpiderMower"
    class="view fullscreen-view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
    <header class="flex flex-col items-center justify-center py-4 relative">
      <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: #f59e0b;"><i
          class="fa-solid fa-bars"></i></button>
      <i class="fa-solid fa-spider text-5xl" style="color: #f59e0b;"></i>
      <h1 class="text-xl font-bold" style="color: #f59e0b;">和農日向 機械管理アプリ</h1>
    </header>

    <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg"
      style="color: #f59e0b; border-bottom: 2px solid #f59e0b;">
      <i class="fa-solid fa-wrench"></i> スパイダーモアメンテナンス記録
    </div>

    <div id="maintenanceMachineGridSpiderMower" class="space-y-6">
    </div>

    <button onclick="switchView('maintenanceListView')" class="btn-sub mt-6 w-full"
      style="background: #f59e0b; color: white; border: 2px solid #f59e0b;">
      <i class="fa-solid fa-arrow-left mr-2"></i>メンテナンス管理に戻る
    </button>
  </div>

  <!-- ウイングモアメンテナンス -->
  <div id="maintenanceMachineListViewWingMower"
    class="view fullscreen-view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
    <header class="flex flex-col items-center justify-center py-4 relative">
      <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: #84cc16;"><i
          class="fa-solid fa-bars"></i></button>
      <i class="fa-solid fa-leaf text-5xl" style="color: #84cc16;"></i>
      <h1 class="text-xl font-bold" style="color: #84cc16;">和農日向 機械管理アプリ</h1>
    </header>

    <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg"
      style="color: #84cc16; border-bottom: 2px solid #84cc16;">
      <i class="fa-solid fa-wrench"></i> ウイングモアメンテナンス記録
    </div>

    <div id="maintenanceMachineGridWingMower" class="space-y-6">
    </div>

    <button onclick="switchView('maintenanceListView')" class="btn-sub mt-6 w-full"
      style="background: #84cc16; color: white; border: 2px solid #84cc16;">
      <i class="fa-solid fa-arrow-left mr-2"></i>メンテナンス一覧に戻る
    </button>
  </div>

  <!-- インプルメントメンテナンス -->
  <div id="maintenanceMachineListViewImplement"
    class="view fullscreen-view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
    <header class="flex flex-col items-center justify-center py-4 relative">
      <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: #483D8B;"><i
          class="fa-solid fa-bars"></i></button>
      <i class="fa-solid fa-gears text-5xl" style="color: #483D8B;"></i>
      <h1 class="text-xl font-bold" style="color: #483D8B;">和農日向 機械管理アプリ</h1>
    </header>

    <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg"
      style="color: #483D8B; border-bottom: 2px solid #483D8B;">
      <i class="fa-solid fa-wrench"></i> インプルメントメンテナンス記録
    </div>

    <div id="maintenanceMachineGridImplement" class="space-y-6">
    </div>

    <button onclick="switchView('maintenanceListView')" class="btn-sub mt-6 w-full"
      style="background: #483D8B; color: white; border: 2px solid #483D8B;">
      <i class="fa-solid fa-arrow-left mr-2"></i>メンテナンス一覧に戻る
    </button>
  </div>

  <!-- インプルメントメンテナンス詳細 -->
  <div id="maintenanceDetailViewImplement"
    class="view fullscreen-view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
    <header class="flex flex-col items-center justify-center py-4 relative">
      <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: #483D8B;"><i
          class="fa-solid fa-bars"></i></button>
      <i class="fa-solid fa-gears text-5xl" style="color: #483D8B;"></i>
      <h1 class="text-xl font-bold" style="color: #483D8B;">和農日向 機械管理アプリ</h1>
    </header>

    <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg"
      style="color: #483D8B; border-bottom: 2px solid #483D8B;">
      <i class="fa-solid fa-gears"></i>
      <span id="maintenanceMachineNameImplement">機械名</span>
    </div>

    <div class="card mb-4">
      <p class="font-bold text-sm text-gray-500 mb-2">メンテナンス進捗</p>
      <div id="maintenanceSummaryImplement" class="text-xs mt-1">
        未着手
      </div>
    </div>

    <div class="card mb-4">
      <p class="font-bold text-sm text-gray-500 mb-2">点検項目</p>
      <div id="maintenanceChecklistImplement" class="space-y-2">
      </div>
    </div>

    <div class="card mb-4">
      <p class="font-bold text-sm text-gray-500 mb-2">作業履歴</p>
      <div id="maintenanceHistoryLogImplement" class="space-y-3 text-sm">
        <p class="italic text-gray-400 text-center py-4">履歴はありません</p>
      </div>
    </div>

    <div class="card mb-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
      <p class="font-bold text-sm mb-4 flex items-center" style="color: #483D8B;">
        <i class="fas fa-tools mr-2"></i>部品交換を記録
      </p>

      <label class="block text-xs font-bold text-gray-400 mb-1">交換部品・項目名</label>
      <input id="newMaintenanceItemImplement" type="text"
        class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#483D8B] outline-none">

      <label class="block text-xs font-bold text-gray-400 mb-1">担当者</label>
      <select id="newMaintenanceOperatorImplement"
        class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#483D8B] outline-none">
        <option value="">担当者を選択</option>
      </select>

      <label class="block text-xs font-bold text-gray-400 mb-1">状態</label>
      <select id="newMaintenanceStatusImplement"
        class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#483D8B] outline-none">
        <option value="done">完了</option>
        <option value="progress">作業中</option>
      </select>

      <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
      <textarea id="newMaintenanceMemoImplement" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-4"
        rows="2" placeholder="備考"></textarea>

      <button onclick="saveMaintenanceRecordImplement()"
        class="btn-main w-full py-3 text-white rounded-lg font-bold transition-all shadow-md"
        style="background: #483D8B;" onmouseover="this.style.backgroundColor='#3a2f6f'"
        onmouseout="this.style.backgroundColor='#483D8B'">
        部品交換を保存する
      </button>
    </div>

    <div class="flex justify-center w-full mt-6 mb-8">
      <button onclick="switchView('maintenanceMachineListViewImplement'); loadMachineListImplement();"
        class="px-6 py-3 rounded-lg font-medium transition-all shadow-md text-white flex items-center justify-center"
        style="background: #483D8B;" onmouseover="this.style.backgroundColor='#3a2f6f'"
        onmouseout="this.style.backgroundColor='#483D8B'">
        <i class="fa-solid fa-list mr-2"></i>
        <span>メンテナンス一覧に戻る</span>
      </button>
    </div>
  </div>

  <!-- 動力散布機メンテナンス -->
  <div id="maintenanceMachineListViewSpreader"
    class="view fullscreen-view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
    <header class="flex flex-col items-center justify-center py-4 relative">
      <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: #DB7093;"><i
          class="fa-solid fa-bars"></i></button>
      <i class="fa-solid fa-seedling text-5xl" style="color: #DB7093;"></i>
      <h1 class="text-xl font-bold" style="color: #DB7093;">和農日向 機械管理アプリ</h1>
    </header>

    <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg"
      style="color: #DB7093; border-bottom: 2px solid #DB7093;">
      <i class="fa-solid fa-wrench"></i> 動力散布機メンテナンス記録
    </div>

    <div id="maintenanceMachineGridSpreader" class="space-y-6">
    </div>

    <button onclick="switchView('maintenanceListView')" class="btn-sub mt-6 w-full"
      style="background: #DB7093; color: white; border: 2px solid #DB7093;">
      <i class="fa-solid fa-arrow-left mr-2"></i>メンテナンス管理に戻る
    </button>
  </div>

  <!-- 動力散布機メンテナンス詳細 -->
  <div id="maintenanceDetailViewSpreader"
    class="view fullscreen-view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
    <header class="flex flex-col items-center justify-center py-4 relative">
      <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: #DB7093;"><i
          class="fa-solid fa-bars"></i></button>
      <i class="fa-solid fa-seedling text-5xl" style="color: #DB7093;"></i>
      <h1 class="text-xl font-bold" style="color: #DB7093;">和農日向 機械管理アプリ</h1>
    </header>

    <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg"
      style="color: #DB7093; border-bottom: 2px solid #DB7093;">
      <i class="fa-solid fa-seedling"></i>
      <span id="maintenanceMachineNameSpreader">機械名</span>
    </div>

    <div class="card mb-4">
      <p class="font-bold text-sm text-gray-500 mb-2">メンテナンス進捗</p>
      <div id="maintenanceSummarySpreader" class="text-xs mt-1">
        未着手
      </div>
    </div>

    <div class="card mb-4">
      <p class="font-bold text-sm text-gray-500 mb-2">点検項目</p>
      <div id="maintenanceChecklistSpreader" class="space-y-2">
      </div>
    </div>

    <div class="card mb-4">
      <p class="font-bold text-sm text-gray-500 mb-2">作業履歴</p>
      <div id="maintenanceHistoryLogSpreader" class="space-y-3 text-sm">
        <p class="italic text-gray-400 text-center py-4">履歴はありません</p>
      </div>
    </div>

    <div class="card mb-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
      <p class="font-bold text-sm mb-4 flex items-center" style="color: #DB7093;">
        <i class="fas fa-tools mr-2"></i>部品交換を記録
      </p>

      <label class="block text-xs font-bold text-gray-400 mb-1">交換部品・項目名</label>
      <input id="newMaintenanceItemSpreader" type="text"
        class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#DB7093] outline-none">

      <label class="block text-xs font-bold text-gray-400 mb-1">担当者</label>
      <select id="newMaintenanceOperatorSpreader"
        class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#DB7093] outline-none">
        <option value="">担当者を選択</option>
      </select>

      <label class="block text-xs font-bold text-gray-400 mb-1">状態</label>
      <select id="newMaintenanceStatusSpreader"
        class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#DB7093] outline-none">
        <option value="done">完了</option>
        <option value="progress">作業中</option>
      </select>

      <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
      <textarea id="newMaintenanceMemoSpreader" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-4"
        rows="2" placeholder="備考"></textarea>

      <button onclick="saveMaintenanceRecordSpreader()"
        class="btn-main w-full py-3 text-white rounded-lg font-bold transition-all shadow-md"
        style="background: #DB7093;" onmouseover="this.style.backgroundColor='#C6608A'"
        onmouseout="this.style.backgroundColor='#DB7093'">
        部品交換を保存する
      </button>
    </div>

    <div class="flex justify-center w-full mt-6 mb-8">
      <button onclick="switchView('maintenanceMachineListViewSpreader')"
        class="px-6 py-3 rounded-lg font-medium transition-all shadow-md text-white flex items-center justify-center"
        style="background: #DB7093;" onmouseover="this.style.backgroundColor='#C6608A'"
        onmouseout="this.style.backgroundColor='#DB7093'">
        <i class="fa-solid fa-arrow-left mr-2"></i>
        <span>メンテナンス一覧に戻る</span>
      </button>
    </div>
  </div>

  <!-- 動力噴霧器メンテナンス -->
  <div id="maintenanceMachineListViewSprayer"
    class="view fullscreen-view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
    <header class="flex flex-col items-center justify-center py-4 relative">
      <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: #06b6d4;"><i
          class="fa-solid fa-bars"></i></button>
      <i class="fa-solid fa-droplet text-5xl" style="color: #06b6d4;"></i>
      <h1 class="text-xl font-bold" style="color: #06b6d4;">和農日向 機械管理アプリ</h1>
    </header>

    <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg"
      style="color: #06b6d4; border-bottom: 2px solid #06b6d4;">
      <i class="fa-solid fa-wrench"></i> 動力噴霧器メンテナンス記録
    </div>

    <div id="maintenanceMachineGridSprayer" class="space-y-6">
    </div>

    <button onclick="switchView('maintenanceListView')" class="btn-sub mt-6 w-full"
      style="background: #06b6d4; color: white; border: 2px solid #06b6d4;">
      <i class="fa-solid fa-arrow-left mr-2"></i>メンテナンス管理に戻る
    </button>
  </div>

  <!-- ラップマシーンメンテナンス -->
  <div id="maintenanceMachineListViewWrapper"
    class="view fullscreen-view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
    <header class="flex flex-col items-center justify-center py-4 relative">
      <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: #6b395f;"><i
          class="fa-solid fa-bars"></i></button>
      <i class="fa-solid fa-tape text-5xl" style="color: #6b395f;"></i>
      <h1 class="text-xl font-bold" style="color: #6b395f;">和農日向 機械管理アプリ</h1>
    </header>

    <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg"
      style="color: #6b395f; border-bottom: 2px solid #6b395f;">
      <i class="fa-solid fa-wrench"></i> ラップマシーンメンテナンス記録
    </div>

    <div id="maintenanceMachineGridWrapper" class="space-y-6">
    </div>

    <button onclick="switchView('maintenanceListView')" class="btn-sub mt-6 w-full"
      style="background: #6b395f; color: white; border: 2px solid #6b395f;">
      <i class="fa-solid fa-arrow-left mr-2"></i>メンテナンス管理に戻る
    </button>
  </div>

  <!-- ラップマシーンメンテナンス詳細 -->
  <div id="maintenanceDetailViewWrapper"
    class="view fullscreen-view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
    <header class="flex flex-col items-center justify-center py-4 relative">
      <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: #6b395f;"><i
          class="fa-solid fa-bars"></i></button>
      <i class="fa-solid fa-tape text-5xl" style="color: #6b395f;"></i>
      <h1 class="text-xl font-bold" style="color: #6b395f;">和農日向 機械管理アプリ</h1>
    </header>

    <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg"
      style="color: #6b395f; border-bottom: 2px solid #6b395f;">
      <i class="fa-solid fa-tape"></i>
      <span id="maintenanceMachineNameWrapper">機械名</span>
    </div>

    <div class="card mb-4">
      <p class="font-bold text-sm text-gray-500 mb-2">メンテナンス進捗</p>
      <div id="maintenanceSummaryWrapper" class="text-xs mt-1">
        未着手
      </div>
    </div>

    <div class="card mb-4">
      <p class="font-bold text-sm text-gray-500 mb-2">点検項目</p>
      <div id="maintenanceChecklistWrapper" class="space-y-2">
      </div>
    </div>

    <div class="card mb-4">
      <p class="font-bold text-sm text-gray-500 mb-2">作業履歴</p>
      <div id="maintenanceHistoryLogWrapper" class="space-y-3 text-sm">
        <p class="italic text-gray-400 text-center py-4">履歴はありません</p>
      </div>
    </div>

    <div class="card mb-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
      <p class="font-bold text-sm mb-4 flex items-center" style="color: #6b395f;">
        <i class="fas fa-tools mr-2"></i>部品交換を記録
      </p>

      <label class="block text-xs font-bold text-gray-400 mb-1">交換部品・項目名</label>
      <input id="newMaintenanceItemWrapper" type="text"
        class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#6b395f] outline-none">

      <label class="block text-xs font-bold text-gray-400 mb-1">担当者</label>
      <select id="newMaintenanceOperatorWrapper"
        class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#6b395f] outline-none">
        <option value="">担当者を選択</option>
      </select>

      <label class="block text-xs font-bold text-gray-400 mb-1">状態</label>
      <select id="newMaintenanceStatusWrapper"
        class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#6b395f] outline-none">
        <option value="done">完了</option>
        <option value="progress">作業中</option>
      </select>

      <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
      <textarea id="newMaintenanceMemoWrapper" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-4"
        rows="2" placeholder="備考"></textarea>

      <button onclick="saveMaintenanceRecordWrapper()"
        class="btn-main w-full py-3 text-white rounded-lg font-bold transition-all shadow-md"
        style="background: #6b395f;" onmouseover="this.style.backgroundColor='#552e4c'"
        onmouseout="this.style.backgroundColor='#6b395f'">
        部品交換を保存する
      </button>
    </div>

    <div class="flex justify-center w-full mt-6 mb-8">
      <button onclick="switchView('maintenanceMachineListViewWrapper'); loadMachineListWrapper();"
        class="px-6 py-3 rounded-lg font-medium transition-all shadow-md text-white flex items-center justify-center"
        style="background: #6b395f;" onmouseover="this.style.backgroundColor='#552e4c'"
        onmouseout="this.style.backgroundColor='#6b395f'">
        <i class="fa-solid fa-arrow-left mr-2"></i>
        <span>メンテナンス一覧に戻る</span>
      </button>
    </div>
  </div>

  <!-- スパイダーモアメンテナンス詳細 -->
  <div id="maintenanceDetailViewSpiderMower"
    class="view fullscreen-view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
    <header class="flex flex-col items-center justify-center py-4 relative">
      <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: #666633;"><i
          class="fa-solid fa-bars"></i></button>
      <i class="fa-solid fa-spider text-5xl" style="color: #666633;"></i>
      <h1 class="text-xl font-bold" style="color: #666633;">和農日向 機械管理アプリ</h1>
    </header>

    <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg"
      style="color: #666633; border-bottom: 2px solid #666633;">
      <i class="fa-solid fa-spider"></i>
      <span id="maintenanceMachineNameSpiderMower">機械名</span>
    </div>

    <div class="card mb-4">
      <p class="font-bold text-sm text-gray-500 mb-2">メンテナンス進捗</p>
      <div id="maintenanceSummarySpiderMower" class="text-xs mt-1">
        未着手
      </div>
    </div>

    <div class="card mb-4">
      <p class="font-bold text-sm text-gray-500 mb-2">点検項目</p>
      <div id="maintenanceChecklistSpiderMower" class="space-y-2">
      </div>
    </div>

    <div class="card mb-4">
      <p class="font-bold text-sm text-gray-500 mb-2">作業履歴</p>
      <div id="maintenanceHistoryLogSpiderMower" class="space-y-3 text-sm">
        <p class="italic text-gray-400 text-center py-4">履歴はありません</p>
      </div>
    </div>

    <div class="card mb-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
      <p class="font-bold text-sm mb-4 flex items-center" style="color: #666633;">
        <i class="fas fa-tools mr-2"></i>部品交換を記録
      </p>

      <label class="block text-xs font-bold text-gray-400 mb-1">交換部品・項目名</label>
      <input id="newMaintenanceItemSpiderMower" type="text"
        class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#666633] outline-none">

      <label class="block text-xs font-bold text-gray-400 mb-1">担当者</label>
      <select id="newMaintenanceOperatorSpiderMower"
        class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#666633] outline-none">
        <option value="">担当者を選択</option>
      </select>

      <label class="block text-xs font-bold text-gray-400 mb-1">状態</label>
      <select id="newMaintenanceStatusSpiderMower"
        class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#666633] outline-none">
        <option value="done">完了</option>
        <option value="progress">作業中</option>
      </select>

      <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
      <textarea id="newMaintenanceMemoSpiderMower" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-4"
        rows="2" placeholder="備考"></textarea>

      <button onclick="saveMaintenanceRecordSpiderMower()"
        class="btn-main w-full py-3 text-white rounded-lg font-bold hover:bg-[#555522] transition-all shadow-md"
        style="background: #666633;">
        部品交換を保存する
      </button>
    </div>

    <div class="flex justify-center w-full mt-6 mb-8">
      <button onclick="switchView('maintenanceMachineListViewMower'); loadMachineListMower();"
        class="px-6 py-3 rounded-lg font-medium transition-all shadow-md text-white hover:bg-[#555522] flex items-center justify-center"
        style="background: #666633;">
        <i class="fa-solid fa-list mr-2"></i>
        <span>メンテナンス一覧に戻る</span>
      </button>
    </div>
  </div>

  <!-- ウイングモアメンテナンス詳細 -->
  <div id="maintenanceDetailViewWingMower"
    class="view fullscreen-view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
    <header class="flex flex-col items-center justify-center py-4 relative">
      <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: #666633;"><i
          class="fa-solid fa-bars"></i></button>
      <i class="fa-solid fa-leaf text-5xl" style="color: #666633;"></i>
      <h1 class="text-xl font-bold" style="color: #666633;">和農日向 機械管理アプリ</h1>
    </header>

    <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg"
      style="color: #666633; border-bottom: 2px solid #666633;">
      <i class="fa-solid fa-leaf"></i>
      <span id="maintenanceMachineNameWingMower">機械名</span>
    </div>

    <div class="card mb-4">
      <p class="font-bold text-sm text-gray-500 mb-2">メンテナンス進捗</p>
      <div id="maintenanceSummaryWingMower" class="text-xs mt-1">
        未着手
      </div>
    </div>

    <div class="card mb-4">
      <p class="font-bold text-sm text-gray-500 mb-2">点検項目</p>
      <div id="maintenanceChecklistWingMower" class="space-y-2">
      </div>
    </div>

    <div class="card mb-4">
      <p class="font-bold text-sm text-gray-500 mb-2">作業履歴</p>
      <div id="maintenanceHistoryLogWingMower" class="space-y-3 text-sm">
        <p class="italic text-gray-400 text-center py-4">履歴はありません</p>
      </div>
    </div>

    <div class="card mb-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
      <p class="font-bold text-sm mb-4 flex items-center" style="color: #666633;">
        <i class="fas fa-tools mr-2"></i>部品交換を記録
      </p>

      <label class="block text-xs font-bold text-gray-400 mb-1">交換部品・項目名</label>
      <input id="newMaintenanceItemWingMower" type="text"
        class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#666633] outline-none">

      <label class="block text-xs font-bold text-gray-400 mb-1">担当者</label>
      <select id="newMaintenanceOperatorWingMower"
        class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#666633] outline-none">
        <option value="">担当者を選択</option>
      </select>

      <label class="block text-xs font-bold text-gray-400 mb-1">状態</label>
      <select id="newMaintenanceStatusWingMower"
        class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#666633] outline-none">
        <option value="done">完了</option>
        <option value="progress">作業中</option>
      </select>

      <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
      <textarea id="newMaintenanceMemoWingMower" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-4"
        rows="2" placeholder="備考"></textarea>

      <button onclick="saveMaintenanceRecordWingMower()"
        class="btn-main w-full py-3 text-white rounded-lg font-bold hover:bg-[#555522] transition-all shadow-md"
        style="background: #666633;">
        部品交換を保存する
      </button>
    </div>

    <div class="flex justify-center w-full mt-6 mb-8">
      <button onclick="switchView('maintenanceMachineListViewMower'); loadMachineListMower();"
        class="px-6 py-3 rounded-lg font-medium transition-all shadow-md text-white hover:bg-[#555522] flex items-center justify-center"
        style="background: #666633;">
        <i class="fa-solid fa-list mr-2"></i>
        <span>メンテナンス一覧に戻る</span>
      </button>
    </div>
  </div>

  <!-- その他の機械メンテナンス一覧 -->
  <div id="maintenanceMachineListViewOtherMachinery"
    class="view fullscreen-view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
    <header class="flex flex-col items-center justify-center py-4 relative">
      <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--other-color);"><i
          class="fa-solid fa-bars"></i></button>
      <i class="fas fa-tachometer-alt text-5xl" style="color: var(--other-color);"></i>
      <h1 class="text-xl font-bold" style="color: var(--other-color);">和農日向 機械管理アプリ</h1>
    </header>

    <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg"
      style="color: var(--other-color); border-bottom: 2px solid var(--other-color);">
      <i class="fa-solid fa-wrench"></i> その他の機械メンテナンス記録
    </div>

    <div id="maintenanceMachineGridOtherMachinery" class="space-y-6">
    </div>

    <button onclick="switchView('maintenanceListView')" class="btn-sub mt-6 w-full"
      style="background: var(--other-color); color: white; border: 2px solid var(--other-color);">
      <i class="fa-solid fa-arrow-left mr-2"></i>メンテナンス管理に戻る
    </button>
  </div>

  <!-- その他の機械メンテナンス詳細 -->
  <div id="maintenanceDetailViewOtherMachinery"
    class="view fullscreen-view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
    <header class="flex flex-col items-center justify-center py-4 relative">
      <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--other-color);"><i
          class="fa-solid fa-bars"></i></button>
      <i class="fas fa-tachometer-alt text-5xl" style="color: var(--other-color);"></i>
      <h1 class="text-xl font-bold" style="color: var(--other-color);">和農日向 機械管理アプリ</h1>
    </header>

    <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg"
      style="color: var(--other-color); border-bottom: 2px solid var(--other-color);">
      <i class="fas fa-tachometer-alt"></i>
      <span id="maintenanceMachineNameOtherMachinery">機械名</span>
    </div>

    <div class="card mb-4">
      <p class="font-bold text-sm text-gray-500 mb-2">メンテナンス進捗</p>
      <div id="maintenanceSummaryOtherMachinery" class="text-xs mt-1">
        未着手
      </div>
    </div>

    <div class="card mb-4">
      <p class="font-bold text-sm text-gray-500 mb-2">点検項目</p>
      <div id="maintenanceChecklistOtherMachinery" class="space-y-2">
      </div>
    </div>

    <div class="card mb-4">
      <p class="font-bold text-sm text-gray-500 mb-2">作業履歴</p>
      <div id="maintenanceHistoryLogOtherMachinery" class="space-y-3 text-sm">
        <p class="italic text-gray-400 text-center py-4">履歴はありません</p>
      </div>
    </div>

    <div class="card mb-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
      <p class="font-bold text-sm mb-4 flex items-center" style="color: var(--other-color);">
        <i class="fas fa-tools mr-2"></i>部品交換を記録
      </p>

      <label class="block text-xs font-bold text-gray-400 mb-1">交換部品・項目名</label>
      <input id="newMaintenanceItemOtherMachinery" type="text"
        class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-4" placeholder="エンジンオイル、タイヤ、バッテリー等">

      <label class="block text-xs font-bold text-gray-400 mb-1">担当者</label>
      <select id="newMaintenanceOperatorOtherMachinery"
        class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-4">
        <option value="">選択してください</option>
      </select>

      <label class="block text-xs font-bold text-gray-400 mb-1">状態</label>
      <select id="newMaintenanceStatusOtherMachinery"
        class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-4">
        <option value="completed">完了</option>
        <option value="progress">作業中</option>
      </select>

      <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
      <textarea id="newMaintenanceMemoOtherMachinery"
        class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-4" rows="2" placeholder="備考"></textarea>

      <button onclick="saveMaintenanceRecordOtherMachinery()"
        class="btn-main w-full py-3 text-white rounded-lg font-bold transition-all shadow-md"
        style="background: var(--other-color);" onmouseover="this.style.background='var(--other-hover)'"
        onmouseout="this.style.background='var(--other-color)'">
        部品交換を保存する
      </button>
    </div>

    <div class="flex justify-center w-full mt-6 mb-8">
      <button onclick="switchView('maintenanceMachineListViewOtherMachinery'); loadMachineListOtherMachinery();"
        class="px-6 py-3 rounded-lg font-medium transition-all shadow-md text-white flex items-center justify-center"
        style="background: var(--other-color);" onmouseover="this.style.background='var(--other-hover)'"
        onmouseout="this.style.background='var(--other-color)'">
        <i class="fa-solid fa-list mr-2"></i>
        <span>メンテナンス一覧に戻る</span>
      </button>
    </div>
  </div>

  <!-- Other Machinery Section -->
  <div id="other-machinery-section">
    <div id="otherMachineryView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
      <!-- その他の機械専用ヘッダー -->
      <header id="pageHeader" class="flex flex-col items-center justify-center py-4 relative">
        <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--other-color)"><i
            class="fa-solid fa-bars"></i></button>
        <i class="fas fa-tachometer-alt text-5xl" style="color: var(--other-color)"></i>
        <h1 class="text-xl font-bold" style="color: var(--other-color)">和農日向 機械管理アプリ</h1>
      </header>

      <div class="flex items-center gap-2 mb-1 mt-4">
        <i class="fa-solid fa-pen-to-square text-lg" style="color: var(--other-color)"></i>
        <span class="text-lg font-bold" style="color: var(--other-color)">ログ入力</span>
      </div>
      <div class="border-t-2 mb-6 opacity-50" style="border-color: var(--other-color)"></div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">機械を選択</label>
        <select id="machineSelectOther" class="w-full p-3 rounded-lg" onchange="autoFillHourOther()"></select>
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">作業日</label>
        <input type="date" id="workDateOther" class="w-full p-3 rounded-lg" />
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">オペレーター</label>
        <select id="operatorOther" class="w-full p-3 rounded-lg">
          <option value="">読込中...</option>
        </select>
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">作業内容</label>
        <select id="work_nameOther" class="w-full p-3 rounded-lg">
          <option value="">読込中...</option>
        </select>
      </div>

      <div class="card">
        <div class="flex space-x-4">
          <div class="flex-1">
            <label class="block text-xs font-bold text-gray-400 mb-1">稼働前</label>
            <input type="number" id="hourBeforeOther" class="w-full p-3 rounded-lg font-bold" step="0.1"
              oninput="calcDiffOther()" />
          </div>
          <div class="flex-1 min-w-0">
            <label class="block text-xs font-bold text-gray-400 mb-1">稼働後</label>
            <div class="flex items-center gap-2 min-w-0">
              <input type="number" id="hourAfterOther" class="flex-1 min-w-0 p-3 rounded-lg font-bold" step="0.1"
                oninput="calcDiffOther()" />
              <input type="file" id="hourAfterImageOther" accept="image/*" capture="environment" class="hidden"
                onchange="handleHourAfterImageOther(this)">
              <button type="button" onclick="document.getElementById('hourAfterImageOther').click()"
                class="flex-none p-2 bg-white border rounded-lg shadow-sm hover:bg-gray-50"
                style="color: var(--other-color)"><i class="fa-solid fa-camera"></i></button>
            </div>
          </div>
        </div>
      </div>

      <div id="hourDiffDisplayOther" class="text-right font-black mb-6 text-xl" style="color: var(--other-color)">稼働時間:
        0.0 h</div>

      <div class="card">
        <div class="flex gap-4">
          <div class="flex-1">
            <label class="block text-xs font-bold text-gray-400 mb-1">油種</label>
            <select id="fuelTypeOther" class="w-full p-3 rounded-lg">
              <option value="">読込中...</option>
            </select>
          </div>
          <div class="flex-[2]">
            <label class="block text-xs font-bold text-gray-400 mb-1">給油量 (L)</label>
            <input type="number" id="fuelAmountOther" class="w-full p-3 rounded-lg" />
          </div>
        </div>
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
        <textarea id="memoInputOther" class="w-full p-3 rounded-lg" rows="2"></textarea>
      </div>

      <button id="saveBtnOther" class="btn-main" onclick="saveLogOther()">ログを保存する</button>
    </div>

    <!-- 本日の稼働状況 (その他の機械) -->
    <div id="todayViewOther" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0 hidden">
      <header class="flex flex-col items-center justify-center py-4 relative">
        <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--other-color)"><i
            class="fa-solid fa-bars"></i></button>
        <i class="fas fa-tachometer-alt text-5xl" style="color: var(--other-color)"></i>
        <h1 class="text-xl font-bold" style="color: var(--other-color)">和農日向 機械管理アプリ</h1>
      </header>

      <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg"
        style="color: var(--other-color); border-bottom: 2px solid var(--other-color)">
        <i class="fa-solid fa-calendar-day"></i> 本日の稼働状況
      </div>

      <div id="todayLogsOther"></div>

      <button onclick="switchView('otherMachineryView')" class="btn-sub mt-6 w-full">
        <i class="fa-solid fa-arrow-left mr-2"></i>ログ入力に戻る
      </button>
    </div>

    <!-- 稼働履歴・検索 (その他の機械) -->
    <div id="historyViewOther" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0 hidden">
      <header class="flex flex-col items-center justify-center py-4 relative">
        <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--other-color)"><i
            class="fa-solid fa-bars"></i></button>
        <i class="fas fa-tachometer-alt text-5xl" style="color: var(--other-color)"></i>
        <h1 class="text-xl font-bold" style="color: var(--other-color)">和農日向 機械管理アプリ</h1>
      </header>

      <div class="flex items-center gap-2 mb-6 font-bold pb-3 text-lg w-full"
        style="color: var(--other-color); border-bottom: 2px solid var(--other-color)">
        <i class="fa-solid fa-magnifying-glass"></i>
        <span>稼働履歴検索</span>
      </div>

      <div class="card space-y-3 text-sm mb-6">
        <div class="grid grid-cols-3 gap-3">
          <div class="flex flex-col gap-1">
            <label class="text-[10px] text-gray-400 font-bold ml-1">期間選択</label>
            <select id="filterPeriodTypeOther" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm"
              onchange="togglePeriodInputOther()">
              <option value="month">月単位</option>
              <option value="year">年単位</option>
            </select>
          </div>
          <div class="flex flex-col gap-1" id="filterMonthContainerOther">
            <label class="text-[10px] text-gray-400 font-bold ml-1">対象月</label>
            <input type="month" id="filterMonthOther" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm">
          </div>
          <div class="flex flex-col gap-1" id="filterYearContainerOther" style="display: none;">
            <label class="text-[10px] text-gray-400 font-bold ml-1">対象年</label>
            <input type="number" id="filterYearOther" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm"
              min="2000" max="2100" placeholder="例: 2026">
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-[10px] text-gray-400 font-bold ml-1">機械</label>
            <select id="filterMachineOther" class="p-3 rounded-lg w-full border border-gray-100 shadow-sm">
              <option value="">すべての機械</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mt-1">
          <div class="flex flex-col gap-1">
            <label class="text-[10px] text-gray-400 font-bold ml-1">オペレーター</label>
            <select id="filterOperatorOther"
              class="p-3 rounded-lg w-full border border-gray-100 shadow-sm text-sm text-gray-600">
              <option value="">全オペレーター</option>
            </select>
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-[10px] text-gray-400 font-bold ml-1">作業内容</label>
            <select id="filterTaskOther"
              class="p-3 rounded-lg w-full border border-gray-100 shadow-sm text-sm text-gray-600">
              <option value="">全作業内容</option>
            </select>
          </div>
        </div>

        <button onclick="loadHistoryOther()" class="btn-main mt-2 shadow-md">
          検索を実行
        </button>
      </div>

      <div class="flex justify-end items-center mb-4 px-1">
        <div id="historyTotalHoursOther" class="text-sm font-black opacity-80 bg-white px-4 py-2 rounded-full shadow-sm"
          style="color: var(--other-color)">
          合計: 0.0 h
        </div>
      </div>

      <div id="historyResultsOther" class="space-y-4"></div>

      <button onclick="switchView('otherMachineryView')" class="btn-sub mt-6 w-full">
        <i class="fa-solid fa-arrow-left mr-2"></i>ログ入力に戻る
      </button>
    </div>

    <!-- その他の機械 Dashboard -->
    <div id="dashboardOther" class="view fullscreen-view">
      <div class="bi-header">
        <button onclick="openMenu()" class="text-2xl mr-6 hover:opacity-70 transition-opacity"><i
            class="fa-solid fa-bars"></i></button>
        <h1 class="text-lg md:text-2xl font-black tracking-widest flex items-center">
          <i class="fa-solid fa-chart-column mr-3"></i> 2026 Other Machinery Data Analysis
        </h1>
      </div>

      <div class="dashboard-top-bar">
        <div class="main-top-row">
          <div class="kpi-section">
            <div id="machineTabsOther" class="flex gap-2 overflow-x-auto pb-1"></div>
            <div class="kpi-grid">
              <div class="kpi-card"><span class="kpi-label">総 稼 働</span>
                <div class="kpi-value-container"><span class="kpi-value" id="kpi-hours-other">0.0</span><span
                    class="kpi-unit">h</span></div>
              </div>
              <div class="kpi-card"><span class="kpi-label">給 油</span>
                <div class="kpi-value-container"><span class="kpi-value" id="kpi-fuel-other">0.0</span><span
                    class="kpi-unit">L</span></div>
              </div>
              <div class="kpi-card"><span class="kpi-label">燃 費</span>
                <div class="kpi-value-container"><span class="kpi-value" id="kpi-avg-other">0.0</span><span
                    class="kpi-unit">L/h</span></div>
              </div>
              <div class="kpi-card"><span class="kpi-label">日 数</span>
                <div class="kpi-value-container"><span class="kpi-value" id="kpi-days-other">0</span><span
                    class="kpi-unit">日</span></div>
              </div>
              <div class="kpi-card" style="background-color: var(--other-color);"><span class="kpi-label">状
                  態</span><span class="kpi-value text-[15px]">良好</span></div>
            </div>
          </div>
          <div class="ranking-section">
            <p class="text-[11px] font-bold mb-2 text-center" style="color: var(--other-color)"><i
                class="fa-solid fa-trophy mr-1"></i>稼働ランキング</p>
            <div id="rankListOther" class="flex justify-around items-center"></div>
          </div>
        </div>
      </div>

      <div class="bi-container">
        <div class="bi-left-col">
          <div class="card">
            <p class="chart-title" style="display: flex; align-items: center;">
              <i class="fa-solid fa-screwdriver-wrench" style="margin-right: 8px; color: var(--other-color);"></i>
              機械別修理コスト
            </p>
            <div class="chart-wrapper relative">
              <canvas id="categoryShareChartOther"></canvas>
            </div>
          </div>
          <div class="card">
            <p class="chart-title" style="display: flex; align-items: center;">
              <i class="fa-solid fa-wheat-awn" style="margin-right: 8px; color: var(--other-color);"></i>
              作物別比率
            </p>
            <div class="chart-wrapper relative">
              <canvas id="taskShareChartOther"></canvas>
            </div>
          </div>
          <div class="card operator-card">
            <p class="chart-title" style="display: flex; align-items: center;">
              <i class="fa-solid fa-user-check" style="margin-right: 8px; color: var(--other-color);"></i>
              オペレーター比率
            </p>
            <div class="flex items-center justify-center">
              <div class="chart-container" style="width: 60%; min-width: 120px; height: 160px;">
                <canvas id="operatorShareChartOther"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="bi-main-col">
          <div class="lg:col-span-2 space-y-4">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
              <p class="chart-title" style="display: flex; align-items: center;">
                <i class="fa-solid fa-calendar-days" style="margin-right: 8px; color: var(--other-color);"></i>
                月別稼働推移
              </p>
              <div class="relative" style="height: 140px;">
                <canvas id="detailChartOther"></canvas>
              </div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
              <p class="chart-title" style="display: flex; align-items: center;">
                <i class="fa-solid fa-list-check" style="margin-right: 8px; color: var(--other-color);"></i>
                作業内容分析
              </p>
              <div class="relative" style="height: 430px;">
                <canvas id="gradientBarChartOther"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="bi-right-col">
          <div class="card yoy-card text-center relative">
            <p class="chart-title" style="display: flex; align-items: center; justify-content: center;">
              <i class="fa-solid fa-chart-line" style="margin-right: 8px; color: var(--other-color);"></i>
              前年実績比 (YoY)
            </p>
            <div class="chart-wrapper relative">
              <canvas id="yearComparisonGaugeOther"></canvas>
              <div class="absolute inset-0 flex items-center justify-center pt-14">
                <p id="detailCompareValueOther" class="text-2xl font-black" style="color: var(--other-color)">--%</p>
              </div>
            </div>
          </div>

          <div class="card maint-card overflow-hidden">
            <p class="chart-title border-b pb-1" style="display: flex; align-items: center;">
              <i class="fa-solid fa-clipboard-list" style="margin-right: 8px; color: var(--other-color);"></i>
              メンテナンス情報
            </p>
            <div id="maintenanceLogOther" class="text-[10px] space-y-2 opacity-80 pt-2 flex-1 overflow-y-auto">
              <p class="italic text-gray-400 text-center py-4">履歴はありません</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Repair Section -->
  <div id="repair-section">
    <div id="repairView" class="view px-4 max-w-5xl mx-auto pb-0 hidden" style="background-color: var(--repair-bg);">
      <!-- 修理専用ヘッダー -->
      <header class="flex flex-col items-center justify-center py-4 relative">
        <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--repair-color);"><i
            class="fa-solid fa-bars"></i></button>
        <i class="fa-solid fa-screwdriver-wrench text-5xl" style="color: var(--repair-color);"></i>
        <h1 class="text-xl font-bold" style="color: var(--repair-color);">和農日向 機械管理アプリ</h1>
      </header>

      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl md:text-2xl font-extrabold flex items-center gap-2" style="color: var(--repair-color);">
          <i class="fa-solid fa-screwdriver-wrench"></i> 修理履歴
        </h2>
        <button onclick="switchView('invoiceOCRView'); populateMachineSelect();"
          class="text-white px-5 py-2 rounded-full shadow-lg active:scale-95 transition-all text-xs font-bold"
          style="background-color: var(--repair-color);">
          <i class="fa-solid fa-plus mr-1"></i> 新規登録
        </button>
      </div>

      <div class="rounded-[2rem] p-6 text-white shadow-xl mb-8 relative overflow-hidden"
        style="background: linear-gradient(to bottom right, var(--repair-color), var(--repair-hover));">
        <div class="relative z-10">
          <p class="text-white/80 text-[16px] md:text-xs font-medium mb-1 uppercase tracking-widest">2026年度 累計修理費</p>
          <h3 id="totalRepairCost" class="text-3xl md:text-5xl font-black tracking-wider">¥ 0</h3>
          <div class="mt-4 flex gap-4 text-[12px] text-white/80">
            <span><i class="fa-solid fa-screwdriver-wrench mr-1"></i> 修理の登録は右上の「+新規登録」から</span>
          </div>
        </div>
        <i class="fa-solid fa-gears absolute -right-4 -bottom-4 text-white/10 text-7xl md:text-8xl rotate-12"></i>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col">
          <div class="flex items-center gap-2 mb-4 font-bold border-b border-gray-50 pb-2 text-sm"
            style="color: var(--repair-color);">
            <i class="fa-solid fa-calendar-days"></i> 年ごとの修理費
          </div>
          <div id="yearlyRepairContainer" class="space-y-2 flex-grow text-sm">
          </div>
        </div>

        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col">
          <div class="flex items-center gap-2 mb-4 font-bold border-b border-gray-50 pb-2 text-sm"
            style="color: var(--repair-color);">
            <i class="fa-solid fa-microchip"></i> 機械ごとの集計
          </div>
          <div id="machineRepairContainer" class="space-y-2 flex-grow text-sm">
          </div>
        </div>

        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col">
          <div class="flex items-center gap-2 mb-4 font-bold border-b border-gray-50 pb-2 text-sm"
            style="color: var(--repair-color);">
            <i class="fa-solid fa-clock-rotate-left"></i> 最近の修理
          </div>
          <div id="recentRepairContainer" class="space-y-3 flex-grow">
          </div>
        </div>
      </div>

      <div class="flex justify-center w-full mt-6 mb-8">
        <button onclick="switchView('portalView')" class="btn-sub w-full">
          <i class="fa-solid fa-house mr-2"></i>portalに戻る
        </button>
      </div>
    </div>

    <div id="invoiceOCRView" class="view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0 hidden">
      <!-- トラクター専用ヘッダー -->
      <header class="flex flex-col items-center justify-center py-4 relative">
        <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl text-[#6b8f71] p-2"><i
            class="fa-solid fa-bars"></i></button>
        <i class="fa-solid fa-tractor text-5xl text-[#6b8f71]"></i>
        <h1 class="text-xl font-bold text-[#6b8f71]">和農日向 機械管理アプリ</h1>
      </header>

      <div class="flex items-center gap-2 mb-4 font-bold text-[#6b8f71] border-b-2 border-[#6b8f71] pb-2 text-lg">
        <i class="fa-solid fa-screwdriver-wrench"></i> 修理の登録
      </div>

      <!-- 請求書の読み取り -->
      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">請求書・領収書の撮影</label>

        <input type="file" id="invoiceImage" accept="image/*" capture="environment" class="hidden"
          onchange="previewInvoice(this)">

        <button onclick="document.getElementById('invoiceImage').click()"
          class="w-full py-4 border-2 border-dashed border-[#6b8f71] rounded-lg text-[#6b8f71] flex flex-col items-center gap-2 hover:bg-[#f0f7f1] transition-colors">
          <i class="fa-solid fa-camera text-2xl"></i>
          <span class="text-sm font-bold">カメラを起動 / 画像を選択</span>
        </button>

        <div id="invoicePreviewArea" class="mt-4 hidden text-center">
          <img id="invoicePreviewImg" src="" class="w-full rounded-lg shadow-md mb-2 opacity-50">
          <p class="text-[10px] text-gray-500">解析用プレビュー（画像は保存されません）</p>
        </div>
      </div>

      <!-- 種別選択 -->
      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">種別</label>
        <select id="repairMachineType" class="w-full p-3 rounded-lg" onchange="filterMachinesByType()">
          <option value="">選択してください</option>
        </select>
      </div>

      <!-- 自動入力される項目 -->
      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">対象の機械</label>
        <select id="repairMachineSelect" class="w-full p-3 rounded-lg border bg-white">
        </select>
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">修理日</label>
        <input type="date" id="repairDate" class="w-full p-3 rounded-lg">
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">店舗名</label>
        <input type="text" id="repairShop" class="w-full p-3 rounded-lg">
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">金額</label>
        <input type="number" id="repairCost" class="w-full p-3 rounded-lg">
      </div>

      <div class="card">
        <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
        <textarea id="repairMemo" class="w-full p-3 rounded-lg" rows="3"></textarea>
      </div>

      <button id="saveRepairBtn" class="btn-main" onclick="saveRepairLog()">修理履歴を保存</button>
      <button onclick="switchView('repairView'); loadRepairDashboard();" class="btn-sub mt-4 w-full">修理履歴へ戻る</button>

    </div>
  </div>

  <!-- Maintenance Detail View -->
  <div id="maintenanceDetailView" class="view fullscreen-view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
    <!-- トラクター専用ヘッダー -->
    <header class="flex flex-col items-center justify-center py-4 relative">
      <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: #6b8f71;"><i
          class="fa-solid fa-bars"></i></button>
      <i class="fa-solid fa-tractor text-5xl" style="color: #6b8f71;"></i>
      <h1 class="text-xl font-bold" style="color: #6b8f71;">和農日向 機械管理アプリ</h1>
    </header>

    <!-- タイトル（機械名は JS で差し替える） -->
    <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg"
      style="color: #6b8f71; border-bottom: 2px solid #6b8f71;">
      <i class="fa-solid fa-tractor"></i>
      <span id="maintenanceMachineName">機械名</span>
    </div>

    <div class="card mb-4">
      <p class="font-bold text-sm text-gray-500 mb-2">メンテナンス進捗</p>
      <div id="maintenanceSummary" class="text-xs mt-1">
        未着手
      </div>
    </div>

    <div class="card mb-4">
      <p class="font-bold text-sm text-gray-500 mb-2">点検項目</p>
      <div id="maintenanceChecklist" class="space-y-2">
      </div>
    </div>

    <!-- 作業履歴タイムライン -->
    <div class="card mb-4">
      <p class="font-bold text-sm text-gray-500 mb-2">作業履歴</p>
      <div id="maintenanceHistoryLog" class="space-y-3 text-sm">
        <p class="italic text-gray-400 text-center py-4">履歴はありません</p>
      </div>
    </div>

    <div class="card mb-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
      <p class="font-bold text-sm text-[#6b8f71] mb-4 flex items-center">
        <i class="fas fa-tools mr-2"></i>部品交換を記録
      </p>

      <label class="block text-xs font-bold text-gray-400 mb-1">交換部品・項目名</label>
      <input id="newMaintenanceItem" type="text"
        class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#6b8f71] outline-none">

      <label class="block text-xs font-bold text-gray-400 mb-1">担当者</label>
      <select id="newMaintenanceOperator"
        class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#6b8f71] outline-none">
        <option value="">担当者を選択</option>
      </select>

      <label class="block text-xs font-bold text-gray-400 mb-1">状態</label>
      <select id="newMaintenanceStatus"
        class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-[#6b8f71] outline-none">
        <option value="done">完了</option>
        <option value="progress">作業中</option>
      </select>

      <label class="block text-xs font-bold text-gray-400 mb-1">メモ</label>
      <textarea id="newMaintenanceMemo" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-4" rows="2"
        placeholder="備考"></textarea>

      <button onclick="saveMaintenanceRecord()"
        class="btn-main w-full py-3 text-white rounded-lg font-bold transition-all shadow-md"
        style="background-color: #6b8f71 !important;" onmouseover="this.style.backgroundColor='#5a7a5f'"
        onmouseout="this.style.backgroundColor='#6b8f71'">
        部品交換を保存する
      </button>
    </div>

    <div class="flex justify-center w-full mt-6 mb-8">
      <button onclick="switchView('maintenanceMachineListView')"
        class="px-6 py-3 rounded-lg font-medium transition-all shadow-md text-white hover:bg-[#5a7a60] flex items-center justify-center"
        style="background: #6b8f71;">
        <i class="fa-solid fa-arrow-left mr-2"></i>
        <span>メンテナンス一覧に戻る</span>
      </button>
    </div>
  </div>
  </div>

  <!-- Export View -->
  <div id="exportView" class="view fullscreen-view" style="background: #faf9f6;">
    <div class="px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0">
      <header class="flex flex-col items-center justify-center py-4 relative">
        <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--export-color);"><i
            class="fa-solid fa-bars"></i></button>
        <i class="fa-solid fa-file-export text-5xl" style="color: var(--export-color);"></i>
        <h1 class="text-xl font-bold" style="color: var(--export-color);">和農日向 機械管理アプリ</h1>
      </header>

      <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg"
        style="color: var(--export-color); border-bottom: 2px solid var(--export-color);">
        <i class="fa-solid fa-file-export"></i> Data Export
      </div>

      <!-- 絞り込み条件 -->
      <div class="card mb-4">
        <h3 class="font-bold mb-3 flex items-center gap-2" style="color: var(--export-color);">
          <i class="fa-solid fa-filter"></i>絞り込み条件
        </h3>

        <div class="space-y-3">
          <!-- データタイプ選択 -->
          <div>
            <label class="block text-xs font-bold text-gray-400 mb-1">データタイプ</label>
            <select id="exportDataType" class="w-full p-3 rounded-lg" onchange="updateExportPreview()">
              <option value="tractor">トラクター稼働ログ</option>
              <option value="planting">田植え機稼働ログ</option>
              <option value="combine">コンバイン稼働ログ</option>
              <option value="maintenance">メンテナンス記録</option>
              <option value="repair">修理記録</option>
            </select>
          </div>

          <!-- 期間選択 -->
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-bold text-gray-400 mb-1">開始日</label>
              <input type="date" id="exportStartDate" class="w-full p-3 rounded-lg" onchange="updateExportPreview()">
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-400 mb-1">終了日</label>
              <input type="date" id="exportEndDate" class="w-full p-3 rounded-lg" onchange="updateExportPreview()">
            </div>
          </div>

          <!-- 機械選択 -->
          <div id="exportMachineFilter">
            <label class="block text-xs font-bold text-gray-400 mb-1">機械（オプション）</label>
            <select id="exportMachine" class="w-full p-3 rounded-lg" onchange="updateExportPreview()">
              <option value="">全ての機械</option>
            </select>
          </div>

          <!-- オペレーター選択 -->
          <div id="exportOperatorFilter">
            <label class="block text-xs font-bold text-gray-400 mb-1">オペレーター（オプション）</label>
            <select id="exportOperator" class="w-full p-3 rounded-lg" onchange="updateExportPreview()">
              <option value="">全てのオペレーター</option>
            </select>
          </div>
        </div>
      </div>

      <!-- データプレビュー -->
      <div class="card mb-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-bold flex items-center gap-2" style="color: var(--export-color);">
            <i class="fa-solid fa-table"></i>Data Preview
          </h3>
          <span id="previewCount" class="text-sm text-gray-600">0件</span>
        </div>

        <div class="overflow-x-auto">
          <div id="exportPreviewTable" class="text-sm preview-only">
            <p class="text-center text-gray-500 py-8">条件を選択してください</p>
          </div>
          <div id="exportPrintTable" class="text-sm print-only" style="display: none;">
          </div>
        </div>
      </div>

      <!-- エクスポートボタン -->
      <div class="card mb-4">
        <button id="exportButton" onclick="executeExport()" class="btn w-full" disabled>
          <i class="fa-solid fa-download mr-2"></i>このデータをExcelでダウンロード
        </button>
      </div>

      <div class="card mb-4" style="background: white; border: 2px solid var(--export-color); border-left-width: 6px;">
        <div class="flex items-center gap-2 mb-2">
          <i class="fa-solid fa-print text-xl" style="color: var(--export-color);"></i>
          <h3 class="font-bold" style="color: var(--export-color);">印刷機能</h3>
        </div>
        <p class="text-sm mb-3" style="color: var(--export-color); opacity: 0.8;">
          現在表示しているページをそのまま印刷できます。印刷時にはボタンや入力欄などが自動的に非表示になります。</p>
        <button onclick="window.print()" class="w-full py-3 px-6 rounded-lg font-bold transition-all shadow-md"
          style="background-color: var(--export-color); color: white;">
          <i class="fa-solid fa-print mr-2"></i>このページを印刷
        </button>
      </div>

      <button onclick="switchView('portalView')" class="btn-sub mt-8">
        <i class="fa-solid fa-home mr-2"></i>portalに戻る
      </button>
    </div>
  </div>

  <div id="versionView" class="view fullscreen-view px-4 max-w-xl md:max-w-3xl lg:max-w-4xl mx-auto pb-0"
    data-version="1.0.0">
    <!-- バージョン情報専用ヘッダー -->
    <header class="flex flex-col items-center justify-center py-4 relative">
      <button onclick="openMenu()" class="absolute left-4 top-4 text-3xl p-2" style="color: var(--version-color);"><i
          class="fa-solid fa-bars"></i></button>
      <i class="fa-solid fa-code-branch text-5xl" style="color: var(--version-color);"></i>
      <h1 class="text-xl font-bold" style="color: var(--version-color);">和農日向 機械管理アプリ</h1>
    </header>

    <div class="flex items-center gap-2 mb-4 font-bold pb-2 text-lg"
      style="color: var(--version-color); border-bottom: 2px solid var(--version-color);">
      <i class="fa-solid fa-code-branch"></i> バージョン情報
    </div>

    <div class="card text-sm leading-relaxed space-y-3">
      <p><span class="font-bold">バージョン:</span> 1.0.0</p>
      <p><span class="font-bold">最終更新日:</span> 2026-01-19</p>

      <div>
        <p class="font-bold mb-1" style="color: var(--version-color);">更新内容</p>
        <ul class="list-disc pl-5 space-y-1">
          <li>初期リリース</li>
        </ul>
      </div>

      <div>
        <p class="font-bold mb-1" style="color: var(--version-color);">使用技術</p>
        <ul class="list-disc pl-5 space-y-1">
          <li>HTML / CSS / JavaScript</li>
          <li>Tailwind CSS</li>
          <li>Supabase</li>
          <li>Chart.js</li>
          <li>GitHub Pages</li>
        </ul>
      </div>
    </div>

    <button onclick="switchView('portalView')" class="btn-sub mt-6">
      <i class="fa-solid fa-house mr-2"></i>portalに戻る
    </button>

  </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const SUPABASE_URL = window.APP_CONFIG.SUPABASE_URL;
    const SUPABASE_KEY = window.APP_CONFIG.SUPABASE_KEY;
    // Vision APIはそのまま（もしこれもテスト用があれば後でconfig.jsに）
    const GOOGLE_VISION_API_KEY = 'AIzaSyCdX_rYEeovClhxRAwAOhPxG4CPTX6fqlg';
    // window. をつけることで、アプリのどこからでもアクセスできるようにします
    window.client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let allMachines = []; let currentMachineId = 'all'; window.charts = {};

    // ==========================================
    // オフライン対応：LocalStorage同期機能
    // ==========================================

    // LocalStorageに未送信データを保存
    function saveToLocalStorage(type, data) {
      try {
        console.log("--- 履歴取得開始 ---"); // これを追加
        const key = `unsyncedData_${type}`;
        const existing = JSON.parse(localStorage.getItem(key) || '[]');
        existing.push({
          ...data,
          _localId: Date.now() + Math.random(),
          _timestamp: new Date().toISOString()
        });
        localStorage.setItem(key, JSON.stringify(existing));
        updateSyncBadge();
        console.log(`📦 LocalStorageに保存: ${type}`, data);
        return true;
      } catch (e) {
        console.error('LocalStorage保存エラー:', e);
        return false;
      }
    }

    // 未同期データ件数を表示
    function updateSyncBadge() {
      const types = ['hour_logs', 'repair_logs', 'maintenance_records', 'taue_logs', 'combine_logs', 'other_logs'];
      let total = 0;
      types.forEach(type => {
        const data = JSON.parse(localStorage.getItem(`unsyncedData_${type}`) || '[]');
        total += data.length;
      });

      const badge = document.getElementById('syncBadge');
      if (badge) {
        if (total > 0) {
          badge.textContent = total;
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }
      }
    }

    // LocalStorageからSupabaseに同期
    async function syncLocalStorageToSupabase() {
      const types = [
        { key: 'hour_logs', table: 'hour_logs' },
        { key: 'repair_logs', table: 'repair_logs' },
        { key: 'maintenance_records', table: 'maintenance_records' },
        { key: 'taue_logs', table: 'taue_logs' },
        { key: 'combine_logs', table: 'combine_logs' },
        { key: 'other_logs', table: 'other_logs' }
      ];

      let successCount = 0;
      let failCount = 0;

      for (const type of types) {
        const key = `unsyncedData_${type.key}`;
        const data = JSON.parse(localStorage.getItem(key) || '[]');

        if (data.length === 0) continue;

        const remaining = [];

        for (const item of data) {
          try {
            // _localIdと_timestampを除いてSupabaseに送信
            const { _localId, _timestamp, ...cleanData } = item;
            const { error } = await client.from(type.table).insert(cleanData);

            if (error) throw error;
            successCount++;
            console.log(`✅ 同期成功: ${type.key}`, cleanData);
          } catch (e) {
            console.error(`❌ 同期失敗: ${type.key}`, e);
            remaining.push(item);
            failCount++;
          }
        }

        // 同期できなかったデータのみ残す
        localStorage.setItem(key, JSON.stringify(remaining));
      }

      updateSyncBadge();

      if (successCount > 0) {
        console.log(`🔄 同期完了: 成功 ${successCount}件, 失敗 ${failCount}件`);
        if (failCount === 0) {
          showModal('同期完了', `${successCount}件のデータをクラウドに保存しました`);
        }
      }

      return { successCount, failCount };
    }

    // ネットワーク状態をチェック
    function isOnline() {
      return navigator.onLine;
    }

    // データ保存のラッパー関数（オンライン時は直接保存、オフライン時はLocalStorage）
    async function saveData(table, data, type) {
      if (isOnline()) {
        try {
          const { error } = await client.from(table).insert(data);
          if (error) throw error;

          // 成功したら念のためLocalStorageもチェックして同期
          setTimeout(() => syncLocalStorageToSupabase(), 100);
          return { success: true };
        } catch (e) {
          console.error('保存エラー、LocalStorageに保存:', e);
          saveToLocalStorage(type, data);
          return { success: true, offline: true };
        }
      } else {
        saveToLocalStorage(type, data);
        showModal('オフラインモード', 'ネットワークに接続されていません。\nデータはローカルに保存され、接続時に自動同期されます。');
        return { success: true, offline: true };
      }
    }

    // メンテナンス全項目完了チェック&保存
    async function checkAndSaveMaintenanceCompletion(machineId, machineType) {
      try {
        // メンテナンス項目テーブル名を決定
        const itemsTableMap = {
          'tractor': 'maintenance_items_tractor',
          'transplanter': 'maintenance_items_transplanter',
          'combine': 'maintenance_items_combine',
          'brush_cutter': 'maintenance_items_brush_cutter',
          'power_duster': 'maintenance_items_power_duster',
          'spider_mower': 'maintenance_items_spider_mower',
          'wing_mower': 'maintenance_items_wing_mower',
          'bale_wrapper': 'maintenance_items_bale_wrapper',
          'implements': 'maintenance_items_implements',
          'other_machinery': 'maintenance_items_other_machinery'
        };

        const itemsTable = itemsTableMap[machineType];
        if (!itemsTable) return;

        // 全メンテナンス項目を取得
        const { data: items } = await client.from(itemsTable).select('id');
        if (!items || items.length === 0) return;

        // 現在のチェック状況を取得
        const { data: checks } = await client
          .from('maintenance_status')
          .select('item_id, status')
          .filter('item_id', 'ilike', `${machineId}_%`);

        if (!checks) return;

        // 完了した項目をカウント
        const uniqueChecks = {};
        checks.forEach(c => { uniqueChecks[c.item_id] = c.status; });
        const completedCount = Object.values(uniqueChecks).filter(status => status === true || status === "true").length;

        // 全項目完了の場合、maintenance_completion_logsに保存
        if (completedCount === items.length) {
          // 機械情報を取得
          const { data: machine } = await client
            .from('machines')
            .select('name, machine_type')
            .eq('id', machineId)
            .single();

          if (machine) {
            await client.from('maintenance_completion_logs').insert({
              machine_id: parseInt(machineId),
              machine_name: machine.name,
              completion_date: new Date().toISOString().split('T')[0],
              status: 'completed',
              created_at: new Date().toISOString(),
              total_items: items.length
            });
            console.log(`✅ メンテナンス完了ログ保存: 機械ID ${machineId}, 名前: ${machine.name}`);
          }
        }
      } catch (e) {
        console.error('メンテナンス完了チェックエラー:', e);
      }
    }

    window.drawCharts = function (data) {
      console.log("📊 全カラムのグラフを最適化します");
      if (typeof Chart === 'undefined') return;

      if (window.charts) {
        Object.values(window.charts).forEach(c => c && typeof c.destroy === 'function' && c.destroy());
      }
      window.charts = {};

      // データ集計
      const stats = { cat: {}, op: {}, task: {}, time: new Array(12).fill(0) };
      let totalH = 0;
      data.forEach(d => {
        const h = Math.max(0, (parseFloat(d.end_hour) || 0) - (parseFloat(d.start_hour) || 0));
        totalH += h;
        stats.cat[d.category || "その他"] = (stats.cat[d.category || "その他"] || 0) + h;
        stats.op[d.operator || "不明"] = (stats.op[d.operator || "不明"] || 0) + h;
        stats.task[d.task || "その他"] = (stats.task[d.task || "その他"] || 0) + h;
        if (d.date) {
          const m = new Date(d.date).getMonth();
          stats.time[m] += h;
        }
      });

      const colors = ['#6b8f71', '#9eb3a2', '#d1dbd3', '#3a4d3f', '#b5c9b8'];

      // --- 【左】上段：機械別修理コスト (金額順にソート & グラデーション) ---
      const ctxRepair = document.getElementById('categoryShareChart');
      if (ctxRepair) {
        // 1. データをオブジェクトの配列にする
        const rawData = [
          { label: 'SL54', value: 80000 },
          { label: 'YT333', value: 30000 },
          { label: 'TJV95', value: 7000 },
          { label: 'SL60', value: 20000 },
          { label: 'MZ70', value: 4000 }
        ];

        // 2. 金額が高い順に並べ替える (降順)
        rawData.sort((a, b) => b.value - a.value);

        // 3. グラフ用にラベルと数値を切り分ける
        const sortedLabels = rawData.map(d => d.label);
        const sortedValues = rawData.map(d => d.value);

        // 4. グラデーション色の計算
        const maxVal = sortedValues[0];
        const backgroundColors = sortedValues.map(val => {
          const opacity = 0.3 + (val / maxVal) * 0.7;
          return `rgba(139, 0, 0, ${opacity})`;
        });

        window.charts.c1 = new Chart(ctxRepair, {
          type: 'bar',
          data: {
            labels: sortedLabels,
            datasets: [{
              label: 'コスト',
              data: sortedValues,
              backgroundColor: backgroundColors,
              borderRadius: 4,
              barThickness: 15
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { display: false },
              y: {
                grid: { display: false },
                ticks: { font: { size: 11, weight: 'bold' } }
              }
            },
            plugins: { legend: { display: false } }
          }
        });
      }

      // --- 【左】下段：作物比率 (ドーナツ) ---
      const ctxCrop = document.getElementById('taskShareChart');
      if (ctxCrop) {
        window.charts.c2 = new Chart(ctxCrop, {
          type: 'doughnut',
          data: { labels: Object.keys(stats.cat), datasets: [{ data: Object.values(stats.cat), backgroundColor: colors }] },
          options: {
            cutout: '45%', // 🔥 70%→45%に下げることで「肉厚」なドーナツになります
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } }
          }
        });
      }

      // --- 【中央】上段：月別稼働推移 (以前の折れ線グラフ) ---
      const ctxLine = document.getElementById('detailChart');
      if (ctxLine) {
        window.charts.line = new Chart(ctxLine, {
          type: 'line',
          data: {
            labels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'],
            datasets: [{ label: 'h', data: stats.time, borderColor: '#6b8f71', backgroundColor: 'rgba(107,143,113,0.1)', fill: true, tension: 0.4 }]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
      }

      // --- 【中央】下段：作業内容分析 (グラデーション棒グラフ) ---
      const ctxBar = document.getElementById('gradientBarChart');
      if (ctxBar) {
        const sorted = Object.entries(stats.task).sort((a, b) => b[1] - a[1]);
        window.charts.bar = new Chart(ctxBar, {
          type: 'bar',
          data: {
            labels: sorted.map(t => t[0]),
            datasets: [{
              label: 'h',
              data: sorted.map(t => t[1]),
              backgroundColor: sorted.map((_, i) => `rgba(107, 143, 113, ${Math.max(0.2, 1 - (i / 5))})`),
              borderRadius: 4
            }]
          },
          options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
      }

      // --- 【右】上段：前年実績比 (半円ゲージ) ---
      const ctxGauge = document.getElementById('yearComparisonGauge');
      if (ctxGauge) {
        const ratio = Math.min(100, (totalH / 500) * 100);
        window.charts.gauge = new Chart(ctxGauge, {
          type: 'doughnut',
          data: { datasets: [{ data: [ratio, 100 - ratio], backgroundColor: ['#6b8f71', '#eee'], borderWidth: 0 }] },
          options: { rotation: -90, circumference: 180, cutout: '75%', maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
        const valEl = document.getElementById("detailCompareValue");
        if (valEl) valEl.innerText = ratio.toFixed(1) + "%";
      }

      // --- 【右】下段：担当者比率 (ドーナツ) ---
      const ctxOp = document.getElementById('operatorShareChart');
      if (ctxOp) {
        window.charts.c4 = new Chart(ctxOp, {
          type: 'doughnut',
          data: { labels: Object.keys(stats.op), datasets: [{ data: Object.values(stats.op), backgroundColor: colors }] },
          options: { cutout: '45%', responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } } }
        });
      }
    };

    function openMenu() {
      // 現在アクティブなビューに応じて適切なメニューを開く
      const tractorSection = document.querySelector('#tractor-section .view.active');
      const plantingSection = document.querySelector('#planting-section .view.active');
      const combineSection = document.querySelector('#combine-section .view.active');

      let menuId = 'sideMenu'; // デフォルトはグローバルメニュー

      if (tractorSection) {
        menuId = 'tractorSideMenu';
      } else if (plantingSection) {
        menuId = 'plantingSideMenu';
      } else if (combineSection) {
        menuId = 'combineSideMenu';
      }

      document.getElementById(menuId).style.left = "0px";
      document.getElementById("overlay").style.display = "block";
    }

    function closeMenu() {
      // PC表示でサイドバー常時表示モードの場合は閉じない
      const isDesktop = window.innerWidth >= 1024;
      const showSidebar = document.body.classList.contains('show-sidebar');

      if (isDesktop && showSidebar) {
        // PC表示時はオーバーレイだけ閉じる（サイドバーは閉じない）
        document.getElementById("overlay").style.display = "none";
        return;
      }

      // モバイル表示時は通常通りすべて閉じる
      document.getElementById("sideMenu").style.left = "-280px";
      document.getElementById("tractorSideMenu").style.left = "-280px";
      document.getElementById("plantingSideMenu").style.left = "-280px";
      document.getElementById("combineSideMenu").style.left = "-280px";
      document.getElementById("otherMachinerySideMenu").style.left = "-280px";
      document.getElementById("overlay").style.display = "none";
    }

    async function switchView(id) {
      console.log("Switching to:", id);

      // 現在のビューをlocalStorageに保存
      localStorage.setItem('currentView', id);

      // 全てのビューからactiveを取り除く
      document.querySelectorAll('.view').forEach(v => {
        v.classList.remove('active');
        v.style.display = 'none';
      });

      // 対象のビューを取得
      const targetView = document.getElementById(id);
      if (targetView) {
        targetView.classList.add('active');
        targetView.style.display = 'block';

        // サイドバーを表示しないページのリスト
        const noSidebarPages = ['portalView', 'dashboard', 'dashboardPlanting', 'dashboardCombine', 'dashboardOther'];

        // サイドバー表示の制御
        if (noSidebarPages.includes(id)) {
          document.body.classList.remove('show-sidebar');
          document.body.classList.add('fullscreen-mode');
          // 全てのサイドメニューを閉じる
          document.querySelectorAll('.sideMenu, #sideMenu, #tractorSideMenu, #plantingSideMenu, #combineSideMenu, #exportSideMenu, #maintenanceSideMenu, #versionSideMenu, #otherMachinerySideMenu, #repairSideMenu').forEach(menu => {
            menu.style.left = '-280px';
          });
        } else {
          document.body.classList.add('show-sidebar');
          document.body.classList.remove('fullscreen-mode');
        }

        // 適切なサイドメニューにactive-menuクラスを付与（ビューIDベース）
        const tractorViews = ['tractorView', 'todayView', 'historyView'];
        const plantingViews = ['plantingView', 'todayViewPlanting', 'historyViewPlanting', 'maintenanceMachineListViewPlanting', 'maintenanceDetailViewPlanting'];
        const combineViews = ['combineView', 'todayViewCombine', 'historyViewCombine', 'maintenanceMachineListViewCombine', 'maintenanceDetailViewCombine'];
        const exportViews = ['exportView'];
        const maintenanceViews = ['maintenanceListView', 'maintenanceMachineListView', 'maintenanceDetailView', 'maintenanceMachineListViewBrushCutter', 'maintenanceDetailViewBrushCutter', 'maintenanceMachineListViewMower', 'maintenanceDetailViewSpiderMower', 'maintenanceDetailViewWingMower', 'maintenanceMachineListViewImplement', 'maintenanceDetailViewImplement', 'maintenanceMachineListViewSpreader', 'maintenanceDetailViewSpreader', 'maintenanceMachineListViewSprayer', 'maintenanceMachineListViewWrapper', 'maintenanceDetailViewWrapper', 'maintenanceMachineListViewOtherMachinery', 'maintenanceDetailViewOtherMachinery'];
        const versionViews = ['versionView'];
        const repairViews = ['repairView', 'invoiceOCRView'];
        const otherMachineryViews = ['otherMachineryView', 'todayViewOther', 'historyViewOther'];
        const dashboardViews = ['dashboard', 'dashboardPlanting', 'dashboardCombine', 'dashboardOther'];

        // body背景色を変更
        if (tractorViews.includes(id) || dashboardViews.includes(id)) {
          document.body.style.backgroundColor = '#e2e8e3';
        } else if (plantingViews.includes(id)) {
          document.body.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--planting-bg');
        } else if (combineViews.includes(id)) {
          document.body.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--combine-bg');
        } else if (maintenanceViews.includes(id)) {
          document.body.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--maintenance-bg');
        } else if (repairViews.includes(id)) {
          document.body.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--repair-bg');
        } else if (exportViews.includes(id)) {
          document.body.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--export-bg');
        } else if (versionViews.includes(id)) {
          document.body.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--version-bg');
        } else if (otherMachineryViews.includes(id)) {
          document.body.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--other-bg');
        } else if (id === 'portalView') {
          document.body.style.backgroundColor = '#faf9f6';
        }

        // 全てのメニューからactive-menuクラスを削除
        document.getElementById("sideMenu").classList.remove('active-menu');
        document.getElementById("tractorSideMenu").classList.remove('active-menu');
        document.getElementById("plantingSideMenu").classList.remove('active-menu');
        document.getElementById("combineSideMenu").classList.remove('active-menu');
        document.getElementById("exportSideMenu").classList.remove('active-menu');
        document.getElementById("maintenanceSideMenu").classList.remove('active-menu');
        document.getElementById("versionSideMenu").classList.remove('active-menu');
        document.getElementById("otherMachinerySideMenu").classList.remove('active-menu');
        document.getElementById("repairSideMenu").classList.remove('active-menu');

        // 適切なメニューにactive-menuクラスを追加
        let activeMenuId = 'sideMenu';
        if (tractorViews.includes(id)) {
          activeMenuId = 'tractorSideMenu';
          document.getElementById("tractorSideMenu").classList.add('active-menu');
        } else if (plantingViews.includes(id)) {
          activeMenuId = 'plantingSideMenu';
          document.getElementById("plantingSideMenu").classList.add('active-menu');
        } else if (combineViews.includes(id)) {
          activeMenuId = 'combineSideMenu';
          document.getElementById("combineSideMenu").classList.add('active-menu');
        } else if (exportViews.includes(id)) {
          activeMenuId = 'exportSideMenu';
          document.getElementById("exportSideMenu").classList.add('active-menu');
        } else if (maintenanceViews.includes(id)) {
          activeMenuId = 'maintenanceSideMenu';
          document.getElementById("maintenanceSideMenu").classList.add('active-menu');
        } else if (versionViews.includes(id)) {
          activeMenuId = 'versionSideMenu';
          document.getElementById("versionSideMenu").classList.add('active-menu');
        } else if (otherMachineryViews.includes(id)) {
          activeMenuId = 'otherMachinerySideMenu';
          document.getElementById("otherMachinerySideMenu").classList.add('active-menu');
        } else if (repairViews.includes(id)) {
          activeMenuId = 'repairSideMenu';
          document.getElementById("repairSideMenu").classList.add('active-menu');
        } else {
          document.getElementById("sideMenu").classList.add('active-menu');
        }

        // PC表示でサイドバー表示モードの場合、アクティブメニューを明示的に開く
        const isDesktop = window.innerWidth >= 1024;
        if (isDesktop && !noSidebarPages.includes(id)) {
          document.getElementById(activeMenuId).style.left = "0px";
        }

        // バージョン情報ページを開いたら通知バッジを消す
        if (id === 'versionView') {
          const currentVersion = targetView.dataset.version || '1.0.0';
          localStorage.setItem('lastViewedVersion', currentVersion);
          checkVersionUpdate();
        }

        // portalページ表示時に通知バッジをチェック
        if (id === 'portalView') {
          checkVersionUpdate();
        }
      } else {
        console.error("エラー: ID '" + id + "' のビューが見つかりません。");
      }

      // ヘッダーの制御（portalView, dashboard, dashboardPlanting, versionView では非表示）
      const header = document.getElementById("pageHeader");
      if (header) {
        header.style.display = (id === 'dashboard' || id === 'dashboardPlanting' || id === 'portalView' || id === 'versionView') ? 'none' : 'flex';
      }

      closeMenu();

      // 各ページごとの読み込み処理
      if (id === 'dashboard') {
        setTimeout(() => renderDashboard('all'), 100);
      }
      if (id === 'dashboardPlanting') {
        setTimeout(() => renderDashboardPlanting('all'), 100);
      }
      if (id === 'dashboardCombine') {
        setTimeout(() => renderDashboardCombine('all'), 100);
      }
      if (id === 'dashboardOther') {
        renderDashboardOther('all');
      }
      if (id === 'todayView') {
        console.log("本日ログ読込実行");
        loadLogs("todayLogList", true);
      }
      if (id === 'historyView') {
        console.log("履歴ログ読込実行");
        loadLogs("historyLogList", false);
      }
      if (id === 'todayViewPlanting') {
        console.log("田植え機 本日ログ読込実行");
        loadLogsPlanting("todayLogListPlanting", true);
      }
      if (id === 'historyViewPlanting') {
        console.log("田植え機 履歴ログ読込実行");
        loadLogsPlanting("historyLogListPlanting", false);
      }
      if (id === 'todayViewCombine') {
        console.log("コンバイン 本日ログ読込実行");
        loadLogsCombine("todayLogListCombine", true);
      }
      if (id === 'historyViewCombine') {
        console.log("コンバイン 履歴ログ読込実行");
        loadLogsCombine("historyLogListCombine", false);
      }
      if (id === 'repairView') {
        loadRepairDashboard();
      }
      if (id === 'repairViewPlanting') {
        loadRepairDashboardPlanting();
      }
      if (id === 'maintenanceMachineListView') {
        loadMachineList();
      }
      if (id === 'maintenanceView') {
        console.log("メンテナンス状態を復元中...");
        restoreMaintenanceChecks();
      }
      if (id === 'maintenanceMachineListViewPlanting') {
        loadMachineListPlanting();
      }
      if (id === 'maintenanceMachineListViewCombine') {
        if (typeof loadMachineListCombine === 'function') {
          loadMachineListCombine();
        }
      }
      if (id === 'maintenanceDetailViewPlanting') {
        console.log("田植え機メンテナンス状態を復元中...");
        restoreMaintenanceChecksPlanting();
      }
      if (id === 'exportView') {
        initExportPage();
      }
      if (id === 'otherMachineryView') {
        await loadOtherMachinerySelects();
      }
      if (id === 'todayViewOther') {
        await loadOtherMachinerySelects();
        loadTodayLogsOther();
      }
      if (id === 'historyViewOther') {
        await loadOtherMachinerySelects();
        setDefaultDateOther();
        loadHistoryOther();
      }
    }

    // バージョン更新チェック
    function checkVersionUpdate() {
      const versionView = document.getElementById('versionView');
      const currentVersion = versionView ? versionView.dataset.version || '1.0.0' : '1.0.0';
      const lastViewedVersion = localStorage.getItem('lastViewedVersion') || '0.0.0';
      const badge = document.getElementById('versionBadge');

      if (badge) {
        if (currentVersion !== lastViewedVersion) {
          badge.classList.add('show');
        } else {
          badge.classList.remove('show');
        }
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      // リロード後、保存されたビューを復元
      const savedView = localStorage.getItem('currentView');
      if (savedView) {
        // 一度だけ使用したら削除（次回のページ読み込みはportalViewから）
        localStorage.removeItem('currentView');
        setTimeout(() => switchView(savedView), 100);
      }

      // 1. 機械（トラクターのみ）の取得
      const { data: machines } = await client
        .from("machines")
        .select("*")
        .eq("machine_type", "tractor")
        .order("name");

      allMachines = machines || [];

      // 2. オペレーターの取得
      const { data: operators } = await client
        .from("operators")
        .select("*")
        .order("id");

      // 3. 作業内容の取得
      const { data: workTypes } = await client
        .from("work_types")
        .select("*")
        .order("id");

      // --- 各画面要素への反映 ---

      // 入力フォームの機械選択
      const machineSelect = document.getElementById("machineSelect");
      if (machineSelect) {
        machineSelect.innerHTML = '<option value="">選択</option>' +
          allMachines.map(m => `<option value="${m.id}">${m.name}</option>`).join("");
      }

      // 検索条件の機械選択
      const filterMachine = document.getElementById("filterMachine");
      if (filterMachine) {
        filterMachine.innerHTML = '<option value="">すべての機械</option>' +
          allMachines.map(m => `<option value="${m.id}">${m.name}</option>`).join("");
      }

      // 4. オペレーター選択の反映
      const operatorSelect = document.getElementById("operatorSelect");
      if (operatorSelect) {
        operatorSelect.innerHTML = '<option value="">選択</option>' +
          (operators || []).map(o => `<option value="${o.name}">${o.name}</option>`).join("");
      }

      // 5. 作業種別選択の反映
      const workTypeSelect = document.getElementById("workTypeSelect");
      if (workTypeSelect) {
        workTypeSelect.innerHTML = '<option value="">選択</option>' +
          (workTypes || []).map(w => `<option value="${w.name}">${w.name}</option>`).join("");
      }

      // 最後に、ダッシュボードを表示する（ダッシュボード画面にいる場合のみ）
      if (typeof renderDashboard === 'function') {
        renderDashboard('all');
      }

      // ダッシュボードの機械別タブ
      const machineTabs = document.getElementById("machineTabs");
      if (machineTabs) {
        // 今選ばれているIDを確実に取得（関数の引数 machineId を使用）
        const currentId = 'all';

        // 1. 「全体」ボタン
        const allBtnClass = (currentId === 'all') ? 'active' : 'inactive';
        let tabsHTML = `
          <button onclick="renderDashboard('all')" 
                  id="tab-all" 
                  class="tab-btn ${allBtnClass}" 
                  style="min-width: 80px; letter-spacing: 0.2em;">全 体</button>
        `;

        // 2. 各機械のボタン（allMachines.map）
        if (typeof allMachines !== 'undefined' && allMachines.length > 0) {
          tabsHTML += allMachines.map(m => {
            // IDを比較して active か inactive か決める
            const isActive = (String(m.id) === String(currentId)) ? 'active' : 'inactive';
            return `
              <button onclick="renderDashboard(${m.id})" 
                      id="tab-${m.id}" 
                      class="tab-btn ${isActive}">${m.name}</button>
            `;
          }).join("");
        }

        machineTabs.innerHTML = tabsHTML;
      }

      // オペレーター選択の反映（検索と入力両方）
      if (operators) {
        const opList = operators.map(o => `<option value="${o.name}">${o.name}</option>`).join("");
        const fOp = document.getElementById("filterOperator");
        if (fOp) fOp.innerHTML = '<option value="">全オペレーター</option>' + opList;

        const iOp = document.getElementById("operator");
        if (iOp) iOp.innerHTML = '<option value="">選択してください</option>' + opList;
      }

      // 作業内容の反映（連動ロジック含む）
      if (workTypes) {
        // 検索条件側
        const fCat = document.getElementById("filterCategory");
        if (fCat) {
          fCat.innerHTML = '<option value="">全作業内容</option>' +
            workTypes.map(w => `<option value="${w.work_name || w.category}">${w.work_name || w.category}</option>`).join("");
        }

        // 入力フォーム側（種別）
        // 入力フォーム側（種別）
        const iCat = document.getElementById("category");
        if (iCat) {
          // 💡 表示したいカテゴリを限定
          const targetCategories = ["稲", "そば", "保全会", "小規模工事"];

          const categories = [...new Set(
            workTypes
              .filter(w => w.category && targetCategories.includes(w.category))
              .map(w => w.category)
          )];

          iCat.innerHTML = '<option value="">種別を選択</option>' +
            categories.map(c => `<option value="${c}">${c}</option>`).join("");

          // 種別を選んだら作業内容を出す連動設定
          iCat.onchange = () => {
            const selected = iCat.value;
            const iWork = document.getElementById("work_name");
            if (iWork) {
              const filtered = workTypes.filter(t => t.category === selected);
              iWork.innerHTML = '<option value="">作業内容を選択</option>' +
                filtered.map(t => `<option value="${t.work_name}">${t.work_name}</option>`).join("");
            }
          };
        }
      }

      // 日付の初期
      const today = new Date().toISOString().split('T')[0];
      if (document.getElementById("workDate")) {
        document.getElementById("workDate").value = today;
      }
      if (document.getElementById("taue_workDate")) {
        document.getElementById("taue_workDate").value = today;
      }
      if (document.getElementById("combine_workDate")) {
        document.getElementById("combine_workDate").value = today;
      }
      if (document.getElementById("workDateOther")) {
        document.getElementById("workDateOther").value = today;
      }
      if (document.getElementById("filterMonth")) {
        document.getElementById("filterMonth").value = today.substring(0, 7);
      }

      // その他の機械の機械選択を設定
      const { data: otherMachines } = await client
        .from("machines")
        .select("*")
        .eq("machine_type", "other_machinery")
        .order("name");

      const machineSelectOther = document.getElementById("machineSelectOther");
      if (machineSelectOther && otherMachines) {
        machineSelectOther.innerHTML = '<option value="">選択</option>' +
          otherMachines.map(m => `<option value="${m.id}">${m.name}</option>`).join("");
      }

      // 油種の取得と設定（トラクター用）
      const { data: fuelTypes } = await client.from("fuel_types").select("*");
      const fuelTypeSelect = document.getElementById("fuelType");
      if (fuelTypeSelect && fuelTypes) {
        fuelTypeSelect.innerHTML = '<option value="">選択</option>' +
          fuelTypes.map(f => `<option value="${f.id}">${f.name}</option>`).join("");
      }

      // 安全のため、機械選択に change リスナを確実に追加
      const msEl = document.getElementById('machineSelect');
      if (msEl && !msEl.onchange) msEl.addEventListener('change', autoFillHour);

      // 田植え機用の初期化
      await initTauePage();

      // コンバイン用の初期化
      await initCombinePage();

      // 初期画面をポータルビューに設定
      switchView('portalView');

      // ページを表示
      document.body.style.visibility = 'visible';

      // バージョン更新チェック
      if (typeof checkVersionUpdate === 'function') {
        checkVersionUpdate();
      }

      console.log("全データの初期化と日付セットが完了しました");
    });

    // 修理履歴ダッシュボードを読み込む
    async function loadRepairDashboard() {
      try {
        // repair_logs をすべて取得
        const { data: logs, error } = await client
          .from('repair_logs')
          .select('*')
          .order('date', { ascending: false });

        if (error) {
          console.error('Error loading repair logs:', error);
          return;
        }

        // -----------------------------
        // ① 累計修理費
        // -----------------------------
        const totalCost = logs.reduce((sum, log) => sum + (log.cost || 0), 0);
        document.getElementById('totalRepairCost').textContent =
          '¥ ' + totalCost.toLocaleString();

        // -----------------------------
        // ② 年ごとの修理費
        // -----------------------------
        const yearly = {};
        logs.forEach(log => {
          const year = new Date(log.date).getFullYear();
          if (!yearly[year]) yearly[year] = 0;
          yearly[year] += log.cost || 0;
        });

        const yearlyContainer = document.getElementById('yearlyRepairContainer');
        yearlyContainer.innerHTML = '';

        Object.keys(yearly)
          .sort((a, b) => b - a)
          .forEach(year => {
            const card = document.createElement('div');
            card.className =
              'p-3 bg-white rounded-md shadow text-center border border-gray-100';
            card.innerHTML = `
          <div class="text-sm text-gray-500">${year}年</div>
          <div class="text-lg font-bold text-[#6b8f71]">¥ ${yearly[year].toLocaleString()}</div>
        `;
            yearlyContainer.appendChild(card);
          });

        // -----------------------------
        // ③ 機械ごとの修理費
        // -----------------------------
        let machineTotals = {};
        // ここでは全体用の集計を行う場合のみ利用（その他の機械用は下で再利用）
        logs.forEach(log => {
          if (!machineTotals[log.machine_id]) machineTotals[log.machine_id] = 0;
          machineTotals[log.machine_id] += log.cost || 0;
        });

        // machinesテーブルからmachine_typeが'other_machinery'のIDのみ取得
        const { data: machines } = await client.from('machines').select('*').eq('machine_type', 'other_machinery');
        console.log("other machinery machines:", machines);
        const otherIds = machines ? machines.map(m => m.id) : [];
        console.log("otherMachineIds:", otherIds);

        // machine_idがotherIdsに含まれるrepair_logsのみ集計
        console.log("全repair_logs件数:", logs.length);
        console.log("repair_logsサンプル:", logs[0]);
        const filteredLogs = logs.filter(log => otherIds.includes(log.machine_id));
        console.log("other machinery用repair_logs件数:", filteredLogs.length);
        console.log("filteredLogsサンプル:", filteredLogs[0]);

        const machineContainer = document.getElementById('machineRepairContainer');
        machineContainer.innerHTML = '';

        // 機械ごとの修理費集計
        machineTotals = {};
        filteredLogs.forEach(log => {
          if (!machineTotals[log.machine_id]) machineTotals[log.machine_id] = 0;
          machineTotals[log.machine_id] += log.cost || 0;
        });

        Object.keys(machineTotals).forEach(machineId => {
          const machine = machines.find(m => m.id === Number(machineId));
          const name = machine ? machine.name : '不明な機械';

          const card = document.createElement('div');
          card.className =
            'p-3 bg-white rounded-md shadow text-center border border-gray-100';
          card.innerHTML = `
        <div class="text-sm text-gray-500">${name}</div>
        <div class="text-lg font-bold text-[#6b8f71]">¥ ${machineTotals[machineId].toLocaleString()}</div>
      `;
          machineContainer.appendChild(card);
        });

        // -----------------------------
        // ④ 最近の修理履歴（最新5件）
        // -----------------------------
        const recentContainer = document.getElementById('recentRepairContainer');
        recentContainer.innerHTML = '';

        logs.slice(0, 5).forEach(log => {
          const item = document.createElement('div');
          item.className =
            'p-3 bg-white rounded-md shadow border border-gray-100';

          item.innerHTML = `
        <div class="text-sm text-gray-500">${log.date}</div>
        <div class="font-bold">${log.memo || '(内容なし)'}</div>
        <div class="text-[#6b8f71] font-bold mt-1">¥ ${log.cost.toLocaleString()}</div>
        <div class="text-xs text-gray-400 mt-1">${log.shop || ''}</div>
      `;

          recentContainer.appendChild(item);
        });

      } catch (err) {
        console.error('Unexpected error:', err);
      }
    }

    async function autoFillHour() {
      const mId = document.getElementById("machineSelect").value;
      if (!mId) return;
      const { data } = await client.from("hour_logs").select("end_hour").eq("machine_id", mId).order("date", { ascending: false }).order("created_at", { ascending: false }).limit(1);
      if (data && data.length > 0) { document.getElementById("hourBefore").value = data[0].end_hour; calcDiff(); }
    }

    function calcDiff() {
      const b = parseFloat(document.getElementById("hourBefore").value) || 0;
      const a = parseFloat(document.getElementById("hourAfter").value) || 0;
      const d = a - b;
      const disp = document.getElementById("hourDiffDisplay");

      // ① 稼働後のほうが小さい場合に文字を赤くするロジック
      if (a > 0 && a < b) {
        disp.classList.remove("text-[#6b8f71]");
        disp.classList.add("text-red-500");
        disp.textContent = `稼働時間: 0.0 h (入力エラー)`;
      } else {
        disp.classList.remove("text-red-500");
        disp.classList.add("text-[#6b8f71]");
        disp.textContent = `稼働時間: ${d > 0 ? d.toFixed(1) : "0.0"} h`;
      }
    }

    async function previewInvoice(input) {
      const file = input.files[0];
      if (!file) return;

      const previewImg = document.getElementById('invoicePreviewImg');
      const previewArea = document.getElementById('invoicePreviewArea');
      const saveBtn = document.getElementById('saveRepairBtn');

      // プレビュー表示
      previewImg.src = URL.createObjectURL(file);
      previewArea.classList.remove('hidden');

      const memoField = document.getElementById('repairMemo');
      memoField.value = "📄 Google AIが解析中... ⏳";
      if (saveBtn) saveBtn.disabled = true; // 解析中は二重押し防止で無効化

      try {
        const base64Image = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.readAsDataURL(file);
        });

        const url = `https://vision.googleapis.com/v1/images:annotate?key=${GOOGLE_VISION_API_KEY}`;
        const response = await fetch(url, {
          method: "POST",
          body: JSON.stringify({
            requests: [{ image: { content: base64Image }, features: [{ type: "TEXT_DETECTION" }] }]
          })
        });
        const result = await response.json();

        const fullText = result.responses[0]?.textAnnotations[0]?.description || "";

        // --- 抽出処理 ---
        const cleanText = fullText.replace(/\s/g, '');
        const costMatch = cleanText.match(/(?:金額|合計|税込|￥|¥|請求額)[:：]?([0-9,]{3,})/);
        if (costMatch) document.getElementById('repairCost').value = costMatch[1].replace(/,/g, '');

        const dateMatch = cleanText.match(/(\d{4})[年\/-](\d{1,2})[月\/-](\d{1,2})/);
        if (dateMatch) {
          document.getElementById('repairDate').value = `${dateMatch[1]}-${dateMatch[2].padStart(2, '0')}-${dateMatch[3].padStart(2, '0')}`;
        }

        // ✨ 解析が終わったらプレビューを消す
        previewArea.classList.add('hidden');
        previewImg.src = "";
        memoField.value = "解析完了: " + fullText.substring(0, 50) + "..."; // 冒頭だけメモに残す

        showModal("解析完了", "内容を確認して保存してください。");

      } catch (error) {
        console.error("OCR Error:", error);
        memoField.value = "❌ 解析エラー";
      } finally {
        if (saveBtn) saveBtn.disabled = false; // エラーでも成功でもボタンを復活させる
      }
    }

    async function populateMachineSelect() {
      const { data: machines } = await client
        .from('machines')
        .select('*')
        .order('name');

      // 全機械を保存（フィルタリング用）
      window.allMachinesForRepair = machines || [];

      // 種別セレクトボックスを設定
      const typeSelect = document.getElementById('repairMachineType');
      if (typeSelect && machines) {
        const uniqueTypes = [...new Set(machines.map(m => m.machine_type))].filter(Boolean);
        typeSelect.innerHTML = '<option value="">選択してください</option>';
        uniqueTypes.forEach(type => {
          const opt = document.createElement('option');
          opt.value = type;
          opt.textContent = type === 'tractor' ? 'トラクター' : type === 'transplanter' ? '田植え機' : type;
          typeSelect.appendChild(opt);
        });
      }

      // 機械セレクトボックスは初期状態では空
      const select = document.getElementById('repairMachineSelect');
      if (select) {
        select.innerHTML = '<option value="">まず種別を選択してください</option>';
      }
    }

    function filterMachinesByType() {
      const typeSelect = document.getElementById('repairMachineType');
      const machineSelect = document.getElementById('repairMachineSelect');
      const selectedType = typeSelect.value;

      if (!machineSelect || !window.allMachinesForRepair) return;

      machineSelect.innerHTML = '<option value="">選択してください</option>';

      if (!selectedType) {
        machineSelect.innerHTML = '<option value="">まず種別を選択してください</option>';
        return;
      }

      const filteredMachines = window.allMachinesForRepair.filter(m => m.machine_type === selectedType);

      if (filteredMachines.length > 0) {
        filteredMachines.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.id;
          opt.textContent = m.name;
          machineSelect.appendChild(opt);
        });
      } else {
        const opt = document.createElement('option');
        opt.textContent = `${selectedType}が登録されていません`;
        machineSelect.appendChild(opt);
      }
    }

    async function saveRepairLog() {
      console.log("保存処理を開始します...");

      // 1. 画面から入力値を取得
      const dateValue = document.getElementById('repairDate').value;
      const shopValue = document.getElementById('repairShop').value;
      const costValue = document.getElementById('repairCost').value;
      const memoValue = document.getElementById('repairMemo').value;
      const machineId = document.getElementById('repairMachineSelect').value;

      // 2. 必須チェック
      if (!dateValue || !costValue) {
        showModal("入力エラー", "「修理日」と「金額」を入力してください。");
        return;
      }

      const btn = document.getElementById('saveRepairBtn');
      btn.disabled = true;
      btn.innerText = "保存中...";

      try {
        const repairData = {
          date: dateValue,
          shop: shopValue,
          cost: parseInt(costValue),
          memo: memoValue,
          machine_id: machineId || null,
          created_at: new Date().toISOString()
        };

        const result = await saveData('repair_logs', repairData, 'repair_logs');

        btn.innerText = "保存完了！";
        loadRepairDashboard();

        const message = result.offline ?
          "修理ログをローカルに保存しました\n（オンライン時に自動同期されます）" :
          "保存完了しました！🚜🌾";

        // 💡 どっちの名前か迷わずに、新しく作った showModal を呼ぶだけ！
        showModal("保存完了", message);
        // 3. 自動的に履歴トップ画面に戻す
        setTimeout(() => {
          switchView('repairView');
          btn.disabled = false;
          btn.innerText = "修理履歴を保存";
        }, 1500);

      } catch (err) {
        console.error("❌ 保存に失敗しました:", err);
        showModal("保存エラー", "エラーで保存できませんでした: " + err.message);
        btn.disabled = false;
        btn.innerText = "修理履歴を保存";
      }
    }

    function prepareMachineSelect() {
      const select = document.getElementById('repairMachineSelect');
      if (!select) return;

      select.innerHTML = '';

      if (allMachines && allMachines.length > 0) {
        allMachines.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.id;
          opt.textContent = m.name;
          select.appendChild(opt);
        });
      } else {
        const opt = document.createElement('option');
        opt.textContent = "機械が登録されていません";
        select.appendChild(opt);
      }
    }

    function goToRepairRegistration() {
      prepareMachineSelect(); // リストを作成
      switchView('invoiceOCRView'); // 画面を切り替え
    }

    // 期間選択の切り替え関数（トラクター）
    function togglePeriodInput() {
      const type = document.getElementById('filterPeriodType').value;
      document.getElementById('filterMonthContainer').style.display = type === 'month' ? 'block' : 'none';
      document.getElementById('filterYearContainer').style.display = type === 'year' ? 'block' : 'none';
    }

    // 期間選択の切り替え関数（田植え機）
    function togglePeriodInputPlanting() {
      const type = document.getElementById('filterPeriodTypePlanting').value;
      document.getElementById('filterMonthContainerPlanting').style.display = type === 'month' ? 'block' : 'none';
      document.getElementById('filterYearContainerPlanting').style.display = type === 'year' ? 'block' : 'none';
    }

    // 期間選択の切り替え関数（コンバイン）
    function togglePeriodInputCombine() {
      const type = document.getElementById('filterPeriodTypeCombine').value;
      document.getElementById('filterMonthContainerCombine').style.display = type === 'month' ? 'block' : 'none';
      document.getElementById('filterYearContainerCombine').style.display = type === 'year' ? 'block' : 'none';
    }

    // 期間選択の切り替え関数（その他の機械）
    function togglePeriodInputOther() {
      const type = document.getElementById('filterPeriodTypeOther').value;
      document.getElementById('filterMonthContainerOther').style.display = type === 'month' ? 'block' : 'none';
      document.getElementById('filterYearContainerOther').style.display = type === 'year' ? 'block' : 'none';
    }

    async function loadLogs(elId, todayOnly) {
      const list = document.getElementById(elId);
      list.innerHTML = "<p class='text-center py-10 opacity-50 text-xs'>読込中...</p>";

      // 基本のクエリ作成
      let query = client.from("hour_logs").select("*, machines(name)").order("date", { ascending: false });

      if (todayOnly) {
        // 【本日の稼働状況】日本時間（JST）の今日の日付で絞り込み
        const jstToday = new Date().toLocaleDateString('sv-SE');
        query = query.eq("date", jstToday);
      } else {

        // 【稼働履歴】画面の入力値を取得してフィルターをかける
        const periodType = document.getElementById("filterPeriodType")?.value || 'month';
        const month = document.getElementById("filterMonth").value; // YYYY-MM
        const year = document.getElementById("filterYear").value; // YYYY
        const machine = document.getElementById("filterMachine").value;
        const operator = document.getElementById("filterOperator").value;
        const category = document.getElementById("filterCategory").value;

        // 期間で絞り込み
        if (periodType === 'month' && month) {
          // 月で絞り込み (月の最終日を動的に計算)
          const [yearNum, monthNum] = month.split('-');
          const lastDay = new Date(yearNum, monthNum, 0).getDate();
          query = query.gte("date", `${month}-01`).lte("date", `${month}-${lastDay}`);
        } else if (periodType === 'year' && year) {
          // 年で絞り込み
          query = query.gte("date", `${year}-01-01`).lte("date", `${year}-12-31`);
        }
        // 機械で絞り込み
        if (machine) query = query.eq("machine_id", machine);
        // オペレーターで絞り込み
        if (operator) query = query.eq("operator", operator);
        // 種別（水稲・そば等）で絞り込み
        if (category) query = query.eq("category", category);
      }

      const { data, error } = await query;
      if (error) {
        console.error("データ取得エラー:", error);
        return;
      }

      let total = 0;
      const displayData = todayOnly ? [...(data || [])].reverse() : (data || []);

      list.innerHTML = displayData.map(l => {
        const diff = (l.end_hour - l.start_hour);
        total += diff;
        return `<div class="card border-l-4 border-[#6b8f71] !mb-3 !py-3 flex justify-between items-center">
              <div>
                <b class="text-sm">${l.date} - ${l.machines?.name}</b>
                <p class="text-xs opacity-70 mt-1">${l.operator} | ${l.task}</p>
                <div class="flex gap-4 mt-2">
                  <span class="text-[11px] font-bold log-badge px-2 py-1 rounded"><i class="fa-solid fa-clock mr-1 text-[#6b8f71]"></i>${diff.toFixed(1)} h</span>
                  <span class="text-[11px] font-bold log-badge px-2 py-1 rounded"><i class="fa-solid fa-gas-pump mr-1 text-[#6b8f71]"></i>${l.fuel_amount || 0} L</span>
                </div>
              </div>
              <button onclick="deleteLog(${l.id})" class="text-gray-400 p-2 hover:text-red-500 transition-colors">
                <i class="fa-regular fa-trash-can text-lg"></i>
              </button>
            </div>`;
      }).join("");

      if (!todayOnly) {
        const totalEl = document.getElementById("historyTotalHours");
        if (totalEl) totalEl.innerText = `合計: ${total.toFixed(1)} h`;
      }
    }

    async function deleteLog(id) {
      showModal("削除確認", "このログを削除しますか？", async () => {
        const { error } = await client.from("hour_logs").delete().eq("id", id);
        if (!error) {
          if (document.getElementById("todayView").classList.contains("active")) loadLogs("todayLogList", true);
          else loadLogs("historyLogList", false);
        }
      });
    }

    // メンテナンス履歴をDBから取得して表示する関数
    async function loadMaintenanceLogs() {
      const logContainer = document.getElementById('maintenanceLog');
      if (!logContainer) return;

      try {
        // トラクターの機械IDを取得
        const { data: tractorMachines, error: machineError } = await client
          .from('machines')
          .select('id, name')
          .eq('machine_type', 'tractor');

        if (machineError) throw machineError;

        const tractorIds = tractorMachines ? tractorMachines.map(m => m.id) : [];
        const tractorMap = {};
        if (tractorMachines) {
          tractorMachines.forEach(m => tractorMap[m.id] = m.name);
        }

        // トラクターIDが空の場合は早期リターン
        if (tractorIds.length === 0) {
          logContainer.innerHTML = `<p class="italic text-gray-400 text-center py-4">直近の整備履歴はありません</p>`;
          return;
        }

        // メンテナンス完了ログを取得
        const { data: completionLogs, error: completionError } = await client
          .from('maintenance_completion_logs')
          .select('machine_id, machine_name, completion_date, status, created_at')
          .in('machine_id', tractorIds)
          .order('created_at', { ascending: false })
          .limit(3);

        // メンテナンス記録を取得
        const { data: logs, error } = await client
          .from('maintenance_records')
          .select('machine_id, item_name, date, created_at')
          .in('machine_id', tractorIds)
          .order('created_at', { ascending: false })
          .limit(5);

        if (error) throw error;

        let html = '';

        // 完了ログを表示（トラクターのみ）
        if (completionLogs && completionLogs.length > 0) {
          html += completionLogs
            .filter(log => tractorIds.includes(log.machine_id))
            .map(log => {
              const machineName = log.machine_name || tractorMap[log.machine_id] || '不明';
              const date = new Date(log.completion_date || log.created_at).toLocaleDateString('ja-JP', {
                month: '2-digit',
                day: '2-digit'
              });

              return `
          <div class="flex flex-col border-b border-gray-50 pb-1 mb-1 last:border-0">
            <div class="flex justify-between items-center">
              <span class="font-bold text-gray-700">${machineName}</span>
              <span class="text-[9px] text-gray-400">${date}</span>
            </div>
            <div class="text-green-600 flex items-center gap-1">
              <i class="fa-solid fa-circle-check" style="color:#6b8f71"></i> <strong style="color:#6b8f71">ALL MAINTENANCE COMPLETE</strong>
            </div>
          </div>
        `;
            }).join('');
        }

        // 個別記録を表示（トラクターのみ）
        if (logs && logs.length > 0) {
          html += logs
            .filter(log => tractorIds.includes(log.machine_id))
            .map(log => {
              const machineName = tractorMap[log.machine_id] || '不明';
              const date = new Date(log.date || log.created_at).toLocaleDateString('ja-JP', {
                month: '2-digit',
                day: '2-digit'
              });

              return `
          <div class="flex flex-col border-b border-gray-50 pb-1 mb-1 last:border-0">
            <div class="flex justify-between items-center">
              <span class="font-bold text-gray-700">${machineName}</span>
              <span class="text-[9px] text-gray-400">${date}</span>
            </div>
            <div class="text-[#6b8f71] flex items-center gap-1">
              <i class="fa-solid fa-check-circle"></i> ${log.item_name} 完了
            </div>
          </div>
        `;
            }).join('');
        }

        if (html) {
          logContainer.innerHTML = html;
        } else {
          logContainer.innerHTML = `<p class="italic text-gray-400 text-center py-4">直近の整備履歴はありません</p>`;
        }
      } catch (err) {
        console.error('履歴取得エラー:', err);
        logContainer.innerHTML = `<p class="text-red-400 text-center py-4">データ取得失敗</p>`;
      }
    }

    loadMaintenanceLogs();

    // コンバインのメンテナンス履歴をDBから取得して表示する関数
    async function loadMaintenanceLogsCombine() {
      const logContainer = document.getElementById('maintenanceLogCombine');
      if (!logContainer) return;

      try {
        // コンバインの機械IDを取得
        const { data: combineMachines, error: machineError } = await client
          .from('machines')
          .select('id, name')
          .eq('machine_type', 'combine');

        if (machineError) throw machineError;

        const combineIds = combineMachines ? combineMachines.map(m => m.id) : [];
        const combineMap = {};
        if (combineMachines) {
          combineMachines.forEach(m => combineMap[m.id] = m.name);
        }

        // メンテナンス完了ログを取得
        const { data: completionLogs, error: completionError } = await client
          .from('maintenance_completion_logs')
          .select('machine_id, machine_name, completion_date, status, created_at')
          .in('machine_id', combineIds)
          .order('created_at', { ascending: false })
          .limit(3);

        // メンテナンス記録を取得
        const { data: logs, error } = await client
          .from('maintenance_records')
          .select('machine_id, item_name, date, created_at')
          .in('machine_id', combineIds)
          .order('created_at', { ascending: false })
          .limit(5);

        if (error) throw error;

        let html = '';

        // 完了ログを表示
        if (completionLogs && completionLogs.length > 0) {
          html += completionLogs.map(log => {
            const machineName = log.machine_name || combineMap[log.machine_id] || '不明';
            const date = new Date(log.completion_date || log.created_at).toLocaleDateString('ja-JP', {
              month: '2-digit',
              day: '2-digit'
            });

            return `
          <div class="flex flex-col border-b border-gray-50 pb-1 mb-1 last:border-0">
            <div class="flex justify-between items-center">
              <span class="font-bold text-gray-700">${machineName}</span>
              <span class="text-[9px] text-gray-400">${date}</span>
            </div>
            <div class="text-green-600 flex items-center gap-1">
              <i class="fa-solid fa-circle-check" style="color:#6b8f71"></i> <strong style="color:#6b8f71">ALL MAINTENANCE COMPLETE</strong>
            </div>
          </div>
        `;
          }).join('');
        }

        // 個別記録を表示
        if (logs && logs.length > 0) {
          html += logs.map(log => {
            const machineName = combineMap[log.machine_id] || '不明';
            const date = new Date(log.date || log.created_at).toLocaleDateString('ja-JP', {
              month: '2-digit',
              day: '2-digit'
            });

            return `
          <div class="flex flex-col border-b border-gray-50 pb-1 mb-1 last:border-0">
            <div class="flex justify-between items-center">
              <span class="font-bold text-gray-700">${machineName}</span>
              <span class="text-[9px] text-gray-400">${date}</span>
            </div>
            <div class="flex items-center gap-1" style="color: var(--combine-color)">
              <i class="fa-solid fa-check-circle"></i> ${log.item_name} 完了
            </div>
          </div>
        `;
          }).join('');
        }

        if (html) {
          logContainer.innerHTML = html;
        } else {
          logContainer.innerHTML = `<p class="italic text-gray-400 text-center py-4">直近の整備履歴はありません</p>`;
        }
      } catch (err) {
        console.error('履歴取得エラー:', err);
        logContainer.innerHTML = `<p class="text-red-400 text-center py-4">データ取得失敗</p>`;
      }
    }

    loadMaintenanceLogsCombine();

    // その他の機械のメンテナンス履歴をDBから取得して表示する関数
    async function loadMaintenanceLogsOther() {
      const client = window.client;
      const logContainer = document.getElementById('maintenanceLogOther');
      if (!logContainer) return;

      try {
        // その他の機械の機械IDを取得
        const { data: otherMachines, error: machineError } = await client
          .from('machines')
          .select('id, name')
          .eq('machine_type', 'other_machinery');
        if (machineError) throw machineError;

        const otherIds = otherMachines ? otherMachines.map(m => m.id) : [];
        console.log("見つかったその他の機械のID:", otherIds); // 👈 これを追加！
        const otherMap = {};
        if (otherMachines) {
          otherMachines.forEach(m => otherMap[m.id] = m.name);
        }

        // メンテナンス完了ログを取得
        const { data: completionLogs, error: completionError } = await client
          .from('maintenance_completion_logs')
          .select('machine_id, machine_name, completion_date, status, created_at')
          .in('machine_id', otherIds)
          .order('created_at', { ascending: false })
          .limit(3);

        // メンテナンス記録を取得
        const { data: logs, error } = await client
          .from('maintenance_records')
          .select('machine_id, item_name, date, created_at')
          .in('machine_id', otherIds)
          .order('created_at', { ascending: false })
          .limit(5);
        if (error) throw error;

        let html = '';

        // 完了ログを表示
        if (completionLogs && completionLogs.length > 0) {
          html += completionLogs.map(log => {
            const machineName = log.machine_name || otherMap[log.machine_id] || '不明';
            const date = new Date(log.completion_date || log.created_at).toLocaleDateString('ja-JP', {
              month: '2-digit',
              day: '2-digit'
            });
            return `
          <div class="flex flex-col border-b border-gray-50 pb-1 mb-1 last:border-0">
            <div class="flex justify-between items-center">
              <span class="font-bold text-gray-700">${machineName}</span>
              <span class="text-[9px] text-gray-400">${date}</span>
            </div>
            <div class="text-green-600 flex items-center gap-1">
              <i class="fa-solid fa-circle-check" style="color:#6b8f71"></i> <strong style="color:#6b8f71">ALL MAINTENANCE COMPLETE</strong>
            </div>
          </div>
        `;
          }).join('');
        }

        // 個別記録を表示
        if (logs && logs.length > 0) {
          html += logs.map(log => {
            const machineName = otherMap[log.machine_id] || '不明';
            const date = new Date(log.date || log.created_at).toLocaleDateString('ja-JP', {
              month: '2-digit',
              day: '2-digit'
            });
            return `
          <div class="flex flex-col border-b border-gray-50 pb-1 mb-1 last:border-0">
            <div class="flex justify-between items-center">
              <span class="font-bold text-gray-700">${machineName}</span>
              <span class="text-[9px] text-gray-400">${date}</span>
            </div>
            <div class="flex items-center gap-1" style="color: var(--other-color)">
              <i class="fa-solid fa-check-circle"></i> ${log.item_name} 完了
            </div>
          </div>
        `;
          }).join('');
        }

        if (html) {
          // 1回目：とりあえず表示
          logContainer.innerHTML = html;
          console.log("✅ 履歴を表示しました（1回目）");

          // 2回目：0.5秒後、誰かに上書きされて空っぽになっていたら再注入
          setTimeout(() => {
            if (logContainer.innerHTML.includes('italic') || logContainer.innerHTML === "") {
              logContainer.innerHTML = html;
              console.log("♻️ 消されていたので再描画しました（0.5秒後）");
            }
          }, 500);

          // 3回目：1.5秒後、ダメ押しの確認
          setTimeout(() => {
            logContainer.innerHTML = html;
            console.log("📌 履歴を最終固定しました（1.5秒後）");
          }, 1500);
        } else {
          logContainer.innerHTML = `<p class="italic text-gray-400 text-center py-4">直近の整備履歴はありません</p>`;
        }
      } catch (err) {
        console.error('履歴取得エラー:', err);
        logContainer.innerHTML = `<p class="text-red-400 text-center py-4">データ取得失敗</p>`;
      }
    }


    // Mower (スパイダーモア・ウイングモア) メンテナンスリスト読み込み
    async function loadMachineListMower() {
      try {
        // スパイダーモアとウイングモアの両方を取得
        const { data: machines, error } = await client
          .from("machines")
          .select("*")
          .in("machine_type", ["spider_mower", "wing_mower"])
          .order("machine_type")
          .order("id");

        if (error) throw error;

        const container = document.getElementById("maintenanceMachineGridMower");
        if (!container) return;
        container.innerHTML = machines.length === 0
          ? "<p class='text-gray-400 text-center py-8'>mowerが登録されていません</p>"
          : "";

        // 機種ごとにグループ化
        const grouped = {};
        machines.forEach(m => {
          const type = m.machine_type === "spider_mower" ? "スパイダーモア" : "ウイングモア";
          if (!grouped[type]) grouped[type] = [];
          grouped[type].push(m);
        });

        for (const [typeName, typemachines] of Object.entries(grouped)) {
          const typeHeader = document.createElement("h3");
          typeHeader.className = "font-bold text-sm mb-2 mt-4 flex items-center gap-2";
          typeHeader.style.color = "#666633";
          typeHeader.innerHTML = `<i class="fa-solid fa-tag opacity-50"></i> ${typeName}`;
          container.appendChild(typeHeader);

          const grid = document.createElement("div");
          grid.className = "grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-4";

          for (const m of typemachines) {
            const card = document.createElement("div");
            card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-all active:scale-95";

            // 機種に応じて適切な詳細ページを開く
            if (m.machine_type === "spider_mower") {
              card.onclick = () => openMaintenanceDetailSpiderMower(m.id);
            } else {
              card.onclick = () => openMaintenanceDetailWingMower(m.id);
            }

            const icon = m.machine_type === "spider_mower"
              ? '<i class="fa-solid fa-spider"></i>'
              : '<i class="fa-solid fa-leaf"></i>';

            card.innerHTML = `
              <div class="flex flex-col gap-2">
                <div class="flex items-center gap-3">
                  <div style="color: #666633;" class="text-xl flex-shrink-0">
                    ${icon}
                  </div>
                  <div class="font-bold text-gray-900 text-sm leading-tight break-words">${m.name}</div>
                </div>
                <div class="border-t border-gray-50 pt-2" id="card-progress-mower-${m.id}">
                  <div class="text-[11px] text-gray-400 flex items-center gap-1">
                    <i class="fa-solid fa-circle-notch fa-spin text-[9px]"></i> 確認中...
                  </div>
                </div>
              </div>
            `;
            grid.appendChild(card);

            // 進捗状況を非同期で取得
            (async () => {
              try {
                const { data: checks } = await client
                  .from('maintenance_status')
                  .select('item_id, status')
                  .filter('item_id', 'ilike', `${m.id}_%`);

                const totalItems = 7;
                const uniqueChecks = {};
                if (checks) {
                  checks.forEach(c => { uniqueChecks[c.item_id] = c.status; });
                }

                const completedCount = Object.values(uniqueChecks).filter(status => status === true || status === "true").length;
                let percent = Math.round((completedCount / totalItems) * 100);
                percent = Math.min(100, percent);

                const progressDiv = document.getElementById(`card-progress-mower-${m.id}`);
                if (progressDiv) {
                  let statusHTML = percent === 0
                    ? `<span class="text-red-600 font-black"><i class="fa-solid fa-circle-exclamation text-[9px]"></i> 未着手</span>`
                    : percent === 100
                      ? `<span style="color: #666633;" class="font-black"><i class="fa-solid fa-circle-check text-[9px]"></i> 完了</span>`
                      : `<span class="text-orange-500 font-black"><i class="fa-solid fa-spinner text-[9px]"></i> ${percent}% 完了</span>`;

                  progressDiv.innerHTML = `
                    <div class="text-[11px] flex items-center gap-1">${statusHTML}</div>
                    <div class="w-full bg-gray-100 rounded-full h-1 mt-1">
                      <div class="h-1 rounded-full transition-all duration-500" style="width: ${percent}%; background: #666633;"></div>
                    </div>
                  `;
                }
              } catch (err) { console.error("mowerカード進捗更新エラー:", err); }
            })();
          }
          container.appendChild(grid);
        }
      } catch (e) { console.error("mower一覧読み込みエラー:", e); }
    }

    // 刈払い機メンテナンスリスト読み込み
    async function loadMachineListBrushCutter() {
      try {
        const { data: machines, error } = await client
          .from("machines")
          .select("*")
          .eq("machine_type", "brushcutter")
          .order("id");

        if (error) throw error;

        const container = document.getElementById("maintenanceMachineGridBrushCutter");
        if (!container) return;
        container.innerHTML = machines.length === 0
          ? "<p class='text-gray-400 text-center py-8'>刈払い機が登録されていません</p>"
          : "";

        // 機械名から背負い式と肩掛け式を判定してグループ分け
        const grouped = { "背負い式": [], "肩掛け式": [] };
        machines.forEach(m => {
          if (m.name.includes("背負い式")) {
            grouped["背負い式"].push(m);
          } else if (m.name.includes("肩掛け式")) {
            grouped["肩掛け式"].push(m);
          } else {
            if (!grouped["その他"]) grouped["その他"] = [];
            grouped["その他"].push(m);
          }
        });

        // 背負い式を先に表示
        const displayOrder = ["背負い式", "肩掛け式", "その他"];
        for (const typeName of displayOrder) {
          if (!grouped[typeName]) continue;

          const typeHeader = document.createElement("h3");
          typeHeader.className = "font-bold text-sm mb-3 mt-4 flex items-center gap-2";
          typeHeader.style.color = "#418b89";
          typeHeader.innerHTML = `<i class="fa-solid fa-tag opacity-50"></i> ${typeName}`;
          container.appendChild(typeHeader);

          const grid = document.createElement("div");
          grid.className = "grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-4";

          for (const m of grouped[typeName]) {
            const card = document.createElement("div");
            card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-all active:scale-95";
            card.onclick = () => openMaintenanceDetailBrushCutter(m.id);

            card.innerHTML = `
              <div class="flex flex-col gap-2">
                <div class="flex items-center gap-3">
                  <div style="color: #418b89;" class="text-xl flex-shrink-0">
                    <i class="fa-solid fa-scissors"></i>
                  </div>
                  <div class="font-bold text-gray-900 text-lg truncate">${m.name}</div>
                </div>
                <div class="border-t border-gray-50 pt-2" id="card-progress-brush-${m.id}">
                  <div class="text-[11px] text-gray-400 flex items-center gap-1">
                    <i class="fa-solid fa-circle-notch fa-spin text-[9px]"></i> 確認中...
                  </div>
                </div>
              </div>
            `;
            grid.appendChild(card);

            // 進捗状況を非同期で取得
            (async () => {
              try {
                const { data: checks } = await client
                  .from('maintenance_status')
                  .select('item_id, status')
                  .filter('item_id', 'ilike', `${m.id}_%`);

                const totalItems = 8;
                const uniqueChecks = {};
                if (checks) {
                  checks.forEach(c => { uniqueChecks[c.item_id] = c.status; });
                }
                const checkedCount = Object.values(uniqueChecks).filter(s => Boolean(s) === true).length;
                let percentage = Math.round((checkedCount / totalItems) * 100);
                percentage = Math.min(100, percentage);

                const progressDiv = document.getElementById(`card-progress-brush-${m.id}`);
                if (progressDiv) {
                  let statusHTML = percentage === 0
                    ? `<span class="text-red-600 font-black"><i class="fa-solid fa-circle-exclamation text-[9px]"></i> 未着手</span>`
                    : percentage === 100
                      ? `<span style="color: #418b89;" class="font-black"><i class="fa-solid fa-circle-check text-[9px]"></i> 完了</span>`
                      : `<span class="text-orange-500 font-black"><i class="fa-solid fa-spinner text-[9px]"></i> ${percentage}% 完了</span>`;

                  progressDiv.innerHTML = `
                    <div class="text-[11px] flex items-center gap-1">${statusHTML}</div>
                    <div class="w-full bg-gray-100 rounded-full h-1 mt-1">
                      <div class="h-1 rounded-full transition-all duration-500" style="width: ${percentage}%; background: #418b89;"></div>
                    </div>
                  `;
                }
              } catch (e) {
                console.error('進捗取得エラー:', e);
              }
            })();
          }
          container.appendChild(grid);
        }

        // その他のグループも表示
        for (const typeName of Object.keys(grouped)) {
          if (displayOrder.includes(typeName)) continue;

          const typeHeader = document.createElement("h3");
          typeHeader.className = "font-bold text-sm mb-3 mt-4 flex items-center gap-2";
          typeHeader.style.color = "#418b89";
          typeHeader.innerHTML = `<i class="fa-solid fa-tag opacity-50"></i> ${typeName}`;
          container.appendChild(typeHeader);

          const grid = document.createElement("div");
          grid.className = "grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-4";

          for (const m of grouped[typeName]) {
            const card = document.createElement("div");
            card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-all active:scale-95";
            card.onclick = () => openMaintenanceDetailBrushCutter(m.id);

            card.innerHTML = `
              <div class="flex flex-col gap-2">
                <div class="flex items-center gap-3">
                  <div style="color: #418b89;" class="text-xl flex-shrink-0">
                    <i class="fa-solid fa-scissors"></i>
                  </div>
                  <div class="font-bold text-gray-900 text-lg truncate">${m.name}</div>
                </div>
                <div class="border-t border-gray-50 pt-2" id="card-progress-brush-${m.id}">
                  <div class="text-[11px] text-gray-400 flex items-center gap-1">
                    <i class="fa-solid fa-circle-notch fa-spin text-[9px]"></i> 確認中...
                  </div>
                </div>
              </div>
            `;
            grid.appendChild(card);

            // 進捗状況を非同期で取得
            (async () => {
              try {
                const { data: checks } = await client
                  .from('maintenance_status')
                  .select('item_id, status')
                  .filter('item_id', 'ilike', `${m.id}_%`);

                const totalItems = 8;
                const uniqueChecks = {};
                if (checks) {
                  checks.forEach(c => { uniqueChecks[c.item_id] = c.status; });
                }
                const checkedCount = Object.values(uniqueChecks).filter(s => Boolean(s) === true).length;
                let percentage = Math.round((checkedCount / totalItems) * 100);
                percentage = Math.min(100, percentage);

                const progressDiv = document.getElementById(`card-progress-brush-${m.id}`);
                if (progressDiv) {
                  let statusHTML = percentage === 0
                    ? `<span class="text-red-600 font-black"><i class="fa-solid fa-circle-exclamation text-[9px]"></i> 未着手</span>`
                    : percentage === 100
                      ? `<span style="color: #418b89;" class="font-black"><i class="fa-solid fa-circle-check text-[9px]"></i> 完了</span>`
                      : `<span class="text-orange-500 font-black"><i class="fa-solid fa-spinner text-[9px]"></i> ${percentage}% 完了</span>`;

                  progressDiv.innerHTML = `
                    <div class="text-[11px] flex items-center gap-1">${statusHTML}</div>
                    <div class="w-full bg-gray-100 rounded-full h-1 mt-1">
                      <div class="h-1 rounded-full transition-all duration-500" style="width: ${percentage}%; background: #418b89;"></div>
                    </div>
                  `;
                }
              } catch (e) {
                console.error('進捗取得エラー:', e);
              }
            })();
          }
          container.appendChild(grid);
        }
      } catch (e) { console.error("刈払い機一覧読み込みエラー:", e); }
    }

    // 刈払い機メンテナンス詳細を開く
    async function openMaintenanceDetailBrushCutter(machineId) {
      console.log('刈払い機詳細ページを開きます。機械ID:', machineId);
      window.currentMachineIdBrushCutter = machineId;
      switchView('maintenanceDetailViewBrushCutter');

      try {
        const { data: machine, error: machineError } = await client.from("machines").select("*").eq("id", machineId).single();
        if (machineError) throw new Error('機械情報の取得エラー: ' + machineError.message);
        document.getElementById("maintenanceMachineNameBrushCutter").textContent = machine.name;

        const { data: operators } = await client.from('operators').select('name').order('id');
        const opSelect = document.getElementById('newMaintenanceOperatorBrushCutter');
        if (opSelect && operators) {
          opSelect.innerHTML = '<option value="">担当者を選択</option>';
          operators.forEach(op => {
            const opt = document.createElement('option');
            opt.value = op.name; opt.textContent = op.name;
            opSelect.appendChild(opt);
          });
        }

        loadMaintenanceHistoryBrushCutter(machineId);
        const { data: items, error: itemsError } = await client.from("maintenance_items_brush_cutter").select("*").order("id");
        if (itemsError) {
          console.error('メンテナンス項目の取得エラー:', itemsError);
          alert('メンテナンス項目の読み込みに失敗しました。maintenance_items_brush_cutterテーブルが存在するか確認してください。');
        }
        const checklistContainer = document.getElementById("maintenanceChecklistBrushCutter");
        if (checklistContainer && items) {
          checklistContainer.innerHTML = "";
          items.forEach(item => {
            const uniqueId = `${machineId}_${item.id}`;
            const div = document.createElement("div");
            div.className = "flex items-center justify-between p-3 border-b border-gray-50 last:border-0 hover:bg-gray-50 transition-colors";
            div.innerHTML = `
              <div class="flex flex-col flex-1 text-left">
                  <span class="text-sm font-bold text-gray-700">${item.item_name}</span>
                  <span class="text-[10px] text-gray-400">${item.description || ''}</span>
              </div>
              <input type="checkbox" id="${uniqueId}" class="maintenance-check w-6 h-6 rounded border-gray-300"
                     style="accent-color: #418b89;"
                     onchange="saveSingleCheckBrushCutter('${machineId}', '${item.id}', this.checked)">
            `;
            checklistContainer.appendChild(div);
          });
        } else if (checklistContainer) {
          checklistContainer.innerHTML = '<p class="text-gray-400 text-center py-4">メンテナンス項目が登録されていません</p>';
        }
        await restoreMaintenanceChecksBrushCutter();
      } catch (e) {
        console.error('刈払い機詳細ページエラー:', e);
        alert('エラーが発生しました: ' + e.message);
      }
    }

    // 刈払い機進捗表示の更新
    function updateMaintenanceProgressBrushCutter() {
      const checkboxes = document.querySelectorAll('#maintenanceChecklistBrushCutter input[type="checkbox"]');
      const total = checkboxes.length;
      if (total === 0) return;
      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
      const percentage = Math.round((checkedCount / total) * 100);
      const summaryDiv = document.getElementById('maintenanceSummaryBrushCutter');
      if (summaryDiv) {
        summaryDiv.innerHTML = `
          <div class="flex justify-between items-center mb-1">
            <span class="font-bold" style="color: #418b89;">${percentage}% 完了</span>
            <span class="text-xs text-gray-400">${checkedCount} / ${total} 項目</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="h-2 rounded-full transition-all duration-500" style="width: ${percentage}%; background: #418b89;"></div>
          </div>
        `;
      }
    }

    // 刈払い機チェック保存
    async function saveSingleCheckBrushCutter(machineId, itemId, isChecked) {
      const itemIdStr = `${machineId}_${itemId}`;
      try {
        await client.from('maintenance_status').upsert({
          item_id: itemIdStr,
          status: Boolean(isChecked),
          updated_at: new Date().toISOString()
        }, { onConflict: 'item_id' });
        updateMaintenanceProgressBrushCutter();
        loadMachineListBrushCutter();
      } catch (e) {
        console.error(e);
      }
    }

    // 刈払い機チェック復元
    async function restoreMaintenanceChecksBrushCutter() {
      if (!window.currentMachineIdBrushCutter) return;
      try {
        const { data: checks } = await client
          .from('maintenance_status')
          .select('item_id, status')
          .filter('item_id', 'ilike', `${window.currentMachineIdBrushCutter}_%`);

        if (checks) {
          checks.forEach(c => {
            const cb = document.getElementById(c.item_id);
            if (cb) cb.checked = Boolean(c.status);
          });
        }
        updateMaintenanceProgressBrushCutter();
      } catch (e) {
        console.error(e);
      }
    }

    // 刈払い機履歴読み込み
    async function loadMaintenanceHistoryBrushCutter(machineId) {
      try {
        const { data: records } = await client
          .from('maintenance_records')
          .select('*')
          .eq('machine_id', machineId)
          .order('created_at', { ascending: false });

        const historyContainer = document.getElementById('maintenanceHistoryLogBrushCutter');
        if (!historyContainer) return;

        if (!records || records.length === 0) {
          historyContainer.innerHTML = '<p class="italic text-gray-400 text-center py-4">履歴はありません</p>';
          return;
        }

        historyContainer.innerHTML = records.map(rec => `
          <div class="border-b border-gray-100 pb-2 mb-2 last:border-0 text-left">
            <div class="flex justify-between font-bold text-gray-700"><span>${rec.item_name}</span><span class="text-gray-400 text-[9px]">${rec.date}</span></div>
            <div class="text-gray-500">担当: ${rec.operator}</div>
            ${rec.memo ? `<div class="text-gray-400 italic">"${rec.memo}"</div>` : ''}
          </div>
        `).join('');
      } catch (e) {
        console.error(e);
      }
    }

    // 刈払い機部品交換記録保存
    async function saveMaintenanceRecordBrushCutter() {
      const itemName = document.getElementById('newMaintenanceItemBrushCutter').value;
      const operator = document.getElementById('newMaintenanceOperatorBrushCutter').value;
      const status = document.getElementById('newMaintenanceStatusBrushCutter').value;
      const memo = document.getElementById('newMaintenanceMemoBrushCutter').value;

      if (!itemName) {
        alert('交換部品・項目名を入力してください');
        return;
      }

      try {
        await client.from('maintenance_records').insert({
          machine_id: window.currentMachineIdBrushCutter,
          item_name: itemName,
          operator: operator || null,
          status: status,
          memo: memo || null,
          recorded_at: new Date().toISOString()
        });

        document.getElementById('newMaintenanceItemBrushCutter').value = '';
        document.getElementById('newMaintenanceOperatorBrushCutter').value = '';
        document.getElementById('newMaintenanceStatusBrushCutter').value = 'done';
        document.getElementById('newMaintenanceMemoBrushCutter').value = '';

        loadMaintenanceHistoryBrushCutter(window.currentMachineIdBrushCutter);
        alert('保存しました');
      } catch (e) {
        console.error(e);
        alert('保存に失敗しました');
      }
    }

    // スパイダーモアメンテナンスリスト読み込み
    async function loadMachineListSpiderMower() {
      try {
        const { data: machines, error } = await client
          .from("machines")
          .select("*")
          .eq("machine_type", "spider_mower")
          .order("id");

        if (error) throw error;

        const container = document.getElementById("maintenanceMachineGridSpiderMower");
        if (!container) return;
        container.innerHTML = machines.length === 0
          ? "<p class='text-gray-400 text-center py-8'>スパイダーモアが登録されていません</p>"
          : "";

        for (const m of machines) {
          const card = document.createElement("div");
          card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-all active:scale-95";
          card.onclick = () => openMaintenanceDetailSpiderMower(m.id);

          card.innerHTML = `
            <div class="flex flex-col gap-2">
              <div class="flex items-center gap-3">
                <div style="color: #f59e0b;" class="text-xl flex-shrink-0">
                  <i class="fa-solid fa-spider"></i>
                </div>
                <div class="font-bold text-gray-900 text-lg truncate">${m.name}</div>
              </div>
              <div class="border-t border-gray-50 pt-2" id="card-progress-spider-${m.id}">
                <div class="text-[11px] text-gray-400 flex items-center gap-1">
                  <i class="fa-solid fa-circle-notch fa-spin text-[9px]"></i> 確認中...
                </div>
              </div>
            </div>
          `;
          container.appendChild(card);

          // 進捗状況を非同期で取得
          (async () => {
            try {
              const { data: checks } = await client
                .from('maintenance_status')
                .select('item_id, status')
                .filter('item_id', 'ilike', `${m.id}_%`);

              const totalItems = 7;
              const uniqueChecks = {};
              if (checks) {
                checks.forEach(c => { uniqueChecks[c.item_id] = c.status; });
              }

              const completedCount = Object.values(uniqueChecks).filter(status => status === true || status === "true").length;
              let percent = Math.round((completedCount / totalItems) * 100);
              percent = Math.min(100, percent);

              const progressDiv = document.getElementById(`card-progress-spider-${m.id}`);
              if (progressDiv) {
                let statusHTML = percent === 0
                  ? `<span class="text-red-600 font-black"><i class="fa-solid fa-circle-exclamation text-[9px]"></i> 未着手</span>`
                  : percent === 100
                    ? `<span style="color: #f59e0b;" class="font-black"><i class="fa-solid fa-circle-check text-[9px]"></i> 完了</span>`
                    : `<span class="text-orange-500 font-black"><i class="fa-solid fa-spinner text-[9px]"></i> ${percent}% 完了</span>`;

                progressDiv.innerHTML = `
                  <div class="text-[11px] flex items-center gap-1">${statusHTML}</div>
                  <div class="w-full bg-gray-100 rounded-full h-1 mt-1">
                    <div class="h-1 rounded-full transition-all duration-500" style="width: ${percent}%; background: #f59e0b;"></div>
                  </div>
                `;
              }
            } catch (err) { console.error("スパイダーモアカード進捗更新エラー:", err); }
          })();
        }
      } catch (e) { console.error("スパイダーモア一覧読み込みエラー:", e); }
    }

    // ウイングモアメンテナンスリスト読み込み
    async function loadMachineListWingMower() {
      try {
        const { data: machines, error } = await client
          .from("machines")
          .select("*")
          .eq("machine_type", "wing_mower")
          .order("id");

        if (error) throw error;

        const container = document.getElementById("maintenanceMachineGridWingMower");
        if (!container) return;
        container.innerHTML = machines.length === 0
          ? "<p class='text-gray-400 text-center py-8'>ウイングモアが登録されていません</p>"
          : "";

        for (const m of machines) {
          const card = document.createElement("div");
          card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-all active:scale-95";
          card.onclick = () => openMaintenanceDetailWingMower(m.id);

          card.innerHTML = `
            <div class="flex flex-col gap-2">
              <div class="flex items-center gap-3">
                <div style="color: #84cc16;" class="text-xl flex-shrink-0">
                  <i class="fa-solid fa-leaf"></i>
                </div>
                <div class="font-bold text-gray-900 text-lg truncate">${m.name}</div>
              </div>
              <div class="border-t border-gray-50 pt-2" id="card-progress-wing-${m.id}">
                <div class="text-[11px] text-gray-400 flex items-center gap-1">
                  <i class="fa-solid fa-circle-notch fa-spin text-[9px]"></i> 確認中...
                </div>
              </div>
            </div>
          `;
          container.appendChild(card);

          // 進捗状況を非同期で取得
          (async () => {
            try {
              const { data: checks } = await client
                .from('maintenance_status')
                .select('item_id, status')
                .filter('item_id', 'ilike', `${m.id}_%`);

              const totalItems = 7;
              const uniqueChecks = {};
              if (checks) {
                checks.forEach(c => { uniqueChecks[c.item_id] = c.status; });
              }

              const completedCount = Object.values(uniqueChecks).filter(status => status === true || status === "true").length;
              let percent = Math.round((completedCount / totalItems) * 100);
              percent = Math.min(100, percent);

              const progressDiv = document.getElementById(`card-progress-wing-${m.id}`);
              if (progressDiv) {
                let statusHTML = percent === 0
                  ? `<span class="text-red-600 font-black"><i class="fa-solid fa-circle-exclamation text-[9px]"></i> 未着手</span>`
                  : percent === 100
                    ? `<span style="color: #84cc16;" class="font-black"><i class="fa-solid fa-circle-check text-[9px]"></i> 完了</span>`
                    : `<span class="text-orange-500 font-black"><i class="fa-solid fa-spinner text-[9px]"></i> ${percent}% 完了</span>`;

                progressDiv.innerHTML = `
                  <div class="text-[11px] flex items-center gap-1">${statusHTML}</div>
                  <div class="w-full bg-gray-100 rounded-full h-1 mt-1">
                    <div class="h-1 rounded-full transition-all duration-500" style="width: ${percent}%; background: #84cc16;"></div>
                  </div>
                `;
              }
            } catch (err) { console.error("ウイングモアカード進捗更新エラー:", err); }
          })();
        }
      } catch (e) { console.error("ウイングモア一覧読み込みエラー:", e); }
    }

    // インプルメントメンテナンスリスト読み込み
    async function loadMachineListImplement() {
      try {
        const { data: machines, error } = await client
          .from("machines")
          .select("*")
          .eq("machine_type", "implement")
          .order("id");

        if (error) throw error;

        const container = document.getElementById("maintenanceMachineGridImplement");
        if (!container) return;
        container.innerHTML = machines.length === 0
          ? "<p class='text-gray-400 text-center py-8'>インプルメントが登録されていません</p>"
          : "";

        // sub_type別にグループ化
        const grouped = {};
        machines.forEach(m => {
          // machinesテーブルのsub_typeカラムを参照
          const subType = m.sub_type || 'other';

          if (!grouped[subType]) grouped[subType] = [];
          grouped[subType].push(m);
        });

        // sub_type順に表示（データベースに存在するすべてのsub_typeを表示）
        const subTypeOrder = ['plow', 'rotary', 'ridge_maker', 'ridge_mower', 'harrow', 'fertilizer_applicator', 'other'];

        // 定義済みのsub_typeを優先順に表示
        const displayedSubTypes = new Set();
        for (const subType of subTypeOrder) {
          if (!grouped[subType] || grouped[subType].length === 0) continue;
          displayedSubTypes.add(subType);

          const subTypeHeader = document.createElement("h3");
          subTypeHeader.className = "font-bold text-sm mb-2 mt-4 flex items-center gap-2";
          subTypeHeader.style.color = "#483D8B";
          subTypeHeader.innerHTML = `<i class="fa-solid fa-layer-group opacity-50"></i> ${subType}`;
          container.appendChild(subTypeHeader);

          const grid = document.createElement("div");
          grid.className = "grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-4";

          for (const m of grouped[subType]) {
            const card = document.createElement("div");
            card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-all active:scale-95";
            card.onclick = () => openMaintenanceDetailImplement(m.id);

            card.innerHTML = `
              <div class="flex flex-col gap-2">
                <div class="flex items-center gap-3">
                  <div style="color: #483D8B;" class="text-xl flex-shrink-0">
                    <i class="fa-solid fa-gears"></i>
                  </div>
                  <div class="font-bold text-gray-900 text-sm leading-tight break-words">${m.name}</div>
                </div>
                <div class="border-t border-gray-50 pt-2" id="card-progress-implement-${m.id}">
                  <div class="text-[11px] text-gray-400 flex items-center gap-1">
                    <i class="fa-solid fa-circle-notch fa-spin text-[9px]"></i> 確認中...
                  </div>
                </div>
              </div>
            `;
            grid.appendChild(card);

            // 進捗状況を非同期で取得して反映
            (async () => {
              try {
                const { data: checks } = await client
                  .from('maintenance_status')
                  .select('item_id, status')
                  .filter('item_id', 'ilike', `${m.id}_%`);

                const { data: items } = await client.from("maintenance_items_implements").select("id");
                const totalItems = items ? items.length : 20;

                const uniqueChecks = {};
                if (checks) {
                  checks.forEach(c => { uniqueChecks[c.item_id] = c.status; });
                }

                const completedCount = Object.values(uniqueChecks).filter(status => status === true || status === "true").length;
                let percent = Math.round((completedCount / totalItems) * 100);
                percent = Math.min(100, percent);

                const progressDiv = document.getElementById(`card-progress-implement-${m.id}`);
                if (progressDiv) {
                  let statusHTML = percent === 0
                    ? `<span class="text-red-600 font-black"><i class="fa-solid fa-circle-exclamation text-[9px]"></i> 未着手</span>`
                    : percent === 100
                      ? `<span style="color: #483D8B;" class="font-black"><i class="fa-solid fa-circle-check text-[9px]"></i> 完了</span>`
                      : `<span class="text-orange-500 font-black"><i class="fa-solid fa-spinner text-[9px]"></i> ${percent}% 完了</span>`;

                  progressDiv.innerHTML = `
                    <div class="text-[11px] flex items-center gap-1">${statusHTML}</div>
                    <div class="w-full bg-gray-100 rounded-full h-1 mt-1">
                      <div class="h-1 rounded-full transition-all duration-500" style="background-color: #483D8B; width: ${percent}%"></div>
                    </div>
                  `;
                }
              } catch (err) { console.error("カード進捗更新エラー:", err); }
            })();
          }
          container.appendChild(grid);
        }

        // 定義されていないsub_typeも表示
        for (const subType of Object.keys(grouped)) {
          if (displayedSubTypes.has(subType)) continue;

          const subTypeHeader = document.createElement("h3");
          subTypeHeader.className = "font-bold text-sm mb-2 mt-4 flex items-center gap-2";
          subTypeHeader.style.color = "#483D8B";
          subTypeHeader.innerHTML = `<i class="fa-solid fa-layer-group opacity-50"></i> ${subType}`;
          container.appendChild(subTypeHeader);

          const grid = document.createElement("div");
          grid.className = "grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-4";

          for (const m of grouped[subType]) {
            const card = document.createElement("div");
            card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-all active:scale-95";
            card.onclick = () => openMaintenanceDetailImplement(m.id);

            card.innerHTML = `
              <div class="flex flex-col gap-2">
                <div class="flex items-center gap-3">
                  <div style="color: #483D8B;" class="text-xl flex-shrink-0">
                    <i class="fa-solid fa-gears"></i>
                  </div>
                  <div class="font-bold text-gray-900 text-sm leading-tight break-words">${m.name}</div>
                </div>
                <div class="border-t border-gray-50 pt-2" id="card-progress-implement-${m.id}">
                  <div class="text-[11px] text-gray-400 flex items-center gap-1">
                    <i class="fa-solid fa-circle-notch fa-spin text-[9px]"></i> 確認中...
                  </div>
                </div>
              </div>
            `;
            grid.appendChild(card);

            // 進捗状況を非同期で取得して反映
            (async () => {
              try {
                const { data: checks } = await client
                  .from('maintenance_status')
                  .select('item_id, status')
                  .filter('item_id', 'ilike', `${m.id}_%`);

                const { data: items } = await client.from("maintenance_items_implements").select("id");
                const totalItems = items ? items.length : 20;

                const uniqueChecks = {};
                if (checks) {
                  checks.forEach(c => { uniqueChecks[c.item_id] = c.status; });
                }

                const completedCount = Object.values(uniqueChecks).filter(status => status === true || status === "true").length;
                let percent = Math.round((completedCount / totalItems) * 100);
                percent = Math.min(100, percent);

                const progressDiv = document.getElementById(`card-progress-implement-${m.id}`);
                if (progressDiv) {
                  let statusHTML = percent === 0
                    ? `<span class="text-red-600 font-black"><i class="fa-solid fa-circle-exclamation text-[9px]"></i> 未着手</span>`
                    : percent === 100
                      ? `<span style="color: #483D8B;" class="font-black"><i class="fa-solid fa-circle-check text-[9px]"></i> 完了</span>`
                      : `<span class="text-orange-500 font-black"><i class="fa-solid fa-spinner text-[9px]"></i> ${percent}% 完了</span>`;

                  progressDiv.innerHTML = `
                    <div class="text-[11px] flex items-center gap-1">${statusHTML}</div>
                    <div class="w-full bg-gray-100 rounded-full h-1 mt-1">
                      <div class="h-1 rounded-full transition-all duration-500" style="background-color: #483D8B; width: ${percent}%"></div>
                    </div>
                  `;
                }
              } catch (err) { console.error("カード進捗更新エラー:", err); }
            })();
          }
          container.appendChild(grid);
        }
      } catch (e) { console.error("インプルメント一覧読み込みエラー:", e); }
    }

    // 動力散布機メンテナンスリスト読み込み
    async function loadMachineListSpreader() {
      try {
        const { data: machines, error } = await client
          .from("machines")
          .select("*")
          .eq("machine_type", "power_duster")
          .order("id");

        if (error) throw error;

        const container = document.getElementById("maintenanceMachineGridSpreader");
        if (!container) return;
        container.innerHTML = machines.length === 0
          ? "<p class='text-gray-400 text-center py-8'>動力散布機が登録されていません</p>"
          : "";

        // メーカー別にグループ化
        const grouped = {};
        machines.forEach(m => {
          const manufacturer = m.manufacturer || "その他";
          if (!grouped[manufacturer]) grouped[manufacturer] = [];
          grouped[manufacturer].push(m);
        });

        for (const brand of Object.keys(grouped)) {
          const brandHeader = document.createElement("h3");
          brandHeader.className = "font-bold text-sm mb-2 mt-4 flex items-center gap-2";
          brandHeader.style.color = "#DB7093";
          brandHeader.innerHTML = `<i class="fa-solid fa-tag opacity-50"></i> ${brand}`;
          container.appendChild(brandHeader);

          const grid = document.createElement("div");
          grid.className = "grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-4";

          for (const m of grouped[brand]) {
            const card = document.createElement("div");
            card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-all active:scale-95";
            card.onclick = () => openMaintenanceDetailSpreader(m.id);

            card.innerHTML = `
              <div class="flex flex-col gap-2">
                <div class="flex items-center gap-3">
                  <div style="color: #DB7093;" class="text-xl flex-shrink-0">
                    <i class="fa-solid fa-seedling"></i>
                  </div>
                  <div class="font-bold text-gray-900 text-sm leading-tight break-words">${m.name}</div>
                </div>
                <div class="border-t border-gray-50 pt-2" id="card-progress-spreader-${m.id}">
                  <div class="text-[11px] text-gray-400 flex items-center gap-1">
                    <i class="fa-solid fa-circle-notch fa-spin text-[9px]"></i> 確認中...
                  </div>
                </div>
              </div>
            `;
            grid.appendChild(card);

            // 進捗状況を非同期で取得して反映
            (async () => {
              try {
                const { data: checks } = await client
                  .from('maintenance_status')
                  .select('item_id, status')
                  .filter('item_id', 'ilike', `${m.id}_%`);

                const { data: items } = await client.from("maintenance_items_power_duster").select("id");
                const totalItems = items ? items.length : 20;

                const uniqueChecks = {};
                if (checks) {
                  checks.forEach(c => { uniqueChecks[c.item_id] = c.status; });
                }

                const completedCount = Object.values(uniqueChecks).filter(status => status === true || status === "true").length;
                let percent = Math.round((completedCount / totalItems) * 100);
                percent = Math.min(100, percent);

                const progressDiv = document.getElementById(`card-progress-spreader-${m.id}`);
                if (progressDiv) {
                  let statusHTML = percent === 0
                    ? `<span class="text-red-600 font-black"><i class="fa-solid fa-circle-exclamation text-[9px]"></i> 未着手</span>`
                    : percent === 100
                      ? `<span class="text-[#DB7093] font-black"><i class="fa-solid fa-circle-check text-[9px]"></i> 完了</span>`
                      : `<span class="text-orange-500 font-black"><i class="fa-solid fa-spinner text-[9px]"></i> ${percent}% 完了</span>`;

                  progressDiv.innerHTML = `
                    <div class="text-[11px] flex items-center gap-1">${statusHTML}</div>
                    <div class="w-full bg-gray-100 rounded-full h-1 mt-1">
                      <div class="h-1 rounded-full transition-all duration-500" style="width: ${percent}%; background: #DB7093;"></div>
                    </div>
                  `;
                }
              } catch (err) { console.error("動力散布機カード進捗更新エラー:", err); }
            })();
          }
          container.appendChild(grid);
        }
      } catch (e) { console.error("動力散布機一覧読み込みエラー:", e); }
    }

    // 動力散布機メンテナンス詳細を開く
    async function openMaintenanceDetailSpreader(machineId) {
      console.log('動力散布機詳細ページを開きます。機械ID:', machineId);
      window.currentMachineIdSpreader = machineId;
      switchView('maintenanceDetailViewSpreader');

      try {
        const { data: machine, error: machineError } = await client.from("machines").select("*").eq("id", machineId).single();
        if (machineError) throw new Error('機械情報の取得エラー: ' + machineError.message);
        document.getElementById("maintenanceMachineNameSpreader").textContent = machine.name;

        const { data: operators } = await client.from('operators').select('name').order('id');
        const opSelect = document.getElementById('newMaintenanceOperatorSpreader');
        if (opSelect && operators) {
          opSelect.innerHTML = '<option value="">担当者を選択</option>';
          operators.forEach(op => {
            const opt = document.createElement('option');
            opt.value = op.name; opt.textContent = op.name;
            opSelect.appendChild(opt);
          });
        }

        loadMaintenanceHistorySpreader(machineId);
        const { data: items, error: itemsError } = await client.from("maintenance_items_power_duster").select("*").order("id");
        if (itemsError) {
          console.error('メンテナンス項目の取得エラー:', itemsError);
          alert('メンテナンス項目の読み込みに失敗しました。maintenance_items_power_dusterテーブルが存在するか確認してください。');
        }
        const checklistContainer = document.getElementById("maintenanceChecklistSpreader");
        if (checklistContainer && items) {
          checklistContainer.innerHTML = "";
          items.forEach(item => {
            const uniqueId = `${machineId}_${item.id}`;
            const div = document.createElement("div");
            div.className = "flex items-center justify-between p-3 border-b border-gray-50 last:border-0 hover:bg-gray-50 transition-colors";
            div.innerHTML = `
              <div class="flex flex-col flex-1 text-left">
                  <span class="text-sm font-bold text-gray-700">${item.item_name}</span>
                  <span class="text-[10px] text-gray-400">${item.description || ''}</span>
              </div>
              <input type="checkbox" id="${uniqueId}" class="maintenance-check w-6 h-6 rounded border-gray-300"
                     style="accent-color: #DB7093;"
                     onchange="saveSingleCheckSpreader('${machineId}', '${item.id}', this.checked)">
            `;
            checklistContainer.appendChild(div);
          });
        } else if (checklistContainer) {
          checklistContainer.innerHTML = '<p class="text-gray-400 text-center py-4">メンテナンス項目が登録されていません</p>';
        }
        await restoreMaintenanceChecksSpreader();
      } catch (e) {
        console.error('動力散布機詳細ページエラー:', e);
        alert('エラーが発生しました: ' + e.message);
      }
    }

    // 動力散布機進捗表示の更新
    function updateMaintenanceProgressSpreader() {
      const checkboxes = document.querySelectorAll('#maintenanceChecklistSpreader input[type="checkbox"]');
      const total = checkboxes.length;
      if (total === 0) return;
      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
      const percentage = Math.round((checkedCount / total) * 100);
      const summaryDiv = document.getElementById('maintenanceSummarySpreader');
      if (summaryDiv) {
        summaryDiv.innerHTML = `
          <div class="flex justify-between items-center mb-1">
            <span class="font-bold" style="color: #DB7093;">${percentage}% 完了</span>
            <span class="text-xs text-gray-400">${checkedCount} / ${total} 項目</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="h-2 rounded-full transition-all duration-500" style="width: ${percentage}%; background: #DB7093;"></div>
          </div>
        `;
      }
    }

    // 動力散布機チェック保存
    async function saveSingleCheckSpreader(machineId, itemId, isChecked) {
      const itemIdStr = `${machineId}_${itemId}`;
      try {
        await client.from('maintenance_status').upsert({
          item_id: itemIdStr,
          status: Boolean(isChecked),
          updated_at: new Date().toISOString()
        }, { onConflict: 'item_id' });
        updateMaintenanceProgressSpreader();
        loadMachineListSpreader();
      } catch (e) {
        console.error(e);
      }
    }

    // 動力散布機チェック復元
    async function restoreMaintenanceChecksSpreader() {
      if (!window.currentMachineIdSpreader) return;
      try {
        const { data: checks } = await client
          .from('maintenance_status')
          .select('item_id, status')
          .filter('item_id', 'ilike', `${window.currentMachineIdSpreader}_%`);

        if (checks) {
          checks.forEach(c => {
            const cb = document.getElementById(c.item_id);
            if (cb) cb.checked = Boolean(c.status);
          });
        }
        updateMaintenanceProgressSpreader();
      } catch (e) {
        console.error(e);
      }
    }

    // 動力散布機履歴読み込み
    async function loadMaintenanceHistorySpreader(machineId) {
      try {
        const { data: records } = await client
          .from('maintenance_records')
          .select('*')
          .eq('machine_id', machineId)
          .order('created_at', { ascending: false });

        const historyContainer = document.getElementById('maintenanceHistoryLogSpreader');
        if (!historyContainer) return;

        if (!records || records.length === 0) {
          historyContainer.innerHTML = '<p class="italic text-gray-400 text-center py-4">履歴はありません</p>';
          return;
        }

        historyContainer.innerHTML = records.map(rec => `
          <div class="border-b border-gray-100 pb-2 mb-2 last:border-0 text-left">
            <div class="flex justify-between font-bold text-gray-700"><span>${rec.item_name}</span><span class="text-gray-400 text-[9px]">${rec.date}</span></div>
            <div class="text-gray-500">担当: ${rec.operator}</div>
            ${rec.memo ? `<div class="text-gray-400 italic">"${rec.memo}"</div>` : ''}
          </div>
        `).join('');
      } catch (e) {
        console.error(e);
      }
    }

    // 動力散布機部品交換記録保存
    async function saveMaintenanceRecordSpreader() {
      const itemName = document.getElementById('newMaintenanceItemSpreader').value;
      const operator = document.getElementById('newMaintenanceOperatorSpreader').value;
      const status = document.getElementById('newMaintenanceStatusSpreader').value;
      const memo = document.getElementById('newMaintenanceMemoSpreader').value;

      if (!itemName) {
        alert('交換部品・項目名を入力してください');
        return;
      }

      try {
        await client.from('maintenance_records').insert({
          machine_id: window.currentMachineIdSpreader,
          item_name: itemName,
          operator: operator || null,
          status: status,
          memo: memo || null,
          recorded_at: new Date().toISOString()
        });

        document.getElementById('newMaintenanceItemSpreader').value = '';
        document.getElementById('newMaintenanceOperatorSpreader').value = '';
        document.getElementById('newMaintenanceStatusSpreader').value = 'done';
        document.getElementById('newMaintenanceMemoSpreader').value = '';

        loadMaintenanceHistorySpreader(window.currentMachineIdSpreader);
        alert('保存しました');
      } catch (e) {
        console.error(e);
        alert('保存に失敗しました');
      }
    }

    // インプルメントメンテナンス詳細を開く
    async function openMaintenanceDetailImplement(machineId) {
      console.log('インプルメント詳細ページを開きます。機械ID:', machineId);
      window.currentMachineIdImplement = machineId;
      switchView('maintenanceDetailViewImplement');

      try {
        const { data: machine, error: machineError } = await client.from("machines").select("*").eq("id", machineId).single();
        if (machineError) throw new Error('機械情報の取得エラー: ' + machineError.message);
        document.getElementById("maintenanceMachineNameImplement").textContent = machine.name;

        // サブタイプを取得（機械テーブルの値をそのまま使用）
        const subType = machine.sub_type || null;

        const { data: operators } = await client.from('operators').select('name').order('id');
        const opSelect = document.getElementById('newMaintenanceOperatorImplement');
        if (opSelect && operators) {
          opSelect.innerHTML = '<option value="">担当者を選択</option>';
          operators.forEach(op => {
            const opt = document.createElement('option');
            opt.value = op.name; opt.textContent = op.name;
            opSelect.appendChild(opt);
          });
        }

        loadMaintenanceHistoryImplement(machineId);

        // メンテナンス項目を取得（sub_typeでフィルタ）
        let itemsQuery = client.from("maintenance_items_implements").select("*").order("id");

        if (subType) {
          itemsQuery = itemsQuery.eq('sub_type', subType);
        }

        const { data: items, error: itemsError } = await itemsQuery;

        if (itemsError) {
          console.error('メンテナンス項目の取得エラー:', itemsError);
          alert('メンテナンス項目の読み込みに失敗しました。maintenance_items_implementsテーブルが存在するか確認してください。');
        }

        const checklistContainer = document.getElementById("maintenanceChecklistImplement");
        if (checklistContainer && items && items.length > 0) {
          checklistContainer.innerHTML = "";
          items.forEach(item => {
            const uniqueId = `${machineId}_${item.id}`;
            const div = document.createElement("div");
            div.className = "flex items-center justify-between p-3 border-b border-gray-50 last:border-0 hover:bg-gray-50 transition-colors";
            div.innerHTML = `
              <div class="flex flex-col flex-1 text-left">
                  <span class="text-sm font-bold text-gray-700">${item.item_name}</span>
                  <span class="text-[10px] text-gray-400">${item.description || ''}</span>
              </div>
              <input type="checkbox" id="${uniqueId}" class="maintenance-check w-6 h-6 rounded border-gray-300"
                     style="accent-color: #483D8B;"
                     onchange="saveSingleCheckImplement('${machineId}', '${item.id}', this.checked)">
            `;
            checklistContainer.appendChild(div);
          });
        } else if (checklistContainer) {
          checklistContainer.innerHTML = '<p class="text-gray-400 text-center py-4">この機械のメンテナンス項目が登録されていません</p>';
        }
        await restoreMaintenanceChecksImplement();
      } catch (e) {
        console.error('インプルメント詳細ページエラー:', e);
        alert('エラーが発生しました: ' + e.message);
      }
    }

    // インプルメント進捗表示の更新
    function updateMaintenanceProgressImplement() {
      const checkboxes = document.querySelectorAll('#maintenanceChecklistImplement input[type="checkbox"]');
      const total = checkboxes.length;
      if (total === 0) return;
      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
      const percentage = Math.round((checkedCount / total) * 100);
      const summaryDiv = document.getElementById('maintenanceSummaryImplement');
      if (summaryDiv) {
        summaryDiv.innerHTML = `
          <div class="flex justify-between items-center mb-1">
            <span class="font-bold" style="color: #483D8B;">${percentage}% 完了</span>
            <span class="text-xs text-gray-400">${checkedCount} / ${total} 項目</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="h-2 rounded-full transition-all duration-500" style="width: ${percentage}%; background: #483D8B;"></div>
          </div>
        `;
      }
    }

    // インプルメントチェック保存
    async function saveSingleCheckImplement(machineId, itemId, isChecked) {
      const itemIdStr = `${machineId}_${itemId}`;
      try {
        await client.from('maintenance_status').upsert({
          item_id: itemIdStr,
          status: Boolean(isChecked),
          updated_at: new Date().toISOString()
        }, { onConflict: 'item_id' });
        updateMaintenanceProgressImplement();
        loadMachineListImplement();

        // 全項目完了チェック
        await checkAndSaveMaintenanceCompletion(machineId, 'implements');
      } catch (e) {
        console.error(e);
      }
    }

    // インプルメントチェック復元
    async function restoreMaintenanceChecksImplement() {
      if (!window.currentMachineIdImplement) return;
      try {
        const { data: checks } = await client
          .from('maintenance_status')
          .select('item_id, status')
          .filter('item_id', 'ilike', `${window.currentMachineIdImplement}_%`);

        if (checks) {
          checks.forEach(c => {
            const cb = document.getElementById(c.item_id);
            if (cb) cb.checked = Boolean(c.status);
          });
        }
        updateMaintenanceProgressImplement();
      } catch (e) {
        console.error(e);
      }
    }

    // インプルメント履歴読み込み
    async function loadMaintenanceHistoryImplement(machineId) {
      try {
        const { data: records } = await client
          .from('maintenance_records')
          .select('*')
          .eq('machine_id', machineId)
          .order('created_at', { ascending: false });

        const historyContainer = document.getElementById('maintenanceHistoryLogImplement');
        if (!historyContainer) return;

        if (!records || records.length === 0) {
          historyContainer.innerHTML = '<p class="italic text-gray-400 text-center py-4">履歴はありません</p>';
          return;
        }

        historyContainer.innerHTML = records.map(rec => `
          <div class="border-b border-gray-100 pb-2 mb-2 last:border-0 text-left">
            <div class="flex justify-between font-bold text-gray-700"><span>${rec.item_name}</span><span class="text-gray-400 text-[9px]">${rec.date}</span></div>
            <div class="text-gray-500">担当: ${rec.operator}</div>
            ${rec.memo ? `<div class="text-gray-400 italic">"${rec.memo}"</div>` : ''}
          </div>
        `).join('');
      } catch (e) {
        console.error('履歴読み込みエラー:', e);
      }
    }

    // インプルメント記録保存
    async function saveMaintenanceRecordImplement() {
      const itemName = document.getElementById('newMaintenanceItemImplement').value;
      const operator = document.getElementById('newMaintenanceOperatorImplement').value;
      const status = document.getElementById('newMaintenanceStatusImplement').value;
      const memo = document.getElementById('newMaintenanceMemoImplement').value;

      if (!itemName) {
        alert('交換部品・項目名を入力してください');
        return;
      }

      try {
        await client.from('maintenance_records').insert({
          machine_id: window.currentMachineIdImplement,
          item_name: itemName,
          operator: operator || null,
          status: status,
          memo: memo || null
        });

        document.getElementById('newMaintenanceItemImplement').value = '';
        document.getElementById('newMaintenanceOperatorImplement').value = '';
        document.getElementById('newMaintenanceStatusImplement').value = 'done';
        document.getElementById('newMaintenanceMemoImplement').value = '';

        loadMaintenanceHistoryImplement(window.currentMachineIdImplement);
        alert('保存しました');
      } catch (e) {
        console.error(e);
        alert('保存に失敗しました');
      }
    }

    // 動力噴霧器メンテナンスリスト読み込み
    async function loadMachineListSprayer() {
      try {
        const { data: machines, error } = await client
          .from("machines")
          .select("*")
          .eq("machine_type", "sprayer")
          .order("id");

        if (error) throw error;

        const container = document.getElementById("maintenanceMachineGridSprayer");
        if (!container) return;
        container.innerHTML = machines.length === 0
          ? "<p class='text-gray-400 text-center py-8'>動力噴霧器が登録されていません</p>"
          : "";

        machines.forEach(m => {
          const card = document.createElement("div");
          card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-all";
          card.innerHTML = `
            <div class="flex items-center gap-3">
              <div style="color: #06b6d4;" class="text-xl flex-shrink-0">
                <i class="fa-solid fa-droplet"></i>
              </div>
              <div class="font-bold text-gray-900 text-sm leading-tight break-words">${m.name}</div>
            </div>
          `;
          container.appendChild(card);
        });
      } catch (e) { console.error("動力噴霧器一覧読み込みエラー:", e); }
    }

    // ラップマシーン一覧読み込み
    async function loadMachineListWrapper() {
      try {
        const { data: machines, error } = await client
          .from("machines")
          .select("*")
          .eq("machine_type", "bale_wrapper")
          .order("id");

        if (error) throw error;

        const container = document.getElementById("maintenanceMachineGridWrapper");
        if (!container) return;
        container.innerHTML = machines.length === 0
          ? "<p class='text-gray-400 text-center py-8'>ラップマシーンが登録されていません</p>"
          : "";

        // sub_type別にグループ化
        const subTypeNames = {
          'self_propelled': '自走式',
          'trailed': '牽引式',
          'other': 'その他'
        };

        const grouped = {};
        machines.forEach(m => {
          const subType = m.sub_type || 'other';
          if (!grouped[subType]) grouped[subType] = [];
          grouped[subType].push(m);
        });

        // sub_type順に表示
        const subTypeOrder = ['self_propelled', 'trailed', 'other'];

        // 定義済みのsub_typeを優先順に表示
        const displayedSubTypes = new Set();
        for (const subType of subTypeOrder) {
          if (!grouped[subType] || grouped[subType].length === 0) continue;
          displayedSubTypes.add(subType);

          const subTypeHeader = document.createElement("h3");
          subTypeHeader.className = "font-bold text-sm mb-2 mt-4 flex items-center gap-2";
          subTypeHeader.style.color = "#6b395f";
          subTypeHeader.innerHTML = `<i class="fa-solid fa-layer-group opacity-50"></i> ${subTypeNames[subType]}`;
          container.appendChild(subTypeHeader);

          const grid = document.createElement("div");
          grid.className = "grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-4";

          for (const m of grouped[subType]) {
            const card = document.createElement("div");
            card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-all active:scale-95";
            card.onclick = () => openMaintenanceDetailWrapper(m.id);

            card.innerHTML = `
              <div class="flex flex-col gap-2">
                <div class="flex items-center gap-3">
                  <div style="color: #6b395f;" class="text-xl flex-shrink-0">
                    <i class="fa-solid fa-tape"></i>
                  </div>
                  <div class="font-bold text-gray-900 text-sm leading-tight break-words">${m.name}</div>
                </div>
                <div class="border-t border-gray-50 pt-2" id="card-progress-wrapper-${m.id}">
                  <div class="text-[11px] text-gray-400 flex items-center gap-1">
                    <i class="fa-solid fa-circle-notch fa-spin text-[9px]"></i> 確認中...
                  </div>
                </div>
              </div>
            `;
            grid.appendChild(card);

            // 進捗状況を非同期で取得して反映
            (async () => {
              try {
                const { data: checks } = await client
                  .from('maintenance_status')
                  .select('item_id, status')
                  .filter('item_id', 'ilike', `${m.id}_%`);

                // sub_typeに応じた項目数を取得
                let itemsQuery = client.from("maintenance_items_bale_wrapper").select("id");
                if (m.sub_type) {
                  itemsQuery = itemsQuery.eq('sub_type', m.sub_type);
                }
                const { data: items } = await itemsQuery;
                const totalItems = items ? items.length : 20;

                const uniqueChecks = {};
                if (checks) {
                  checks.forEach(c => { uniqueChecks[c.item_id] = c.status; });
                }

                const completedCount = Object.values(uniqueChecks).filter(status => status === true || status === "true").length;
                let percent = Math.round((completedCount / totalItems) * 100);
                percent = Math.min(100, percent);

                const progressDiv = document.getElementById(`card-progress-wrapper-${m.id}`);
                if (progressDiv) {
                  let statusHTML = percent === 0
                    ? `<span class="text-red-600 font-black"><i class="fa-solid fa-circle-exclamation text-[9px]"></i> 未着手</span>`
                    : percent === 100
                      ? `<span style="color: #6b395f;" class="font-black"><i class="fa-solid fa-circle-check text-[9px]"></i> 完了</span>`
                      : `<span class="text-orange-500 font-black"><i class="fa-solid fa-spinner text-[9px]"></i> ${percent}% 完了</span>`;

                  progressDiv.innerHTML = `
                    <div class="text-[11px] flex items-center gap-1">${statusHTML}</div>
                    <div class="w-full bg-gray-100 rounded-full h-1 mt-1">
                      <div style="background-color: #6b395f; width: ${percent}%;" class="h-1 rounded-full transition-all duration-500"></div>
                    </div>
                  `;
                }
              } catch (err) { console.error("カード進捗更新エラー:", err); }
            })();
          }
          container.appendChild(grid);
        }

        // 定義されていないsub_typeも表示
        for (const subType of Object.keys(grouped)) {
          if (displayedSubTypes.has(subType)) continue;

          const subTypeHeader = document.createElement("h3");
          subTypeHeader.className = "font-bold text-sm mb-2 mt-4 flex items-center gap-2";
          subTypeHeader.style.color = "#6b395f";
          subTypeHeader.innerHTML = `<i class="fa-solid fa-layer-group opacity-50"></i> ${subTypeNames[subType] || subType}`;
          container.appendChild(subTypeHeader);

          const grid = document.createElement("div");
          grid.className = "grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-4";

          for (const m of grouped[subType]) {
            const card = document.createElement("div");
            card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-all active:scale-95";
            card.onclick = () => openMaintenanceDetailWrapper(m.id);

            card.innerHTML = `
              <div class="flex flex-col gap-2">
                <div class="flex items-center gap-3">
                  <div style="color: #6b395f;" class="text-xl flex-shrink-0">
                    <i class="fa-solid fa-tape"></i>
                  </div>
                  <div class="font-bold text-gray-900 text-sm leading-tight break-words">${m.name}</div>
                </div>
                <div class="border-t border-gray-50 pt-2" id="card-progress-wrapper-${m.id}">
                  <div class="text-[11px] text-gray-400 flex items-center gap-1">
                    <i class="fa-solid fa-circle-notch fa-spin text-[9px]"></i> 確認中...
                  </div>
                </div>
              </div>
            `;
            grid.appendChild(card);

            // 進捗状況を非同期で取得して反映
            (async () => {
              try {
                const { data: checks } = await client
                  .from('maintenance_status')
                  .select('item_id, status')
                  .filter('item_id', 'ilike', `${m.id}_%`);

                // sub_typeに応じた項目数を取得
                let itemsQuery = client.from("maintenance_items_bale_wrapper").select("id");
                if (m.sub_type) {
                  itemsQuery = itemsQuery.eq('sub_type', m.sub_type);
                }
                const { data: items } = await itemsQuery;
                const totalItems = items ? items.length : 20;

                const uniqueChecks = {};
                if (checks) {
                  checks.forEach(c => { uniqueChecks[c.item_id] = c.status; });
                }

                const completedCount = Object.values(uniqueChecks).filter(status => status === true || status === "true").length;
                let percent = Math.round((completedCount / totalItems) * 100);
                percent = Math.min(100, percent);

                const progressDiv = document.getElementById(`card-progress-wrapper-${m.id}`);
                if (progressDiv) {
                  let statusHTML = percent === 0
                    ? `<span class="text-red-600 font-black"><i class="fa-solid fa-circle-exclamation text-[9px]"></i> 未着手</span>`
                    : percent === 100
                      ? `<span style="color: #6b395f;" class="font-black"><i class="fa-solid fa-circle-check text-[9px]"></i> 完了</span>`
                      : `<span class="text-orange-500 font-black"><i class="fa-solid fa-spinner text-[9px]"></i> ${percent}% 完了</span>`;

                  progressDiv.innerHTML = `
                    <div class="text-[11px] flex items-center gap-1">${statusHTML}</div>
                    <div class="w-full bg-gray-100 rounded-full h-1 mt-1">
                      <div style="background-color: #6b395f; width: ${percent}%;" class="h-1 rounded-full transition-all duration-500"></div>
                    </div>
                  `;
                }
              } catch (err) { console.error("カード進捗更新エラー:", err); }
            })();
          }
          container.appendChild(grid);
        }
      } catch (e) { console.error("ラップマシーン一覧読み込みエラー:", e); }
    }

    // ラップマシーンメンテナンス詳細を開く
    async function openMaintenanceDetailWrapper(machineId) {
      window.currentMachineIdWrapper = machineId;
      switchView('maintenanceDetailViewWrapper');

      try {
        const { data: machine } = await client.from("machines").select("*").eq("id", machineId).single();
        document.getElementById("maintenanceMachineNameWrapper").textContent = machine.name;

        const { data: operators } = await client.from('operators').select('name').order('id');
        const opSelect = document.getElementById('newMaintenanceOperatorWrapper');
        if (opSelect && operators) {
          opSelect.innerHTML = '<option value="">担当者を選択</option>';
          operators.forEach(op => {
            const opt = document.createElement('option');
            opt.value = op.name; opt.textContent = op.name;
            opSelect.appendChild(opt);
          });
        }

        loadMaintenanceHistoryWrapper(machineId);

        // sub_typeを取得してフィルタリング
        const subType = machine.sub_type;
        let itemsQuery = client.from("maintenance_items_bale_wrapper").select("*").order("id");

        if (subType) {
          itemsQuery = itemsQuery.eq('sub_type', subType);
        }

        const { data: items, error: itemsError } = await itemsQuery;

        if (itemsError) {
          console.error('メンテナンス項目の取得エラー:', itemsError);
          alert('メンテナンス項目の読み込みに失敗しました。maintenance_items_bale_wrapperテーブルが存在するか確認してください。');
        }

        const checklistContainer = document.getElementById("maintenanceChecklistWrapper");
        if (checklistContainer && items && items.length > 0) {
          checklistContainer.innerHTML = "";
          items.forEach(item => {
            const uniqueId = `${machineId}_${item.id}`;
            const div = document.createElement("div");
            div.className = "flex items-center justify-between p-3 border-b border-gray-50 last:border-0 hover:bg-gray-50 transition-colors";
            div.innerHTML = `
              <div class="flex flex-col flex-1 text-left">
                  <span class="text-sm font-bold text-gray-700">${item.item_name}</span>
                  <span class="text-[10px] text-gray-400">${item.description || ''}</span>
              </div>
              <input type="checkbox" id="${uniqueId}" class="maintenance-check w-6 h-6 rounded border-gray-300"
                     style="accent-color: #6b395f;"
                     onchange="saveSingleCheckWrapper('${machineId}', '${item.id}', this.checked)">
            `;
            checklistContainer.appendChild(div);
          });
        } else if (checklistContainer) {
          checklistContainer.innerHTML = '<p class="text-gray-400 text-center py-4">メンテナンス項目がありません</p>';
        }
        await restoreMaintenanceChecksWrapper();
      } catch (e) { console.error(e); }
    }

    // ラップマシーン進捗表示の更新
    function updateMaintenanceProgressWrapper() {
      const checkboxes = document.querySelectorAll('#maintenanceChecklistWrapper input[type="checkbox"]');
      const total = checkboxes.length;
      if (total === 0) return;
      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
      const percentage = Math.round((checkedCount / total) * 100);
      const summaryDiv = document.getElementById('maintenanceSummaryWrapper');
      if (summaryDiv) {
        summaryDiv.innerHTML = `
          <div class="flex justify-between items-center mb-1">
            <span class="font-bold" style="color: #6b395f;">${percentage}% 完了</span>
            <span class="text-xs text-gray-400">${checkedCount} / ${total} 項目</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="h-2 rounded-full transition-all duration-500" style="width: ${percentage}%; background: #6b395f;"></div>
          </div>
        `;
      }
    }

    // ラップマシーンチェック保存
    async function saveSingleCheckWrapper(machineId, itemId, isChecked) {
      try {
        const itemKey = `${machineId}_${itemId}`;
        const { data: existing } = await client.from('maintenance_status').select('*').eq('item_id', itemKey).maybeSingle();

        if (existing) {
          await client.from('maintenance_status').update({ status: isChecked }).eq('item_id', itemKey);
        } else {
          await client.from('maintenance_status').insert({ item_id: itemKey, status: isChecked });
        }
        updateMaintenanceProgressWrapper();

        // 全項目完了チェック
        await checkAndSaveMaintenanceCompletion(machineId, 'bale_wrapper');
      } catch (e) { console.error("保存エラー:", e); }
    }

    // ラップマシーンチェック復元
    async function restoreMaintenanceChecksWrapper() {
      try {
        const machineId = window.currentMachineIdWrapper;
        const { data: checks } = await client.from('maintenance_status')
          .select('item_id, status')
          .filter('item_id', 'ilike', `${machineId}_%`);

        if (checks) {
          checks.forEach(check => {
            const checkbox = document.getElementById(check.item_id);
            if (checkbox) {
              checkbox.checked = (check.status === true || check.status === "true");
            }
          });
        }
        updateMaintenanceProgressWrapper();
      } catch (e) { console.error("チェック復元エラー:", e); }
    }

    // ラップマシーン履歴読み込み
    async function loadMaintenanceHistoryWrapper(machineId) {
      try {
        const { data: records } = await client
          .from('maintenance_logs_bale_wrapper')
          .select('*')
          .eq('machine_id', machineId)
          .order('created_at', { ascending: false })
          .limit(10);

        const logContainer = document.getElementById('maintenanceHistoryLogWrapper');
        if (!logContainer) return;

        if (!records || records.length === 0) {
          logContainer.innerHTML = '<p class="italic text-gray-400 text-center py-4">履歴はありません</p>';
          return;
        }

        logContainer.innerHTML = records.map(rec => {
          const date = new Date(rec.created_at).toLocaleDateString('ja-JP');
          return `
          <div class="border-b border-gray-100 pb-2 mb-2 last:border-0 text-left">
            <div class="flex justify-between font-bold text-gray-700"><span>${rec.item_name}</span><span class="text-gray-400 text-[9px]">${date}</span></div>
            <div class="text-gray-500">担当: ${rec.operator}</div>
            ${rec.memo ? `<div class="text-gray-400 italic">"${rec.memo}"</div>` : ''}
          </div>
        `}).join('');
      } catch (e) {
        console.error('履歴読み込みエラー:', e);
      }
    }

    // ラップマシーン記録保存
    async function saveMaintenanceRecordWrapper() {
      const itemName = document.getElementById('newMaintenanceItemWrapper').value;
      const operator = document.getElementById('newMaintenanceOperatorWrapper').value;
      const status = document.getElementById('newMaintenanceStatusWrapper').value;
      const memo = document.getElementById('newMaintenanceMemoWrapper').value;

      if (!itemName) {
        alert('交換部品・項目名を入力してください');
        return;
      }

      try {
        await client.from('maintenance_logs_bale_wrapper').insert({
          machine_id: window.currentMachineIdWrapper,
          item_name: itemName,
          operator: operator || null,
          status: status,
          memo: memo || null,
          created_at: new Date().toISOString()
        });

        document.getElementById('newMaintenanceItemWrapper').value = '';
        document.getElementById('newMaintenanceOperatorWrapper').value = '';
        document.getElementById('newMaintenanceStatusWrapper').value = 'done';
        document.getElementById('newMaintenanceMemoWrapper').value = '';

        loadMaintenanceHistoryWrapper(window.currentMachineIdWrapper);
        alert('保存しました');
      } catch (e) {
        console.error(e);
        alert('保存に失敗しました');
      }
    }

    // スパイダーモアメンテナンス詳細を開く
    async function openMaintenanceDetailSpiderMower(machineId) {
      window.currentMachineIdSpiderMower = machineId;
      switchView('maintenanceDetailViewSpiderMower');

      try {
        const { data: machine } = await client.from("machines").select("*").eq("id", machineId).single();
        document.getElementById("maintenanceMachineNameSpiderMower").textContent = machine.name;

        const { data: operators } = await client.from('operators').select('name').order('id');
        const opSelect = document.getElementById('newMaintenanceOperatorSpiderMower');
        if (opSelect && operators) {
          opSelect.innerHTML = '<option value="">担当者を選択</option>';
          operators.forEach(op => {
            const opt = document.createElement('option');
            opt.value = op.name; opt.textContent = op.name;
            opSelect.appendChild(opt);
          });
        }

        loadMaintenanceHistorySpiderMower(machineId);
        const { data: items } = await client.from("maintenance_items_spider_mower").select("*").order("id");
        const checklistContainer = document.getElementById("maintenanceChecklistSpiderMower");
        if (checklistContainer && items) {
          checklistContainer.innerHTML = "";
          items.forEach(item => {
            const uniqueId = `${machineId}_${item.id}`;
            const div = document.createElement("div");
            div.className = "flex items-center justify-between p-3 border-b border-gray-50 last:border-0 hover:bg-gray-50 transition-colors";
            div.innerHTML = `
              <div class="flex flex-col flex-1 text-left">
                  <span class="text-sm font-bold text-gray-700">${item.item_name}</span>
                  <span class="text-[10px] text-gray-400">${item.description || ''}</span>
              </div>
              <input type="checkbox" id="${uniqueId}" class="maintenance-check w-6 h-6 rounded border-gray-300"
                     style="accent-color: #666633;"
                     onchange="saveSingleCheckSpiderMower('${machineId}', '${item.id}', this.checked)">
            `;
            checklistContainer.appendChild(div);
          });
        }
        await restoreMaintenanceChecksSpiderMower();
      } catch (e) { console.error(e); }
    }

    // スパイダーモア進捗表示の更新
    function updateMaintenanceProgressSpiderMower() {
      const checkboxes = document.querySelectorAll('#maintenanceChecklistSpiderMower input[type="checkbox"]');
      const total = checkboxes.length;
      if (total === 0) return;
      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
      const percentage = Math.round((checkedCount / total) * 100);
      const summaryDiv = document.getElementById('maintenanceSummarySpiderMower');
      if (summaryDiv) {
        summaryDiv.innerHTML = `
          <div class="flex justify-between items-center mb-1">
            <span class="font-bold" style="color: #666633;">${percentage}% 完了</span>
            <span class="text-xs text-gray-400">${checkedCount} / ${total} 項目</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="h-2 rounded-full transition-all duration-500" style="width: ${percentage}%; background: #666633;"></div>
          </div>
        `;
      }
    }

    // スパイダーモアチェック保存
    async function saveSingleCheckSpiderMower(machineId, itemId, isChecked) {
      try {
        const uniqueId = `${machineId}_${itemId}`;
        await client.from('maintenance_status').upsert({
          item_id: uniqueId, status: Boolean(isChecked), updated_at: new Date()
        }, { onConflict: 'item_id' });
        updateMaintenanceProgressSpiderMower();
        loadMachineListSpiderMower();

        // 全項目完了チェック
        await checkAndSaveMaintenanceCompletion(machineId, 'spider_mower');
      } catch (e) { console.error(e); }
    }

    // スパイダーモアチェック復元
    async function restoreMaintenanceChecksSpiderMower() {
      try {
        const { data } = await client.from('maintenance_status').select('item_id, status');
        if (data) {
          data.forEach(row => {
            const el = document.getElementById(row.item_id);
            if (el) el.checked = row.status;
          });
        }
        updateMaintenanceProgressSpiderMower();
      } catch (e) { console.error(e); }
    }

    // スパイダーモア履歴読み込み
    async function loadMaintenanceHistorySpiderMower(machineId) {
      try {
        const { data } = await client.from('maintenance_records').select('*').eq('machine_id', machineId).order('created_at', { ascending: false });
        const container = document.getElementById('maintenanceHistoryLogSpiderMower');
        if (!container) return;
        if (!data || data.length === 0) {
          container.innerHTML = '<p class="italic text-gray-400 text-center py-4">履歴はありません</p>';
          return;
        }
        container.innerHTML = data.map(rec => `
          <div class="border-b border-gray-100 pb-2 mb-2 last:border-0 text-left">
            <div class="flex justify-between font-bold text-gray-700"><span>${rec.item_name}</span><span class="text-gray-400 text-[9px]">${rec.date}</span></div>
            <div class="text-gray-500">担当: ${rec.operator}</div>
            ${rec.memo ? `<div class="text-gray-400 italic">"${rec.memo}"</div>` : ''}
          </div>`).join('');
      } catch (e) { console.error(e); }
    }

    // スパイダーモア部品交換記録保存
    async function saveMaintenanceRecordSpiderMower() {
      const itemName = document.getElementById('newMaintenanceItemSpiderMower').value;
      const operator = document.getElementById('newMaintenanceOperatorSpiderMower').value;
      const status = document.getElementById('newMaintenanceStatusSpiderMower').value;
      const memo = document.getElementById('newMaintenanceMemoSpiderMower').value;

      if (!itemName || !operator) {
        alert('項目名と担当者を入力してください');
        return;
      }

      try {
        await client.from('maintenance_records').insert({
          machine_id: window.currentMachineIdSpiderMower,
          item_name: itemName,
          operator: operator,
          status: status,
          memo: memo,
          date: new Date().toISOString().split('T')[0]
        });

        document.getElementById('newMaintenanceItemSpiderMower').value = '';
        document.getElementById('newMaintenanceMemoSpiderMower').value = '';
        loadMaintenanceHistorySpiderMower(window.currentMachineIdSpiderMower);
        alert('保存しました');
      } catch (e) {
        console.error(e);
        alert('保存に失敗しました');
      }
    }

    // ウイングモアメンテナンス詳細を開く
    async function openMaintenanceDetailWingMower(machineId) {
      window.currentMachineIdWingMower = machineId;
      switchView('maintenanceDetailViewWingMower');

      try {
        const { data: machine } = await client.from("machines").select("*").eq("id", machineId).single();
        document.getElementById("maintenanceMachineNameWingMower").textContent = machine.name;

        const { data: operators } = await client.from('operators').select('name').order('id');
        const opSelect = document.getElementById('newMaintenanceOperatorWingMower');
        if (opSelect && operators) {
          opSelect.innerHTML = '<option value="">担当者を選択</option>';
          operators.forEach(op => {
            const opt = document.createElement('option');
            opt.value = op.name; opt.textContent = op.name;
            opSelect.appendChild(opt);
          });
        }

        loadMaintenanceHistoryWingMower(machineId);
        const { data: items } = await client.from("maintenance_items_wing_mower").select("*").order("id");
        const checklistContainer = document.getElementById("maintenanceChecklistWingMower");
        if (checklistContainer && items) {
          checklistContainer.innerHTML = "";
          items.forEach(item => {
            const uniqueId = `${machineId}_${item.id}`;
            const div = document.createElement("div");
            div.className = "flex items-center justify-between p-3 border-b border-gray-50 last:border-0 hover:bg-gray-50 transition-colors";
            div.innerHTML = `
              <div class="flex flex-col flex-1 text-left">
                  <span class="text-sm font-bold text-gray-700">${item.item_name}</span>
                  <span class="text-[10px] text-gray-400">${item.description || ''}</span>
              </div>
              <input type="checkbox" id="${uniqueId}" class="maintenance-check w-6 h-6 rounded border-gray-300"
                     style="accent-color: #666633;"
                     onchange="saveSingleCheckWingMower('${machineId}', '${item.id}', this.checked)">
            `;
            checklistContainer.appendChild(div);
          });
        }
        await restoreMaintenanceChecksWingMower();
      } catch (e) { console.error(e); }
    }

    // ウイングモア進捗表示の更新
    function updateMaintenanceProgressWingMower() {
      const checkboxes = document.querySelectorAll('#maintenanceChecklistWingMower input[type="checkbox"]');
      const total = checkboxes.length;
      if (total === 0) return;
      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
      const percentage = Math.round((checkedCount / total) * 100);
      const summaryDiv = document.getElementById('maintenanceSummaryWingMower');
      if (summaryDiv) {
        summaryDiv.innerHTML = `
          <div class="flex justify-between items-center mb-1">
            <span class="font-bold" style="color: #666633;">${percentage}% 完了</span>
            <span class="text-xs text-gray-400">${checkedCount} / ${total} 項目</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="h-2 rounded-full transition-all duration-500" style="width: ${percentage}%; background: #666633;"></div>
          </div>
        `;
      }
    }

    // ウイングモアチェック保存
    async function saveSingleCheckWingMower(machineId, itemId, isChecked) {
      try {
        const uniqueId = `${machineId}_${itemId}`;
        await client.from('maintenance_status').upsert({
          item_id: uniqueId, status: Boolean(isChecked), updated_at: new Date()
        }, { onConflict: 'item_id' });
        updateMaintenanceProgressWingMower();
        loadMachineListWingMower();

        // 全項目完了チェック
        await checkAndSaveMaintenanceCompletion(machineId, 'wing_mower');
      } catch (e) { console.error(e); }
    }

    // ウイングモアチェック復元
    async function restoreMaintenanceChecksWingMower() {
      try {
        const { data } = await client.from('maintenance_status').select('item_id, status');
        if (data) {
          data.forEach(row => {
            const el = document.getElementById(row.item_id);
            if (el) el.checked = row.status;
          });
        }
        updateMaintenanceProgressWingMower();
      } catch (e) { console.error(e); }
    }

    // ウイングモア履歴読み込み
    async function loadMaintenanceHistoryWingMower(machineId) {
      try {
        const { data } = await client.from('maintenance_records').select('*').eq('machine_id', machineId).order('created_at', { ascending: false });
        const container = document.getElementById('maintenanceHistoryLogWingMower');
        if (!container) return;
        if (!data || data.length === 0) {
          container.innerHTML = '<p class="italic text-gray-400 text-center py-4">履歴はありません</p>';
          return;
        }
        container.innerHTML = data.map(rec => `
          <div class="border-b border-gray-100 pb-2 mb-2 last:border-0 text-left">
            <div class="flex justify-between font-bold text-gray-700"><span>${rec.item_name}</span><span class="text-gray-400 text-[9px]">${rec.date}</span></div>
            <div class="text-gray-500">担当: ${rec.operator}</div>
            ${rec.memo ? `<div class="text-gray-400 italic">"${rec.memo}"</div>` : ''}
          </div>`).join('');
      } catch (e) { console.error(e); }
    }

    // ウイングモア部品交換記録保存
    async function saveMaintenanceRecordWingMower() {
      const itemName = document.getElementById('newMaintenanceItemWingMower').value;
      const operator = document.getElementById('newMaintenanceOperatorWingMower').value;
      const status = document.getElementById('newMaintenanceStatusWingMower').value;
      const memo = document.getElementById('newMaintenanceMemoWingMower').value;

      if (!itemName || !operator) {
        alert('項目名と担当者を入力してください');
        return;
      }

      try {
        await client.from('maintenance_records').insert({
          machine_id: window.currentMachineIdWingMower,
          item_name: itemName,
          operator: operator,
          status: status,
          memo: memo,
          date: new Date().toISOString().split('T')[0]
        });

        document.getElementById('newMaintenanceItemWingMower').value = '';
        document.getElementById('newMaintenanceMemoWingMower').value = '';
        loadMaintenanceHistoryWingMower(window.currentMachineIdWingMower);
        alert('保存しました');
      } catch (e) {
        console.error(e);
        alert('保存に失敗しました');
      }
    }



    // 1. メンテナンス一覧（トラクター一覧）を表示する
    async function loadMachineList() {
      try {
        const { data: machines, error } = await client
          .from("machines")
          .select("*")
          .eq("machine_type", "tractor")
          .order("id");

        if (error) throw error;

        const container = document.getElementById("maintenanceMachineGrid");
        if (!container) return;
        container.innerHTML = "";

        const grouped = {};
        machines.forEach(m => {
          const manufacturer = m.manufacturer || "その他";
          if (!grouped[manufacturer]) grouped[manufacturer] = [];
          grouped[manufacturer].push(m);
        });

        for (const brand of Object.keys(grouped)) {
          const brandHeader = document.createElement("h3");
          brandHeader.className = "text-[#6b8f71] font-bold text-sm mb-2 mt-4 flex items-center gap-2";
          brandHeader.innerHTML = `<i class="fa-solid fa-tag opacity-50"></i> ${brand}`;
          container.appendChild(brandHeader);

          const grid = document.createElement("div");
          grid.className = "grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-4";

          // 各マシンのカードを作成
          for (const m of grouped[brand]) {
            const card = document.createElement("div");
            card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-all active:scale-95";
            card.onclick = () => openMaintenanceDetail(m.id);

            card.innerHTML = `
              <div class="flex flex-col gap-2">
                <div class="flex items-center gap-3">
                  <div style="color: var(--tractor-color);" class="text-xl flex-shrink-0">
                    <i class="fa-solid fa-tractor"></i>
                  </div>
                  <div class="font-bold text-gray-900 text-sm leading-tight break-words">${m.name}</div>
                </div>
                <div class="border-t border-gray-50 pt-2" id="card-progress-${m.id}">
                  <div class="text-[11px] text-gray-400 flex items-center gap-1">
                    <i class="fa-solid fa-circle-notch fa-spin text-[9px]"></i> 確認中...
                  </div>
                </div>
              </div>
            `;
            grid.appendChild(card);

            // 進捗状況を非同期で取得して反映
            (async () => {
              try {
                const { data: checks } = await client
                  .from('maintenance_status')
                  .select('item_id, status')
                  .filter('item_id', 'ilike', `${m.id}_%`);

                const totalItems = 20;
                const uniqueChecks = {};
                if (checks) {
                  checks.forEach(c => { uniqueChecks[c.item_id] = c.status; });
                }

                const completedCount = Object.values(uniqueChecks).filter(status => status === true || status === "true").length;
                let percent = Math.round((completedCount / totalItems) * 100);
                percent = Math.min(100, percent);

                const progressDiv = document.getElementById(`card-progress-${m.id}`);
                if (progressDiv) {
                  let statusHTML = percent === 0
                    ? `<span class="text-red-600 font-black"><i class="fa-solid fa-circle-exclamation text-[9px]"></i> 未着手</span>`
                    : percent === 100
                      ? `<span class="text-[#6b8f71] font-black"><i class="fa-solid fa-circle-check text-[9px]"></i> 完了</span>`
                      : `<span class="text-orange-500 font-black"><i class="fa-solid fa-spinner text-[9px]"></i> ${percent}% 完了</span>`;

                  progressDiv.innerHTML = `
                    <div class="text-[11px] flex items-center gap-1">${statusHTML}</div>
                    <div class="w-full bg-gray-100 rounded-full h-1 mt-1">
                      <div class="bg-[#6b8f71] h-1 rounded-full transition-all duration-500" style="width: ${percent}%"></div>
                    </div>
                  `;
                }
              } catch (err) { console.error("カード進捗更新エラー:", err); }
            })();
          }
          container.appendChild(grid);
        }
      } catch (e) { console.error("一覧読み込みエラー:", e); }
    }
    async function loadMaintenanceLogs() {
      const logContainer = document.getElementById('maintenanceLog');
      if (!logContainer) return;

      try {
        // 1. トラクターの機械IDを取得
        const { data: tractorMachines, error: tractorError } = await client
          .from('machines')
          .select('id, name')
          .eq('machine_type', 'tractor');

        if (tractorError) throw tractorError;
        if (!tractorMachines || tractorMachines.length === 0) {
          logContainer.innerHTML = `<p class="italic text-gray-400 text-center py-4">トラクターが登録されていません</p>`;
          return;
        }

        const tractorIds = tractorMachines.map(m => m.id);
        const tractorMap = {};
        tractorMachines.forEach(m => { tractorMap[m.id.toString()] = m.name; });

        // 2. トラクターのメンテナンス状態のみを取得
        const { data: allStatus, error: statusError } = await client
          .from('maintenance_status')
          .select('item_id, status, updated_at');

        if (statusError) throw statusError;

        // 3. 機械ごとに「全項目数」と「完了数」をカウント（トラクターのみ）
        const machineProgress = {};
        allStatus.forEach(item => {
          const mId = parseInt(item.item_id.split('_')[0]);
          // トラクターIDに含まれているもののみ処理
          if (!tractorIds.includes(mId)) return;

          if (!machineProgress[mId]) {
            machineProgress[mId] = { total: 0, completed: 0, lastUpdate: item.updated_at };
          }
          machineProgress[mId].total++;
          if (item.status) {
            machineProgress[mId].completed++;
            // 一番新しい完了日時を保持
            if (new Date(item.updated_at) > new Date(machineProgress[mId].lastUpdate)) {
              machineProgress[mId].lastUpdate = item.updated_at;
            }
          }
        });

        // 4. 判定ロジック（トラクターで完了したもののみ）
        const finishedMachineIds = Object.keys(machineProgress).filter(mId => {
          const p = machineProgress[mId];
          // 1つ以上項目があり、かつ（完了数 ＝ 項目数）であること
          // かつ、特定の「少なすぎるデータ（テスト用）」を除外するために 3項目以上 とする
          return p.total >= 3 && p.completed === p.total;
        });

        if (finishedMachineIds.length === 0) {
          logContainer.innerHTML = `<p class="italic text-gray-400 text-center py-4">完了したメンテナンスはありません</p>`;
          return;
        }

        // 5. 完了した機械を最新順に並べて表示
        const displayData = finishedMachineIds
          .map(mId => ({
            id: mId,
            name: tractorMap[mId] || `トラクター(ID:${mId})`,
            date: machineProgress[mId].lastUpdate
          }))
          .sort((a, b) => new Date(b.date) - new Date(a.date));

        logContainer.innerHTML = displayData.map(data => {
          const date = new Date(data.date);
          const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;

          return `
        <div class="flex items-center justify-between border-b border-gray-50 py-3 last:border-0">
          <div class="flex flex-col">
            <span class="text-[13px] font-black text-gray-800">${data.name}</span>
            <div class="flex items-center gap-1">
              <span class="w-2 h-2 rounded-full bg-[#6b8f71] flex items-center justify-center">
                <i class="fa-solid fa-check text-[5px] text-white"></i>
              </span>
              <span class="text-[10px] text-[#6b8f71] font-bold tracking-wider">ALL MAINTENANCE COMPLETE</span>
            </div>
          </div>
          <div class="text-right">
            <div class="text-[11px] text-gray-500 font-mono font-bold">${dateStr}</div>
          </div>
        </div>
      `;
        }).join('');

      } catch (err) {
        console.error('履歴取得エラー:', err);
        logContainer.innerHTML = `<p class="text-red-400 text-center py-4">データ取得失敗</p>`;
      }
    }

    // 2. 詳細画面を開く
    async function openMaintenanceDetail(machineId) {
      window.currentMachineId = machineId;
      switchView('maintenanceDetailView');

      try {
        const { data: machine } = await client.from("machines").select("*").eq("id", machineId).single();
        document.getElementById("maintenanceMachineName").textContent = machine.name;

        const { data: operators } = await client.from('operators').select('name').order('id');
        const opSelect = document.getElementById('newMaintenanceOperator');
        if (opSelect && operators) {
          opSelect.innerHTML = '<option value="">担当者を選択</option>';
          operators.forEach(op => {
            const opt = document.createElement('option');
            opt.value = op.name; opt.textContent = op.name;
            opSelect.appendChild(opt);
          });
        }

        loadMaintenanceHistory(machineId);
        const { data: items } = await client.from("maintenance_items_tractor").select("*").order("id");
        const checklistContainer = document.getElementById("maintenanceChecklist");
        if (checklistContainer && items) {
          checklistContainer.innerHTML = "";
          items.forEach(item => {
            const uniqueId = `${machineId}_${item.id}`;
            const div = document.createElement("div");
            div.className = "flex items-center justify-between p-3 border-b border-gray-50 last:border-0 hover:bg-gray-50 transition-colors";
            div.innerHTML = `
              <div class="flex flex-col flex-1 text-left">
                  <span class="text-sm font-bold text-gray-700">${item.item_name}</span>
                  <span class="text-[10px] text-gray-400">${item.description || ''}</span>
              </div>
              <input type="checkbox" id="${uniqueId}" class="maintenance-check w-6 h-6 rounded border-gray-300" style="accent-color: #6b8f71;"
                     onchange="saveSingleCheck('${machineId}', '${item.id}', this.checked)">
            `;
            checklistContainer.appendChild(div);
          });
        }
        await restoreMaintenanceChecks();
      } catch (e) { console.error(e); }
    }

    // 3. 進捗表示の更新
    function updateMaintenanceProgress() {
      const checkboxes = document.querySelectorAll('#maintenanceChecklist input[type="checkbox"]');
      const total = checkboxes.length;
      if (total === 0) return;
      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
      const percentage = Math.round((checkedCount / total) * 100);
      const summaryDiv = document.getElementById('maintenanceSummary');
      if (summaryDiv) {
        summaryDiv.innerHTML = `
          <div class="flex justify-between items-center mb-1">
            <span class="font-bold" style="color: #6b8f71;">${percentage}% 完了</span>
            <span class="text-xs text-gray-400">${checkedCount} / ${total} 項目</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="h-2 rounded-full transition-all duration-500" style="width: ${percentage}%; background: #6b8f71;"></div>
          </div>
        `;
      }
    }

    // 4. 保存
    async function saveSingleCheck(machineId, itemId, isChecked) {
      try {
        const uniqueId = `${machineId}_${itemId}`;
        await client.from('maintenance_status').upsert({
          item_id: uniqueId, status: Boolean(isChecked), updated_at: new Date()
        }, { onConflict: 'item_id' });
        updateMaintenanceProgress();
        loadMachineList();

        // 全項目完了チェック
        await checkAndSaveMaintenanceCompletion(machineId, 'tractor');
      } catch (e) { console.error(e); }
    }

    // 5. 復元
    async function restoreMaintenanceChecks() {
      try {
        const { data } = await client.from('maintenance_status').select('item_id, status');
        if (data) {
          data.forEach(row => {
            const el = document.getElementById(row.item_id);
            if (el) el.checked = row.status;
          });
        }
        updateMaintenanceProgress();
      } catch (e) { console.error(e); }
    }

    async function loadMaintenanceHistory(machineId) {
      try {
        const { data } = await client.from('maintenance_records').select('*').eq('machine_id', machineId).order('created_at', { ascending: false });
        const container = document.getElementById('maintenanceHistoryLog');
        if (!container) return;
        if (!data || data.length === 0) {
          container.innerHTML = '<p class="italic text-gray-400 text-center py-4">履歴はありません</p>';
          return;
        }
        container.innerHTML = data.map(rec => `
          <div class="border-b border-gray-100 pb-2 mb-2 last:border-0 text-left">
            <div class="flex justify-between font-bold text-gray-700"><span>${rec.item_name}</span><span class="text-gray-400 text-[9px]">${rec.date}</span></div>
            <div class="text-gray-500">担当: ${rec.operator}</div>
            ${rec.memo ? `<div class="text-gray-400 italic">"${rec.memo}"</div>` : ''}
          </div>`).join('');
      } catch (e) { console.error(e); }
    }

    // ==========================================
    // 2. 実務をこなす関数たち
    // ==========================================

    // --- ダッシュボード全体を制御する関数 ---
    async function renderDashboard(machineId = 'all') {
      const machineTabs = document.getElementById("machineTabs");
      if (!machineTabs) return;

      window.currentViewMachineId = machineId;
      console.log("🛠️ ダッシュボード描画中... ID:", machineId);
      const currentId = machineId;
      const allBtnClass = (currentId === 'all') ? 'active' : 'inactive';

      let tabsHTML = `
      <button onclick="renderDashboard('all')" 
              class="tab-btn ${allBtnClass}" 
              style="min-width: 80px; letter-spacing: 0.2em;">全 体</button>
    `;

      if (typeof allMachines !== 'undefined' && allMachines.length > 0) {
        tabsHTML += allMachines.map(m => {
          const isActive = (String(m.id) === String(currentId)) ? 'active' : 'inactive';
          return `
          <button onclick="renderDashboard(${m.id})" 
                  class="tab-btn ${isActive}">${m.name}</button>
        `;
        }).join("");
      }
      machineTabs.innerHTML = tabsHTML;


      try {
        // 1. まずベースのクエリを作る（2026年以降＋日付順）
        let query = client
          .from("hour_logs")
          .select("*")
          .gte("date", "2026-01-01")
          .order("date", { ascending: false });

        // 2. 「すべて」以外が選ばれている場合だけ、さらにマシンIDで絞り込む
        if (machineId !== 'all') {
          query = query.eq("machine_id", machineId);
        }

        const { data, error } = await query;
        if (error) throw error;

        // もしデータが0件なら「データなし」と表示して終わる（エラーで止めない）
        if (!data || data.length === 0) {
          console.warn("⚠️ 2026年のデータが見つかりません");
          const rankingContainer = document.getElementById("rankList");
          if (rankingContainer) rankingContainer.innerHTML = "データなし";
          return;
        }

        // 集計
        const summary = {};
        data.forEach(log => {
          let name = "不明";
          if (typeof allMachines !== 'undefined') {
            const m = allMachines.find(item => String(item.id) === String(log.machine_id));
            if (m) name = m.name;
          }
          const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
          summary[name] = (summary[name] || 0) + (h > 0 ? h : 0);
        });

        // ランキング表示（上位3位）
        const sorted = Object.entries(summary).sort((a, b) => b[1] - a[1]);
        const rankingContainer = document.getElementById("rankList");
        if (rankingContainer) {
          const crownColors = ['text-yellow-500', 'text-gray-400', 'text-amber-600'];
          rankingContainer.innerHTML = sorted.slice(0, 3).map(([name, hours], i) => `
            <div class="flex flex-col items-center px-1 text-center" style="min-width: 75px;">
              <div class="mb-1"><i class="fa-solid fa-crown ${crownColors[i]} text-xl"></i></div>
              <span class="text-[10px] font-bold text-gray-700 truncate w-20 leading-tight">${name}</span>
            </div>
          `).join('');
        }

        // --- KPIカードの集計と反映 ---
        if (data) {
          let totalH = 0;
          let totalF = 0;
          const daysSet = new Set();

          data.forEach(log => {
            // 稼働時間の計算
            const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
            totalH += (h > 0 ? h : 0);

            // ✅ 給油量を fuel_amount から取得
            totalF += (parseFloat(log.fuel_amount) || 0);

            // 作業日数のカウント
            if (log.date) daysSet.add(log.date);
          });

          // 燃費計算 (給油合計 ÷ 稼働時間合計)
          const fuelAvg = totalH > 0 ? (totalF / totalH).toFixed(2) : "0.00";

          // HTML要素への反映
          const elH = document.getElementById("kpi-hours");
          const elF = document.getElementById("kpi-fuel");
          const elA = document.getElementById("kpi-avg");
          const elD = document.getElementById("kpi-days");

          if (elH) elH.innerText = totalH.toFixed(1);
          if (elF) elF.innerText = totalF.toFixed(1);
          if (elA) elA.innerText = fuelAvg;
          if (elD) elD.innerText = daysSet.size;

          console.log("✅ KPI更新完了 (fuel_amount使用):", { totalH, totalF, fuelAvg });
        }

        if (typeof drawCharts === 'function') {
          drawCharts(data);
        }

      } catch (e) {
        console.error("❌ ダッシュボード描画エラー:", e);
      }
    }

    async function saveMaintenanceRecord() {
      const item = document.getElementById('newMaintenanceItem')?.value;
      const operator = document.getElementById('newMaintenanceOperator')?.value;
      const status = document.getElementById('newMaintenanceStatus')?.value;
      const memo = document.getElementById('newMaintenanceMemo')?.value;

      // window.currentMachineId を明示的に数値として取得する
      let mId = window.currentMachineId;
      const numericMachineId = parseInt(mId);

      // 数値じゃない（"all"や空っぽ）場合はエラーを出す
      if (isNaN(numericMachineId)) {
        showModal("エラー", "機械の情報を読み取れませんでした。一度一覧に戻って選び直してください🌸");
        return;
      }

      if (!item) {
        showModal("入力エラー", "交換部品・項目名を入力してくださいね🌸");
        return;
      }

      try {
        const { error } = await client.from('maintenance_records').insert([
          {
            item_name: item,
            operator: operator,
            status: status,
            memo: memo,
            date: new Date().toISOString().split('T')[0],
            machine_id: numericMachineId // ここで数値を使う
          }
        ]);

        if (error) throw error;

        showModal("保存完了", "メンテナンス情報を記録しました！✨");

        // 入力欄をクリア
        document.getElementById('newMaintenanceItem').value = '';
        document.getElementById('newMaintenanceMemo').value = '';

        // 履歴の表示を更新（この関数がある場合）
        if (typeof loadMaintenanceHistory === 'function') {
          loadMaintenanceHistory(numericMachineId);
        }

      } catch (err) {
        console.error("Maint Save Error:", err);
        showModal("保存エラー", "保存に失敗しました: " + (err.message || JSON.stringify(err)));
      }
    }

    async function saveLog() {
      const machineId = document.getElementById('machineSelect')?.value;
      const workDate = document.getElementById('workDate')?.value;
      const operator = document.getElementById('operator')?.value;
      const category = document.getElementById('category')?.value;
      const workName = document.getElementById('work_name')?.value;
      const hourBefore = parseFloat(document.getElementById('hourBefore')?.value) || 0;
      const hourAfter = parseFloat(document.getElementById('hourAfter')?.value) || 0;
      const fuelType = document.getElementById('fuelType')?.value;
      const fuel = parseFloat(document.getElementById('fuelAmount')?.value) || 0;
      const memo = document.getElementById('memoInput')?.value;

      // バリデーション（入力チェック）
      if (!machineId) return showModal("入力エラー", "機械を選択してください");
      if (!workDate || !workName) return showModal("入力エラー", "「作業日」「作業内容」は必須項目です");
      if (hourAfter < hourBefore) return showModal("入力エラー", "稼働後の数値が稼働前より小さくなっています。");

      showModal("登録確認", "ログを登録しますか？", async () => {
        try {
          const logData = {
            date: workDate,
            operator: operator,
            machine_id: parseInt(machineId),
            start_hour: hourBefore,
            end_hour: hourAfter,
            category: category,
            task: workName,
            fuel_type_id: fuelType ? parseInt(fuelType) : null,
            fuel_amount: fuel,
            memo: memo,
            created_at: new Date().toISOString()
          };

          const result = await saveData('hour_logs', logData, 'hour_logs');

          const message = result.offline ?
            "稼働ログをローカルに保存しました\n（オンライン時に自動同期されます）" :
            "稼働ログを保存しました";

          showModal("保存完了", message, () => {
            localStorage.setItem('currentView', 'tractorView');
            location.reload();
          });

        } catch (err) {
          console.error("Log Save Error:", err);
          showModal("保存エラー", "保存に失敗しました: " + (err.message));
        }
      });
    }

    // --- Google Vision APIを使って画像から数字を読み取る関数 ---
    async function performOCR(base64Image) {
      const url = `https://vision.googleapis.com/v1/images:annotate?key=${GOOGLE_VISION_API_KEY}`;

      const requestData = {
        requests: [{
          image: { content: base64Image },
          features: [{ type: "TEXT_DETECTION" }]
        }]
      };

      try {
        const response = await fetch(url, {
          method: "POST",
          body: JSON.stringify(requestData)
        });
        const result = await response.json();

        // 読み取った全テキストを結合
        const detections = result.responses[0].textAnnotations;
        if (!detections || detections.length === 0) return null;

        const fullText = detections[0].description;
        console.log("🔍 OCR読み取り結果:", fullText);

        // テキストから「数字（小数点含む）」だけを抽出する（例: "123.4"）
        const match = fullText.match(/\d+(\.\d+)?/);
        return match ? match[0] : null;
      } catch (err) {
        console.error("❌ OCRエラー:", err);
        return null;
      }
    }

    // ハンドラ：稼働後の数値を画像から読み取る
    async function handleHourAfterImage(input) {
      const file = input.files[0];
      if (!file) return;

      try {
        const base64Image = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.readAsDataURL(file);
        });

        // OCR 実行
        const text = await performOCR(base64Image);
        if (!text) return showModal('読み取り失敗', '読み取りに失敗しました。写真を変えて再試行してください。');

        // 数字（小数点含む）を抽出して input に反映
        const m = text.match(/\d+(?:\.\d+)?/);
        if (m) {
          document.getElementById('hourAfter').value = m[0];
          calcDiff();
        } else {
          showModal('検出失敗', '数字が検出されませんでした。読み取り結果:\n' + (text.substring(0, 200) || '-----'));
        }
      } catch (err) {
        console.error('HourAfter OCR error', err);
        showModal('エラー', '読み取り中にエラーが発生しました');
      } finally {
        // ファイル入力をクリアして同じ画像を再選択できるようにする
        input.value = '';
      }
    }

    // ========== 田植え機用の関数 ==========
    async function initTauePage() {
      // 田植え機の機械リストを取得
      const { data: taueMachines } = await client
        .from("machines")
        .select("*")
        .eq("machine_type", "transplanter")
        .order("name");

      // オペレーター取得
      const { data: operators } = await client
        .from("operators")
        .select("*")
        .order("id");

      // 油種取得
      const { data: fuelTypes } = await client
        .from("fuel_types")
        .select("*");

      // 作業内容取得（category = '田植え'）
      const { data: workTypes, error: workTypesError } = await client
        .from("work_types")
        .select("*")
        .eq("category", "田植え");

      console.log("田植え機 作業内容データ:", workTypes);
      console.log("田植え機 作業内容エラー:", workTypesError);
      if (workTypes && workTypes.length > 0) {
        console.log("最初のデータのキー:", Object.keys(workTypes[0]));
      }

      // 機械選択
      const taue_machineSelect = document.getElementById("taue_machineSelect");
      if (taue_machineSelect) {
        taue_machineSelect.innerHTML = '<option value="">選択</option>' +
          (taueMachines || []).map(m => `<option value="${m.id}">${m.name}</option>`).join("");
      }

      // オペレーター選択
      const taue_operator = document.getElementById("taue_operator");
      if (taue_operator) {
        taue_operator.innerHTML = '<option value="">選択</option>' +
          (operators || []).map(o => `<option value="${o.id}">${o.name}</option>`).join("");
      }

      // 油種選択
      const taue_fuelType = document.getElementById("taue_fuelType");
      if (taue_fuelType) {
        taue_fuelType.innerHTML = '<option value="">選択</option>' +
          (fuelTypes || []).map(f => `<option value="${f.name}">${f.name}</option>`).join("");
      }

      // 作業内容選択
      const taue_work_name = document.getElementById("taue_work_name");
      if (taue_work_name) {
        taue_work_name.innerHTML = '<option value="">選択</option>' +
          (workTypes || []).map(w => `<option value="${w.work_name}">${w.work_name}</option>`).join("");
        console.log("田植え機 作業内容セレクトボックス設定完了:", taue_work_name.innerHTML);
      }

      // 履歴検索フィルター - 機械選択
      const filterMachinePlanting = document.getElementById("filterMachinePlanting");
      if (filterMachinePlanting) {
        filterMachinePlanting.innerHTML = '<option value="">すべて</option>' +
          (taueMachines || []).map(m => `<option value="${m.id}">${m.name}</option>`).join("");
      }

      // 履歴検索フィルター - オペレーター選択
      const filterOperatorPlanting = document.getElementById("filterOperatorPlanting");
      if (filterOperatorPlanting) {
        filterOperatorPlanting.innerHTML = '<option value="">すべて</option>' +
          (operators || []).map(o => `<option value="${o.id}">${o.name}</option>`).join("");
      }

      // 履歴検索フィルター - 作業内容選択
      const filterCategoryPlanting = document.getElementById("filterCategoryPlanting");
      if (filterCategoryPlanting) {
        filterCategoryPlanting.innerHTML = '<option value="">すべて</option>' +
          (workTypes || []).map(w => `<option value="${w.work_name}">${w.work_name}</option>`).join("");
      }

      // 履歴検索フィルター - 月の初期値設定
      const filterMonthPlanting = document.getElementById("filterMonthPlanting");
      if (filterMonthPlanting) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        filterMonthPlanting.value = `${year}-${month}`;
      }
    }

    async function taue_autoFillHour() {
      const mId = document.getElementById("taue_machineSelect").value;
      if (!mId) return;
      const { data } = await client.from("planting_logs").select("end_hour").eq("machine_id", mId).order("date", { ascending: false }).order("created_at", { ascending: false }).limit(1);
      if (data && data.length > 0) { document.getElementById("taue_hourBefore").value = data[0].end_hour; taue_calcDiff(); }
    }

    function taue_calcDiff() {
      const b = parseFloat(document.getElementById("taue_hourBefore").value) || 0;
      const a = parseFloat(document.getElementById("taue_hourAfter").value) || 0;
      const d = a - b;
      const disp = document.getElementById("taue_hourDiffDisplay");

      if (a > 0 && a < b) {
        disp.classList.remove("text-[#6b8f71]");
        disp.classList.add("text-red-500");
        disp.textContent = `稼働時間: 0.0 h (入力エラー)`;
      } else {
        disp.classList.remove("text-red-500");
        disp.classList.add("text-[#6b8f71]");
        disp.textContent = `稼働時間: ${d > 0 ? d.toFixed(1) : "0.0"} h`;
      }
    }

    async function taue_saveLog() {
      const machineId = document.getElementById('taue_machineSelect')?.value;
      const workDate = document.getElementById('taue_workDate')?.value;
      const operator = document.getElementById('taue_operator')?.value;
      const workName = document.getElementById('taue_work_name')?.value;
      const hourBefore = parseFloat(document.getElementById('taue_hourBefore')?.value) || 0;
      const hourAfter = parseFloat(document.getElementById('taue_hourAfter')?.value) || 0;
      const fuelType = document.getElementById('taue_fuelType')?.value;
      const fuel = parseFloat(document.getElementById('taue_fuelAmount')?.value) || 0;
      const memo = document.getElementById('taue_memoInput')?.value;

      console.log("🔍 田植え機ログ保存前のデータ確認:", {
        machineId,
        workDate,
        operator,
        workName,
        hourBefore,
        hourAfter,
        hourBeforeElement: document.getElementById('taue_hourBefore'),
        hourBeforeValue: document.getElementById('taue_hourBefore')?.value,
        hourAfterValue: document.getElementById('taue_hourAfter')?.value
      });

      if (!machineId) return showModal("入力エラー", "機械を選択してください");
      if (!workDate || !workName) return showModal("入力エラー", "「作業日」「作業内容」は必須項目です");
      if (hourAfter < hourBefore) return showModal("入力エラー", "稼働後の数値が稼働前より小さくなっています。");

      showModal("登録確認", "ログを登録しますか？", async () => {
        try {
          const logData = {
            date: workDate,
            operator_id: operator ? parseInt(operator) : null,
            machine_id: parseInt(machineId),
            start_hour: hourBefore,
            end_hour: hourAfter,
            task: workName,
            fuel_type_id: fuelType ? parseInt(fuelType) : null,
            fuel_amount: fuel,
            memo: memo,
            created_at: new Date().toISOString()
          };
          console.log("🚀 Supabaseに送信するデータ:", logData);

          const result = await saveData('planting_logs', logData, 'taue_logs');

          const message = result.offline ?
            "ログをローカルに保存しました\n（オンライン時に自動同期されます）" :
            "ログを保存しました";

          showModal("保存完了", message, () => {
            localStorage.setItem('currentView', 'plantingView');
            location.reload();
          });

        } catch (err) {
          console.error("Log Save Error:", err);
          showModal("保存エラー", "保存に失敗しました: " + (err.message));
        }
      });
    }

    async function taue_handleHourAfterImage(input) {
      const file = input.files[0];
      if (!file) return;

      try {
        const base64Image = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.readAsDataURL(file);
        });

        // OCR 実行
        const text = await performOCR(base64Image);
        if (!text) return showModal('読み取り失敗', '読み取りに失敗しました。写真を変えて再試行してください。');

        // 数字（小数点含む）を抽出して input に反映
        const m = text.match(/\d+(?:\.\d+)?/);
        if (m) {
          document.getElementById('taue_hourAfter').value = m[0];
          taue_calcDiff();
        } else {
          showModal('検出失敗', '数字が検出されませんでした。読み取り結果:\n' + (text.substring(0, 200) || '-----'));
        }
      } catch (err) {
        console.error('TaueHourAfter OCR error', err);
        showModal('エラー', '読み取り中にエラーが発生しました');
      } finally {
        // ファイル入力をクリアして同じ画像を再選択できるようにする
        input.value = '';
      }
    }

    // ========== コンバイン用の関数 ==========
    async function initCombinePage() {
      // コンバインの機械リストを取得
      const { data: combineMachines } = await client
        .from("machines")
        .select("*")
        .eq("machine_type", "combine")
        .order("name");

      // オペレーター取得
      const { data: operators } = await client
        .from("operators")
        .select("*")
        .order("id");

      // 油種取得
      const { data: fuelTypes } = await client
        .from("fuel_types")
        .select("*");

      // 作業内容取得（category = '刈取り'）
      const { data: workTypes, error: workTypesError } = await client
        .from("work_types")
        .select("*")
        .eq("category", "刈取り");

      console.log("コンバイン 作業内容データ:", workTypes);
      console.log("コンバイン 作業内容エラー:", workTypesError);
      if (workTypes && workTypes.length > 0) {
        console.log("最初のデータのキー:", Object.keys(workTypes[0]));
      }

      // 機械選択
      const combine_machineSelect = document.getElementById("combine_machineSelect");
      if (combine_machineSelect) {
        combine_machineSelect.innerHTML = '<option value="">選択</option>' +
          (combineMachines || []).map(m => `<option value="${m.id}">${m.name}</option>`).join("");
      }

      // オペレーター選択
      const combine_operator = document.getElementById("combine_operator");
      if (combine_operator) {
        combine_operator.innerHTML = '<option value="">選択</option>' +
          (operators || []).map(o => `<option value="${o.id}">${o.name}</option>`).join("");
      }

      // 油種選択
      const combine_fuelType = document.getElementById("combine_fuelType");
      if (combine_fuelType) {
        combine_fuelType.innerHTML = '<option value="">選択</option>' +
          (fuelTypes || []).map(f => `<option value="${f.id}">${f.name}</option>`).join("");
      }

      // 作業内容選択
      const combine_work_name = document.getElementById("combine_work_name");
      if (combine_work_name) {
        combine_work_name.innerHTML = '<option value="">選択</option>' +
          (workTypes || []).map(w => `<option value="${w.work_name}">${w.work_name}</option>`).join("");
        console.log("コンバイン 作業内容セレクトボックス設定完了:", combine_work_name.innerHTML);
      }

      // 履歴検索フィルター - 機械選択
      const filterMachineCombine = document.getElementById("filterMachineCombine");
      if (filterMachineCombine) {
        filterMachineCombine.innerHTML = '<option value="">すべて</option>' +
          (combineMachines || []).map(m => `<option value="${m.id}">${m.name}</option>`).join("");
      }

      // 履歴検索フィルター - オペレーター選択
      const filterOperatorCombine = document.getElementById("filterOperatorCombine");
      if (filterOperatorCombine) {
        filterOperatorCombine.innerHTML = '<option value="">すべて</option>' +
          (operators || []).map(o => `<option value="${o.id}">${o.name}</option>`).join("");
      }

      // 履歴検索フィルター - 作業内容選択
      const filterCategoryCombine = document.getElementById("filterCategoryCombine");
      if (filterCategoryCombine) {
        filterCategoryCombine.innerHTML = '<option value="">すべて</option>' +
          (workTypes || []).map(w => `<option value="${w.work_name}">${w.work_name}</option>`).join("");
      }

      // 履歴検索フィルター - 月の初期値設定
      const filterMonthCombine = document.getElementById("filterMonthCombine");
      if (filterMonthCombine) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        filterMonthCombine.value = `${year}-${month}`;
      }
    }

    async function combine_autoFillHour() {
      const mId = document.getElementById("combine_machineSelect").value;
      if (!mId) return;
      const { data } = await client.from("combine_logs").select("end_hour").eq("machine_id", mId).order("date", { ascending: false }).order("created_at", { ascending: false }).limit(1);
      if (data && data.length > 0) { document.getElementById("combine_hourBefore").value = data[0].end_hour; combine_calcDiff(); }
    }

    function combine_calcDiff() {
      const b = parseFloat(document.getElementById("combine_hourBefore").value) || 0;
      const a = parseFloat(document.getElementById("combine_hourAfter").value) || 0;
      const d = a - b;
      const disp = document.getElementById("combine_hourDiffDisplay");

      if (a > 0 && a < b) {
        disp.classList.remove("text-[#c9a961]");
        disp.classList.add("text-red-500");
        disp.textContent = `稼働時間: 0.0 h (入力エラー)`;
      } else {
        disp.classList.remove("text-red-500");
        disp.classList.add("text-[#c9a961]");
        disp.textContent = `稼働時間: ${d > 0 ? d.toFixed(1) : "0.0"} h`;
      }
    }

    async function combine_saveLog() {
      const machineId = document.getElementById('combine_machineSelect')?.value;
      const workDate = document.getElementById('combine_workDate')?.value;
      const operator = document.getElementById('combine_operator')?.value;
      const workName = document.getElementById('combine_work_name')?.value;
      const hourBefore = parseFloat(document.getElementById('combine_hourBefore')?.value) || 0;
      const hourAfter = parseFloat(document.getElementById('combine_hourAfter')?.value) || 0;
      const fuelType = document.getElementById('combine_fuelType')?.value;
      const fuel = parseFloat(document.getElementById('combine_fuelAmount')?.value) || 0;
      const memo = document.getElementById('combine_memoInput')?.value;

      if (!machineId) return showModal("入力エラー", "機械を選択してください");
      if (!workDate || !workName) return showModal("入力エラー", "「作業日」「作業内容」は必須項目です");
      if (hourAfter < hourBefore) return showModal("入力エラー", "稼働後の数値が稼働前より小さくなっています。");

      showModal("登録確認", "ログを登録しますか？", async () => {
        try {
          const logData = {
            date: workDate,
            operator_id: operator ? parseInt(operator) : null,
            machine_id: parseInt(machineId),
            start_hour: hourBefore,
            end_hour: hourAfter,
            task: workName,
            fuel_type_id: fuelType ? parseInt(fuelType) : null,
            fuel_amount: fuel,
            memo: memo,
            created_at: new Date().toISOString()
          };

          const result = await saveData('combine_logs', logData, 'combine_logs');

          const message = result.offline ?
            "ログをローカルに保存しました\n（オンライン時に自動同期されます）" :
            "ログを保存しました";

          showModal("保存完了", message, () => {
            localStorage.setItem('currentView', 'combineView');
            location.reload();
          });

        } catch (err) {
          console.error("Log Save Error:", err);
          showModal("保存エラー", "保存に失敗しました: " + (err.message));
        }
      });
    }

    async function combine_handleHourAfterImage(input) {
      const file = input.files[0];
      if (!file) return;

      try {
        const base64Image = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.readAsDataURL(file);
        });

        const text = await performOCR(base64Image);
        if (!text) return showModal('読み取り失敗', '読み取りに失敗しました。写真を変えて再試行してください。');

        const m = text.match(/\d+(?:\.\d+)?/);
        if (m) {
          document.getElementById('combine_hourAfter').value = m[0];
          combine_calcDiff();
        } else {
          showModal('検出失敗', '数字が検出されませんでした。読み取り結果:\n' + (text.substring(0, 200) || '-----'));
        }
      } catch (err) {
        console.error('CombineHourAfter OCR error', err);
        showModal('エラー', '読み取り中にエラーが発生しました');
      } finally {
        input.value = '';
      }
    }

    // ========== 田植え機用のログ読み込み関数 ==========
    async function loadLogsPlanting(elId, todayOnly) {
      const list = document.getElementById(elId);
      list.innerHTML = "<p class='text-center py-10 opacity-50 text-xs'>読込中...</p>";

      let query = client.from("planting_logs").select("*, machines(name), operators(name)").order("date", { ascending: false });

      if (todayOnly) {
        const jstToday = new Date().toLocaleDateString('sv-SE');
        query = query.eq("date", jstToday);
      } else {
        const periodType = document.getElementById("filterPeriodTypePlanting")?.value || 'month';
        const month = document.getElementById("filterMonthPlanting").value;
        const year = document.getElementById("filterYearPlanting").value;
        const machine = document.getElementById("filterMachinePlanting").value;
        const operator = document.getElementById("filterOperatorPlanting").value;
        const category = document.getElementById("filterCategoryPlanting").value;

        if (periodType === 'month' && month) {
          const [yearNum, monthNum] = month.split('-');
          const lastDay = new Date(yearNum, monthNum, 0).getDate();
          query = query.gte("date", `${month}-01`).lte("date", `${month}-${lastDay}`);
        } else if (periodType === 'year' && year) {
          query = query.gte("date", `${year}-01-01`).lte("date", `${year}-12-31`);
        }
        if (machine) query = query.eq("machine_id", machine);
        if (operator) query = query.eq("operator_id", operator);
        if (category) query = query.eq("task", category);
      }

      const { data, error } = await query;
      if (error) {
        console.error("データ取得エラー:", error);
        console.error("エラー詳細:", error.message, error.details, error.hint);
        list.innerHTML = `<p class='text-center py-10 text-red-500 text-xs'>エラー: ${error.message}</p>`;
        return;
      }

      let total = 0;
      const displayData = todayOnly ? [...(data || [])].reverse() : (data || []);

      list.innerHTML = displayData.map(l => {
        const diff = (l.end_hour - l.start_hour);
        total += diff;
        return `<div class="card border-l-4 !mb-3 !py-3 flex justify-between items-center" style="border-color: var(--planting-color)">
              <div>
                <b class="text-sm">${l.date} - ${l.machines?.name}</b>
                <p class="text-xs opacity-70 mt-1">${l.operators?.name || '不明'} | ${l.task}</p>
                <div class="flex gap-4 mt-2">
                  <span class="text-[11px] font-bold log-badge px-2 py-1 rounded"><i class="fa-solid fa-clock mr-1" style="color: var(--planting-color)"></i>${diff.toFixed(1)} h</span>
                  <span class="text-[11px] font-bold log-badge px-2 py-1 rounded"><i class="fa-solid fa-gas-pump mr-1" style="color: var(--planting-color)"></i>${l.fuel_amount || 0} L</span>
                </div>
              </div>
              <button onclick="deleteLogPlanting(${l.id})" class="text-gray-400 p-2 hover:text-red-500 transition-colors">
                <i class="fa-regular fa-trash-can text-lg"></i>
              </button>
            </div>`;
      }).join("");

      if (!todayOnly) {
        const totalEl = document.getElementById("historyTotalHoursPlanting");
        if (totalEl) totalEl.innerText = `合計: ${total.toFixed(1)} h`;
      }
    }

    async function deleteLogPlanting(id) {
      showModal("削除確認", "このログを削除しますか？", async () => {
        const { error } = await client.from("planting_logs").delete().eq("id", id);
        if (!error) {
          if (document.getElementById("todayViewPlanting").classList.contains("active")) loadLogsPlanting("todayLogListPlanting", true);
          else loadLogsPlanting("historyLogListPlanting", false);
        }
      });
    }

    // ========== コンバイン用のログ読み込み関数 ==========
    async function loadLogsCombine(elId, todayOnly) {
      const list = document.getElementById(elId);
      list.innerHTML = "<p class='text-center py-10 opacity-50 text-xs'>読込中...</p>";

      try {
        // まず機械とオペレーターのマスタデータを取得
        const { data: machines } = await client.from("machines").select("id, name");
        const { data: operators } = await client.from("operators").select("id, name");

        const machineMap = {};
        const operatorMap = {};
        (machines || []).forEach(m => machineMap[m.id] = m.name);
        (operators || []).forEach(o => operatorMap[o.id] = o.name);

        // combine_logsを取得
        let query = client.from("combine_logs").select("*").order("date", { ascending: false });

        if (todayOnly) {
          const jstToday = new Date().toLocaleDateString('sv-SE');
          query = query.eq("date", jstToday);
        } else {
          const periodType = document.getElementById("filterPeriodTypeCombine")?.value || 'month';
          const month = document.getElementById("filterMonthCombine").value;
          const year = document.getElementById("filterYearCombine").value;
          const machine = document.getElementById("filterMachineCombine").value;
          const operator = document.getElementById("filterOperatorCombine").value;
          const category = document.getElementById("filterCategoryCombine").value;

          if (periodType === 'month' && month) {
            const [yearNum, monthNum] = month.split('-');
            const lastDay = new Date(yearNum, monthNum, 0).getDate();
            query = query.gte("date", `${month}-01`).lte("date", `${month}-${lastDay}`);
          } else if (periodType === 'year' && year) {
            query = query.gte("date", `${year}-01-01`).lte("date", `${year}-12-31`);
          }
          if (machine) query = query.eq("machine_id", machine);
          if (operator) query = query.eq("operator_id", operator);
          if (category) query = query.eq("task", category);
        }

        const { data, error } = await query;
        if (error) throw error;

        let total = 0;
        const displayData = todayOnly ? [...(data || [])].reverse() : (data || []);

        list.innerHTML = displayData.map(l => {
          const diff = (l.end_hour - l.start_hour);
          total += diff;
          const machineName = machineMap[l.machine_id] || '不明';
          const operatorName = operatorMap[l.operator_id] || '不明';

          return `<div class="card border-l-4 !mb-3 !py-3 flex justify-between items-center" style="border-color: var(--combine-color)">
                <div>
                  <b class="text-sm">${l.date} - ${machineName}</b>
                  <p class="text-xs opacity-70 mt-1">${operatorName} | ${l.task}</p>
                  <div class="flex gap-4 mt-2">
                    <span class="text-[11px] font-bold log-badge px-2 py-1 rounded"><i class="fa-solid fa-clock mr-1" style="color: var(--combine-color)"></i>${diff.toFixed(1)} h</span>
                    <span class="text-[11px] font-bold log-badge px-2 py-1 rounded"><i class="fa-solid fa-gas-pump mr-1" style="color: var(--combine-color)"></i>${l.fuel_amount || 0} L</span>
                  </div>
                </div>
                <button onclick="deleteLogCombine(${l.id})" class="text-gray-400 p-2 hover:text-red-500 transition-colors">
                  <i class="fa-regular fa-trash-can text-lg"></i>
                </button>
              </div>`;
        }).join("");

        if (!todayOnly) {
          const totalEl = document.getElementById("historyTotalHoursCombine");
          if (totalEl) totalEl.innerText = `合計: ${total.toFixed(1)} h`;
        }
      } catch (error) {
        console.error("データ取得エラー:", error);
        console.error("エラー詳細:", error.message, error.details, error.hint);
        list.innerHTML = `<p class='text-center py-10 text-red-500 text-xs'>エラー: ${error.message}</p>`;
      }
    }

    async function deleteLogCombine(id) {
      showModal("削除確認", "このログを削除しますか？", async () => {
        const { error } = await client.from("combine_logs").delete().eq("id", id);
        if (!error) {
          if (document.getElementById("todayViewCombine").classList.contains("active")) loadLogsCombine("todayLogListCombine", true);
          else loadLogsCombine("historyLogListCombine", false);
        }
      });
    }

    // ========== 田植え機用 メンテナンス記録関数 ==========
    async function loadMachineListPlanting() {
      try {
        const { data: machines, error } = await client
          .from("machines")
          .select("*")
          .eq("machine_type", "transplanter")
          .order("id");

        if (error) throw error;

        const container = document.getElementById("maintenanceMachineGridPlanting");
        if (!container) return;
        container.innerHTML = "";

        const grouped = {};
        machines.forEach(m => {
          const manufacturer = m.manufacturer || "その他";
          if (!grouped[manufacturer]) grouped[manufacturer] = [];
          grouped[manufacturer].push(m);
        });

        for (const brand of Object.keys(grouped)) {
          const brandHeader = document.createElement("h3");
          brandHeader.className = "font-bold text-sm mb-2 mt-4 flex items-center gap-2";
          brandHeader.style.color = "var(--planting-color)";
          brandHeader.innerHTML = `<i class="fa-solid fa-tag opacity-50"></i> ${brand}`;
          container.appendChild(brandHeader);

          const grid = document.createElement("div");
          grid.className = "grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-4";

          for (const m of grouped[brand]) {
            const card = document.createElement("div");
            card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-all active:scale-95";
            card.onclick = () => openMaintenanceDetailPlanting(m.id);

            card.innerHTML = `
              <div class="flex flex-col gap-2">
                <div class="flex items-center gap-3">
                  <div style="color: #c9a961;" class="text-xl flex-shrink-0">
                    <i class="fa-solid fa-seedling"></i>
                  </div>
                  <div class="font-bold text-gray-900 text-sm leading-tight break-words">${m.name}</div>
                </div>
                <div class="border-t border-gray-50 pt-2" id="card-progress-planting-${m.id}">
                  <div class="text-[11px] text-gray-400 flex items-center gap-1">
                    <i class="fa-solid fa-circle-notch fa-spin text-[9px]"></i> 確認中...
                  </div>
                </div>
              </div>
            `;
            grid.appendChild(card);

            (async () => {
              try {
                const { data: checks } = await client
                  .from('maintenance_status')
                  .select('item_id, status')
                  .filter('item_id', 'ilike', `${m.id}_%`);

                const totalItems = 16;
                const uniqueChecks = {};
                if (checks) {
                  checks.forEach(c => { uniqueChecks[c.item_id] = c.status; });
                }

                const completedCount = Object.values(uniqueChecks).filter(status => status === true || status === "true").length;
                let percent = Math.round((completedCount / totalItems) * 100);
                percent = Math.min(100, percent);

                const progressDiv = document.getElementById(`card-progress-planting-${m.id}`);
                if (progressDiv) {
                  let statusHTML = percent === 0
                    ? `<span class="text-red-600 font-black"><i class="fa-solid fa-circle-exclamation text-[9px]"></i> 未着手</span>`
                    : percent === 100
                      ? `<span style="color: #c9a961;" class="font-black"><i class="fa-solid fa-circle-check text-[9px]"></i> 完了</span>`
                      : `<span class="text-orange-500 font-black"><i class="fa-solid fa-spinner text-[9px]"></i> ${percent}% 完了</span>`;

                  progressDiv.innerHTML = `
                    <div class="text-[11px] flex items-center gap-1">${statusHTML}</div>
                    <div class="w-full bg-gray-100 rounded-full h-1 mt-1">
                      <div class="h-1 rounded-full transition-all duration-500" style="width: ${percent}%; background: #c9a961;"></div>
                    </div>
                  `;
                }
              } catch (err) { console.error("カード進捗更新エラー:", err); }
            })();
          }
          container.appendChild(grid);
        }
      } catch (e) { console.error("一覧読み込みエラー:", e); }
    }

    async function openMaintenanceDetailPlanting(machineId) {
      window.currentMachineIdPlanting = machineId;
      switchView('maintenanceDetailViewPlanting');

      try {
        const { data: machine } = await client.from("machines").select("*").eq("id", machineId).single();
        document.getElementById("maintenanceMachineNamePlanting").textContent = machine.name;
        // メーカー名表示の色をテーマカラーに統一
        const brandHeader = document.querySelector('#maintenanceDetailViewPlanting h3');
        if (brandHeader) {
          brandHeader.style.color = 'var(--planting-color)';
        }

        const { data: operators } = await client.from('operators').select('name').order('id');
        const opSelect = document.getElementById('newMaintenanceOperatorPlanting');
        if (opSelect && operators) {
          opSelect.innerHTML = '<option value="">担当者を選択</option>';
          operators.forEach(op => {
            const opt = document.createElement('option');
            opt.value = op.name; opt.textContent = op.name;
            opSelect.appendChild(opt);
          });
        }

        loadMaintenanceHistoryPlanting(machineId);
        const { data: items } = await client.from("maintenance_items_transplanter").select("*").order("id");
        const checklistContainer = document.getElementById("maintenanceChecklistPlanting");
        if (checklistContainer && items) {
          checklistContainer.innerHTML = "";
          items.forEach(item => {
            const uniqueId = `${machineId}_${item.id}`;
            const div = document.createElement("div");
            div.className = "flex items-center justify-between p-3 border-b border-gray-50 last:border-0 hover:bg-gray-50 transition-colors";
            div.innerHTML = `
              <div class="flex flex-col flex-1 text-left">
                  <span class="text-sm font-bold text-gray-700">${item.item_name}</span>
                  <span class="text-[10px] text-gray-400">${item.description || ''}</span>
              </div>
              <input type="checkbox" id="${uniqueId}" class="maintenance-check w-6 h-6 rounded border-gray-300" style="accent-color: #c9a961;"
                     onchange="saveSingleCheckPlanting('${machineId}', '${item.id}', this.checked)">
            `;
            checklistContainer.appendChild(div);
          });
        }
        await restoreMaintenanceChecksPlanting();
      } catch (e) { console.error(e); }
    }

    function updateMaintenanceProgressPlanting() {
      const checkboxes = document.querySelectorAll('#maintenanceChecklistPlanting input[type="checkbox"]');
      const total = checkboxes.length;
      if (total === 0) return;
      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
      const percentage = Math.round((checkedCount / total) * 100);
      const summaryDiv = document.getElementById('maintenanceSummaryPlanting');
      if (summaryDiv) {
        summaryDiv.innerHTML = `
          <div class="flex justify-between items-center mb-1">
            <span class="font-bold" style="color: #c9a961;">${percentage}% 完了</span>
            <span class="text-xs text-gray-400">${checkedCount} / ${total} 項目</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="h-2 rounded-full transition-all duration-500" style="width: ${percentage}%; background: #c9a961;"></div>
          </div>
        `;
      }
    }

    async function saveSingleCheckPlanting(machineId, itemId, isChecked) {
      try {
        const uniqueId = `${machineId}_${itemId}`;
        await client.from('maintenance_status').upsert({
          item_id: uniqueId, status: Boolean(isChecked), updated_at: new Date()
        }, { onConflict: 'item_id' });
        updateMaintenanceProgressPlanting();
        loadMachineListPlanting();

        // 全項目完了チェック
        await checkAndSaveMaintenanceCompletion(machineId, 'transplanter');
      } catch (e) { console.error(e); }
    }

    async function restoreMaintenanceChecksPlanting() {
      try {
        const { data } = await client.from('maintenance_status').select('item_id, status');
        if (data) {
          data.forEach(row => {
            const el = document.getElementById(row.item_id);
            if (el) el.checked = row.status;
          });
        }
        updateMaintenanceProgressPlanting();
      } catch (e) { console.error(e); }
    }

    async function loadMaintenanceHistoryPlanting(machineId) {
      try {
        const { data } = await client.from('maintenance_records').select('*').eq('machine_id', machineId).order('created_at', { ascending: false });
        const container = document.getElementById('maintenanceHistoryLogPlanting');
        if (!container) return;
        if (!data || data.length === 0) {
          container.innerHTML = '<p class="italic text-gray-400 text-center py-4">履歴はありません</p>';
          return;
        }
        container.innerHTML = data.map(rec => `
          <div class="border-b border-gray-100 pb-2 mb-2 last:border-0 text-left">
            <div class="flex justify-between font-bold text-gray-700"><span>${rec.item_name}</span><span class="text-gray-400 text-[9px]">${rec.date}</span></div>
            <div class="text-gray-500">担当: ${rec.operator}</div>
            ${rec.memo ? `<div class="text-gray-400 italic">"${rec.memo}"</div>` : ''}
          </div>`).join('');
      } catch (e) { console.error(e); }
    }

    async function saveMaintenanceRecordPlanting() {
      const item = document.getElementById('newMaintenanceItemPlanting')?.value;
      const operator = document.getElementById('newMaintenanceOperatorPlanting')?.value;
      const status = document.getElementById('newMaintenanceStatusPlanting')?.value;
      const memo = document.getElementById('newMaintenanceMemoPlanting')?.value;

      let mId = window.currentMachineIdPlanting;
      const numericMachineId = parseInt(mId);

      if (isNaN(numericMachineId)) {
        showModal("エラー", "機械の情報を読み取れませんでした。一度一覧に戻って選び直してください🌸");
        return;
      }

      if (!item) {
        showModal("入力エラー", "交換部品・項目名を入力してくださいね🌸");
        return;
      }

      try {
        const { error } = await client.from('maintenance_records').insert([
          {
            item_name: item,
            operator: operator,
            status: status,
            memo: memo,
            date: new Date().toISOString().split('T')[0],
            machine_id: numericMachineId
          }
        ]);

        if (error) throw error;

        showModal("保存完了", "メンテナンス情報を記録しました！✨");

        document.getElementById('newMaintenanceItemPlanting').value = '';
        document.getElementById('newMaintenanceMemoPlanting').value = '';

        if (typeof loadMaintenanceHistoryPlanting === 'function') {
          loadMaintenanceHistoryPlanting(numericMachineId);
        }

      } catch (err) {
        console.error("Maint Save Error:", err);
        showModal("保存エラー", "保存に失敗しました: " + (err.message || JSON.stringify(err)));
      }
    }

    // ========== 田植え機用の修理履歴読み込み関数 ==========
    async function loadRepairDashboardPlanting() {
      try {
        // repair_logs をすべて取得し、machine_type='transplanter'でフィルタリング
        const { data: machines, error: machinesError } = await client
          .from('machines')
          .select('id')
          .eq('machine_type', 'transplanter');

        if (machinesError) {
          console.error('Error loading machines:', machinesError);
          return;
        }

        const transplantMachineIds = machines.map(m => m.id);

        const { data: logs, error } = await client
          .from('repair_logs')
          .select('*')
          .in('machine_id', transplantMachineIds)
          .order('date', { ascending: false });

        if (error) {
          console.error('Error loading repair logs:', error);
          return;
        }

        // -----------------------------
        // ① 累計修理費
        // -----------------------------
        const totalCost = logs.reduce((sum, log) => sum + (log.cost || 0), 0);
        document.getElementById('totalRepairCostPlanting').textContent =
          '¥ ' + totalCost.toLocaleString();

        // -----------------------------
        // ② 年ごとの修理費
        // -----------------------------
        const yearly = {};
        logs.forEach(log => {
          const year = new Date(log.date).getFullYear();
          if (!yearly[year]) yearly[year] = 0;
          yearly[year] += log.cost || 0;
        });

        const yearlyContainer = document.getElementById('yearlyRepairContainerPlanting');
        yearlyContainer.innerHTML = '';

        Object.keys(yearly)
          .sort((a, b) => b - a)
          .forEach(year => {
            const card = document.createElement('div');
            card.className =
              'p-3 bg-white rounded-md shadow text-center border border-gray-100';
            card.innerHTML = `
          <div class="text-sm text-gray-500">${year}年</div>
          <div class="text-lg font-bold text-[#6b8f71]">¥ ${yearly[year].toLocaleString()}</div>
        `;
            yearlyContainer.appendChild(card);
          });

        // -----------------------------
        // ③ 機械ごとの修理費
        // -----------------------------
        const machineTotals = {};

        logs.forEach(log => {
          if (!machineTotals[log.machine_id]) machineTotals[log.machine_id] = 0;
          machineTotals[log.machine_id] += log.cost || 0;
        });

        // machines テーブルから名前を取得
        const { data: allMachines } = await client.from('machines').select('*');

        const machineContainer = document.getElementById('machineRepairContainerPlanting');
        machineContainer.innerHTML = '';

        Object.keys(machineTotals).forEach(machineId => {
          const machine = allMachines.find(m => m.id === Number(machineId));
          const name = machine ? machine.name : '不明な機械';

          const card = document.createElement('div');
          card.className =
            'p-3 bg-white rounded-md shadow text-center border border-gray-100';
          card.innerHTML = `
        <div class="text-sm text-gray-500">${name}</div>
        <div class="text-lg font-bold text-[#6b8f71]">¥ ${machineTotals[machineId].toLocaleString()}</div>
      `;
          machineContainer.appendChild(card);
        });

        // -----------------------------
        // ④ 最近の修理履歴（最新5件）
        // -----------------------------
        const recentContainer = document.getElementById('recentRepairContainerPlanting');
        recentContainer.innerHTML = '';

        logs.slice(0, 5).forEach(log => {
          const item = document.createElement('div');
          item.className =
            'p-3 bg-white rounded-md shadow border border-gray-100';

          item.innerHTML = `
        <div class="text-sm text-gray-500">${log.date}</div>
        <div class="font-bold">${log.memo || '(内容なし)'}</div>
        <div class="text-[#6b8f71] font-bold mt-1">¥ ${log.cost.toLocaleString()}</div>
        <div class="text-xs text-gray-400 mt-1">${log.shop || ''}</div>
      `;

          recentContainer.appendChild(item);
        });

      } catch (err) {
        console.error('Unexpected error:', err);
      }
    }

    async function populateMachineSelectPlanting() {
      const { data: machines } = await client
        .from('machines')
        .select('*')
        .eq('machine_type', 'transplanter')
        .order('name');

      const select = document.getElementById('repairMachineSelectPlanting');
      if (!select) return;

      select.innerHTML = '<option value="">選択してください</option>';

      if (machines && machines.length > 0) {
        machines.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.id;
          opt.textContent = m.name;
          select.appendChild(opt);
        });
      } else {
        const opt = document.createElement('option');
        opt.textContent = "田植え機が登録されていません";
        select.appendChild(opt);
      }
    }

    async function previewInvoicePlanting(input) {
      const file = input.files[0];
      if (!file) return;

      const previewImg = document.getElementById('invoicePreviewImgPlanting');
      const previewArea = document.getElementById('invoicePreviewAreaPlanting');
      const saveBtn = document.getElementById('saveRepairBtnPlanting');

      // プレビュー表示
      previewImg.src = URL.createObjectURL(file);
      previewArea.classList.remove('hidden');

      const memoField = document.getElementById('repairMemoPlanting');
      const dateField = document.getElementById('repairDatePlanting');
      const shopField = document.getElementById('repairShopPlanting');
      const costField = document.getElementById('repairCostPlanting');

      saveBtn.disabled = true;
      saveBtn.innerText = "解析中...";

      try {
        const base64 = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });

        const response = await fetch(
          `https://vision.googleapis.com/v1/images:annotate?key=${VISION_API_KEY}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              requests: [{
                image: { content: base64 },
                features: [{ type: 'TEXT_DETECTION', maxResults: 1 }]
              }]
            })
          }
        );

        const data = await response.json();
        const text = data.responses[0]?.fullTextAnnotation?.text || '';

        console.log("OCR解析結果:", text);

        // 日付を抽出（YYYY/MM/DD または YYYY-MM-DD）
        const dateMatch = text.match(/(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})/);
        if (dateMatch) {
          const [_, year, month, day] = dateMatch;
          dateField.value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        }

        // 店舗名（仮のロジック：最初の行を店舗名とする）
        const lines = text.split('\n').filter(line => line.trim());
        if (lines.length > 0) {
          shopField.value = lines[0];
        }

        // 金額を抽出（¥または￥または「円」の前の数字）
        const costMatch = text.match(/[¥￥]?\s*([\d,]+)\s*円?/);
        if (costMatch) {
          costField.value = costMatch[1].replace(/,/g, '');
        }

        memoField.value = text.substring(0, 200);

        saveBtn.disabled = false;
        saveBtn.innerText = "修理履歴を保存";

      } catch (err) {
        console.error("OCR読み取りエラー:", err);
        showModal("エラー", "画像の読み取りに失敗しました");
        saveBtn.disabled = false;
        saveBtn.innerText = "修理履歴を保存";
      }
    }

    async function saveRepairLogPlanting() {
      const machineId = document.getElementById('repairMachineSelectPlanting').value;
      const dateValue = document.getElementById('repairDatePlanting').value;
      const shopValue = document.getElementById('repairShopPlanting').value;
      const costValue = document.getElementById('repairCostPlanting').value;
      const memoValue = document.getElementById('repairMemoPlanting').value;

      if (!dateValue || !costValue) {
        showModal("入力エラー", "修理日と金額は必須です");
        return;
      }

      const btn = document.getElementById('saveRepairBtnPlanting');
      btn.disabled = true;
      btn.innerText = "保存中...";

      try {
        const { error } = await client
          .from('repair_logs')
          .insert([
            {
              date: dateValue,
              shop: shopValue,
              cost: parseInt(costValue),
              memo: memoValue,
              machine_id: machineId || null
            }
          ]);

        if (error) throw error;

        btn.innerText = "保存完了！";

        loadRepairDashboardPlanting();

        if (typeof showCustomModal === 'function') {
        } else {
          showModal("保存完了", "保存完了しました🌾");
        }

        setTimeout(() => {
          switchView('repairViewPlanting');
          btn.disabled = false;
          btn.innerText = "修理履歴を保存";
        }, 1500);

      } catch (err) {
        console.error("❌ 保存に失敗しました:", err);
        showModal("保存エラー", "エラーで保存できませんでした: " + err.message);
        btn.disabled = false;
        btn.innerText = "修理履歴を保存";
      }
    }

    // ========== コンバイン用 メンテナンス記録関数 ==========
    async function loadMachineListCombine() {
      try {
        const { data: machines, error } = await client
          .from("machines")
          .select("*")
          .eq("machine_type", "combine")
          .order("id");

        if (error) throw error;

        const container = document.getElementById("maintenanceMachineGridCombine");
        if (!container) return;
        container.innerHTML = "";

        const grouped = {};
        machines.forEach(m => {
          const manufacturer = m.manufacturer || "その他";
          if (!grouped[manufacturer]) grouped[manufacturer] = [];
          grouped[manufacturer].push(m);
        });

        for (const brand of Object.keys(grouped)) {
          const brandHeader = document.createElement("h3");
          brandHeader.className = "font-bold text-sm mb-2 mt-4 flex items-center gap-2";
          brandHeader.style.color = "var(--combine-color)";
          brandHeader.innerHTML = `<i class="fa-solid fa-tag opacity-50"></i> ${brand}`;
          container.appendChild(brandHeader);

          const grid = document.createElement("div");
          grid.className = "grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-4";

          for (const m of grouped[brand]) {
            const card = document.createElement("div");
            card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-all active:scale-95";
            card.onclick = () => openMaintenanceDetailCombine(m.id);

            card.innerHTML = `
              <div class="flex flex-col gap-2">
                <div class="flex items-center gap-3">
                  <div style="color: var(--combine-color);" class="text-xl flex-shrink-0">
                    <i class="fa-solid fa-wheat-awn"></i>
                  </div>
                  <div class="font-bold text-gray-900 text-sm leading-tight break-words">${m.name}</div>
                </div>
                <div class="border-t border-gray-50 pt-2" id="card-progress-combine-${m.id}">
                  <div class="text-[11px] text-gray-400 flex items-center gap-1">
                    <i class="fa-solid fa-circle-notch fa-spin text-[9px]"></i> 確認中...
                  </div>
                </div>
              </div>
            `;
            grid.appendChild(card);

            (async () => {
              try {
                const { data: checks } = await client
                  .from('maintenance_status')
                  .select('item_id, status')
                  .filter('item_id', 'ilike', `${m.id}_%`);

                const { data: items } = await client
                  .from('maintenance_items_combine')
                  .select('id');

                const totalItems = items ? items.length : 0;
                const uniqueChecks = {};
                if (checks) {
                  checks.forEach(c => { uniqueChecks[c.item_id] = c.status; });
                }

                const completedCount = Object.values(uniqueChecks).filter(status => status === true || status === "true").length;
                let percent = totalItems > 0 ? Math.round((completedCount / totalItems) * 100) : 0;
                percent = Math.min(100, percent);

                const progressDiv = document.getElementById(`card-progress-combine-${m.id}`);
                if (progressDiv) {
                  let statusHTML = percent === 0
                    ? `<span class="text-red-600 font-black"><i class="fa-solid fa-circle-exclamation text-[9px]"></i> 未着手</span>`
                    : percent === 100
                      ? `<span style="color: #c97c73;" class="font-black"><i class="fa-solid fa-circle-check text-[9px]"></i> 完了</span>`
                      : `<span class="text-orange-500 font-black"><i class="fa-solid fa-spinner text-[9px]"></i> ${percent}% 完了</span>`;

                  progressDiv.innerHTML = `
                    <div class="text-[11px] flex items-center gap-1">${statusHTML}</div>
                    <div class="w-full bg-gray-100 rounded-full h-1 mt-1">
                      <div class="h-1 rounded-full transition-all duration-500" style="width: ${percent}%; background: #c97c73;"></div>
                    </div>
                  `;
                }
              } catch (err) { console.error("カード進捗更新エラー:", err); }
            })();
          }
          container.appendChild(grid);
        }
      } catch (e) { console.error("一覧読み込みエラー:", e); }
    }

    async function openMaintenanceDetailCombine(machineId) {
      window.currentMachineIdCombine = machineId;
      switchView('maintenanceDetailViewCombine');

      try {
        const { data: machine } = await client.from("machines").select("*").eq("id", machineId).single();
        document.getElementById("maintenanceMachineNameCombine").textContent = machine.name;

        const { data: operators } = await client.from('operators').select('name').order('id');
        const opSelect = document.getElementById('newMaintenanceOperatorCombine');
        if (opSelect && operators) {
          opSelect.innerHTML = '<option value="">担当者を選択</option>';
          operators.forEach(op => {
            const opt = document.createElement('option');
            opt.value = op.name; opt.textContent = op.name;
            opSelect.appendChild(opt);
          });
        }

        loadMaintenanceHistoryCombine(machineId);
        const { data: items } = await client.from("maintenance_items_combine").select("*").order("id");
        const checklistContainer = document.getElementById("maintenanceChecklistCombine");
        if (checklistContainer && items) {
          checklistContainer.innerHTML = "";
          items.forEach(item => {
            const uniqueId = `${machineId}_${item.id}`;
            const div = document.createElement("div");
            div.className = "flex items-center justify-between p-3 border-b border-gray-50 last:border-0 hover:bg-gray-50 transition-colors";
            div.innerHTML = `
              <div class="flex flex-col flex-1 text-left">
                  <span class="text-sm font-bold text-gray-700">${item.item_name}</span>
                  <span class="text-[10px] text-gray-400">${item.description || ''}</span>
              </div>
              <input type="checkbox" id="${uniqueId}" class="maintenance-check w-6 h-6 rounded border-gray-300" style="accent-color: #c97c73;"
                     onchange="saveSingleCheckCombine('${machineId}', '${item.id}', this.checked)">
            `;
            checklistContainer.appendChild(div);
          });
        }
        await restoreMaintenanceChecksCombine();
      } catch (e) { console.error(e); }
    }

    function updateMaintenanceProgressCombine() {
      const checkboxes = document.querySelectorAll('#maintenanceChecklistCombine input[type="checkbox"]');
      const total = checkboxes.length;
      if (total === 0) return;
      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
      const percentage = Math.round((checkedCount / total) * 100);
      const summaryDiv = document.getElementById('maintenanceSummaryCombine');
      if (summaryDiv) {
        summaryDiv.innerHTML = `
          <div class="flex justify-between items-center mb-1">
            <span class="font-bold" style="color: #c97c73;">${percentage}% 完了</span>
            <span class="text-xs text-gray-400">${checkedCount} / ${total} 項目</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="h-2 rounded-full transition-all duration-500" style="width: ${percentage}%; background: #c97c73;"></div>
          </div>
        `;
      }
    }

    async function saveSingleCheckCombine(machineId, itemId, isChecked) {
      try {
        const uniqueId = `${machineId}_${itemId}`;
        await client.from('maintenance_status').upsert({
          item_id: uniqueId, status: Boolean(isChecked), updated_at: new Date()
        }, { onConflict: 'item_id' });
        updateMaintenanceProgressCombine();
        loadMachineListCombine();

        // 全項目完了チェック
        await checkAndSaveMaintenanceCompletion(machineId, 'combine');
      } catch (e) { console.error(e); }
    }

    async function restoreMaintenanceChecksCombine() {
      try {
        const { data } = await client.from('maintenance_status').select('item_id, status');
        if (data) {
          data.forEach(row => {
            const el = document.getElementById(row.item_id);
            if (el) el.checked = row.status;
          });
        }
        updateMaintenanceProgressCombine();
      } catch (e) { console.error(e); }
    }

    async function loadMaintenanceHistoryCombine(machineId) {
      try {
        const { data } = await client.from('maintenance_records').select('*').eq('machine_id', machineId).order('created_at', { ascending: false });
        const container = document.getElementById('maintenanceHistoryLogCombine');
        if (!container) return;
        if (!data || data.length === 0) {
          container.innerHTML = '<p class="italic text-gray-400 text-center py-4">履歴はありません</p>';
          return;
        }
        container.innerHTML = data.map(rec => `
          <div class="border-b border-gray-100 pb-2 mb-2 last:border-0 text-left">
            <div class="flex justify-between font-bold text-gray-700"><span>${rec.item_name}</span><span class="text-gray-400 text-[9px]">${rec.date}</span></div>
            <div class="text-gray-500">担当: ${rec.operator}</div>
            ${rec.memo ? `<div class="text-gray-400 italic">"${rec.memo}"</div>` : ''}
          </div>`).join('');
      } catch (e) { console.error(e); }
    }

    async function saveMaintenanceRecordCombine() {
      const item = document.getElementById('newMaintenanceItemCombine')?.value;
      const operator = document.getElementById('newMaintenanceOperatorCombine')?.value;
      const status = document.getElementById('newMaintenanceStatusCombine')?.value;
      const memo = document.getElementById('newMaintenanceMemoCombine')?.value;

      let mId = window.currentMachineIdCombine;
      const numericMachineId = parseInt(mId);

      if (isNaN(numericMachineId)) {
        showModal("エラー", "機械の情報を読み取れませんでした。一度一覧に戻って選び直してください🌸");
        return;
      }

      if (!item) {
        showModal("入力エラー", "交換部品・項目名を入力してくださいね🌸");
        return;
      }

      try {
        const { error } = await client.from('maintenance_records').insert([
          {
            item_name: item,
            operator: operator,
            status: status,
            memo: memo,
            date: new Date().toISOString().split('T')[0],
            machine_id: numericMachineId
          }
        ]);

        if (error) throw error;

        showModal("保存完了", "メンテナンス情報を記録しました！✨");

        document.getElementById('newMaintenanceItemCombine').value = '';
        document.getElementById('newMaintenanceMemoCombine').value = '';

        if (typeof loadMaintenanceHistoryCombine === 'function') {
          loadMaintenanceHistoryCombine(numericMachineId);
        }

      } catch (err) {
        console.error("Maint Save Error:", err);
        showModal("保存エラー", "保存に失敗しました: " + (err.message || JSON.stringify(err)));
      }
    }

    // ==========================================
    // エクスポート機能
    // ==========================================

    // エクスポートページ用のグローバル変数
    let currentExportData = [];

    // エクスポートページ初期化
    async function initExportPage() {
      // 機械リストを読み込み
      const { data: machines } = await client
        .from('machines')
        .select('*')
        .order('name');

      const machineSelect = document.getElementById('exportMachine');
      if (machineSelect && machines) {
        // 機械タイプごとにグループ化
        const tractors = machines.filter(m => m.machine_type === 'tractor');
        const transplanters = machines.filter(m => m.machine_type === 'transplanter');
        const combines = machines.filter(m => m.machine_type === 'combine');
        const others = machines.filter(m => !['tractor', 'transplanter', 'combine'].includes(m.machine_type));

        let optionsHTML = '<option value="">全ての機械</option>';

        if (tractors.length > 0) {
          optionsHTML += '<optgroup label="トラクター">';
          optionsHTML += tractors.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
          optionsHTML += '</optgroup>';
        }

        if (transplanters.length > 0) {
          optionsHTML += '<optgroup label="田植え機">';
          optionsHTML += transplanters.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
          optionsHTML += '</optgroup>';
        }

        if (combines.length > 0) {
          optionsHTML += '<optgroup label="コンバイン">';
          optionsHTML += combines.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
          optionsHTML += '</optgroup>';
        }

        if (others.length > 0) {
          optionsHTML += '<optgroup label="その他">';
          optionsHTML += others.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
          optionsHTML += '</optgroup>';
        }

        machineSelect.innerHTML = optionsHTML;
      }

      // オペレーターリストを読み込み
      const { data: operators } = await client
        .from('operators')
        .select('*')
        .order('name');

      const operatorSelect = document.getElementById('exportOperator');
      if (operatorSelect && operators) {
        operatorSelect.innerHTML = '<option value="">全てのオペレーター</option>' +
          operators.map(o => `<option value="${o.id}">${o.name}</option>`).join('');
      }

      // デフォルトで過去30日間を設定
      const endDate = new Date();
      const startDate = new Date();
      startDate.setDate(startDate.getDate() - 30);

      document.getElementById('exportEndDate').valueAsDate = endDate;
      document.getElementById('exportStartDate').valueAsDate = startDate;

      // 初回プレビュー表示
      updateExportPreview();
    }

    // データプレビュー更新
    async function updateExportPreview() {
      const dataType = document.getElementById('exportDataType').value;
      const startDate = document.getElementById('exportStartDate').value;
      const endDate = document.getElementById('exportEndDate').value;
      const machineId = document.getElementById('exportMachine').value;
      const operatorId = document.getElementById('exportOperator').value;

      const previewDiv = document.getElementById('exportPreviewTable');
      const countSpan = document.getElementById('previewCount');
      const exportButton = document.getElementById('exportButton');

      // データタイプに応じてフィルタの表示/非表示を制御
      const operatorFilter = document.getElementById('exportOperatorFilter');
      if (['tractor', 'planting', 'combine'].includes(dataType)) {
        operatorFilter.style.display = 'block';
      } else {
        operatorFilter.style.display = 'none';
      }

      // ローディング表示
      previewDiv.innerHTML = '<p class="text-center text-gray-500 py-8"><i class="fa-solid fa-spinner fa-spin mr-2"></i>読み込み中...</p>';

      try {
        // マスターデータを取得
        const { data: machines } = await client.from("machines").select("id, name");
        const { data: operators } = await client.from("operators").select("id, name");
        const { data: workTypes } = await client.from("work_types").select("id, work_name, category");

        const machineMap = {};
        const operatorMap = {};
        const workTypeMap = {};

        (machines || []).forEach(m => machineMap[m.id] = m.name);
        (operators || []).forEach(o => operatorMap[o.id] = o.name);
        (workTypes || []).forEach(w => workTypeMap[w.id] = w);

        let query;
        let tableName;
        let dateField;

        // データタイプに応じてクエリを構築
        if (dataType === 'tractor') {
          tableName = 'hour_logs';
          dateField = 'date';
          query = client.from(tableName).select('*');
        } else if (dataType === 'planting') {
          tableName = 'planting_logs';
          dateField = 'date';
          query = client.from(tableName).select('*');
        } else if (dataType === 'combine') {
          tableName = 'combine_logs';
          dateField = 'date';
          query = client.from(tableName).select('*');
        } else if (dataType === 'maintenance') {
          tableName = 'maintenance_records';
          dateField = 'date';
          query = client.from(tableName).select('*');
        } else if (dataType === 'repair') {
          tableName = 'repair_logs';
          dateField = 'date';
          query = client.from(tableName).select('*');
        }

        // 期間フィルター
        if (startDate) {
          query = query.gte(dateField, startDate);
        }
        if (endDate) {
          query = query.lte(dateField, endDate);
        }

        // 機械フィルター
        if (machineId) {
          query = query.eq('machine_id', machineId);
        }

        // オペレーターフィルター（稼働ログのみ）
        if (operatorId && ['tractor', 'planting', 'combine'].includes(dataType)) {
          query = query.eq('operator_id', operatorId);
        }

        query = query.order(dateField, { ascending: false }).limit(100);

        const { data, error } = await query;

        if (error) throw error;

        // データにマスターデータを結合
        currentExportData = (data || []).map(row => {
          const enrichedRow = { ...row };

          // 機械名の取得（machine_idがnullやundefinedの場合も考慮）
          if (row.machine_id) {
            enrichedRow.machine_name = machineMap[row.machine_id] || row.machine_name || '';
          } else {
            enrichedRow.machine_name = row.machine_name || '';
          }

          // オペレーター名の取得
          if (['tractor', 'planting', 'combine'].includes(dataType)) {
            enrichedRow.operator_name = row.operator || operatorMap[row.operator_id] || '';
          }

          if (dataType === 'tractor' && row.work_type_id) {
            const workType = workTypeMap[row.work_type_id];
            enrichedRow.work_type_category = workType?.category || '';
            enrichedRow.work_type_name = workType?.work_name || '';
          }

          // 稼働時間を計算
          if (row.start_hour !== undefined && row.end_hour !== undefined) {
            enrichedRow.diff_hour = (row.end_hour - row.start_hour).toFixed(1);
          }

          return enrichedRow;
        });

        // プレビュー表示
        if (currentExportData.length === 0) {
          previewDiv.innerHTML = '<p class="text-center text-gray-500 py-8">該当するデータがありません</p>';
          countSpan.textContent = '0件';
          exportButton.disabled = true;
        } else {
          countSpan.textContent = `${currentExportData.length}件`;
          exportButton.disabled = false;

          // テーブル生成
          let tableHTML = '<table class="w-full text-xs border-collapse"><thead><tr class="bg-gray-100">';

          // ヘッダー
          if (['tractor', 'planting', 'combine'].includes(dataType)) {
            tableHTML += `
              <th class="border p-2">作業日</th>
              <th class="border p-2">機械名</th>
              <th class="border p-2">オペレーター</th>
              <th class="border p-2">種別</th>
              <th class="border p-2">作業内容</th>
              <th class="border p-2">稼働前(h)</th>
              <th class="border p-2">稼働後(h)</th>
              <th class="border p-2">稼働時間(h)</th>
              <th class="border p-2">備考</th>
            `;
          } else if (dataType === 'maintenance') {
            tableHTML += `
              <th class="border p-2">日付</th>
              <th class="border p-2">機械名</th>
              <th class="border p-2">項目名</th>
              <th class="border p-2">担当者</th>
              <th class="border p-2">状態</th>
              <th class="border p-2">メモ</th>
            `;
          } else if (dataType === 'repair') {
            tableHTML += `
              <th class="border p-2">修理日</th>
              <th class="border p-2">機械名</th>
              <th class="border p-2">修理先</th>
              <th class="border p-2">費用</th>
              <th class="border p-2">メモ</th>
            `;
          }

          tableHTML += '</tr></thead><tbody>';

          // データ行（最大10件まで表示）
          currentExportData.slice(0, 10).forEach(row => {
            tableHTML += '<tr>';

            if (['tractor', 'planting', 'combine'].includes(dataType)) {
              let category = '';
              let workName = '';

              if (dataType === 'tractor') {
                category = row.work_type_category || row.category || '';
                workName = row.work_type_name || row.task || '';
              } else if (dataType === 'planting' || dataType === 'combine') {
                category = row.task || '';
                workName = '';
              }

              tableHTML += `
                <td class="border p-2">${row.date || ''}</td>
                <td class="border p-2">${row.machine_name}</td>
                <td class="border p-2">${row.operator_name}</td>
                <td class="border p-2">${category}</td>
                <td class="border p-2">${workName}</td>
                <td class="border p-2">${row.start_hour || ''}</td>
                <td class="border p-2">${row.end_hour || ''}</td>
                <td class="border p-2">${row.diff_hour || ''}</td>
                <td class="border p-2">${row.memo || ''}</td>
              `;
            } else if (dataType === 'maintenance') {
              tableHTML += `
                <td class="border p-2">${row.date || ''}</td>
                <td class="border p-2">${row.machine_name}</td>
                <td class="border p-2">${row.item_name || ''}</td>
                <td class="border p-2">${row.operator || ''}</td>
                <td class="border p-2">${row.status || ''}</td>
                <td class="border p-2">${row.memo || ''}</td>
              `;
            } else if (dataType === 'repair') {
              tableHTML += `
                <td class="border p-2">${row.date || ''}</td>
                <td class="border p-2">${row.machine_name}</td>
                <td class="border p-2">${row.shop || ''}</td>
                <td class="border p-2">${row.cost || ''}</td>
                <td class="border p-2">${row.memo || ''}</td>
              `;
            }

            tableHTML += '</tr>';
          });

          if (currentExportData.length > 10) {
            tableHTML += `<tr><td colspan="9" class="border p-2 text-center text-gray-500">...他${currentExportData.length - 10}件</td></tr>`;
          }

          tableHTML += '</tbody></table>';
          previewDiv.innerHTML = tableHTML;

          // 印刷用テーブル(全件表示)
          let printTableHTML = '<table class="w-full text-xs border-collapse"><thead><tr class="bg-gray-100">';

          // ヘッダー(プレビューと同じ)
          if (['tractor', 'planting', 'combine'].includes(dataType)) {
            printTableHTML += `
              <th class="border p-2">作業日</th>
              <th class="border p-2">機械名</th>
              <th class="border p-2">オペレーター</th>
              <th class="border p-2">種別</th>
              <th class="border p-2">作業内容</th>
              <th class="border p-2">稼働前(h)</th>
              <th class="border p-2">稼働後(h)</th>
              <th class="border p-2">稼働時間(h)</th>
              <th class="border p-2">備考</th>
            `;
          } else if (dataType === 'maintenance') {
            printTableHTML += `
              <th class="border p-2">日付</th>
              <th class="border p-2">機械名</th>
              <th class="border p-2">項目名</th>
              <th class="border p-2">担当者</th>
              <th class="border p-2">状態</th>
              <th class="border p-2">メモ</th>
            `;
          } else if (dataType === 'repair') {
            printTableHTML += `
              <th class="border p-2">修理日</th>
              <th class="border p-2">機械名</th>
              <th class="border p-2">修理先</th>
              <th class="border p-2">費用</th>
              <th class="border p-2">メモ</th>
            `;
          }

          printTableHTML += '</tr></thead><tbody>';

          // 全件のデータ行を追加
          currentExportData.forEach(row => {
            printTableHTML += '<tr>';

            if (['tractor', 'planting', 'combine'].includes(dataType)) {
              let category = '';
              let workName = '';

              if (dataType === 'tractor') {
                category = row.work_type_category || row.category || '';
                workName = row.work_type_name || row.task || '';
              } else if (dataType === 'planting' || dataType === 'combine') {
                category = row.task || '';
                workName = '';
              }

              printTableHTML += `
                <td class="border p-2">${row.date || ''}</td>
                <td class="border p-2">${row.machine_name}</td>
                <td class="border p-2">${row.operator_name}</td>
                <td class="border p-2">${category}</td>
                <td class="border p-2">${workName}</td>
                <td class="border p-2">${row.start_hour || ''}</td>
                <td class="border p-2">${row.end_hour || ''}</td>
                <td class="border p-2">${row.diff_hour || ''}</td>
                <td class="border p-2">${row.memo || ''}</td>
              `;
            } else if (dataType === 'maintenance') {
              printTableHTML += `
                <td class="border p-2">${row.date || ''}</td>
                <td class="border p-2">${row.machine_name}</td>
                <td class="border p-2">${row.item_name || ''}</td>
                <td class="border p-2">${row.operator || ''}</td>
                <td class="border p-2">${row.status || ''}</td>
                <td class="border p-2">${row.memo || ''}</td>
              `;
            } else if (dataType === 'repair') {
              printTableHTML += `
                <td class="border p-2">${row.date || ''}</td>
                <td class="border p-2">${row.machine_name}</td>
                <td class="border p-2">${row.shop || ''}</td>
                <td class="border p-2">${row.cost || ''}</td>
                <td class="border p-2">${row.memo || ''}</td>
              `;
            }

            printTableHTML += '</tr>';
          });

          printTableHTML += '</tbody></table>';
          document.getElementById('exportPrintTable').innerHTML = printTableHTML;
        }

      } catch (error) {
        console.error('プレビューエラー:', error);
        previewDiv.innerHTML = '<p class="text-center text-red-500 py-8">データの読み込みに失敗しました</p>';
        exportButton.disabled = true;
      }
    }

    // Excelエクスポート実行
    function executeExport() {
      if (currentExportData.length === 0) {
        showModal('エクスポート', 'エクスポートするデータがありません');
        return;
      }

      const dataType = document.getElementById('exportDataType').value;
      let exportData, fileName, sheetName;

      try {
        if (['tractor', 'planting', 'combine'].includes(dataType)) {
          exportData = currentExportData.map(row => {
            let category = '';
            let workName = '';

            if (dataType === 'tractor') {
              category = row.work_type_category || row.category || '';
              workName = row.work_type_name || row.task || '';
            } else if (dataType === 'planting' || dataType === 'combine') {
              category = row.task || '';
              workName = '';
            }

            return {
              '作業日': row.date || '',
              '機械名': row.machine_name,
              'オペレーター': row.operator_name,
              '種別': category,
              '作業内容': workName,
              '稼働前(h)': row.start_hour || '',
              '稼働後(h)': row.end_hour || '',
              '稼働時間(h)': row.diff_hour || '',
              '備考': row.memo || ''
            };
          });
          sheetName = dataType === 'tractor' ? 'トラクター稼働ログ' :
            dataType === 'planting' ? '田植え機稼働ログ' : 'コンバイン稼働ログ';
        } else if (dataType === 'maintenance') {
          exportData = currentExportData.map(row => ({
            '日付': row.date || '',
            '機械名': row.machine_name,
            '項目名': row.item_name || '',
            '担当者': row.operator || '',
            '状態': row.status || '',
            'メモ': row.memo || ''
          }));
          sheetName = 'メンテナンス記録';
        } else if (dataType === 'repair') {
          exportData = currentExportData.map(row => ({
            '修理日': row.date || '',
            '機械名': row.machine_name,
            '修理先': row.shop || '',
            '費用(円)': row.cost || '',
            'メモ': row.memo || ''
          }));
          sheetName = '修理記録';
        }

        // SheetJSでExcel生成
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, sheetName);

        // ファイル名生成
        const now = new Date();
        fileName = `${sheetName}_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}.xlsx`;

        // ダウンロード
        XLSX.writeFile(wb, fileName);

        showModal('エクスポート完了', `${currentExportData.length}件のデータをエクスポートしました`);
      } catch (error) {
        console.error('エクスポートエラー:', error);
        showModal('エラー', 'データのエクスポートに失敗しました');
      }
    }

    // トラクターデータエクスポート（旧関数 - 削除予定）
    async function exportTractorData() {
      try {
        const { data, error } = await client
          .from('hour_logs')
          .select(`
            *,
            machines(name),
            operators(name),
            work_types(work_name, category)
          `)
          .order('work_date', { ascending: false });

        if (error) throw error;

        if (!data || data.length === 0) {
          showModal('エクスポート', 'エクスポートするデータがありません');
          return;
        }

        // データを整形
        const exportData = data.map(row => ({
          '作業日': row.work_date || '',
          '機械名': row.machines?.name || '',
          'オペレーター': row.operators?.name || '',
          '種別': row.work_types?.category || '',
          '作業内容': row.work_types?.work_name || '',
          '稼働前(h)': row.start_hour || '',
          '稼働後(h)': row.end_hour || '',
          '稼働時間(h)': row.diff_hour || '',
          '備考': row.memo || ''
        }));

        // SheetJSでExcel生成
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'トラクター稼働ログ');

        // ファイル名生成（現在日時）
        const now = new Date();
        const fileName = `トラクター稼働ログ_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}.xlsx`;

        // ダウンロード
        XLSX.writeFile(wb, fileName);

        showModal('エクスポート完了', `${data.length}件のデータをエクスポートしました`);
      } catch (error) {
        console.error('エクスポートエラー:', error);
        showModal('エラー', 'データのエクスポートに失敗しました');
      }
    }

    // 田植え機データエクスポート
    async function exportPlantingData() {
      try {
        const { data, error } = await client
          .from('planting_logs')
          .select(`
            *,
            machines(name),
            operators(name),
            work_types(work_name, category)
          `)
          .order('work_date', { ascending: false });

        if (error) throw error;

        if (!data || data.length === 0) {
          showModal('エクスポート', 'エクスポートするデータがありません');
          return;
        }

        const exportData = data.map(row => ({
          '作業日': row.work_date || '',
          '機械名': row.machines?.name || '',
          'オペレーター': row.operators?.name || '',
          '種別': row.work_types?.category || '',
          '作業内容': row.work_types?.work_name || '',
          '稼働前(h)': row.start_hour || '',
          '稼働後(h)': row.end_hour || '',
          '稼働時間(h)': row.diff_hour || '',
          '備考': row.memo || ''
        }));

        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, '田植え機稼働ログ');

        const now = new Date();
        const fileName = `田植え機稼働ログ_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}.xlsx`;

        XLSX.writeFile(wb, fileName);

        showModal('エクスポート完了', `${data.length}件のデータをエクスポートしました`);
      } catch (error) {
        console.error('エクスポートエラー:', error);
        showModal('エラー', 'データのエクスポートに失敗しました');
      }
    }

    // コンバインデータエクスポート
    async function exportCombineData() {
      try {
        const { data, error } = await client
          .from('combine_logs')
          .select(`
            *,
            machines(name),
            operators(name),
            work_types(work_name, category)
          `)
          .order('work_date', { ascending: false });

        if (error) throw error;

        if (!data || data.length === 0) {
          showModal('エクスポート', 'エクスポートするデータがありません');
          return;
        }

        const exportData = data.map(row => ({
          '作業日': row.work_date || '',
          '機械名': row.machines?.name || '',
          'オペレーター': row.operators?.name || '',
          '種別': row.work_types?.category || '',
          '作業内容': row.work_types?.work_name || '',
          '稼働前(h)': row.start_hour || '',
          '稼働後(h)': row.end_hour || '',
          '稼働時間(h)': row.diff_hour || '',
          '備考': row.memo || ''
        }));

        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'コンバイン稼働ログ');

        const now = new Date();
        const fileName = `コンバイン稼働ログ_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}.xlsx`;

        XLSX.writeFile(wb, fileName);

        showModal('エクスポート完了', `${data.length}件のデータをエクスポートしました`);
      } catch (error) {
        console.error('エクスポートエラー:', error);
        showModal('エラー', 'データのエクスポートに失敗しました');
      }
    }

    // メンテナンスデータエクスポート
    async function exportMaintenanceData() {
      try {
        const { data, error } = await client
          .from('maintenance_records')
          .select(`
            *,
            machines(name)
          `)
          .order('maintenance_date', { ascending: false });

        if (error) throw error;

        if (!data || data.length === 0) {
          showModal('エクスポート', 'エクスポートするデータがありません');
          return;
        }

        const exportData = data.map(row => ({
          'メンテナンス日': row.maintenance_date || '',
          '機械名': row.machines?.name || '',
          'メンテナンス内容': row.maintenance_type || '',
          '詳細': row.details || '',
          '次回予定日': row.next_maintenance_date || '',
          '費用(円)': row.cost || '',
          '備考': row.memo || ''
        }));

        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'メンテナンス記録');

        const now = new Date();
        const fileName = `メンテナンス記録_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}.xlsx`;

        XLSX.writeFile(wb, fileName);

        showModal('エクスポート完了', `${data.length}件のデータをエクスポートしました`);
      } catch (error) {
        console.error('エクスポートエラー:', error);
        showModal('エラー', 'データのエクスポートに失敗しました');
      }
    }

    // 修理データエクスポート
    async function exportRepairData() {
      try {
        const { data, error } = await client
          .from('repair_logs')
          .select(`
            *,
            machines(name)
          `)
          .order('repair_date', { ascending: false });

        if (error) throw error;

        if (!data || data.length === 0) {
          showModal('エクスポート', 'エクスポートするデータがありません');
          return;
        }

        const exportData = data.map(row => ({
          '修理日': row.repair_date || '',
          '機械名': row.machines?.name || '',
          '故障内容': row.issue || '',
          '修理内容': row.repair_details || '',
          '修理先': row.shop || '',
          '費用(円)': row.cost || '',
          '備考': row.memo || ''
        }));

        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, '修理記録');

        const now = new Date();
        const fileName = `修理記録_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}.xlsx`;

        XLSX.writeFile(wb, fileName);

        showModal('エクスポート完了', `${data.length}件のデータをエクスポートしました`);
      } catch (error) {
        console.error('エクスポートエラー:', error);
        showModal('エラー', 'データのエクスポートに失敗しました');
      }
    }

    // ========================================
    // その他の機械セクション用の関数
    // ========================================

    async function initOtherMachineryPage() {
      await populateSelectsOther();
      setDefaultDateOther();
    }

    async function loadOtherMachinerySelects() {
      await populateSelectsOther();
    }

    async function populateSelectsOther() {
      const { data: machines } = await client.from('machines').select('*').eq('machine_type', 'other_machinery').order('name');
      const { data: operators } = await client.from('operators').select('*').order('name');
      const { data: workTypes } = await client.from('work_types').select('*').eq('category', 'その他機械').order('work_name');
      const { data: fuelTypes } = await client.from('fuel_types').select('*').order('name');

      const machineSelect = document.getElementById('machineSelectOther');
      const filterMachineOther = document.getElementById('filterMachineOther');
      machineSelect.innerHTML = '<option value="">機械を選択してください</option>';
      if (filterMachineOther) filterMachineOther.innerHTML = '<option value="">すべての機械</option>';
      if (machines) {
        machines.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.id;
          opt.textContent = m.name;
          machineSelect.appendChild(opt);
          if (filterMachineOther) filterMachineOther.appendChild(opt.cloneNode(true));
        });
      }

      const operatorSelect = document.getElementById('operatorOther');
      const filterOperatorOther = document.getElementById('filterOperatorOther');
      operatorSelect.innerHTML = '<option value="">選択してください</option>';
      if (filterOperatorOther) filterOperatorOther.innerHTML = '<option value="">全オペレーター</option>';
      if (operators) operators.forEach(o => {
        const opt = document.createElement('option');
        opt.value = o.name;
        opt.textContent = o.name;
        operatorSelect.appendChild(opt);
        if (filterOperatorOther) filterOperatorOther.appendChild(opt.cloneNode(true));
      });

      const workNameSelect = document.getElementById('work_nameOther');
      const filterTaskOther = document.getElementById('filterTaskOther');
      workNameSelect.innerHTML = '<option value="">選択してください</option>';
      if (filterTaskOther) filterTaskOther.innerHTML = '<option value="">全作業内容</option>';
      if (workTypes) workTypes.forEach(w => {
        const opt = document.createElement('option');
        opt.value = w.work_name;
        opt.textContent = w.work_name;
        workNameSelect.appendChild(opt);
        if (filterTaskOther) {
          const filterOpt = document.createElement('option');
          filterOpt.value = w.work_name;
          filterOpt.textContent = w.work_name;
          filterTaskOther.appendChild(filterOpt);
        }
      });

      const fuelTypeSelect = document.getElementById('fuelTypeOther');
      fuelTypeSelect.innerHTML = '<option value="">選択してください</option>';
      if (fuelTypes) fuelTypes.forEach(f => {
        const opt = document.createElement('option');
        opt.value = f.id;
        opt.textContent = f.name;
        fuelTypeSelect.appendChild(opt);
      });
    }

    function setDefaultDateOther() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('workDateOther').value = today;
      const filterMonthOther = document.getElementById('filterMonthOther');
      if (filterMonthOther) {
        filterMonthOther.value = today.substring(0, 7);
      }
    }

    async function autoFillHourOther() {
      const machineId = document.getElementById('machineSelectOther').value;
      if (!machineId) return;
      const { data } = await client
        .from('other_machinery_logs')
        .select('end_hour')
        .eq('machine_id', machineId)
        .order('date', { ascending: false })
        .order('created_at', { ascending: false })
        .limit(1);
      if (data && data.length > 0) {
        document.getElementById('hourBeforeOther').value = data[0].end_hour;
        calcDiffOther();
      }
    }

    function calcDiffOther() {
      const before = parseFloat(document.getElementById('hourBeforeOther').value) || 0;
      const after = parseFloat(document.getElementById('hourAfterOther').value) || 0;
      const diff = after - before;
      const disp = document.getElementById('hourDiffDisplayOther');

      // 稼働後のほうが小さい場合に文字を赤くするロジック
      if (after > 0 && after < before) {
        disp.style.color = '#ef4444'; // red-500
        disp.textContent = `稼働時間: 0.0 h (入力エラー)`;
      } else {
        disp.style.color = 'var(--other-color)';
        disp.textContent = `稼働時間: ${diff > 0 ? diff.toFixed(1) : '0.0'} h`;
      }
    }

    async function handleHourAfterImageOther(input) {
      if (!input.files || !input.files[0]) return;
      const file = input.files[0];
      showModal('画像認識', '画像を解析しています...');
      try {
        const base64 = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result.split(',')[1]);
          reader.readAsDataURL(file);
        });
        const res = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${GOOGLE_VISION_API_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            requests: [{ image: { content: base64 }, features: [{ type: 'TEXT_DETECTION' }] }]
          })
        });
        const json = await res.json();
        if (json.responses && json.responses[0].textAnnotations) {
          const text = json.responses[0].textAnnotations[0].description;
          const numbers = text.match(/\d+\.?\d*/g);
          if (numbers && numbers.length > 0) {
            const lastNumber = numbers[numbers.length - 1];
            document.getElementById('hourAfterOther').value = lastNumber;
            calcDiffOther();
            closeModal();
            showModal('認識成功', `数値「${lastNumber}」を検出しました`);
          } else {
            closeModal();
            showModal('認識失敗', '数値が検出できませんでした。手動で入力してください。');
          }
        }
      } catch (error) {
        console.error(error);
        closeModal();
        showModal('エラー', '画像の解析に失敗しました');
      }
    }

    async function saveLogOther() {
      const machineId = document.getElementById('machineSelectOther').value;
      const workDate = document.getElementById('workDateOther').value;
      const operatorId = document.getElementById('operatorOther').value;
      const workNameId = document.getElementById('work_nameOther').value;
      const hourBefore = parseFloat(document.getElementById('hourBeforeOther').value);
      const hourAfter = parseFloat(document.getElementById('hourAfterOther').value);
      const fuelTypeId = document.getElementById('fuelTypeOther').value;
      const fuelAmount = parseFloat(document.getElementById('fuelAmountOther').value) || null;
      const memo = document.getElementById('memoInputOther').value;

      if (!machineId || !workDate || !operatorId || !workNameId || isNaN(hourBefore) || isNaN(hourAfter)) {
        showModal('入力エラー', '必須項目をすべて入力してください');
        return;
      }
      if (hourAfter < hourBefore) {
        showModal('入力エラー', '稼働後の値が稼働前より小さいです');
        return;
      }

      const logData = {
        machine_id: parseInt(machineId),
        date: workDate,
        operator: operatorId || null,
        task: workNameId,
        start_hour: hourBefore,
        end_hour: hourAfter,
        fuel_amount: fuelAmount,
        fuel_type_id: fuelTypeId ? parseInt(fuelTypeId) : null,
        memo: memo,
        created_at: new Date().toISOString()
      };

      showModal('保存確認', '保存しますか？', async () => {
        try {
          const result = await saveData('other_machinery_logs', logData, 'other_logs');

          const message = result.offline ?
            'ログをローカルに保存しました\n（オンライン時に自動同期されます）' :
            'ログを保存しました';

          showModal('保存完了', message);

          document.getElementById('hourBeforeOther').value = hourAfter;
          document.getElementById('hourAfterOther').value = '';
          document.getElementById('fuelAmountOther').value = '';
          document.getElementById('memoInputOther').value = '';
          calcDiffOther();
          loadTodayLogsOther();
        } catch (error) {
          console.error(error);
          showModal('保存失敗', 'ログの保存に失敗しました');
        }
      });
    }

    async function loadTodayLogsOther() {
      const today = new Date().toISOString().split('T')[0];
      const { data, error } = await client
        .from('other_machinery_logs')
        .select(`
          *,
          machines(name, machine_type),
          fuel_types(name)
        `)
        .gte('date', today)
        .lte('date', today)
        .order('created_at', { ascending: false });

      if (error) {
        console.error('loadTodayLogsOther error:', error);
      }

      const container = document.getElementById('todayLogsOther');
      container.innerHTML = '';

      if (!data || data.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-8">本日の稼働ログはまだありません</p>';
        return;
      }

      data.forEach(log => {
        const diff = (log.end_hour - log.start_hour).toFixed(1);
        const card = document.createElement('div');
        card.className = 'card border-l-4 !mb-3 !py-3 flex justify-between items-center';
        card.style.borderColor = 'var(--other-color)';

        const machineName = (log.machines?.name || '不明').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        const operatorName = (log.operator || '不明').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        const taskName = (log.task || '不明').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        const fuelTypeName = (log.fuel_types?.name || '不明').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        const memoText = log.memo ? (log.memo.replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;')) : '';

        card.innerHTML = `
          <div>
            <b class="text-sm">${log.date} - ${machineName}</b>
            <p class="text-xs opacity-70 mt-1">${operatorName} | ${taskName}</p>
            <div class="flex gap-4 mt-2">
              <span class="text-[11px] font-bold log-badge px-2 py-1 rounded"><i class="fa-solid fa-clock mr-1" style="color: var(--other-color)"></i>${diff} h</span>
              ${log.fuel_amount ? `<span class="text-[11px] font-bold log-badge px-2 py-1 rounded"><i class="fa-solid fa-gas-pump mr-1" style="color: var(--other-color)"></i>${log.fuel_amount} L (${fuelTypeName})</span>` : ''}
            </div>
            ${memoText ? `<p class="text-xs text-gray-500 mt-2"><i class="fa-solid fa-memo mr-1"></i>${memoText}</p>` : ''}
          </div>
          <button onclick="deleteLogOther('${log.id}')" class="text-gray-400 p-2 hover:text-red-500 transition-colors">
            <i class="fa-regular fa-trash-can text-lg"></i>
          </button>
        `;
        container.appendChild(card);
      });
    }

    async function loadHistoryOther() {
      const periodType = document.getElementById('filterPeriodTypeOther')?.value || 'month';
      const month = document.getElementById('filterMonthOther').value;
      const year = document.getElementById('filterYearOther').value;
      const machine = document.getElementById('filterMachineOther').value;
      const operator = document.getElementById('filterOperatorOther').value;
      const task = document.getElementById('filterTaskOther').value;

      let query = client
        .from('other_machinery_logs')
        .select(`
          *,
          machines(name, machine_type),
          fuel_types(name)
        `)
        .order('date', { ascending: false });

      if (periodType === 'month' && month) {
        const [yearNum, monthNum] = month.split('-');
        const lastDay = new Date(yearNum, monthNum, 0).getDate();
        query = query.gte('date', `${month}-01`).lte('date', `${month}-${lastDay}`);
      } else if (periodType === 'year' && year) {
        query = query.gte('date', `${year}-01-01`).lte('date', `${year}-12-31`);
      }
      if (machine) query = query.eq('machine_id', machine);
      if (operator) query = query.eq('operator', operator);
      if (task) query = query.eq('task', task);

      const { data, error } = await query;

      if (error) {
        console.error('loadHistoryOther error:', error);
      }

      const container = document.getElementById('historyResultsOther');
      container.innerHTML = '';

      if (!data || data.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-8">該当するログがありません</p>';
        return;
      }

      let total = 0;
      data.forEach(log => {
        const diff = (log.end_hour - log.start_hour);
        total += diff;
        const card = document.createElement('div');
        card.className = 'card border-l-4 !mb-3 !py-3 flex justify-between items-center';
        card.style.borderColor = 'var(--other-color)';

        const machineName = (log.machines?.name || '不明').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        const operatorName = (log.operator || '不明').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        const taskName = (log.task || '不明').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        const fuelTypeName = (log.fuel_types?.name || '不明').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        const memoText = log.memo ? (log.memo.replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;')) : '';

        card.innerHTML = `
          <div>
            <b class="text-sm">${log.date} - ${machineName}</b>
            <p class="text-xs opacity-70 mt-1">${operatorName} | ${taskName}</p>
            <div class="flex gap-4 mt-2">
              <span class="text-[11px] font-bold log-badge px-2 py-1 rounded"><i class="fa-solid fa-clock mr-1" style="color: var(--other-color)"></i>${diff.toFixed(1)} h</span>
              ${log.fuel_amount ? `<span class="text-[11px] font-bold log-badge px-2 py-1 rounded"><i class="fa-solid fa-gas-pump mr-1" style="color: var(--other-color)"></i>${log.fuel_amount} L (${fuelTypeName})</span>` : ''}
            </div>
            ${memoText ? `<p class="text-xs text-gray-500 mt-2"><i class="fa-solid fa-memo mr-1"></i>${memoText}</p>` : ''}
          </div>
          <button onclick="deleteLogOther('${log.id}')" class="text-gray-400 p-2 hover:text-red-500 transition-colors">
            <i class="fa-regular fa-trash-can text-lg"></i>
          </button>
        `;
        container.appendChild(card);
      });

      // 合計時間を表示（履歴画面のみ）
      const totalEl = document.getElementById('historyTotalHoursOther');
      if (totalEl) totalEl.textContent = `合計: ${total.toFixed(1)} h`;
    }

    async function deleteLogOther(id) {
      showModal("削除確認", "このログを削除しますか？", async () => {
        const { error } = await client.from("other_machinery_logs").delete().eq("id", id);
        if (!error) {
          if (document.getElementById("todayViewOther").classList.contains("active")) {
            loadTodayLogsOther();
          } else {
            loadHistoryOther();
          }
        }
      });
    }

    // ========================================
    // ダッシュボードグラフ描画関数
    // ========================================

    // 田植え機ダッシュボード描画関数を更新（グラフ追加）
    async function renderDashboardPlanting(machineId = 'all') {
      const machineTabs = document.getElementById("machineTabsPlanting");
      if (!machineTabs) return;

      window.currentViewMachineIdPlanting = machineId;
      console.log("🌾 田植え機ダッシュボード描画中... ID:", machineId);
      const currentId = machineId;
      const allBtnClass = (currentId === 'all') ? 'active' : 'inactive';

      const { data: plantingMachines } = await client
        .from("machines")
        .select("*")
        .eq("machine_type", "transplanter")
        .order("name");

      let tabsHTML = `
        <button onclick="renderDashboardPlanting('all')" 
                class="tab-btn ${allBtnClass}" 
                style="min-width: 80px; letter-spacing: 0.2em;">全 体</button>
      `;

      if (plantingMachines && plantingMachines.length > 0) {
        tabsHTML += plantingMachines.map(m => {
          const isActive = (String(m.id) === String(currentId)) ? 'active' : 'inactive';
          return `
            <button onclick="renderDashboardPlanting(${m.id})" 
                    class="tab-btn ${isActive}">${m.name}</button>
          `;
        }).join("");
      }
      machineTabs.innerHTML = tabsHTML;

      try {
        // planting_logsデータを取得
        let query = client
          .from("planting_logs")
          .select("*")
          .gte("date", "2026-01-01")
          .order("date", { ascending: false });

        if (machineId !== 'all') {
          query = query.eq("machine_id", machineId);
        }

        const { data, error } = await query;
        if (error) throw error;

        // machine_typeでフィルタ
        const plantingData = data?.filter(log => {
          const machine = plantingMachines?.find(m => m.id === log.machine_id);
          return machine !== undefined;
        }) || [];

        // 関連データを取得
        const { data: workTypes } = await client.from("work_types").select("*");

        // operatorテーブルを取得（単数形で試す）
        let operators = null;
        const { data: operatorsData, error: operatorError } = await client.from("operator").select("*");
        if (operatorError) {
          console.warn("⚠️ operatorテーブル取得エラー（単数形）:", operatorError);
          // 複数形で再試行
          const { data: operatorsDataPlural } = await client.from("operators").select("*");
          operators = operatorsDataPlural;
        } else {
          operators = operatorsData;
        }
        console.log("🔍 取得したオペレーターデータ:", operators);

        const { data: crops } = await client.from("crops").select("*");

        // データを結合
        const enrichedData = plantingData.map(log => ({
          ...log,
          work_types: workTypes?.find(w => w.id === log.work_type_id) || { name: '不明' },
          operators: operators?.find(o => o.id === log.operator_id) || { name: '不明' },
          categories: crops?.find(c => c.id === log.crop_id) || { name: '不明' }
        }));

        console.log("🔍 enrichedDataサンプル:", enrichedData[0]);

        // operator_idがnullでないログを1つ表示（新規登録したログの構造を確認）
        const newLog = plantingData.find(log => log.operator_id !== null);
        if (newLog) {
          console.log("🔍 operator_idがあるログの全データ:", newLog);
          console.log("🔍 このログのカラム名一覧:", Object.keys(newLog));
        }

        if (enrichedData.length === 0) {
          console.warn("⚠️ 田植え機データが見つかりません");
          return;
        }

        // 機械ごとの稼働時間集計
        const summary = {};
        enrichedData.forEach(log => {
          let name = "不明";
          const m = plantingMachines?.find(item => String(item.id) === String(log.machine_id));
          if (m) name = m.name;
          const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
          summary[name] = (summary[name] || 0) + (h > 0 ? h : 0);
        });

        // ランキング表示
        const sorted = Object.entries(summary).sort((a, b) => b[1] - a[1]);
        const rankingContainer = document.getElementById("rankListPlanting");
        if (rankingContainer) {
          const crownColors = ['text-yellow-500', 'text-gray-400', 'text-amber-600'];
          rankingContainer.innerHTML = sorted.slice(0, 3).map(([name, hours], i) => `
            <div class="flex flex-col items-center px-1 text-center" style="min-width: 75px;">
              <div class="mb-1"><i class="fa-solid fa-crown ${crownColors[i]} text-xl"></i></div>
              <span class="text-[10px] font-bold text-gray-700 truncate w-20 leading-tight">${name}</span>
            </div>
          `).join('');
        }

        // KPI集計
        let totalH = 0, totalF = 0;
        const daysSet = new Set();
        enrichedData.forEach(log => {
          const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
          totalH += (h > 0 ? h : 0);
          totalF += (parseFloat(log.fuel_amount) || 0);
          if (log.date) daysSet.add(log.date);
        });

        const fuelAvg = totalH > 0 ? (totalF / totalH).toFixed(2) : "0.00";

        const kpiHours = document.getElementById("kpi-hours-planting");
        const kpiFuel = document.getElementById("kpi-fuel-planting");
        const kpiAvg = document.getElementById("kpi-avg-planting");
        const kpiDays = document.getElementById("kpi-days-planting");

        if (kpiHours) kpiHours.innerText = totalH.toFixed(1);
        if (kpiFuel) kpiFuel.innerText = totalF.toFixed(1);
        if (kpiAvg) kpiAvg.innerText = fuelAvg;
        if (kpiDays) kpiDays.innerText = daysSet.size;

        // グラフ描画
        drawChartsPlanting(enrichedData, plantingMachines);

        // メンテナンスログを読み込む
        loadMaintenanceLogsPlanting(machineId);

      } catch (e) {
        console.error("❌ 田植え機ダッシュボード描画エラー:", e);
        console.error("エラー詳細:", e.message, e.stack);
      }
    }

    // 田植え機のメンテナンスログを読み込む関数
    async function loadMaintenanceLogsPlanting(machineId) {
      const logContainer = document.getElementById('maintenanceLogPlanting');
      if (!logContainer) return;

      try {
        // 田植え機のリストを取得
        let query = client
          .from('machines')
          .select('id, name')
          .eq('machine_type', 'transplanter');

        if (machineId !== 'all') {
          query = query.eq('id', machineId);
        }

        const { data: machines } = await query;
        if (!machines || machines.length === 0) {
          logContainer.innerHTML = `<p class="italic text-gray-400 text-center py-4">履歴はありません</p>`;
          return;
        }

        const plantingIds = machines.map(m => m.id);
        const plantingMap = {};
        machines.forEach(m => plantingMap[m.id] = m.name);

        // メンテナンス完了ログを取得
        const { data: completionLogs } = await client
          .from('maintenance_completion_logs')
          .select('machine_id, machine_name, completion_date, status, created_at')
          .in('machine_id', plantingIds)
          .order('created_at', { ascending: false })
          .limit(3);

        // メンテナンス記録を取得
        const { data: maintenanceRecords } = await client
          .from('maintenance_records')
          .select('machine_id, item_name, date, created_at')
          .in('machine_id', plantingIds)
          .order('created_at', { ascending: false })
          .limit(5);

        let html = '';

        // 完了ログを表示
        if (completionLogs && completionLogs.length > 0) {
          html += completionLogs.map(log => {
            const machineName = log.machine_name || plantingMap[log.machine_id] || '不明';
            const date = new Date(log.completion_date || log.created_at).toLocaleDateString('ja-JP', {
              month: '2-digit',
              day: '2-digit'
            });

            return `
              <div class="flex flex-col border-b border-gray-50 pb-1 mb-1 last:border-0">
                <div class="flex justify-between items-center">
                  <span class="font-bold text-gray-700">${machineName}</span>
                  <span class="text-[9px] text-gray-400">${date}</span>
                </div>
                <div class="text-green-600 flex items-center gap-1">
                  <i class="fa-solid fa-circle-check"></i> <strong style="color:#6b8f71">ALL MAINTENANCE COMPLETE</strong>
                </div>
              </div>
            `;
          }).join('');
        }

        // 個別記録を表示
        if (maintenanceRecords && maintenanceRecords.length > 0) {
          html += maintenanceRecords.map(log => {
            const machineName = plantingMap[log.machine_id] || '不明';
            const date = new Date(log.date || log.created_at).toLocaleDateString('ja-JP', {
              month: '2-digit',
              day: '2-digit'
            });

            return `
              <div class="flex flex-col border-b border-gray-50 pb-1 mb-1 last:border-0">
                <div class="flex justify-between items-center">
                  <span class="font-bold text-gray-700">${machineName}</span>
                  <span class="text-[9px] text-gray-400">${date}</span>
                </div>
                <div class="text-[#c9a961] flex items-center gap-1">
                  <i class="fa-solid fa-check-circle"></i> ${log.item_name} 完了
                </div>
              </div>
            `;
          }).join('');
        }

        if (html) {
          logContainer.innerHTML = html;
        } else {
          logContainer.innerHTML = `<p class="italic text-gray-400 text-center py-4">履歴はありません</p>`;
        }
      } catch (err) {
        console.error('メンテナンスログ取得エラー:', err);
        logContainer.innerHTML = `<p class="italic text-gray-400 text-center py-4">履歴はありません</p>`;
      }
    }

    function drawChartsPlanting(data, plantingMachines) {
      console.log("🎨 田植え機グラフ描画開始:", data.length, "件のデータ");

      // === 1. 月別稼働推移（折れ線グラフ） ===
      const monthData = {};
      data.forEach(log => {
        const month = log.date?.substring(5, 7) || '不明'; // MM形式で取得
        const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
        monthData[month] = (monthData[month] || 0) + (h > 0 ? h : 0);
      });

      // 1～12月のラベルを作成
      const monthLabels = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'];
      const monthValues = monthLabels.map(m => {
        const paddedMonth = m.padStart(2, '0');
        return monthData[paddedMonth] || 0;
      });

      const ctx1 = document.getElementById('monthlyTrendChartPlanting');
      if (ctx1) {
        if (window.monthlyTrendChartPlantingInstance) window.monthlyTrendChartPlantingInstance.destroy();
        window.monthlyTrendChartPlantingInstance = new Chart(ctx1, {
          type: 'line',
          data: {
            labels: monthLabels,
            datasets: [{
              label: 'h',
              data: monthValues,
              borderColor: '#c9a961',
              backgroundColor: 'rgba(201, 169, 97, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            }
          }
        });
      }

      // === 2. 作業内容別稼働時間（縦棒グラフ） ===
      const taskData = {};
      data.forEach(log => {
        const task = log.task || '不明';
        // 「選択」を除外
        if (task === '選択') return;
        const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
        taskData[task] = (taskData[task] || 0) + (h > 0 ? h : 0);
      });

      const sortedTasks = Object.entries(taskData).sort((a, b) => b[1] - a[1]);
      const ctx2 = document.getElementById('taskHoursChartPlanting');
      if (ctx2) {
        if (window.taskHoursChartPlantingInstance) window.taskHoursChartPlantingInstance.destroy();
        window.taskHoursChartPlantingInstance = new Chart(ctx2, {
          type: 'bar',
          data: {
            labels: sortedTasks.map(t => t[0]),
            datasets: [{
              label: '稼働時間',
              data: sortedTasks.map(t => t[1]),
              backgroundColor: ['#c9a961', '#b8985a', '#a08550', '#8f7448', '#7d6340'],
              borderRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.parsed.y.toFixed(1)} h`
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: { callback: (value) => value + ' h' }
              }
            }
          }
        });
      }

      // === 3. 機械別稼働ランキング（横棒グラフ） ===
      const machineData = {};
      data.forEach(log => {
        const machine = plantingMachines?.find(m => m.id === log.machine_id);
        const name = machine?.name || '不明';
        const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
        machineData[name] = (machineData[name] || 0) + (h > 0 ? h : 0);
      });

      const sortedMachines = Object.entries(machineData).sort((a, b) => b[1] - a[1]);
      const ctx3 = document.getElementById('machineRankingChartPlanting');
      if (ctx3) {
        if (window.machineRankingChartPlantingInstance) window.machineRankingChartPlantingInstance.destroy();
        window.machineRankingChartPlantingInstance = new Chart(ctx3, {
          type: 'bar',
          data: {
            labels: sortedMachines.map(m => m[0]),
            datasets: [{
              label: 'h',
              data: sortedMachines.map(m => m[1]),
              backgroundColor: sortedMachines.map((_, i) => `rgba(201, 169, 97, ${Math.max(0.2, 1 - (i / 5))})`),
              borderRadius: 4
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            }
          }
        });
      }

      // === 4. オペレーター別比率（ドーナツグラフ） ===
      const operatorData = {};
      data.forEach(log => {
        const op = log.operators?.name || '不明';
        const start = parseFloat(log.start_hour);
        const end = parseFloat(log.end_hour);
        const h = (end || 0) - (start || 0);
        console.log("オペレーター処理:", {
          op,
          operator_id: log.operator_id,
          start_hour: log.start_hour,
          end_hour: log.end_hour,
          calculated_hours: h,
          operators: log.operators
        });
        operatorData[op] = (operatorData[op] || 0) + (h > 0 ? h : 0);
      });

      console.log("🔍 オペレーターデータ:", operatorData);

      // 0時間のオペレーターを除外し、降順でソート
      const operatorEntries = Object.entries(operatorData)
        .filter(([name, hours]) => hours > 0)
        .sort((a, b) => b[1] - a[1]);

      if (operatorEntries.length === 0) {
        console.warn("⚠️ オペレーター別比率: データがありません");
      }

      const operatorLabels = operatorEntries.map(e => e[0]);
      const operatorValues = operatorEntries.map(e => e[1]);
      const operatorColors = ['#c9a961', '#b8985a', '#a08550', '#8f7448', '#7d6340', '#6d5838', '#5d4930'];
      const operatorBgColors = operatorLabels.map((_, i) => operatorColors[i % operatorColors.length]);

      console.log("🎨 ラベル順:", operatorLabels);
      console.log("🎨 値順:", operatorValues);
      console.log("🎨 色順:", operatorBgColors);

      const ctx4 = document.getElementById('operatorShareChartPlanting');
      if (ctx4) {
        if (window.operatorShareChartPlantingInstance) {
          window.operatorShareChartPlantingInstance.destroy();
        }

        if (operatorEntries.length > 0) {
          window.operatorShareChartPlantingInstance = new Chart(ctx4, {
            type: 'doughnut',
            data: {
              labels: operatorLabels,
              datasets: [{
                data: operatorValues,
                backgroundColor: operatorBgColors,
                borderWidth: 2,
                borderColor: '#fff'
              }]
            },
            options: {
              cutout: '60%',
              responsive: true,
              maintainAspectRatio: false,
              layout: {
                padding: {
                  left: 0,
                  right: 10,
                  top: 0,
                  bottom: 0
                }
              },
              plugins: {
                legend: {
                  position: 'right',
                  align: 'center',
                  labels: {
                    boxWidth: 10,
                    font: { size: 9 },
                    padding: 4
                  }
                },
                tooltip: {
                  callbacks: {
                    label: (context) => {
                      const label = context.label || '';
                      const value = context.parsed;
                      const total = context.dataset.data.reduce((a, b) => a + b, 0);
                      const percentage = ((value / total) * 100).toFixed(1);
                      return `${label}: ${value.toFixed(1)} h (${percentage}%)`;
                    }
                  }
                }
              }
            }
          });
        }
      }

      // === 5. 燃費効率の計算と表示 ===
      let totalHours = 0;
      let totalFuel = 0;
      data.forEach(log => {
        const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
        totalHours += (h > 0 ? h : 0);
        totalFuel += (parseFloat(log.fuel_amount) || 0);
      });

      const fuelEfficiency = totalHours > 0 ? (totalFuel / totalHours) : 0;

      const fuelEfficiencyEl = document.getElementById('fuelEfficiencyValuePlanting');
      const totalFuelEl = document.getElementById('totalFuelPlanting');
      const totalHoursEl = document.getElementById('totalHoursPlanting');

      if (fuelEfficiencyEl) fuelEfficiencyEl.textContent = fuelEfficiency.toFixed(2);
      if (totalFuelEl) totalFuelEl.textContent = totalFuel.toFixed(1);
      if (totalHoursEl) totalHoursEl.textContent = totalHours.toFixed(1);

      console.log("✅ 田植え機グラフ描画完了");
    }

    // コンバインダッシュボード描画関数
    async function renderDashboardCombine(machineId = 'all') {
      const machineTabs = document.getElementById("machineTabsCombine");
      if (!machineTabs) return;

      window.currentViewMachineIdCombine = machineId;
      console.log("🌾 コンバインダッシュボード描画中... ID:", machineId);
      const currentId = machineId;
      const allBtnClass = (currentId === 'all') ? 'active' : 'inactive';

      const { data: combineMachines } = await client
        .from("machines")
        .select("*")
        .eq("machine_type", "combine")
        .order("name");

      let tabsHTML = `
        <button onclick="renderDashboardCombine('all')" 
                class="tab-btn ${allBtnClass}" 
                style="min-width: 80px; letter-spacing: 0.2em;">全 体</button>
      `;

      if (combineMachines && combineMachines.length > 0) {
        tabsHTML += combineMachines.map(m => {
          const isActive = (String(m.id) === String(currentId)) ? 'active' : 'inactive';
          return `
            <button onclick="renderDashboardCombine(${m.id})" 
                    class="tab-btn ${isActive}">${m.name}</button>
          `;
        }).join("");
      }
      machineTabs.innerHTML = tabsHTML;

      try {
        // combine_logsデータを取得
        let query = client
          .from("combine_logs")
          .select("*")
          .gte("date", "2026-01-01")
          .order("date", { ascending: false });

        if (machineId !== 'all') {
          query = query.eq("machine_id", machineId);
        }

        const { data, error } = await query;
        if (error) throw error;

        const combineData = data?.filter(log => {
          const machine = combineMachines?.find(m => m.id === log.machine_id);
          return machine !== undefined;
        }) || [];

        // 関連データを取得
        const { data: workTypes } = await client.from("work_types").select("*");
        const { data: operators } = await client.from("operators").select("*");
        const { data: categories } = await client.from("categories").select("*");

        // データを結合
        const enrichedCombineData = combineData.map(log => ({
          ...log,
          work_types: workTypes?.find(w => w.id === log.work_type_id) || { name: '不明' },
          operators: operators?.find(o => o.id === log.operator_id) || { name: '不明' },
          categories: categories?.find(c => c.id === log.category_id) || { name: '不明' }
        }));

        if (enrichedCombineData.length === 0) {
          console.warn("⚠️ コンバインデータが見つかりません");
          return;
        }

        // 機械ごとの稼働時間集計
        const summary = {};
        enrichedCombineData.forEach(log => {
          let name = "不明";
          const m = combineMachines?.find(item => String(item.id) === String(log.machine_id));
          if (m) name = m.name;
          const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
          summary[name] = (summary[name] || 0) + (h > 0 ? h : 0);
        });

        const sorted = Object.entries(summary).sort((a, b) => b[1] - a[1]);
        const rankingContainer = document.getElementById("rankListCombine");
        if (rankingContainer) {
          const crownColors = ['text-yellow-500', 'text-gray-400', 'text-amber-600'];
          rankingContainer.innerHTML = sorted.slice(0, 3).map(([name, hours], i) => `
            <div class="flex flex-col items-center px-1 text-center" style="min-width: 75px;">
              <div class="mb-1"><i class="fa-solid fa-crown ${crownColors[i]} text-xl"></i></div>
              <span class="text-[10px] font-bold text-gray-700 truncate w-20 leading-tight">${name}</span>
            </div>
          `).join('');
        }

        // KPI集計
        let totalH = 0, totalF = 0;
        const daysSet = new Set();
        enrichedCombineData.forEach(log => {
          const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
          totalH += (h > 0 ? h : 0);
          totalF += (parseFloat(log.fuel_amount) || 0);
          if (log.date) daysSet.add(log.date);
        });

        const fuelAvg = totalH > 0 ? (totalF / totalH).toFixed(2) : "0.00";

        const kpiHours = document.getElementById("kpi-hours-combine");
        const kpiFuel = document.getElementById("kpi-fuel-combine");
        const kpiAvg = document.getElementById("kpi-avg-combine");
        const kpiDays = document.getElementById("kpi-days-combine");

        if (kpiHours) kpiHours.innerText = totalH.toFixed(1);
        if (kpiFuel) kpiFuel.innerText = totalF.toFixed(1);
        if (kpiAvg) kpiAvg.innerText = fuelAvg;
        if (kpiDays) kpiDays.innerText = daysSet.size;

        drawChartsCombine(enrichedCombineData);

      } catch (e) {
        console.error("❌ コンバインダッシュボード描画エラー:", e);
        console.error("エラー詳細:", e.message, e.stack);
      }
    }

    function drawChartsCombine(data) {
      const categoryData = {};
      data.forEach(log => {
        const cat = log.categories?.name || '不明';
        const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
        categoryData[cat] = (categoryData[cat] || 0) + (h > 0 ? h : 0);
      });

      const ctx1 = document.getElementById('categoryShareChartCombine');
      if (ctx1) {
        if (window.categoryShareChartCombineInstance) window.categoryShareChartCombineInstance.destroy();

        // 機械別修理コストのダミーデータ
        const rawData = [
          { label: 'ER470', value: 80000 },
          { label: '丸山1030', value: 30000 },
          { label: 'WB1040YH', value: 7000 }
        ];

        // 金額が高い順に並べ替え
        rawData.sort((a, b) => b.value - a.value);

        const sortedLabels = rawData.map(d => d.label);
        const sortedValues = rawData.map(d => d.value);

        // グラデーション色の計算
        const maxVal = sortedValues[0];
        const backgroundColors = sortedValues.map(val => {
          const opacity = 0.3 + (val / maxVal) * 0.7;
          return `rgba(201, 124, 115, ${opacity})`;
        });

        window.categoryShareChartCombineInstance = new Chart(ctx1, {
          type: 'bar',
          data: {
            labels: sortedLabels,
            datasets: [{
              label: 'コスト',
              data: sortedValues,
              backgroundColor: backgroundColors,
              borderRadius: 4,
              barThickness: 15
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { display: false },
              y: {
                grid: { display: false },
                ticks: { font: { size: 11, weight: 'bold' } }
              }
            },
            plugins: { legend: { display: false } }
          }
        });
      }

      const taskData = {};
      data.forEach(log => {
        const task = log.task || '不明';
        const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
        taskData[task] = (taskData[task] || 0) + (h > 0 ? h : 0);
      });

      const ctx2 = document.getElementById('taskShareChartCombine');
      if (ctx2) {
        if (window.taskShareChartCombineInstance) window.taskShareChartCombineInstance.destroy();
        window.taskShareChartCombineInstance = new Chart(ctx2, {
          type: 'doughnut',
          data: {
            labels: Object.keys(taskData),
            datasets: [{
              data: Object.values(taskData),
              backgroundColor: ['#c97c73', '#b86b62', '#a75a51', '#964940', '#854830']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'right',
                labels: {
                  boxWidth: 10,
                  font: { size: 9 },
                  padding: 6
                }
              }
            }
          }
        });
      }

      const operatorData = {};
      data.forEach(log => {
        const op = log.operators?.name || '不明';
        const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
        operatorData[op] = (operatorData[op] || 0) + (h > 0 ? h : 0);
      });

      const ctx3 = document.getElementById('operatorShareChartCombine');
      if (ctx3) {
        if (window.operatorShareChartCombineInstance) window.operatorShareChartCombineInstance.destroy();
        window.operatorShareChartCombineInstance = new Chart(ctx3, {
          type: 'doughnut',
          data: {
            labels: Object.keys(operatorData),
            datasets: [{
              data: Object.values(operatorData),
              backgroundColor: ['#c97c73', '#b86b62', '#a75a51', '#964940']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'right',
                labels: {
                  boxWidth: 10,
                  font: { size: 9 },
                  padding: 6
                }
              }
            }
          }
        });
      }

      const monthData = {};
      data.forEach(log => {
        const month = log.date?.substring(5, 7) || '不明'; // MM形式で取得
        const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
        monthData[month] = (monthData[month] || 0) + (h > 0 ? h : 0);
      });

      // 1～12月のラベルを作成
      const monthLabels = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'];
      const monthValues = monthLabels.map(m => {
        const paddedMonth = m.padStart(2, '0');
        return monthData[paddedMonth] || 0;
      });

      const ctx4 = document.getElementById('detailChartCombine');
      if (ctx4) {
        if (window.detailChartCombineInstance) window.detailChartCombineInstance.destroy();
        window.detailChartCombineInstance = new Chart(ctx4, {
          type: 'line',
          data: {
            labels: monthLabels,
            datasets: [{
              label: 'h',
              data: monthValues,
              borderColor: '#c97c73',
              backgroundColor: 'rgba(201, 124, 115, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
      }

      const ctx5 = document.getElementById('gradientBarChartCombine');
      if (ctx5) {
        if (window.gradientBarChartCombineInstance) window.gradientBarChartCombineInstance.destroy();

        // 稼働時間が多い順にソート
        const sorted = Object.entries(taskData).sort((a, b) => b[1] - a[1]);

        window.gradientBarChartCombineInstance = new Chart(ctx5, {
          type: 'bar',
          data: {
            labels: sorted.map(t => t[0]),
            datasets: [{
              label: 'h',
              data: sorted.map(t => t[1]),
              backgroundColor: sorted.map((_, i) => `rgba(201, 124, 115, ${Math.max(0.2, 1 - (i / 5))})`),
              borderRadius: 4
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
          }
        });
      }
    }

    // その他の機械ダッシュボード描画関数
    async function renderDashboardOther(machineId = 'all') {
      // その他の機械専用の修理コスト集計を呼び出す
      if (typeof loadRepairDashboardOther === 'function') {
        await loadRepairDashboardOther();
      }
      const machineTabs = document.getElementById("machineTabsOther");
      if (!machineTabs) return;

      window.currentViewMachineIdOther = machineId;
      console.log("🔧 その他の機械ダッシュボード描画中... ID:", machineId);
      const currentId = machineId;
      const allBtnClass = (currentId === 'all') ? 'active' : 'inactive';

      const { data: otherMachines } = await client
        .from("machines")
        .select("*")
        .eq("machine_type", "other_machinery")
        .order("name");

      let tabsHTML = `
        <button onclick="renderDashboardOther('all')" 
                class="tab-btn ${allBtnClass}" 
                style="min-width: 80px; letter-spacing: 0.2em;">全 体</button>
      `;

      if (otherMachines && otherMachines.length > 0) {
        tabsHTML += otherMachines.map(m => {
          const isActive = (String(m.id) === String(currentId)) ? 'active' : 'inactive';
          return `
            <button onclick="renderDashboardOther(${m.id})" 
                    class="tab-btn ${isActive}">${m.name}</button>
          `;
        }).join("");
      }
      machineTabs.innerHTML = tabsHTML;

      try {
        // other_machinery_logsデータを取得
        let query = client
          .from("other_machinery_logs")
          .select("*")
          .gte("date", "2026-01-01")
          .order("date", { ascending: false });

        if (machineId !== 'all') {
          query = query.eq("machine_id", machineId);
        }

        const { data, error } = await query;
        if (error) throw error;

        const otherData = data?.filter(log => {
          const machine = otherMachines?.find(m => m.id === log.machine_id);
          return machine !== undefined;
        }) || [];

        // 関連データを取得
        const { data: workTypes } = await client.from("work_types").select("*").eq("category", "その他機械");
        // 1. その他の機械IDリストを作成
        const otherMachineIds = otherMachines.map(m => m.id);
        // 2. IDリストに含まれる修理ログだけを取得
        const { data: repairLogs, error: repairError } = await client
          .from("repair_logs")
          .select("*")
          .in("machine_id", otherMachineIds);
        if (repairError) console.error("修理ログ取得失敗:", repairError);
        const { data: operators } = await client.from("operators").select("*");

        // データを結合
        const enrichedOtherData = otherData.map(log => ({
          ...log,
          work_types: workTypes?.find(w => w.id === log.work_type_id) || { name: '不明' },
        }));

        // 機械別修理コスト集計用データ（金額）
        const repairCostByMachine = {};
        if (repairLogs && repairLogs.length > 0 && otherMachines) {
          repairLogs.forEach(r => {
            // 機械IDから機械名を取得
            const machine = otherMachines.find(m => String(m.id) === String(r.machine_id));
            const name = machine ? machine.name : '不明';
            const cost = parseFloat(r.cost) || 0;
            repairCostByMachine[name] = (repairCostByMachine[name] || 0) + cost;
          });
        }
        // グローバル変数にセット
        window.repairCostByMachine = repairCostByMachine;

        if (enrichedOtherData.length === 0) {
          console.warn("⚠️ その他の機械データが見つかりません");
          return;
        }

        // 機械ごとの稼働時間集計
        const summary = {};
        enrichedOtherData.forEach(log => {
          let name = "不明";
          const m = otherMachines?.find(item => String(item.id) === String(log.machine_id));
          if (m) name = m.name;
          const h = (parseFloat(log.hour_end) || 0) - (parseFloat(log.hour_start) || 0);
          summary[name] = (summary[name] || 0) + (h > 0 ? h : 0);
        });

        const sorted = Object.entries(summary).sort((a, b) => b[1] - a[1]);
        const rankingContainer = document.getElementById("rankListOther");
        if (rankingContainer) {
          const crownColors = ['text-yellow-500', 'text-gray-400', 'text-amber-600'];
          rankingContainer.innerHTML = sorted.slice(0, 3).map(([name, hours], i) => `
            <div class="flex flex-col items-center px-1 text-center" style="min-width: 75px;">
              <div class="mb-1"><i class="fa-solid fa-crown ${crownColors[i]} text-xl"></i></div>
              <span class="text-[10px] font-bold text-gray-700 truncate w-20 leading-tight">${name}</span>
            </div>
          `).join('');
        }

        // KPI集計
        let totalH = 0, totalF = 0;
        const daysSet = new Set();
        enrichedOtherData.forEach(log => {
          const h = (parseFloat(log.hour_end) || 0) - (parseFloat(log.hour_start) || 0);
          totalH += (h > 0 ? h : 0);
          totalF += (parseFloat(log.fuel_amount) || 0);
          if (log.date) daysSet.add(log.date);
        });

        const fuelAvg = totalH > 0 ? (totalF / totalH).toFixed(2) : "0.00";

        const kpiHours = document.getElementById("kpi-hours-other");
        const kpiFuel = document.getElementById("kpi-fuel-other");
        const kpiAvg = document.getElementById("kpi-avg-other");
        const kpiDays = document.getElementById("kpi-days-other");

        if (kpiHours) kpiHours.innerText = totalH.toFixed(1);
        if (kpiFuel) kpiFuel.innerText = totalF.toFixed(1);
        if (kpiAvg) kpiAvg.innerText = fuelAvg;
        if (kpiDays) kpiDays.innerText = daysSet.size;

        // 描画タイミングを遅らせてcanvas要素の存在を保証
        setTimeout(() => {
          drawChartsOther(enrichedOtherData);
        }, 200);

        // ...existing code...（maintenanceLogOtherの描画処理を削除）

      } catch (e) {
        console.error("❌ その他の機械ダッシュボード描画エラー:", e);
        console.error("エラー詳細:", e.message, e.stack);
      }
    }

    // 全ての処理が終わった最後に履歴を呼ぶ
    loadMaintenanceLogsOther();

    function drawChartsOther(data) {
      console.log("📊 グラフ描画開始！データ件数:", data.length);
      console.log("📊 生データサンプル:", data[0]);
      if (data.length === 0) {
        console.warn("⚠️ データが0件なのでグラフは描画されません");
        return;
      }
      const categoryData = {};
      data.forEach(log => {
        const cat = log.work_types?.category || '不明';
        const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
        categoryData[cat] = (categoryData[cat] || 0) + (h > 0 ? h : 0);
      });
      console.log("カテゴリ別集計:", categoryData);

      // グローバル変数から修理コスト集計データを取得
      if (window.repairCostByMachine) {
        console.log("修理コスト集計データ:", window.repairCostByMachine);
        const ctx1 = document.getElementById('categoryShareChartOther');
        if (ctx1) {
          console.log("categoryShareChartOther描画");
          if (window.categoryShareChartOtherInstance) window.categoryShareChartOtherInstance.destroy();
          window.categoryShareChartOtherInstance = new Chart(ctx1, {
            type: 'bar',
            data: {
              labels: Object.keys(window.repairCostByMachine),
              datasets: [{
                label: '修理コスト（円）',
                data: Object.values(window.repairCostByMachine),
                backgroundColor: [
                  'rgba(120,0,0,1)',
                  'rgba(150,20,20,0.85)',
                  'rgba(180,40,40,0.7)',
                  'rgba(210,60,60,0.55)'
                ],
                borderRadius: 5,
                barPercentage: 0.7
              }]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } }
            }
          });
          console.log("categoryShareChartOther描画完了");
        }
      }

      const taskData = {};
      data.forEach(log => {
        const task = log.task || '不明';
        const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
        taskData[task] = (taskData[task] || 0) + (h > 0 ? h : 0);
      });
      console.log("作業種別集計:", taskData);

      const ctx2 = document.getElementById('taskShareChartOther');
      if (ctx2) {
        console.log("taskShareChartOther描画");
        if (window.taskShareChartOtherInstance) window.taskShareChartOtherInstance.destroy();
        console.trace("今、横棒を描画しようとしています！");
        window.taskShareChartOtherInstance = new Chart(ctx2, {
          type: 'bar',
          data: {
            labels: Object.keys(taskData),
            datasets: [{
              label: '作業内容別稼働時間',
              data: Object.values(taskData),
              backgroundColor: [
                '#006888',
                'rgba(0, 104, 136, 0.7)',
                'rgba(0, 104, 136, 0.5)',
                'rgba(0, 104, 136, 0.3)',
                'rgba(0, 104, 136, 0.15)'
              ],
              borderColor: '#006888',
              borderWidth: 2,
              borderRadius: 6
            }]
          },
          options: {
            indexAxis: 'y', // 横棒グラフに強制
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { beginAtZero: true },
              y: { beginAtZero: true }
            }
          }
        });
        console.log("taskShareChartOther描画完了");
      }

      const operatorData = {};
      data.forEach(log => {
        const op = log.operator || '不明';
        const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
        operatorData[op] = (operatorData[op] || 0) + (h > 0 ? h : 0);
      });
      console.log("オペレーター別集計:", operatorData);

      const ctx3 = document.getElementById('operatorShareChartOther');
      if (ctx3) {
        console.log("operatorShareChartOther描画");
        if (window.operatorShareChartOtherInstance) window.operatorShareChartOtherInstance.destroy();
        window.operatorShareChartOtherInstance = new Chart(ctx3, {
          type: 'doughnut',
          data: {
            labels: Object.keys(operatorData),
            datasets: [{
              data: Object.values(operatorData),
              backgroundColor: ['#006888', '#005270', '#004158', '#003040']
            }]
          },
          options: {
            cutout: '45%',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'right',
                padding: 50,
                labels: {
                  boxWidth: 10,
                  font: { size: 9 },
                  padding: 18
                }
              }
            }
          }
        });
        console.log("operatorShareChartOther描画完了");
      }

      const monthData = {};
      const monthlyCounts = Array(12).fill(0);
      data.forEach(log => {
        console.log("月別集計データ確認:", log);
        if (log.date) {
          const dateObj = new Date(log.date);
          const month = dateObj.getMonth(); // 0=1月, 1=2月...
          // カラム名をスクショに合わせて修正
          const h = (parseFloat(log.end_hour) || 0) - (parseFloat(log.start_hour) || 0);
          if (month >= 0 && month < 12) {
            monthlyCounts[month] += (h > 0 ? h : 0);
          }
        }
      });
      console.log("月別集計:", monthlyCounts);

      // 1～12月のラベルを作成
      const monthLabels = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'];
      const monthValues = monthlyCounts;
      console.log("月別グラフラベル:", monthLabels);
      console.log("月別グラフ値:", monthValues);

      const ctx4 = document.getElementById('detailChartOther');
      if (ctx4) {
        console.log("detailChartOther描画");
        if (window.detailChartOtherInstance) window.detailChartOtherInstance.destroy();
        window.detailChartOtherInstance = new Chart(ctx4, {
          type: 'line',
          data: {
            labels: monthLabels.map(m => m + '月'),
            datasets: [{
              label: '稼働時間',
              data: monthValues,
              borderColor: '#006888',
              backgroundColor: 'rgba(0, 104, 136, 0.15)',
              pointBackgroundColor: '#006888',
              pointBorderColor: '#006888',
              tension: 0.4,
              fill: true
            }]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
        console.log("detailChartOther描画完了");
      }

      const ctx5 = document.getElementById('gradientBarChartOther');
      if (ctx5) {
        console.log("gradientBarChartOther描画");
        if (window.gradientBarChartOtherInstance) window.gradientBarChartOtherInstance.destroy();
        window.gradientBarChartOtherInstance = new Chart(ctx5, {
          type: 'bar',
          data: {
            labels: Object.keys(taskData),
            datasets: [{
              label: '稼働時間',
              data: Object.values(taskData),
              backgroundColor: [
                '#006888',
                'rgba(0, 104, 136, 0.7)',
                'rgba(0, 104, 136, 0.5)',
                'rgba(0, 104, 136, 0.3)',
                'rgba(0, 104, 136, 0.15)'
              ],
              borderRadius: 8
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
          }
        });
        console.log("gradientBarChartOther描画完了");
      }
    }

    // ========================================
    // その他の機械メンテナンス関数
    // ========================================

    // その他の機械メンテナンスリスト読み込み
    async function loadMachineListOtherMachinery() {
      try {
        const { data: machines, error } = await client
          .from("machines")
          .select("*")
          .eq("machine_type", "other_machinery")
          .order("id");

        if (error) throw error;

        const container = document.getElementById("maintenanceMachineGridOtherMachinery");
        if (!container) return;
        container.innerHTML = machines.length === 0
          ? "<p class='text-gray-400 text-center py-8'>その他の機械が登録されていません</p>"
          : "";

        const grid = document.createElement("div");
        grid.className = "grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-4";

        for (const m of machines) {
          const card = document.createElement("div");
          card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-all active:scale-95";
          card.onclick = () => openMaintenanceDetailOtherMachinery(m.id);

          card.innerHTML = `
            <div class="flex flex-col gap-2">
              <div class="flex items-center gap-3">
                <div style="color: var(--other-color);" class="text-xl flex-shrink-0">
                  <i class="fas fa-tachometer-alt"></i>
                </div>
                <div class="font-bold text-gray-900 text-sm leading-tight break-words">${m.name}</div>
              </div>
              <div class="border-t border-gray-50 pt-2" id="card-progress-other-${m.id}">
                <div class="text-[11px] text-gray-400 flex items-center gap-1">
                  <i class="fa-solid fa-circle-notch fa-spin text-[9px]"></i> 確認中...
                </div>
              </div>
            </div>
          `;
          grid.appendChild(card);

          // 進捗状況を非同期で取得
          (async () => {
            try {
              // 機械名からsub_typeを判定
              let subType = null;
              if (m.name.includes('ローダー')) {
                subType = 'loader';
              } else if (m.name.includes('フォークリフト')) {
                subType = 'forklift';
              } else if (m.name.includes('藁収集機') || m.name.includes('SR1021')) {
                subType = 'collector';
              } else if (m.name.includes('マニアスプレッダー')) {
                subType = 'manure_spreader';
              }

              let itemsQuery = client
                .from('maintenance_items_other_machinery')
                .select('id');

              if (subType) {
                itemsQuery = itemsQuery.eq('sub_type', subType);
              }

              const { data: items } = await itemsQuery;

              const totalItems = items ? items.length : 0;

              if (totalItems === 0) {
                const progressDiv = document.getElementById(`card-progress-other-${m.id}`);
                if (progressDiv) {
                  progressDiv.innerHTML = `
                    <div class="text-[11px] flex items-center gap-1">
                      <span class="text-gray-400">点検項目なし</span>
                    </div>
                  `;
                }
                return;
              }

              const { data: checks } = await client
                .from('maintenance_status')
                .select('item_id, status')
                .filter('item_id', 'ilike', `${m.id}_%`);

              const uniqueChecks = {};
              if (checks) {
                checks.forEach(c => { uniqueChecks[c.item_id] = c.status; });
              }
              const checkedCount = Object.values(uniqueChecks).filter(s => Boolean(s) === true).length;
              let percentage = Math.round((checkedCount / totalItems) * 100);
              percentage = Math.min(100, percentage);

              const progressDiv = document.getElementById(`card-progress-other-${m.id}`);
              if (progressDiv) {
                let statusHTML = percentage === 0
                  ? `<span class="text-red-600 font-black"><i class="fa-solid fa-circle-exclamation text-[9px]"></i> 未着手</span>`
                  : percentage === 100
                    ? `<span style="color: var(--other-color);" class="font-black"><i class="fa-solid fa-circle-check text-[9px]"></i> 完了</span>`
                    : `<span class="text-orange-500 font-black"><i class="fa-solid fa-spinner text-[9px]"></i> ${percentage}% 完了</span>`;

                progressDiv.innerHTML = `
                  <div class="text-[11px] flex items-center gap-1">${statusHTML}</div>
                  <div class="w-full bg-gray-100 rounded-full h-1 mt-1">
                    <div class="h-1 rounded-full transition-all duration-500" style="width: ${percentage}%; background: var(--other-color);"></div>
                  </div>
                `;
              }
            } catch (e) {
              console.error('進捗取得エラー:', e);
            }
          })();
        }
        container.appendChild(grid);
      } catch (e) {
        console.error("その他の機械一覧読み込みエラー:", e);
      }
    }

    // その他の機械メンテナンス詳細を開く
    async function openMaintenanceDetailOtherMachinery(machineId) {
      console.log('その他の機械詳細ページを開きます。機械ID:', machineId);
      window.currentMachineIdOtherMachinery = machineId;
      switchView('maintenanceDetailViewOtherMachinery');

      try {
        const { data: machine } = await client.from("machines").select("*").eq("id", machineId).single();
        document.getElementById("maintenanceMachineNameOtherMachinery").textContent = machine.name;

        // 機械名からsub_typeを判定
        let subType = null;
        if (machine.name.includes('ローダー')) {
          subType = 'loader';
        } else if (machine.name.includes('フォークリフト')) {
          subType = 'forklift';
        } else if (machine.name.includes('藁収集機') || machine.name.includes('SR1021')) {
          subType = 'collector';
        } else if (machine.name.includes('マニアスプレッダー')) {
          subType = 'manure_spreader';
        }

        const { data: operators } = await client.from('operators').select('name').order('id');
        const opSelect = document.getElementById('newMaintenanceOperatorOtherMachinery');
        if (opSelect && operators) {
          opSelect.innerHTML = '<option value="">担当者を選択</option>';
          operators.forEach(op => {
            const opt = document.createElement('option');
            opt.value = op.name;
            opt.textContent = op.name;
            opSelect.appendChild(opt);
          });
        }

        // sub_typeでフィルタリングして点検項目を取得
        let itemsQuery = client
          .from('maintenance_items_other_machinery')
          .select('*')
          .order('id');

        if (subType) {
          itemsQuery = itemsQuery.eq('sub_type', subType);
        }

        const { data: items } = await itemsQuery;

        const checklistDiv = document.getElementById('maintenanceChecklistOtherMachinery');
        checklistDiv.innerHTML = '';

        if (!items || items.length === 0) {
          checklistDiv.innerHTML = '<p class="text-gray-400 text-center py-4">点検項目が登録されていません</p>';
        } else {
          items.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex items-center justify-between p-3 border-b border-gray-50 last:border-0 hover:bg-gray-50 transition-colors';
            const uniqueId = `${machineId}_${item.id}`;

            itemDiv.innerHTML = `
              <div class="flex flex-col flex-1 text-left">
                <span class="text-sm font-bold text-gray-700">${item.item_name}</span>
                <span class="text-[10px] text-gray-400">${item.description || ''}</span>
              </div>
              <input type="checkbox" id="check-other-${uniqueId}" data-item-id="${uniqueId}"
                class="w-6 h-6 rounded border-gray-300" 
                style="accent-color: var(--other-color);"
                onchange="saveSingleCheckOtherMachinery(this)">
            `;
            checklistDiv.appendChild(itemDiv);
          });

          restoreMaintenanceChecksOtherMachinery();
        }

        await updateMaintenanceProgressOtherMachinery();
        await loadMaintenanceHistoryOtherMachinery(machineId);

      } catch (err) {
        console.error('その他の機械詳細読み込みエラー:', err);
      }
    }

    // チェックボックス保存
    async function saveSingleCheckOtherMachinery(checkbox) {
      const itemId = checkbox.dataset.itemId;
      const isChecked = checkbox.checked;

      try {
        const { error } = await client
          .from('maintenance_status')
          .upsert({
            item_id: itemId,
            status: isChecked,
            updated_at: new Date().toISOString()
          }, { onConflict: 'item_id' });

        if (error) throw error;
        await updateMaintenanceProgressOtherMachinery();
      } catch (err) {
        console.error('保存エラー:', err);
        alert('保存に失敗しました');
        checkbox.checked = !isChecked;
      }
    }

    // チェック状態復元
    async function restoreMaintenanceChecksOtherMachinery() {
      try {
        const machineId = window.currentMachineIdOtherMachinery;
        const { data: statuses } = await client
          .from('maintenance_status')
          .select('item_id, status')
          .filter('item_id', 'ilike', `${machineId}_%`);

        if (statuses) {
          statuses.forEach(s => {
            const checkbox = document.querySelector(`input[data-item-id="${s.item_id}"]`);
            if (checkbox) {
              checkbox.checked = Boolean(s.status);
            }
          });
        }
      } catch (err) {
        console.error('復元エラー:', err);
      }
    }

    // 進捗更新
    async function updateMaintenanceProgressOtherMachinery() {
      try {
        const machineId = window.currentMachineIdOtherMachinery;
        const checkboxes = document.querySelectorAll('#maintenanceChecklistOtherMachinery input[type="checkbox"]');
        const total = checkboxes.length;
        if (total === 0) return;

        const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
        const percentage = Math.round((checked / total) * 100);

        const summaryDiv = document.getElementById('maintenanceSummaryOtherMachinery');
        if (summaryDiv) {
          let statusHTML = percentage === 0
            ? `<span class="text-red-600 font-bold"><i class="fa-solid fa-circle-exclamation"></i> 未着手</span>`
            : percentage === 100
              ? `<span style="color: var(--other-color);" class="font-bold"><i class="fa-solid fa-circle-check"></i> 完了</span>`
              : `<span class="text-orange-500 font-bold"><i class="fa-solid fa-spinner"></i> 進行中 (${percentage}%)</span>`;

          summaryDiv.innerHTML = `
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm">${checked} / ${total} 項目</span>
              ${statusHTML}
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="h-2 rounded-full transition-all duration-500" style="width: ${percentage}%; background: var(--other-color);"></div>
            </div>
          `;
        }
      } catch (err) {
        console.error('進捗更新エラー:', err);
      }
    }

    // 履歴読み込み
    async function loadMaintenanceHistoryOtherMachinery(machineId) {
      try {
        const { data: records } = await client
          .from('maintenance_records')
          .select('*')
          .eq('machine_id', machineId)
          .order('created_at', { ascending: false });

        const logDiv = document.getElementById('maintenanceHistoryLogOtherMachinery');
        if (!logDiv) return;
        if (!records || records.length === 0) {
          logDiv.innerHTML = '<p class="italic text-gray-400 text-center py-4">履歴はありません</p>';
          return;
        }

        logDiv.innerHTML = records.map(rec => `
          <div class="border-b border-gray-100 pb-2 mb-2 last:border-0 text-left">
            <div class="flex justify-between font-bold text-gray-700"><span>${rec.item_name}</span><span class="text-gray-400 text-[9px]">${rec.date}</span></div>
            <div class="text-gray-500">担当: ${rec.operator}</div>
            ${rec.memo ? `<div class="text-gray-400 italic">"${rec.memo}"</div>` : ''}
          </div>`).join('');
      } catch (e) {
        console.error(e);
      }
    }

    // 部品交換記録保存
    async function saveMaintenanceRecordOtherMachinery() {
      const machineId = window.currentMachineIdOtherMachinery;
      const itemName = document.getElementById('newMaintenanceItemOtherMachinery').value;
      const operator = document.getElementById('newMaintenanceOperatorOtherMachinery').value;
      const status = document.getElementById('newMaintenanceStatusOtherMachinery').value;
      const memo = document.getElementById('newMaintenanceMemoOtherMachinery').value;

      if (!itemName) {
        alert('項目名を入力してください');
        return;
      }

      try {
        const { error } = await client
          .from('maintenance_records')
          .insert({
            machine_id: machineId,
            item_name: itemName,
            operator: operator,
            status: status,
            memo: memo,
            created_at: new Date().toISOString()
          });

        if (error) throw error;

        document.getElementById('newMaintenanceItemOtherMachinery').value = '';
        document.getElementById('newMaintenanceOperatorOtherMachinery').value = '';
        document.getElementById('newMaintenanceStatusOtherMachinery').value = 'completed';
        document.getElementById('newMaintenanceMemoOtherMachinery').value = '';

        alert('保存しました');
        await loadMaintenanceHistoryOtherMachinery(machineId);
      } catch (err) {
        console.error('保存エラー:', err);
        alert('保存に失敗しました');
      }
    }
    // モーダル本体の制御
    function showModal(title, message, onOk) {
      const modal = document.getElementById("customModal");
      const modalTitle = document.getElementById("modalTitle");
      const modalMessage = document.getElementById("modalMessage");
      const okBtn = document.getElementById("modalOkBtn");

      // 「戻る」ボタンを、モーダル内のボタンの中から確実に探す
      const allBtns = modal.querySelectorAll("button");
      const cancelBtn = allBtns[0]; // 最初のボタン（左側）をキャンセル用とする

      // テキストをセット
      if (modalTitle) modalTitle.innerText = title;
      modalMessage.innerText = message;

      if (onOk) {
        // 【確認モード】保存しますか？
        okBtn.style.display = "block";
        cancelBtn.innerText = "戻る";

        // 実行ボタンの動作
        okBtn.onclick = async () => {
          okBtn.disabled = true; // 連打防止
          await onOk();
          okBtn.disabled = false;
          closeModal();
        };
        // 戻るボタンの動作
        cancelBtn.onclick = closeModal;
      } else {
        // 【完了モード】保存しました
        okBtn.style.display = "none"; // 実行ボタンを隠す
        cancelBtn.innerText = "OK";   // 左側のボタンをOKに変身
        cancelBtn.onclick = closeModal;
      }

      modal.style.display = "block";
      modal.classList.add("active");
    }

    function closeModal() {
      const modal = document.getElementById("customModal");
      modal.style.display = "none";
      modal.classList.remove("active");
    }
  </script>
</body>

</html>